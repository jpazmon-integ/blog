---
title: Azure Monitor エージェントのよくあるご質問集
date: 2025-05-12 12:00:00
tags:
 - How-To
 - Azure Monitor Agent
---

こんにちは、Azure Monitoring チームの徳田です。

本ブログでは、Azure Monitor エージェントの自動アップグレード昨日に関するよくあるご質問に対する回答をご紹介いたします。

<!-- more -->

<br>

<!-- more -->
## Q & A タイトル

### <アップグレードに関する質問>
- [アップグレード中はログ収集が停止しますか。停止期間中のログはアップグレード後に再送されますか](#)
- [どのようなタイミングでアップグレードされますか。利用者側で指定できますか](#)
- [停止している VM にたいして自動アップグレードは行われますか](#)
- [アップグレードの成否は確認できますか。](#)
- [Azure Monitor エージェントの各バージョンの情報はどこで確認できますか。](#)
- [自動アップグレードが失敗した場合、再実行されますか](#)
- [最新バージョンがリリースされてすぐにアップグレードされますか](#)
- [アップグレードの際に VM (OS) は停止・再起動されますか](#)

<br>

### <アップグレードに関する質問>
--------------------------------------------------------
### Q. アップグレード中はログ収集が停止しますか。停止期間中のログはアップグレード後に再送されますか。
--------------------------------------------------------
まず、AMA で収集可能なログは、仕組みによって大きく 2 種類に分かれます。  
1. 一定の間隔で取得して収集するログ : Heartbeat、パフォーマンス データ、Change Tracking データ  
2. 内部の仕組みでログの更新を検知して収集するログ : イベント ログ、 Syslog、カスタム ログ

1 のログについては、アップグレードしている間はログ収集できなくなりますため、その分のログは欠損してしまいます。  
2 のログについては、アップグレード後に再度ログの更新を検知することが可能ですので、理論上欠損は発生しません。

--------------------------------------------------------
### Q. アップグレードの際に仮想マシン (OS) は停止・再起動されますか
--------------------------------------------------------

されません。

--------------------------------------------------------
### Q. どのようなタイミングでアップグレードされますか。利用者側で指定できますか
--------------------------------------------------------
残念ながら、利用者様側で自動アップグレードのタイミングを制御することはできません。  
起動している仮想マシン上で動作するエージェントが、定期的に最新バージョンの値をチェックし、最新のものが存在する場合は、その後自動アップグレードの処理がトリガーされます。

--------------------------------------------------------
### Q. 停止している VM にたいして自動アップグレードは行われますか
--------------------------------------------------------

仮想マシンが停止している場合は、自動アップグレード機能によるアップグレードは実行されません。

--------------------------------------------------------
### Q. アップグレードの成否は確認できますか。
--------------------------------------------------------

アクティビティ ログから確認が可能です。  
具体的には、Create or Update Virtual Machine Extension というアクティビティ ログが記録されます。  
なお、手動で拡張機能をアップロードした場合も同様のログが記録されますため、こちらの点についてご留意ください。

![アクティビティ ログの例](./AMAAutoupgradeFAQ/upgrade-activitylog.jpg)


また、各マシンで動作している Azure Monitor エージェントのバージョンは、Log Analytics ワークスペースの Heartbeat テーブルの Version 列からもご確認いただけます。  
そのため、当該エージェントのバージョンがどのタイミングで変更されたかは、Heartbeat ログからもご確認が可能です。

// クエリの例
```
Heartbeat
| where _ResourceId =~ "<VMResourceId>"
| where Category == "Azure Monitor Agent"
| where TimeGenerated >= ago(100d)
| summarize max(TimeGenerated) by _ResourceId, Category, Version
```

![Heartbeat ログから Version を確認した例](./AMAAutoupgradeFAQ/Heartbeat-versions.jpg)

--------------------------------------------------------
### Q. Azure Monitor エージェントの各バージョンの情報はどこで確認できますか。
--------------------------------------------------------

Azure Monitor エージェントのバージョンのリリース情報は、以下弊社公開情報に記載されます。  

[Azure Monitor エージェント拡張機能のバージョン | バージョンの詳細](https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-extension-versions#version-details)  

なお、上記サイトにリリース情報が記録されるタイミングと、新しいバージョンが実際に利用できるようになるタイミングは前後する可能性がございますため、恐れ入りますが、あらかじめご理解・ご了承ください。  

補足として、リージョンごとにデプロイされている Azure Monitor エージェント拡張機能のバージョンは、以下の PowerShell コマンドを実行することで確認が可能でございます。

```
# Windows
((Get-AzVMExtensionImage -Location <region> -PublisherName "Microsoft.Azure.Monitor" -Type "AzureMonitorWindowsAgent").Version | Sort-Object -Property { [Version]$_})

# Linux
((Get-AzVMExtensionImage -Location <region> -PublisherName "Microsoft.Azure.Monitor" -Type "AzureMonitorLinuxAgent").Version | Sort-Object -Property { [Version]$_})
```
※ <region> の箇所は、任意のリージョン名にご変更ください (japaneast など)。


--------------------------------------------------------
### Q. 自動アップグレードが失敗した場合、再実行されますか
--------------------------------------------------------

AMAの自動アップグレードが失敗した場合、バージョンアップ前のバージョンが再インストール (ロールバック) されます。  
ロールバックが成功した場合は、翌日の処理で再度自動アップグレードが施行されます。  
なお、ロールバックが失敗すると、AMA 自体の機能が停止し、ログ転送機能が停止する可能性が高いですが、ロールバックが失敗した際の挙動と解消方法は状況により異なります。  
そのため、ロールバックも失敗した場合は、原因と解消方法の調査のためにサポート起票をしてください。

--------------------------------------------------------
### Q. 最新バージョンがリリースされてすぐにアップグレードされますか
--------------------------------------------------------

ご利用のリージョンで最新バージョンが利用可能になってから、すぐにその最新版への自動アップグレードが実行されるわけではありません。  
自動アップグレードによるアップグレードが実行されるまで、数週間かかることを想定してください。
