<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Monitoring Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Monitoring に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazmon-integ.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazmon-integ.github.io/blog/"/>
  <updated>2025-03-28T01:05:31.529Z</updated>
  <id>https://jpazmon-integ.github.io/blog/</id>
  
  <author>
    <name>Japan Azure Monitoring Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Container Insights のご紹介</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToContainerInsights/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToContainerInsights/</id>
    <published>2025-03-25T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.529Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure Monitoring チームの加治屋です。<br>この記事では、Container Insights に関する説明、導入のための前提条件、導入方法をご紹介いたします。</p><span id="more"></span><h2 id="Container-Insights-とは？"><a href="#Container-Insights-とは？" class="headerlink" title="Container Insights とは？"></a>Container Insights とは？</h2><p>AKS クラスターをはじめとした コンテナー環境へデプロイすることで、コンテナー環境で収集された情報を ログとして Log Analytics ワークスペースに収集する、Azure Monitor の製品です。<br>Log Analytics ワークスペースへ収集した情報は通常の VM などから収集したログと同じように、KQL を使用して、情報の分析やログ アラート ルールの処理を行うことができます。</p><p>Kubernetes 監視用の Azure Monitor の機能<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview</a> </p><p>この機能をデプロイすると、コンテナー環境へ Azure Monitor エージェント Pod がデプロイされます。</p><p>Kubernetes 監視用の Azure Monitor の機能 - エージェント<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview#agent">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview#agent</a> </p><h2 id="Container-Insights-を有効化する上での前提条件"><a href="#Container-Insights-を有効化する上での前提条件" class="headerlink" title="Container Insights を有効化する上での前提条件"></a>Container Insights を有効化する上での前提条件</h2><p>以下の前提条件がございます。</p><h3 id="サポートされているクラスター"><a href="#サポートされているクラスター" class="headerlink" title="サポートされているクラスター"></a>サポートされているクラスター</h3><p>・ Azure Kubernetes クラスター<br>・ Azure Arc 対応 Kubernetes クラスター (※)<br>※ ディストリビューションによっては対応していないものもございます。サポートしているディストリビューションにつきましては、以下の弊社公開情報をご確認ください。</p><p>Kubernetes 監視用の Azure Monitor の機能 - サポートされている構成<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview#supported-configurations">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview#supported-configurations</a></p><h3 id="ネットワーク要件"><a href="#ネットワーク要件" class="headerlink" title="ネットワーク要件"></a>ネットワーク要件</h3><p>Container Insights には以下のネットワーク要件がございます。<br>Container Insights を有効化いただく前に以下の宛先に接続できるか、ご確認をお願いいたします。</p><p>*.ods.opinsights.azure.com:443<br>*.oms.opinsights.azure.com:443<br>dc.services.visualstudio.com:443<br>*.monitoring.azure.com:443<br>login.microsoftonline.com:443<br>global.handler.control.monitor.azure.com:443<br>*.ingest.monitor.azure.com:443<br>*.metrics.ingest.monitor.azure.com:443<br><cluster-region-name>.handler.control.monitor.azure.com:443</p><p>詳細な要件につきましては、以下の弊社公開情報をご確認いただけますと幸いです。</p><p>Azure Kubernetes Service (AKS) クラスターのアウトバウンド ネットワークと FQDN の規則 - Azure Monitor - マネージド Prometheus と Container insights<br><a href="https://learn.microsoft.com/ja-jp/azure/aks/outbound-rules-control-egress#azure-monitor---managed-prometheus-and-container-insights">https://learn.microsoft.com/ja-jp/azure/aks/outbound-rules-control-egress#azure-monitor---managed-prometheus-and-container-insights</a></p><h3 id="その他前提条件"><a href="#その他前提条件" class="headerlink" title="その他前提条件"></a>その他前提条件</h3><p>Container Insights 有効化の際は、以下の前提条件をご確認ください。<br>・Azure CLI バージョン 2.49.0 以降では、CLI によるオンボーディングを実行すると、既定でマネージド ID 認証を使用する Container Insights が有効化されます。<br>・Azure k8s-extension バージョンが 1.3.7 以降であること。k8s-extension バージョン 1.43.0 以降では、既定でマネージド ID 認証が使用されます。</p><p>※ マネージド ID 認証は、ARO (Azure Red Hat OpenShift) または Windows ノードを使用する Azure Arc 対応 Kubernetes クラスターではサポートされていません。<br>  上記環境にて Container Insights をご利用される場合は、レガシー認証を使用して Container Insights の有効化を実施ください。</p><p>Kubernetes クラスターの監視を有効にする - コンテナー分析情報を有効にする - 前提条件<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#prerequisites-4">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#prerequisites-4</a></p><h2 id="Container-Insights-の有効化-デプロイ-方法"><a href="#Container-Insights-の有効化-デプロイ-方法" class="headerlink" title="Container Insights の有効化 (デプロイ) 方法"></a>Container Insights の有効化 (デプロイ) 方法</h2><p>有効化方法として、いくつか方法がございます。<br>代表的な手順をご紹介いたします。<br>なお、以下の有効化手順につきましては、Azure Kubernetes Service (AKS) リソースでご利用されることを前提として記載しております。</p><p>I. AKS リソースの作成時に Container Insights も一緒に有効化する方法</p><p>以下の画面にて有効化を行うことが可能です。<br>[コンテナー ログを有効にする] にチェックを入れていただき、ログを送信する先の Log Analytics ワークスペースを指定します。<br>指定しない場合は、規定の Log Analytics ワークスペース (DefaultWorkspace- からはじまる Log Analytics ワークスペース) が新規作成、もしくは自動的に指定されます。</p><p><img src="/blog/LogAnalytics/HowToContainerInsights/01.png" alt="リソース作成時に有効化"></p><p>コストの事前設定の部分は、ログの収集頻度やログの収集対象を設定する箇所でございます。<br>具体的な設定につきましては、以下の弊社公開情報にも記載がございますので、ご参照ください。</p><p>Container insights でログ収集を構成する - DCR を使用してデータ収集を構成する - Azure portal を使用して DCR を構成する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-data-collection-configure?tabs=portal#configure-dcr-with-azure-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-data-collection-configure?tabs=portal#configure-dcr-with-azure-portal</a></p><p>II. AKS リソース作成後に Azure CLI を使用して有効化する方法<br>以下のコマンドを実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az aks enable-addons --addon monitoring --name &quot;&lt;AKS クラスター名&gt;&quot; --resource-group &quot;&lt;リソース グループ名&gt;&quot; --workspace-resource-id &quot;&lt;Log Analytics ワークスペースのリソース ID&gt;&quot;</span><br></pre></td></tr></table></figure><p>Azure Arc 対応クラスターをご利用の場合は、こちらのコマンドをご利用ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az k8s-extension create --name azuremonitor-containers --cluster-name &quot;&lt;Azure Arc 対応クラスター名&gt;&quot; --resource-group &quot;&lt;リソース グループ名&gt;&quot; --cluster-type connectedClusters --extension-type Microsoft.AzureMonitor.Containers --configuration-settings logAnalyticsWorkspaceResourceID=&quot;&lt;Log Analytics ワークスペースのリソース ID&gt;&quot;</span><br></pre></td></tr></table></figure><p>ARO (Azure Red Hat OpenShift) または Windows ノードを使用する Azure Arc 対応 Kubernetes クラスターに対しては、以下のコマンドにてレガシー認証を利用した Container Insights を有効化します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az k8s-extension create --name azuremonitor-containers --cluster-name &quot;&lt;Azure Arc 対応クラスター名&gt;&quot; --resource-group &quot;&lt;リソース グループ名&gt;&quot; --cluster-type connectedClusters --extension-type Microsoft.AzureMonitor.Containers ---configuration-settings logAnalyticsWorkspaceResourceID=&quot;&lt;Log Analytics ワークスペースのリソース ID&gt;&quot; amalogs.useAADAuth=false</span><br></pre></td></tr></table></figure><p>その他のクラスターで有効化を行う方法につきましては、以下の弊社公開情報にコマンドのサンプルがございますので、ご参照ください。<br>Kubernetes クラスターの監視を有効にする - コンテナー分析情報を有効にする<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-container-insights">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-container-insights</a></p><p>III. AKS リソース作成後に Azure ポータルを使用して有効化する方法</p><p>AKS リソースより [分析情報] もしくは [監視] をご選択いただき、[モニターの設定] より有効化いただけます。<br><img src="/blog/LogAnalytics/HowToContainerInsights/02.png" alt="Azure ポータルからの有効化"></p><p>ログ送信先の Log Analytics ワークスペースの変更したいなど、設定変更を行いたい場合は、画面下部の [詳細設定] より設定を変更いただけます。<br><img src="/blog/LogAnalytics/HowToContainerInsights/03.png" alt="Azure ポータルからの有効化時の設定変更"></p><p>コストの事前設定に関する具体的な設定につきましては、以下の弊社公開情報にも記載がございますので、ご参照ください。<br>Container insights でログ収集を構成する - DCR を使用してデータ収集を構成する - Azure portal を使用して DCR を構成する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-data-collection-configure?tabs=portal#configure-dcr-with-azure-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-data-collection-configure?tabs=portal#configure-dcr-with-azure-portal</a></p><p>なお、この有効化方法は、マネージド ID による認証が使用できないクラスター (Azure Arc 対応 Redhat OpenShift クラスターなど) ではご利用いただけません。</p><h3 id="有効化の確認方法"><a href="#有効化の確認方法" class="headerlink" title="有効化の確認方法"></a>有効化の確認方法</h3><p>Contianer Insights は、Azure Monitor にて使用されているエージェント (Azure Monitor エージェント) の仕組みを使用し、ログを Log Analytics ワークスペースへ送信いたします。<br>そのため、Container Insights を有効化いたしますと、ログの送信先 log Analytics ワークスペースに対して Heartbeat ログが 1 分間隔で送信されます。<br>Container Insights の有効化が正常に行われたかご確認いただければと存じます。</p><p><img src="/blog/LogAnalytics/HowToContainerInsights/04.png" alt="Container Insights の有効化確認"></p><p>heartbeat ログの確認方法につきましては、以下の記事をご参照ください。<br>Azure Monitor エージェントにより収集される Heartbeat ログを使用した死活監視方法<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM_AMA/#%E4%BE%8B-1-%E3%81%82%E3%82%8B%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8B%E3%82%89-Heartbeat-%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM_AMA/#%E4%BE%8B-1-%E3%81%82%E3%82%8B%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%8B%E3%82%89-Heartbeat-%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B</a></p><h3 id="Container-Insights-の無効化方法"><a href="#Container-Insights-の無効化方法" class="headerlink" title="Container Insights の無効化方法"></a>Container Insights の無効化方法</h3><p>誤った方法で設定変更を行ってしまった場合や、特定の設定を実施いただく際に必要な手順として、Container Insights の無効化をご案内させていただく場合がございます。<br>無効化の際は以下のコマンドをご実行ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az k8s-extension delete --name azuremonitor-containers --cluster-type connectedClusters --cluster-name &lt;クラスター名&gt; --resource-group &lt;リソース グループ名&gt;</span><br></pre></td></tr></table></figure><p>無効化を行いますと、Container Insights を使用する機能 (ログ収集機能) がご利用いただけなくなりますので、ご留意ください。<br>また、無効化を行った場合でも、Container Insights の作成時に同時に作成した Log Analytics ワークスペースやアラート等は削除されませんので、もしこれらのリソースも不要である場合は、個別に削除ください。</p><p>Kubernetes クラスターの監視を有効にする - コンテナー分析情報を有効にする - 拡張機能のインスタンスを削除する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-container-insights">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-container-insights</a></p><p>もし、Container Insights のデプロイ方法にてお困りごとがございましたら、遠慮なく弊社サポートまでお問い合わせください。</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><ul><li>Kubernetes 監視用の Azure Monitor の機能<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview">https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure Monitoring チームの加治屋です。&lt;br&gt;この記事では、Container Insights に関する説明、導入のための前提条件、導入方法をご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Container Insights" scheme="https://jpazmon-integ.github.io/blog/tags/Container-Insights/"/>
    
  </entry>
  
  <entry>
    <title>エージェント ベースの Hybrid Runbook Worker がご利用いただけなくなります</title>
    <link href="https://jpazmon-integ.github.io/blog/automation/AgentBasedHrwRetired/"/>
    <id>https://jpazmon-integ.github.io/blog/automation/AgentBasedHrwRetired/</id>
    <published>2025-02-20T05:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.689Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北山です。<br>今回の記事では、Azure Automation のエージェント ベースの Hybrid Runbook Worker 廃止について記載します。<br><a href="https://azure.microsoft.com/ja-jp/updates/?id=477734">Retirement: All Azure Automation jobs running on Agent-based Hybrid Worker will be stopped from 1 April 2025</a></p><span id="more"></span><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E7%94%A8%E8%AA%9E">用語</a><ul><li><a href="#hybrid-runbook-worker">Hybrid Runbook Worker</a></li><li><a href="#%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE-hybrid-runbook-worker">エージェント ベースの Hybrid Runbook Worker</a></li><li><a href="#%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE-hybrid-runbook-worker">拡張機能ベースの Hybrid Runbook Worker</a></li></ul></li><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8B">どのような影響を受けるか</a></li><li><a href="#%E3%81%84%E3%81%A4%E3%81%8B%E3%82%89%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8B">いつから影響を受けるか</a></li><li><a href="#%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8A%E5%AE%A2%E6%A7%98">影響を受けるお客様</a><ul><li><a href="#%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88-%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE-hybrid-runbook-worker-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">エージェント ベースの Hybrid Runbook Worker を利用しているか確認する方法</a></li></ul></li><li><a href="#%E7%A7%BB%E8%A1%8C%E6%96%B9%E6%B3%95">移行方法</a></li><li><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB">最後に</a></li></ul><h1 id="用語"><a href="#用語" class="headerlink" title="用語"></a>用語</h1><h2 id="Hybrid-Runbook-Worker"><a href="#Hybrid-Runbook-Worker" class="headerlink" title="Hybrid Runbook Worker"></a>Hybrid Runbook Worker</h2><p>Azure Automation の機能の一つです。<br>予め作成した Runbook (PowerShell・Python スクリプト) は、Azure Automation のクラウド環境で比較的容易に実行可能です。<br>一方で Hybrid Runbook Worker を利用すると、お客様管理のコンピューター上で Runbook の実行が可能です。  </p><p>メリットは、クラウド環境で実行するよりも制限が緩いこと、サード パーティー製のアプリケーションと連携が可能なこと、お客様管理のネットワーク環境上で実行が可能なことなどです。</p><h2 id="エージェント-ベースの-Hybrid-Runbook-Worker"><a href="#エージェント-ベースの-Hybrid-Runbook-Worker" class="headerlink" title="エージェント ベースの Hybrid Runbook Worker"></a>エージェント ベースの Hybrid Runbook Worker</h2><p>Log Analytics エージェントのテクノロジーを利用した、Hybrid Runbook Worker です。<br>エージェント ベースの Hybrid Runbook Worker をご利用いただくには、当該コンピューターに Log Analytics エージェントのインストールが必須です。</p><p>Log Analytics エージェントは 2024 年の 8 月にサポート終了しているため、それに伴いエージェント ベースの Hybrid Runbook Worker もサポートが終了しています。</p><h2 id="拡張機能ベースの-Hybrid-Runbook-Worker"><a href="#拡張機能ベースの-Hybrid-Runbook-Worker" class="headerlink" title="拡張機能ベースの Hybrid Runbook Worker"></a>拡張機能ベースの Hybrid Runbook Worker</h2><p>現在主流の、Azure VM・Azure Arc enabled servers の拡張機能として動作する Hybrid Runbook Worker です。<br>Log Analytics エージェントに依存していないため、Log Analytics エージェントのインストールは不要です。<br>Log Analytics エージェントの後継版である Azure Monitor エージェントのインストールも不要です。</p><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><p>エージェント ベースの Hybrid Runbook Worker に関しましては、2024 年の 8 月にすでにサポートが終了しております。<br>サポートは終了していましたが、引き続きエージェント ベースの Hybrid Runbook Worker がご利用いただけておりました。  </p><p>しかし、下記の更新情報に記載がございますとおり <strong>2025 年 4 月 1 日からはエージェント ベースの Hybrid Runbook Worker がご利用できなくなります。</strong></p><p><a href="https://azure.microsoft.com/ja-jp/updates/?id=477734">Retirement: All Azure Automation jobs running on Agent-based Hybrid Worker will be stopped from 1 April 2025</a></p><h1 id="どのような影響を受けるか"><a href="#どのような影響を受けるか" class="headerlink" title="どのような影響を受けるか"></a>どのような影響を受けるか</h1><p>エージェント ベースの Hybrid Runbook Worker 上でジョブを実行した場合、ジョブ実行が正常に動作しません。<br>これは、スケジュール実行・ポータルからの実行・Webhook (*1) による実行すべてに該当します。<br>※ 1 : Logic Apps や PowerAutomate で使われる Azure Automation コネクタも該当します。</p><h1 id="いつから影響を受けるか"><a href="#いつから影響を受けるか" class="headerlink" title="いつから影響を受けるか"></a>いつから影響を受けるか</h1><p>2025 年 4 月 1 日からです。</p><h1 id="影響を受けるお客様"><a href="#影響を受けるお客様" class="headerlink" title="影響を受けるお客様"></a>影響を受けるお客様</h1><p>ジョブ実行環境として、エージェント ベースの Hybrid Runbook Worker をご利用いただいているお客様です。</p><h2 id="エージェント-ベースの-Hybrid-Runbook-Worker-を利用しているか確認する方法"><a href="#エージェント-ベースの-Hybrid-Runbook-Worker-を利用しているか確認する方法" class="headerlink" title="エージェント ベースの Hybrid Runbook Worker を利用しているか確認する方法"></a>エージェント ベースの Hybrid Runbook Worker を利用しているか確認する方法</h2><h3 id="1-Azure-ポータルから確認する方法"><a href="#1-Azure-ポータルから確認する方法" class="headerlink" title="1. Azure ポータルから確認する方法"></a>1. Azure ポータルから確認する方法</h3><p>一つ一つ Automation アカウントを確認する必要がありますが、Azure ポータルから確認が可能です。<br>確認の手順は下記のとおりです。</p><ol><li>Azure ポータルを開き、Automation アカウントのページへ移動します。</li><li>画面左側の [プロセス オートメーション - ハイブリッド Worker グループ] をクリックし、[ユーザー ハイブリッド worker グループ] タブから確認したい Hybrid Runbook Worker グループをクリックします。<br><img src="/blog/automation/AgentBasedHrwRetired/pict-1.png"></li><li>[ハイブリッド Worker グループ - ハイブリッド Worker] をクリックして表示される Hybrid Runbook Worker の [プラットフォーム] 列を確認し、値が「エージェント ベース (V1)」の場合はエージェント ベースの Hybrid Runbook Worker を利用しています。<br><img src="/blog/automation/AgentBasedHrwRetired/pict-2.png"></li></ol><p>もしプラットフォームの箇所が「拡張機能ベース (V2)」の場合は、対処不要です。<br><img src="/blog/automation/AgentBasedHrwRetired/pict-3.png"></p><h3 id="2-PowerShell-スクリプトを実行して確認する方法"><a href="#2-PowerShell-スクリプトを実行して確認する方法" class="headerlink" title="2. PowerShell スクリプトを実行して確認する方法"></a>2. PowerShell スクリプトを実行して確認する方法</h3><h4 id="実行方法"><a href="#実行方法" class="headerlink" title="実行方法"></a>実行方法</h4><p>後述する PowerShell スクリプトを Azure Portal の Cloud Shell にて実行することで、エージェント ベースの Hybrid Runbook Worker 一覧を CSV 形式で出力が可能です。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/cloud-shell/overview">Azure Cloud Shell の概要</a></li></ul><p>PowerShell スクリプトを Cloud Shell の PowerShell にて実行し、「CSV file has been created: Agent-basedHRWs.csv」が出力されれば処理は完了です。<br>その後、下記の手順にて CSV ファイルのダウンロードが可能です。</p><ol><li><p>Dir コマンドで対象の CSV ファイルが存在する事を確認します。<br><img src="/blog/automation/AgentBasedHrwRetired/pict-4.png"></p></li><li><p>ダウンロードをクリックします。<br><img src="/blog/automation/AgentBasedHrwRetired/pict-5.png"></p></li><li><p>ファイル名 (Agent-basedHRWs.csv) を入力して [ダウンロード] をクリックします。<br><img src="/blog/automation/AgentBasedHrwRetired/pict-6.png"></p></li></ol><p>出力された CSV には、下記の列が存在します。</p><ul><li>WorkerName : エージェント ベースの Hybrid Runbook Worker の名称です。</li><li>AutomationAccountName : Hybrid Runbook Worker を管理している Azure Automation アカウントの名称です。</li><li>HybridRunbookWorkerGroupName : Hybrid Runbook Worker を管理している Hybrid Runbook Worker グループの名称です。</li><li>ResourceGroupName : Azure Automation アカウントを管理しているリソース グループの名称です。</li></ul><p><img src="/blog/automation/AgentBasedHrwRetired/pict-7.png"></p><h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><ul><li>Cloud Shell は、Bash ではなく PowerShell としてご利用ください。</li><li>テナントに複数のサブスクリプションが存在する場合、期待しないサブスクリプションに対して処理が実行される可能性がございます。期待しないサブスクリプションに処理が実行される場合は、予め「Set-AzContext -SubscriptionID “&lt;対象サブスクリプション ID&gt;”」のコマンドレットを実行ください。</li><li>Azure portal にアクセスしているユーザーには、最低でもサブスクリプション スコープに閲覧者ロールを付与してください。サブスクリプション内のすべての Azure Automation リソースを参照するためです。</li></ul><h4 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h4><ul><li>Cloud Shell のターミナルに PowerShell スクリプトをペーストする場合は、「Ctrl + V」ではなく「Shift + Insert」をご利用ください。</li><li>出力される CSV には、エージェント ベースの Hybrid Runbook Worker しか出力されません。</li><li>この PowerShell スクリプトを実行することで、Azure リソースが更新されることはございません。</li><li>この PowerShell スクリプトを実行することで、Hybrid Runbook Worker として稼働している Azure VM が停止することはございません。</li></ul><h4 id="サンプル-スクリプト"><a href="#サンプル-スクリプト" class="headerlink" title="サンプル スクリプト"></a>サンプル スクリプト</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 出力用のデータを格納する配列を初期化</span></span><br><span class="line"><span class="variable">$output</span> = <span class="selector-tag">@</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Automation アカウントの一覧を取得</span></span><br><span class="line"><span class="variable">$automationAccounts</span> = <span class="built_in">Get-AzAutomationAccount</span> | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> ResourceGroupName, AutomationAccountName</span><br><span class="line"></span><br><span class="line"><span class="comment"># Automation アカウントの総数を取得</span></span><br><span class="line"><span class="variable">$totalAccounts</span> = <span class="variable">$automationAccounts</span>.Count</span><br><span class="line"><span class="variable">$currentIndex</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$account</span> <span class="keyword">in</span> <span class="variable">$automationAccounts</span>) &#123;</span><br><span class="line">    <span class="variable">$currentIndex</span>++</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 進捗状況を出力</span></span><br><span class="line">    <span class="built_in">Write-Progress</span> `</span><br><span class="line">        <span class="literal">-Activity</span> <span class="string">&quot;In progress...&quot;</span> `</span><br><span class="line">        <span class="literal">-Status</span> <span class="string">&quot;Current account: <span class="variable">$</span>(<span class="variable">$account</span>.AutomationAccountName)&quot;</span> `</span><br><span class="line">        <span class="literal">-PercentComplete</span> ((<span class="variable">$currentIndex</span> / <span class="variable">$totalAccounts</span>) * <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># リソースグループ名とAutomationアカウント名を変数にセット</span></span><br><span class="line">    <span class="variable">$resourceGroup</span> = <span class="variable">$account</span>.ResourceGroupName</span><br><span class="line">    <span class="variable">$automationAccountName</span> = <span class="variable">$account</span>.AutomationAccountName</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Hybrid Worker Groups を取得</span></span><br><span class="line">    <span class="variable">$hybridRunbookWorkerGroups</span> = <span class="built_in">Get-AzAutomationHybridWorkerGroup</span> `</span><br><span class="line">        <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> `</span><br><span class="line">        <span class="literal">-AutomationAccountName</span> <span class="variable">$automationAccountName</span> `</span><br><span class="line">    | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.GroupType <span class="operator">-eq</span> <span class="string">&quot;User&quot;</span> &#125; `</span><br><span class="line">    | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> Id, Name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $hybridRunbookWorkerGroups が NULL または空白の場合は次のループへ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">-not</span> <span class="variable">$hybridRunbookWorkerGroups</span>) &#123;</span><br><span class="line">        <span class="keyword">Continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Hybrid Worker Groups に含まれる、エージェント ベース (HybridV1) Hybrid Runbook Worker を取得</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$worker</span> <span class="keyword">in</span> <span class="variable">$hybridRunbookWorkerGroups</span>) &#123;</span><br><span class="line">        <span class="variable">$workerItem</span> = <span class="built_in">Get-AzAutomationHybridRunbookWorker</span> `</span><br><span class="line">            <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroup</span> `</span><br><span class="line">            <span class="literal">-AutomationAccountName</span> <span class="variable">$automationAccountName</span> `</span><br><span class="line">            <span class="literal">-HybridRunbookWorkerGroupName</span> <span class="variable">$worker</span>.Name `</span><br><span class="line">        | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.WorkerType <span class="operator">-eq</span> <span class="string">&quot;HybridV1&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="operator">-not</span> <span class="variable">$workerItem</span>) &#123;</span><br><span class="line">            <span class="keyword">Continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 出力用のデータを配列に追加</span></span><br><span class="line">        <span class="variable">$outputItem</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">            ResourceGroupName            = <span class="variable">$resourceGroup</span></span><br><span class="line">            AutomationAccountName        = <span class="variable">$automationAccountName</span></span><br><span class="line">            HybridRunbookWorkerGroupName = <span class="variable">$worker</span>.Name</span><br><span class="line">            WorkerName                   = <span class="variable">$workerItem</span>.WorkerName</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$output</span> += <span class="variable">$outputItem</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># CSV ファイルに出力</span></span><br><span class="line"><span class="variable">$FilePath</span> = <span class="string">&quot;Agent-basedHRWs.csv&quot;</span></span><br><span class="line"><span class="variable">$output</span> | <span class="built_in">Export-Csv</span> <span class="literal">-Path</span> <span class="variable">$FilePath</span> <span class="literal">-NoTypeInformation</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Write-Output</span> <span class="string">&quot;CSV file has been created: <span class="variable">$FilePath</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="移行方法"><a href="#移行方法" class="headerlink" title="移行方法"></a>移行方法</h1><p>基本的には、下記の流れで移行作業を実施します。</p><ol><li>対象のコンピューターに、Hybrid Runbook Worker の拡張機能をインストールします。</li><li>拡張機能をインストール後、動作実績がある Runbook を Hybrid Runbook Worker にて実行し、動作確認を行います。</li><li>動作確認完了後、Azure portal にて当該 Hybrid Runbook Worker グループからエージェント ベースの Hybrid Runbook Worker を削除します。</li></ol><p>その他、拡張機能ベースの Hybrid Runbook Worker ご利用の前提条件や、Azure VM 以外のコンピューターでご利用いただく方法などが下記の公開情報に記載されております。<br>こちらの公開情報をご参考に、エージェント ベースの Hybrid Runbook Worker から拡張機能の Hybrid Runbook Worker へ移行作業をご検討ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/migrate-existing-agent-based-hybrid-worker-to-extension-based-workers?tabs=bicep-template,win-hrw">既存のエージェント ベースのハイブリッド worker を拡張機能ベースのハイブリッド worker に移行する</a></li></ul><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>もし移行方法についてご質問がある場合やトラブル解決のためにサポートが必要な場合は、Azure portal より Azure Automation 観点でお問い合わせください。<br>以上となります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北山です。&lt;br&gt;今回の記事では、Azure Automation のエージェント ベースの Hybrid Runbook Worker 廃止について記載します。&lt;br&gt;&lt;a href=&quot;https://azure.microsoft.com/ja-jp/updates/?id=477734&quot;&gt;Retirement: All Azure Automation jobs running on Agent-based Hybrid Worker will be stopped from 1 April 2025&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Automation" scheme="https://jpazmon-integ.github.io/blog/tags/Automation/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor の診断設定に関するよくあるご質問</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/MonitorDiagnosticsSettingFAQ/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/MonitorDiagnosticsSettingFAQ/</id>
    <published>2025-02-19T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.408Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">Azure Monitor の診断設定</a>に関するよくあるご質問をご紹介します。</p><br><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><h4 id="lt-Azure-Monitor-の診断設定の全般-gt"><a href="#lt-Azure-Monitor-の診断設定の全般-gt" class="headerlink" title="&lt;Azure Monitor の診断設定の全般&gt;"></a>&lt;Azure Monitor の診断設定の全般&gt;</h4><ul><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定について教えてください。</a></li><li><a href="#Q-Azure-VM-%E3%81%AB%E3%82%82%E3%80%8C%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%80%8D%E3%81%A8%E3%81%84%E3%81%86%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%81%8C%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8C%E3%80%81Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%81%AF%E7%95%B0%E3%81%AA%E3%82%8B%E6%A9%9F%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. Azure VM にも「診断設定」というメニューがありますが、Azure Monitor の診断設定とは異なる機能ですか。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AF%E3%80%81%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%A7%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. Azure Monitor の診断設定は、すべてのリソースでサポートしていますか。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定の設定手順を教えてください。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B%E5%89%8D%E3%81%AB%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%81%9F%E3%83%AD%E3%82%B0%E3%82%84%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%80%81%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%81%AF%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%84-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. Azure Monitor の診断設定を構成する前に生成されたログやメトリック、アクティビティ ログは、ストレージ アカウントや Log Analytics ワークスペースにエクスポートされますか。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AE%E6%A7%8B%E6%88%90%E3%82%92%E6%A4%9C%E8%A8%8E%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E7%A7%81%E3%81%AE%E7%92%B0%E5%A2%83%E3%81%AE%E5%A0%B4%E5%90%88%E3%80%81%E3%82%B3%E3%82%B9%E3%83%88%E3%81%AF%E3%81%A9%E3%82%8C%E3%81%90%E3%82%89%E3%81%84%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. Azure Monitor の診断設定の構成を検討しています。私の環境の場合、コストはどれぐらいになりますか。</a></li></ul><br><h4 id="lt-リソース-ログ・メトリックのエクスポート-gt"><a href="#lt-リソース-ログ・メトリックのエクスポート-gt" class="headerlink" title="&lt;リソース ログ・メトリックのエクスポート&gt;"></a>&lt;リソース ログ・メトリックのエクスポート&gt;</h4><ul><li><a href="#Q-Azure-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%84%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%A4%9C%E8%A8%8E%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E5%BF%85%E8%A6%81%E3%81%AA%E6%A8%A9%E9%99%90%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure リソースのログやメトリックを Log Analytics ワークスペースにエクスポートすることを検討しています。必要な権限を教えてください。</a></li><li><a href="#Q-Azure-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%84%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%A4%9C%E8%A8%8E%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E5%BF%85%E8%A6%81%E3%81%AA%E6%A8%A9%E9%99%90%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure リソースのログやメトリックをストレージアカウントにエクスポートすることを検討しています。必要な権限を教えてください。</a></li><li><a href="#Q-%E8%A4%87%E6%95%B0%E3%81%AE%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%82%84%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81%E4%B8%80%E3%81%A4%E3%81%AE-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. 複数のサブスクリプションのリソース ログやメトリックを、一つの Log Analytics ワークスペースにエクスポートすることは可能ですか。</a></li><li><a href="#Q-%E8%A4%87%E6%95%B0%E3%81%AE%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%82%84%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. 複数のサブスクリプションのリソース ログやメトリックを、一つのストレージ アカウントにエクスポートすることは可能ですか。</a></li><li><a href="#Q-%E5%88%A5%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E3%81%AE-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%84%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. 別テナントの Log Analytics ワークスペースやストレージ アカウントに対して診断設定を構成することは可能ですか。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所を教えてください。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定でリソース ログとメトリックを、Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所を変更することはできますか。</a></li><li><a href="#Q-Azure-VM-%E3%81%AE%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%83%9B%E3%82%B9%E3%83%88-OS-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%92-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E3%81%84%E3%81%AE%E3%81%A7%E3%81%99%E3%81%8C%E3%80%81Azure-%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%AB%E4%B8%8A%E3%81%AB%E8%A8%AD%E5%AE%9A%E7%94%BB%E9%9D%A2%E3%81%8C%E8%A6%8B%E5%BD%93%E3%81%9F%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82">Q. Azure VM のプラットフォーム メトリック (ホスト OS メトリック) を Log Analytics ワークスペースにエクスポートしたいのですが、Azure ポータル上に設定画面が見当たりません。</a></li></ul><br><h4 id="lt-アクティビティ-ログのエクスポート-gt"><a href="#lt-アクティビティ-ログのエクスポート-gt" class="headerlink" title="&lt;アクティビティ ログのエクスポート&gt;"></a>&lt;アクティビティ ログのエクスポート&gt;</h4><ul><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アクティビティ ログの診断設定の設定手順を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%81%AE%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA%E3%81%AE%E8%A9%B3%E7%B4%B0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アクティビティ ログのカテゴリの詳細を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%82%92-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%A4%9C%E8%A8%8E%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E6%A8%A9%E9%99%90%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アクティビティ ログを Log Analytics ワークスペースにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E6%A4%9C%E8%A8%8E%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E6%A8%A9%E9%99%90%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アクティビティ ログをストレージ アカウントにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。</a></li><li><a href="#Q-%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%82%92%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%84%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. 特定のリソースのアクティビティ ログを、Log Analytics ワークスペースやストレージ アカウントにエクスポートすることは可能ですか。</a></li><li><a href="#Q-Azure-%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%AB%E3%81%8B%E3%82%89%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0-gt-%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A-%E3%82%92%E9%96%8B%E3%81%8F%E3%81%A8%E3%80%81%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8D%98%E4%BD%8D%E3%81%A7%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E4%BD%9C%E6%88%90%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%E3%81%8B%E3%80%82">Q. Azure ポータルからリソース グループの [アクティビティ ログ] &gt; [診断設定] を開くと、アクティビティ ログの診断設定が表示されます。リソース グループ単位でアクティビティ ログの診断設定を作成できるのでしょうか。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%80%81%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定で、アクティビティ ログをストレージ アカウントにエクスポートしています。データの格納場所を教えてください。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%80%81%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%82%92-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定で、アクティビティ ログを Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0%E3%82%92-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E6%96%99%E9%87%91%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. アクティビティ ログを Log Analytics ワークスペースにエクスポートした場合、Log Analytics ワークスペースに対する料金が発生しますか。</a></li></ul><br><h3 id="lt-トラブルシューティング-gt"><a href="#lt-トラブルシューティング-gt" class="headerlink" title="&lt;トラブルシューティング&gt;"></a>&lt;トラブルシューティング&gt;</h3><ul><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AB%E3%82%88%E3%82%8B%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%84%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%81%AE%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AF%E3%80%81100-%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BF%9D%E8%A8%BC%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. Azure Monitor の診断設定によるプラットフォーム メトリックやリソース ログのエクスポートは、100 % のデータ エクスポートを保証していますか。</a></li><li><a href="#Q-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%84%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%84%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8C%E3%80%81%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%A0%BC%E7%B4%8D%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%E8%80%83%E3%81%88%E3%82%89%E3%82%8C%E3%82%8B%E5%8E%9F%E5%9B%A0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Log Analytics ワークスペースやストレージ アカウントにログやメトリックをエクスポートしていますが、データが格納されていません。考えられる原因を教えてください。</a></li><li><a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E8%A8%AD%E5%AE%9A%E3%81%8C%E6%B6%88%E3%81%88%E3%81%A6%E3%81%97%E3%81%BE%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82">Q. Azure Monitor の診断設定を構成しましたが、設定が消えてしまいました。</a></li><li><a href="#Q-%E6%96%B0%E3%81%9F%E3%81%AB-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E6%A7%8B%E6%88%90%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E3%81%97%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E4%BF%9D%E6%8C%81%E6%9C%9F%E9%96%93%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%E4%BB%A5%E5%89%8D%E3%81%AF%E3%80%81%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AB%E3%81%A6%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%80%81%E4%BF%9D%E6%8C%81%E6%9C%9F%E9%96%93%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82">Q. 新たに Azure Monitor の診断設定を構成しようとしたところ、ストレージ アカウントの保持期間を指定する項目が表示されません。以前は、診断設定にてストレージ アカウントにエクスポートした場合、保持期間を指定する項目が表示されていました。</a></li></ul><br><hr><h3 id="Azure-Monitor-の診断設定の全般"><a href="#Azure-Monitor-の診断設定の全般" class="headerlink" title="Azure Monitor の診断設定の全般"></a>Azure Monitor の診断設定の全般</h3><hr><h3 id="Q-Azure-Monitor-の診断設定について教えてください。"><a href="#Q-Azure-Monitor-の診断設定について教えてください。" class="headerlink" title="Q. Azure Monitor の診断設定について教えてください。"></a>Q. Azure Monitor の診断設定について教えてください。</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">Azure プラットフォームのメトリックやログ、アクティビティ ログを Log Analytics ワークスペース等にエクスポートする機能</a>です。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/metrics-index">プラットフォームのメトリック</a>は Azure リソースから一定の間隔で自動で収集される数値データであり、既定で収集されます。メトリックは Azure 基盤側のメトリック データベースに保存され、Azure ポータルの<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics">メトリック エクスプローラー</a>から確認できます。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/logs-index">プラットフォームのログ</a>は Azure リソース内で実行された操作に関するデータであり、Azure Monitor の診断設定を構成しない限り、収集することはできません。プラット フォームのメトリックを既定の保持期間 (<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#platform-and-custom-metrics">93 日間</a>) 以上保管したい場合やプラットフォームのログを保管・監視したい場合にご利用いただける機能です。</p><br><h3 id="Q-Azure-VM-にも「診断設定」というメニューがありますが、Azure-Monitor-の診断設定とは異なる機能ですか。"><a href="#Q-Azure-VM-にも「診断設定」というメニューがありますが、Azure-Monitor-の診断設定とは異なる機能ですか。" class="headerlink" title="Q. Azure VM にも「診断設定」というメニューがありますが、Azure Monitor の診断設定とは異なる機能ですか。"></a>Q. Azure VM にも「診断設定」というメニューがありますが、Azure Monitor の診断設定とは異なる機能ですか。</h3><p>はい、Azure VM のメニューで表示される「診断設定」は、Azure Monitor の診断設定とは別の機能です。<br>Azure ポータルから Azure VM を開くと [診断設定] という項目がありますが、これは Azure VM に <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure Diagnostics 拡張機能</a>をインストールし、ゲスト OS のログやメトリックをストレージ アカウントに送信する機能です。この 2 つの機能の違いについては、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/">Azure VM の診断設定とそれ以外のリソースにおける診断設定について</a> のブログで詳しく説明しておりますので、ご覧いただけますと幸いです。<br><img width="700" src="../MonitorDiagnosticsSettingFAQ/image01.png"></p><br><h3 id="Q-Azure-Monitor-の診断設定は、すべてのリソースでサポートしていますか。"><a href="#Q-Azure-Monitor-の診断設定は、すべてのリソースでサポートしていますか。" class="headerlink" title="Q. Azure Monitor の診断設定は、すべてのリソースでサポートしていますか。"></a>Q. Azure Monitor の診断設定は、すべてのリソースでサポートしていますか。</h3><p>いいえ、Azure Monitor の診断設定は、すべてのリソースでサポートしておりません。<br>基本的には、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/logs-index#supported-metrics-and-log-categories-by-resource-type">こちら</a>の公開情報でサポート状況をご確認いただけます。<br>メトリックの場合は、上記公開情報経由でアクセスできる各ページに掲載されている表の [DS エクスポート] 列が「はい」の場合、診断設定で Log Analytics ワークスペース等にエクスポート可能です。下図は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/microsoft-automation-automationaccounts-metrics">Microsoft.Automation/automationAccounts</a> の例です。<br><img width="700" src="../MonitorDiagnosticsSettingFAQ/image02.png"></p><p>ログの場合は、各ページにカテゴリやログの出力先テーブル (宛先が Log Analytics ワークスペースの場合) が記載されています。<br>下図は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-logs/microsoft-automation-automationaccounts-logs">Microsoft.Automation/automationAccounts</a> の例です。<br><img width="700" src="../MonitorDiagnosticsSettingFAQ/image03.png"></p><br><h3 id="Q-Azure-Monitor-の診断設定の設定手順を教えてください。"><a href="#Q-Azure-Monitor-の診断設定の設定手順を教えてください。" class="headerlink" title="Q. Azure Monitor の診断設定の設定手順を教えてください。"></a>Q. Azure Monitor の診断設定の設定手順を教えてください。</h3><p>基本的には Azure ポータルから対象リソースを選択し、[監視] - [診断設定] から構成することが可能です。<br>設定手順の詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings?tabs=portal">こちら</a>の公開情報をご覧ください。<br><img width="750" src="../MonitorDiagnosticsSettingFAQ/image04.png"></p><br><h3 id="Q-Azure-Monitor-の診断設定を構成する前に生成されたログやメトリック、アクティビティ-ログは、ストレージ-アカウントや-Log-Analytics-ワークスペースにエクスポートされますか。"><a href="#Q-Azure-Monitor-の診断設定を構成する前に生成されたログやメトリック、アクティビティ-ログは、ストレージ-アカウントや-Log-Analytics-ワークスペースにエクスポートされますか。" class="headerlink" title="Q. Azure Monitor の診断設定を構成する前に生成されたログやメトリック、アクティビティ ログは、ストレージ アカウントや Log Analytics ワークスペースにエクスポートされますか。"></a>Q. Azure Monitor の診断設定を構成する前に生成されたログやメトリック、アクティビティ ログは、ストレージ アカウントや Log Analytics ワークスペースにエクスポートされますか。</h3><p>いいえ、エクスポートされません。<br>診断設定の構成後に生成されたログやメトリックがエクスポートされます。</p><br><h3 id="Q-Azure-Monitor-の診断設定の構成を検討しています。私の環境の場合、コストはどれぐらいになりますか。"><a href="#Q-Azure-Monitor-の診断設定の構成を検討しています。私の環境の場合、コストはどれぐらいになりますか。" class="headerlink" title="Q. Azure Monitor の診断設定の構成を検討しています。私の環境の場合、コストはどれぐらいになりますか。"></a>Q. Azure Monitor の診断設定の構成を検討しています。私の環境の場合、コストはどれぐらいになりますか。</h3><p>誠に残念ではございますが、発生する具体的なコストについては一概に回答出来ません。<br>理由は、ご利用いただいている Azure サービスの種類やリソースの数・Azure のご利用方法など、お客様の環境に影響して出力されるログの量が変わるからです。</p><p>弊社といたしましては、<a href="https://azure.microsoft.com/ja-jp/pricing/calculator/?service=monitor">料金計算ツール</a>を用いてコストをお見積りいただくか、最低限の Azure リソースに対して一時的に診断設定をご構築いただき、1 日あたりのログ量を計測いただくことを一般的な戦略として案内しております。Azure Monitor のコスト見積もりに関しましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/cost-estimate">下記</a>の公開情報もご覧いただけますと幸いです。</p><br><br><br><hr><h4 id="リソース-ログ・メトリックのエクスポート"><a href="#リソース-ログ・メトリックのエクスポート" class="headerlink" title="リソース ログ・メトリックのエクスポート"></a>リソース ログ・メトリックのエクスポート</h4><hr><h3 id="Q-Azure-リソースのログやメトリックを-Log-Analytics-ワークスペースにエクスポートすることを検討しています。必要な権限を教えてください。"><a href="#Q-Azure-リソースのログやメトリックを-Log-Analytics-ワークスペースにエクスポートすることを検討しています。必要な権限を教えてください。" class="headerlink" title="Q. Azure リソースのログやメトリックを Log Analytics ワークスペースにエクスポートすることを検討しています。必要な権限を教えてください。"></a>Q. Azure リソースのログやメトリックを Log Analytics ワークスペースにエクスポートすることを検討しています。必要な権限を教えてください。</h3><p>診断設定を構成するリソース側と、ログのエクスポート先となる Log Analytics ワークスペース側で、以下の権限が必要です。<br>診断設定に関する必要な権限は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/roles-permissions-security#monitoring-contributor">公開情報</a>にも掲載されておりますのでご覧ください。また、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">ロールの割り当て手順</a>や<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">カスタム ロールの作成手順</a> も公開情報をご確認ください。</p><ul><li><p><strong>診断設定を構成するリソース側に必要な権限 (診断設定の作成、変更、削除)</strong><br>Azure Monitor の組み込みロールの場合、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/monitor#monitoring-contributor">Monitoring Contributor (監視共同作成者)</a> や <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#log-analytics-contributor">Log Analytics Contributor (Log Analytics 共同作成者)</a> が該当します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;*/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/write&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/delete&quot;</span><br></pre></td></tr></table></figure></li><li><p><strong>ログのエクスポート先となる Log Analytics ワークスペースに必要な権限</strong><br>Azure Monitor の組み込みロールの場合、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/monitor#monitoring-contributor">Monitoring Contributor (監視共同作成者)</a> や <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#log-analytics-contributor">Log Analytics Contributor (Log Analytics 共同作成者)</a> が該当します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;Microsoft.OperationalInsights/workspaces/read&quot;,</span><br><span class="line">&quot;Microsoft.OperationalInsights/workspaces/sharedKeys/action&quot;</span><br></pre></td></tr></table></figure></li></ul><br><h3 id="Q-Azure-リソースのログやメトリックをストレージアカウントにエクスポートすることを検討しています。必要な権限を教えてください。"><a href="#Q-Azure-リソースのログやメトリックをストレージアカウントにエクスポートすることを検討しています。必要な権限を教えてください。" class="headerlink" title="Q. Azure リソースのログやメトリックをストレージアカウントにエクスポートすることを検討しています。必要な権限を教えてください。"></a>Q. Azure リソースのログやメトリックをストレージアカウントにエクスポートすることを検討しています。必要な権限を教えてください。</h3><p>診断設定を構成するリソース側と、ログのエクスポート先となるストレージ アカウント側で、以下の権限が必要です。<br>診断設定に関する必要な権限は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/roles-permissions-security#limit-access-to-monitoring-related-storage-accounts">公開情報</a>にも掲載されておりますのでご覧ください。また、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">ロールの割り当て手順</a>や<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">カスタム ロールの作成手順</a> も公開情報をご確認ください。</p><ul><li><p><strong>診断設定を構成するリソース側に必要な権限 (診断設定の作成、変更、削除)</strong><br>Azure Monitor の組み込みロールの場合、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/monitor#monitoring-contributor">Monitoring Contributor (監視共同作成者)</a> や <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#log-analytics-contributor">Log Analytics Contributor (Log Analytics 共同作成者)</a> が該当します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;*/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/write&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/delete&quot;</span><br></pre></td></tr></table></figure></li><li><p><strong>ログのエクスポート先となるストレージアカウントに必要な権限</strong><br>Azure Monitor の組み込みロールの場合、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#log-analytics-contributor">Log Analytics Contributor (Log Analytics 共同作成者)</a> が該当します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;Microsoft.Storage/storageAccounts/Read&quot;,</span><br><span class="line">&quot;Microsoft.Storage/storageAccounts/listkeys/action&quot;</span><br></pre></td></tr></table></figure></li></ul><br><h3 id="Q-複数のサブスクリプションのリソース-ログやメトリックを、一つの-Log-Analytics-ワークスペースにエクスポートすることは可能ですか。"><a href="#Q-複数のサブスクリプションのリソース-ログやメトリックを、一つの-Log-Analytics-ワークスペースにエクスポートすることは可能ですか。" class="headerlink" title="Q. 複数のサブスクリプションのリソース ログやメトリックを、一つの Log Analytics ワークスペースにエクスポートすることは可能ですか。"></a>Q. 複数のサブスクリプションのリソース ログやメトリックを、一つの Log Analytics ワークスペースにエクスポートすることは可能ですか。</h3><p>はい、可能です。<br>各リソースの診断設定で同一の Log Analytics ワークスペースをご指定ください。</p><br><h3 id="Q-複数のサブスクリプションのリソース-ログやメトリックを、一つのストレージ-アカウントにエクスポートすることは可能ですか。"><a href="#Q-複数のサブスクリプションのリソース-ログやメトリックを、一つのストレージ-アカウントにエクスポートすることは可能ですか。" class="headerlink" title="Q. 複数のサブスクリプションのリソース ログやメトリックを、一つのストレージ アカウントにエクスポートすることは可能ですか。"></a>Q. 複数のサブスクリプションのリソース ログやメトリックを、一つのストレージ アカウントにエクスポートすることは可能ですか。</h3><p>はい、可能です。<br>ただし、診断設定を構成するリソースとストレージ アカウントは、<u>同じリージョン</u>である必要がございます。<br>診断設定の宛先に関する制限事項は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings#destination-limitations">こちら</a>の公開情報もご確認ください。</p><br><h3 id="Q-別テナントの-Log-Analytics-ワークスペースやストレージ-アカウントに対して診断設定を構成することは可能ですか。"><a href="#Q-別テナントの-Log-Analytics-ワークスペースやストレージ-アカウントに対して診断設定を構成することは可能ですか。" class="headerlink" title="Q. 別テナントの Log Analytics ワークスペースやストレージ アカウントに対して診断設定を構成することは可能ですか。"></a>Q. 別テナントの Log Analytics ワークスペースやストレージ アカウントに対して診断設定を構成することは可能ですか。</h3><p>はい、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings#destination-limitations">Azure Lighthouse を使用することで別テナントの Log Analytics ワークスペースやストレージ アカウントにリソース ログやメトリックをエクスポートすることが可能です</a>。<a href="https://learn.microsoft.com/ja-jp/azure/lighthouse/overview">Azure Lighthouse</a> では、あるテナントのリソースへのアクセスを、別テナント内のユーザーやグループに委任することができます。詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/lighthouse/how-to/onboard-customer">Azure Lighthouse への顧客のオンボード</a>をご覧ください。</p><br><h3 id="Q-Azure-Monitor-の診断設定でリソース-ログとメトリックを、ストレージ-アカウントにエクスポートしています。データの格納場所を教えてください。"><a href="#Q-Azure-Monitor-の診断設定でリソース-ログとメトリックを、ストレージ-アカウントにエクスポートしています。データの格納場所を教えてください。" class="headerlink" title="Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所を教えてください。"></a>Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所を教えてください。</h3><p>メトリックやログをストレージ アカウントにエクスポートすると、追加 BLOB が作成されます。<br>診断設定で<strong>メトリック</strong>をストレージ アカウントにエクスポートした場合には、以下の命名規則で BLOB が作成されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insights-metrics-pt1m/resourceId=/SUBSCRIPTIONS/&#123;subscription ID&#125;/RESOURCEGROUPS/&#123;resource group name&#125;/PROVIDERS/&#123;resource provider name&#125;/&#123;resource type&#125;/&#123;resource name&#125;/y=&#123;four-digit numeric year&#125;/m=&#123;two-digit numeric month&#125;/d=&#123;two-digit numeric day&#125;/h=&#123;two-digit 24-hour clock hour&#125;/m=00/PT1H.json</span><br></pre></td></tr></table></figure><p>リソース共通で <strong>insights-metrics-pt1m</strong> コンテナーに情報が格納されます。<br><img width="650" src="../MonitorDiagnosticsSettingFAQ/image05.png"></p><br><p>診断設定で<strong>ログ</strong>をストレージ アカウントにエクスポートした場合には、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/resource-logs#send-to-azure-storage">以下の命名規則</a>で BLOB が作成されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insights-logs-&#123;log category name&#125;/resourceId=/SUBSCRIPTIONS/&#123;subscription ID&#125;/RESOURCEGROUPS/&#123;resource group name&#125;/PROVIDERS/&#123;resource provider name&#125;/&#123;resource type&#125;/&#123;resource name&#125;/y=&#123;four-digit numeric year&#125;/m=&#123;two-digit numeric month&#125;/d=&#123;two-digit numeric day&#125;/h=&#123;two-digit 24-hour clock hour&#125;/m=00/PT1H.json</span><br></pre></td></tr></table></figure><p><strong>insights-logs-{log category name}</strong> の {log category name} はリソースおよび収集するログの種類により異なりますが、基本的に<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/logs-index">こちら</a>の公開情報経由で参照可能なカテゴリ名が利用されます。例えば、ロジック アプリの診断設定で WorkflowRuntime カテゴリのログをエクスポートした場合、insights-logs-workflowruntime コンテナーに情報が格納されます。<br><img width="650" src="../MonitorDiagnosticsSettingFAQ/image06.png"></p><p>ログのカテゴリは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/logs-index">こちら</a>の公開情報経由で <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-logs/microsoft-logic-workflows-logs">Microsoft.Logic のワークフロー</a>のページを開くと確認できます。<br><img width="650" src="../MonitorDiagnosticsSettingFAQ/image07.png"></p><br><h3 id="Q-Azure-Monitor-の診断設定でリソース-ログとメトリックを、Log-Analytics-ワークスペースにエクスポートしています。データの格納場所を教えてください。"><a href="#Q-Azure-Monitor-の診断設定でリソース-ログとメトリックを、Log-Analytics-ワークスペースにエクスポートしています。データの格納場所を教えてください。" class="headerlink" title="Q. Azure Monitor の診断設定でリソース ログとメトリックを、Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。"></a>Q. Azure Monitor の診断設定でリソース ログとメトリックを、Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。</h3><p>メトリックを Log Analytics ワークスペースにエクスポートした場合は <strong><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/azuremetrics">AzureMetrics</a></strong> テーブルにデータが格納されます。<br>リソース共通で AzureMetrics テーブルにエクスポートされますので、複数のリソースを 1 つの Log Analytics ワークスペースにエクスポートしている場合は、リソース ID (_ResourceId) やメトリック名 (MetricName) 等の条件を指定して検索してください。AzureMetrics テーブルのサンプル クエリは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/queries/azuremetrics">こちら</a>の公開情報をご覧ください。<br><img width="900" src="../MonitorDiagnosticsSettingFAQ/image08.png"></p><p>リソース ログを Log Analytics ワークスペースに送信する場合は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/resource-logs#send-to-log-analytics-workspace">2 種類の収集モード</a>があり、<strong><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/AzureDiagnostics">AzureDiagnostics</a></strong> テーブル、または <strong>リソース固有のテーブル</strong>に格納されます。</p><ul><li><strong>Azure Diagnostics</strong> - すべてのデータが AzureDiagnostics テーブルに書き込まれます。</li><li><strong>リソース固有</strong> - データは、リソースのカテゴリごとに個別のテーブルに書き込まれます。</li></ul><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/resource-logs#select-the-collection-mode">Azure Diagnostics とリソース固有の両方のモードをサポートしている場合</a>は、ターゲットとして Log Analytics ワークスペースを選択すると、ターゲット テーブルを選択するオプションが表示されます。各リソースのログ出力先は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/logs-index#supported-metrics-and-log-categories-by-resource-type">こちら</a>の公開情報経由で参照可能な表や、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/resource-logs-schema#service-specific-schemas">Azure リソース ログの共通およびサービス固有のスキーマ</a>、各リソース側の公開情報等をご確認ください。<br><img width="500" src="../MonitorDiagnosticsSettingFAQ/image09.png"></p><p>例えば、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-logs/microsoft-automation-automationaccounts-logs">Microsoft.Automation/automationAccounts</a> の場合、AzureDiagnostics テーブルにエクスポートされることが分かります。<br>AzureDiagnostics テーブルのサンプル クエリは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/queries/azurediagnostics">こちら</a>の公開情報をご覧ください。<br><img width="700" src="../MonitorDiagnosticsSettingFAQ/image10.png"></p><br><h3 id="Q-Azure-Monitor-の診断設定でリソース-ログとメトリックを、ストレージ-アカウントにエクスポートしています。データの格納場所のコンテナーを変更することはできますか。"><a href="#Q-Azure-Monitor-の診断設定でリソース-ログとメトリックを、ストレージ-アカウントにエクスポートしています。データの格納場所のコンテナーを変更することはできますか。" class="headerlink" title="Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所のコンテナーを変更することはできますか。"></a>Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所のコンテナーを変更することはできますか。</h3><p>いいえ、データの格納場所のコンテナーを変更することはできません。<br>リソース ログとメトリックを、ストレージ アカウントにエクスポートした場合は、<a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定でリソース ログとメトリックを、ストレージ アカウントにエクスポートしています。データの格納場所を教えてください。</a> や <a href="#Q-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%A0%BC%E7%B4%8D%E5%A0%B4%E6%89%80%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. Azure Monitor の診断設定でリソース ログとメトリックを、Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。</a> に記載した格納場所にコンテナーが作成されます。</p><br><h3 id="Q-Azure-VM-のプラットフォーム-メトリック-ホスト-OS-メトリック-を-Log-Analytics-ワークスペースにエクスポートしたいのですが、Azure-ポータル上に設定画面が見当たりません。"><a href="#Q-Azure-VM-のプラットフォーム-メトリック-ホスト-OS-メトリック-を-Log-Analytics-ワークスペースにエクスポートしたいのですが、Azure-ポータル上に設定画面が見当たりません。" class="headerlink" title="Q. Azure VM のプラットフォーム メトリック (ホスト OS メトリック) を Log Analytics ワークスペースにエクスポートしたいのですが、Azure ポータル上に設定画面が見当たりません。"></a>Q. Azure VM のプラットフォーム メトリック (ホスト OS メトリック) を Log Analytics ワークスペースにエクスポートしたいのですが、Azure ポータル上に設定画面が見当たりません。</h3><p>Azure VM の<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/microsoft-classiccompute-virtualmachines-metrics">プラットフォーム メトリック (ホスト OS メトリック)</a> に関する診断設定は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings?tabs=powershell">Azure PowerShell</a> 等で設定可能です。<br>設定手順の詳細は、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/#4-Azure-VM-%E3%81%AE%E3%83%97%E3%83%A9%E3%83%83%E3%83%88-%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">こちら</a>のブログをご参照ください。</p><br><br><br><hr><h3 id="アクティビティ-ログのエクスポート"><a href="#アクティビティ-ログのエクスポート" class="headerlink" title="アクティビティ ログのエクスポート"></a>アクティビティ ログのエクスポート</h3><hr><h3 id="Q-アクティビティ-ログの診断設定の設定手順を教えてください。"><a href="#Q-アクティビティ-ログの診断設定の設定手順を教えてください。" class="headerlink" title="Q. アクティビティ ログの診断設定の設定手順を教えてください。"></a>Q. アクティビティ ログの診断設定の設定手順を教えてください。</h3><p>Azure ポータルから設定する場合は [監視] を検索し、[アクティビティ ログ] の [診断設定] から構成いただけます。<br>設定手順の詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings?tabs=portal">こちら</a>の公開情報をご覧ください。<br><img width="750" src="../MonitorDiagnosticsSettingFAQ/image11.png"></p><br><h3 id="Q-アクティビティ-ログのカテゴリの詳細を教えてください。"><a href="#Q-アクティビティ-ログのカテゴリの詳細を教えてください。" class="headerlink" title="Q. アクティビティ ログのカテゴリの詳細を教えてください。"></a>Q. アクティビティ ログのカテゴリの詳細を教えてください。</h3><p>アクティビティ ログのカテゴリの詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log-schema">Azure アクティビティ ログのイベント スキーマ</a>の公開情報をご覧ください。</p><br><h3 id="Q-アクティビティ-ログを-Log-Analytics-ワークスペースにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。"><a href="#Q-アクティビティ-ログを-Log-Analytics-ワークスペースにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。" class="headerlink" title="Q. アクティビティ ログを Log Analytics ワークスペースにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。"></a>Q. アクティビティ ログを Log Analytics ワークスペースにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。</h3><p>診断設定を構成するサブスクリプションと、ログのエクスポート先となる Log Analytics ワークスペース側で以下の権限が必要です。Azure Monitor の組み込みロールの場合、サブスクリプションをスコープとして <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/monitor#monitoring-contributor">Monitoring Contributor (監視共同作成者)</a> や <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#log-analytics-contributor">Log Analytics Contributor (Log Analytics 共同作成者)</a> を付与いただけますと幸いです。<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">ロールの割り当て手順</a>や<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">カスタム ロールの作成手順</a> は公開情報をご覧ください。</p><ul><li><p><strong>サブスクリプション スコープで必要な権限 (診断設定の作成、変更、削除)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;*/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/write&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/delete&quot;</span><br></pre></td></tr></table></figure></li><li><p><strong>ログのエクスポート先となる Log Analytics ワークスペースに必要な権限</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;Microsoft.OperationalInsights/workspaces/read&quot;,</span><br><span class="line">&quot;Microsoft.OperationalInsights/workspaces/sharedKeys/action&quot;</span><br></pre></td></tr></table></figure></li></ul><br><h3 id="Q-アクティビティ-ログをストレージ-アカウントにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。"><a href="#Q-アクティビティ-ログをストレージ-アカウントにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。" class="headerlink" title="Q. アクティビティ ログをストレージ アカウントにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。"></a>Q. アクティビティ ログをストレージ アカウントにエクスポートすることを検討しています。診断設定を構成するために必要な権限を教えてください。</h3><p>診断設定を構成するサブスクリプションと、ログのエクスポート先となるストレージ アカウント側で以下の権限が必要です。Azure Monitor の組み込みロールの場合、サブスクリプションをスコープとして <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/monitor#monitoring-contributor">Monitoring Contributor (監視共同作成者)</a> や <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles/analytics#log-analytics-contributor">Log Analytics Contributor (Log Analytics 共同作成者)</a> を付与いただけますと幸いです。<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">ロールの割り当て手順</a>や<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/custom-roles-portal">カスタム ロールの作成手順</a> は公開情報をご覧ください。</p><ul><li><p><strong>サブスクリプション スコープで必要な権限 (診断設定の作成、変更、削除)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;*/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/read&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/write&quot;,</span><br><span class="line">&quot;Microsoft.Insights/DiagnosticSettings/delete&quot;</span><br></pre></td></tr></table></figure></li><li><p><strong>ログのエクスポート先となるストレージアカウントに必要な権限</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;Microsoft.Storage/storageAccounts/Read&quot;,</span><br><span class="line">&quot;Microsoft.Storage/storageAccounts/listkeys/action&quot;</span><br></pre></td></tr></table></figure></li></ul><br><h3 id="Q-特定のリソースのアクティビティ-ログを、Log-Analytics-ワークスペースやストレージ-アカウントにエクスポートすることは可能ですか。"><a href="#Q-特定のリソースのアクティビティ-ログを、Log-Analytics-ワークスペースやストレージ-アカウントにエクスポートすることは可能ですか。" class="headerlink" title="Q. 特定のリソースのアクティビティ ログを、Log Analytics ワークスペースやストレージ アカウントにエクスポートすることは可能ですか。"></a>Q. 特定のリソースのアクティビティ ログを、Log Analytics ワークスペースやストレージ アカウントにエクスポートすることは可能ですか。</h3><p>いいえ、特定のリソースのアクティビティ ログのみをエクスポートすることはできません。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/resource-manager-diagnostic-settings?tabs=json#diagnostic-setting-for-an-activity-log">アクティビティ ログの診断設定はサブスクリプション単位で指定する</a>ものであり、リソース単位で設定することはできません。</p><br><h3 id="Q-Azure-ポータルからリソース-グループの-アクティビティ-ログ-gt-診断設定-を開くと、アクティビティ-ログの診断設定が表示されます。リソース-グループ単位でアクティビティ-ログの診断設定を作成できるのでしょうか。"><a href="#Q-Azure-ポータルからリソース-グループの-アクティビティ-ログ-gt-診断設定-を開くと、アクティビティ-ログの診断設定が表示されます。リソース-グループ単位でアクティビティ-ログの診断設定を作成できるのでしょうか。" class="headerlink" title="Q. Azure ポータルからリソース グループの [アクティビティ ログ] &gt; [診断設定] を開くと、アクティビティ ログの診断設定が表示されます。リソース グループ単位でアクティビティ ログの診断設定を作成できるのでしょうか。"></a>Q. Azure ポータルからリソース グループの [アクティビティ ログ] &gt; [診断設定] を開くと、アクティビティ ログの診断設定が表示されます。リソース グループ単位でアクティビティ ログの診断設定を作成できるのでしょうか。</h3><p>いいえ、できません。<br>リソース グループの [アクティビティ ログ] &gt; [診断設定] からも、アクティビティ ログの診断設定が表示されますが、あくまで表示されているだけであり、アクティビティ ログの診断設定はサブスクリプション単位でしか設定できません。</p><br><h3 id="Q-Azure-Monitor-の診断設定で、アクティビティ-ログをストレージ-アカウントにエクスポートしています。データの格納場所を教えてください。"><a href="#Q-Azure-Monitor-の診断設定で、アクティビティ-ログをストレージ-アカウントにエクスポートしています。データの格納場所を教えてください。" class="headerlink" title="Q. Azure Monitor の診断設定で、アクティビティ ログをストレージ アカウントにエクスポートしています。データの格納場所を教えてください。"></a>Q. Azure Monitor の診断設定で、アクティビティ ログをストレージ アカウントにエクスポートしています。データの格納場所を教えてください。</h3><p>アクティビティ ログをストレージ アカウントにエクスポートすると、追加 BLOB が作成され、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell#send-to-azure-storage">以下の命名規則</a>で BLOB が作成されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insights-activity-logs/resourceId=/SUBSCRIPTIONS/&#123;subscription ID&#125;/y=&#123;four-digit numeric year&#125;/m=&#123;two-digit numeric month&#125;/d=&#123;two-digit numeric day&#125;/h=&#123;two-digit 24-hour clock hour&#125;/m=00/PT1H.json</span><br></pre></td></tr></table></figure><p>リソース共通で <strong>insights-activity-logs</strong> コンテナーに情報が格納されます。<br><img width="650" src="../MonitorDiagnosticsSettingFAQ/image12.png"></p><br><h3 id="Q-Azure-Monitor-の診断設定で、アクティビティ-ログを-Log-Analytics-ワークスペースにエクスポートしています。データの格納場所を教えてください。"><a href="#Q-Azure-Monitor-の診断設定で、アクティビティ-ログを-Log-Analytics-ワークスペースにエクスポートしています。データの格納場所を教えてください。" class="headerlink" title="Q. Azure Monitor の診断設定で、アクティビティ ログを Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。"></a>Q. Azure Monitor の診断設定で、アクティビティ ログを Log Analytics ワークスペースにエクスポートしています。データの格納場所を教えてください。</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell#send-to-log-analytics-workspace">アクティビティ ログを Log Analytics ワークスペースにエクスポートした場合</a>は <strong><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/azureactivity">AzureActivity</a></strong> テーブルにデータが格納されます。<br>AzureMetrics テーブルのサンプル クエリは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/queries/azureactivity">こちら</a>の公開情報をご覧ください。<br><img width="900" src="../MonitorDiagnosticsSettingFAQ/image13.png"></p><br><h3 id="Q-アクティビティ-ログを-Log-Analytics-ワークスペースにエクスポートした場合、Log-Analytics-ワークスペースに対する料金が発生しますか。"><a href="#Q-アクティビティ-ログを-Log-Analytics-ワークスペースにエクスポートした場合、Log-Analytics-ワークスペースに対する料金が発生しますか。" class="headerlink" title="Q. アクティビティ ログを Log Analytics ワークスペースにエクスポートした場合、Log Analytics ワークスペースに対する料金が発生しますか。"></a>Q. アクティビティ ログを Log Analytics ワークスペースにエクスポートした場合、Log Analytics ワークスペースに対する料金が発生しますか。</h3><p>いいえ、アクティビティ ログを Log Analytics ワークスペースにエクスポートしても、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell#send-to-log-analytics-workspace">Log Analytics ワークスペースに対するインジェスト料金や保持料金は発生しません</a>。</p><br><br><br><hr><h3 id="トラブルシューティング"><a href="#トラブルシューティング" class="headerlink" title="トラブルシューティング"></a>トラブルシューティング</h3><hr><h3 id="Q-Azure-Monitor-の診断設定によるプラットフォーム-メトリックやリソース-ログのエクスポートは、100-のデータ-エクスポートを保証していますか。"><a href="#Q-Azure-Monitor-の診断設定によるプラットフォーム-メトリックやリソース-ログのエクスポートは、100-のデータ-エクスポートを保証していますか。" class="headerlink" title="Q. Azure Monitor の診断設定によるプラットフォーム メトリックやリソース ログのエクスポートは、100 % のデータ エクスポートを保証していますか。"></a>Q. Azure Monitor の診断設定によるプラットフォーム メトリックやリソース ログのエクスポートは、100 % のデータ エクスポートを保証していますか。</h3><p>いいえ、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings?tabs=portal#possibility-of-duplicated-or-dropped-data">100 % のデータ エクスポートを保証しておりません</a>。<br>診断設定は、1 日あたりペタバイト単位のデータをお手頃な価格で、効率よくエクスポートすることを前提に設計されているため、完全なトランザクションは保証しておらず、ログやプラットフォーム メトリックが一部欠損する可能性がございます。<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/DiagnosticSettings/">診断設定によるプラットフォーム メトリックやリソース ログの一部欠損について</a>のブログでも紹介しておりますので、ご確認いただけますと幸いです。</p><br><h3 id="Q-Log-Analytics-ワークスペースやストレージ-アカウントにログやメトリックをエクスポートしていますが、データが格納されていません。考えられる原因を教えてください。"><a href="#Q-Log-Analytics-ワークスペースやストレージ-アカウントにログやメトリックをエクスポートしていますが、データが格納されていません。考えられる原因を教えてください。" class="headerlink" title="Q. Log Analytics ワークスペースやストレージ アカウントにログやメトリックをエクスポートしていますが、データが格納されていません。考えられる原因を教えてください。"></a>Q. Log Analytics ワークスペースやストレージ アカウントにログやメトリックをエクスポートしていますが、データが格納されていません。考えられる原因を教えてください。</h3><p>考えられる原因は以下の通りです。<br>なお、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/DiagnosticSettings/">診断設定によるエクスポートでは、制約上、プラットフォーム メトリックやログの一部欠損は発生する可能性がございます</a>ので、予めご留意ください。</p><p><strong>1. ログの出力に時間を要している</strong><br>診断設定は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings#requirements-and-limitations">基本的には 90 分以内にデータがエクスポートされ始めますが、これよりもお時間がかかることもございます</a>。<br>診断設定の構成後、1 日程度お時間をおいていただき、ログを確認できるかどうかをご確認いただけますと幸いです。</p><p><strong>2. 対象のログがそもそも生成されていない</strong><br>診断設定を構成しますと、リソース側から出力されたログは、基盤側の内部パイプラインを通じて Log Analytics ワークスペースやストレージ アカウントに送信されます。そもそもリソース側でログが生成されていない場合には、Log Analytics ワークスペースやストレージ アカウントにはログが収集されません。各リソースのログが生成される条件や契機をご確認されたい場合には、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/logs-index">各リソース観点</a>でお問い合わせのご起票をお願いいたします。</p><p><strong>3. ストレージ アカウントのネットワーク設定で “信頼された Microsoft サービス” が許可されていない</strong><br>ログの出力先がストレージ アカウントの場合は、ストレージ アカウントのネットワーク設定により、データがエクスポートされていない可能性がございます。宛先のストレージ アカウントが選択したネットワークからのアクセスを許可する構成である場合、 <u>[信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します]</u> が有効になっているかどうかをご確認ください。</p><p>完全に外部からのアクセスを無効にすると、Azure Monitor サービスからの通信が遮断され、ログやメトリックをエクスポートすることができません。また、選択したネットワークからのアクセスを許可する構成の場合、Azure Monitor サービスからの通信を許可するために <u>[信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します] </u>を有効にしていただく必要がございます。<br><img width="900" src="../MonitorDiagnosticsSettingFAQ/image14.png"></p><p>上記に該当せず、一部の欠損ではなく継続的にログやメトリックが出力されていない場合は、下記の情報をお寄せいただき、弊社サポート窓口までお問い合わせください。</p><p>・診断設定を構成しているリソースのリソース ID<br>・診断設定の名前<br>・ログやメトリックが出力されることが想定された日時 (タイムゾーンを明記してご記載ください。例. 2024-12-30 12:00 JST)<br>・出力されることが想定されたログのカテゴリ名やメトリック名</p><br><h3 id="Q-Azure-Monitor-の診断設定を構成しましたが、設定が消えてしまいました。"><a href="#Q-Azure-Monitor-の診断設定を構成しましたが、設定が消えてしまいました。" class="headerlink" title="Q. Azure Monitor の診断設定を構成しましたが、設定が消えてしまいました。"></a>Q. Azure Monitor の診断設定を構成しましたが、設定が消えてしまいました。</h3><p><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/#2-3-%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%8C%E6%B6%88%E3%81%88%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B">日本語を含む、英数字以外の文字がリソース名に含まれる場合、診断設定を作成しても設定が消えることがあります</a>。<br>ただし本事象は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings?tabs=portal#setting-disappears-because-of-non-ascii-characters-in-resourceid">公開情報</a>にも記載があるとおり、診断設定が英数字以外の文字をサポートしないために発生する事象であるため、製品の不具合ではございません。</p><br><h3 id="Q-新たに-Azure-Monitor-の診断設定を構成しようとしたところ、ストレージ-アカウントの保持期間を指定する項目が表示されません。以前は、診断設定にてストレージ-アカウントにエクスポートした場合、保持期間を指定する項目が表示されていました。"><a href="#Q-新たに-Azure-Monitor-の診断設定を構成しようとしたところ、ストレージ-アカウントの保持期間を指定する項目が表示されません。以前は、診断設定にてストレージ-アカウントにエクスポートした場合、保持期間を指定する項目が表示されていました。" class="headerlink" title="Q. 新たに Azure Monitor の診断設定を構成しようとしたところ、ストレージ アカウントの保持期間を指定する項目が表示されません。以前は、診断設定にてストレージ アカウントにエクスポートした場合、保持期間を指定する項目が表示されていました。"></a>Q. 新たに Azure Monitor の診断設定を構成しようとしたところ、ストレージ アカウントの保持期間を指定する項目が表示されません。以前は、診断設定にてストレージ アカウントにエクスポートした場合、保持期間を指定する項目が表示されていました。</h3><p><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/">こちら</a>のブログでもご紹介しておりますとおり、診断設定固有のストレージ アカウントの保持機能は廃止されます。<br>以前は、診断設定にてストレージ アカウントを出力先としていた場合、診断設定側でログの保持期間の指定ができましたが、今後はストレージ アカウント側の Azure Storage ライフサイクル管理にて保持期間を指定する必要がございます。<br>また、診断設定固有のストレージ アカウントの保持機能の廃止に伴う移行手順は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/migrate-to-azure-storage-lifecycle-policy?tabs=portal">こちら</a>の公開情報をご覧ください。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は &lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal&quot;&gt;Azure Monitor の診断設定&lt;/a&gt;に関するよくあるご質問をご紹介します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor エージェントにより収集される Heartbeat ログを使用した死活監視方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM_AMA/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM_AMA/</id>
    <published>2025-02-13T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.637Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村、佐藤です。<br>Azure Monitor エージェントを使用した死活監視方法について本ブログで紹介します。<br>本ブログは、以下の過去の記事 (Log Analytics エージェントを使用した死活監視) を Azure Monitor エージェント版に更新したものとなります。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM/">https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM/</a></p><br><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#Heartbeat-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E6%AD%BB%E6%B4%BB%E7%9B%A3%E8%A6%96%E3%82%92%E8%A1%8C%E3%81%86%E3%81%9F%E3%82%81%E3%81%AB">Heartbeat を使用した死活監視を行うために</a></li><li><a href="#Heartbeat-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9F%E6%AD%BB%E6%B4%BB%E7%9B%A3%E8%A6%96">Heartbeat を使用した死活監視</a></li><li><a href="#Heartbeat-%E3%81%AE%E5%8F%8E%E9%9B%86%E3%81%8C%E9%81%85%E5%BB%B6%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">Heartbeat の収集が遅延していることを確認する</a></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li></ul><br><h2 id="Heartbeat-を使用した死活監視を行うために"><a href="#Heartbeat-を使用した死活監視を行うために" class="headerlink" title="Heartbeat を使用した死活監視を行うために"></a>Heartbeat を使用した死活監視を行うために</h2><p>Azure Monitor エージェントを使用して死活監視をするためには、Heartbeat ログ (マシンが実行中の間、1 分間に 1 度収集されるログ) を収集する必要がございます。</p><p>まず、Azure Monitor エージェントがログを収集するよう構成する方法からご説明します。<br>Azure Monitor エージェントは、データ収集ルールと呼ばれるリソースに仮想マシンを関連付けることで、インストールおよび必要なデータ収集設定の連携が行われます。<br>データ収集ルールは、Azure Monitor エージェントを用いてどのようなログを収集するかを Azure Monitor エージェントに伝える指示書の役割を果たします。</p><p>データ収集ルールでデータ ソース (どのようなログを取得するか) として設定可能なログ種は以下の通りです。</p><p>■ Windows OS</p><ul><li>イベント ログ</li><li>パフォーマンス</li><li>テキスト ログ</li><li>IIS ログ</li></ul><p>■ Linux OS</p><ul><li>syslog</li><li>パフォーマンス</li><li>テキスト ログ</li></ul><p>データ収集ルールは、上述のいずれかのデータ ソースを収集するよう指定する必要があります。マシンをデータ収集ルールと関連付け、上述のデータ ソースのログ収集を開始すると、Heartbeat ログも併せて収集されるようになります。<br>すなわち、Azure Monitor エージェントをご利用いただく場合、基本的に Heartbeat ログを単体で収集することはできかねます。</p><p>では、以下に Azure Monitor エージェントを使用したログ収集を行うための基本的な流れを簡単にご説明します。</p><ol><li>Log Analytics ワークスペースの作成</li><li>データ収集ルールの作成とデータ収集ルールへの関連付け</li><li>アラート設定</li></ol><br><h3 id="1-Log-Analytics-ワークスペースの作成"><a href="#1-Log-Analytics-ワークスペースの作成" class="headerlink" title="1. Log Analytics ワークスペースの作成"></a>1. Log Analytics ワークスペースの作成</h3><p>ログの送信先となる Log Analytics ワークスペースを作成します。</p><p>– Create a Log Analytics workspace<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal</a></p><br><h3 id="2-データ収集ルールの作成とデータ収集ルールへの関連付け"><a href="#2-データ収集ルールの作成とデータ収集ルールへの関連付け" class="headerlink" title="2. データ収集ルールの作成とデータ収集ルールへの関連付け"></a>2. データ収集ルールの作成とデータ収集ルールへの関連付け</h3><p>1 で作成した Log Analytics ワークスペースにログを収集するよう、データ収集ルールを構成します。</p><p>– Collect data with Azure Monitor Agent<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection</a><br>(<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection#data-sources">“データ ソース”</a> 項目にて、各データ ソースをクリックすることでデータ ソースごとの設定方法の公開情報に遷移します。)</p><p>データ収集ルールにマシンを関連づけると Azure Monitor エージェントがインストールされます。<br>(すでにインストール済みの場合には、マシン上に Azure Monitor エージェントが存在することが確認されたのち、インストールがスキップされます。)</p><br><h3 id="3-アラート設定"><a href="#3-アラート設定" class="headerlink" title="3. アラート設定"></a>3. アラート設定</h3><p>作成した Log Analytics ワークスペースの画面左側にあるメニュー内 [ログ] をクリックします。<br>[ログ] 検索フィールドでクエリを実行し、アラートの設定を行います。アラートの評価期間や設定したクエリを実行する頻度、<br>アラートの通知方法等を設定します。詳細は以下の弊社公開情報をご覧ください。</p><p>– Create or edit a log search alert rule<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule</a></p><p>– Action groups<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups</a></p><div class="alert is-info"><p class="alert-title">Note</p><p>(補足)</p><p>前述の通り、Azure Monitor エージェントをご利用いただく場合、基本的に Heartbeat ログを単体で収集することはできません。</p><p>どうしても、Heartbeat ログだけを収集する必要がある場合には、存在しないダミーの情報を収集するようデータ収集ルールを構成することで、実質 Heartbeat ログだけを収集すること自体は可能でございます。  </p><p><strong>&lt;カスタム パス追加手順&gt;</strong></p><p>以下すべて [データ ソースの追加] タブでの設定でございます。</p><ol><li>[データ ソースの種類] にて [パフォーマンス カウンター] を選択します。</li><li>[パフォーマンス カウンターを構成する] という項目で [カスタム] タブを選択します。</li><li>[収集するパフォーマンス カウンターと、そのサンプリング頻度を構成します:] に “\dummy” と入力し、[追加] をクリックします。</p><p><img src="/blog/LogAnalytics/MonitorVM_AMA/sample_dummypath.png"></li><li>お手数ではございますが、3. で追加した “\dummy” 以外のパスの左側にあるチェックをすべて外します。</li></ol><p>なお、パフォーマンス カウンターについて、任意の収集設定を行う方法については以下のブログ記事に記載しております。</p><p>設定方法の詳細は以下をご確認ください。</p><p>– 既定で用意されているもの以外のパフォーマンス カウンターを収集する方法</p><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/">https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/</a></p></div><br><br><h2 id="Heartbeat-を使用した死活監視"><a href="#Heartbeat-を使用した死活監視" class="headerlink" title="Heartbeat を使用した死活監視"></a>Heartbeat を使用した死活監視</h2><p>Heartbeat は Azure Monitor エージェントによって Log Analytics ワークスペースに既定で収集されます。<br>Log Analytics ワークスペースで Heartbeat のレコードを確認すると、1 分間に 1 回レコードが生成されていることがわかります。<br>この Heartbeat を使用した死活監視の例をご紹介します。</p><br><h3 id="例-1-あるマシンから-Heartbeat-が収集されていることを確認する"><a href="#例-1-あるマシンから-Heartbeat-が収集されていることを確認する" class="headerlink" title="例 1. あるマシンから Heartbeat が収集されていることを確認する"></a>例 1. あるマシンから Heartbeat が収集されていることを確認する</h3><p>下記クエリでは、指定した VM の Heartbeat を抽出します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| where Computer == &#x27;computer-name&#x27;</span><br></pre></td></tr></table></figure><p><img src="/blog/LogAnalytics/MonitorVM_AMA/result_example1.png"></p><p>上記クエリを利用したアラート ルールの設定例を示します。まず、アラート ルールの主な設定項目をご説明します。<br><img src="/blog/LogAnalytics/MonitorVM_AMA/parameters.png"></p><ul><li><p>集計の粒度 (赤枠線部分)<br>クエリで取得したログを一つのグループにまとめる単位を示します。<br>以下のように 5 分と設定した場合は 5 分単位でグループ化されます。</p></li><li><p>演算子としきい値 (黄色ハイライト部分)<br>上記クエリは、直近 5 分以内の Heartbeat を返しますので、当該クエリの実行結果が 0 件の場合は直近 5 分間 Heartbeat が収集されていないことを意味します。そのため、演算子は 「等しい」、しきい値は 「0」 としています。</p></li><li><p>評価の頻度 (黄色枠線部分)<br>アラートの検索クエリが実行される間隔です。この例では、5 分ごとにクエリが実行されます。</p></li><li><p>評価期間 (黒枠線部分)<br>クエリの対象とするデータの時間範囲です。基本的には [集計の粒度] と同じ時間範囲になります。</p></li><li><p>違反の数 (緑枠線部分)<br>評価期間内にある集約ポイントのうち (集約ポイントの個数 = 評価期間 ÷ 集計の粒度) 、指定した回数以上発報条件を満たしたらアラートが発報します。<br>(連続で発報条件を満たした回数ではございません。)</p></li></ul><p>例えば、以下の設定であったとします。<br>その場合、具体的には以下の挙動となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">集計の粒度 : 5 分</span><br><span class="line">評価頻度 : 10 分</span><br><span class="line">評価期間: 15 分</span><br><span class="line">違反の数 : 2 (評価期間内に 2 回閾値を超えたら発報する構成の場合)</span><br></pre></td></tr></table></figure><p>以下、〇はしきい値を超えること、×はしきい値を超えないことを表します。<br>10:00 の評価<br>9:45 ~ 9:50 のログ :  ×<br>9:50 ~ 9:55 のログ : 〇<br>9:55 ~ 10:00 のログ : ×<br>———&gt; 発報しない</p><p>10:10 の評価<br>9:55 ~ 10:00 のログ : ×<br>10:00 ~ 10:05 のログ :  〇<br>10:05 ~ 10:10 のログ : 〇<br>———&gt; 発報する</p><p>10:20 の評価<br>10:05 ~ 10:10 のログ : 〇<br>10:10 ~ 10:15 のログ :  ×<br>10:15 ~ 10:20 のログ : 〇<br>———&gt; 発報する</p><p>&lt;ご参考&gt;<br>アラートの設定項目は下記弊社公開情報にも記載しております。<br>–- Create or edit a log search alert rule<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule</a></p><br><h3 id="例-2-直近-15-分間に-Heartbeat-が途絶えた-VM-を確認する"><a href="#例-2-直近-15-分間に-Heartbeat-が途絶えた-VM-を確認する" class="headerlink" title="例 2. 直近 15 分間に Heartbeat が途絶えた VM を確認する"></a>例 2. 直近 15 分間に Heartbeat が途絶えた VM を確認する</h3><p>下記クエリでは、直近 15 分間、VM の Heartbeat が送信されなかった場合に検知します。<br>LastCall は 各コンピューターの Heartbeat が生成された最新の時刻です。<br>Heartbeat の最新時刻が 15 分より前の場合、実行結果が返されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| summarize LastCall = max(TimeGenerated) by Computer </span><br><span class="line">| where LastCall &lt; ago(15m)</span><br></pre></td></tr></table></figure><p><img src="/blog/LogAnalytics/MonitorVM_AMA/result_example2.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>アラートルールで設定する場合、アラート ルール側では [集計の粒度] で 15 分より長い粒度 (期間) を指定する必要があります。</p><p>例えばこのクエリを利用する場合には、以下の様に設定する必要があります。</p><p>メジャー: テーブルの行</p><p>集計の種類: カウント</p><p>集計の粒度: 30 分 (クエリで指定した期間より長い期間)</p><p>演算子: 次の値より大きい</p><p>しきい値: 0</p><p>頻度: 15分</p></div><br><h3 id="例-3-直近-2-日間に-Heartbeat-が記録されたマシンのうち、直近-5-分間に-Heartbeat-が途絶えた-VM-を確認する"><a href="#例-3-直近-2-日間に-Heartbeat-が記録されたマシンのうち、直近-5-分間に-Heartbeat-が途絶えた-VM-を確認する" class="headerlink" title="例 3. 直近 2 日間に Heartbeat が記録されたマシンのうち、直近 5 分間に Heartbeat が途絶えた VM を確認する"></a>例 3. 直近 2 日間に Heartbeat が記録されたマシンのうち、直近 5 分間に Heartbeat が途絶えた VM を確認する</h3><p>下記クエリでは、直近 2 日間に Heartbeat が記録されたマシンの中で、直近 5 分間に Heartbeat が途絶えた VM を検知します。<br>変数 ComputerListFor2days には、直近 2 日間に Heartbeat が記録されたマシンと、最新の TimeGenerated の情報が格納されます。<br>次に、直近 5 分間に収集された Heartbeat と、変数 ComputerListFor2days のデータを、Computer 列で <a href="https://learn.microsoft.com/ja-jp/kusto/query/join-rightouter?view=microsoft-fabric">rightouter 結合</a>します。<br>最後に、直近 5 分間に Heartbeat が記録されていないマシン の AggregatedValue を 0 に設定します。<br>この AggregatedValue の値を監視することで Heartbeat が収集されなくなったマシンを検知することが可能です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let ComputerListFor2days =</span><br><span class="line">    (Heartbeat</span><br><span class="line">    | where TimeGenerated &gt; ago(2d)</span><br><span class="line">    | summarize max(TimeGenerated) by Computer</span><br><span class="line">    );</span><br><span class="line">Heartbeat</span><br><span class="line">| where TimeGenerated &gt; ago(5m)</span><br><span class="line">| summarize count() by Computer </span><br><span class="line">| join kind=rightouter ComputerListFor2days on $left.Computer == $right.Computer</span><br><span class="line">| extend AggregatedValue = iif(isnull(count_), 0, count_)</span><br><span class="line">| project ComputerName = Computer1, AggregatedValue</span><br></pre></td></tr></table></figure><br><img width="600" src="../MonitorVM_AMA/result_example4.png"><p>上記クエリの設定例をご紹介します。<br>下記の設定の場合、[評価の頻度] の 5 分毎に、直近 2 日間に Heartbeat が記録されたマシンのうち、直近 5 分間に Heartbeat が途絶えた VM を検知します。また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#monitor-multiple-instances-of-a-resource-using-dimensions">ディメンション名</a> で ComputerName を指定することで、VM 単位で Heartbeat が途絶えたことを監視できます。</p><img width="600" src="../MonitorVM_AMA/setting_example3.png"><br><br><h2 id="Heartbeat-の収集が遅延していることを確認する"><a href="#Heartbeat-の収集が遅延していることを確認する" class="headerlink" title="Heartbeat の収集が遅延していることを確認する"></a>Heartbeat の収集が遅延していることを確認する</h2><p>死活監視のアラートを検知したにもかかわらず、監視対象の VM は正常に動作している。<br>このようなときは、Heartbeat の収集遅延が発生している可能性がございます。</p><p>– Azure Monitor でのログ データ インジェスト時間<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time">https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time</a></p><p>※ ログ データを取り込むための一般的な待ち時間は 20 秒から 3 分です。ただしシステムの負荷状況によりさらに遅延が発生する可能性がございます。</p><p>Heartbeat の収集遅延には、様々な理由が考えられますが、以下のクエリを実行していただきますと、<br>“Azure Monitor エージェントがデータを生成してから Azure 側でデータを受信するまで” の間に遅延が発生していたことを確認できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| where Computer == &quot;Computer Name&quot;</span><br><span class="line">| extend E2EIngestionLatency = ingestion_time() - TimeGenerated</span><br><span class="line">| project Computer, TimeGenerated, _TimeReceived, ingestion_time(), E2EIngestionLatency</span><br><span class="line">| order by TimeGenerated desc</span><br></pre></td></tr></table></figure><p>※ TimeGenerated : データ ソースが生成された時刻<br>※ _TimeReceived : Azure Monitor のインジェスト エンドポイントによって受信される時刻<br>※ $ingestion_time : Log Analytics ワークスペースに保存され、クエリ検索が可能となる時刻<br>※ E2EIngestionLatency : ログが生成されてから Log Analytics ワークスペースにログが送信されるまでに要した時間</p><p>下記画像は上記クエリを実行した例です。<br>赤線で囲んだ部分が「ログが生成されてから Log Analytics ワークスペースにログが送信されるまでに要した時間」です。</p><p><img src="/blog/LogAnalytics/MonitorVM_AMA/result_latency.png"></p><p>Heartbeat ログ アラートが期待されないタイミングで発報した場合の調査方法については、よろしければ以下のブログ記事もご参照ください。</p><p>– マシンが起動中にも関わらず Heartbeat ログ アラートが発報された場合の調査方法<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/Unexpected_Heartbeat_logalert/">https://jpazmon-integ.github.io/blog/LogAnalytics/Unexpected_Heartbeat_logalert/</a></p><br><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事では、Azure Monitor エージェントを使用して Heartbeat ログを収集する方法および、収集された Heartbeat ログを用いて死活監視を行う方法をご案内いたしました。</p><p>Heartbeat ログを含め、仮想マシンの死活監視全般については以下のブログ記事でもご案内しております。よろしければこちらもご参照いただけますと幸いです。</p><p>– Azure VM における死活監視の考え方<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/</a></p><p>最後までお読みいただき、ありがとうございました！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村、佐藤です。&lt;br&gt;Azure Monitor エージェントを使用した死活監視方法について本ブログで紹介します。&lt;br&gt;本ブログは、以下の過去の記事 (Log Analytics エージェントを使用した死活</summary>
      
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor のアラートに関するよくあるご質問</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/MonitorAlertFAQ/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/MonitorAlertFAQ/</id>
    <published>2025-01-28T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.401Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は Azure Monitor のアラートに関するよくあるご質問をご紹介します。<br><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/">リソース正常性アラート</a>や<a href="https://jpazmon-integ.github.io/blog/ame/HowToSetUpServiceHealthAlertsAndRecommendedSettings/">サービス正常性アラート</a>については、別途ブログを投稿しておりますので併せてご覧いただけますと幸いです！</p><br><span id="more"></span><h4 id="lt-メトリック-アラート-ルール-gt"><a href="#lt-メトリック-アラート-ルール-gt" class="headerlink" title="&lt;メトリック アラート ルール&gt;"></a>&lt;メトリック アラート ルール&gt;</h4><ul><li><a href="#Q-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E9%A0%85%E7%9B%AE%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. メトリック アラート ルールの設定項目を教えてください。</a></li><li><a href="#Q-%E9%9D%99%E7%9A%84%E3%81%97%E3%81%8D%E3%81%84%E5%80%A4%E3%81%AE%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E3%80%812-%E5%9B%9E%E9%80%A3%E7%B6%9A%E3%81%A7%E3%81%97%E3%81%8D%E3%81%84%E5%80%A4%E3%82%92%E6%BA%80%E3%81%9F%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%82%92%E7%99%BA%E5%A0%B1%E3%81%95%E3%81%9B%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. 静的しきい値のメトリック アラート ルールで、2 回連続でしきい値を満たした時にアラートを発報させることはできますか。</a></li><li><a href="#Q-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. メトリック アラート ルールが実行されるタイミングを指定することはできますか。</a></li><li><a href="#Q-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E6%99%82%E9%96%93%E5%B8%AF%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E6%9D%A1%E4%BB%B6%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. メトリック アラート ルールで時間帯によって条件を変更することはできますか。</a></li><li><a href="#Q-%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%95%E3%83%AB%E3%81%AA%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E8%B5%B7%E5%8B%95%E6%B8%88%E3%81%BF-Fired-%E3%81%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%82%92%E3%80%81%E6%89%8B%E5%8B%95%E3%81%A7%E8%A7%A3%E6%B1%BA%E6%B8%88%E3%81%BF-Resolved-%E3%81%AB%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. ステートフルなメトリック アラート ルールで起動済み (Fired) のアラートを、手動で解決済み (Resolved) に変更することはできますか。</a></li><li><a href="#Q-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E5%80%A4%E3%81%AE%E3%83%89%E3%83%AD%E3%83%83%E3%83%97-%E3%83%80%E3%82%A6%E3%83%B3%E3%81%AB%E5%80%A4%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82">Q. メトリック アラート ルールのディメンション値のドロップ ダウンに値が表示されません。</a></li><li><a href="#Q-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E7%B7%A8%E9%9B%86%E7%94%BB%E9%9D%A2%E3%81%AE-%E3%83%97%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC-%E3%81%A7%E3%81%AF%E3%81%97%E3%81%8D%E3%81%84%E5%80%A4%E3%82%92%E6%BA%80%E3%81%9F%E3%81%97%E3%81%A6%E3%81%84%E3%81%9F%E3%82%88%E3%81%86%E3%81%AB%E8%A6%8B%E3%81%88%E3%81%BE%E3%81%99%E3%81%8C%E3%80%81%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82">Q. メトリック アラート ルール編集画面の [プレビュー] ではしきい値を満たしていたように見えますが、アラートが発報していません。</a></li><li><a href="#Q-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. メトリック アラート ルールの利用料金を教えてください。</a></li></ul><br><h4 id="lt-ログ-アラート-ルール-gt"><a href="#lt-ログ-アラート-ルール-gt" class="headerlink" title="&lt;ログ アラート ルール&gt;"></a>&lt;ログ アラート ルール&gt;</h4><ul><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E9%A0%85%E7%9B%AE%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. ログ アラート ルールの設定項目を教えてください。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. ログ アラート ルールが実行されるタイミングを指定することはできますか。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E5%80%A4%E3%81%AE%E3%83%89%E3%83%AD%E3%83%83%E3%83%97-%E3%83%80%E3%82%A6%E3%83%B3%E3%81%AB%E5%80%A4%E3%81%8C%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82">Q  ログ アラート ルールのディメンション値のドロップダウンに値が表示されません。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%80%81%E5%90%84%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%8C-0-%E4%BB%B6%E3%81%AE%E3%81%A8%E3%81%8D%E3%81%AB%E7%99%BA%E5%A0%B1%E3%81%99%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%90%AB%E3%82%80%E3%83%AD%E3%82%B0%E3%81%AE%E5%87%BA%E5%8A%9B%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82">Q. ログ アラート ルールでディメンションを設定し、各ディメンションのログが 0 件のときに発報するルールを作成しました。特定のディメンションを含むログの出力を停止しましたが、アラートが発報しません。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E7%94%BB%E9%9D%A2%E3%82%92%E9%96%8B%E3%81%84%E3%81%9F%E3%81%A8%E3%81%93%E3%82%8D%E3%80%81%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6-UI-%E3%81%8C%E7%95%B0%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82">Q. ログ アラート ルールの設定画面を開いたところ、アラート ルールによって UI が異なります。</a></li><li><a href="#Q-%E6%97%A7-API-%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3-2018-04-16-%E4%BB%A5%E5%89%8D-%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. 旧 API (バージョン 2018-04-16 以前) のログ アラート ルールを作成する方法を教えてください。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%82%8B%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E4%BB%B6%E5%90%8D%E3%82%84%E6%9C%AC%E6%96%87%E3%82%92%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. ログ アラート ルールで通知されるメールの件名や本文をカスタマイズすることはできますか。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%9F%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E4%BB%B6%E5%90%8D%E3%82%84%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E3%81%8C%E5%A4%89%E3%82%8F%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E5%8E%9F%E5%9B%A0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. ログ アラート ルールで通知されたメールの件名やフォーマットが変わりました。原因を教えてください。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E5%8B%9D%E6%89%8B%E3%81%AB%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E8%80%83%E3%81%88%E3%82%89%E3%82%8C%E3%82%8B%E5%8E%9F%E5%9B%A0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. ログ アラート ルールが勝手に無効化されていました。考えられる原因を教えてください。</a></li><li><a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. ログ アラート ルールの利用料金を教えてください。</a></li></ul><br><h4 id="lt-アクティビティ-ログ-アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ-ログ-アラート）-gt"><a href="#lt-アクティビティ-ログ-アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ-ログ-アラート）-gt" class="headerlink" title="&lt;アクティビティ ログ アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ ログ アラート）&gt;"></a>&lt;アクティビティ ログ アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ ログ アラート）&gt;</h4><ul><li><a href="#Q-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E3%83%86%E3%82%B9%E3%83%88%E7%99%BA%E5%A0%B1%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. サービス正常性アラートでテスト発報することは可能ですか。</a></li><li><a href="#Q-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%9F%E5%86%85%E5%AE%B9%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%9F%E3%81%84%E3%81%A7%E3%81%99%E3%80%82">Q. サービス正常性アラートで通知された内容について確認したいです。</a></li><li><a href="#Q-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%9F%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%92%E3%80%81%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E4%BB%B6%E5%90%8D%E3%81%A7%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E5%88%86%E3%81%91%E3%81%97%E3%81%9F%E3%81%84%E3%81%A7%E3%81%99%E3%80%82%E4%BB%B6%E5%90%8D%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. サービス正常性アラートで通知されたメールを、メールの件名でフォルダ分けしたいです。件名のルールを教えてください。</a></li><li><a href="#Q-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E3%80%81%E7%8F%BE%E5%9C%A8%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E9%80%9A%E7%9F%A5%E3%81%AE%E3%81%BF%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A%E3%81%9F%E3%81%84%E3%81%A7%E3%81%99%E3%80%82">Q. サービス正常性アラートで、現在利用しているサービスに関する通知のみを受け取りたいです。</a></li><li><a href="#Q-Azure-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%BB%83%E6%AD%A2%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E9%80%9A%E7%9F%A5%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8A%E3%80%81%E9%80%9A%E7%9F%A5%E3%81%AE%E5%86%85%E5%AE%B9%E3%81%AB%E6%B2%BF%E3%81%A3%E3%81%A6%E7%A7%BB%E8%A1%8C%E4%BD%9C%E6%A5%AD%E3%82%92%E5%AE%9F%E6%96%BD%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E5%90%8C%E6%A7%98%E3%81%AE%E9%80%9A%E7%9F%A5%E3%81%8C%E5%86%8D%E5%BA%A6%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E5%AF%BE%E5%BF%9C%E3%81%8C%E5%AE%8C%E4%BA%86%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%E3%81%8B%E3%80%82">Q. Azure サービスの廃止に関する通知を受け取り、通知の内容に沿って移行作業を実施しましたが、同様の通知が再度通知されました。対応が完了していないリソースが存在するということでしょうか。</a></li><li><a href="#Q-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%82%84%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%80%81%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%A7%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%9A%E7%9F%A5%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. サービス正常性アラートやリソース正常性アラートを利用し、アクション グループでメール通知を設定しています。利用料金を教えてください。</a></li></ul><br><h4 id="lt-アクション-グループ、アラート処理ルール-gt"><a href="#lt-アクション-グループ、アラート処理ルール-gt" class="headerlink" title="&lt;アクション グループ、アラート処理ルール&gt;"></a>&lt;アクション グループ、アラート処理ルール&gt;</h4><ul><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E5%87%A6%E7%90%86%E3%81%8C%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E3%81%93%E3%81%A8%E3%82%92%E6%A4%9C%E7%9F%A5%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. アクション グループの処理が失敗したことを検知する方法はありますか。</a></li><li><a href="#Q-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%8C%E5%B1%8A%E3%81%84%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%E8%80%83%E3%81%88%E3%82%89%E3%82%8C%E3%82%8B%E5%8E%9F%E5%9B%A0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アラートが発報しましたが、メールが届いていません。考えられる原因を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%A7%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%92%E9%80%9A%E7%9F%A5%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アクション グループでメールを通知しています。利用料金を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%A7%E3%81%AF%E3%80%81%E9%80%9A%E7%9F%A5%E3%82%92%E6%8A%91%E5%88%B6%E3%81%97%E3%81%9F%E3%81%84%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8C%E3%81%B0%E3%82%88%E3%81%84%E3%81%AE%E3%81%A7%E3%81%97%E3%82%87%E3%81%86%E3%81%8B%E3%80%82">Q. アラート処理ルールのスコープでは、通知を抑制したいアラート ルールを指定すればよいのでしょうか。</a></li><li><a href="#Q-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8C%E3%80%81Azure-%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%AB%E3%81%AE-%E7%9B%A3%E8%A6%96-gt-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%81%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%88%E3%81%86%E3%81%A7%E3%81%99%E3%80%82">Q. アラート処理ルールを利用していますが、Azure ポータルの [監視] &gt; [アラート] でアラートが発報しているようです。</a></li><li><a href="#Q-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E9%80%9A%E7%9F%A5%E3%81%8C%E6%8A%91%E5%88%B6%E3%81%95%E3%82%8C%E3%81%9F%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q. アラート処理ルールによってアラート ルールの通知が抑制されたことを確認する方法を教えてください。</a></li><li><a href="#Q-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AF%E3%80%8C%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%80%8D%E3%82%84%E3%80%8C%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%80%8D%E3%81%AE%E5%8D%98%E4%BD%8D%E3%81%A7%E7%99%BB%E9%8C%B2%E3%81%97%E3%81%9F%E6%96%B9%E3%81%8C%E3%82%88%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q. アラート処理ルールのスコープは「サブスクリプション」や「リソース グループ」の単位で登録した方がよいですか</a></li><li><a href="#Q-%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%95%E3%83%AB%E3%81%AA%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E3%80%8C%E8%A7%A3%E6%B1%BA%E3%80%8D%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E3%81%BF%E9%80%9A%E7%9F%A5%E3%82%92%E6%8A%91%E5%88%B6%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. ステートフルなアラート ルールを設定しています。アラートが「解決」したときのみ通知を抑制することはできますか。</a></li><li><a href="#Q-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E9%80%9A%E7%9F%A5%E3%82%92%E6%8A%91%E5%88%B6%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q. アラート処理ルールでサービス正常性アラートの通知を抑制することはできますか。</a></li></ul><br><br><br><hr><h3 id="メトリック-アラート-ルール"><a href="#メトリック-アラート-ルール" class="headerlink" title="メトリック アラート ルール"></a>メトリック アラート ルール</h3><hr><h3 id="Q-メトリック-アラート-ルールの設定項目を教えてください。"><a href="#Q-メトリック-アラート-ルールの設定項目を教えてください。" class="headerlink" title="Q. メトリック アラート ルールの設定項目を教えてください。"></a>Q. メトリック アラート ルールの設定項目を教えてください。</h3><p>メトリック アラート ルールの設定項目は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-metric-alert-rule">公開情報</a>をご確認いただけますと幸いです。<br>また、動的しきい値を利用したメトリック アラートについては <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-dynamic-thresholds">こちら</a>の公開情報もご参照ください。</p><details><summary><b>アラート ロジック</b></summary>メトリックの値を集計する方法、集計された値と比較する際のしきい値等を指定します。<p>※ 静的しきい値を選択したときの設定項目です。<br><img width="500" src="../MonitorAlertFAQ/image04.png"></p><p>※ 動的しきい値を選択したときの設定項目です。<br><img width="500" src="../MonitorAlertFAQ/image05.png"></p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>しきい値</td><td>静的しきい値では指定した値に基づいて評価されます。<br> 動的しきい値では機械学習アルゴリズムを使用してメトリックの動作パターンが継続的に学習され、予期しない動作に該当するしきい値が計算されます。</td></tr><tr><td>集計の種類</td><td>[ルックバック期間] で設定した期間において、データをまとめる方法を選択します。</td></tr><tr><td>演算子</td><td>集計された値と比較する際に、どの様な比較を行うかを設定します。</td></tr><tr><td>しきい値 (静的しきい値)</td><td>集計された値と比較する際に使用するしきい値を数値で設定します。</td></tr><tr><td>しきい値の感度 (動的しきい値)</td><td>アラートをトリガーする感度のレベルを指定します。</td></tr></tbody></table></details><br><details><summary><b>ディメンション</b></summary>ディメンションは、メトリック値に関する追加のデータ (名前と値のペア) です。メトリックは、個々のリソースごとに記録されますが、ディメンションはメトリックの値をより詳細に説明するための追加情報とお考えください。ディメンションを分割しない場合、メトリックのデータをより細かく分析するための要素を考慮せずに集計されます。一方で、ディメンションを分割した場合には、そのディメンションで集計されたデータが監視され、メトリックのデータをより細かく分析することができます。また、複数のディメンション値を選択した場合は、その組み合わせによって集計されたデータごとに監視されます。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#dimensions-splitting-and-filtering)">こちら</a>の公開情報ごご覧いただけますと幸いです。<img width="700" src="../MonitorAlertFAQ/image06.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>ディメンション名</td><td>メトリックの特定列によって分割したい場合に利用します。</td></tr></tbody></table></details><br><details><summary><b>評価するタイミング</b></summary>1 回の評価を行う際に評価の対象となる期間と、評価の頻度を設定します。<p>※ 静的しきい値を選択したときの設定項目です。<br><img width="500" src="../MonitorAlertFAQ/image07.png"></p><p>※ 動的しきい値を選択したときの設定項目です。<br><img width="500" src="../MonitorAlertFAQ/image08.png"></p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>確認する間隔</td><td>集計された値としきい値の比較を行う頻度です。[確認する間隔] は [ルックバック期間] で設定した期間以下とする必要があります。</td></tr><tr><td>ルックバック期間</td><td>1 回の評価を行う際に評価の対象となる期間を設定します。</td></tr><tr><td>違反の数 (動的しきい値)</td><td>アラートをトリガーするために発生する必要がある違反の数を設定します。</td></tr><tr><td>範囲 (動的しきい値)</td><td>違反の数を評価する期間です。[範囲] で指定した期間を、[ルックバック期間] で分割され、しきい値を違反していた数を確認します。</td></tr></tbody></table></details><br><br><br><h3 id="Q-静的しきい値のメトリック-アラート-ルールで、2-回連続でしきい値を満たした時にアラートを発報させることはできますか。"><a href="#Q-静的しきい値のメトリック-アラート-ルールで、2-回連続でしきい値を満たした時にアラートを発報させることはできますか。" class="headerlink" title="Q. 静的しきい値のメトリック アラート ルールで、2 回連続でしきい値を満たした時にアラートを発報させることはできますか。"></a>Q. 静的しきい値のメトリック アラート ルールで、2 回連続でしきい値を満たした時にアラートを発報させることはできますか。</h3><p>メトリック アラートでは「特定の条件を満たした状態が N 回継続したときに通知する」という設定ではできません。</p><p>一方で、監視対象のメトリックが<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/metrics-index">プラットフォーム メトリック</a>であり、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings#metrics">Azure Monitor の診断設定</a>でメトリックを Log Analytics ワークスペースに転送できる場合には、ログ アラート ルールにてご要件を満たす設定が実現できる可能性があります。</p><p>ログ アラート ルールの場合は [違反の数] を利用することで、特定の条件を満たした状態が N 回継続したときに通知することが可能です。大まかな設定手順は以下の通りです。</p><ol><li><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/">Azure Monitor の診断設定</a>の機能で Log Analytics ワークスペースにメトリックをエクスポートする</li><li>対象の Log Analytics ワークスペースをスコープにして、ログ アラート ルールを作成する</li></ol><p>メトリックを Log Analytics ワークスペースにエクスポートすると、Log Analytics ワークスペース上では <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/azuremetrics">AzureMetrics</a> というテーブルに格納されます。例えば、Azure VM の Percentage CPU の平均値を監視している場合、以下のようなクエリでメトリックの平均値を確認することができます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AzureMetrics</span><br><span class="line">| where _ResourceId =~ &quot;&lt;リソース ID&gt;&quot; // 目的のリソースで絞ります</span><br><span class="line">| where MetricName contains &quot;Percentage CPU&quot; // 目的のメトリックで絞り込みます</span><br><span class="line">| project TimeGenerated, ResourceProvider, MetricName, Average</span><br></pre></td></tr></table></figure><img width="700" src="../MonitorAlertFAQ/image09.png"><p>ログ アラート ルールの場合は、これらの値を利用してログ アラート ルールを設定します。<br>例えば、[評価の頻度] が 5 分、[集計の粒度] が 5 分、[違反の数] を 3、[評価期間] が 15 分と設定したとします。<br>この場合、[評価の頻度] の 5 分毎に、15 分の [評価期間] が 5 分の [集計の粒度] で分割されます (15 ÷ 5 = 3)。この 3 つのグループの中で閾値を違反するグループが 3 つあった場合にアラートが発報します。ログ アラート ルールの設定項目は、本ブログの「<a href="#Q-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E9%A0%85%E7%9B%AE%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">ログ アラート ルールの設定項目を教えてください</a>」もご覧ください。<br><img width="700" src="../MonitorAlertFAQ/image10.png"></p><br><br><h3 id="Q-メトリック-アラート-ルールが実行されるタイミングを指定することはできますか。"><a href="#Q-メトリック-アラート-ルールが実行されるタイミングを指定することはできますか。" class="headerlink" title="Q. メトリック アラート ルールが実行されるタイミングを指定することはできますか。"></a>Q. メトリック アラート ルールが実行されるタイミングを指定することはできますか。</h3><p>Azure Monitor のアラート ルールでは、アラートが実行されるタイミングを指定することはできません。<br>アラート ルールが作成された時点から指定された &quot;確認する間隔&quot; のタイミングでアラート ルールが実行されるとご認識ください。</p><br><br><h3 id="Q-メトリック-アラート-ルールで時間帯によって条件を変更することはできますか。"><a href="#Q-メトリック-アラート-ルールで時間帯によって条件を変更することはできますか。" class="headerlink" title="Q. メトリック アラート ルールで時間帯によって条件を変更することはできますか。"></a>Q. メトリック アラート ルールで時間帯によって条件を変更することはできますか。</h3><p>メトリック アラート ルールで時間帯によって条件を変更することはできません。<br>時間帯によって条件を変更したい場合には、以下の方法をご検討ください。</p><ul><li>複数のメトリック アラート ルールを作成し、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-processing-rules?tabs=portal">アラート処理ルール</a>を使用して特定の時間帯の通知を抑制する</li><li>監視対象のメトリックをログとして Log Analytics ワークスペースに収集できる場合には、ログ アラート ルールで監視する</li></ul><br><br><h3 id="Q-ステートフルなメトリック-アラート-ルールで起動済み-Fired-のアラートを、手動で解決済み-Resolved-に変更することはできますか。"><a href="#Q-ステートフルなメトリック-アラート-ルールで起動済み-Fired-のアラートを、手動で解決済み-Resolved-に変更することはできますか。" class="headerlink" title="Q. ステートフルなメトリック アラート ルールで起動済み (Fired) のアラートを、手動で解決済み (Resolved) に変更することはできますか。"></a>Q. ステートフルなメトリック アラート ルールで起動済み (Fired) のアラートを、手動で解決済み (Resolved) に変更することはできますか。</h3><p>いいえ、手動で解決済みに変更することはできません。<br>メトリックの値がしきい値を満たさなくなるように Azure リソースを操作してください。</p><br><br><h3 id="Q-メトリック-アラート-ルールのディメンション値のドロップ-ダウンに値が表示されません。"><a href="#Q-メトリック-アラート-ルールのディメンション値のドロップ-ダウンに値が表示されません。" class="headerlink" title="Q. メトリック アラート ルールのディメンション値のドロップ ダウンに値が表示されません。"></a>Q. メトリック アラート ルールのディメンション値のドロップ ダウンに値が表示されません。</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-metric-alert-rule">ディメンションは過去 48 時間のデータをもとに表示されます</a>。<br>過去 48 時間以内に当該ディメンション値を含むメトリックが記録されていない場合は、ディメンション値のドロップダウンには表示されません。ディメンション値が表示されない場合はカスタム値として設定いただきますようお願いいたします。</p><br><br><h3 id="Q-メトリック-アラート-ルール編集画面の-プレビュー-ではしきい値を満たしていたように見えますが、アラートが発報していません。"><a href="#Q-メトリック-アラート-ルール編集画面の-プレビュー-ではしきい値を満たしていたように見えますが、アラートが発報していません。" class="headerlink" title="Q. メトリック アラート ルール編集画面の [プレビュー] ではしきい値を満たしていたように見えますが、アラートが発報していません。"></a>Q. メトリック アラート ルール編集画面の [プレビュー] ではしきい値を満たしていたように見えますが、アラートが発報していません。</h3><p>下図はプレビュー画面であり、実際のアラート ルールの評価時刻やルックバック期間に基づいた集計の粒度で表示されていない場合がございます。このため、実際にはしきい値を満たしていない場合でも、プレビュー画面上ではしきい値を満たしているように表示されてしまう場合もございます。<br><img width="700" src="../MonitorAlertFAQ/image19.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics#configure-the-time-range">こちら</a>の公開情報の手順に沿って、しきい値を満たしていたと推測される時間帯のメトリック値をご確認ください。<br>メトリック エクスプローラー上でもアラートのしきい値を満たしている場合には、何らかの原因によりアラートが想定通り発報しなかった可能性がございます。アラートの検知漏れの調査をご要望の場合には、<a href="https://jpazmon-integ.github.io/blog/general/HowToCreateSR/#4-3-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E6%83%B3%E5%AE%9A%E3%81%A9%E3%81%8A%E3%82%8A%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84-%E6%A4%9C%E7%9F%A5%E3%82%82%E3%82%8C">以下の情報</a>をご記載の上、お問い合わせをご起票ください。</p><p>・アラート ルールのリソース ID<br>・アラートが発報されることが想定された日時 (タイムゾーンを明記してご記載ください。例. 2024-12-30 12:00 JST)</p><br><br><h3 id="Q-メトリック-アラート-ルールの利用料金を教えてください。"><a href="#Q-メトリック-アラート-ルールの利用料金を教えてください。" class="headerlink" title="Q. メトリック アラート ルールの利用料金を教えてください。"></a>Q. メトリック アラート ルールの利用料金を教えてください。</h3><p>メトリック アラート ルールは、監視対象の時系列ごとに課金されます。時系列はメトリックではなく、監視する単位とお考え下さい。例えば、静的メトリック アラート ルールで 10 個の VM を対象に 4 つのメトリックを監視した場合の月額料金は以下のとおりです。</p><p><strong>(10 VM * 4 メトリック時系列/VM - 10 無料ユニット分) * メトリック時系列あたりの価格/月</strong></p><p>また、アラート ルールにご指定いただくメトリック数 (条件数) 以外に、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-metric-multiple-time-series-single-rule?WT.mc_id=Portal-Microsoft_Azure_Monitoring#alert-rule-on-multiple-time-series">ディメンション分割した場合もメトリックの時系列が増加します</a>。例えば、静的メトリック アラート ルールで 10 個の VM を対象に 4 つのメトリックを監視し、このうち 1 つのメトリックで 1 つのディメンションを選択してディメンションの値を 2 つ指定した場合、月額料金は以下のように計算されます。</p><p><strong>(10 VM * 3 メトリック時系列/VM + 10 VM * 1 メトリック時系列/VM * 1 ディメンション * 2 個 - 10 無料ユニット分) * メトリック時系列あたりの価格/月</strong></p><p>価格の詳細は <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor 価格サイト</a>や<a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">計算ツール</a>をご覧ください。<br>なお、アクション グループによってメールや SMS 等でアラートを通知している場合には、別途アクション グループに関するご利用料金も発生しますのでご留意ください。</p><br><br><br><hr><h3 id="ログ-アラート-ルール"><a href="#ログ-アラート-ルール" class="headerlink" title="ログ アラート ルール"></a>ログ アラート ルール</h3><hr><h3 id="Q-ログ-アラート-ルールの設定項目を教えてください。"><a href="#Q-ログ-アラート-ルールの設定項目を教えてください。" class="headerlink" title="Q. ログ アラート ルールの設定項目を教えてください。"></a>Q. ログ アラート ルールの設定項目を教えてください。</h3><p>ログ アラート ルールの設定項目は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">公開情報</a>をご確認いただけますと幸いです。</p><details><summary><b>測定</b></summary>ログ検索を行う検索期間、実行結果の集計方法を指定します。例えば、[集計の粒度] を 10 分、[集計の種類] を [平均] とした場合、10 分間の期間にあるデータを平均化し、その値をアラート検知に利用します。<img width="500" src="../MonitorAlertFAQ/image01.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>メジャー</td><td>集計対象のテーブルの行または数値列を選択します。</td></tr><tr><td>集計の種類</td><td>[集計の粒度] で設定した期間において、データをまとめる方法を選択します。</td></tr><tr><td>集計の粒度</td><td>クエリで取得したログを一つのグループにまとめる単位を示します。</td></tr></tbody></table></details><br><details><summary><b>ディメンション</b></summary>ディメンションごとに分割すると、数値列または文字列の組み合わせがグループ化され、複数の Azure リソースで同じ条件を監視できます。複数のディメンション値を選択した場合は、その組み合わせによって生成される時系列ごとに独自のアラートがトリガーされ、個別に処理されます。<img width="700" src="../MonitorAlertFAQ/image02.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>リソース ID 列</td><td>クエリ結果に リソース ID が含まれていると、自動的に検出され、選択状態となります。リソース ID を指定した場合、リソース ID 毎にアラートのターゲットとして分割され、リソース ID 別にアラートの検知、通知が行われます。</td></tr><tr><td>ディメンション名</td><td>リソース ID 以外の特定列によって分割したい場合に利用します。</td></tr></tbody></table></details><br><details><summary><b>アラートロジック</b></summary>[測定] の設定によって集計された値と比較する際のしきい値と、評価の頻度を設定します。<img width="500" src="../MonitorAlertFAQ/image03.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>演算子</td><td>[測定] の設定によって集計された値と比較する際に、どの様な比較を行うかを設定します。</td></tr><tr><td>しきい値</td><td>[測定] の設定によって集計された値と比較する際に、使用するしきい値を数値で設定します。</td></tr><tr><td>評価の頻度</td><td>[測定] の設定によって集計された値としきい値の比較を行う頻度です。[評価の頻度] は [集計の粒度] で設定した期間以下とする必要があります。</td></tr></tbody></table></details><br><br><h3 id="Q-ログ-アラート-ルールが実行されるタイミングを指定することはできますか。"><a href="#Q-ログ-アラート-ルールが実行されるタイミングを指定することはできますか。" class="headerlink" title="Q. ログ アラート ルールが実行されるタイミングを指定することはできますか。"></a>Q. ログ アラート ルールが実行されるタイミングを指定することはできますか。</h3><p>Azure Monitor のアラート ルールでは、アラートが実行されるタイミングを指定することはできません。<br>アラート ルールが作成された時点から指定された &quot;評価の頻度&quot; のタイミングでアラート ルールが実行されるとご認識ください。</p><br><br><h3 id="Q-ログ-アラート-ルールのディメンション値のドロップ-ダウンに値が表示されません。"><a href="#Q-ログ-アラート-ルールのディメンション値のドロップ-ダウンに値が表示されません。" class="headerlink" title="Q. ログ アラート ルールのディメンション値のドロップ ダウンに値が表示されません。"></a>Q. ログ アラート ルールのディメンション値のドロップ ダウンに値が表示されません。</h3><p>メトリック アラート ルールと同様、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">ディメンションは過去 48 時間のデータをもとに表示されます</a>。<br>過去 48 時間以内に当該ディメンション値を含むログが記録されていない場合は、ディメンション値のドロップダウンには表示されません。ディメンション値が表示されない場合はカスタム値として設定いただきますようお願いいたします。</p><br><br><h3 id="Q-ログ-アラート-ルールでディメンションを設定し、各ディメンションのログが-0-件のときに発報するルールを作成しました。特定のディメンションを含むログの出力を停止しましたが、アラートが発報しません。"><a href="#Q-ログ-アラート-ルールでディメンションを設定し、各ディメンションのログが-0-件のときに発報するルールを作成しました。特定のディメンションを含むログの出力を停止しましたが、アラートが発報しません。" class="headerlink" title="Q. ログ アラート ルールでディメンションを設定し、各ディメンションのログが 0 件のときに発報するルールを作成しました。特定のディメンションを含むログの出力を停止しましたが、アラートが発報しません。"></a>Q. ログ アラート ルールでディメンションを設定し、各ディメンションのログが 0 件のときに発報するルールを作成しました。特定のディメンションを含むログの出力を停止しましたが、アラートが発報しません。</h3><p>ログ アラート ルールでディメンションを分割した場合、すべてのディメンションのログが 0 件のときにはアラートが検知されますが、一部のディメンションが 0 件のときには、アラートが検知されません。例を用いて説明します。</p><p>例えば、Windows マシンでパフォーマンス カウンターを収集し、「\Process(*)\ID Process」を監視するアラートを構成していたとします。<br>ログ アラート ルールに対して下記のようなクエリを指定し、Computer と InstanceName でディメンション分割されたと仮定します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Perf</span><br><span class="line">| where ObjectName == &quot;Process&quot;</span><br><span class="line">| where CounterName == &quot;ID Process&quot;</span><br></pre></td></tr></table></figure><p>このアラート ルールで [集計の粒度] を 5 分とした場合、下記のように直近 5 分間のログを検索し Computer、InstanceName 列でレコード数を集計したデータを、ログ アラート ルールは確認します。つまり、<strong>Log Analytics ワークスペースに存在するログ</strong>に対してディメンション分割されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Perf</span><br><span class="line">| where TimeGenerated &gt; ago(5m) // 集計粒度が 5 分なので、直近 5 分間のログを取得</span><br><span class="line">| where ObjectName == &quot;Process&quot;</span><br><span class="line">| where CounterName == &quot;ID Process&quot;</span><br><span class="line">| summarize count() by Computer, InstanceName, bin (TimeGenerated, 5m) // Computer と InstanceName でレコード数を集計する</span><br></pre></td></tr></table></figure><p>上記のクエリで特定のプロセスを停止し、5 分以上当該プロセス情報が送信されていなかったとしても、<strong>そもそも直近 5 分間のログとして監視対象のプロセスに該当するログが存在しないため、そのプロセスに対するディメンション分割ができず、アラート ルールは検知できません</strong>。</p><p>一方で、下記のようにログ アラート ルールを設定いただくことで、このような問題を回避することができます。<br>このクエリでは、過去 2 日間のデータをプロセス リストとして取得し、直近 5 分間のデータとジョインしてレコードの数をカウントします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">let Computer_InstanceList =</span><br><span class="line">( Perf</span><br><span class="line">| where TimeGenerated &gt; ago(2d)</span><br><span class="line">| where ObjectName == &quot;Process&quot;</span><br><span class="line">| where CounterName == &quot;ID Process&quot;</span><br><span class="line">| summarize max(TimeGenerated) by Computer, InstanceName </span><br><span class="line">);</span><br><span class="line">Perf</span><br><span class="line">| where TimeGenerated &gt; ago(5m)</span><br><span class="line">| where ObjectName == &quot;Process&quot;</span><br><span class="line">| where CounterName == &quot;ID Process&quot;</span><br><span class="line">| summarize count() by Computer, InstanceName </span><br><span class="line">| join kind=rightouter Computer_InstanceList on $left.Computer == $right.Computer and $left.InstanceName == $right.InstanceName</span><br><span class="line">| extend AggregatedValue = iif(isnull(count_), 0, count_)</span><br><span class="line">| project ComputerName = Computer1, AggregatedValue, InstanceName = InstanceName1</span><br></pre></td></tr></table></figure><p><strong>&lt; 測定 &gt;</strong><br>メジャー : AggregatedValue<br>集計の種類 : 合計<br>集計の粒度 : 2 日</p><p><strong>&lt; ディメンションで分割する &gt;</strong><br>リソース ID 列 : 分割しない<br>ディメンション設定 : ComputerName と InstanceName を指定</p><p><strong>&lt; アラート ロジック &gt;</strong><br>演算子 : 次の値以下<br>しきい値 : 0<br>評価の頻度 : 5 分</p><br><br><h3 id="Q-ログ-アラート-ルールの設定画面を開いたところ、アラート-ルールによって-UI-が異なります。"><a href="#Q-ログ-アラート-ルールの設定画面を開いたところ、アラート-ルールによって-UI-が異なります。" class="headerlink" title="Q. ログ アラート ルールの設定画面を開いたところ、アラート ルールによって UI が異なります。"></a>Q. ログ アラート ルールの設定画面を開いたところ、アラート ルールによって UI が異なります。</h3><p>ログ アラート ルールの API バージョンによって UI が異なります。<br>API のバージョンが 2021-08-01 以降の場合は新 UI、バージョン 2018-04-16 以前であれば旧 UI で表示されます。</p><p>旧 UI のアラート条件を設定する画面です。<br><img width="1000" src="../MonitorAlertFAQ/image11.png"></p><p>新 UI のアラート条件を設定する画面です。<br><img width="1000" src="../MonitorAlertFAQ/image12.png"></p><p>ログ アラート ルールの API バージョンは、Azure Resource Graph クエリで確認することができます。Azure ポータルで [Resource Graph エクスプローラー] (<a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/first-query-portal">Azure Resource Graph エクスプローラー</a>) を開き、API バージョンをご確認ください。また、API バージョンの違いによる UI の差異については、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AboutCustomizingAlertNotificationEmail/#%E6%96%B0%E3%81%97%E3%81%84-API-%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3-API-%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3-2021-08-01-%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E4%BD%9C%E6%88%90%E7%94%BB%E9%9D%A2">こちら</a>のブログでも紹介しておりますので、ぜひご覧下さい。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line">| where subscriptionId == &quot;サブスクリプション ID&quot;</span><br><span class="line">| where type == &quot;microsoft.insights/scheduledqueryrules&quot;</span><br><span class="line">| extend createdWithApiVersion = properties[&#x27;createdWithApiVersion&#x27;]</span><br><span class="line">| where kind != &#x27;LogToMetric&#x27;</span><br><span class="line">| project id, createdWithApiVersion</span><br></pre></td></tr></table></figure><br><br><h3 id="Q-旧-API-バージョン-2018-04-16-以前-のログ-アラート-ルールを作成する方法を教えてください。"><a href="#Q-旧-API-バージョン-2018-04-16-以前-のログ-アラート-ルールを作成する方法を教えてください。" class="headerlink" title="Q. 旧 API (バージョン 2018-04-16 以前) のログ アラート ルールを作成する方法を教えてください。"></a>Q. 旧 API (バージョン 2018-04-16 以前) のログ アラート ルールを作成する方法を教えてください。</h3><p>旧 API バージョンのログ アラート ルールを作成する場合は ARM テンプレートや REST API を利用してアラート ルールをデプロイしてください。Azure ポータルからログ アラート ルールを作成した場合は、現行の API (バージョン 2021-08-01 以降) でデプロイされます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/resource-manager-alerts-log?tabs=json#number-of-results-template-up-to-version-2018-04-16">弊社サイト</a>の 「(バージョン 2018-04-16 以前) 」 と記載されたテンプレートは旧 API バージョンの ARM テンプレートになります。また、REST API の場合は<a href="https://learn.microsoft.com/en-us/rest/api/monitor/scheduled-query-rules/create-or-update?view=rest-monitor-2018-04-16&tabs=HTTP">こちら</a>のサイトをご覧ください。</p><br><br><h3 id="Q-ログ-アラート-ルールで通知されるメールの件名や本文をカスタマイズすることはできますか。"><a href="#Q-ログ-アラート-ルールで通知されるメールの件名や本文をカスタマイズすることはできますか。" class="headerlink" title="Q. ログ アラート ルールで通知されるメールの件名や本文をカスタマイズすることはできますか。"></a>Q. ログ アラート ルールで通知されるメールの件名や本文をカスタマイズすることはできますか。</h3><p><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AboutCustomizingAlertNotificationEmail/#%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E9%80%9A%E7%9F%A5%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AF%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84">Azure Monitor で通知されるアラートのメールは、カスタマイズすることはできません</a>。<br>メール本文のカスタマイズが必要な場合には、<a href="https://learn.microsoft.com/ja-jp/azure/logic-apps/logic-apps-overview">Logic Apps</a> 等でお客様にて作りこんでいただく必要がございます。<br>弊社 <a href="https://jpazinteg.github.io/blog/LogicApps/Integration-logAlertRule/">Integration Support Blog</a>では Logic Apps を利用してログ アラート ルールのメールを通知する方法を紹介しておりますので、ご覧いただけますと幸いです。</p><br><br><h3 id="Q-ログ-アラート-ルールで通知されたメールの件名やフォーマットが変わりました。原因を教えてください。"><a href="#Q-ログ-アラート-ルールで通知されたメールの件名やフォーマットが変わりました。原因を教えてください。" class="headerlink" title="Q. ログ アラート ルールで通知されたメールの件名やフォーマットが変わりました。原因を教えてください。"></a>Q. ログ アラート ルールで通知されたメールの件名やフォーマットが変わりました。原因を教えてください。</h3><p>ログ アラート ルールの API バージョンの差異によってフォーマットが異なるメールが通知された可能性がございます。<br><a href="https://azure.microsoft.com/ja-jp/updates/new-email-templates-for-log-search-alerts-api-version-20210801-and-up/">現行の API (バージョン 2021-08-01 以降) のログ アラート ルール (ログ アラート ルール V2) で、非共通アラート スキーマの場合に送られる通知メールのフォーマットが変更されました</a>。アラート ルールによって通知されるメールのフォーマットが異なる場合には、アクション グループの共通アラート スキーマの設定をご確認ください。<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/LogAlert_NewEmailTemplate_2024/">こちら</a>のブログでアクション グループの設定を確認する方法や、フォーマットが変更された背景等をご案内しておりますので、ご確認いただけますと幸いです。</p><br><br><h3 id="Q-ログ-アラート-ルールが勝手に無効化されていました。考えられる原因を教えてください。"><a href="#Q-ログ-アラート-ルールが勝手に無効化されていました。考えられる原因を教えてください。" class="headerlink" title="Q. ログ アラート ルールが勝手に無効化されていました。考えられる原因を教えてください。"></a>Q. ログ アラート ルールが勝手に無効化されていました。考えられる原因を教えてください。</h3><p>ログ アラート ルールの検索クエリの実行が継続して失敗している可能性があります。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-troubleshoot-log#a-log-search-alert-didnt-fire-when-it-should-have">ログ アラート ルールは、クエリなどの失敗が 1 週間続いた場合、Azure Monitor によって自動で無効化されます</a>。クエリの構文や該当のテーブルにログが出力されているかどうかをご確認ください。</p><p>また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">ログ アラート ルールにて Azure Data Explorer や Azure Resource Graph クエリを設定する際には、システム割り当てマネージド ID、またはユーザー割り当てマネージド ID を有効化し、閲覧者権限を付与いただく必要がございます</a>。マネージド ID に必要な権限が付与されていない場合、Azure Data Explorer や Azure Resource Graph に対してクエリを実行できません。Azure Data Explorer や Azure Resource Graph クエリを設定している場合には、マネージド ID に必要な権限が付与されているかどうかもご確認ください。</p><br><br><h3 id="Q-ログ-アラート-ルールの利用料金を教えてください。"><a href="#Q-ログ-アラート-ルールの利用料金を教えてください。" class="headerlink" title="Q. ログ アラート ルールの利用料金を教えてください。"></a>Q. ログ アラート ルールの利用料金を教えてください。</h3><p>ログ アラート ルールは、評価の頻度毎に月額料金が設定されています。また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#monitor-multiple-instances-of-a-resource-using-dimensions">ディメンション分割した場合、評価される時系列が増えますので時系列に対するご利用料金も発生します</a>。</p><p>例えば、評価の頻度が 5 分のログ アラート ルールで 2 つのディメンションを選択し、それぞれディメンションの値を 2 つ指定した場合、評価される時系列は 2 * 2 = 4 時系列となり、月額料金は以下のように計算されます。</p><p><strong>頻度 5 分のログ アラート ルールの価格/月 + (4 時系列 - 無料の 1 時系列) * 頻度 5 分の時系列の価格/月</strong></p><p>価格の詳細は <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor 価格サイト</a>や<a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">計算ツール</a>をご覧ください。<br>なお、アクション グループによってメールや SMS 等でアラートを通知している場合には、別途アクション グループに関するご利用料金も発生しますのでご留意ください。</p><br><br><br><hr><h3 id="アクティビティ-ログ-アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ-ログ-アラート）"><a href="#アクティビティ-ログ-アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ-ログ-アラート）" class="headerlink" title="アクティビティ ログ アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ ログ アラート）"></a>アクティビティ ログ アラート（サービス正常性アラート、リソース正常性アラート、アクティビティ ログ アラート）</h3><hr><h3 id="Q-サービス正常性アラートでテスト発報することは可能ですか。"><a href="#Q-サービス正常性アラートでテスト発報することは可能ですか。" class="headerlink" title="Q. サービス正常性アラートでテスト発報することは可能ですか。"></a>Q. サービス正常性アラートでテスト発報することは可能ですか。</h3><p>サービス正常性アラートでは、テスト アラートという仕組みはございません。<br>一方で、アクション グループにはテスト通知機能がございます。通知のテストを実施されたい場合には、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#test-an-action-group-in-the-azure-portal">テスト アクション グループ</a>機能をご利用いただけますと幸いです。</p><br><br><h3 id="Q-サービス正常性アラートで通知された内容について確認したいです。"><a href="#Q-サービス正常性アラートで通知された内容について確認したいです。" class="headerlink" title="Q. サービス正常性アラートで通知された内容について確認したいです。"></a>Q. サービス正常性アラートで通知された内容について確認したいです。</h3><p>サービス正常性アラートで通知された内容についてご不明な点がある場合、基本的には該当するサービス観点でお問い合わせをご起票くださいますようお願いいたします。サービス正常性のメールでは、メールの下部に該当するサービス名が記載されております (下記例の場合は Azure Resource Manager 観点でお問い合わせをご起票ください)。<br><img width="700" src="../MonitorAlertFAQ/image14.png"><br>また、サービス正常性のイベントには Tracking-ID (追跡 ID) が付与されておりますので、Tracking-ID の情報もご記載ください。</p><br><br><h3 id="Q-サービス正常性アラートで通知されたメールを、メールの件名でフォルダ分けしたいです。件名のルールを教えてください。"><a href="#Q-サービス正常性アラートで通知されたメールを、メールの件名でフォルダ分けしたいです。件名のルールを教えてください。" class="headerlink" title="Q. サービス正常性アラートで通知されたメールを、メールの件名でフォルダ分けしたいです。件名のルールを教えてください。"></a>Q. サービス正常性アラートで通知されたメールを、メールの件名でフォルダ分けしたいです。件名のルールを教えてください。</h3><p>サービス正常性アラートのメールの件名や本文の内容は、特に決められた形式はございません。<br>メールの件名や通知内容は各サービスの弊社開発エンジニアが決定しております。ご参考までに過去に通知されたサービス正常性アラートの件名やメールで通知された内容を紹介しますが、決められた形式はないこと、ご了承ください。</p><table style="border-collapse: collapse; width: 100%;">  <thead>    <tr>      <th style="border: 0.5px solid lightgray; text-align: center; padding: 8px; width: 180px;">イベントの種類</th>      <th style="border: 0.5px solid lightgray; text-align: center; padding: 8px; width: 250px;">イベントの内容</th>      <th style="border: 0.5px solid lightgray; text-align: center; padding: 8px; width: 250px;">過去に通知されたメール件名の例</th>      <th style="border: 0.5px solid lightgray; text-align: center; padding: 8px;">過去に通知されたメールの内容</th>    </tr>  </thead>  <tbody>    <tr>      <td style="border: 0.5px solid lightgray; padding: 8px;">サービスに関する問題</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">サービスの問題は、Azure サービスに影響する問題が発生した際のイベント</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Azure Resource Manager - Investigating</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Azure Resource Managerプラットフォームに依存するサービスのリソース作成で問題が発生する可能性があることを通知した内容です。</td>    </tr>    <tr>      <td style="border: 0.5px solid lightgray; padding: 8px;">計画メンテナンス</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">定期的なメンテナンスは、Azure サービスの可用性に影響を及ぼす可能性のあるメンテナンスが発生した際のイベント</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Advance Notification for Scheduled Maintenance to Azure Database for MySQL</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Azure Database for MySQLの定期メンテナンスの事前通知のメールです。</td>    </tr>    <tr>      <td style="border: 0.5px solid lightgray; padding: 8px;">正常性の勧告</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">ユーザーが注目すべき Azure サービスの変更が発生した際のイベント</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Action recommended: Allow communication with new Azure SQL Database gateways by 1 September 2020</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">SQL Databaseの更新に伴い、推奨される操作をご案内した内容です。</td>    </tr>    <tr>      <td style="border: 0.5px solid lightgray; padding: 8px;">セキュリティ アドバイザリ</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Azure サービスの可用性に影響する可能性があるセキュリティ関連の通知または違反があった際のイベント</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">Security - Critical: Certificate Authority revocation due to non-compliance of your certificates potentially impacting</td>      <td style="border: 0.5px solid lightgray; padding: 8px;">一部の証明書の失効に伴う影響について通知をするメールです。</td>    </tr>  </tbody></table><br><br><h3 id="Q-サービス正常性アラートで、現在利用しているサービスに関する通知のみを受け取りたいです。"><a href="#Q-サービス正常性アラートで、現在利用しているサービスに関する通知のみを受け取りたいです。" class="headerlink" title="Q. サービス正常性アラートで、現在利用しているサービスに関する通知のみを受け取りたいです。"></a>Q. サービス正常性アラートで、現在利用しているサービスに関する通知のみを受け取りたいです。</h3><p>サービス正常性アラート設定時の “サービス” や “リージョン” ですべて選択いただくことをご検討ください。<br>サービス正常性アラートは、ご利用いただいているサービスのご利用いただいているリージョンを対象としたイベントが発生した場合にのみ通知が行われる仕組みです。このため、サブスクリプション上のすべてのサービス、リージョンおよびイベントの種類を選択した場合にも、利用していないリソースに対してアラートは発生いたしません。サービス正常性アラートの<a href="https://jpazmon-integ.github.io/blog/ame/HowToSetUpServiceHealthAlertsAndRecommendedSettings/">サポート ブログ</a> もあわせてご確認ください。</p><br><br><h3 id="Q-Azure-サービスの廃止に関する通知を受け取り、通知の内容に沿って移行作業を実施しましたが、同様の通知が再度通知されました。対応が完了していないリソースが存在するということでしょうか。"><a href="#Q-Azure-サービスの廃止に関する通知を受け取り、通知の内容に沿って移行作業を実施しましたが、同様の通知が再度通知されました。対応が完了していないリソースが存在するということでしょうか。" class="headerlink" title="Q. Azure サービスの廃止に関する通知を受け取り、通知の内容に沿って移行作業を実施しましたが、同様の通知が再度通知されました。対応が完了していないリソースが存在するということでしょうか。"></a>Q. Azure サービスの廃止に関する通知を受け取り、通知の内容に沿って移行作業を実施しましたが、同様の通知が再度通知されました。対応が完了していないリソースが存在するということでしょうか。</h3><p>サービスの廃止や仕様の変更等、ご利用いただいているお客様に影響が大きいと推測される通知は、対象となるリソースが存在しない場合も、そのサービスをご利用いただいている幅広いお客様に通知させていただくことがございます。予めご了承ください。</p><br><br><h3 id="Q-サービス正常性アラートやリソース正常性アラートを利用し、アクション-グループでメール通知を設定しています。利用料金を教えてください。"><a href="#Q-サービス正常性アラートやリソース正常性アラートを利用し、アクション-グループでメール通知を設定しています。利用料金を教えてください。" class="headerlink" title="Q. サービス正常性アラートやリソース正常性アラートを利用し、アクション グループでメール通知を設定しています。利用料金を教えてください。"></a>Q. サービス正常性アラートやリソース正常性アラートを利用し、アクション グループでメール通知を設定しています。利用料金を教えてください。</h3><p>メールの通知に関する費用のみが発生します。<br>アラート ルールで通知する場合、基本的にアラート ルールに対する料金と通知の料金が発生します。アクティビティ ログ アラート (サービス正常性やリソース正常性アラートを含む) の場合は、アラート ルールに対する料金は発生しません。<br>価格の詳細は <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor 価格サイト</a>や<a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">計算ツール</a>をご覧ください。</p><div class="alert is-info"><p class="alert-title">Note</p><p>リソース正常性アラートについては別途<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/">ブログ</a>を作成しております。</p></div><br><br><br><hr><h3 id="アクション-グループ、アラート処理ルール"><a href="#アクション-グループ、アラート処理ルール" class="headerlink" title="アクション グループ、アラート処理ルール"></a>アクション グループ、アラート処理ルール</h3><hr><h3 id="Q-アクション-グループの処理が失敗したことを検知する方法はありますか。"><a href="#Q-アクション-グループの処理が失敗したことを検知する方法はありますか。" class="headerlink" title="Q. アクション グループの処理が失敗したことを検知する方法はありますか。"></a>Q. アクション グループの処理が失敗したことを検知する方法はありますか。</h3><p>誠に恐れ入りますが、基本的にアクション グループの失敗を検知する方法はございません。<br>アクション グループによる通知処理が失敗する原因は、主に以下の 2 つが考えらえます。</p><ul><li>Azure 側の障害でアクション グループがトリガーされなかった</li><li>アクション グループはトリガーされたが、何かしらの原因で処理が失敗した</li></ul><p>前者の場合は Azure の<a href="https://learn.microsoft.com/ja-jp/azure/service-health/overview">サービス正常性アラート</a>で通知される可能性はございます。<br>一方で、後者の場合はお客様環境で確認いただく方法がなく、現時点でアクション グループの失敗を検知することができません。</p><p>アクション グループによって通知処理が失敗した原因の調査をご希望の場合は、<a href="https://jpazmon-integ.github.io/blog/general/HowToCreateSR/#4-5-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84">以下の情報</a>をもってお問い合わせをご起票くださいますようお願いいたします。</p><p>・アラート ルールのリソース ID<br>・アクション グループのリソース ID<br>・アラートが発報した日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)<br>・<a href="https://jpazmon-integ.github.io/blog/general/HowToCreateSR/#4-4-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E6%83%B3%E5%AE%9A%E3%81%A9%E3%81%8A%E3%82%8A%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84-%E8%AA%A4%E6%A4%9C%E7%9F%A5">アラート ID</a></p><br><br><h3 id="Q-アラートが発報しましたが、メールが届いていません。考えられる原因を教えてください。"><a href="#Q-アラートが発報しましたが、メールが届いていません。考えられる原因を教えてください。" class="headerlink" title="Q. アラートが発報しましたが、メールが届いていません。考えられる原因を教えてください。"></a>Q. アラートが発報しましたが、メールが届いていません。考えられる原因を教えてください。</h3><p>考えられる主な原因は以下の通りです。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-troubleshoot#i-didnt-receive-the-expected-email">こちら</a>の公開情報にもトラブルシューティングのステップが掲載されておりますのでご確認ください。</p><ul><li>通知されたメール アドレスが許可されていない</li><li>アラート処理ルールによってメールの通知が抑制された</li><li>アクション グループで登録解除されていた</li><li>メールのレート制限に達した</li></ul><p>Azure Monitor から送られるメールは以下のアドレスが利用されます。メール アドレスがブロックされていないかどうかをご確認ください。</p><p>・azure-noreply@microsoft.com<br>・azureemail-noreply@microsoft.com<br>・alerts-noreply@mail.windowsazure.com</p><p>アラート処理ルールによってメールの通知が抑制された可能性もございます。<br>Azure ポータルの [監視] - [アラート] から、アラート処理ルールでアラートの通知が抑制されていないかどうかをご確認ください。<br><img width="900" src="../MonitorAlertFAQ/image15.png"></p><p>アクション グループのメール アドレスが登録解除されている可能性もございます。<br>Azure ポータルからアクション グループの編集画面を開き、[通知] の [状態] で <strong>登録解除済み</strong> と表示されている場合は、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnsubscribeAlertMail/">こちら</a> のブログを参考にメール アドレスの再登録をお願いいたします。<br><img width="700" src="../MonitorAlertFAQ/image16.png"></p><p>また、アクション グループには<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/service-limits#action-groups">制限</a>がございます。メールの場合は 1 時間に 100 通のレート制限があり、この制限に触れた場合は通知が停止されます。この制限に抵触すると、当該のアドレスに「We’ve temporarily paused your Azure email notifications」という通知メールが届きますので、このレート制限の影響でメールが届いていないとご判断いただけます。<br><img width="600" src="../MonitorAlertFAQ/image17.png"></p><p>上記に該当しない場合は、Azure Monitoring サポートまでお問い合わせをご起票ください。<br>お問い合わせをご起票いただく際には、<a href="https://jpazmon-integ.github.io/blog/general/HowToCreateSR/#4-5-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84">以下の情報</a>をご連携くださいますようお願いいたします。</p><p>・アラート ルールのリソース ID<br>・アクション グループのリソース ID<br>・アラートが発報した日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)<br>・<a href="https://jpazmon-integ.github.io/blog/general/HowToCreateSR/#4-4-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E6%83%B3%E5%AE%9A%E3%81%A9%E3%81%8A%E3%82%8A%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84-%E8%AA%A4%E6%A4%9C%E7%9F%A5">アラート ID</a></p><br><br><h3 id="Q-アクション-グループでメールを通知しています。利用料金を教えてください。"><a href="#Q-アクション-グループでメールを通知しています。利用料金を教えてください。" class="headerlink" title="Q. アクション グループでメールを通知しています。利用料金を教えてください。"></a>Q. アクション グループでメールを通知しています。利用料金を教えてください。</h3><p>サブスクリプション毎に 1,000 通までは無料でご利用いただけますが、この無料枠を超えた場合はご利用料金が発生します。<br>100,000 通につき $2 の場合、1,001 通目から 100,000 通目までは、$2 となります。<br>100,001 通 から 200,000 通目までは、さらに + $2 となり、＄4 となります。<br>現時点の価格の詳細は <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor 価格サイト</a>や<a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">計算ツール</a>をご覧ください。通知の種類 (メール、webhook、SMS など) によってご利用料金が異なりますので、アクション グループの設定内容に応じてご確認ください。</p><br><br><h3 id="Q-アラート処理ルールのスコープでは、通知を抑制したいアラート-ルールを指定すればよいのでしょうか。"><a href="#Q-アラート処理ルールのスコープでは、通知を抑制したいアラート-ルールを指定すればよいのでしょうか。" class="headerlink" title="Q. アラート処理ルールのスコープでは、通知を抑制したいアラート ルールを指定すればよいのでしょうか。"></a>Q. アラート処理ルールのスコープでは、通知を抑制したいアラート ルールを指定すればよいのでしょうか。</h3><p>いいえ。アラート処理ルールのスコープでは、<strong>影響を受けるリソース</strong>を指定してください。<br><strong>影響を受けるリソース</strong> は、Azure ポータルの [監視] &gt; [アラート] でご確認いただけます。<br><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AlertProcessingRule/#2-1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AF%E3%80%81%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84">必ずしも、アラート ルールのスコープと 影響を受けるリソース が一致するとは限りません</a>ので、ご注意ください。</p><p>また、スコープでサブスクリプションやリソース グループを選択することも可能ですが、サブスクリプションやリソース グループに存在するリソースを対象とした、すべてのアラート ルールにアラート処理ルールが適用されますので、ご注意ください。<br><img width="900" src="../MonitorAlertFAQ/image18.png"></p><br><br><h3 id="Q-アラート処理ルールを利用していますが、Azure-ポータルの-監視-gt-アラート-でアラートが発報しているようです。"><a href="#Q-アラート処理ルールを利用していますが、Azure-ポータルの-監視-gt-アラート-でアラートが発報しているようです。" class="headerlink" title="Q. アラート処理ルールを利用していますが、Azure ポータルの [監視] &gt; [アラート] でアラートが発報しているようです。"></a>Q. アラート処理ルールを利用していますが、Azure ポータルの [監視] &gt; [アラート] でアラートが発報しているようです。</h3><p>アラート処理ルールは、<strong>アクション グループの適用/抑制を行う機能であり、アラート ルールの実行自体を抑制するものではございません。</strong> アラートの発報や解決自体を抑制する機能ではございませんので、ご留意ください。</p><br><br><h3 id="Q-アラート処理ルールによってアラート-ルールの通知が抑制されたことを確認する方法を教えてください。"><a href="#Q-アラート処理ルールによってアラート-ルールの通知が抑制されたことを確認する方法を教えてください。" class="headerlink" title="Q. アラート処理ルールによってアラート ルールの通知が抑制されたことを確認する方法を教えてください。"></a>Q. アラート処理ルールによってアラート ルールの通知が抑制されたことを確認する方法を教えてください。</h3><p>Azure ポータルの [監視] - [アラート] を開き、[履歴] を選択してください。<br>アラート処理ルールでアラートの通知が抑制された場合は、以下のように表示されます。<br><img width="900" src="../MonitorAlertFAQ/image15.png"></p><br><br><h3 id="Q-アラート処理ルールのスコープは「サブスクリプション」や「リソース-グループ」の単位で登録した方がよいですか。"><a href="#Q-アラート処理ルールのスコープは「サブスクリプション」や「リソース-グループ」の単位で登録した方がよいですか。" class="headerlink" title="Q. アラート処理ルールのスコープは「サブスクリプション」や「リソース グループ」の単位で登録した方がよいですか。"></a>Q. アラート処理ルールのスコープは「サブスクリプション」や「リソース グループ」の単位で登録した方がよいですか。</h3><p>弊社としては推奨している単位はございません。<br>監視対象となるリソース、リソース グループ、サブスクリプションのいずれか、お客様のご要件に沿うものをご指定ください。</p><p>アラート処理ルールのスコープでサブスクリプションやリソース グループを選択した場合、その配下に存在するリソースを対象とした、すべてのアラート ルールにアラート処理ルールが適用されます。特定のアラート ルールにアラート処理ルールを適用されたい場合には、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-processing-rules?tabs=portal#scope-and-filters-for-alert-processing-rules">フィルター</a>の条件で [アラート ルール ID] もしくは [アラート ルール名] で通知を抑制したいアラート ルールをご指定ください。<br><img width="700" src="../MonitorAlertFAQ/image13.png"></p><br><br><h3 id="Q-ステートフルなアラート-ルールを設定しています。アラートが「解決」したときのみ通知を抑制することはできますか。"><a href="#Q-ステートフルなアラート-ルールを設定しています。アラートが「解決」したときのみ通知を抑制することはできますか。" class="headerlink" title="Q. ステートフルなアラート ルールを設定しています。アラートが「解決」したときのみ通知を抑制することはできますか。"></a>Q. ステートフルなアラート ルールを設定しています。アラートが「解決」したときのみ通知を抑制することはできますか。</h3><p>はい、可能です。<br>アラート処理ルールでは、任意の時間帯にアクション グループを適用したり、抑制したりすることができます。<br>下図のようにアラートの条件に対して「解決済み」をご指定いただくことで、解決済みのアラートに対してアクション グループを抑制することが可能です。<br><img width="900" src="../MonitorAlertFAQ/image20.png"></p><br><br><h3 id="Q-アラート処理ルールでサービス正常性アラートの通知を抑制することはできますか。"><a href="#Q-アラート処理ルールでサービス正常性アラートの通知を抑制することはできますか。" class="headerlink" title="Q. アラート処理ルールでサービス正常性アラートの通知を抑制することはできますか。"></a>Q. アラート処理ルールでサービス正常性アラートの通知を抑制することはできますか。</h3><p>いいえ。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-processing-rules?tabs=portal#add-action-groups-to-all-alert-types">サービス正常性アラートはアラート処理ルールで通知を抑制することはできません</a>。</p><br><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は Azure Monitor のアラートに関するよくあるご質問をご紹介します。&lt;br&gt;&lt;a href=&quot;https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/&quot;&gt;リソース正常性アラート&lt;/a&gt;や&lt;a href=&quot;https://jpazmon-integ.github.io/blog/ame/HowToSetUpServiceHealthAlertsAndRecommendedSettings/&quot;&gt;サービス正常性アラート&lt;/a&gt;については、別途ブログを投稿しておりますので併せてご覧いただけますと幸いです！&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>CMA/AMA とエンドポイントの通信経路上に Azure Firewall がある場合の注意事項</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMA_CMA_FW/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/AMA_CMA_FW/</id>
    <published>2025-01-05T12:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.433Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Monitoring チームの佐藤です。<br>本日は Azure Arc や Azure Monitor サービスを使用いただく際に監視、管理対象マシンにインストールする以下エージェントが Azure のエンドポイント（ログなどの送り先）と通信する際の途中経路に Azure Firewall (以後、AZFW) がある場合、留意すべきポイントについてご紹介します。</p><table><thead><tr><th>略称</th><th>エージェント名</th><th>用途</th></tr></thead><tbody><tr><td>CMA</td><td>Connected Machine Agent</td><td>Azure Arc サーバーとして管理する。Azure 基盤と通信する</td></tr><tr><td>AMA</td><td>Azure Monitor Agent</td><td>ログ採取、採取したログを Log Analytics ワークスペースなどログ格納先に送る</td></tr></tbody></table><p>目次</p><h3 id="対象マシンからエンドポイントへ-Test-NetConnection-コマンドで疎通確認する場合"><a href="#対象マシンからエンドポイントへ-Test-NetConnection-コマンドで疎通確認する場合" class="headerlink" title="対象マシンからエンドポイントへ Test-NetConnection コマンドで疎通確認する場合"></a>対象マシンからエンドポイントへ Test-NetConnection コマンドで疎通確認する場合</h3><p>以下 blog で当社 AZFW を所管しているチームにて公開しておりますとおりエンドポイントへ疎通できてなくとも “TcpTestSucceeded : True” の応答を得る点にご注意ください。<br><a href="https://jpaztech.github.io/blog/network/firewall-rules/">Azure Firewall の各ルールの動作について</a></p><p>//内容抜粋<br>HTTP (80), HTTPS (443) の通信において、ネットワークルール、アプリケーションルールで明示的に拒否していない場合、ルールの処理順序に従って、Azure Firewall の既定の動作として、アプリケーションルールで拒否されることが想定される動作となります。<br>この動作について <strong>Windows の Test-Netconnection</strong> や Linux の curl, nc コマンド等 (以下に記載) で <strong>TCP の 3way handshake による接続確認を実施した場合はアプリケーションルールで許可していないにもかかわらず、3way handshake が確立され、許可されたように見える動作</strong>となります。</p><p>上記シナリオに合致する場合、 Test-NetConnection と tls コネクションまで実施する curl コマンド（※）の結果は以下のように違い発生します。</p><p>◆Test-NetConnection コマンドの実行例<br>PS C:\Users\azureuser&gt; Test-NetConnection global.handler.control.monitor.azure.com -port 443<br>ComputerName     : global.handler.control.monitor.azure.com<br>RemoteAddress    : 20.43.70.102<br>RemotePort       : 443<br>InterfaceAlias   : Ethernet 3<br>SourceAddress    : 10.10.94.69<br>TcpTestSucceeded : True</p><p>◆ curl コマンドの実行例（curl.output.txt より）<br>Starting external process: C:\Windows\system32\curl.exe -v -s -S -k <a href="https://global.handler.control.monitor.azure.com/ping">https://global.handler.control.monitor.azure.com/ping</a><br>Some arguments have been redacted for security reasons.</p><ul><li>Host global.handler.control.monitor.azure.com:443 was resolved.</li><li>IPv6: (none)</li><li>IPv4: 20.43.70.102</li><li>  Trying 20.43.70.102:443…</li><li>Connected to global.handler.control.monitor.azure.com (20.43.70.102) port 443</li><li>schannel: disabled automatic use of client certificate</li><li>ALPN: curl offers http/1.1</li><li>schannel: <strong>failed to receive handshake, SSL/TLS connection failed</strong></li><li>closing connection #0</li></ul><p>※今回は AMA の トラブルシューティング ツールで取得した curl コマンド結果を使用いたします。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/troubleshooter-ama-windows?tabs=WindowsPowerShell">Azure Monitor エージェント トラブルシューティング ツールの使用方法</a></p><p>Test-NetConnection コマンドで疎通できているように見える場合でも実態としては、AZFW で疎通が許可されていない場合は上記のようになる点ご留意ください。<br>その他上記の結果は TLS コネクションをはるための暗号化スイートが要件を満たしていない可能性もございますが、既定では暗号化スイートは基本満たしていることがほとんどです。<br>新しい Windows Server 構築して上記結果になる場合は一度 AZFW の疎通許可を確認いただけますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Monitoring チームの佐藤です。&lt;br&gt;本日は Azure Arc や Azure Monitor サービスを使用いただく際に監視、管理対象マシンにインストールする以下エージェントが Azu</summary>
      
    
    
    
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Troubleshoot" scheme="https://jpazmon-integ.github.io/blog/tags/Troubleshoot/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor エージェントを使用したログ収集が行われない場合のトラブルシューティングについて</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/TroubleshootingAMALogIngestion/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/TroubleshootingAMALogIngestion/</id>
    <published>2024-11-08T05:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.641Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>Azure Monitor エージェントを使用したログ収集を行っている場合、Log Analytics ワークスペースには、Heartbeat と呼ばれるログが 1 分毎に収集されます。<br>この Heartbeat はマシンの死活監視にも使用されることがありますが、何らかの理由でこの Heartbeat が収集されないことがあります。<br>Heartbeat が収集できていない場合は、ログ収集設定以前もところで問題が発生していることも多く、その場合は、Heartbeat 以外のログ収集も停止してしまいます。</p><p>今回は、Heartbeat をはじめとしたログが収集されないときの、はじめのトラブルシューティング方法をご紹介します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li><li><a href="#%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E5%AF%BE%E8%B1%A1-os-%E3%81%AE%E7%A2%BA%E8%AA%8D">サポート対象 OS の確認</a></li><li><a href="#%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E8%B5%B7%E5%8B%95%E7%8A%B6%E6%85%8B%E3%81%AE%E7%A2%BA%E8%AA%8D">マシンの起動状態の確認</a></li><li><a href="#azure-monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%AE%E7%A2%BA%E8%AA%8D">Azure Monitor エージェントの状態の確認</a></li><li><a href="#%E9%80%9A%E4%BF%A1%E8%A6%81%E4%BB%B6%E3%81%AE%E7%A2%BA%E8%AA%8D">通信要件の確認</a></li><li><a href="#%E9%80%9A%E4%BF%A1%E8%A6%81%E4%BB%B6%E3%81%AE%E7%A2%BA%E8%AA%8D-ampls-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88">通信要件の確認 (AMPLS を使用している場合)</a></li><li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E7%A2%BA%E8%AA%8D">データ収集ルールの設定の確認</a></li><li><a href="#%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E7%A2%BA%E8%AA%8D">マネージド ID の設定の確認</a></li><li><a href="#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E3%81%97%E3%81%A6%E3%82%82%E5%95%8F%E9%A1%8C%E3%81%8C%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88">トラブルシューティングをしても問題が解決しない場合</a></li><li><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">おわりに</a></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure Monitor を使用したログ収集が行われない場合の要因は多岐にわたります。<br>以下では、その中でもよくある原因の特定とその対処方法をご案内します。</p><h2 id="サポート対象-OS-の確認"><a href="#サポート対象-OS-の確認" class="headerlink" title="サポート対象 OS の確認"></a>サポート対象 OS の確認</h2><p>ご利用中のマシンの OS において Azure Monitor エージェントの利用がサポートされていない場合、当仮想マシン上でのエージェントの正常な動作は保証されておりません。<br>そのため、まずはじめに、使用している OS が Azure Monitor エージェントのサポート対象であるかをご確認ください。  </p><p>Azure Monitor エージェントがサポートする OS は、以下公開情報にてご確認いただけます。  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-supported-operating-systems">Azure Monitor エージェントでサポートされるオペレーティング システムと環境</a></p><h2 id="マシンの起動状態の確認"><a href="#マシンの起動状態の確認" class="headerlink" title="マシンの起動状態の確認"></a>マシンの起動状態の確認</h2><p>サポート対象であることが分かったのち、次に確認すべきことは、マシンが正常に起動した状態であるかです。<br>マシンが起動していない場合は、ログ収集が行われません。  </p><h3 id="確認方法"><a href="#確認方法" class="headerlink" title="確認方法"></a>確認方法</h3><p>Azure portal では、対象のマシンの [概要] ページ内の “基本” &gt; “状態” からご確認いただけます。</p><h3 id="マシンが起動していないときの対処方法"><a href="#マシンが起動していないときの対処方法" class="headerlink" title="マシンが起動していないときの対処方法"></a>マシンが起動していないときの対処方法</h3><p>マシンが起動されていない場合 (“状態” が “停止済み” となっている場合) は、対象のマシンの [概要] ページ内の [開始] ボタンより起動させ、ログ収集が再開するかどうかをご確認ください。</p><h2 id="Azure-Monitor-エージェントの状態の確認"><a href="#Azure-Monitor-エージェントの状態の確認" class="headerlink" title="Azure Monitor エージェントの状態の確認"></a>Azure Monitor エージェントの状態の確認</h2><p>マシンが問題なく起動していても、Azure Monitor エージェントが正常に稼働しておらず、ログ収集が行われない場合があります。  </p><h3 id="確認方法-1"><a href="#確認方法-1" class="headerlink" title="確認方法"></a>確認方法</h3><p>Azure portal で対象のマシンを開き、左ペインの [設定] &gt; [拡張機能とアプリケーション] を開きます。<br>Linux の場合は “AzureMonitorLinuxAgent”、Windows の場合は “AzureMonitorWindowsAgent” の “状態” が “Provisioning Succeeded” となっている場合は、Azure Monitor エージェントが正常に稼働していることを意味します。</p><h3 id="Azure-Monitor-エージェントが正常に稼働していない場合の対処方法"><a href="#Azure-Monitor-エージェントが正常に稼働していない場合の対処方法" class="headerlink" title="Azure Monitor エージェントが正常に稼働していない場合の対処方法"></a>Azure Monitor エージェントが正常に稼働していない場合の対処方法</h3><ul><li>Azure Monitor エージェントの状態が “Provisioning Succeeded” になっていない場合は、一度マシン自体を再起動し、しばらく待って “Provisioning Succeeded” になるかをご確認ください。  </li><li>それでも “Provisioning Succeeded” とならない場合は、下記の手順で、エージェントの再インストール をお試しください。これにより事象が解決する場合があります。</li></ul><p>■ Azure Monitor エージェントの再インストール手順</p><ol><li><p>Azure portal で対象のマシンを開き、左ペインの [拡張機能とアプリケーション] を開きます。</p></li><li><p>“種類” に “AzureMonitorLinuxAgent” (Linux の場合)、または “AzureMonitorWindowsAgent” (Windows の場合) が含まれるものを押下し、右ペインの [アンインストール] を押下します。</p></li><li><p>2 のアンインストールの完了が確認出来たら、以下のコマンドを実行します。</p><ul><li>&lt;&gt; の箇所はお客様の環境に合わせてご変更ください。実行時、&lt;&gt; は不要です</li><li>自動アップグレード機能を有効化したくない場合は、<code>-EnableAutomaticUpgrade $true</code> を削除して実行してください。  </li><li><code>-HandlerVersion</code> としてマイナー バージョンまでを指定することはできません。<br>詳細については、本手順末尾の <code>インストール可能なバージョンの確認方法とコマンドでのバージョンの指定方法</code> をご参照ください。</li></ul><p> (Linux の場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AzVMExtension -Name AzureMonitorLinuxAgent -ExtensionType AzureMonitorLinuxAgent -Publisher Microsoft.Azure.Monitor -ResourceGroupName &lt;resourcegroup-name&gt; -VMName &lt;vm-name&gt; -Location &lt;region-name&gt; -HandlerVersion &lt;version&gt; -DisableAutoUpgradeMinorVersion -EnableAutomaticUpgrade $true</span><br></pre></td></tr></table></figure><p>(Windows の場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-AzVMExtension -Name AzureMonitorWindowsAgent -ExtensionType AzureMonitorWindowsAgent -Publisher Microsoft.Azure.Monitor -ResourceGroupName &lt;resourcegroup-name&gt; -VMName &lt;vm-name&gt; -Location &lt;region-name&gt; -HandlerVersion &lt;version&gt; -DisableAutoUpgradeMinorVersion -EnableAutomaticUpgrade $true</span><br></pre></td></tr></table></figure></li><li><p>1 の  [拡張機能とアプリケーション]  にて、Azure Monitor エージェントの “状態” が “Provisioning Succeeded” となれば、完了です。  </p></li></ol><p><strong>(補足) インストール可能なバージョンの確認方法とコマンドでのバージョンの指定方法</strong><br>使用可能なエージェントのバージョンの一覧は、以下の PowerShell コマンドを実行することで確認できます。(<code>&lt;region&gt;</code> には、マシンが存在するリージョンを指定してください。)  </p><p>(Windows の場合)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((Get-AzVMExtensionImage -Location &quot;&lt;region&gt;&quot; -PublisherName &quot;Microsoft.Azure.Monitor&quot; -Type &quot;AzureMonitorWindowsAgent&quot;).Version | Sort-Object -Property &#123; [Version]$_&#125;)  </span><br></pre></td></tr></table></figure><p>(Linux の場合)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((Get-AzVMExtensionImage -Location &quot;&lt;region&gt;&quot; -PublisherName &quot;Microsoft.Azure.Monitor&quot; -Type &quot;AzureMonitorLinuxAgent&quot;).Version | Sort-Object -Property &#123; [Version]$_&#125;)</span><br></pre></td></tr></table></figure><p>注意点として、コマンドを使用して Azure Monitor エージェントをインストールする場合、マイナー バージョンは指定することができかねます。<br>例えばもし 1.31.1 をご指定いただいた場合、下図のように <code>The value of parameter typeHandlerVersion is invalid.</code> のエラーが発生します。<br>そのため、必ずマイナーバージョン (“1.xx.y” の “.y” の部分) を削除した状態で拡張機能のバージョンをご指定ください。<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/setazvmextension-error.png"></p><h2 id="通信要件の確認"><a href="#通信要件の確認" class="headerlink" title="通信要件の確認"></a>通信要件の確認</h2><p>マシンにインストールされた Azure Monitor エージェントがマシンのログを Log Analytics ワークスペースに送信したい場合は、マシン (Azure Monitor エージェント) が必要なエンドポイントへ接続できるよう設定する必要があります。  </p><p>接続できる必要のあるエンドポイントは以下の通りです。<br>(<code>&lt;&gt;</code> で囲まれた箇所は環境に合わせて変更してください。実行時に <code>&lt;&gt;</code> は不要です。)  </p><p><code>global.handler.control.monitor.azure.com</code>  </p><p><code>&lt;virtual-machine-region-name&gt;.handler.control.monitor.azure.com</code> </p><p><code>&lt;log-analytics-workspace-id&gt;.ods.opinsights.azure.com</code>  </p><p>Log Analytics ワークスペース内のカスタム ログ テーブルにデータを送信する場合は、以下のエンドポイントへの接続も必要です。   </p><p><code>&lt;data-collection-endpoint&gt;.&lt;virtual-machine-region-name&gt;.ingest.monitor.azure.com</code>  </p><p>＊ <code>&lt;data-collection-endpoint&gt;.&lt;virtual-machine-region-name&gt;</code> の値は、使用しているデータ収集ルールに設定しているデータ収集エンドポイントを Azure portal で開き、[概要] の “ログ インジェスト” を確認してください。<br>   こちらに記載されている値から “https://“ を除いたものがエンドポイントです。<br>   <img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/dce-logingest.png"></p><h3 id="確認方法-2"><a href="#確認方法-2" class="headerlink" title="確認方法"></a>確認方法</h3><p>上記エンドポイントへ接続できているかどうかは、以下の方法で確認可能です。  </p><p><strong>■ Windows の場合</strong><br>PowerShell を開き、以下のコマンドを実行し、出力結果に <code>TcpTestSucceeded : True</code> が記載されていれば、エンドポイントに接続できています<br>(* Azure Firewlall を使用している場合は、後述の “ご注意点” をご確認ください)。  </p><p>( <code>&lt;endpoint&gt;</code> の箇所は、上記のエンドポイントのうち確認したいものに置き換えてください)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test-NetConnection &lt;endpoint&gt; -port 443</span><br></pre></td></tr></table></figure><p>(結果例)<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/result-tnc.png">  </p><p><strong>ご注意点</strong><br>Azure Firewall を使用している環境の場合、Test-NetConnection の結果が <code>TcpTestSucceeded : True</code> であっても、実際にはエンドポイントに通信できない場合があります。<br>これは、クライアントとエンドポイント間の通信が Azure Firewall のアプリケーション ルールによって拒否される場合があるためです。<br>詳細については、以下弊社サポート チーム ブログをご参照ください。<br><a href="https://jpaztech.github.io/blog/network/firewall-rules/">Azure Firewall の各ルールの動作について</a></p><p><strong>■ Linux の場合</strong><br>ターミナルを開き、以下のコマンドを実行し、出力結果に <code>CONNECTED</code> が記載されていれば、エンドポイントに接続できています。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo | openssl s_client -connect &lt;endpoint&gt;:443 -servername &lt;endpoint&gt; -showcerts</span><br></pre></td></tr></table></figure><p>(結果例)<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/result-echo.png"></p><h3 id="エンドポイントへ接続できていない場合の対処方法"><a href="#エンドポイントへ接続できていない場合の対処方法" class="headerlink" title="エンドポイントへ接続できていない場合の対処方法"></a>エンドポイントへ接続できていない場合の対処方法</h3><p><strong>エンドポイントへの接続を許可する</strong><br>まずはネットワーク構成を確認し、エンドポイントへの接続を拒否するような設定が適用されていないかを確認してください。<br>プロキシ サーバーやファイアウォールが設置されている場合は、これらの設定により、上記のエンドポイントへの接続が拒否されている可能性があります。</p><p><strong>名前解決の問題を解消する</strong><br>上記のコマンドの実行結果で以下のように表示された場合は、何らかの要因でエンドポイントの名前解決に失敗しています。  </p><ul><li>Windows の場合：<code>RemoteAddress</code> が空欄</li><li>Linux の場合：<code>Name or service not known</code> が表示される  </li></ul><p>このように名前解決に失敗している場合は、お客様環境の DNS 構成の見直しをご検討ください。<br>また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">AMPLS (Azure Monitor Private Link Scope)</a> を使用している場合は、後述の<a href="#%E9%80%9A%E4%BF%A1%E8%A6%81%E4%BB%B6%E3%81%AE%E7%A2%BA%E8%AA%8D-ampls-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88">通信要件の確認 (AMPLS を使用している場合)</a>をご確認ください。</p><p>(ご参考)<br>Azure Monitor エージェントを使用する上でのネットワーク要件については、以下の弊社公開情報でもご案内しています。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-network-configuration?tabs=PowerShellWindows">Azure Monitor エージェントのネットワーク構成</a></p><h2 id="通信要件の確認-AMPLS-を使用している場合"><a href="#通信要件の確認-AMPLS-を使用している場合" class="headerlink" title="通信要件の確認 (AMPLS を使用している場合)"></a>通信要件の確認 (AMPLS を使用している場合)</h2><p>上記 <code>通信要件の確認</code> ではログ収集のために接続が必要なエンド ポイントを紹介しました。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">AMPLS (Azure Monitor Private Link Scope)</a> を使用している場合、名前解決の結果 Global IP への通信を試みてしまい、結果、必要なエンドポイントに接続できていない可能性もございます。<br>AMPLS に関連するエンドポイントへの接続失敗のよくある原因といたしましては、下記の 2 点が考えられます。<br>以下に、それぞれの確認方法と対処法をご紹介します。</p><h3 id="原因-A-AMPLS-に対して、Log-Analytics-ワークスペースやデータ収集エンドポイントが追加出来ていない"><a href="#原因-A-AMPLS-に対して、Log-Analytics-ワークスペースやデータ収集エンドポイントが追加出来ていない" class="headerlink" title="原因 A: AMPLS に対して、Log Analytics ワークスペースやデータ収集エンドポイントが追加出来ていない"></a>原因 A: AMPLS に対して、Log Analytics ワークスペースやデータ収集エンドポイントが追加出来ていない</h3><p><strong>確認方法</strong><br>Azure portal から、当該 AMPLS リソースの [構成] &gt; [Azure Monitor リソース] よりご確認可能です。<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/ampls-monitorresource.png"></p><p><strong>対処方法</strong><br>もし当該 Log Analytics ワークスペースやデータ収集エンドポイントが追加できていない場合は、[+ 追加] からこれらのリソースの追加をお願いします。  </p><h3 id="原因-B-AMPLS-のプライベート-エンドポイントに紐づくプライベート-DNS-ゾーンの設定がおかしい"><a href="#原因-B-AMPLS-のプライベート-エンドポイントに紐づくプライベート-DNS-ゾーンの設定がおかしい" class="headerlink" title="原因 B: AMPLS のプライベート エンドポイントに紐づくプライベート DNS ゾーンの設定がおかしい"></a>原因 B: AMPLS のプライベート エンドポイントに紐づくプライベート DNS ゾーンの設定がおかしい</h3><p>お客様環境によっては、AMPLS のためのプライベート DNS ゾーンが作成されます。<br>＊ privatelink.monitor.azure.com や privatelink.ods.opinsights.azure.com などです。</p><p>これらのプライベート DNS ゾーンには、AMA がインストールされたマシンに関係する VNET (仮想ネットワーク) をリンクさせる必要があります。<br>(例えば、ログ収集対象のマシンが存在する VNET がプライベート DNS ゾーンにリンクされていない、などです。)<br>もし適切な VNET がリンクされていない場合は、AMA がインストールされたマシンから各エンドポイントの名前解決を実施しても Private IP に変換されず、結果、エンドポイントへの接続に失敗します。  </p><p><strong>確認方法</strong>  </p><ol><li>Azure portal から、当該 AMPLS リソースの [構成] &gt; [プライベート エンドポイント接続] のページを開き、 “プライベート エンドポイント” を押下し、プライベート エンドポイントのリソース ページに移動します。  </li><li>つづいて、[設定] &gt; [DNS の構成] を押下し、”構成名” が “privatelink-monitor-azure-com” である行の “プライベート DNS ゾーン” を押下します。<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/ampls-privatednszone.png">  </li><li>プライベート DNS ゾーンのリソース ページに遷移したら、[DNS の管理] &gt; [仮想ネットワーク リンク] を押下し、AMA がインストールされたマシンに関係する VNET が追加されているかを確認します。<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/ampls-linkedvnets.png">   </li></ol><p><strong>対処方法</strong><br>上記 3 で、AMA がインストールされたマシンに関係する VNET が追加されていなかった場合は、同ページの [+ 追加] から必要な VNET を追加してください。  </p><p>その他、AMPLS に関する設定方法については、下記公開情報をご参照ください。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-configure#review-and-validate-your-private-link-setup">プライベート リンクを構成する | 自分のプライベート リンク セットアップを確認および検証する</a></p><h2 id="データ収集ルールの設定の確認"><a href="#データ収集ルールの設定の確認" class="headerlink" title="データ収集ルールの設定の確認"></a>データ収集ルールの設定の確認</h2><p>Azure Monitor エージェントを使用してログ収集を行う場合、データ収集ルールを使用して、対象のマシンと、ログ収集先の Log Analytics ワークスペースを指定します。<br>確認対象のマシンが、データ収集ルールに関連付けられているか、ログ収集を確認している Log Analytics ワークスペースが合っているかを、確認してください。</p><h3 id="確認方法-3"><a href="#確認方法-3" class="headerlink" title="確認方法"></a>確認方法</h3><p><strong>■ マシンとデータ収集ルールの関連付け</strong>  </p><ol><li>Azure portal でデータ収集ルールのリソース ページを開きます。  </li><li>左ペインの [構成] &gt; [リソース] を開きます。<br>ここに、確認対象のマシンが表示されていることを確認してください。</li></ol><p><strong>■ ログ収集先の Log Analytics ワークスペース</strong>  </p><ol><li>Azure portal でデータ収集ルールのリソース ページを開きます。  </li><li>左ペインの [構成] &gt; [データ ソース] を開きます。  </li><li>表示されているデータ ソースを押下し、右ペインの [ターゲット] タブを開きます。<br>ここに表示される Log Analytics ワークスペースに、ログが収集されます。<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/check-dcr-target.png"></li></ol><h3 id="マシンとデータ収集ルールを関連付いていない場合の対処方法"><a href="#マシンとデータ収集ルールを関連付いていない場合の対処方法" class="headerlink" title="マシンとデータ収集ルールを関連付いていない場合の対処方法"></a>マシンとデータ収集ルールを関連付いていない場合の対処方法</h3><p>以下の手順でマシンとデータ収集ルールを関連付けます。</p><ol><li>Azure portal でデータ収集ルールのリソース ページを開きます。  </li><li>左ペインの [構成] &gt; [リソース] を開きます。<br>[追加] を押下し、関連付けたいマシンを選択します。 </li><li>[適用] を押下し、完了です。</li></ol><h3 id="ログ送信先となる-Log-Analytics-ワークスペースを設定-変更する方法"><a href="#ログ送信先となる-Log-Analytics-ワークスペースを設定-変更する方法" class="headerlink" title="ログ送信先となる Log Analytics ワークスペースを設定/変更する方法"></a>ログ送信先となる Log Analytics ワークスペースを設定/変更する方法</h3><p>ログ送信先となる Log Analytics ワークスペースを設定/変更したい場合は、以下の手順を実施してください。  </p><ol><li>Azure portal でデータ収集ルールのリソース ページを開きます。  </li><li>左ペインの [構成] &gt; [データ ソース] を開きます。</li><li>設定対象のデータ ソースを押下し、右ペイン内の [ターゲット] タブを開きます。</li><li>現在設定されているターゲット (ワークスペース) を変更したい場合は、既存のターゲットのゴミ箱アイコンを押下し、削除します。</li><li>[ターゲットの追加] を押下し、設定したい Log Analytics ワークスペースを選択します。</li><li>[保存] を押下し、完了です。</li></ol><h2 id="マネージド-ID-の設定の確認"><a href="#マネージド-ID-の設定の確認" class="headerlink" title="マネージド ID の設定の確認"></a>マネージド ID の設定の確認</h2><p>Azure Monitor エージェントを使用する場合は、マシンにシステム割り当てマネージド ID または、ユーザー マネージド ID が割り当てられている必要があります。  </p><h3 id="確認方法-4"><a href="#確認方法-4" class="headerlink" title="確認方法"></a>確認方法</h3><ol><li>Azure portal で確認対象のマシンを開きます。  </li><li>(システム割り当てマネージド ID の場合)<br>左ペインの [セキュリティ] &gt; [ID] を押下し、[システム割り当て済み] タブを開きます。<br>“状態” が “オン” になっていれば、そのマシンにはシステム割り当てマネージド ID が割り当てられています。<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/check-systemassignedId.png"><br>(ユーザー割り当てマネージド ID の場合)<br>左ペインの [セキュリティ] &gt; [ID] を押下し、[ユーザー割り当て済み] タブを開きます。<br>ユーザー割り当てマネージド ID が表示されていれば、そのマシンにはユーザー割り当てマネージド ID が割り当てられています。  </li></ol><h3 id="マネージド-ID-が割り当てられていないときの対処方法"><a href="#マネージド-ID-が割り当てられていないときの対処方法" class="headerlink" title="マネージド ID が割り当てられていないときの対処方法"></a>マネージド ID が割り当てられていないときの対処方法</h3><p>以下の手順で、システム割り当てマネージド ID を割り当ててください。  </p><p><strong>■ システム割り当てマネージド ID の割り当て手順</strong>  </p><ol><li>Azure portal で確認対象のマシンを開きます。  </li><li>左ペインの [セキュリティ] &gt; [ID] を押下し、[システム割り当て済み] タブを開きます。  </li><li>“状態” の “オン” を押下し、しばらく待つと、システム割り当てマネージド ID が割り当てられます。  </li></ol><p><strong>■ ユーザー割り当てマネージド ID の割り当て手順</strong>  </p><ol><li>ユーザー割り当てマネージド ID を作成していない場合は、ユーザー割り当てマネージド ID を作成します。<br><a href="https://learn.microsoft.com/ja-jp/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp#create-a-user-assigned-managed-identity">参考：ユーザー割り当てマネージド ID を作成する</a></li><li>Azure portal で確認対象のマシンを開き、左ペインの [セキュリティ] &gt; [ID] を押下し、[ユーザー割り当て済み] タブを開きます。  </li><li>[追加] を押下し、右ペインで使用したいユーザー割り当てマネージド ID を選択し、[追加] を押下し、完了です。</li></ol><p>なお、マネージド ID については、以下弊社サイトでもご案内しています。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-requirements#permissions">Azure Monitor エージェントの要件 | アクセス許可</a></li><li><a href="https://learn.microsoft.com/ja-jp/entra/identity/managed-identities-azure-resources/overview#managed-identity-types">Azure リソース用マネージド ID とは | マネージド ID の種類</a>  </li></ul><h2 id="トラブルシューティングをしても問題が解決しない場合"><a href="#トラブルシューティングをしても問題が解決しない場合" class="headerlink" title="トラブルシューティングをしても問題が解決しない場合"></a>トラブルシューティングをしても問題が解決しない場合</h2><p>上記対応を実施しても事象が解決しない場合は、お気兼ねなく Azure portal からサポート リクエストをご起票ください。<br>ご起票の手順は以下の通りです。  </p><ol><li><p>以下のいずれかの方法でサポート リクエストを開きます。<br>A. ページ上部、グローバル ヘッダー内の [?] アイコンを押下します。<br>   <img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/open-sr-1.png"> </p><p>B. リソース ページの左ペイン内 [ヘルプ] &gt; [サポートとトラブルシューティング] を押下します。  </p></li><li><p>“どのようなご用件ですか?” の欄に、発生している問題の概要を入力し、[移動] を押下します。<br>(例：”Azure Monitor エージェントでログが収集できない”)  </p><p><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/sr-input-description.png">    </p></li><li><p>“問題が発生しているのは、どのサービスですか?” で “Azure Monitor Agent (AMA) on Windows machine” か “Azure Monitor Agent (AMA) on Linux machine” (“監視+管理” のカテゴリ内にございます) を選択し、[Next] を押下します。</p></li><li><p>“問題が発生しているのはどのサブスクリプションですか?” で、該当するサブスクリプションを選択し。[Next] を押下します。  </p></li><li><p>“What issue are you having?” で以下のように選択し、[Next] を押下します。  </p><ul><li>“Problem type”: “I created a DCR but the data is not in the Log Analytics Workspace”  </li><li>“Problem subtype”: No Heartbeat events in Log Analytics Workcspace  </li></ul><p>手順 3 - 5 が完了すると、以下のような状態になります。  </p><p><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/sr-currentselection.png"> </p></li><li><p>[サポートに問い合わせる] を押下し、”ヘルプ + サポート” 内の [サポート リクエストの作成] を押下します。<br>(“新しいサポート リクエスト” のページに遷移します。)</p><p><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/create-sr.png">    </p></li><li><p>“リソース” で [リソースの選択] を押下し、以下のように問題が発生しているリソース (VM) を選択します。  </p><p><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/newsr-select-resource.png">  </p></li><li><p>[次へ] を 2 回押下し、”追加の詳細” タブへ移動します。<br>以下 3 つの項目と、その他の必要な情報を入力します。  </p><ul><li><p>“問題が発生し始めたのはいつですか”  </p></li><li><p>“説明”: 「問題内容・実施いただいたアクション・対象のリソース名・お問合せのゴールやお客様のご状況」をご記入いただくと調査がスムーズに進み、結果的に問題解消までの時間短縮が期待できます。<br>＊ サンプルを後述しております。必要に応じてご利用ください。<br>＊ 記載内容については、以下のブログ記事もご参照ください。  </p><ul><li><a href="https://jpaztech.github.io/blog/information/How-to-inquiry-to-the-Azure-Support/">お問い合わせの発行方法について</a>  </li><li><a href="https://zenn.dev/microsoft/articles/f0ad86348bc9ac">（障害対応編）最速でテクニカルサポートから求める回答を得る方法</a>  </li></ul></li><li><p>“ファイルのアップロード”: 可能であれば、Azure Monitor エージェントのログ ファイル (＊) を採取し、こちらに添付してください。<br>(＊) Azure Monitor エージェントのログ ファイルの採取方法は、下記の公開情報をご参照ください。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/troubleshooter-ama-windows?tabs=WindowsPowerShell">Windows オペレーティング システム (OS) の Azure Monitor エージェント トラブルシューティング ツールの使用方法</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/troubleshooter-ama-linux?tabs=redhat,GenerateLogs">Linux オペレーティング システム (OS) の Azure Monitor エージェント トラブルシューティング ツールの使用方法</a>  </li></ul></li></ul><p>(“説明” 欄のサンプル)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XXXX という名称の Azure VM リソースに対して AMA の拡張機能をインストールしましたが、Log Analytics ワークスペースに対して Heartbeat ログが全く収集されません。</span><br><span class="line"></span><br><span class="line">以下のブログを参考に AMA の再インストールを試しましたが、事象は解消しませんでした。  </span><br><span class="line">&lt;&lt;&lt; 参照した公開情報やブログの URL &gt;&gt;&gt;</span><br><span class="line">ネットワーク要件も確認しましたが、問題が無いことを確認しました。</span><br><span class="line"></span><br><span class="line">使用しているデータ収集ルールののリソース名は ZZZZ です。</span><br><span class="line">データ収集エンドポイントは使用していません。</span><br><span class="line">MM 月 DD 日までにエンドユーザー様へ環境を引き渡す必要があり、問題解消を急いでおります。</span><br><span class="line">まずは復旧を優先したいと考えておりますので、復旧のためのサポートをお願いします。</span><br></pre></td></tr></table></figure><p>(記入例)<br><img src="/blog/LogAnalytics/TroubleshootingAMALogIngestion/newsr-additionalinfo.png">  </p></li><li><p>[次へ] を押下し、”確認と作成” タブで問題がなければ、[作成] を押下します。<br>こちらでサポート リクエストの起票は完了です。<br>弊社からの連絡をお待ちください。</p></li></ol><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は、Azure Monitor エージェントを使用したログ収集が行われない場合の、初期トラブルシューティング方法についてご案内しました。<br>この情報が、事象解決の一助となれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;Azure Monitor エージェントを使用したログ収集を行っている場合、Log Analytics ワークスペースには、Heartbeat と呼ばれるログが 1 分毎に収集されます。&lt;br&gt;</summary>
      
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Retirement notice ： Migrate to Azure Monitor Agent before 31 March 2026 について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromAzureDiagnostics/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromAzureDiagnostics/</id>
    <published>2024-10-30T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.562Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの佐藤、北村です。<br>今回の記事では、サービス正常性にて通知された「Retirement notice: Migrate to Azure Monitor Agent before 31 March 2026 」についてご説明します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E5%A0%B1%E5%91%8A%E3%81%95%E3%82%8C%E3%81%9F%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%81%AE%E5%8B%A7%E5%91%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">1. 報告された正常性の勧告について</a><ul><li><a href="#1-1-%E6%A6%82%E8%A6%81">1-1.概要</a></li><li><a href="#1-2-%E5%86%85%E5%AE%B9">1-2.内容</a></li><li><a href="#1-3-%E5%AE%9F%E6%96%BD%E3%81%84%E3%81%9F%E3%81%A0%E3%81%8D%E3%81%9F%E3%81%84%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">1-3.実施いただきたいアクション</a></li></ul></li><li><a href="#2-%E7%A7%BB%E8%A1%8C%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">2. 移行が必要かどうかを確認する方法</a><ul><li><a href="#2-1-%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8A%E5%AE%A2%E6%A7%98">2-1. 影響を受けるお客様</a></li><li><a href="#2-2-%E7%A7%BB%E8%A1%8C%E5%AF%BE%E8%B1%A1%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">2-2. 移行対象のマシンを確認する手順</a></li></ul></li><li><a href="#3-%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86">3. 移行手順</a><ul><li><a href="#3-1-Azure-Diagnostics-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD-WAD-LAD-%E3%81%A7%E5%8F%8E%E9%9B%86%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">3-1. Azure Diagnostics 拡張機能 (WAD/LAD) で収集しているデータの種類を確認する</a></li><li><a href="#3-2-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%83%AD%E3%82%B0%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E9%80%81%E4%BF%A1%E3%81%99%E3%82%8B">3-2. Azure Monitor エージェントでログをストレージ アカウントに送信する</a></li><li><a href="#3-3-Azure-Diagnostics-%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD-WAD-LAD-%E3%82%92%E3%82%A2%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B">3-3. Azure Diagnostics 拡張機能 (WAD/LAD) をアンインストールする</a></li></ul></li></ul><br><h2 id="1-報告された正常性の勧告について"><a href="#1-報告された正常性の勧告について" class="headerlink" title="1. 報告された正常性の勧告について"></a>1. 報告された正常性の勧告について</h2><h3 id="1-1-概要"><a href="#1-1-概要" class="headerlink" title="1-1. 概要"></a>1-1. 概要</h3><table><thead><tr><th>項目名</th><th>項目値</th></tr></thead><tbody><tr><td>題名</td><td>Retirement notice: Migrate to Azure Monitor Agent before 31 March 2026</td></tr><tr><td>追跡 ID</td><td>GLSJ-LQ0</td></tr><tr><td>影響を受けるサービス</td><td>Azure Monitor</td></tr><tr><td>影響を受けるリージョン</td><td>Global</td></tr><tr><td>正常性イベントの種類</td><td>正常性の勧告</td></tr></tbody></table><br><h3 id="1-2-内容"><a href="#1-2-内容" class="headerlink" title="1-2. 内容"></a>1-2. 内容</h3><p>You’re receiving this notice because you use the Azure Diagnostics Agent to monitor your virtual machines (VMs) or servers.<br>On 31 March 2026, we’ll retire the Azure Diagnostic Extensions for Windows and Linux (WAD/LAD) and it’ll no longer be supported by Microsoft. You’ll need to start using the Azure Monitor Agent to monitor your VMs and servers in Azure. The Azure Monitor Agent provides new features and capabilities, including:</p><ul><li>Centralized configuration for multiple VMs.</li><li>Data limits and filters at the source.</li><li>Multiple destinations for data from a single agent. (Log Analytics, Storage, Event Hubs, and Metrics).</li></ul><p><strong>翻訳</strong><br>2026 年 3 月 31 日をもって、Windows および Linux 向けの Azure Diagnostics 拡張機能 (WAD / LAD) は廃止となり、Microsoft によるサポートが終了します。Azure の VM やサーバーを監視するために、Azure Monitor エージェントの使用を開始する必要があります。Azure Monitor エージェントには以下の新しい特徴や機能が含まれています。</p><ul><li>複数の VM に対する集中管理可能な設定機能</li><li>データ ソースに対する制限とフィルター機能</li><li>単一のエージェントから複数の送信先 (Log Analytics、Storage、Event Hubs、Metrics) へのデータ送信が可能</li></ul><br><h3 id="1-3-実施いただきたいアクション"><a href="#1-3-実施いただきたいアクション" class="headerlink" title="1-3. 実施いただきたいアクション"></a>1-3. 実施いただきたいアクション</h3><p>Follow the <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/azure-monitor-agent-send-data-to-event-hubs-and-storage?tabs=windows,windows-1">set-up instructions</a> to start using the Azure Monitor Agent to monitor your VMs and servers before 31 March 2026.<br>To check which extensions are installed on your VM, select Extensions + applications under Settings on your VM.</p><p><strong>翻訳</strong><br>2026 年 3 月 31 日までに、Azure Monitor エージェントを使用して VM やサーバーを監視するためのセットアップ手順を実行して下さい。お使いの VM にインストールされている拡張機能を確認するには、Azure VM の [設定] から [拡張機能とアプリケーション] を選択して下さい。</p><br><h2 id="2-移行が必要かどうかを確認する方法"><a href="#2-移行が必要かどうかを確認する方法" class="headerlink" title="2. 移行が必要かどうかを確認する方法"></a>2. 移行が必要かどうかを確認する方法</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure Diagnostics 拡張機能</a> は 2026 年 3 月 31 日に廃止される予定のため、引き続きパフォーマンス カウンターやログ データの収集を行うためには、同等の機能を有する <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-overview">Azure Monitor エージェント</a>への移行をお願いしております。<br>Azure Diagnostics 拡張機能は <a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/#2-Azure-VM-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A">Azure VM の診断設定</a> を有効化することで、Azure VM にインストールされ、ゲスト OS のログやメトリックをストレージ アカウントに送信します。Windows 用の Azure Diagnostics 拡張機能 は Windows Azure Diagnostics extension (WAD)、Linux 用は Linux Azure Diagnostics extension (LAD) と呼ばれています。Azure Monitor エージェントは、基本的に Log Analytics ワークスペースへログ収集を行います。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-send-data-to-event-hubs-and-storage?tabs=windows,windows-1">ストレージ アカウントへのエクスポートを行いたい場合は別途設定が必要です</a>。</p><br><h3 id="2-1-影響を受けるお客様"><a href="#2-1-影響を受けるお客様" class="headerlink" title="2-1. 影響を受けるお客様"></a>2-1. 影響を受けるお客様</h3><p>Azure VM で <a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/#2-Azure-VM-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A">Azure VM の診断設定</a> をご利用されている場合に影響がございます。<br>引き続きパフォーマンス カウンターやログ データを、ストレージ アカウントに収集する場合には Azure Monitor エージェントによる収集をご検討ください。なお、既に Azure Monitor エージェントを利用して必要なログ等を収集されている場合や、ストレージ アカウントにデータを収集する必要がない場合には、移行は不要です (Azure Diagnostics 拡張機能のアンインストールのみ実施してください)。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>Azure Monitor には “診断設定” という名前の機能が 2 つ存在します。この 2 つの機能の違いについては、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/#2-Azure-VM-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A">こちら</a> のブログでご案内しておりますので、必要に応じてご確認ください。</p></div><br><h3 id="2-2-移行対象のマシンを確認する手順"><a href="#2-2-移行対象のマシンを確認する手順" class="headerlink" title="2-2. 移行対象のマシンを確認する手順"></a>2-2. 移行対象のマシンを確認する手順</h3><p>Azure ポータルで [Resource Graph エクスプローラー] (<a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/first-query-portal">Azure Resource Graph エクスプローラー</a>) を開き、下記のようなクエリを実行することで、Azure Diagnostics 拡張機能が導入されたマシンとその接続先のストレージ アカウントを確認できます。<br>以下がサンプル クエリでございます。クエリ内、&lt;&gt; 部分についてはお客様環境に合わせてご変更いただく必要がございます。以下のクエリを実行いただき、該当するマシンがあるかどうかをご確認ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">resources </span><br><span class="line">| where subscriptionId == &quot;&lt;サブスクリプション ID&gt;&quot;</span><br><span class="line">| extend publisher = properties.publisher</span><br><span class="line">| extend extensionType = properties.type</span><br><span class="line">| extend connectedStorageAccount = properties.settings.StorageAccount</span><br><span class="line">| where extensionType in (&quot;IaaSDiagnostics&quot;,&quot;LinuxDiagnostic&quot;)</span><br><span class="line">| parse id with * &quot;/virtualMachines/&quot; vmName &quot;/extensions&quot; *</span><br><span class="line">| project vmName, extensionName = name, extensionType, publisher, location, resourceGroup, connectedStorageAccount</span><br></pre></td></tr></table></figure><p>extentionType が IaaSDiagnostics の場合は、Windows 用の Azure Diagnostics 拡張機能、<br>extentionType が LinuxDiagnostic の場合は、Linux 用の Azure Diagnostics 拡張機能を表します。<br>上記のクエリでヒットするマシンがありましたら、そのマシンには Azure Diagnostics 拡張機能が導入されていることになります。</p><br><h2 id="3-移行手順"><a href="#3-移行手順" class="headerlink" title="3. 移行手順"></a>3. 移行手順</h2><h3 id="3-1-Azure-Diagnostics-拡張機能-WAD-LAD-で収集しているデータの種類を確認する"><a href="#3-1-Azure-Diagnostics-拡張機能-WAD-LAD-で収集しているデータの種類を確認する" class="headerlink" title="3-1. Azure Diagnostics 拡張機能 (WAD/LAD) で収集しているデータの種類を確認する"></a>3-1. Azure Diagnostics 拡張機能 (WAD/LAD) で収集しているデータの種類を確認する</h3><p>Azure VM の [監視] - [診断設定] より、現在のデータ収集設定をご確認ください。下図は Linux VM の設定画面です。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaFromAzureDiagnostics/image01.png"></p><br><h3 id="3-2-Azure-Monitor-エージェントでログをストレージ-アカウントに送信する"><a href="#3-2-Azure-Monitor-エージェントでログをストレージ-アカウントに送信する" class="headerlink" title="3-2. Azure Monitor エージェントでログをストレージ アカウントに送信する"></a>3-2. Azure Monitor エージェントでログをストレージ アカウントに送信する</h3><p>Azure Monitor エージェントでログをストレージ アカウントに送信する場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-send-data-to-event-hubs-and-storage?tabs=windows,windows-1">こちら</a> の公開情報を参考に設定してください。<br>なお、Azure Monitor エージェントを導入される前に必ず <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-requirements">Azure Monitor エージェントの前提条件</a>や<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-network-configuration?tabs=PowerShellWindows">通信要件</a>をご確認ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>Azure Monitor エージェントでストレージ アカウントに送信できるログの種類は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-send-data-to-event-hubs-and-storage?tabs=windows,windows-1#migration-from-azure-diagnostic-extensions-for-linux-and-windows-ladwad">公開情報</a> に記載されております。移行前に必ずご確認ください。</p></div><br><h3 id="3-3-Azure-Diagnostics-拡張機能-WAD-LAD-をアンインストールする"><a href="#3-3-Azure-Diagnostics-拡張機能-WAD-LAD-をアンインストールする" class="headerlink" title="3-3. Azure Diagnostics 拡張機能 (WAD/LAD) をアンインストールする"></a>3-3. Azure Diagnostics 拡張機能 (WAD/LAD) をアンインストールする</h3><p>Azure ポータルから Azure Diagnostics 拡張機能 (WAD/LAD) をアンインストール方法は以下の通りです。</p><ol><li>Azure ポータル上で VM を開き、画面左側の [設定] &gt; [拡張機能とアプリケーション] を選択します。</li><li>一覧から Azure Diagnostics 拡張機能をクリックします。Windows マシンの場合は [種類] が IaaSDiagnostics を含むもの、Linux マシンの場合は [種類] が LinuxDiagnostic を含むものが該当します。</li><li>画面右上の [アンインストール] を選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaFromAzureDiagnostics/image02.png"></li></ol><hr><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの佐藤、北村です。&lt;br&gt;今回の記事では、サービス正常性にて通知された「Retirement notice: Migrate to Azure Monitor Agent before 31 March 2026 」についてご説明します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Diagnostics extension" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Diagnostics-extension/"/>
    
    <category term="WAD" scheme="https://jpazmon-integ.github.io/blog/tags/WAD/"/>
    
    <category term="LAD" scheme="https://jpazmon-integ.github.io/blog/tags/LAD/"/>
    
  </entry>
  
  <entry>
    <title>&lt;Linux 版&gt; Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク)</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/</id>
    <published>2024-10-30T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.533Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>Linux マシンにおける Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク） の設定手順の一例をご紹介します。なお、本記事は 10/2 に投稿した<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/">&lt;Windows 版&gt; Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク)</a> の Linux 版です。</p><br><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a><ul><li><a href="#1-1-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AF">1-1. ログ アラート ルールとは</a></li><li><a href="#1-2-azure-monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E6%B5%81%E3%82%8C">1-2. Azure Monitor エージェントを利用した ログ アラート ルールの設定の流れ</a></li><li><a href="#1-3-%E6%9C%AC%E3%83%96%E3%83%AD%E3%82%B0%E3%81%A7%E7%B4%B9%E4%BB%8B%E3%81%99%E3%82%8B%E5%86%85%E5%AE%B9%E3%81%AE%E5%89%8D%E6%8F%90">1-3. 本ブログで紹介する内容の前提</a></li></ul></li><li><a href="#2-%E6%80%A7%E8%83%BD%E7%9B%A3%E8%A6%96cpu%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF-%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC">2. 性能監視（CPU、メモリ、ディスク） に関するパフォーマンス カウンター</a></li><li><a href="#3-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB">3. パフォーマンス カウンターのデータ収集ルール</a><ul><li><a href="#3-1-%E6%97%A2%E5%AE%9A%E3%81%A7%E7%94%A8%E6%84%8F%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">3-1. 既定で用意されているパフォーマンス カウンターについて</a></li><li><a href="#3-2-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">3-2. パフォーマンス カウンターのデータ収集ルール設定手順</a></li></ul></li><li><a href="#4-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%BB%E3%81%AA%E8%A8%AD%E5%AE%9A%E9%A0%85%E7%9B%AE">4. ログ アラート ルールの主な設定項目</a></li><li><a href="#5-cpu-%E4%BD%BF%E7%94%A8%E7%8E%87%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB">5. CPU 使用率を監視するログ アラート ルール</a><ul><li><a href="#5-1-cpu-%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B">5-1. CPU 使用率のログ アラート ルールの設定例</a></li><li><a href="#5-2-cpu-%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">5-2. CPU 使用率のログ アラート ルールの設定手順</a></li></ul></li><li><a href="#6-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E7%8E%87%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB">6. メモリ使用率を監視するログ アラート ルール</a><ul><li><a href="#6-1-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B">6-1. メモリ使用率のログ アラート ルールの設定例</a></li><li><a href="#6-2-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">6-2. メモリ使用率のログ アラート ルールの設定手順</a></li></ul></li><li><a href="#7-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E7%8E%87%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB">7. ディスク空き容量率を監視するログ アラート ルール</a><ul><li><a href="#7-1-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B">7-1. ディスク空き容量率のログ アラート ルールの設定例</a></li><li><a href="#7-2-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">7-2. ディスク空き容量率のログ アラート ルールの設定手順</a></li></ul></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><h3 id="1-1-ログ-アラート-ルールとは"><a href="#1-1-ログ-アラート-ルールとは" class="headerlink" title="1-1. ログ アラート ルールとは"></a>1-1. ログ アラート ルールとは</h3><p>本ブログでは Red Hat Enterprise Linux 8.8 (LVM) の Azure VM に Azure Monitor エージェントを導入し、当該 VM からパフォーマンス カウンターの情報を収集して CPU 使用率やメモリ使用率、ディスク使用率を監視する「ログ アラート ルール」の設定手順を紹介します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">ログ アラート ルール</a>とは、Log Analytics ワークスペースに収集したデータを評価し、条件が満たされたときにアラートを発報します。監視要件に応じてログ クエリを設定し、アラートの条件を定義することで、しきい値を満たしたときに<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">電子メールや SMS 等に通知する</a>ことができます。例えば、Azure VM からイベント ログを収集し、5 分単位でログの評価を行い、特定のイベント ログが出力されたときにアラートを発報する、といったことが可能です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Azure Monitor エージェントではパフォーマンス カウンターを<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/tutorial-monitor-vm-guest#view-guest-metrics">メトリック</a>として収集することも可能です。そのため、ログ アラート ルールではなく、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/tutorial-metrics">メトリック アラート ルール</a>でも同様の内容を監視することができます。</p></div><br><h3 id="1-2-Azure-Monitor-エージェントを利用した-ログ-アラート-ルールの設定の流れ"><a href="#1-2-Azure-Monitor-エージェントを利用した-ログ-アラート-ルールの設定の流れ" class="headerlink" title="1-2. Azure Monitor エージェントを利用した ログ アラート ルールの設定の流れ"></a>1-2. Azure Monitor エージェントを利用した ログ アラート ルールの設定の流れ</h3><p>ログ アラート ルールを作成するための基本的な流れを説明します。<br>本ブログでは 2. および 3. の手順を紹介します。</p><hr><p><strong>1). Log Analytics ワークスペースの作成</strong><br><strong>2). データ収集ルールの作成と Azure Monitor エージェントのインストール</strong><br><strong>3). ログ アラート ルールの設定</strong></p><hr><p><strong>1). Log Analytics ワークスペースの作成</strong><br>パフォーマンス カウンターを収集する Log Analytics ワークスペースを作成してください (既存の Log Analytics ワークスペースをご利用いただくことでも構いません)。新規にワークスペースを作成する場合には <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal">弊社公開情報</a> をご参照ください。</p><p><strong>2). データ収集ルールの作成と Azure Monitor エージェントのインストール</strong><br>パフォーマンス カウンターを収集するために <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance">“データ収集ルール”</a> を作成します。<br>Azure Monitor エージェントでは、データ収集ルールでデータ ソースやデータの宛先 (Azure Monitor Metrics や Log Analytics ワークスペース) を指定します。このデータ収集ルールにマシンを紐づけることで、データ収集ルールの内容に従ってログやメトリックが収集されます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=azure-portal#installation-options">Azure ポータルからデータ収集ルールをマシンに紐づけた場合は、対象マシンのシステム割り当てマネージド ID が有効化され、自動で Azure Monitor エージェントがインストールされます</a>。</p><p><strong>3). ログ アラート ルールの設定</strong><br>Azure Monitor エージェントによってパフォーマンス カウンターが収集されていることを確認し、監視要件に応じたクエリを作成、しきい値やアラートの通知方法等を設定します。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>データ収集ルールは、ログ収集先の Log Analytics ワークスペースと同じリージョンに作成する必要があります。例えば、東日本リージョンの Log Analytics ワークスペースにログを収集したい場合は、データ収集ルールのリージョンも東日本リージョンを指定する必要があります。</p></div><br><h3 id="1-3-本ブログで紹介する内容の前提"><a href="#1-3-本ブログで紹介する内容の前提" class="headerlink" title="1-3. 本ブログで紹介する内容の前提"></a>1-3. 本ブログで紹介する内容の前提</h3><p>今回ご紹介するログ アラート ルールの設定は以下の通りです。<br><strong>以下の設定値は、あくまで一例です。ログ アラート ルールを設定する際には、お客様の監視要件に従って設定値をご検討ください。</strong></p><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>CPU</td><td>5 分毎にアラートを評価し、直近 10 分間の CPU 使用率の平均が 80 ％ を超えた場合に発報する</td></tr><tr><td>メモリ</td><td>5 分毎にアラートを評価し、直近 10 分間のメモリ使用率の平均が 80 ％ を超えた場合に発報する</td></tr><tr><td>ディスク</td><td>5 分毎にアラートを評価し、直近 10 分間のディスク使用率 (特定のファイル システム) の平均が 80 ％ を超えた場合に発報する</td></tr></tbody></table><p>Azure Monitor エージェントを導入するマシンは <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-supported-operating-systems#linux-operating-systems">Azure VM (Red Hat Enterprise Linux 8.8 (LVM)</a> であり、インターネットに接続可能な構成で、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-requirements">Azure Monitor エージェントの前提条件</a>と<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-network-configuration?tabs=PowerShellWindows">通信要件</a>を満たしているものとします。また、監視対象のマシンは 1 台、各パフォーマンスカウンターは同一の Log Analytics ワークスペースに収集します。Azure Monitor エージェントを導入いただく際には、必ず前提要件や通信要件を満たしていることをご確認ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>今回ご紹介するデータ収集ルールの設定は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> の利用を想定しておりません。AMPLS を用いて閉域網でログを収集する場合、別途<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal">データ収集エンドポイント (DCE)</a> の構築と設定が必要です。データ収集エンドポイントの詳細につきましては、<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/">弊社サポート ブログ</a>で紹介しております。AMPLS をご利用されている場合は、<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/">ブログ</a> や<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-configure">公開情報</a>もご確認くださいませ。</p></div><br><h2 id="2-性能監視（CPU、メモリ、ディスク）-に関するパフォーマンス-カウンター"><a href="#2-性能監視（CPU、メモリ、ディスク）-に関するパフォーマンス-カウンター" class="headerlink" title="2. 性能監視（CPU、メモリ、ディスク） に関するパフォーマンス カウンター"></a>2. 性能監視（CPU、メモリ、ディスク） に関するパフォーマンス カウンター</h2><p>Linux では 以下のパフォーマンス カウンターを収集いただくことで、性能（CPU、メモリ、ディスク) を監視できます。<br>Azure Monitor エージェント for Linux では、<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/">こちら</a>のブログに掲載しているパフォーマンス カウンターであれば収集可能であり、Windows マシンと同様、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/perf">Perf テーブル</a> に格納されます。</p><table><thead><tr><th>項目</th><th>パフォーマンス カウンター</th><th>クエリ</th></tr></thead><tbody><tr><td>CPU</td><td>Processor(_Total)\% Processor Time</td><td>Perf &#124; where ObjectName == &#39;Processor&#39; and CounterName == &#39;% Processor Time&#39; and InstanceName == &#39;total&#39;</td></tr><tr><td>メモリ</td><td>Memory(*)\% Used Memory</td><td>Perf &#124; where ObjectName == &#39;Memory&#39; and CounterName == &#39;% Used Memory&#39;</td></tr><tr><td>ディスク</td><td>Logical Disk(*)\% Used Space</td><td>Perf &#124; where ObjectName == &#39;Logical Disk&#39; and CounterName == &#39;% Used Space&#39;</td></tr></tbody></table><br><h2 id="3-パフォーマンス-カウンターのデータ収集ルール"><a href="#3-パフォーマンス-カウンターのデータ収集ルール" class="headerlink" title="3. パフォーマンス カウンターのデータ収集ルール"></a>3. パフォーマンス カウンターのデータ収集ルール</h2><h3 id="3-1-既定で用意されているパフォーマンス-カウンターについて"><a href="#3-1-既定で用意されているパフォーマンス-カウンターについて" class="headerlink" title="3-1. 既定で用意されているパフォーマンス カウンターについて"></a>3-1. 既定で用意されているパフォーマンス カウンターについて</h3><p>パフォーマンス カウンターの種類は多数存在し、Azure ポータルで既定で用意されているものと、そうでないものがあります。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/">既定で用意されていない場合は [カスタム] タブを選択し、収集するパフォーマンス カウンターを指定する必要があります</a>。</p><p>データ収集ルールの設定画面の [データ ソース画面] を開くと、既定で用意されているカウンターを確認できます。<br>[基本] タブの項目 (CPU, Memory, Disk, Network) は既定で用意されているパフォーマンス カウンターに該当しますが、<br><img width="600" src="../HowToCreatePerfLogAlertForLinux/image01.png"></p><p>既定のパフォーマンス カウンターは [カスタム] タブを選択すると確認できます。<br><img width="600" src="../HowToCreatePerfLogAlertForLinux/image02.png"></p><br><p>今回、監視する 3 つのカウンターは、既定で用意されているパフォーマンス カウンターのため、[基本] タブで指定されたパフォーマンス カウンターを収集するデータ収集ルールを作成します。</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>CPU</td><td>既定で用意されています。<br><img width="500" src="../HowToCreatePerfLogAlertForLinux/image03.png"></td></tr><tr><td>メモリ</td><td>既定で用意されています。<br><img width="500" src="../HowToCreatePerfLogAlertForLinux/image04.png"></td></tr><tr><td>ディスク</td><td>既定で用意されています。<br><img width="500" src="../HowToCreatePerfLogAlertForLinux/image05.png"></td></tr></tbody></table><br><h3 id="3-2-パフォーマンス-カウンターのデータ収集ルール設定手順"><a href="#3-2-パフォーマンス-カウンターのデータ収集ルール設定手順" class="headerlink" title="3-2. パフォーマンス カウンターのデータ収集ルール設定手順"></a>3-2. パフォーマンス カウンターのデータ収集ルール設定手順</h3><p>前置きが長くなりましたが、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance">パフォーマンス カウンターを収集するためにデータ収集ルールを作成</a>しましょう！</p><hr><p><strong>以下手順を実施する前に、監視対象マシンが起動中であることを確認してください。</strong><br>Azure ポータルからデータ収集ルールをマシンに紐づけた際、そのマシンが起動している場合は自動で Azure Monitor エージェントがインストールされますが、<strong>マシンが起動していない場合はエージェントがインストールされません。</strong></p><ol><li>Azure ポータルで [モニター] を検索し、[設定] &gt; [データ収集ルール] を開き、 [+ 作成] をクリックします。<img width="400" src="../HowToCreatePerfLogAlertForLinux/image06.png"></li></ol><ol start="2"><li><strong>基本画面</strong>では、データ収集ルールの名前やリージョン、プラットフォームの種類を選択します。設定例は下図のとおりです。<br>データ収集ルールは、ログ収集先の Log Analytics ワークスペースと同じリージョンに作成する必要がありますのでご注意ください。<img width="600" src="../HowToCreatePerfLogAlertForLinux/image07.png"></li></ol><div class="alert is-important"><p class="alert-title">重要</p><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90-%E5%9F%BA%E6%9C%AC-%E3%82%BF%E3%83%96">基本タブで設定するデータ収集エンドポイント (エンドポイント ID) </a>は Log Analytics ワークスペースにログを取り込む際に使用するエンドポイントで、カスタム ログや IIS ログを収集するときに必要になります。このため、パフォーマンス カウンターを収集する場合は指定する必要はございません。</p></div><br><ol start="3"><li><strong>リソース画面</strong>では、監視対象のマシンを追加します。[+ リソースの追加] をクリックし、監視対象マシンにチェックを入れ、適用ボタンをクリックしてください。これにより、自動で Azure Monitor エージェントがインストールされます。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image08.png"></li></ol><div class="alert is-important"><p class="alert-title">重要</p><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%82%BF%E3%83%96">リソース タブでもデータ収集エンドポイント</a>を有効化するチェックボタンがありますが、これは Azure Monitor エージェントに関連付けられたデータ収集ルールの設定を取得するためのエンドポイントとなります。AMPLS を使用したプライベート リンク環境で必要な手順であり、プライベート リンク環境でなければ、設定する必要はございません（ここでは AMPLS を利用しない前提のため、有効化していません）。</p></div><br><ol start="4"><li><strong>データ ソース画面</strong> で、収集するパフォーマンス カウンターと、Log Analytics ワークスペースを指定します。<br>今回は [基本] タブで指定されている既定のパフォーマンス カウンターを収集します (既定の設定から変更しません)。</li></ol><p>4-1. [+ データ ソースの追加] をクリックし、[データ ソースの種類] で “パフォーマンス カウンター” を選びます。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image09.png"></p><p>4-2. [ターゲット] 画面でログの収集先を指定します。今回はログ アラート ルールを構成するため、[ターゲットの種類] で「Azure Monitor Logs」を選択し、[Destination Details] で Log Analytics ワークスペースを選択し、[データ ソースの追加] を押下します。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image10.png"></p><div class="alert is-important"><p class="alert-title">重要</p><p>既定で用意されているパフォーマンス カウンターで不要なものがある場合には [カスタム] タブからチェックを外してください。Linux では、インスタンスの指定があるパフォーマンス カウンターはデフォルトで (*) が指定されています。例えば、ディスク使用率を監視する場合において、すべてのインスタンスではなく、特定のファイル システムのみを監視する場合では、(*) ではなく、必要なファイル システムのマウント パスのみをインスタンスに指定する等、お客様の監視要件に応じて設定内容をご検討ください。</p></div><br><ol start="5"><li>タグ画面では必要に応じてタグをご指定ください。<br>確認と作成画面で設定した内容を確認の上、[作成] ボタンを押します。データ収集ルールの作成手順は以上です。<img width="500" src="../HowToCreatePerfLogAlertForLinux/image11.png"></li></ol><br><ol start="6"><li>データ収集ルールのデプロイが完了しましたら、監視対象のマシンに Azure Monitor エージェントがインストールされたことを確認します。Azure ポータルで対象マシンの [設定] &gt; [拡張機能とアプリケーション] を開き、AzureMonitorLinuxAgent の状態が Provisioning succeeded であることを確認します。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image12.png"></li></ol><hr><br><h2 id="4-ログ-アラート-ルールの主な設定項目"><a href="#4-ログ-アラート-ルールの主な設定項目" class="headerlink" title="4. ログ アラート ルールの主な設定項目"></a>4. ログ アラート ルールの主な設定項目</h2><p>ログ アラート ルールを作成する前に、今回作成するログ アラート ルールに関連する項目を簡単にご説明します。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">弊社公開情報</a> と共に、必要に応じてご確認ください。</p><details><summary><b>測定</b></summary>ログ検索を行う検索期間、実行結果の集計方法を指定します。例えば、[集計の粒度] を 10 分、[集計の種類] を [平均] とした場合、10 分間の期間にあるデータを平均化し、その値をアラート検知に利用します。<img width="500" src="../HowToCreatePerfLogAlertForLinux/image13.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>メジャー</td><td>集計対象のテーブルの行または数値列を選択します。</td></tr><tr><td>集計の種類</td><td>[集計の粒度] で設定した期間において、データをまとめる方法を選択します。</td></tr><tr><td>集計の粒度</td><td>クエリで取得したログを一つのグループにまとめる単位を示します。</td></tr></tbody></table></details><br><details><summary><b>ディメンション</b></summary>ディメンションごとに分割すると、数値列または文字列の組み合わせがグループ化され、複数の Azure リソースで同じ条件を監視できます。複数のディメンション値を選択した場合は、その組み合わせによって生成される時系列ごとに独自のアラートがトリガーされ、個別に処理されます。<img width="700" src="../HowToCreatePerfLogAlertForLinux/image14.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>リソース ID 列</td><td>クエリ結果に リソース ID が含まれていると、自動的に検出され、選択状態となります。リソース ID を指定した場合、リソース ID 毎にアラートのターゲットとして分割され、リソース ID 別にアラートの検知、通知が行われます。</td></tr><tr><td>ディメンション名</td><td>リソース ID 以外の特定列によって分割したい場合に利用します。</td></tr></tbody></table></details><br><details><summary><b>アラートロジック</b></summary>[測定] の設定によって集計された値と比較する際のしきい値と、評価の頻度を設定します。<img width="500" src="../HowToCreatePerfLogAlertForLinux/image15.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>演算子</td><td>[測定] の設定によって集計された値と比較する際に、どの様な比較を行うかを設定します。</td></tr><tr><td>しきい値</td><td>[測定] の設定によって集計された値と比較する際に、使用するしきい値を数値で設定します。</td></tr><tr><td>評価の頻度</td><td>[測定] の設定によって集計された値としきい値の比較を行う頻度です。[評価の頻度] は [集計の粒度] で設定した期間以下とする必要があります。</td></tr></tbody></table></details><br><br><h2 id="5-CPU-使用率を監視するログ-アラート-ルール"><a href="#5-CPU-使用率を監視するログ-アラート-ルール" class="headerlink" title="5. CPU 使用率を監視するログ アラート ルール"></a>5. CPU 使用率を監視するログ アラート ルール</h2><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>CPU</td><td>5 分毎にアラートを評価し、直近 10 分間の CPU 使用率の平均が 80 ％ を超えた場合に発報する</td></tr></tbody></table><br><h3 id="5-1-CPU-使用率のログ-アラート-ルールの設定例"><a href="#5-1-CPU-使用率のログ-アラート-ルールの設定例" class="headerlink" title="5-1. CPU 使用率のログ アラート ルールの設定例"></a>5-1. CPU 使用率のログ アラート ルールの設定例</h3><p>パフォーマンス カウンターの値は、<a href="https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/perf">Perf テーブル</a>の CounterValue 列に格納されるため、[メジャー] で CounterValue を指定します。<br>今回は 5 分毎に直近 10 分間の CPU 使用率の平均値を監視するため、[評価の頻度] は 5 分、[集計の種類] は「平均」、[集計の粒度] は 10 分を指定します。</p><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>シグナル名</td><td>カスタム ログ検索</td></tr><tr><td>検索クエリ</td><td>Perf &#124; where ObjectName == &#39;Processor&#39; and CounterName == &#39;% Processor Time&#39; and InstanceName == &#39;total&#39;</td></tr><tr><td>測定 - メジャー</td><td>CounterValue</td></tr><tr><td>測定 - 集計の種類</td><td>平均</td></tr><tr><td>測定 - 集計の粒度</td><td>10 分</td></tr><tr><td>ディメンションで分割する</td><td>分割しない</td></tr><tr><td>アラート ロジック - 演算子</td><td>次の値より大きい</td></tr><tr><td>アラート ロジック - しきい値</td><td>80</td></tr><tr><td>アラート ロジック - 評価の頻度</td><td>5 分</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>同一の Log Analytics ワークスペースに複数のマシンのログを収集している場合、[ディメンションで分割する] の項目で “リソース ID 列” もしくは “Computer” を指定することで、1 つのログ アラート ルールで複数のマシンを同じ条件で監視することが可能です。ログ アラート ルールのディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">弊社公開情報</a> もご確認ください。</p></div><br><h3 id="5-2-CPU-使用率のログ-アラート-ルールの設定手順"><a href="#5-2-CPU-使用率のログ-アラート-ルールの設定手順" class="headerlink" title="5-2. CPU 使用率のログ アラート ルールの設定手順"></a>5-2. CPU 使用率のログ アラート ルールの設定手順</h3><hr><p><strong>1. ログ収集先の Log Analytics ワークスペースを開きます。</strong><br>データ収集ルールで指定したログ収集先の Log Analytics ワークスペースを開きます。</p><p><strong>2. CPU 使用率を確認するクエリを実行します。</strong><br>[ログ] から Perf &#124; where ObjectName == &#39;Processor&#39; and CounterName == &#39;% Processor Time&#39; and InstanceName == &#39;total&#39; を入力します。[実行] をクリックし、[+ 新しいアラート ルール] をクリックします。<br>※ ログの収集が開始されるまでに時間がかかる場合がございます。予めご留意ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image16.png"></p><p><strong>3. ログ アラート ルールの条件を指定します。</strong><br>5-1. のとおり値を指定します。<br><img width="650" src="../HowToCreatePerfLogAlertForLinux/image17.png"></p><p><strong>4. アラートが発報した際に通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image18.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。アクション グループの概要や設定手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image19.png"></p><p><strong>5. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] は既定の状態 (作成時に有効化のみチェックが入っている状態) とします。また、今回は Log Analytics ワークスペースのログを対象にクエリを実行するため、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">Identity</a> でマネージド ID を有効化する必要はございません。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image20.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">詳細設定オプション</a>の [アラートを自動的に解決する] と [アクションのミュート] につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>や<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction">弊社サポート ブログ</a> をご確認ください。</p></div><ol start="6"><li>最後に設定した内容を確認し、[作成] をクリックします。手順は以上です。</li></ol><hr><br><br><br><h2 id="6-メモリ使用率を監視するログ-アラート-ルール"><a href="#6-メモリ使用率を監視するログ-アラート-ルール" class="headerlink" title="6. メモリ使用率を監視するログ アラート ルール"></a>6. メモリ使用率を監視するログ アラート ルール</h2><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>メモリ</td><td>5 分毎にアラートを評価し、直近 10 分間のメモリ使用率の平均が 80 ％ を超えた場合に発報する</td></tr></tbody></table><br><h3 id="6-1-メモリ使用率のログ-アラート-ルールの設定例"><a href="#6-1-メモリ使用率のログ-アラート-ルールの設定例" class="headerlink" title="6-1. メモリ使用率のログ アラート ルールの設定例"></a>6-1. メモリ使用率のログ アラート ルールの設定例</h3><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>シグナル名</td><td>カスタム ログ検索</td></tr><tr><td>検索クエリ</td><td>Perf &#124; where ObjectName == &#39;Memory&#39; and CounterName == &#39;% Used Memory&#39;</td></tr><tr><td>測定 - メジャー</td><td>CounterValue</td></tr><tr><td>測定 - 集計の種類</td><td>平均</td></tr><tr><td>測定 - 集計の粒度</td><td>10 分</td></tr><tr><td>ディメンションで分割する</td><td>分割しない</td></tr><tr><td>アラート ロジック - 演算子</td><td>次の値より大きい</td></tr><tr><td>アラート ロジック - しきい値</td><td>80</td></tr><tr><td>アラート ロジック - 評価の頻度</td><td>5 分</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>同一の Log Analytics ワークスペースに複数のマシンのログを収集している場合、[ディメンションで分割する] の項目で “リソース ID 列” もしくは “Computer” を指定することで、1 つのログ アラート ルールで複数のマシンを同じ条件で監視することが可能です。ログ アラート ルールのディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">弊社公開情報</a> もご確認ください。</p></div><br><h3 id="6-2-メモリ使用率のログ-アラート-ルールの設定手順"><a href="#6-2-メモリ使用率のログ-アラート-ルールの設定手順" class="headerlink" title="6-2. メモリ使用率のログ アラート ルールの設定手順"></a>6-2. メモリ使用率のログ アラート ルールの設定手順</h3><hr><p><strong>1. ログ収集先の Log Analytics ワークスペースを開きます。</strong><br>データ収集ルールで指定したログ収集先の Log Analytics ワークスペースを開きます。</p><p><strong>2. メモリ使用率を確認するクエリを実行します。</strong><br>[ログ] から Perf &#124; where ObjectName == &#39;Memory&#39; and CounterName == &#39;% Used Memory&#39; を入力します。<br>[実行] をクリックし、[+ 新しいアラート ルール] をクリックします。<br>※ ログの収集が開始されるまでに時間がかかる場合がございます。予めご留意ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image21.png"></p><p><strong>3. ログ アラート ルールの条件を指定します。</strong><br>6-1. のとおり値を指定します。<br><img width="650" src="../HowToCreatePerfLogAlertForLinux/image22.png"></p><p><strong>4. アラートが発報した際に通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image18.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。アクション グループの概要や設定手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image19.png"></p><p><strong>5. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] は既定の状態 (作成時に有効化のみチェックが入っている状態) とします。また、今回は Log Analytics ワークスペースのログを対象にクエリを実行するため、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">Identity</a> でマネージド ID を有効化する必要はございません。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image20.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">詳細設定オプション</a>の [アラートを自動的に解決する] と [アクションのミュート] につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>や<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction">弊社サポート ブログ</a> をご確認ください。</p></div><ol start="6"><li>最後に設定した内容を確認し、[作成] をクリックします。手順は以上です。</li></ol><hr><br><br><h2 id="7-ディスク空き容量率を監視するログ-アラート-ルール"><a href="#7-ディスク空き容量率を監視するログ-アラート-ルール" class="headerlink" title="7. ディスク空き容量率を監視するログ アラート ルール"></a>7. ディスク空き容量率を監視するログ アラート ルール</h2><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>ディスク</td><td>5 分毎にアラートを評価し、直近 10 分間のディスク使用率 (特定のファイル システム) の平均が 80 ％ を超えた場合に発報する</td></tr></tbody></table><br><h3 id="7-1-ディスク空き容量率のログ-アラート-ルールの設定例"><a href="#7-1-ディスク空き容量率のログ-アラート-ルールの設定例" class="headerlink" title="7-1. ディスク空き容量率のログ アラート ルールの設定例"></a>7-1. ディスク空き容量率のログ アラート ルールの設定例</h3><p>データ収集ルールでは Logical Disk(*)\% Used Space を設定しているため、各ファイル システムの使用率と各ファイル システム合計での使用率が収集されます。そのため、特定のファイル システムを監視する場合にはディメンションで InstanceName を選択し、値を指定します。今回は InstanceName が /var の使用率を監視するアラート ルールを作成します。</p><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>シグナル名</td><td>カスタム ログ検索</td></tr><tr><td>検索クエリ</td><td>Perf &#124; where ObjectName == &#39;Logical Disk&#39; and CounterName == &#39;% Used Space&#39;</td></tr><tr><td>測定 - メジャー</td><td>CounterValue</td></tr><tr><td>測定 - 集計の種類</td><td>平均</td></tr><tr><td>測定 - 集計の粒度</td><td>10 分</td></tr><tr><td>ディメンションで分割する</td><td>リソース ID 列 : 分割しない <br> ディメンション名 : InstanceName <br> ディメンション値 : /var</td></tr><tr><td>アラート ロジック - 演算子</td><td>次の値より大きい</td></tr><tr><td>アラート ロジック - しきい値</td><td>80</td></tr><tr><td>アラート ロジック - 評価の頻度</td><td>5 分</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>同一の Log Analytics ワークスペースに複数のマシンのログを収集している場合、[ディメンションで分割する] の項目で “リソース ID 列” もしくは “Computer” を指定することで、1 つのログ アラート ルールで複数のマシンを同じ条件で監視することが可能です。ログ アラート ルールのディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">弊社公開情報</a> もご確認ください。</p></div><br><h3 id="7-2-ディスク空き容量率のログ-アラート-ルールの設定手順"><a href="#7-2-ディスク空き容量率のログ-アラート-ルールの設定手順" class="headerlink" title="7-2. ディスク空き容量率のログ アラート ルールの設定手順"></a>7-2. ディスク空き容量率のログ アラート ルールの設定手順</h3><hr><p><strong>1. ログ収集先の Log Analytics ワークスペースを開きます。</strong><br>データ収集ルールで指定したログ収集先の Log Analytics ワークスペースを開きます。</p><p><strong>2. ディスク空き容量率を確認するクエリを実行します。</strong><br>[ログ] から Perf &#124; where ObjectName == &#39;Logical Disk&#39; and CounterName == &#39;% Free Space&#39;を入力します。<br>[実行] をクリックし、[+ 新しいアラート ルール] をクリックします。<br>※ ログの収集が開始されるまでに時間がかかる場合がございます。予めご留意ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image23.png"></p><p><strong>3. ログ アラート ルールの条件を指定します。</strong><br>7-1. のとおり値を指定します。<br><img width="750" src="../HowToCreatePerfLogAlertForLinux/image24.png"></p><p><strong>4. アラートが発報した際に通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image18.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。アクション グループの概要や設定手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image19.png"></p><p><strong>5. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] は既定の状態 (作成時に有効化のみチェックが入っている状態) とします。また、今回は Log Analytics ワークスペースのログを対象にクエリを実行するため、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">Identity</a> でマネージド ID を有効化する必要はございません。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForLinux/image20.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">詳細設定オプション</a>の [アラートを自動的に解決する] と [アクションのミュート] につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>や<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction">弊社サポート ブログ</a> をご確認ください。</p></div><ol start="6"><li>最後に設定した内容を確認し、[作成] をクリックします。手順は以上です。</li></ol><hr><br><p>今回は Linux VM 向けの性能監視におけるアラート ルールの設定手順をご紹介しました。いかがでしたでしょうか。<br>また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/queries/perf">公開情報</a>に Perf のサンプル クエリも掲載されておりますので、こちらもご覧いただけますと幸いです。<br>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;Linux マシンにおける Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク） の設定手順の一例をご紹介します。なお、本記事は 10/2 に投稿した&lt;a h</summary>
      
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
  </entry>
  
  <entry>
    <title>ログ アラートのメール フォーマット変更について</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/LogAlert_NewEmailTemplate_2024/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/LogAlert_NewEmailTemplate_2024/</id>
    <published>2024-10-07T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.400Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの名波です。<br>今回は、ログ アラート メールのフォーマット変更についてご紹介します。<br>お客様からよくお問い合わせいただくご質問もご紹介しますので、ご参考になれば幸いです。</p><span id="more"></span><h2 id="1-ログ-アラート-メールのフォーマット変更について"><a href="#1-ログ-アラート-メールのフォーマット変更について" class="headerlink" title="1. ログ アラート メールのフォーマット変更について"></a>1. ログ アラート メールのフォーマット変更について</h2><p>ログ アラートが発報した際に送付される通知メールに新しいフォーマットが導入されました。<br>この変更は順次展開されていますが、変更適用後は以下の形式のメールが送付されるようになります。</p><p><img src="/blog/AzureMonitorEssential/LogAlert_NewEmailTemplate_2024/New_E-mail_templates_image.png" alt="New_E-mail_templates_image.png"></p><p>メールのタイトルは、**<code>Alert &#39;アラートルール名’ was fired</code>** となります。</p><p>新しいフォーマットは大規模なユーザー調査の結果に基づいて作成されました。<br>より情報量が多く視覚的に把握しやすくすることで、アラートの調査を容易にすることを目指しています。</p><p>この変更については、以下の Azure 更新情報ページでもご案内させていただいてます。<br><a href="https://azure.microsoft.com/ja-jp/updates/new-email-templates-for-log-search-alerts-api-version-20210801-and-up/">New E-mail templates for Log search alerts - API version 2021-08-01 and up | Azure updates | Microsoft Azure</a></p><h2 id="2-新しいフォーマットでメールが送信される条件"><a href="#2-新しいフォーマットでメールが送信される条件" class="headerlink" title="2. 新しいフォーマットでメールが送信される条件"></a>2. 新しいフォーマットでメールが送信される条件</h2><p>送られる通知メールが新しいフォーマットに変わるのは、以下 2 点の条件を満たしている場合となります。</p><h3 id="バージョン-2021-08-01-以降のAPI-バージョン-のログ-アラート-ルール-ログ-アラート-ルール-V2-である"><a href="#バージョン-2021-08-01-以降のAPI-バージョン-のログ-アラート-ルール-ログ-アラート-ルール-V2-である" class="headerlink" title="バージョン 2021-08-01 以降のAPI バージョン のログ アラート ルール (ログ アラート ルール V2) である"></a>バージョン 2021-08-01 以降のAPI バージョン のログ アラート ルール (ログ アラート ルール V2) である</h3><p>Azure Resource Graph エクスプローラーを利用して、既存のログ アラート ルールの API バージョンを確認することが可能です。</p><h4 id="確認手順"><a href="#確認手順" class="headerlink" title="確認手順"></a>確認手順</h4><p>まずAzure ポータルにアクセスし、「Resource Graph エクスプローラー」 に遷移します。<br>次に、以下のサンプル クエリで、対象サブスクリプション配下のログ アラートの API バージョンを表示します。<br>その後、対象サブスクリプション配下のログ アラートの API バージョンを確認します。  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line">| where subscriptionId == &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot; // サブスクリプション ID を指定します。</span><br><span class="line">| where type == &quot;microsoft.insights/scheduledqueryrules&quot;</span><br><span class="line">| project subscriptionId, name, properties[&#x27;createdWithApiVersion&#x27;]</span><br></pre></td></tr></table></figure><p>実行例は以下の通りです。<br> <img src="/blog/AzureMonitorEssential/LogAlert_NewEmailTemplate_2024/LSA_V2_query_exe.png" alt="LSA_V2_query_exe.png"></p><p>「name」 はログ アラート ルール名、「properties_createdWithApiVersion」 は API バージョンです。<br>properties_createdWithApiVersion が 2021-08-01 以降であれば、V2 のログ アラート ルールとご判断いただけます。<br>なお、Resource Graph エクスプローラー以外にも、当該のアラート ルールの設定で 「アクションをカスタマイズする」 の項目がある場合には、V2 ではない古い API バージョンのログ アラート ルールとなります。<br>( API バージョン 2021-08-01 以降は、この機能に対応していないため)</p><h3 id="対象のアクション-グループにて、「共通アラート-スキーマを有効にします」-の設定を-「いいえ」-に設定している"><a href="#対象のアクション-グループにて、「共通アラート-スキーマを有効にします」-の設定を-「いいえ」-に設定している" class="headerlink" title="対象のアクション グループにて、「共通アラート スキーマを有効にします」 の設定を 「いいえ」 に設定している"></a>対象のアクション グループにて、「共通アラート スキーマを有効にします」 の設定を 「いいえ」 に設定している</h3><p>  <img src="/blog/AzureMonitorEssential/LogAlert_NewEmailTemplate_2024/Non_Common_scheme.png" alt="Non_Common_scheme.png"></p><p>引き続き従来のフォーマットでのメール通知を受け取る場合は、アクション グループで共有スキーマを有効化してください。</p><h2 id="3-ログ-アラート-メールのフォーマット変更に関するよくあるご質問"><a href="#3-ログ-アラート-メールのフォーマット変更に関するよくあるご質問" class="headerlink" title="3. ログ アラート メールのフォーマット変更に関するよくあるご質問"></a>3. ログ アラート メールのフォーマット変更に関するよくあるご質問</h2><h3 id="Q1-従来のフォーマットで通知メールを受信する方法を教えてください。"><a href="#Q1-従来のフォーマットで通知メールを受信する方法を教えてください。" class="headerlink" title="Q1. 従来のフォーマットで通知メールを受信する方法を教えてください。"></a>Q1. 従来のフォーマットで通知メールを受信する方法を教えてください。</h3><p>対象のアクション グループにて「共通アラート スキーマを有効にします」 の設定を 「はい」 にすることで、従来のフォーマットで通知メールを受信することが可能となります。</p><p>もしアクション グループ内に通知先として複数のメール アドレスが登録されている場合、<br>通知設定時に共通アラート スキーマを有効にしたアドレスのみ、従来のフォーマットでメールが通知されるようになります。</p><p>なお本設定の影響としましては、従来のフォーマットのメールで通知されるように挙動が変わるのみです。それ以外の影響は現時点ではございません。</p><h3 id="Q2-共通アラート-スキーマを有効に設定しているアラート-ルールは今後も従来のフォーマットでメール通知されるのでしょうか。"><a href="#Q2-共通アラート-スキーマを有効に設定しているアラート-ルールは今後も従来のフォーマットでメール通知されるのでしょうか。" class="headerlink" title="Q2. 共通アラート スキーマを有効に設定しているアラート ルールは今後も従来のフォーマットでメール通知されるのでしょうか。"></a>Q2. 共通アラート スキーマを有効に設定しているアラート ルールは今後も従来のフォーマットでメール通知されるのでしょうか。</h3><p>共通アラート スキーマを有効にした場合のフォーマットの変更は現時点で予定されていません。<br>今後も従来のフォーマットが保持されてメール通知が行われます。</p><h3 id="Q3-メールフォーマットの変更が完了する具体的な日時をお教え下さい。"><a href="#Q3-メールフォーマットの変更が完了する具体的な日時をお教え下さい。" class="headerlink" title="Q3. メールフォーマットの変更が完了する具体的な日時をお教え下さい。"></a>Q3. メールフォーマットの変更が完了する具体的な日時をお教え下さい。</h3><p>現在、ログ アラート ルールが V2 且つ共通アラート スキーマを無効に設定している場合に送られる通知メールのフォーマットの変更は順次 Azure に展開されております。<br>このため、もしログ アラート ルールを複数作成していて、既に一部のアラート ルールに展開されている場合でも、その他のログ アラート ルールに対しても今後フォーマットの変更が起こる可能性があります。</p><h3 id="Q4-メールを自動で振り分けています。新しいフォーマットが導入されたら設定変更が必要ですか"><a href="#Q4-メールを自動で振り分けています。新しいフォーマットが導入されたら設定変更が必要ですか" class="headerlink" title="Q4. メールを自動で振り分けています。新しいフォーマットが導入されたら設定変更が必要ですか?"></a>Q4. メールを自動で振り分けています。新しいフォーマットが導入されたら設定変更が必要ですか?</h3><p>新しいフォーマットでは、**<code>Alert &#39;アラートルール名&#39; was fired</code>** というタイトルでメールが送付されます。<br>メールのタイトルに基づいた振り分けをしている場合は、設定の変更が必要です。<br>共通スキーマを有効化して従来のフォーマットを継続して利用される場合は、メールの振り分け設定の変更は不要です。</p><h3 id="Q5-メトリック-アラートでもフォーマットが変更されますか"><a href="#Q5-メトリック-アラートでもフォーマットが変更されますか" class="headerlink" title="Q5. メトリック アラートでもフォーマットが変更されますか?"></a>Q5. メトリック アラートでもフォーマットが変更されますか?</h3><p>現時点ではログ アラート メール以外（メトリック アラート ルールおよびアクティビティ ログ アラートルール）のフォーマットを変更する予定はございません。</p><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p><p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの名波です。&lt;br&gt;今回は、ログ アラート メールのフォーマット変更についてご紹介します。&lt;br&gt;お客様からよくお問い合わせいただくご質問もご紹介しますので、ご参考になれば幸いです。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
  </entry>
  
  <entry>
    <title>&lt;Windows 版&gt; Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク)</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/</id>
    <published>2024-10-01T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.542Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>Windows マシンにおける Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク） の設定手順の一例をご紹介します。</p><br><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a><ul><li><a href="#1-1-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AF">1-1. ログ アラート ルールとは</a></li><li><a href="#1-2-azure-monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%AE%E6%B5%81%E3%82%8C">1-2. Azure Monitor エージェントを利用した ログ アラート ルールの設定の流れ</a></li><li><a href="#1-3-%E6%9C%AC%E3%83%96%E3%83%AD%E3%82%B0%E3%81%A7%E7%B4%B9%E4%BB%8B%E3%81%99%E3%82%8B%E5%86%85%E5%AE%B9%E3%81%AE%E5%89%8D%E6%8F%90">1-3. 本ブログで紹介する内容の前提</a></li></ul></li><li><a href="#2-%E6%80%A7%E8%83%BD%E7%9B%A3%E8%A6%96cpu%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF-%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC">2. 性能監視（CPU、メモリ、ディスク） に関するパフォーマンス カウンター</a></li><li><a href="#3-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB">3. パフォーマンス カウンターのデータ収集ルール</a><ul><li><a href="#3-1-%E6%97%A2%E5%AE%9A%E3%81%A7%E7%94%A8%E6%84%8F%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">3-1. 既定で用意されているパフォーマンス カウンターについて</a></li><li><a href="#3-2-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">3-2. パフォーマンス カウンターのデータ収集ルール設定手順</a></li></ul></li><li><a href="#4-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%B8%BB%E3%81%AA%E8%A8%AD%E5%AE%9A%E9%A0%85%E7%9B%AE">4. ログ アラート ルールの主な設定項目</a></li><li><a href="#5-cpu-%E4%BD%BF%E7%94%A8%E7%8E%87%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB">5. CPU 使用率を監視するログ アラート ルール</a><ul><li><a href="#5-1-cpu-%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B">5-1. CPU 使用率のログ アラート ルールの設定例</a></li><li><a href="#5-2-cpu-%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">5-2. CPU 使用率のログ アラート ルールの設定手順</a></li></ul></li><li><a href="#6-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E7%8E%87%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB">6. メモリ使用率を監視するログ アラート ルール</a><ul><li><a href="#6-1-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B">6-1. メモリ使用率のログ アラート ルールの設定例</a></li><li><a href="#6-2-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">6-2. メモリ使用率のログ アラート ルールの設定手順</a></li></ul></li><li><a href="#7-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E7%8E%87%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB">7. ディスク空き容量率を監視するログ アラート ルール</a><ul><li><a href="#7-1-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B">7-1. ディスク空き容量率のログ アラート ルールの設定例</a></li><li><a href="#7-2-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E7%8E%87%E3%81%AE%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">7-2. ディスク空き容量率のログ アラート ルールの設定手順</a></li></ul></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><h3 id="1-1-ログ-アラート-ルールとは"><a href="#1-1-ログ-アラート-ルールとは" class="headerlink" title="1-1. ログ アラート ルールとは"></a>1-1. ログ アラート ルールとは</h3><p>本ブログでは Windows Server 2019 の Azure VM に Azure Monitor エージェントを導入し、当該 VM からパフォーマンス カウンターの情報を収集して CPU 使用率やメモリ使用率、ディスク空き容量率を監視する「ログ アラート ルール」の設定手順を紹介します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">ログ アラート ルール</a>とは、Log Analytics ワークスペースに収集したデータを評価し、条件が満たされたときにアラートを発報します。監視要件に応じてログ クエリを設定し、アラートの条件を定義することで、しきい値を満たしたときに<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">電子メールや SMS 等に通知する</a>ことができます。例えば、Azure VM からイベント ログを収集し、5 分単位でログの評価を行い、特定のイベント ログが出力されたときにアラートを発報する、といったことが可能です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Azure Monitor エージェントではパフォーマンス カウンターを<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/tutorial-monitor-vm-guest#view-guest-metrics">メトリック</a>として収集することも可能です。そのため、ログ アラート ルールではなく、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/tutorial-metrics">メトリック アラート ルール</a>でも同様の内容を監視することができます。</p></div><br><h3 id="1-2-Azure-Monitor-エージェントを利用した-ログ-アラート-ルールの設定の流れ"><a href="#1-2-Azure-Monitor-エージェントを利用した-ログ-アラート-ルールの設定の流れ" class="headerlink" title="1-2. Azure Monitor エージェントを利用した ログ アラート ルールの設定の流れ"></a>1-2. Azure Monitor エージェントを利用した ログ アラート ルールの設定の流れ</h3><p>ログ アラート ルールを作成するための基本的な流れを説明します。<br>本ブログでは 2. および 3. の手順を紹介します。</p><hr><p><strong>1). Log Analytics ワークスペースの作成</strong><br><strong>2). データ収集ルールの作成と Azure Monitor エージェントのインストール</strong><br><strong>3). ログ アラート ルールの設定</strong></p><hr><p><strong>1) Log Analytics ワークスペースの作成</strong><br>パフォーマンス カウンターを収集する Log Analytics ワークスペースを作成してください (既存の Log Analytics ワークスペースをご利用いただくことでも構いません)。新規にワークスペースを作成する場合には <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal">弊社公開情報</a> をご参照ください。</p><p><strong>2) データ収集ルールの作成と Azure Monitor エージェントのインストール</strong><br>パフォーマンス カウンターを収集するために <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance">“データ収集ルール”</a> を作成します。<br>Azure Monitor エージェントでは、データ収集ルールでデータ ソースやデータの宛先 (Azure Monitor Metrics や Log Analytics ワークスペース) を指定します。このデータ収集ルールにマシンを紐づけることで、データ収集ルールの内容に従ってログやメトリックが収集されます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=azure-portal#installation-options">Azure ポータルからデータ収集ルールをマシンに紐づけた場合は、対象マシンのシステム割り当てマネージド ID が有効化され、自動で Azure Monitor エージェントがインストールされます</a>。</p><p><strong>3) ログ アラート ルールの設定</strong><br>Azure Monitor エージェントによってパフォーマンス カウンターが収集されていることを確認し、監視要件に応じたクエリを作成、しきい値やアラートの通知方法等を設定します。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>データ収集ルールは、ログ収集先の Log Analytics ワークスペースと同じリージョンに作成する必要があります。例えば、東日本リージョンの Log Analytics ワークスペースにログを収集したい場合は、データ収集ルールのリージョンも東日本リージョンを指定する必要があります。</p></div><h3 id="1-3-本ブログで紹介する内容の前提"><a href="#1-3-本ブログで紹介する内容の前提" class="headerlink" title="1-3. 本ブログで紹介する内容の前提"></a>1-3. 本ブログで紹介する内容の前提</h3><p>今回ご紹介するログ アラート ルールの設定は以下の通りです。<br><strong>以下の設定値は、あくまで一例です。ログ アラート ルールを設定する際には、お客様の監視要件に従って設定値をご検討ください。</strong></p><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>CPU</td><td>5 分毎にアラートを評価し、直近 10 分間の CPU 使用率の平均が 80 ％ を超えた場合に発報する</td></tr><tr><td>メモリ</td><td>5 分毎にアラートを評価し、直近 10 分間のメモリ使用率の平均が 80 ％ を超えた場合に発報する</td></tr><tr><td>ディスク</td><td>5 分毎にアラートを評価し、直近 10 分間のディスク空き容量率 (C ドライブと D ドライブ) が 30 % 以下となった場合に発報する</td></tr></tbody></table><p>Azure Monitor エージェントを導入するマシンは <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-supported-operating-systems">Azure VM (Windows Server 2019)</a> であり、インターネットに接続可能な構成で、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-requirements">Azure Monitor エージェントの前提条件</a>と<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-network-configuration?tabs=PowerShellWindows">通信要件</a>を満たしているものとします。また、監視対象のマシンは 1 台、各パフォーマンスカウンターは同一の Log Analytics ワークスペースに収集します。Azure Monitor エージェントを導入いただく際には、必ず前提要件や通信要件を満たしていることをご確認ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>今回ご紹介するデータ収集ルールの設定は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> の利用を想定しておりません。AMPLS を用いて閉域網でログを収集する場合、別途<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal">データ収集エンドポイント (DCE)</a> の構築と設定が必要です。データ収集エンドポイントの詳細につきましては、<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/">弊社サポート ブログ</a>で紹介しております。AMPLS をご利用されている場合は、<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/">ブログ</a> や<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-configure">公開情報</a>もご確認くださいませ。</p></div><br><h2 id="2-性能監視（CPU、メモリ、ディスク）-に関するパフォーマンス-カウンター"><a href="#2-性能監視（CPU、メモリ、ディスク）-に関するパフォーマンス-カウンター" class="headerlink" title="2. 性能監視（CPU、メモリ、ディスク） に関するパフォーマンス カウンター"></a>2. 性能監視（CPU、メモリ、ディスク） に関するパフォーマンス カウンター</h2><p>Windows では 以下のパフォーマンス カウンターを収集いただくことで、性能（CPU、メモリ、ディスク) を監視できます。<br>Azure Monitor エージェント for Windows では、Windows OS 上に存在するパフォーマンス カウンターであれば取得が可能であり、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/perf">Perf テーブル</a> に格納されます。</p><table><thead><tr><th>項目</th><th>パフォーマンス カウンター</th><th>クエリ</th></tr></thead><tbody><tr><td>CPU</td><td>\Processor Information(_Total)\% Processor Time</td><td>Perf &#124; where ObjectName == &#39;Processor Information&#39; and CounterName == &#39;% Processor Time&#39;</td></tr><tr><td>メモリ</td><td>\Memory\% Committed Bytes In Use</td><td>Perf &#124; where ObjectName == &#39;Memory&#39; and CounterName == &#39;% Committed Bytes In Use&#39;</td></tr><tr><td>ディスク</td><td>\LogicalDisk(*)\% Free Space</td><td>Perf &#124; where ObjectName == &#39;LogicalDisk&#39; and CounterName == &#39;% Free Space&#39;</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>Windows ではディスク使用容量の割合に関するパフォーマンスが OS 自体に提供されておりませんので、今回は空き容量率を示す \LogicalDisk(*)\% Free Space を監視する構成としております。\LogicalDisk(*)\% Free Space では、個別のインスタンス毎の値が収集されますが、特定のドライブのみログを収集する場合には \LogicalDisk(C:)\% Free Space や \LogicalDisk(D:)\% Free Space 等とご指定ください。また、Processor 関連のパフォーマンス カウンターには Processor と Processor Information が存在しますが、違いにつきましては <a href="https://jpwinsup.github.io/blog/2022/07/15/Performance/SystemResource/PerformanceCounterProcessor/#1-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%85%A8%E4%BD%93%E3%81%AE-CPU-%E4%BD%BF%E7%94%A8%E7%8A%B6%E6%B3%81">弊社サポート ブログ</a>をご覧ください。</p></div><br><h2 id="3-パフォーマンス-カウンターのデータ収集ルール"><a href="#3-パフォーマンス-カウンターのデータ収集ルール" class="headerlink" title="3. パフォーマンス カウンターのデータ収集ルール"></a>3. パフォーマンス カウンターのデータ収集ルール</h2><h3 id="3-1-既定で用意されているパフォーマンス-カウンターについて"><a href="#3-1-既定で用意されているパフォーマンス-カウンターについて" class="headerlink" title="3-1. 既定で用意されているパフォーマンス カウンターについて"></a>3-1. 既定で用意されているパフォーマンス カウンターについて</h3><p>パフォーマンス カウンターの種類は多数存在し、Azure ポータルで既定で用意されているものと、そうでないものがあります。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/">既定で用意されていない場合は [カスタム] タブを選択し、収集するパフォーマンス カウンターを指定する必要があります</a>。</p><p>データ収集ルールの設定画面の [データ ソース画面] を開くと、既定で用意されているカウンターを確認できます。<br>[基本] タブの項目 (CPU, Memory, Disk, Network) は既定で用意されているパフォーマンス カウンターに該当しますが、<br><img width="600" src="../HowToCreatePerfLogAlertForWin/image06-01.png"></p><p>既定のパフォーマンス カウンターは [カスタム] タブを選択すると確認できます。<br><img width="600" src="../HowToCreatePerfLogAlertForWin/image06-02.png"></p><br><p>今回、監視する 3 つのカウンターのうち、既定で用意されていないパフォーマンス カウンターは \LogicalDisk(*)\% Free Space です。<br>このため、[基本] タブで指定されている既定のパフォーマンス カウンターに加え、[カスタム] タブから \LogicalDisk(*)\% Free Space のパフォーマンス カウンターを指定します。</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>CPU</td><td>既定で用意されています。<br><img width="500" src="../HowToCreatePerfLogAlertForWin/image07.png"></td></tr><tr><td>メモリ</td><td>既定で用意されています。<br><img width="500" src="../HowToCreatePerfLogAlertForWin/image08.png"></td></tr><tr><td>ディスク</td><td>既定で用意されていません。[基本] タブの項目では InstanceName が _Total の情報しか収集されません。<br><img width="500" src="../HowToCreatePerfLogAlertForWin/image09.png"></td></tr></tbody></table><br><h3 id="3-2-パフォーマンス-カウンターのデータ収集ルール設定手順"><a href="#3-2-パフォーマンス-カウンターのデータ収集ルール設定手順" class="headerlink" title="3-2. パフォーマンス カウンターのデータ収集ルール設定手順"></a>3-2. パフォーマンス カウンターのデータ収集ルール設定手順</h3><p>前置きが長くなりましたが、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance">パフォーマンス カウンターを収集するためにデータ収集ルールを作成</a>しましょう！</p><hr><p><strong>以下手順を実施する前に、監視対象マシンが起動中であることを確認してください。</strong><br>Azure ポータルからデータ収集ルールをマシンに紐づけた際、そのマシンが起動している場合は自動で Azure Monitor エージェントがインストールされますが、<strong>マシンが起動していない場合はエージェントがインストールされません。</strong></p><ol><li>Azure ポータルで [モニター] を検索し、[設定] &gt; [データ収集ルール] を開き、 [+ 作成] をクリックします。<img width="400" src="../HowToCreatePerfLogAlertForWin/image01.png"></li></ol><ol start="2"><li><strong>基本画面</strong>では、データ収集ルールの名前やリージョン、プラットフォームの種類を選択します。設定例は下図のとおりです。<br>データ収集ルールは、ログ収集先の Log Analytics ワークスペースと同じリージョンに作成する必要がありますのでご注意ください。<img width="600" src="../HowToCreatePerfLogAlertForWin/image02.png"></li></ol><div class="alert is-important"><p class="alert-title">重要</p><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90-%E5%9F%BA%E6%9C%AC-%E3%82%BF%E3%83%96">基本タブで設定するデータ収集エンドポイント (エンドポイント ID) </a>は Log Analytics ワークスペースにログを取り込む際に使用するエンドポイントで、カスタム ログや IIS ログを収集するときに必要になります。このため、パフォーマンス カウンターを収集する場合は指定する必要はございません。</p></div><br><ol start="3"><li><strong>リソース画面</strong>では、監視対象のマシンを追加します。[+ リソースの追加] をクリックし、監視対象マシンにチェックを入れ、適用ボタンをクリックしてください。これにより、自動で Azure Monitor エージェントがインストールされます。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image03.png"></li></ol><div class="alert is-important"><p class="alert-title">重要</p><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9-%E3%82%BF%E3%83%96">リソース タブでもデータ収集エンドポイント</a>を有効化するチェックボタンがありますが、これは Azure Monitor エージェントに関連付けられたデータ収集ルールの設定を取得するためのエンドポイントとなります。AMPLS を使用したプライベート リンク環境で必要な手順であり、プライベート リンク環境でなければ、設定する必要はございません（ここでは AMPLS を利用しない前提のため、有効化していません）。</p></div><br><ol start="4"><li><strong>データ ソース画面</strong> で、収集するパフォーマンス カウンターと、Log Analytics ワークスペースを指定します。<br>[基本] タブで指定されている既定のパフォーマンス カウンターに加え、[カスタム] タブで \LogicalDisk(*)% Free Space のパフォーマンス カウンターを指定します。</li></ol><p>4-1. [+ データ ソースの追加] をクリックし、[データ ソースの種類] で “パフォーマンス カウンター” を選びます。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image04.png"></p><p>4-2. [ターゲット] 画面でログの収集先を指定します。今回はログ アラート ルールを構成するため、[ターゲットの種類] で「Azure Monitor Logs」を選択し、[Destination Details] で Log Analytics ワークスペースを選択してください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image11.png"></p><p>4-3. [データ ソース] 画面に戻り、[カスタム] タブから \LogicalDisk(*)\% Free Space のパフォーマンス カウンターを指定します。</p><p>下図の通り \LogicalDisk(*)\% Free Space と入力して [追加] をクリックし、当該カウンターにチェックを入れて [データ ソースの追加] ボタンを押します。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image10.png"></p><div class="alert is-important"><p class="alert-title">重要</p><p>既定で用意されているパフォーマンス カウンターで不要なものがある場合には [カスタム] タブからチェックを外してください。また、Windows では、インスタンスの指定があるパフォーマンス カウンターはデフォルトでは _Total のインスタンスの収集となっているものが多く、ドライブ単位でディスク空き容量を監視する場合、デフォルトで用意された (_Total) のインスタンスではなく、(*) のインスタンスで収集設定を追加いただく必要があります。</p></div><br><ol start="5"><li>タグ画面では必要に応じてタグをご指定ください。<br>確認と作成画面で設定した内容を確認の上、[作成] ボタンを押します。データ収集ルールの作成手順は以上です。<img width="500" src="../HowToCreatePerfLogAlertForWin/image12.png"></li></ol><br><ol start="6"><li>データ収集ルールのデプロイが完了しましたら、監視対象のマシンに Azure Monitor エージェントがインストールされたことを確認します。Azure ポータルで対象マシンの [設定] &gt; [拡張機能とアプリケーション] を開き、AzureMonitorWindowsAgent の状態が Provisioning succeeded であることを確認します。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image13.png"></li></ol><hr><br><h2 id="4-ログ-アラート-ルールの主な設定項目"><a href="#4-ログ-アラート-ルールの主な設定項目" class="headerlink" title="4. ログ アラート ルールの主な設定項目"></a>4. ログ アラート ルールの主な設定項目</h2><p>ログ アラート ルールを作成する前に、今回作成するログ アラート ルールに関連する項目を簡単にご説明します。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">弊社公開情報</a> と共に、必要に応じてご確認ください。</p><details><summary><b>測定</b></summary>ログ検索を行う検索期間、実行結果の集計方法を指定します。例えば、[集計の粒度] を 10 分、[集計の種類] を [平均] とした場合、10 分間の期間にあるデータを平均化し、その値をアラート検知に利用します。<img width="500" src="../HowToCreatePerfLogAlertForWin/image27.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>メジャー</td><td>集計対象のテーブルの行または数値列を選択します。</td></tr><tr><td>集計の種類</td><td>[集計の粒度] で設定した期間において、データをまとめる方法を選択します。</td></tr><tr><td>集計の粒度</td><td>クエリで取得したログを一つのグループにまとめる単位を示します。</td></tr></tbody></table></details><br><details><summary><b>ディメンション</b></summary>ディメンションごとに分割すると、数値列または文字列の組み合わせがグループ化され、複数の Azure リソースで同じ条件を監視できます。複数のディメンション値を選択した場合は、その組み合わせによって生成される時系列ごとに独自のアラートがトリガーされ、個別に処理されます。<img width="700" src="../HowToCreatePerfLogAlertForWin/image29.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>リソース ID 列</td><td>クエリ結果に リソース ID が含まれていると、自動的に検出され、選択状態となります。リソース ID を指定した場合、リソース ID 毎にアラートのターゲットとして分割され、リソース ID 別にアラートの検知、通知が行われます。</td></tr><tr><td>ディメンション名</td><td>リソース ID 以外の特定列によって分割したい場合に利用します。</td></tr></tbody></table></details><br><details><summary><b>アラートロジック</b></summary>[測定] の設定によって集計された値と比較する際のしきい値と、評価の頻度を設定します。<img width="500" src="../HowToCreatePerfLogAlertForWin/image28.png"><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>演算子</td><td>[測定] の設定によって集計された値と比較する際に、どの様な比較を行うかを設定します。</td></tr><tr><td>しきい値</td><td>[測定] の設定によって集計された値と比較する際に、使用するしきい値を数値で設定します。</td></tr><tr><td>評価の頻度</td><td>[測定] の設定によって集計された値としきい値の比較を行う頻度です。[評価の頻度] は [集計の粒度] で設定した期間以下とする必要があります。</td></tr></tbody></table></details><br><br><h2 id="5-CPU-使用率を監視するログ-アラート-ルール"><a href="#5-CPU-使用率を監視するログ-アラート-ルール" class="headerlink" title="5. CPU 使用率を監視するログ アラート ルール"></a>5. CPU 使用率を監視するログ アラート ルール</h2><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>CPU</td><td>5 分毎にアラートを評価し、直近 10 分間の CPU 使用率の平均が 80 ％ を超えた場合に発報する</td></tr></tbody></table><br><h3 id="5-1-CPU-使用率のログ-アラート-ルールの設定例"><a href="#5-1-CPU-使用率のログ-アラート-ルールの設定例" class="headerlink" title="5-1. CPU 使用率のログ アラート ルールの設定例"></a>5-1. CPU 使用率のログ アラート ルールの設定例</h3><p>パフォーマンス カウンターの値は、<a href="https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/perf">Perf テーブル</a>の CounterValue 列に格納されるため、[メジャー] で CounterValue を指定します。<br>今回は 5 分毎に直近 10 分間の CPU 使用率の平均値を監視するため、[評価の頻度] は 5 分、[集計の種類] は「平均」、[集計の粒度] は 10 分を指定します。</p><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>シグナル名</td><td>カスタム ログ検索</td></tr><tr><td>検索クエリ</td><td>Perf &#124; where ObjectName == &#39;Processor Information&#39; and CounterName == &#39;% Processor Time&#39;</td></tr><tr><td>測定 - メジャー</td><td>CounterValue</td></tr><tr><td>測定 - 集計の種類</td><td>平均</td></tr><tr><td>測定 - 集計の粒度</td><td>10 分</td></tr><tr><td>ディメンションで分割する</td><td>分割しない</td></tr><tr><td>アラート ロジック - 演算子</td><td>次の値より大きい</td></tr><tr><td>アラート ロジック - しきい値</td><td>80</td></tr><tr><td>アラート ロジック - 評価の頻度</td><td>5 分</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>同一の Log Analytics ワークスペースに複数のマシンのログを収集している場合、[ディメンションで分割する] の項目で “リソース ID 列” もしくは “Computer” を指定することで、1 つのログ アラート ルールで複数のマシンを同じ条件で監視することが可能です。ログ アラート ルールのディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">弊社公開情報</a> もご確認ください。</p></div><br><h3 id="5-2-CPU-使用率のログ-アラート-ルールの設定手順"><a href="#5-2-CPU-使用率のログ-アラート-ルールの設定手順" class="headerlink" title="5-2. CPU 使用率のログ アラート ルールの設定手順"></a>5-2. CPU 使用率のログ アラート ルールの設定手順</h3><hr><p><strong>1. ログ収集先の Log Analytics ワークスペースを開きます。</strong><br>データ収集ルールで指定したログ収集先の Log Analytics ワークスペースを開きます。</p><p><strong>2. CPU 使用率を確認するクエリを実行します。</strong><br>[ログ] から Perf &#124; where ObjectName == &#39;Processor Information&#39; and CounterName == &#39;% Processor Time&#39; を入力します。<br>[実行] をクリックし、[+ 新しいアラート ルール] をクリックします。<br>※ ログの収集が開始されるまでに時間がかかる場合がございます。予めご留意ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image17.png"></p><p><strong>3. ログ アラート ルールの条件を指定します。</strong><br>5-1. のとおり値を指定します。<br><img width="650" src="../HowToCreatePerfLogAlertForWin/image18.png"></p><p><strong>4. アラートが発報した際に通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image19.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。アクション グループの概要や設定手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image20.png"></p><p><strong>5. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] は既定の状態 (作成時に有効化のみチェックが入っている状態) とします。また、今回は Log Analytics ワークスペースのログを対象にクエリを実行するため、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">Identity</a> でマネージド ID を有効化する必要はございません。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image22.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">詳細設定オプション</a>の [アラートを自動的に解決する] と [アクションのミュート] につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>や<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction">弊社サポート ブログ</a> をご確認ください。</p></div><ol start="6"><li>最後に設定した内容を確認し、[作成] をクリックします。手順は以上です。</li></ol><hr><br><br><br><h2 id="6-メモリ使用率を監視するログ-アラート-ルール"><a href="#6-メモリ使用率を監視するログ-アラート-ルール" class="headerlink" title="6. メモリ使用率を監視するログ アラート ルール"></a>6. メモリ使用率を監視するログ アラート ルール</h2><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>メモリ</td><td>5 分毎にアラートを評価し、直近 10 分間のメモリ使用率の平均が 80 ％ を超えた場合に発報する</td></tr></tbody></table><br><h3 id="6-1-メモリ使用率のログ-アラート-ルールの設定例"><a href="#6-1-メモリ使用率のログ-アラート-ルールの設定例" class="headerlink" title="6-1. メモリ使用率のログ アラート ルールの設定例"></a>6-1. メモリ使用率のログ アラート ルールの設定例</h3><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>シグナル名</td><td>カスタム ログ検索</td></tr><tr><td>検索クエリ</td><td>Perf &#124; where ObjectName == &#39;Memory&#39; and CounterName == &#39;% Committed Bytes In Use&#39;</td></tr><tr><td>測定 - メジャー</td><td>CounterValue</td></tr><tr><td>測定 - 集計の種類</td><td>平均</td></tr><tr><td>測定 - 集計の粒度</td><td>10 分</td></tr><tr><td>ディメンションで分割する</td><td>分割しない</td></tr><tr><td>アラート ロジック - 演算子</td><td>次の値より大きい</td></tr><tr><td>アラート ロジック - しきい値</td><td>80</td></tr><tr><td>アラート ロジック - 評価の頻度</td><td>5 分</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>同一の Log Analytics ワークスペースに複数のマシンのログを収集している場合、[ディメンションで分割する] の項目で “リソース ID 列” もしくは “Computer” を指定することで、1 つのログ アラート ルールで複数のマシンを同じ条件で監視することが可能です。ログ アラート ルールのディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">弊社公開情報</a> もご確認ください。</p></div><br><h3 id="6-2-メモリ使用率のログ-アラート-ルールの設定手順"><a href="#6-2-メモリ使用率のログ-アラート-ルールの設定手順" class="headerlink" title="6-2. メモリ使用率のログ アラート ルールの設定手順"></a>6-2. メモリ使用率のログ アラート ルールの設定手順</h3><hr><p><strong>1. ログ収集先の Log Analytics ワークスペースを開きます。</strong><br>データ収集ルールで指定したログ収集先の Log Analytics ワークスペースを開きます。</p><p><strong>2. メモリ使用率を確認するクエリを実行します。</strong><br>[ログ] から Perf &#124; where ObjectName == &#39;Memory&#39; and CounterName == &#39;% Committed Bytes In Use&#39;を入力します。<br>[実行] をクリックし、[+ 新しいアラート ルール] をクリックします。<br>※ ログの収集が開始されるまでに時間がかかる場合がございます。予めご留意ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image23.png"></p><p><strong>3. ログ アラート ルールの条件を指定します。</strong><br>6-1. のとおり値を指定します。<br><img width="650" src="../HowToCreatePerfLogAlertForWin/image24.png"></p><p><strong>4. アラートが発報した際に通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image19.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。アクション グループの概要や設定手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image20.png"></p><p><strong>5. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] は既定の状態 (作成時に有効化のみチェックが入っている状態) とします。また、今回は Log Analytics ワークスペースのログを対象にクエリを実行するため、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">Identity</a> でマネージド ID を有効化する必要はございません。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image22.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">詳細設定オプション</a>の [アラートを自動的に解決する] と [アクションのミュート] につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>や<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction">弊社サポート ブログ</a> をご確認ください。</p></div><ol start="6"><li>最後に設定した内容を確認し、[作成] をクリックします。手順は以上です。</li></ol><hr><br><br><h2 id="7-ディスク空き容量率を監視するログ-アラート-ルール"><a href="#7-ディスク空き容量率を監視するログ-アラート-ルール" class="headerlink" title="7. ディスク空き容量率を監視するログ アラート ルール"></a>7. ディスク空き容量率を監視するログ アラート ルール</h2><table><thead><tr><th>項目</th><th>アラート ルールの内容</th></tr></thead><tbody><tr><td>ディスク</td><td>5 分毎にアラートを評価し、直近 10 分間のディスク空き容量率 (C ドライブと D ドライブ) が 30 % 以下となった場合に発報する</td></tr></tbody></table><br><h3 id="7-1-ディスク空き容量率のログ-アラート-ルールの設定例"><a href="#7-1-ディスク空き容量率のログ-アラート-ルールの設定例" class="headerlink" title="7-1. ディスク空き容量率のログ アラート ルールの設定例"></a>7-1. ディスク空き容量率のログ アラート ルールの設定例</h3><p>今回は C ドライブと D ドライブの空き容量率を監視します。<br>データ収集ルールでは \LogicalDisk(*)\% Free Space を設定しているため、各ドライブの空き容量率と各ドライブの合計での空き容量率が収集されます。そのため、ディメンションで InstanceName を選択し、ディメンション値で C: と D: を選択します。<br>これにより、C ドライブと D ドライブの値を、1 つのアラート ルールで同じ条件で監視することができます。</p><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>シグナル名</td><td>カスタム ログ検索</td></tr><tr><td>検索クエリ</td><td>Perf &#124; where ObjectName == &#39;LogicalDisk&#39; and CounterName == &#39;% Free Space&#39;</td></tr><tr><td>測定 - メジャー</td><td>CounterValue</td></tr><tr><td>測定 - 集計の種類</td><td>平均</td></tr><tr><td>測定 - 集計の粒度</td><td>10 分</td></tr><tr><td>ディメンションで分割する</td><td>リソース ID 列 : 分割しない <br> ディメンション名 : InstanceName <br> ディメンション値 : C: および D:</td></tr><tr><td>アラート ロジック - 演算子</td><td>次の値以下</td></tr><tr><td>アラート ロジック - しきい値</td><td>30</td></tr><tr><td>アラート ロジック - 評価の頻度</td><td>5 分</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>同一の Log Analytics ワークスペースに複数のマシンのログを収集している場合、[ディメンションで分割する] の項目で “リソース ID 列” もしくは “Computer” を指定することで、1 つのログ アラート ルールで複数のマシンを同じ条件で監視することが可能です。ログ アラート ルールのディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#log-alerts">弊社公開情報</a> もご確認ください。</p></div><br><h3 id="7-2-ディスク空き容量率のログ-アラート-ルールの設定手順"><a href="#7-2-ディスク空き容量率のログ-アラート-ルールの設定手順" class="headerlink" title="7-2. ディスク空き容量率のログ アラート ルールの設定手順"></a>7-2. ディスク空き容量率のログ アラート ルールの設定手順</h3><hr><p><strong>1. ログ収集先の Log Analytics ワークスペースを開きます。</strong><br>データ収集ルールで指定したログ収集先の Log Analytics ワークスペースを開きます。</p><p><strong>2. ディスク空き容量率を確認するクエリを実行します。</strong><br>[ログ] から Perf &#124; where ObjectName == &#39;LogicalDisk&#39; and CounterName == &#39;% Free Space&#39;を入力します。<br>[実行] をクリックし、[+ 新しいアラート ルール] をクリックします。<br>※ ログの収集が開始されるまでに時間がかかる場合がございます。予めご留意ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image25.png"></p><p><strong>3. ログ アラート ルールの条件を指定します。</strong><br>7-1. のとおり値を指定します。<br><img width="750" src="../HowToCreatePerfLogAlertForWin/image26.png"></p><p><strong>4. アラートが発報した際に通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image19.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。アクション グループの概要や設定手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image20.png"></p><p><strong>5. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] は既定の状態 (作成時に有効化のみチェックが入っている状態) とします。また、今回は Log Analytics ワークスペースのログを対象にクエリを実行するため、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">Identity</a> でマネージド ID を有効化する必要はございません。<br><img src="/blog/LogAnalytics/HowToCreatePerfLogAlertForWin/image22.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-log-alert-rule#configure-alert-rule-details">詳細設定オプション</a>の [アラートを自動的に解決する] と [アクションのミュート] につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>や<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction">弊社サポート ブログ</a> をご確認ください。</p></div><ol start="6"><li>最後に設定した内容を確認し、[作成] をクリックします。手順は以上です。</li></ol><hr><br><p>今回は Windows VM 向けの性能監視におけるアラート ルールの設定手順をご紹介しました。いかがでしたでしょうか。<br>また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/queries/perf">公開情報</a>に Perf のサンプル クエリも掲載されておりますので、こちらもご覧いただけますと幸いです。<br>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;Windows マシンにおける Azure Monitor エージェントを利用した性能監視（CPU、メモリ、ディスク） の設定手順の一例をご紹介します。&lt;/p&gt;
&lt;br&gt;




&lt;h2 id</summary>
      
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
  </entry>
  
  <entry>
    <title>メトリック アラート ルールで NULL を検知することはできない</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnableToDetectNullMetric/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnableToDetectNullMetric/</id>
    <published>2024-09-17T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.427Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回はメトリックがない (NULL) 場合のメトリック アラート ルールの動作について説明します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%81%8C-NULL-%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%A8%E3%81%AF">2. メトリックが NULL の状態とは</a></li><li><a href="#3-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%81%8C-NULL-%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF%E8%A9%95%E4%BE%A1%E3%81%8C%E3%82%B9%E3%82%AD%E3%83%83%E3%83%97%E3%81%95%E3%82%8C%E3%82%8B">3. メトリックが NULL の場合は評価がスキップされる</a></li><li><a href="#4-%E3%81%BE%E3%81%A8%E3%82%81">4. まとめ</a><br></li></ul><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#metric-alerts">メトリック アラート ルール</a>でテストを実施したが、しきい値を満たしている状況なのに想定どおりに発報しない・・・というお問い合わせをいただくことがございます。このようなときにご確認いただきたい点は「メトリックが出力されているかどうか」です。<br>本ブログのタイトルのとおり、メトリック アラート ルールでは「NULL」を検知することはできません。対象の評価期間の間、メトリックが NULL の場合は、アラート ルールが評価をスキップするためです。一方で、評価期間中に一度でも値が記録された場合は、その値をもとに評価が実行されます (評価はスキップされません)。</p><br><h2 id="2-メトリックが-NULL-の状態とは"><a href="#2-メトリックが-NULL-の状態とは" class="headerlink" title="2. メトリックが NULL の状態とは"></a>2. メトリックが NULL の状態とは</h2><p>メトリックが「NULL」の状態は、メトリックが何も出力されていないことを意味します。<br>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#null-and-zero-values">弊社公開情報</a> をご参照いただきたく存じますが、NULL はゼロ値とは異なります。</p><p>ここでは Azure VM の<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/monitor-vm-reference#vm-availability-metric-preview">可用性メトリック ‘VM Availability Metric (Preview)’</a> を、折れ線グラフで描画した例に説明します。<br>この<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/VMAvailability-MetricAlert/#2-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%81%A8%E3%81%AF">メトリック</a>では VM が実行中の場合は 1 が記録されますが、Azure VM が “停止済み (割り当て解除)” の場合はメトリックの値が NULL になります。</p><p>VM が実行している間は 1 が記録されます。<br><img src="/blog/AzureMonitorEssential/UnableToDetectNullMetric/image01.png"></p><p>一方で、VM が “停止済み (割り当て解除)” の場合はメトリックが記録されず、破線となっていることがわかります。<br><img src="/blog/AzureMonitorEssential/UnableToDetectNullMetric/image02.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>メトリック エクスプローラーの使い方は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics">弊社公開情報</a> をご参照ください。また、エクスプローラー上で確認した際に値が 0 と表示されていても、アラート ルールの評価時には NULL と認識されるメトリックもございます。メトリックが NULL と判定されたことにより評価がスキップされていると推測される場合には、一度対象のメトリックを意図的に記録いただき、アラートが検知するかどうかをご確認いただきますようお願いいたします。</p></div><br><h2 id="3-メトリックが-NULL-の場合は評価がスキップされる"><a href="#3-メトリックが-NULL-の場合は評価がスキップされる" class="headerlink" title="3. メトリックが NULL の場合は評価がスキップされる"></a>3. メトリックが NULL の場合は評価がスキップされる</h2><p>冒頭でもお伝えしたとおり、メトリック アラート ルールは、評価期間の間、メトリックがずっと NULL の場合は評価をスキップします。以下に例を示します。</p><p><strong>例 1.</strong><br>00:00  NULL<br>00:01  NULL<br>00:02  NULL<br>00:03  NULL<br>00:04  NULL</p><p>例えば、上記のようにメトリックが出力されていない状況だったとします。<br>この状態で、アラート ルールが 00:00 ~ 00:04 のメトリックを対象に評価したとします。<br>このとき、対象の期間メトリックはずっと NULL のため、アラート ルールはこの評価をスキップします。このため、アラートを検知することはありません。</p><p><strong>例 2.</strong><br>00:00  NULL<br>00:01  1<br>00:02  NULL<br>00:03  0<br>00:04  NULL</p><p>例えば、00:01 と 00:03 にメトリックが記録され、それ以外は NULL だったとします。<br>この状態で、アラート ルールが 00:00 ~ 00:04 のメトリックを対象に評価した場合は、00:01 と 00:03 の値をもとに評価が実行されますので、アラート ルールの評価はスキップされません。</p><br><h2 id="4-まとめ"><a href="#4-まとめ" class="headerlink" title="4. まとめ"></a>4. まとめ</h2><p>メトリック アラート ルールにてテストを実施された際には、メトリックが出力されているかどうかをご確認ください。<br>もし期待どおりメトリックが出力されていなかった場合は、メトリックが出力されるように一度意図的に Azure リソースを操作ください。メトリックの出力条件について詳細を知りたい場合は、お手数ですが対象の Azure サービス観点でメトリックに関するお問合せをご起票ください。お問合せいただく際には、「なぜメトリックの出力条件が知りたいのか?」について背景をご共有いただくとスムーズなコミュニケーションが期待出来ます。</p><p><strong>&lt;お問い合わせ文の例&gt;</strong><br>Azure VM の可用性メトリックを監視するメトリック アラート ルールの動作検証を実施したい。<br>メトリック値が 1 になる条件は分かるが 0 になる条件が分からず、メトリック アラート ルールの動作検証のために可用性メトリックが 0 となる条件について知りたいです。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回はメトリックがない (NULL) 場合のメトリック アラート ルールの動作について説明します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="MetricAlert" scheme="https://jpazmon-integ.github.io/blog/tags/MetricAlert/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのコスト増加の原因を分析しコスト削減を検討する</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToManageLogAnalyticsBilling/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToManageLogAnalyticsBilling/</id>
    <published>2024-09-17T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.553Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、Log Analytics ワークスペースのコストの管理方法 (コスト増加原因の調査、コストを抑える方法) についてご説明します。  </p><p>なお、Azure Monitor のコスト最適化、および Log Analytics ワークスペースの使用量の分析については、以下弊社サイトもご参照ください。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost">https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost</a><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li><li><a href="#1-%E3%82%B3%E3%82%B9%E3%83%88%E5%A2%97%E5%8A%A0%E3%81%AE%E5%8E%9F%E5%9B%A0%E3%82%92%E5%88%86%E6%9E%90%E3%81%99%E3%82%8B">1. コスト増加の原因を分析する</a></li><li><a href="#1-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1. データのインジェスト量の推移を確認する</a><ul><li><a href="#1-1-1-%E4%BD%BF%E7%94%A8%E9%87%8F%E3%81%A8%E6%8E%A8%E5%AE%9A%E3%82%B3%E3%82%B9%E3%83%88-%E3%81%8B%E3%82%89%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1-1. [使用量と推定コスト] から確認する</a></li><li><a href="#1-1-2-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1-2. クエリを実行して確認する</a></li></ul></li><li><a href="#1-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-2. データの保有量の推移を確認する</a></li><li><a href="#1-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3. データの保有期間を確認する</a><ul><li><a href="#1-3-1-Azure-portal-%E3%81%8B%E3%82%89%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3-1. Azure portal から確認する</a></li><li><a href="#1-3-2-PowerShell-%E3%81%BE%E3%81%9F%E3%81%AF-Azure-CLI-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3-2. PowerShell または Azure CLI を使用して確認する</a></li><li><a href="#1-3-3-API-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3-3. API を使用して確認する</a></li></ul></li><li><a href="#2-%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">2. コストを抑える</a></li><li><a href="#2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">2-1. データのインジェストにかかるコストを抑える</a><ul><li><a href="#2-1-1-%E4%B8%8D%E8%A6%81%E3%81%AA%E3%83%AD%E3%82%B0%E3%81%AE%E5%8F%8E%E9%9B%86%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B">2-1-1. 不要なログの収集を停止する</a></li><li><a href="#2-1-2-%E6%97%A5%E6%AC%A1%E4%B8%8A%E9%99%90%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%82%92%E4%B8%80%E5%AE%9A%E9%87%8F%E3%81%BE%E3%81%A7%E3%81%AB%E6%8A%91%E3%81%88%E3%82%8B">2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える</a></li></ul></li><li><a href="#2-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%8C%81%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">2-2. データの保持にかかるコストを抑える</a><ul><li><a href="#2-2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">2-2-1. データの保有期間を調整する</a></li><li><a href="#2-2-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E9%87%8F%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">2-2-2. データの保有量を調整する</a></li></ul></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Log Analytics ワークスペースは、データの収集と分析において非常に強力なツールです。<br>しかし、そのコストは収集するデータの量によって大きく変動します。<br>本ブログでは、Log Analyticsワークスペースのコスト管理方法について詳しく解説します。<br>データインジェストのコストを最適化し、予期しない請求を避けるためのベストプラクティスを紹介します。</p><h2 id="1-コスト増加の原因を分析する"><a href="#1-コスト増加の原因を分析する" class="headerlink" title="1. コスト増加の原因を分析する"></a>1. コスト増加の原因を分析する</h2><p>Log Analytics ワークスペースのコストが増加している場合、まずはじめに行うことはコスト増加の原因を分析することです。<br>Log Analytics ワークスペースのコストは主に以下 3 点によって決まります。</p><ul><li>データのインジェスト量</li><li>データの保有量と保有期間  </li><li>Log Analytics ワークスペースが存在するリージョン  </li></ul><p>このうち、コスト増加の原因となりうるのは、データのインジェスト量およびデータの保有量と保有期間です。<br>したがって、コスト増加の主な原因を分析するためには、以下の情報を得る必要があります。</p><ul><li>データのインジェスト量の推移</li><li>データの保有量の推移</li><li>データの保有期間</li></ul><p>それぞれの確認方法について、ご説明します。</p><h3 id="1-1-データのインジェスト量の推移を確認する"><a href="#1-1-データのインジェスト量の推移を確認する" class="headerlink" title="1-1. データのインジェスト量の推移を確認する"></a>1-1. データのインジェスト量の推移を確認する</h3><p>Log Analytics ワークスペースごとのデータのインジェスト量の推移を確認する方法は、主に以下 2 つです。</p><ul><li>[使用量と推定コスト] から確認する方法</li><li>クエリを実行して確認する方法</li></ul><h4 id="1-1-1-使用量と推定コスト-から確認する"><a href="#1-1-1-使用量と推定コスト-から確認する" class="headerlink" title="1-1-1. [使用量と推定コスト] から確認する"></a>1-1-1. [使用量と推定コスト] から確認する</h4><ul><li>Azure portal で、コストを確認したい Log Analytics ワークスペースを開きます。</li><li>左ペインの [設定] &gt; [使用量と推定コスト] を押下します。</li><li>ページ右側に “使用状況のグラフ” として、過去 31 日間の、課金対象のテーブルごとのデータ インジェスト量が表示されます。  </li></ul><p><img src="/blog/LogAnalytics/HowToManageLogAnalyticsBilling/portal-ingest-barchart.png"></p><h4 id="1-1-2-クエリを実行して確認する"><a href="#1-1-2-クエリを実行して確認する" class="headerlink" title="1-1-2. クエリを実行して確認する"></a>1-1-2. クエリを実行して確認する</h4><ol><li>Azure portal で、コストを確認したい Log Analytics ワークスペースを開きます。</li><li>左ペインの [ログ] を押下し、以下いずれかのクエリを実行します。</li></ol><p>(過去 31 日間のログのインジェスト量を日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let days = 31d;</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= startofday(ago(days))</span><br><span class="line">| where StartTime &gt;= startofday(ago(days)) and EndTime &lt; startofday(now())</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| make-series TotalIngestedData = sum(Quantity) / 1.0E3 default=0 on TimeGenerated from startofday(ago(days)) to startofday(now()) step 1d by DataType</span><br><span class="line">| project TimeGenerated, DataType, TotalIngestedData</span><br><span class="line">| render columnchart </span><br></pre></td></tr></table></figure><p>(過去 3 か月のログのインジェスト量を、31 日ごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let days = 93d;</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= startofday(ago(days))</span><br><span class="line">| where StartTime &gt;= startofday(ago(days))</span><br><span class="line">| where IsBillable</span><br><span class="line">| summarize IngestedGB=sum(Quantity) / 1.0E3 by DataType, bin(StartTime, 31d)</span><br><span class="line">| project StartTime, DataType, IngestedGB</span><br><span class="line">| render columnchart</span><br></pre></td></tr></table></figure><p>(指定した期間のログのインジェスト量を、日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">let StartDate = datetime(YYYY-MM-DD);</span><br><span class="line">let EndDate = datetime(YYYY-MM-DD);</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= StartDate and TimeGenerated &lt; EndDate</span><br><span class="line">| where StartTime &gt;= StartDate and EndTime &lt; EndDate</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| make-series TotalIngestedData = sum(Quantity) / 1.0E3 default=0 on TimeGenerated from StartDate to EndDate step 1d by DataType</span><br><span class="line">| project TimeGenerated, DataType, TotalIngestedData</span><br><span class="line">| render columnchart </span><br></pre></td></tr></table></figure><p>(指定した期間のログのインジェスト量を、月ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">let StartDate = datetime(YYYY-MM-DD);</span><br><span class="line">let EndDate = datetime(YYYY-MM-DD);</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= StartDate and TimeGenerated &lt; EndDate</span><br><span class="line">| where StartTime &gt;= StartDate and EndTime &lt; EndDate</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| make-series TotalIngestedData = sum(Quantity) / 1.0E3 default=0 on TimeGenerated from StartDate to EndDate step 31d by DataType</span><br><span class="line">| project TimeGenerated, DataType, TotalIngestedData</span><br><span class="line">| render columnchart </span><br></pre></td></tr></table></figure><ol start="3"><li>結果を確認します。特に以下の項目について確認します。</li></ol><ul><li>特定のテーブルへのログのインジェスト量が多い場合 → <a href="#2-1-1-%E4%B8%8D%E8%A6%81%E3%81%AA%E3%83%AD%E3%82%B0%E3%81%AE%E5%8F%8E%E9%9B%86%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B">2-1-1. 不要なログの収集を停止する</a> をご確認ください。</li><li>ログのインジェスト量が上昇していた場合 → <a href="#2-1-2-%E6%97%A5%E6%AC%A1%E4%B8%8A%E9%99%90%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%82%92%E4%B8%80%E5%AE%9A%E9%87%8F%E3%81%BE%E3%81%A7%E3%81%AB%E6%8A%91%E3%81%88%E3%82%8B">2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える</a> をご確認ください。</li></ul><h3 id="1-2-データの保有量の推移を確認する"><a href="#1-2-データの保有量の推移を確認する" class="headerlink" title="1-2. データの保有量の推移を確認する"></a>1-2. データの保有量の推移を確認する</h3><p>以下では、データのインジェスト量を累積し、データの保有量の推移を可視化するためのクエリをご紹介します。<br>インジェスト量が増加傾向にあるわけではないものの、コストの増加が見られる場合は、保有量が増加している可能性が高いです。 </p><ol><li>Azure portal で、コストを確認したい Log Analytics ワークスペースを開きます。</li><li>左ペインの [ログ] を押下し、以下いずれかのクエリを実行します。</li></ol><p>(過去 31 日間のデータの保有量の推移を日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= startofday(ago(31d))</span><br><span class="line">| where IsBillable</span><br><span class="line">| summarize DailyIngestedGB=sum(Quantity) / 1.0E3 by DataType, bin(TimeGenerated, 1d)</span><br><span class="line">| sort by TimeGenerated asc</span><br><span class="line">| extend CumulativeIngestedGB = row_cumsum(DailyIngestedGB)</span><br><span class="line">| project TimeGenerated, DataType, CumulativeIngestedGB</span><br><span class="line">| render timechart</span><br></pre></td></tr></table></figure><p>(指定した期間のデータの保有量の推移を日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let StartDate = datetime(YYYY-MM-DD);</span><br><span class="line">let EndDate = datetime(YYYY-MM-DD);</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= StartDate and TimeGenerated &lt; EndDate</span><br><span class="line">| where StartTime &gt;= StartDate and EndTime &lt; EndDate</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| summarize DailyIngestedGB=sum(Quantity) / 1.0E3 by DataType, bin(TimeGenerated, 1d)</span><br><span class="line">| sort by TimeGenerated asc</span><br><span class="line">| extend CumulativeIngestedGB = row_cumsum(DailyIngestedGB)</span><br><span class="line">| project TimeGenerated, DataType, CumulativeIngestedGB</span><br><span class="line">| render timechart</span><br></pre></td></tr></table></figure><ol start="3"><li>結果を確認します。</li></ol><ul><li>インジェスト量が増加してるわけではないものの、保有量が増加傾向にある場合 → まずは後述の<a href="#1-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3. データの保有期間を確認する</a>で、各テーブルの保有期間を確認します。</li></ul><h3 id="1-3-データの保有期間を確認する"><a href="#1-3-データの保有期間を確認する" class="headerlink" title="1-3. データの保有期間を確認する"></a>1-3. データの保有期間を確認する</h3><p>データの保持期間は、テーブルごとに設定することが可能です。</p><ul><li><a href="#1-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1. データのインジェスト量の推移を確認する</a>で他に比べてインジェスト量が多いテーブルは、保有されるログ量も多いため、保有期間の長さがコスト増加に寄与する可能性があります。</li><li><a href="#1-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1. データのインジェスト量の推移を確認する</a>で増加傾向にあったテーブルの保有期間を見直すことで、将来的なコスト増加を抑制できる可能性があります。</li></ul><p>各テーブルの保持設定は、Azure portal, API, CLI, PowerShell を使用して確認することができます。</p><h4 id="1-3-1-Azure-portal-から確認する"><a href="#1-3-1-Azure-portal-から確認する" class="headerlink" title="1-3-1. Azure portal から確認する"></a>1-3-1. Azure portal から確認する</h4><ol><li>Azure portal で任意の Log Analytics ワークスペースを開きます。</li><li>左ペインの [設定] &gt; [テーブル] を押下します。</li><li>Log Analytics ワークスペース内に存在するテーブルの一覧が表示されます。<br>“対話型の保持” と “保有期間の合計” 列から保持期間の設定を確認することが可能です。<br>(長期保持期間は “保有期間の合計” から “対話型の保持” を差し引いた値です。)</li></ol><p>特定のテーブルについてのみ確認する場合は、以下の方法でも可能です。</p><h4 id="1-3-2-PowerShell-または-Azure-CLI-を使用して確認する"><a href="#1-3-2-PowerShell-または-Azure-CLI-を使用して確認する" class="headerlink" title="1-3-2. PowerShell または Azure CLI を使用して確認する"></a>1-3-2. PowerShell または Azure CLI を使用して確認する</h4><ol><li><p>PowerShell を開きます。</p></li><li><p>以下いずれかのコマンドを実行します。<br>この際、&lt;&gt; の箇所は任意の値に変更します (“&lt;&gt;” は不要です)。<br>■ PowerShell の場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AzOperationalInsightsTable -ResourceGroupName &lt;リソース グループ名&gt; -WorkspaceName &lt;ワークスペース名&gt; -tableName &lt;テーブル名&gt;</span><br></pre></td></tr></table></figure><p>■ Azure CLI の場合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az monitor log-analytics workspace table show --resource-group &lt;リソース グループ名&gt; --workspace-name &lt;ワークスペース名&gt; --name &lt;テーブル名&gt;</span><br></pre></td></tr></table></figure></li><li><p>結果を確認します。<br>返ってきた結果のうち、<code>RetentionInDays</code> が対話型の保有期間を、<code>TotalRetentionInDays</code> が保有期間の合計を示します。<br>(Azure CLI の場合はそれぞれ <code>retentionInDays</code>, <code>totalRetentionInDays</code> です。)<br>保有期間が長く、再設定が必要なテーブルが見つかった場合 → <a href="#1-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3. データの保有期間を確認する</a>をご確認ください。</p></li></ol><h4 id="1-3-3-API-を使用して確認する"><a href="#1-3-3-API-を使用して確認する" class="headerlink" title="1-3-3. API を使用して確認する"></a>1-3-3. API を使用して確認する</h4><p>以下の Get API を呼び出すことでも、上記と同様に、指定したテーブルの情報を取得することができます。<br>なお、{} の箇所は任意の値に変更してください (“{}” は不要です)。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &quot;https://management.azure.com/subscriptions/&#123;サブスクリプション ID&#125;/resourceGroups/&#123;リソース グループ名&#125;/providers/Microsoft.OperationalInsights/workspaces/&#123;ワークスペース名&#125;/Tables/&#123;テーブル名&#125;?api-version=2022-10-01&quot;</span><br></pre></td></tr></table></figure><p>なお、保有期間については、以下弊社サイトでもご案内しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-configure?tabs=portal-3,portal-1,portal-2">Log Analytics ワークスペース内のデータ保持を管理する</a></p><h2 id="2-コストを抑える"><a href="#2-コストを抑える" class="headerlink" title="2. コストを抑える"></a>2. コストを抑える</h2><p><a href="#1-%E3%82%B3%E3%82%B9%E3%83%88%E5%A2%97%E5%8A%A0%E3%81%AE%E5%8E%9F%E5%9B%A0%E3%82%92%E5%88%86%E6%9E%90%E3%81%99%E3%82%8B">1. コスト増加の原因を分析する</a>により、コスト増加の原因が明らかになった場合は、その原因に応じて、コストを抑えるための対処法を実行します。</p><h3 id="2-1-データのインジェストにかかるコストを抑える"><a href="#2-1-データのインジェストにかかるコストを抑える" class="headerlink" title="2-1. データのインジェストにかかるコストを抑える"></a>2-1. データのインジェストにかかるコストを抑える</h3><p>データのインジェストにかかるコストは、データのインジェスト量によって決まります。<br>そのため、データのインジェストにかかるコストを抑えるためには、インジェスト量を減らす必要があります。</p><h4 id="2-1-1-不要なログの収集を停止する"><a href="#2-1-1-不要なログの収集を停止する" class="headerlink" title="2-1-1. 不要なログの収集を停止する"></a>2-1-1. 不要なログの収集を停止する</h4><p>インジェスト量を減らすためにまずはじめに検討できることは、不要なログの収集を停止することです。  </p><p>以下は、不要なログの収集を停止する主な例です。  </p><p>■ <strong>データ収集ルールをカスタマイズして不要なデータの収集を減らす</strong><br>Azure Monitor エージェントとデータ収集ルールを用いたデータ収集を行っている場合、以下のログについては設定を変えることで、収集・監視が必要なログのみを Log Analytics ワークスペース内に収集することができます。</p><ul><li>パフォーマンス カウンター</li><li>Windows イベント ログ</li><li>Linux Syslog</li></ul><p>ログ収集設定をカスタマイズする方法については、以下弊社サイト、およびサポート チームのブログをご参照ください。</p><p><strong>パフォーマンス カウンター</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance#configure-performance-counters-data-source">パフォーマンス カウンター データ ソースを構成する</a></li><li><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/">既定で用意されているもの以外のパフォーマンス カウンターを収集する方法</a></li></ul><p><strong>Windows イベント ログ</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events#configure-windows-event-data-source">Windows イベント データ ソースを構成する</a></li><li><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomEventlog/">既定で用意されているもの以外のイベント ログを収集する方法</a></li></ul><p><strong>Linux Syslog</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-syslog#configure-collection-of-syslog-data">Syslog データの収集を構成する</a><br><img src="/blog/LogAnalytics/HowToManageLogAnalyticsBilling/docs-syslog.png"></li></ul><p>■ <strong>Application Insights のサンプリング機能を用いて収集ログを減らす</strong></p><p>Application Insights では、サンプリング機能が実装されております。<br>このサンプリング機能では、アプリケーションから出力されるテレメトリ データの出力量を抑えることが出来ます。<br>サンプリングを使用することで、APM に必要なデータをコストの観点で効率的に収集出来ます。<br>もし Application Insights に紐づくデータのコストを抑えたい要望がある場合は、一度サンプリング機能をご検討ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/sampling-classic-api">Sampling in Application Insights</a></li></ul><p>■ <strong>Container Insights の収集設定をカスタマイズして不要なデータの収集を減らす</strong><br>Container Insights を有効化していただくことで、AKS や Azure Arc enabled k8s から、コンテナに関するログやパフォーマンス情報を、Log Analytics ワークスペースに収集することが可能です。<br>一方で Container Insights のログ収集設定によっては収集されるログが増え、コスト増加に繋がります。<br>もし不要な Container Insights に関連するログが存在する場合は、Container Insights のログ収集設定の見直しをご検討ください。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-data-collection-configure?tabs=portal">Configure log collection in Container insights</a></li></ul><h4 id="2-1-2-日次上限を設定しデータのインジェスト量を一定量までに抑える"><a href="#2-1-2-日次上限を設定しデータのインジェスト量を一定量までに抑える" class="headerlink" title="2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える"></a>2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える</h4><p>Log Analytics ワークスペースに日次上限とは、1 日あたりのデータのインジェスト量の上限値を指します。<br>一時的なインジェスト量の上昇がみられた場合、日次上限を設定することで予期しないインジェスト量の増加を防ぐことができます。  </p><p>1 日のデータのインジェスト量が日次上限に達すると、その日の残りの時間は、課金対象のデータの収集が自動的に停止します (*1)。</p><p><strong>重要</strong><br>(*1) データ収集が停止すると、以下の影響が起こりうることをご確認の上、日次上限を設定してください。  </p><ul><li>リソースの正常性の状態を観察したり、アラートを受信したりする機能に影響が出る可能性  </li><li>ワークスペースで利用できる最新のデータに機能が依存している他の Azure サービスやソリューションに影響を与える可能性  </li></ul><p>日次上限については、以下弊社サイトでもご案内しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap">Log Analytics ワークスペースの日次上限を設定する</a>  </p><h3 id="2-2-データの保持にかかるコストを抑える"><a href="#2-2-データの保持にかかるコストを抑える" class="headerlink" title="2-2. データの保持にかかるコストを抑える"></a>2-2. データの保持にかかるコストを抑える</h3><p>データの保持に対してかかるコストは、保有期間と保持するデータ量に基づいて決定します。<br>保持するデータ量は、データのインジェスト量とその保有期間によって決まるため、データ保持にかかるコストを抑えるためには、まずは前述の<a href="#2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">データのインジェスト量の見直し</a>と、以下でご案内する、<a href="#2-2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">保有期間の調整</a>が有効です。</p><h4 id="2-2-1-データの保有期間を調整する"><a href="#2-2-1-データの保有期間を調整する" class="headerlink" title="2-2-1. データの保有期間を調整する"></a>2-2-1. データの保有期間を調整する</h4><p>Log Analytics ワークスペース内のデータは、対話型保持と長期保持のいずれかの状態で保持されます。</p><ul><li>対話型保持 : この状態では、データは監視、トラブルシューティング、ほぼリアルタイムの分析に利用できます。各種データには無料の対話型保持期間が設けられています (*2)。</li><li>長期保持 (アーカイブ) : 対話型保持よりも低コストでデータを保持できます。ただし、データに対するアクセス方法に、制限があります (*3)。</li></ul><p>そして、各テーブルに対して、対話型保持と長期保持の期間を設定することができ、対話型保持期間が終了したデータは、長期保持されます (対話型保持期間と長期保持期間の合計は最大 12 年に設定可能です)。</p><p>テーブル プランによって、設定できる最大の対話型保持期間が異なります。<br>分析プランでは、テーブルの対話型保持期間を最大 2 年間まで延長できます。<br>基本プランと補助プランの対話型保持期間は 30 日間に固定されています。  </p><p><strong>インフォメーション</strong><br>(*2) 各種データには、無料の対話型保持期間が設けられています。<br>この無料期間を超えて Log Analytics ワークスペース内にデータを保有するためには、費用がかかります。<br><img src="/blog/LogAnalytics/HowToManageLogAnalyticsBilling/dataretention-cost.png">  </p><p><strong>重要</strong><br>(*3) 以下のことは、対話型保持されているデータに対してのみ実行でき、長期保持されているデータに対しては実行できません。  </p><ul><li>クエリを通したデータ取得  </li><li>テーブル プランに基づいた視覚化、アラート、およびその他の機能やサービスでのデータ利用  </li><li>長期保持されているデータに対してアクセスするためには、検索ジョブの実行、またはログの復元が必要です。<br>検索ジョブの実行、またはログの復元には別途費用がかかります。  <ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/search-jobs?tabs=portal-1,portal-2">Azure Monitor で検索ジョブを実行する</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/restore?tabs=api-1">Azure Monitor でログを復元する</a></li><li>それぞれにかかる費用は、<a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor の価格</a>の “ジョブの検索”、”復元” の項目をご確認ください。  </li></ul></li></ul><h4 id="2-2-2-データの保有量を調整する"><a href="#2-2-2-データの保有量を調整する" class="headerlink" title="2-2-2. データの保有量を調整する"></a>2-2-2. データの保有量を調整する</h4><p>データの保有量を削減するためにできるもう一つの方法は、現在保有しているワークスペース内のデータをストレージ アカウントにエクスポートし、ワークスペース内のデータの保持期間を短くすることです。</p><p>ストレージ アカウントの価格 (*4) は、<a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Log Analytics ワークスペースの保有料金</a>よりも低価格なため、収集したデータに対して対話型クエリを実行する予定がない場合は、ストレージ アカウントにデータをエクスポート (移動) し、ワークスペース内のデータを短くすることで、コストを抑えられます。 </p><p>以下に、ストレージ アカウントまたは Event Hubs にログを送信する 2 つの方法をご紹介します。</p><p>■ <strong>データ エクスポート ルールを利用してエクスポートする</strong></p><ul><li>選択したテーブルごとに、データをストレージ アカウント、または Event Hubs にエクスポート・保存できます。</li><li>ストレージ アカウント、または Event Hubs にエクスポート・保存されるデータは、Log Analytics ワークスペースにも収集されます。<br>そのため、コストを抑えたい場合は、テーブルの保有期間を無料期間の範囲に収めるなど、保有期間を短くする必要があります。</li><li>より詳細な情報は、以下弊社サイトをご参照ください。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal">Azure Monitor の Log Analytics ワークスペース データ エクスポート</a></li></ul><p>■ <strong>データ収集ルールを構成して直接アップロードする (プレビュー)</strong></p><ul><li>データ収集ルールを構成することで、Azure Monitor エージェントを使用して収集したデータを、直接ストレージ アカウント、または Event Hubs へアップロードすることができます。  </li><li>この方法では、Log Analytics ワークスペースにはデータが収集されません。</li><li>本機能がサポートされているデータ型には制限がございます (2024 年 9 月時点)。詳細は、以下弊社サイトをご確認ください。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-send-data-to-event-hubs-and-storage?tabs=windows,windows-1#whats-supported">サポートされている機能</a></li><li>本機能は 2024 年 9 月時点では、パブリック プレビュー段階です。仕様が余儀なく変更される可能性があるため、使用の際はこちらの点にご留意ください。</li></ul><p>(*4) ストレージ アカウントの価格は以下サイトからご確認ください。<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/blobs/">Azure Blob Storage の価格</a></p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事では、Log Analytics ワークスペースのコストを分析し、それぞれのコスト増加原因に対する対処法をご紹介しました。<br>まずはデータのインジェスト量、保有量、および保有期間の設定を確認し、どこにコストがかかっているかを特定し、適切な対処法を取ることが、コストの削減およびコスト増加の抑制につながります。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Log Analytics ワークスペースのコストの管理方法 (コスト増加原因の調査、コストを抑える方法) についてご説明します。  &lt;/p&gt;
&lt;p&gt;なお、Azure Monitor のコスト最適化、および Log Analytics ワークスペースの使用量の分析については、以下弊社サイトもご参照ください。&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>マシンが起動中にも関わらず Heartbeat ログ アラートが発報された場合の調査方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/Unexpected_Heartbeat_logalert/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/Unexpected_Heartbeat_logalert/</id>
    <published>2024-09-05T01:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.652Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの佐藤です！<br><br>今回は、Heartbeat ログ アラート ルールが発報したが、マシンは稼働しているという状況、<br>特に Heartbeat ログの遅延により期待しないアラートが発報した場合の調査方法についてご紹介いたします。<br></p><span id="more"></span><ol><li>マシンが稼働しているにもかかわらず Heartbeat ログ アラート ルールが発報するシナリオ</li><li>Heartbeat ログの収集状況を確認する方法</li><li>Heartbeat ログの遅延が確認されたら</li></ol><h1 id="1-マシンが稼働しているにもかかわらず-Heartbeat-ログ-アラート-ルールが発報するシナリオ"><a href="#1-マシンが稼働しているにもかかわらず-Heartbeat-ログ-アラート-ルールが発報するシナリオ" class="headerlink" title="1. マシンが稼働しているにもかかわらず Heartbeat ログ アラート ルールが発報するシナリオ"></a>1. マシンが稼働しているにもかかわらず Heartbeat ログ アラート ルールが発報するシナリオ</h1><p>マシンが稼働しているにもかかわらず Heartbeat ログ アラート が発報する原因として、<br>主に以下がございます。<br><br>主な要因 1 : Heartbeat ログの欠損<br><br>-&gt; 何らかの原因によりマシンから Heartbeat ログが届かなくなり、それによりアラートの発報条件を満たし発報する。<br></p><p>主な要因 2 : Heartbeat ログの遅延<br><br>-&gt; Heartbeat ログの収集に遅延発生したことで、アラートの発報条件を満たし発報する。<br></p><p>主な要因 3 : サービスに問題が発生している状況<br></p><p>今回はこのなかでも、主な要因 2 (遅延) にスポットライトを当ててみます。<br></p><h1 id="2-Heartbeat-ログの収集遅延状況を確認する方法"><a href="#2-Heartbeat-ログの収集遅延状況を確認する方法" class="headerlink" title="2. Heartbeat ログの収集遅延状況を確認する方法"></a>2. Heartbeat ログの収集遅延状況を確認する方法</h1><p>以下のクエリにより、まず Heartbeat ログの遅延状況をご確認いただくことが可能です。<br><br>(※ たとえば、ログが 30 分遅延して収集されてしまった環境の場合、10:30 に収集されるべきログが Log Analytics ワークスペースに到着するのは 11:00 でございます。<br><br>    10:30 ~ 11:00 の間に 10:30 に収集されたログを確認した場合、クエリに該当するレコードがない旨表示されることにご留意ください。)<br></p><p>Log Analytics ワークスペースの各テーブルに存在する以下の 3 列を使用して、収集遅延状況を確認することが可能です。<br><br>各列の名称およびどのような値を格納しているかについては以下の通りでございます。​<br><br>(列名 : どのような値を格納しているか の順で記載いたします。)<br></p><p>TimeGenerated 列 : エージェントでデータを検知した時刻<br><br>_TimeReceived 列 : データが Azure に届いた時刻<br><br>ingestion_time() 列 : Log Analytics ワークスペースに取り込まれ、クエリが可能になった時刻<br></p><p>// 参考情報<br></p><ul><li>インジェスト時間のチェック<br><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time#check-ingestion-time">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time#check-ingestion-time</a><br></li></ul><p>Heartbeat<br><br>| where _ResourceId contains “&lt;仮想マシン名&gt;” //&lt;仮想マシン名&gt; は、遅延状況を確認したいログの収集元マシン名に置き換えます<br><br>| order by TimeGenerated asc​<br><br>| extend E2EIngestionLatency = ingestion_time() - TimeGenerated​ // ①<br><br>| extend AgentLatency = _TimeReceived - TimeGenerated​ // ②<br><br>| project TimeGenerated, Computer, E2EIngestionLatency, AgentLatency, _TimeReceived, ingestion_time(), Category​<br><br>| order by E2EIngestionLatency<br><br><br><br>① : エージェントがデータを検知してから、データがクエリ可能になるまでの所要時間を計算します<br><br>② : エージェントがデータを検知してから、Azure に届くまでの所要時間を計算します<br><br><br><br>上述のクエリを実行いただくことで、① として計算した値が大きい順に以下の表なテーブル形式でデータが出力されます。</p><p>エージェントがデータを検知してからログがクエリ可能な状態に処理されるまで、おおよそ 3 分ほどの時間を要します。<br><br>E2EIngestionLatency 列の値をご確認いただき、遅延の有無をご確認ください。<br></p><p><img src="/blog/LogAnalytics/Unexpected_Heartbeat_logalert/image001.png"><br>例えば、上述のハイライトの場合ですと、以下のようになっております。<br><br><br><br>E2EIngestionLatency : 18 分 8 秒<br><br>AgentLatency : 18 分 2 秒<br><br><br><br><br>この場合、AgentLatency が大きいために E2EIngestionLatency の値が大きくなっています。<br>すなわち、エージェントがデータを検知してから Azure に届くまでの過程で時間を要していることがわかります。</p><h1 id="3-Heartbeat-ログの遅延が確認されたら"><a href="#3-Heartbeat-ログの遅延が確認されたら" class="headerlink" title="3. Heartbeat ログの遅延が確認されたら"></a>3. Heartbeat ログの遅延が確認されたら</h1><p>2 に記載のクエリにより Heartbeat ログの遅延が確認された場合、以下 2 パターンの遅延の仕方がございます。<br><br>パターン 1 : E2EIngestionLatency が大きく、かつ AgentLatency も大きい<br><br>パターン 2 : E2EIngestionLatency が大きいが、 AgentLatency は小さい<br></p><p>遅延箇所により遅延の発生原因が異なります。<br><br>それぞれのパターンについて、以下に詳述します。<br></p><h2 id="パターン-1-E2EIngestionLatency-が大きく、かつ-AgentLatency-も大きい"><a href="#パターン-1-E2EIngestionLatency-が大きく、かつ-AgentLatency-も大きい" class="headerlink" title="パターン 1 : E2EIngestionLatency が大きく、かつ AgentLatency も大きい"></a>パターン 1 : E2EIngestionLatency が大きく、かつ AgentLatency も大きい</h2><p>この場合、エージェントがデータを検知してから Azure に届くまでに時間を要しています。<br><br>考えられる主な原因は以下の 2 つでございます。<br></p><ul><li>ご利用いただいているネットワークの問題<br></li><li>エージェントで発生している問題<br></li></ul><p>エージェントで問題が発生しているかどうかは、以下の手順でエージェントのログを取得いただくことでご確認いただけます。</p><h3 id="Windows-OS-の場合"><a href="#Windows-OS-の場合" class="headerlink" title="Windows OS の場合"></a>Windows OS の場合</h3><ol><li>問題が発生した Windows サーバーへ管理者権限にてログインします。<br></li><li>PowerShell ウインドウを管理者権限にて開きます。<br></li><li>以下のコマンドを実行します。<br><br>cd “C:\Packages\Plugins\Microsoft.Azure.Monitor.AzureMonitorWindowsAgent\1.X.X.X\Troubleshooter”<br><br>(X にはバージョン番号が入ります。環境に応じて変更下さい。)<br><br> .\AgentTroubleshooter.exe –ama -v<br></li><li>ログ採取が行われますのでそのまま待機します。<br></li><li>“C:\Packages\Plugins\Microsoft.Azure.Monitor.AzureMonitorWindowsAgent\1.X.X.X\Troubleshooter” フォルダ内 AgentTroubleshooterOutput.zip ファイルが作成されます。<br><br>こちらが Azure Monitor エージェントのログでございます。<br></li></ol><h3 id="Linux-OS-の場合"><a href="#Linux-OS-の場合" class="headerlink" title="Linux OS の場合"></a>Linux OS の場合</h3><p>対象の Linux OS 上で作業を実施してください。<br>以下のコマンドを任意のディレクトリ上で実行します。<br><br><br>$ mkdir ama_tst<br><br>$ cd ama_tst<br><br>$ wget <a href="https://github.com/Azure/azure-linux-extensions/raw/master/AzureMonitorAgent/ama_tst/ama_tst.tgz">https://github.com/Azure/azure-linux-extensions/raw/master/AzureMonitorAgent/ama_tst/ama_tst.tgz</a><br><br>$ tar -xzvf ama_tst.tgz<br><br>$ sudo sh ama_troubleshooter.sh<br><br>“Please select an option:” と表示されますので、”L” を入力し、エンターキーを押します。<br><br>“Output Directory:” と表示されますので、”.” を入力し、エンターキーを押します。<br><br><br><br>シェルが終了しますと、”amalogs” から始まるディレクトリ、またはファイルがカレントディレクトリに出力されます。<br><br>こちらが Azure Monitor エージェントのログでございます。<br><br><br></p><p>事象発生直後のほうが、ログに残存している情報が多いため、<br>弊社サポート窓口にお問い合わせいただく場合でも事象発生後なるべくお早めにログを取得いただくことをお勧めいたします。<br><br>ログ ファイルがディレクトリとなっている場合には、弊社にご提供いただきます際には圧縮いただきますようお願いいたします。<br></p><p>また、エージェントのバージョンが最新でない場合には、<br>過去のエージェント特有の不具合として事象が発生する可能性もございます。<br><br>エージェントは不具合の修正などを目的としたアップグレードが行われております。<br><br>そのため、エージェントは最新バージョンをご利用いただくことを合わせてご検討ください。<br></p><h2 id="パターン-2-E2EIngestionLatency-が大きいが、-AgentLatency-は小さい"><a href="#パターン-2-E2EIngestionLatency-が大きいが、-AgentLatency-は小さい" class="headerlink" title="パターン 2 : E2EIngestionLatency が大きいが、 AgentLatency は小さい"></a>パターン 2 : E2EIngestionLatency が大きいが、 AgentLatency は小さい</h2><p>この場合、AgentLatency が小さいことからエージェントがデータを検知してから Azure に届くまでの経路に問題はありません。<br><br>一方で、Azure に届いてからクエリ可能になるまでに時間を要しているため E2EIngestionLatency の値が大きくなっています。<br><br>この場合、Azure 内部の処理 (受信したデータをクエリ可能となるよう行う処理) に時間がかかっております。<br><br><br>なぜ Azure 内部の処理に時間がかかったか詳細な原因を調査されたい場合には、サポート リクエストを発行いただくことで調査が可能です。<br><br><br><br>Heartbeat 監視は、Log Analytics ワークスペースのデータ取り込み遅延によって期待どおり監視出来ない可能性がございます。<br><br>コンピューターの死活監視として、Heartbeat の監視以外にも様々な方法がございます。<br><br>下記の記事に死活監視に関する内容が記載しております。<br><br>こちらもあわせてご参考ください<br><br><br></p><ul><li>Azure VM における死活監視の考え方<br><br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/</a><br><br>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。最後までお読みいただきありがとうございました！</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの佐藤です！&lt;br&gt;&lt;br&gt;今回は、Heartbeat ログ アラート ルールが発報したが、マシンは稼働しているという状況、&lt;br&gt;特に Heartbeat ログの遅延により期待しないアラートが発報した場合の調査方法についてご紹介いたします。&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
  </entry>
  
  <entry>
    <title>可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラートについて</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/VMAvailability-MetricAlert/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/VMAvailability-MetricAlert/</id>
    <published>2024-08-29T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.653Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回は Azure VM のホストが出力するメトリック ‘VM Availability Metric (Preview)’ を利用したメトリック アラートの設定方法をご紹介します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%81%A8%E3%81%AF">2. 可用性メトリック ‘VM Availability Metric (Preview)’ とは</a></li><li><a href="#3-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%81%AE%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">3. 可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラート設定手順</a></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">Azure VM の死活監視にはいくつか方法があります</a>。<br>Azure Monitor エージェントによって収集される Heartbeat を利用した監視をご利用されている方が多いかと思いますが、<br>今回は可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラートの設定方法をご紹介します。</p><p>VM Availability Metric (Preview) （VM 可用性メトリック (プレビュー)）は Azure VM のホストが出力するメトリックであり、VM ホストを監視することができます。このメトリックを利用したメトリック アラートを構成することで、VM の可用性が低下していることを検知することができます。</p><br><h2 id="2-可用性メトリック-‘VM-Availability-Metric-Preview-’-とは"><a href="#2-可用性メトリック-‘VM-Availability-Metric-Preview-’-とは" class="headerlink" title="2. 可用性メトリック ‘VM Availability Metric (Preview)’ とは"></a>2. 可用性メトリック ‘VM Availability Metric (Preview)’ とは</h2><p>可用性メトリックは Azure VM のホストが出力するメトリックです。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/microsoft-compute-virtualmachines-metrics">ホスト メトリック</a>は仮想マシンを作成すると自動的に収集されます。このホスト メトリックの中で、VM の可用性を表すメトリックが「VM Availability Metric (Preview)」です。</p><p>このメトリックの値が 1 の場合は VM が実行中であり、利用可能であることを表します。<br>このメトリックの値が 0 の場合は VM を利用できない状態であることを意味します。<br>つまり、このメトリックの値が 1 を下回ったことを検知するアラートを作成いただくことで、VM ホストにおける可用性を監視することができます。</p><p>ご注意いただきたい点は、このメトリックでは <strong>Azure VM が “停止済み (割り当て解除) “ を検知することができない</strong>ことです。<br>VM が “停止済み (割り当て解除)” の場合は、メトリックの値が <a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/monitor-vm-reference#vm-availability-metric-preview">NULL</a> になります。<br>しかし、メトリック アラートではメトリックの値が <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#null-and-zero-values">NULL</a> であることを検知できませんので、予めご留意ください。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image01.png"></p><br><h2 id="3-可用性メトリック-‘VM-Availability-Metric-Preview-’-のメトリック-アラート設定手順"><a href="#3-可用性メトリック-‘VM-Availability-Metric-Preview-’-のメトリック-アラート設定手順" class="headerlink" title="3. 可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラート設定手順"></a>3. 可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラート設定手順</h2><p>それでは、可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラートを設定してみましょう！<br>本記事では 5 分おきにメトリックの値を確認し、過去 5 分以内に記録された可用性メトリックの平均値が 1 を下回った場合に発報するメトリック アラートを設定します。</p><br><p><strong>1). 監視対象の Azure VM のメトリック エクスプローラーを開きます。</strong><br>Azure portal にログインし、監視対象の Azure VM を開きます。<br>Azure VM のリソース メニュー [メトリック] を選択し、VM Availability Metric (Preview) のメトリックを表示します。<br>[メトリックの名前空間] で「仮想マシン ホスト」を選択し、[メトリック] で「VM Availability Metric (Preview)」を検索してください。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image02.png"></p><p>下図では [集計] で「平均」を選択していますが、これは指定した期間のメトリックを集計する方法を意味します。<br>例えば、以下の場合は [時間の範囲] で指定した過去 30 分以内に記録されたメトリックを、[時間の粒度] の 5 分間隔でキャプチャされたメトリック値の平均が表示されます。可用性メトリックでは、平均、最小値、最大値の集計方法がサポートされています。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image03.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>メトリック エクスプローラーの使い方は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics">弊社公開情報</a> をご参照ください。また、メトリックの集計の考え方につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#aggregation-types">こちら</a> の公開情報をご覧ください。</p></div><br><p><strong>2). メトリック アラートの発報条件を指定します。</strong><br>VM Availability Metric (Preview) のメトリックを表示できましたら、画面上部の [新しいアラート ルール] をクリックします。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image04.png"></p><p>この画面では、アラートの発報条件を指定します。メトリック アラートの評価に関わる主な項目は以下のとおりです。</p><ul><li>確認する間隔 : 評価を行う頻度</li><li>ルックバック期間 : 1 回の評価を行う際に評価の対象となる期間</li><li>集計の種類 : [ルックバック期間] で指定した期間のメトリックを集計する方法</li></ul><p><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image05.png"></p><p>[確認する間隔] は評価を行う頻度であり、「何分おきに評価を行うか」を表します。<br>[ルックバック期間] は「1 回の評価を行う際に評価の対象となる期間」を表します。<br>今回は 5 分おきに評価を行い、過去 5 分以内に記録された可用性メトリックの平均値が 1 を下回った場合に発報させたいので、以下の通り設定します。</p><ul><li>シグナル名 : VM Availability Metric (Preview) </li><li>しきい値 : Static</li><li>集計の種類 : 平均</li><li>演算子 : 次の値より小さい</li><li>単位 : カウント</li><li>しきい値 : 1</li><li>確認する間隔 : 5 分</li><li>ルックバック期間 : 5 分</li></ul><hr><p><strong>&lt;補足&gt; Azure VM のライブ マイグレーションによる可用性メトリックの影響について</strong><br>Azure VM のライブ マイグレーションの影響で、一時的に VM Availability Metric (Preview) の値が 1 ではなく 0 と出力される可能性がございます。この場合、直近 5 分間の VM Availability Metric (Preview) の平均値が 1 を下回り、Azure VM が稼働しているのにも関わらず期待しないアラートが発報する恐れがございます。もしライブ マイグレーションの影響によるメトリック アラートの発報を回避されたい場合は、アラート発報条件を見直していただくことをご検討ください。</p><ul><li><p>例 : 5 分間のうち、1 分間メトリック値が 0 だった場合を許容したい<br>シグナル名 : VM Availability Metric (Preview)<br>しきい値 : Static<br>集計の種類 : 平均<br>演算子 : 次の値より小さい<br>単位 : カウント<br>しきい値 : 0.8<br>確認する間隔 : 5 分<br>ルックバック期間 : 5 分</p></li><li><p>例 : 5 分間連続でメトリック値が 0 だった場合にアラートを発報したい<br>シグナル名 : VM Availability Metric (Preview)<br>しきい値 : Static<br>集計の種類 : 最大<br>演算子 : 次の値より小さい<br>単位 : カウント<br>しきい値 : 1<br>確認する間隔 : 5 分<br>ルックバック期間 : 5 分</p></li></ul><hr><div class="alert is-info"><p class="alert-title">Note</p><p>メトリック アラートの設定項目につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-metric-alert-rule">弊社公開情報</a>をご覧ください。</p></div><br><p><strong>3). アラートで通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image06.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image07.png"></p><p>また、[アクション] では、アクション グループがトリガーされた際に実行するアクションを選択できます (今回は設定しません)。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image08.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>アクション グループの概要や設定手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。</p></div><br><p><strong>4. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] では、アラート ルールの有効化や自動解決を設定します。</p><p><strong>[アラートを自動的に解決する] にチェックをいれた場合には、アラートの閾値を満たす度にアラートは発報しません。</strong><br>このようなアラートは “<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#alerts-and-state">ステートフルなアラート</a>“ と呼ばれ、アラートの閾値を満たしたときに一度発報し、アラートが解決したとみなされたときに、解決したことが通知されます。メトリック アラートの場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">3 回連続で閾値を満たさなかった場合に解決したとみなされます</a>。</p><p><strong>[アラートを自動的に解決する] にチェックをいれない場合は、アラートの閾値を満たす度にアラートが発報します。</strong> お客様のご要件に合わせてご設定ください。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image09.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>ステートフルなアラートの詳細につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>をご覧ください。</p></div><br><p><strong>5). 最後に設定した内容を確認し、[作成] をクリックします。</strong><br>手順は以上です。</p><p>アラートの履歴は、Azure portal にログインいただき、[モニター] &gt; [アラート] から確認いただけます。<br>以下の例では、アラートの評価時点から過去 5 分間の可用性メトリック ‘VM Availability Metric (Preview)’ の平均値が 1 を下回ったため、アラートが発報していることが分かります。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image10.png"></p><p>本記事の冒頭でもお伝えしておりますとおり、<strong>Azure VM の死活監視には複数の方法がございます</strong>。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">Azure VM における死活監視の考え方</a> のブログもご覧いただき、お客様のご要件に合った監視設定を構築いただけますと幸いです！<br>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回は Azure VM のホストが出力するメトリック ‘VM Availability Metric (Preview)’ を利用したメトリック アラートの設定方法をご紹介します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>既定で用意されているもの以外のイベント ログを収集する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomEventlog/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomEventlog/</id>
    <published>2024-08-18T17:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.483Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムの Windows イベント ログを収集する方法についてご説明します。  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li><li><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0-Windows-%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%AD%E3%82%B0%E3%81%AE%E5%8F%8E%E9%9B%86%E6%89%8B%E9%A0%86">カスタム Windows イベント ログの収集手順</a><ul><li><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99">事前準備</a></li><li><a href="#%E5%8F%8E%E9%9B%86%E3%81%97%E3%81%9F%E3%81%84%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%AD%E3%82%B0%E3%81%AE-XPath-%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B">収集したいイベント ログの XPath を取得する</a></li><li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">データ収集ルールを作成する</a></li><li><a href="#Windows-%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%AD%E3%82%B0%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">Windows イベント ログが収集されていることを確認する</a></li></ul></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Windows イベント ログは、データ収集ルール (DCR) のデータ ソースとして使用できるものの 1 つです。<br>Windows イベント ログの種類は多数存在し、Azure portal でデフォルトで用意されているものと、そうでないものがあります。<br>今回は、Azure portal でデフォルトで用意されていない Windows イベント ログ (以降、カスタム Windows イベント ログ) の収集設定方法についてご紹介します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events</a></p><h2 id="カスタム-Windows-イベント-ログの収集手順"><a href="#カスタム-Windows-イベント-ログの収集手順" class="headerlink" title="カスタム Windows イベント ログの収集手順"></a>カスタム Windows イベント ログの収集手順</h2><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>以下のリソースがご自身の環境にあることを確認してください。</p><ul><li>データ収集元となる Windows OS の仮想マシン (以下 VM)</li><li>データ収集先となる Log Analytics ワークスペース</li></ul><h3 id="収集したいイベント-ログの-XPath-を取得する"><a href="#収集したいイベント-ログの-XPath-を取得する" class="headerlink" title="収集したいイベント ログの XPath を取得する"></a>収集したいイベント ログの XPath を取得する</h3><p>任意のイベント ログをデータ収集ルールのデータ ソースとして指定し、収集設定したい場合、そのイベント ログの XPath が必要になります。<br>以下の手順に沿って任意のイベント ログの XPath を取得することができます。  </p><ol><li><p>VM のスタート画面で “イベント ビューアー” または “Event Viewer” を検索し、開きます。</p></li><li><p>左ペインで “Windows ログ” を押下し、配下の “Application”, “セキュリティ”, “Setup”, “システム”, “Forwarded Events” のいずれかを押下します。<br><img src="/blog/LogAnalytics/HowToCollectCustomEventlog/eventviewer_1.png"></p></li><li><p>右ペインで “現在のログをフィルター” を押下します。<br>以下のようなウィンドウが表示されるため、”フィルター” タブで以下 2 つのパラメーターを設定します。</p></li></ol><ul><li>イベント レベル</li><li>イベント ID<br>  <img src="/blog/LogAnalytics/HowToCollectCustomEventlog/eventviewer_filter.png">  </li></ul><ol start="4"><li><p>フィルターの設定ができたら、同ウィンドウの “XML” タブを開きます。<br>以下 2 点を手元にメモします。</p><ul><li><code>&lt;Select Path=&quot;2で選択したフォルダ&quot;&gt;</code> の <code>2で選択したフォルダ</code> – A</li><li><code>&lt;Select Path=&quot;2で選択したフォルダ&quot;&gt;</code> と <code>&lt;/Select&gt;</code> の間の <code>*[System[(Level=...) and (EventID=...)]]</code> の箇所 – B</li></ul><p> <img src="/blog/LogAnalytics/HowToCollectCustomEventlog/eventviewer_xml.png"></p></li></ol><p><strong>補足</strong><br>上記の方法で取得した XPath が有効であるかを確認したい場合、ローカルで確認することができます。<br>手順は以下の通りです。  </p><ol><li>Windows コンピュータで、PowerShell を開きます。  </li><li>以下のクエリを実行します。<br>この際、$XPath には、上記 4 で取得した B の値を設定してください。<br>また、$LogName には、上記 4 で取得した A の値を設定してください。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$XPath = &#x27;*[System[EventID=1035]]&#x27;   </span><br><span class="line">$LogName = &#x27;Application&#x27; </span><br><span class="line">Get-WinEvent -LogName $LogName -FilterXPath $XPath</span><br></pre></td></tr></table></figure></li><li>結果を確認します。ログの一覧が表示されれば、指定した XPath は有効であると判断できます。</li></ol><h3 id="データ収集ルールを作成する"><a href="#データ収集ルールを作成する" class="headerlink" title="データ収集ルールを作成する"></a>データ収集ルールを作成する</h3><ol><li><p>Azure potral にログインします。</p></li><li><p>“deta collection rules” を選択します。</p></li><li><p>[作成] を押下し、”基本” タブの各値を入力します。<br> 続いて “リソース” タブで収集元 VM を選択・追加します。</p></li><li><p>“収集と配信” タブで [データ ソースの追加] を押下します。<br> 右ペイン内 “データ ソース” タブの “データ ソースの種類” で “Windows イベント ログ” を選択します。  </p></li><li><p>[カスタム] を押下し、入力欄に <a href="#%E5%8F%8E%E9%9B%86%E3%81%97%E3%81%9F%E3%81%84%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%AD%E3%82%B0%E3%81%AE-xpath-%E3%81%AE%E5%8F%96%E5%BE%97">収集したいイベント ログの XPath の取得</a> にて取得した XPath の先頭に <code>&lt;4で取得した A の値&gt;!</code> (“&lt;&gt;” は不要です) を足したものを入力し、[追加] を押下します。<br> <img src="/blog/LogAnalytics/HowToCollectCustomEventlog/dcr_addDatasource.png"></p></li><li><p>[次へ : ターゲット &gt;] を押下し、[+ ターゲットの追加] を押下します。<br> “ターゲットの種類” で “Azure Monitor Logs” を選択し、収集先となる Log Analytics ワークスペースを選択し、”データ ソースの追加” を押下します。<br> <img src="/blog/LogAnalytics/HowToCollectCustomEventlog/dcr_addTarget.png"></p></li><li><p>[確認と作成] タブにて [作成] を押下し、完了です。</p></li></ol><h3 id="Windows-イベント-ログが収集されていることを確認する"><a href="#Windows-イベント-ログが収集されていることを確認する" class="headerlink" title="Windows イベント ログが収集されていることを確認する"></a>Windows イベント ログが収集されていることを確認する</h3><ol><li>Azure portal にログインします。</li><li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">データ収集ルールの作成</a> の 6 で選択した Log Analytics ワークスペースのページを開きます。</li><li>左ペインの [ログ] を押下し、以下のクエリを貼り付け、実行します。<br>なお、where から始まる行は、収集の有無を確認したい EventID およびイベントレベルに置き換えてください。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Event</span><br><span class="line">| where EventID == &lt;イベント ID&gt; </span><br><span class="line">| where EventLevelName == &quot;Information&quot; // 又は where EventLevel == &quot;4&quot;</span><br><span class="line">| sort by TimeGenerated</span><br></pre></td></tr></table></figure></li></ol><p>例 : EventID が 7036 または 7040 の Information レベルのログ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Event</span><br><span class="line">| where EventID == 7036 or EventID == 7040</span><br><span class="line">| where EventLevelName == &quot;Information&quot;</span><br><span class="line">| sort by TimeGenerated</span><br></pre></td></tr></table></figure><ol start="4"><li>以下画像のようにログが表示されれば、ログが収集できています。<br><img src="/blog/LogAnalytics/HowToCollectCustomEventlog/laws_eventlog.png"></li></ol><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本ブログではカスタム Windows イベント ログの収集設定方法についてご紹介しました。<br>データ収集ルールでは、収集したいイベント ログの XPath を指定することで、任意のログを収集することができます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムの Windows イベント ログを収集する方法についてご説明します。  &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>既定で用意されているもの以外のパフォーマンス カウンターを収集する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/</id>
    <published>2024-08-18T16:10:00.000Z</published>
    <updated>2025-03-28T01:05:31.487Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムのパフォーマンス カウンターを収集するためのデータ収集ルールの作成方法についてご説明します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>カスタムのパフォーマンス カウンターの収集手順<ul><li>事前準備</li><li>収集したいパフォーマンス カウンター名の取得</li><li>データ収集ルールの作成</li></ul></li><li>まとめ</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>パフォーマンス カウンターは、データ収集ルール (DCR) のデータ ソースとして使用できるものの 1 つです。<br>パフォーマンス カウンターの種類は多数存在し、Azure portal でデフォルトで用意されているものと、そうでないものがあります。  </p><p>Linux OS のマシンについては、収集可能なパフォーマンス カウンターの種類が固定されている一方、Windows OS のマシンではデフォルトで用意されていないパフォーマンス カウンターも収集することが可能です。<br>今回は、Azure portal でデフォルトで用意されてないパフォーマンス カウンター (以降、カスタム パフォーマンス カウンター) の収集設定方法についてご紹介します。  </p><p>なお、Linux OS のマシンから収集できるパフォーマンス カウンターの一覧については、以下弊社サポート チームのブログをご参照ください。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/">Azure Monitor Agent for Linux で取得可能なパフォーマンス カウンターの一覧</a></p><h2 id="カスタム-パフォーマンス-カウンターの収集手順"><a href="#カスタム-パフォーマンス-カウンターの収集手順" class="headerlink" title="カスタム パフォーマンス カウンターの収集手順"></a>カスタム パフォーマンス カウンターの収集手順</h2><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>以下のリソースがご自身の環境にあることを確認してください。</p><ul><li>データ収集元となる Windows OS の仮想マシン (以下 VM)</li><li>データ収集先となる Log Analytics ワークスペース</li></ul><h3 id="パフォーマンス-カウンター名を取得する"><a href="#パフォーマンス-カウンター名を取得する" class="headerlink" title="パフォーマンス カウンター名を取得する"></a>パフォーマンス カウンター名を取得する</h3><p>データ収集ルールのカスタム パフォーマンス カウンターに含まれないパフォーマンス カウンターを取得したい場合、以下の手順に沿って任意のパフォーマンス カウンター名を取得します。  </p><ol><li><p>VM のスタート画面で “パフォーマンス モニター” または “Performance Monitor” を検索し、開きます。</p></li><li><p>左ペインで Monitoring Tools &gt; Performance Monitor (モニター ツール &gt; パフォーマンス モニター) を押下します。ウィンドウ中央に折れ線グラフが表示されます。<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen1.png" alt="alt text"></p></li><li><p>上部 [+] ボタンを押下し、確認したいパフォーマンス カウンターを押下します。この際、”選択したオブジェクトのインスタンス (I)” に複数の値が表示されている場合は任意のインスタンスも押下します。<br>[追加] を押下し、[OK] を押下します。  </p></li></ol><p>例 : パフォーマンス カウンターにインスタンスがない場合<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen2.png" alt="alt text">  </p><p>例 : パフォーマンス カウンターにインスタンスがある場合<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen3.png" alt="alt text"></p><ol start="4"><li>折れ線グラフの下に、選択したパフォーマンス カウンターの一覧が表示されます。<br>オブジェクト、インスタンス、カウンター列を参照し、以下のルールに従ってパフォーマンス カウンター名を手元にメモします。  </li></ol><p><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen4.png" alt="alt text"></p><p>インスタンスがない場合 : <code>\&lt;オブジェクト&gt;\&lt;カウンター&gt;</code><br>    例 : <code>\System\File Read Bytes/sec</code>  </p><p>インスタンスがある場合 : <code>\&lt;オブジェクト&gt;(&lt;インスタンス&gt;)\&lt;カウンター&gt;</code><br>    例 : <code>\LogicalDisk(C:)\% Free Space</code></p><div class="alert is-info"><p class="alert-title">Note</p><p>カウンター名にアンパサンド (<code>&amp;</code>) が含まれている場合は、<code>&amp;</code> を <code>&amp;amp;</code> に置き換えてください。</p><p>例 : カウンター列の値が <code>Free &amp; Zero Page List Bytes</code> の場合、パフォーマンス カウンター名は <code>\Memory\Free &amp;amp; Zero Page List Bytes</code> となります。</p></div><h3 id="データ収集ルールを作成する"><a href="#データ収集ルールを作成する" class="headerlink" title="データ収集ルールを作成する"></a>データ収集ルールを作成する</h3><ol><li><p>Azure potral にログインします。</p></li><li><p>“deta collection rules” を選択します。</p></li><li><p>[作成] を押下し、”基本” タブの各値を入力します。<br> 続いて “リソース” タブで収集元 VM を選択・追加します。</p></li><li><p>“収集と配信” タブで [データ ソースの追加] を押下します。<br> 右ペイン内 “データ ソース” タブの “データ ソースの種類” で [パフォーマンス カウンター] を選択します。<br> その下にパフォーマンス カウンターの一覧が表示されます。</p></li><li><p>[カスタム] を押下し、収集したいパフォーマンス カウンターのチェックボックスにチェックを入れます。<br> (2024 年 7 月時点では、デフォルトですべてのカスタム パフォーマンス カウンターのチェックボックスにチェックが入っています。そのため、収集不要なカウンター場合は、そちらのチェックを外していただく必要があります。)<br> <img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/dcr-addcustomperf.png" alt="alt text"><br> 表示されているパフォーマンス カウンター以外のものを収集したい場合は、<a href="#%E5%8F%8E%E9%9B%86%E3%81%97%E3%81%9F%E3%81%84%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E5%90%8D%E3%81%AE%E5%8F%96%E5%BE%97">収集したいパフォーマンス カウンター名の取得</a> で取得したパフォーマンス カウンター名を入力し、”追加” を押下した後、チェック ボックスにチェックを入れます。<br> <img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/dcr-addcustomperf2.png" alt="alt text"></p></li><li><p>[次へ : ターゲット &gt;] を押下し、[+ ターゲットの追加] を押下します。<br> “ターゲットの種類” で [Azure Monitor Logs] を選択し、収集先となる Log Analytics ワークスペースを選択し、[データ ソースの追加] を押下します。<br> <img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/dcr-addtargets.png" alt="alt text"></p></li><li><p>“確認と作成” タブにて [作成] を押下し、完了です。</p></li></ol><h3 id="パフォーマンス-カウンターが収集されていることを確認する"><a href="#パフォーマンス-カウンターが収集されていることを確認する" class="headerlink" title="パフォーマンス カウンターが収集されていることを確認する"></a>パフォーマンス カウンターが収集されていることを確認する</h3><ol><li>Azure portal にログインします。</li><li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">データ収集ルールの作成</a> の 6 で選択した Log Analytics ワークスペースのページを開きます。</li><li>左ペインの [ログ] を押下し、以下のクエリを貼り付け、実行します。<br> なお、where から始まる行は、収集の有無を確認したいパフォーマンス カウンターのオブジェクト名、インスタンス名、カウンター名に置き換えてください。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Perf</span><br><span class="line">| where ObjectName == &quot;オブジェクト名&quot;</span><br><span class="line">| where InstanceName == &quot;インスタンス名&quot;</span><br><span class="line">| where CounterName == &quot;カウンター名&quot;</span><br><span class="line">| sort by TimeGenerated</span><br></pre></td></tr></table></figure>例 : パフォーマンス カウンター名が <code>\LogicalDisk(C:)\% Free Space</code> の場合<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Perf</span><br><span class="line">| where ObjectName == &quot;LogicalDisk&quot;</span><br><span class="line">| where InstanceName == &quot;C:&quot;</span><br><span class="line">| where CounterName == &quot;% Free Space&quot;</span><br><span class="line">| sort by TimeGenerated</span><br></pre></td></tr></table></figure></li><li>以下画像のようにログが表示されれば、ログが収集できています。<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/law-checklog.png" alt="alt text"></li></ol><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本ブログではパフォーマンス カウンターおよびカスタム パフォーマンス カウンターの収集設定方法についてご紹介しました。<br>データ収集ルールでは、収集したいパフォーマンス カウンターのパフォーマンス カウンター名を指定することで、任意のログを収集することができます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムのパフォーマンス カウンターを収集するためのデータ収集ルールの作成方法についてご説明します。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>データ収集ルール作成時のデータ収集エンドポイントの構成について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/</id>
    <published>2024-07-23T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.451Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、以下の公開情報に記載されていますデータ収集エンドポイントについて、その設定方法、利用目的、設定時の制限事項を、具体例を用いてご説明します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>データ収集エンドポイント (DCE) とは</li><li>データ収集ルールが使用するエンドポイントの種類<ul><li>ログ インジェスト エンドポイント</li><li>メトリック インジェスト エンドポイント</li><li>構成アクセス エンドポイント</li></ul></li><li>データ収集エンドポイントの 2 種類の設定箇所<ul><li>データ収集ルールの作成 [基本] タブ<ul><li>設定方法</li><li>目的</li><li>制限事項</li></ul></li><li>データ収集ルールの作成 [リソース] タブ<ul><li>設定方法</li><li>目的</li><li>制限事項</li></ul></li></ul></li><li>具体的なシナリオにおけるデータ収集エンドポイントの構成</li><li>データ収集エンドポイントに関する FAQ</li><li>まとめ</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure Monitor エージェントを使用してログやメトリックを収集する場合、どのようなログを収集するのかはデータ収集ルール (DCR) を使用して設定します。<br>データ収集ルールを作成する際、データ収集エンドポイントを設定できる箇所が 2 つあります。<br>今回は、それぞれで設定できるデータ収集エンドポイントの違いを説明するとともに、具体的な例を用いて、どのようにそれぞれのエンドポイントを構成すればよいのかをご紹介します。</p><h2 id="データ収集エンドポイント-DCE-とは"><a href="#データ収集エンドポイント-DCE-とは" class="headerlink" title="データ収集エンドポイント (DCE) とは"></a>データ収集エンドポイント (DCE) とは</h2><p>データ収集エンドポイント (DCE) は、Azure Monitor エージェントなどのデータ ソースが収集したデータを、処理して Azure Monitor に送信する際の接続を担います。</p><h2 id="データ収集ルールが使用するエンドポイントの種類"><a href="#データ収集ルールが使用するエンドポイントの種類" class="headerlink" title="データ収集ルールが使用するエンドポイントの種類"></a>データ収集ルールが使用するエンドポイントの種類</h2><h3 id="ログ-インジェスト-エンドポイント"><a href="#ログ-インジェスト-エンドポイント" class="headerlink" title="ログ インジェスト エンドポイント"></a>ログ インジェスト エンドポイント</h3><p>ログをデータ インジェスト パイプラインに取り込むエンドポイントです。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-text-log?tabs=portal">カスタム ログ</a>、および <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-iis">IIS ログ</a>を取り込む際または<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-ingestion-api-overview">ログ インジェスト API </a>を使用してログ収集を行いたい場合に必要です。</p><h3 id="メトリック-インジェスト-エンドポイント"><a href="#メトリック-インジェスト-エンドポイント" class="headerlink" title="メトリック インジェスト エンドポイント"></a>メトリック インジェスト エンドポイント</h3><p>メトリックをデータ インジェスト パイプラインに取り込むエンドポイントです。<br>エンドポイントを介してデータ インジェスト パイプラインに取り込まれたメトリックは、データ収集ルールで設定された <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/azure-monitor-workspace-overview">Azure Monitor ワークスペース</a>とテーブルに送信されます。</p><details><summary>Azure Monitor ワークスペースとは</summary>Azure Monitor が収集したメトリック データが収集されます。2024 年 7 月時点では、Prometheus に関連するメトリックのみが収集対象です。</details><h3 id="構成アクセス-エンドポイント"><a href="#構成アクセス-エンドポイント" class="headerlink" title="構成アクセス エンドポイント"></a>構成アクセス エンドポイント</h3><p>Azure Monitor エージェントがデータ収集ルールの構成情報を取得するためのエンドポイントです。<br>データ収集元となる仮想マシン (以下、VM) に紐づけられます。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> を使用してログ収集を行いたい場合に必要です。</p><h2 id="データ収集エンドポイントの-2-種類の設定箇所"><a href="#データ収集エンドポイントの-2-種類の設定箇所" class="headerlink" title="データ収集エンドポイントの 2 種類の設定箇所"></a>データ収集エンドポイントの 2 種類の設定箇所</h2><p>“データ収集ルールが使用するエンドポイントの種類” でご紹介したそれぞれのエンドポイントは、データ収集ルール作成時に設定することが可能です。<br>その方法をご紹介します。</p><h3 id="データ収集ルールの作成-基本-タブ"><a href="#データ収集ルールの作成-基本-タブ" class="headerlink" title="データ収集ルールの作成 - [基本] タブ"></a>データ収集ルールの作成 - [基本] タブ</h3><h4 id="設定方法"><a href="#設定方法" class="headerlink" title="設定方法"></a>設定方法</h4><p>Azure portal のデータ収集ルールの作成手順における [基本] タブで設定します。<br>以下画像に示す、”エンドポイント ID” で設定します。<br><img src="/blog/LogAnalytics/DataCollectionEndpoint/endpointid_ingestion.png" alt="alt text"></p><h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><p>ログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイント を設定します。</p><h4 id="制限事項"><a href="#制限事項" class="headerlink" title="制限事項"></a>制限事項</h4><ul><li>送信先の Log Analytics ワークスペース (メトリックを収集する場合は Azure Monitor ワークスペース)、およびデータ収集ルールと同じリージョンに存在する必要があります。</li></ul><h4 id="補足-1-ログ-インジェスト-エンドポイントの設定について"><a href="#補足-1-ログ-インジェスト-エンドポイントの設定について" class="headerlink" title="補足 1 : ログ インジェスト エンドポイントの設定について"></a>補足 1 : ログ インジェスト エンドポイントの設定について</h4><p>ログ インジェスト API を使用しない場合、およびカスタム ログ、IIS ログの収集を行わない場合、このデータ収集エンドポイントの設定は必要ありません。<br>この場合、ログは Log Analytics ワークスペース リソース固有のエンドポイントを介して収集されます。</p><h4 id="補足-2-メトリック-インジェスト-エンドポイントの設定について"><a href="#補足-2-メトリック-インジェスト-エンドポイントの設定について" class="headerlink" title="補足 2 : メトリック インジェスト エンドポイントの設定について"></a>補足 2 : メトリック インジェスト エンドポイントの設定について</h4><p>2024 年 7 月時点で、Prometheus メトリックを Azure Monitor ワークスペースに収集するデータ収集ルールを作成すると、自動的にそのデータ収集ルールに、メトリック インジェスト エンドポイントとしての DCE が新規作成され紐づけられます (すなわちお客様ご自身で作成し、紐づける必要はございません) 。<br>この自動で DCE が作成され紐づけられる仕様は、ログ インジェスト エンドポイントとは異なります。<br>そのため、以降本 blog 内では [基本] タブで設定する DCE はログ インジェスト エンドポイント用の DCE として扱います。<br>尚、Prometheus メトリックの収集方法については、下記の参考情報をご確認ください。  </p><p>(参考情報) Prometheus 用の Azure Monitor マネージド サービス<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/prometheus-metrics-overview#enable">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/prometheus-metrics-overview#enable</a></p><h3 id="データ収集ルールの作成-リソース-タブ"><a href="#データ収集ルールの作成-リソース-タブ" class="headerlink" title="データ収集ルールの作成 - [リソース] タブ"></a>データ収集ルールの作成 - [リソース] タブ</h3><h4 id="設定方法-1"><a href="#設定方法-1" class="headerlink" title="設定方法"></a>設定方法</h4><p>Azure portal のデータ収集ルールの作成手順における [リソース] タブで設定します。<br>以下画像に示す “データ収集エンドポイントを有効にする” のチェック ボックスにチェックを入れ、”データ収集エンドポイント” 列でエンドポイントを設定します。</p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/dce-getconfig.png" alt="alt text"></p><h4 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h4><p>構成アクセス エンドポイントを設定します。</p><h4 id="制限事項-1"><a href="#制限事項-1" class="headerlink" title="制限事項"></a>制限事項</h4><ul><li>収集元の VM と同じリージョンに存在する必要があります。</li><li>1 つの VM に複数の DCE を紐づけることはできません。</li></ul><h4 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h4><p>Azure Private Link Scope (APMPLS) を使用せずにログ収集を行う場合、このデータ収集エンドポイントの設定は必要ありません。<br>この場合、Azure Monitor エージェントはグローバルまたはリージョン共通の構成アクセス エンドポイント (下記参考情報のハイライト箇所) を介して構成情報を取得します。</p><p>(参考情報) ファイアウォールの要件</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows#firewall-requirements">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows#firewall-requirements</a></p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/configaccessDCE_globalregional.png" alt="alt text"></p><h2 id="具体的なシナリオ"><a href="#具体的なシナリオ" class="headerlink" title="具体的なシナリオ"></a>具体的なシナリオ</h2><p>※ このセクションでは、メトリックの収集を行わないシナリオをご紹介します。メトリックの収集を行いたい場合は、[基本] タブで設定するデータ収集エンドポイントと収集先の Azure Monitor ワークスペースを同じリージョンに配置する必要があります (<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90---%E5%9F%BA%E6%9C%AC-%E3%82%BF%E3%83%96">データ収集ルールの作成 - [基本] タブ</a>)。</p><h3 id="ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい"><a href="#ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい" class="headerlink" title="ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい"></a>ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい</h3><ul><li>ログ インジェスト エンドポイント用の DCE が必要です。</li><li>DCE は DCE と紐づけを行うデータ収集ルール、および送信先 Log Analytics ワークスペースと同じリージョンに存在している必要があります。</li></ul><h4 id="例-1"><a href="#例-1" class="headerlink" title="例 1"></a>例 1</h4><p>VM が Log Analytics ワークスペースおよびデータ収集ルールと同じリージョン (下図のリージョン A) に存在する場合、DCE (ログ インジェスト エンドポイント) もリージョン A に配置します。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/logingest_ex1.png" alt="alt text"></p><h4 id="例-2"><a href="#例-2" class="headerlink" title="例 2"></a>例 2</h4><p>VM が Log Analyics ワークスペースおよびデータ収集ルールと異なるリージョンに存在する場合、DCE は Log Analyics ワークスペースおよびデータ収集ルールと同じリージョン (下図のリージョン B) に配置します。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/logingest_ex2.png" alt="alt text"></p><h3 id="Azure-Private-Link-Scope-を使用してログを収集したい"><a href="#Azure-Private-Link-Scope-を使用してログを収集したい" class="headerlink" title="Azure Private Link Scope を使用してログを収集したい"></a>Azure Private Link Scope を使用してログを収集したい</h3><ul><li>構成アクセス エンドポイント用の DCE が必要です。</li><li>DCE はデータ収集元の VM と同じリージョンに存在している必要があります</li></ul><p>※ 以降の図内では、簡略化のためグローバル/リージョン共通のログ インジェスト エンドポイントを省略しております。</p><h4 id="例-1-1"><a href="#例-1-1" class="headerlink" title="例 1"></a>例 1</h4><p>VM が Log Analytics ワークスペースおよびデータ収集ルールと同じリージョン (下図のリージョン A) に存在する場合、DCE (構成アクセス エンドポイント) もリージョン A に配置します。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/configaccess_ex1.png" alt="alt text"></p><h4 id="例-2-1"><a href="#例-2-1" class="headerlink" title="例 2"></a>例 2</h4><p>1 つのデータ収集ルールに複数の VM を紐づける場合、それぞれの VM に対して DCE (構成アクセス エンドポイント) を設定する必要があります。<br>VM と VM に設定する DCE は同じリージョンに存在している必要があります。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/configaccess_ex4.png" alt="alt text"></p><h3 id="ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい-かつ-Azure-Private-Link-Scope-を使用してログを収集したい"><a href="#ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい-かつ-Azure-Private-Link-Scope-を使用してログを収集したい" class="headerlink" title="ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい かつ Azure Private Link Scope を使用してログを収集したい"></a>ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい かつ Azure Private Link Scope を使用してログを収集したい</h3><ul><li>ログ インジェスト エンドポイント用の DCE と構成アクセス エンドポイント用の DCE が必要です。</li><li>必要な DCE の数は VM が Log Analytics ワークスペースおよびデータ収集ルールと同じリージョンに存在しているかどうかで変わります。</li></ul><h4 id="例-1-2"><a href="#例-1-2" class="headerlink" title="例 1"></a>例 1</h4><p>VM と Log Analytics ワークスペース、データ収集ルールが 1 つのリージョン (下図のリージョン A) に存在する場合、1 つの DCE をログ インジェスト エンドポイントと構成アクセス エンドポイントの両方に設定することで、収集の要件を達成することができます。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/dceshared_ex1.png" alt="alt text"></p><h4 id="例-2-2"><a href="#例-2-2" class="headerlink" title="例 2"></a>例 2</h4><p>VM が Log Analytics ワークスペースおよびデータ収集ルールと異なるリージョンに存在する場合、2 つの DCE が必要です。<br>構成アクセス エンドポイントとしての DCE は VM と同じリージョンに、ログ インジェスト エンドポイントとしての DCE は Log Analytics ワークスペースおよびデータ収集ルールと同じリージョンに、それぞれ配置する必要があります。</p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/dcenotshared.png" alt="alt text"></p><h2 id="データ収集エンドポイントに関する-FAQ"><a href="#データ収集エンドポイントに関する-FAQ" class="headerlink" title="データ収集エンドポイントに関する FAQ"></a>データ収集エンドポイントに関する FAQ</h2><p><strong>Q1.</strong> 既存のデータ収集エンドポイントが 1 つ存在する場合、それをデータ収集ルール作成時の [基本] タブと [リソース] の両方で指定することはできますか？</p><p><strong>A1.</strong> はい、可能です。<br>ただし、この場合はデータ収集ルール、送信先 Log Analytics ワークスペース (メトリック収集の場合は Azure Monitor ワークスペース)、送信元 VM、データ収集エンドポイントがすべて同じリージョンに存在する必要があります。</p><hr><p><strong>Q2.</strong> 最低限必要なデータ収集エンドポイントの数が分かりません。どのように考えればよいですか？</p><p><strong>A2.</strong> ログ インジェスト エンドポイント (メトリック収集の場合はメトリック インジェスト エンドポイント)、構成アクセス エンドポイントのどちらが必要かによって考え方が異なります。  </p><p>ログ インジェスト エンドポイント (メトリック インジェスト エンドポイント) だけが必要な場合、必要な DCE の最低数は、送信先の Log Analytics ワークスペース (Azure Monitor ワークスペース) と使用するデータ収集ルールが存在するリージョンの数です。<br>この際、1 つの Log Analytics ワークスペース (Azure Monitor ワークスペース) と、それに紐づいているデータ収集ルール, DCE は同じリージョンに存在している必要があります。  </p><p>構成アクセス エンドポイントだけが必要な場合、必要な DCE の最低数は送信元の VM が存在しているリージョンの数です。<br>この際、VM とそれに紐づける DCE は同じリージョンに存在している必要があります (複数の VM に同じ DCE を設定することができます)。</p><p>なお、ログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイントと構成アクセス エンドポイントの両方が必要な場合、それぞれのエンドポイントの条件を満たしていれば、 1 つのエンドポイントをログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイントと構成アクセス エンドポイントの両方に使用することが可能です。</p><hr><p><strong>Q3.</strong> データ収集エンドポイントには料金がかかりますか？</p><p><strong>A3.</strong> データ収集エンドポイントの使用にあたり、料金は発生しません。</p><hr><p><strong>Q4.</strong> Windows VM と Linux VM, どちらに対しても同じデータ収集エンドポイントを指定できますか？</p><p><strong>A4.</strong> OS の種類に関わらず、複数の VM に 1 つのDCE (構成アクセス エンドポイント) を紐づけることが可能です。<br>この際も、VM とそれに紐づける DCE は同じリージョンに存在している必要があります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>データ収集ルールを作成する際、ご自身の環境においてログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイントと構成アクセス エンドポイント、それぞれ設定が必要かどうかを検討する必要があります。<br>そして必要なデータ収集エンドポイントの数は Log Analytics ワークスペース (メトリック収集の場合は Azure Monitor ワークスペース) および VM が存在するリージョンによって変化します。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、以下の公開情報に記載されていますデータ収集エンドポイントについて、その設定方法、利用目的、設定時の制限事項を、具体例を用いてご説明します。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM における死活監視の考え方</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/</id>
    <published>2024-07-02T15:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.633Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回は、Azure Monitor による Azure VM の死活監視の考え方についてご紹介したいと思います。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E5%90%84%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%81%AE%E7%9B%A3%E8%A6%96%E6%96%B9%E6%B3%95">2. 各レイヤーの監視方法</a></li><li><a href="#3-VM-%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E7%9B%A3%E8%A6%96">3. VM ホストの監視</a><ul><li><a href="#3-1-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">3-1. メトリック ‘VM Availability Metric (Preview)’ を監視する方法</a></li><li><a href="#3-2-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">3-2. リソース正常性を監視する方法</a></li></ul></li><li><a href="#4-VM-%E3%82%B2%E3%82%B9%E3%83%88%E3%81%AE%E7%9B%A3%E8%A6%96">4. VM ゲストの監視</a><ul><li><a href="#4-1-Heartbeat-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88">4-1. Heartbeat を利用したログ アラート</a></li><li><a href="#4-2-Heartbeat-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%AE%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88">4-2. Heartbeat を利用したログのメトリック アラート</a></li></ul></li><li><a href="#5-VM-%E4%B8%8A%E3%81%A7%E7%A8%BC%E5%83%8D%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD%E3%81%AE%E7%9B%A3%E8%A6%96">5. VM 上で稼働している機能の監視</a></li><li><a href="#6-Heartbeat-%E3%81%AE%E5%8F%8E%E9%9B%86%E9%81%85%E5%BB%B6%E3%81%AB%E5%BD%B1%E9%9F%BF%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%9B%A3%E8%A6%96%E6%96%B9%E6%B3%95">6. Heartbeat の収集遅延に影響されない監視方法</a><ul><li><a href="#6-1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E8%A9%95%E4%BE%A1%E6%9C%9F%E9%96%93%E3%82%92%E9%95%B7%E3%82%81%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">6-1. アラートの評価期間を長めに設定する</a></li><li><a href="#6-2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E3%81%97%E3%81%8D%E3%81%84%E5%80%A4%E3%82%92%E7%B7%A9%E5%92%8C%E3%81%99%E3%82%8B">6-2. アラートのしきい値を緩和する</a></li><li><a href="#6-3-Heartbeat-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%80%81VM-Availability-Metric-Preview-%E3%82%84%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%81%A7%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B">6-3. Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する</a></li></ul></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p>Azure VM の死活監視にはいくつか方法がありますが、Heartbeat を利用した監視をご利用されている方が多いかと思います。</p><p>Heartbeat は Azure Monitor エージェントや Log Analytics エージェントによって Log Analytics ワークスペースに収集されます。<br>エージェントによって収集されるログは、基本的にはログが生成されてから 20 秒から 3 分程度で Log Analytics ワークスペースで検索可能となります。しかし、Azure サービスの負荷が高い場合や Azure 基盤側で障害が発生している場合等、様々な要因でログの収集に遅延が生じたり、ログが欠損することがあります。このような状況では Azure VM 自体は正常に稼働していても、アラートが発報する可能性があります。</p><p>弊社 Azure サービスでは、お客様の環境に影響を及ぼす障害が発生しないように日々サービスの品質向上に努めておりますが、<br>ログの収集遅延や欠損が発生する障害が発生した際には、アラートの誤検知に関するお問い合わせを沢山いただきます。</p><p>このような障害が発生した際、Heartbeat による死活監視のみを利用されている場合には、大変心苦しいのですが障害が解消されるまでお待ちいただくしかありません。そのため、弊社としては Heartbeat 以外の死活監視方法を代替案としてご案内させていただいたり、障害が発生した場合でも死活監視を継続できるように死活監視の冗長化を推奨しております。</p><p>今回は、VM の監視方法をレイヤーに分けてご紹介します。<br>お客様には誠に申し訳ございませんが、Heartbeat を含むどの監視方法も 100% の信頼性を保証することはできません。<br>Heartbeat を利用した監視だけではなく、他の監視方法も併用することで障害時でも VM の監視を継続できるようになります。<br>また、Heartbeat の収集遅延の影響を受けずに監視する場合には、Heartbeat 以外を利用した監視方法をご検討ください。<br>各レイヤーの監視方法の特性と内容をご確認いただき、お客様のご要件に合った監視方法や、監視の冗長化をご検討いただけますと幸いです。</p><div class="alert is-important"><p class="alert-title">重要</p><p>Log Analytics エージェントは 2024 年 8 月に廃止されるため、Azure Monitor エージェントへの移行をお願いしております。詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration">弊社公開情報</a> や <a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromLA/">弊社サポート ブログ</a> をご覧ください。</p></div><br><h2 id="2-各レイヤーの監視方法"><a href="#2-各レイヤーの監視方法" class="headerlink" title="2. 各レイヤーの監視方法"></a>2. 各レイヤーの監視方法</h2><p>各レイヤーの VM の監視方法を記載します。<br>複数のアラートで同時に VM の異常を検知した際に VM の状態を確認するなど、お客様のご状況に沿った方法の使用をご検討いただければ幸いです。</p><table><thead><tr><th>レイヤー</th><th>アラート</th></tr></thead><tbody><tr><td>VM ホストの監視</td><td>VM Availability Metric (Preview) <br>リソース正常性</td></tr><tr><td>VM ゲストの監視</td><td>Heartbeat</td></tr><tr><td>VM上で稼働している機能の監視</td><td>可用性テスト</td></tr></tbody></table><br><h2 id="3-VM-ホストの監視"><a href="#3-VM-ホストの監視" class="headerlink" title="3. VM ホストの監視"></a>3. VM ホストの監視</h2><p>VM ホストは、以下の方法で監視できます。</p><ul><li>メトリック ‘VM Availability Metric (Preview)’ を監視する方法</li><li>リソース正常性を監視する方法</li></ul><p>本ブログでは上記 2 つの方法をご紹介しますが、この他にも VM のホスト監視を行う方法がございます。<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/flash-overview#next-steps">こちら</a> の公開情報にも掲載されておりますので、併せてご確認いただけますと幸いです。</p><br><h3 id="3-1-メトリック-‘VM-Availability-Metric-Preview-’-を監視する方法"><a href="#3-1-メトリック-‘VM-Availability-Metric-Preview-’-を監視する方法" class="headerlink" title="3-1. メトリック ‘VM Availability Metric (Preview)’ を監視する方法"></a>3-1. メトリック ‘VM Availability Metric (Preview)’ を監視する方法</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/monitor-vm-reference#vm-availability-metric-preview">VM Availability Metric (Preview) （VM 可用性メトリック (プレビュー)）</a>は Azure VM のホストが出力するメトリックであり、VM の可用性を確認することができます。このメトリックは Heartbeat を収集する Azure Monitor エージェントや Log Analytics エージェントとは関係ないため、エージェントから Log Analytics ワークスペースへのログの出力に問題が発生した際もメトリックは出力されます。<br><img src="/blog/LogAnalytics/MonitorVM02/image01.png"></p><p>VM Availability Metric (Preview) の値が 1 の場合は、VM が実行中であり、利用可能であることを表します。<br>つまり、この値が 1 より小さい場合には VM の可用性が低下していることになりますので、このメトリックを監視するメトリック アラートを構成することで、VM の可用性が低下した場合に発報させることが可能です。<br>このメトリックを利用したアラート ルールの設定方法については、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/tutorial-monitor-vm-alert-availability#view-vm-availability-metric-in-metrics-explorer">こちら</a>の弊社公開情報をご参照ください。<br><img src="/blog/LogAnalytics/MonitorVM02/image02.png"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>VM Availability Metric (Preview) のメトリック アラートで Azure VM が “停止済み (割り当て解除) “ を検知することはできません。VM が “停止済み (割り当て解除)” の場合は VM Availability Metric (Preview) の値は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#null-and-zero-values">NULL</a> になりますが、メトリック アラートではメトリックの値が NULL であることを検知できないためです。予めご留意ください。</p></div><br><h3 id="3-2-リソース正常性を監視する方法"><a href="#3-2-リソース正常性を監視する方法" class="headerlink" title="3-2. リソース正常性を監視する方法"></a>3-2. リソース正常性を監視する方法</h3><p>リソース正常性アラートでは、リソースの正常性に変化が生じた際に通知できます。<br>リソースの状態に変化が発生すると、アクティビティ ログに正常性に関するイベントが書き込まれ、アラートで指定した条件に合致した場合に発報します。Azure VM のリソース正常性では、<a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines">以下の項目</a>をチェックします。この項目に該当するようなイベントが発生した場合に、リソースの正常性に変化が発生したと判断されます。<br><img src="/blog/LogAnalytics/MonitorVM02/image03.png"></p><p>リソース正常性では、リソースに変化が発生した際に、リソースの現在と過去の正常性 (リソースの状態) について報告します。<br>リソース正常性アラートで指定する条件は以下であり、”現在のリソースの状態” と “過去のリソースの状態” や、”イベントの状態”、イベントが発生した “理由の種類” を指定できます。<br><img src="/blog/LogAnalytics/MonitorVM02/image05.png"></p><p>“イベントの状態” が Active である場合、リソースの正常性が異常な状態であることを表し、Resolved に変化した場合、異常な状態から正常な状態に遷移したことを表します。また、”リソースの状態” が Unavailable はリソースが利用可能でないことを意味し、Available はリソースが利用可能であることを意味します。</p><p>つまり、以下の設定にすると、<br>リソースの状態が 「Available」 の状態から 「Unavailable」 に遷移したタイミングと、<br>リソースの状態が 「Unavailable」 の状態から 「Available」 に遷移したタイミングでアラートがトリガーされ、リソース正常性に変更が発生したタイミング、解消したタイミングで通知を受け取ることが可能です。</p><p>■ イベントの状態 :  Active, Resolved<br>■ 以前のリソースの状態 : Available, Unavailable<br>■ 現在のリソースの状態 : Unavailable, Available,</p><p><img src="/blog/LogAnalytics/MonitorVM02/image04.png"></p><p>VM のリソース正常性アラート ルールの設定方法については、<a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-overview">こちら</a>の弊社公開情報や、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/">弊社サポート ブログ</a>も併せてご確認ください。</p><br><h2 id="4-VM-ゲストの監視"><a href="#4-VM-ゲストの監視" class="headerlink" title="4. VM ゲストの監視"></a>4. VM ゲストの監視</h2><p>VM ゲストは、以下の方法で監視できます。</p><ul><li>Heartbeat を利用したログ アラート</li><li>Heartbeat を利用したログのメトリック アラート</li></ul><br><h3 id="4-1-Heartbeat-を利用したログ-アラート"><a href="#4-1-Heartbeat-を利用したログ-アラート" class="headerlink" title="4-1. Heartbeat を利用したログ アラート"></a>4-1. Heartbeat を利用したログ アラート</h3><p>Heartbeat は Log Analytics エージェントや Azure Monitor エージェントによって Log Analytics ワークスペースに収集されます。<br>Log Analytics ワークスペースに収集された Heartbeat を利用して、死活監視の<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">ログ アラート ルール</a>を構成することが可能です。<br>例えば、直近 10 分以内に Heartbeat が収集されていることを確認するログ アラート ルールが発報した場合、アラートが実行された時点から 過去 10 分以内に Heartbeat が途絶えたことになり、該当のマシンにて何らかの問題が発生している可能性がございます。なお、Heartbeat のログ アラートが発報したとしても、必ずしも仮想マシンに問題が発生しているとは限りません。エージェント自体に問題が発生している場合や、ログの収集遅延によってアラートが発報する場合もございます。</p><!--- https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM/ ---><br><h3 id="4-2-Heartbeat-を利用したログのメトリック-アラート"><a href="#4-2-Heartbeat-を利用したログのメトリック-アラート" class="headerlink" title="4-2. Heartbeat を利用したログのメトリック アラート"></a>4-2. Heartbeat を利用したログのメトリック アラート</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-metric-logs">ログのメトリック アラート</a>は、Azure Monitor エージェントや Log Analytics エージェントで収集されたログをメトリックに変換し、メトリックを評価するアラート ルールです。</p><p>ログが生成され、Log Analytics のエンドポイントに対してログを送信し、メトリックに変換されてメトリックを検索できるようになるまでの時間と、ログが生成され、Log Analytics のエンドポイントに対してログを送信し、Log Analytics ワークスペース上でアラートの検索クエリでログを検索できるようになるまでの時間を比較した場合、前者の方が早く処理が実施されます。このため、ログ アラート ルールと比較し、「ログのメトリック アラート」の方がよりリアルタイムに近い監視が可能です。</p><p>なお、ログ アラートと同様、Heartbeat メトリックが途絶えたとしても、マシンに問題が発生しているとは限りません。<br>ログが生成され Log Analytics のエンドポイントに到着するまでの間に遅延が発生していた場合には、ログのメトリック アラートでも遅延の影響を受けてアラートが発報します。Log Analytics のエンドポイントに到着するまでの間に遅延が発生すると、メトリックの変換も遅延し、結果的にメトリックの収集遅延が発生するためです。また、Azure Monitor の基盤側の問題により、変換されたメトリックが欠損してしまう可能性があり、欠損の影響でアラートが発報することも考えられます。</p><p><img src="/blog/LogAnalytics/MonitorVM02/image06.png"></p><br><h2 id="5-VM-上で稼働している機能の監視"><a href="#5-VM-上で稼働している機能の監視" class="headerlink" title="5. VM 上で稼働している機能の監視"></a>5. VM 上で稼働している機能の監視</h2><p>VM で動作するアプリケーションの死活監視を行います。<br>ホストやゲストの監視に異常が発生しても、アプリケーションが正常に動作していれば VM に異常は発生していないと判断できる場合もあります。</p><p>アプリケーションは Application Insights の<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-overview">可用性テスト</a>を使用して死活監視できます。<br>可用性テストは弊社の世界各地のサーバーから定期的にアプリケーションに Web リクエストを送信し可用性を確認する機能です。</p><p>可用性テストは、「メトリック ‘VM Availability Metric (Preview)’ を監視する方法」、「Heartbeat を利用した監視方法」および「リソース正常性を監視する方法」とは独立した機能です。アプリケーションが動作している際に Heartbeat に異常が発生しても、可用性テストが正常であればアプリケーションに問題は起きておらず、VM も正常に動作していると判断いただけます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-standard-tests">可用性テストの設定方法</a>及び、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-alerts">アラート ルールの設定方法</a> は、公開情報をご参照いただけますと幸いです。</p><p>なお、Application Insights の可用性テストを使って監視を行う場合は、監視対象の VM に HTTP/HTTPS のリクエストを受け取るための Web サーバー構築が必要です。Application Insights の可用性テストは、Application Insights で管理しているテスト クライアントから監視対象の VM に対して定期的に HTTP/HTTPS のプロトコルでリクエストを送信し、期待するレスポンスが返ってくるかどうかを評価する機能であるためです。HTTP/HTTPS リクエストを受け取る Web サーバーが構築されていないとご利用出来ないので、ご注意ください。</p><p>また、標準テストは、インターネットからアクセスできるエンドポイントが必要です。<br>もしプライベート ネットワークからのみを許可する機能の監視を行う必要がありましたら、弊社サポート ブログでご案内しております <a href="https://jpazmon-integ.github.io/blog/applicationInsights/privateAvailabilityTestSampleCode/">Azure Functions を使用した可用性テスト</a>を作成いただけますと幸いです。</p><br><h2 id="6-Heartbeat-の収集遅延に影響されない監視方法"><a href="#6-Heartbeat-の収集遅延に影響されない監視方法" class="headerlink" title="6. Heartbeat の収集遅延に影響されない監視方法"></a>6. Heartbeat の収集遅延に影響されない監視方法</h2><p>Heartbeat のログ アラートやログのメトリック アラートを構成されているお客様から「VM は正常に稼働しているがアラートが発報したため、原因を調査してほしい」というお問い合わせをいただくことがあります。こういったお問い合わせで原因を調査しますと、ログの収集が遅延していた影響でアラートが発報しているケースが多く見受けられます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time#average-latency">ログ データを取り込むための一般的な待ち時間は 20 秒から 3 分</a>です。<br>Heartbeat のアラートを構築しているお客様には申し訳ございませんが、以下の要因等によりログの取り込みに遅延が発生する場合がございます。</p><ul><li>Azure Monitor エージェントや Log Analytics エージェントがインストールされたコンピューターに一時的に負荷が発生し、エージェントの動作に影響した。</li><li>何らかの原因で Azure Monitor エージェントや Log Analytics エージェントが停止していた。</li><li>何らかの原因でネットワークに異常が発生し、クライアントから Log Analytics ワークスペースへのデータ送信に失敗。エージェント側の再試行処理により、データの取り込みに時間を要した。</li><li>Azure 基盤側で問題が発生し、Log Analytics ワークスペース上でクエリ検索できるまでに時間を要した。</li></ul><p>また、ログのメトリック アラートではエージェントから Log Analytics のエンドポイントにデータが送信された後、基盤側でログをメトリックに変換します。そのため、Log Analytics のエンドポイントにデータが到着するまでに遅延が発生した場合や、メトリックへの変換処理にて遅延が発生した場合には、ログのメトリック アラートでも収集遅延による誤検知が発生する可能性がございます。</p><p>Heartbeat の収集遅延に影響されない監視方法について聞かれることがよくありますが、<br>弊社サポートとしては基本的に以下 3 つのことをご検討いただくことをご案内しております。</p><ul><li>アラートの評価期間を長めに設定する</li><li>アラートの閾値を緩和する</li><li>Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する</li></ul><br><h3 id="6-1-アラートの評価期間を長めに設定する"><a href="#6-1-アラートの評価期間を長めに設定する" class="headerlink" title="6-1. アラートの評価期間を長めに設定する"></a>6-1. アラートの評価期間を長めに設定する</h3><p>ログの収集遅延に起因したアラートの発報を減らす方法として、アラートの評価期間を長めに設定いただくことを推奨しております。Log Analytics ワークスペースに収集されるデータや、ログからメトリックに変換するデータでは、収集遅延や待機時間が発生いたします。</p><p>「アラートの評価期間」とは、1 回の評価を行う際に評価の対象となる期間を意味します。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">ログ アラート</a>の場合は [集計の粒度]、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-metric-alert-rule">ログのメトリック アラート</a>の場合は [ルックバック期間] に該当します。この [集計の粒度] や [ルックバック期間] が短ければ短いほど (例. 1 分や 5 分) 、収集遅延の影響を受けやすくなります。</p><p>ログ アラートやログのメトリック アラートでは、ログの TimeGenerated やメトリックの timestamp をもとに評価期間内のデータを検索します。アラート ルールの評価時点でログやメトリックが取り込まれていない場合、アラートのしきい値を満たしてアラートが発報してしまいます。ログやメトリックの収集遅延により期待しないアラート発報を緩和させるためには、[集計の粒度] や [ルックバック期間] をより長い期間へとご指定いただけますと幸いです。</p><br><h3 id="6-2-アラートのしきい値を緩和する"><a href="#6-2-アラートのしきい値を緩和する" class="headerlink" title="6-2. アラートのしきい値を緩和する"></a>6-2. アラートのしきい値を緩和する</h3><p>Heartbeat のログ アラートで以下のように設定していたとします。<br>この場合、[評価の頻度] の 5 分毎に、直近 5 分以内に収集された Heartbeat のレコード数が [しきい値] の 3 以下であった場合に発報します。アラートのしきい値を緩和する場合には、例えば、[しきい値] を 「3 以下」から「0 以下」に設定する方法が考えられます。</p><ul><li>メジャー: テーブルの行</li><li>集計の種類: カウント</li><li>集計の粒度: 5 分 </li><li>演算子: 次の値以下</li><li>しきい値: 3</li><li>評価の頻度: 5分</li></ul><br><h3 id="6-3-Heartbeat-を利用したアラートではなく、VM-Availability-Metric-Preview-やリソース正常性で監視する"><a href="#6-3-Heartbeat-を利用したアラートではなく、VM-Availability-Metric-Preview-やリソース正常性で監視する" class="headerlink" title="6-3. Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する"></a>6-3. Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する</h3><p>ログやメトリックを取り込むまでに遅延が発生する場合がございます。<br>エージェントや Log Analytics 基盤等による収集遅延を受けない監視方法として、リソース正常性や VM Availability Metric (Preview) を監視する方法をご検討ください。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回は、Azure Monitor による Azure VM の死活監視の考え方についてご紹介したいと思います。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>Azure Arc のオンボードスクリプトの留意点</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_onboard_FAQ/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_onboard_FAQ/</id>
    <published>2024-05-30T12:00:00.000Z</published>
    <updated>2025-03-28T01:05:31.380Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。<br>当ページでは、Azure Arc のオンボードスクリプトの留意点について説明します。</p><p>Azure Arc にオンボードできる OS やソフトウェアには幾つか種類がございますが、当ページでは Windows マシンを主に、一部 Linux マシンをオンボードすることも含めて解説します。<br>また、オンボードするためのスクリプトの種別は以下 3 点ございますが、本日は多くのお問い合わせを頂戴する ”単一サーバーの追加” について解説いたします。</p><ul><li>単一サーバーの追加</li><li>複数のサーバーの追加 </li><li>Update Management でサーバーを追加する</li></ul><p>まず基本のオンボードの流れは以下の当社公開ページに記載しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/learn/quick-enable-hybrid-vm">クイックスタート: Azure Arc 対応サーバーにハイブリッド マシンを接続する</a></p><p>上記ページに記載のように Azure ポータル上で作成いただいたスクリプトをオンボードさせたいマシン上で実行する運びとなります。</p><p>失敗事例と改善策をお伝えする前に一度オンボードスクリプトの内容を解説いたします。</p><h2 id="Windows-マシン向けスクリプトについて"><a href="#Windows-マシン向けスクリプトについて" class="headerlink" title="Windows マシン向けスクリプトについて"></a>Windows マシン向けスクリプトについて</h2><p>下図 1 の通り大まかな流れとしては接続先の情報を変数に代入した後、Connected Machine エージェントをインストールするため、install_windows_azcmagent.ps1 がダウンロードされ、実行されます。<br>その後、インストールされた Connected Machine エージェントの実行ファイルを使用してオンボード処理をしております。<br>尚、install_windows_azcmagent.ps1 の内容は <a href="https://gbl.his.arc.azure.com/installationScripts?api-version=1.0-preview&platform=windows">こちら</a> からご確認いただくことが可能です。<br>内容の詳細は割愛しますが、この中でエージェントのインストーラファイル”AzureConnectedMachineAgent.msi”がダウンロードされ、その後実行されます。<br>■図 1. Windows マシン向けのスクリプト<br><img src="/blog/Arc/Arc_onboard_FAQ/01.png"></p><h2 id="Linux-マシン向けスクリプトについて"><a href="#Linux-マシン向けスクリプトについて" class="headerlink" title="Linux マシン向けスクリプトについて"></a>Linux マシン向けスクリプトについて</h2><p>下図 2 が Linux 向けとなりますが、Windows 向けと同じと流れとなります。<br>■図 2. Linux マシン向けのスクリプト<br><img src="/blog/Arc/Arc_onboard_FAQ/02.png"></p><h1 id="留意点・失敗事例について"><a href="#留意点・失敗事例について" class="headerlink" title="留意点・失敗事例について"></a>留意点・失敗事例について</h1><h2 id="留意点-1：proxy-サーバーを経由し、且つプラベート-エンドポイントへ接続するシナリオ"><a href="#留意点-1：proxy-サーバーを経由し、且つプラベート-エンドポイントへ接続するシナリオ" class="headerlink" title="留意点 1：proxy サーバーを経由し、且つプラベート エンドポイントへ接続するシナリオ"></a>留意点 1：proxy サーバーを経由し、且つプラベート エンドポイントへ接続するシナリオ</h2><p>Azure ポータル画面でスクリプト作成の条件を設定いただいている中で下図 3 の箇所がございます。<br>お客様環境に依ってはプロキシ サーバーを経由し、且つプラベート エンドポイントへ接続する用件があるかと存じます。<br>その場合、自動で作成されるスクリプトでは動作しないため、まずは下図 3 のように ”プラベート エンドポイント”を選択して、スクリプトのダウンロードまでお進みください。</p><p>■図 3. 接続方法の設定個所の画面<br><img src="/blog/Arc/Arc_onboard_FAQ/03.png"></p><p>上記シナリオの場合以下のような手順でお進みください。</p><h3 id="step-1：エージェントのインストール"><a href="#step-1：エージェントのインストール" class="headerlink" title="step 1：エージェントのインストール"></a>step 1：エージェントのインストール</h3><p>最新のエージェントインストーラを <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/agent-overview#agent-resources">こちら</a> ページの手順でダウンロードおよびインストールいただき、対象マシンにConnected Machine エージェントをインストールまでお進みください。</p><h3 id="step-2：プロキシ設定"><a href="#step-2：プロキシ設定" class="headerlink" title="step 2：プロキシ設定"></a>step 2：プロキシ設定</h3><p>以下ページの手順に従いプロキシ環境向けの設定を行います。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/manage-agent?tabs=windows#update-or-remove-proxy-settings">プロキシ設定の更新または削除</a> </p><p>ここでプロキシ設定について 2 種類の説明がありますので、ここでも解説いたします。<br>上記公開ページに記載の通り、エージェントが Arc 関連の通信をする際にプロキシ向けに通信させる方法は以下２つ、両方の設定がされている場合は前者が採用される仕様となっております。</p><ul><li>エージェント構成（azcmagent config コマンドによる設定）</li><li>システム環境変数への設定</li></ul><p>また注意点として ‘netsh winhttp show proxy’ コマンドで確認できる Windows システム全体のプロキシ設定が構成されていても”システム環境変数への設定”が無い場合はプロキシサーバー向けに通信されない仕様となります。</p><p>そのため上記仕様を踏まえ、どちらの設定をするかご検討いただくようお願いいたします。<br>推奨は ”エージェント構成（azcmagent config コマンドによる設定）” となります。<br>尚、’azcmagent config’ コマンドは公開情報に ”Bash” と記載されておりますが、エージェントをインストールする Windows 上の PowerShell で実行いただけるコマンドとなります。</p><p>設定後に ‘azcmagent show’ コマンドを実行すると下図 3 のように通信を向けるプロキシサーバーならびに bypass（※）設定を確認いただけます。<br>■図 4. ‘azcmagent config’ コマンド および ‘azcmagent config’ コマンド 実行の画面<br><img src="/blog/Arc/Arc_onboard_FAQ/04.png"></p><p>※プロキシサーバーに向けない宛先グループ<br>　Arc と記載されている場合は、プライベートリンク向けの通信はプロキシサーバーへ通信を向けない事を意味します。</p><h3 id="step-3：オンボード"><a href="#step-3：オンボード" class="headerlink" title="step 3：オンボード"></a>step 3：オンボード</h3><p>最後に PowerShell を管理者権限で開いていただき、『図 1. Windows マシン向けのスクリプト』の ”接続先情報を変数に定義” および ”Connected Machine エージェントの接続コマンドを実行”をすることでオンボードが可能となります。<br>図1 のコマンドでなく、ダウンロードしたスクリプトから変数や接続コマンドをコピーして、PowerShell にて 1 行ずつ実行ください。</p><p>上記手順によりプロキシサーバーを使用する環境であり、且つプライベート エンドポイントへ接続するご要件を満たすことが可能となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;br&gt;当ページでは、Azure Arc のオンボードスクリプトの留意点について説明します。&lt;/p&gt;
&lt;p&gt;Azure Arc にオンボードできる OS やソ</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="howto" scheme="https://jpazmon-integ.github.io/blog/tags/howto/"/>
    
    <category term="オンボード script" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%82%AA%E3%83%B3%E3%83%9C%E3%83%BC%E3%83%89-script/"/>
    
  </entry>
  
</feed>
