<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Monitoring Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Monitoring に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazmon-integ.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazmon-integ.github.io/blog/"/>
  <updated>2024-04-07T11:46:44.307Z</updated>
  <id>https://jpazmon-integ.github.io/blog/</id>
  
  <author>
    <name>Japan Azure Monitoring Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Private Link  を使った Azure Arc + Azure Monitor</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_AMPLS/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_AMPLS/</id>
    <published>2024-04-07T12:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.307Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。</p><p>今回は、Azure Private Link  を使った Azure Arc および Azure Monitor を構成した際の DNS 構成例や実際にログ採取する際の通信シーケンスを実際に検証環境を構成してご紹介いたします。<br>当ページの内容は以下 2 稿 の内容を踏まえて記載しております。ご一読いただき当ページの内容を参照いただけますと幸いです。</p><ul><li> <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/">Azure Private Link  を使った Azure Arc への接続 - NW 構成</a> </li><li> <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/">Azure Private Link  を使った Azure Arc への接続 - DNS 構成</a> </li></ul><p>今回説明する構成は公開情報 <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security">Azure Private Link を使用して、サーバーを Azure Arc に安全に接続する</a>に記載しております構成イメージ図を踏まえると下図 1 のような構成となります。<br>■図1 Azure Private Link を使った Azure Arc + Azure Monitor の構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/01.png"></p><p>以後、Azure Private Link  を使った Azure Monitor を AMPLS と記載いたします。<br>ご説明にあたって、当方の検証環境は以下の通りです。</p><p>■図 2. 検証環境の構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/02.png"></p><h2 id="DNS-構成について"><a href="#DNS-構成について" class="headerlink" title="DNS 構成について"></a>DNS 構成について</h2><p>DNS 構成については上記 blog  [DNS サーバーの手動構成] (<a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/#DNS-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%89%8B%E5%8B%95%E6%A7%8B%E6%88%90">https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/#DNS-サーバーの手動構成</a>) の構成を踏襲して図 2 の右上の表に記載されている FQDN を Private Link がデプロイした際に同時に作成される下図 3 のプライベート エンドポイントの IP アドレス（※1）に変換して通信できる環境を構築します。<br>※1 今回の検証環境では 10.13.1.4 ～ 10.13.1.17 となります。尚、Arc 向けの プライベート エンドポイントの IP アドレスは引き続き 10.13.0.4 ～ 10.13.0.9 となります。</p><p>■図 3. AMPLS 向けプライベート エンドポイントの [DNS の構成] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/03.png"></p><p>AMPLS では、後述する ”データ収集ルール”（以後、DCR ）においてリソース（今回は VM ”AAPLS001vm”）に対する ”データ収集エンドポイント” を設定する必要があります。<br>それを AMPLS の ”Azure Monitor リソース” に紐づける事を忘れないようご留意ください。<br>この設定が不足していると上図 3 における 10.13.1.15 ～ 10.13.1.17 のインターフェースのアドレスとそれに紐づく FQDN が登録されずログが採取できません。</p><p>■図 4. AMPLS の [Azure Monitor リソース] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/04.png"></p><p>上記 blog でArc にオンボードさせたマシン（コンピューター名が ”AAPLS001vm” ）から 作成した プライベート エンドポイント向けのアドレスに疎通できるか <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=windowsserver2022-ps">Test-NetConnection</a> で確認しました。<br>下図 5 の通りプライベート IP 向けに疎通（TcpTestSucceeded の結果が True）になっていることが確認できます。</p><p>■図 5. コンピューター  ”AAPLS001vm” からの疎通確認<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/05.png"></p><h3 id="DCR-の設定確認"><a href="#DCR-の設定確認" class="headerlink" title="DCR の設定確認"></a>DCR の設定確認</h3><p>上記までの状態になれば NW ならびに DNS の構成は構築できているので、最後に実際にログを採取するための設定である DCR の設定ページを確認します。<br>DCR では、”ログの送り先の Log Analytics ワークスペース”および ”AMPLS 経由でログを送付するリソース（マシン）のデータ収集エンドポイント”は下図のように 図 4 で設定した AMPLS の [Azure Monitor リソース] である必用があります。</p><p>■図 6. DCR の [データ ソース] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/06.png"></p><p>■図 7. DCR の [リソース] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/07.png"></p><h3 id="Log-Analytics-ワークスペースに届いているログの確認"><a href="#Log-Analytics-ワークスペースに届いているログの確認" class="headerlink" title="Log Analytics ワークスペースに届いているログの確認"></a>Log Analytics ワークスペースに届いているログの確認</h3><p>上記まででログを採取できる構成になりました。最後に実際に Log Analytics ワークスペースに届いているログを確認します。</p><p>ハートビートログ（図 8, 対象テーブル：Heartbeat）、パフォーマンスカウンターログ（図 9, 対象テーブル：Perf）を正しく確認することが出来ました。<br>■図 8. Log Analytics ワークスペース - ハートビートログを確認している画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/08.png"></p><p>■図 9. Log Analytics ワークスペース - パフォーマンスカウンターログを確認している画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/09.png"></p><p>本日のご紹介は以上となります。上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;今回は、Azure Private Link  を使った Azure Arc および Azure Monitor を構成した際の DNS 構成</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="HowTo" scheme="https://jpazmon-integ.github.io/blog/tags/HowTo/"/>
    
    <category term="Azure Private Link" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Private-Link/"/>
    
    <category term="AMPLS" scheme="https://jpazmon-integ.github.io/blog/tags/AMPLS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Private Link  を使った Azure Arc への接続 - DNS 構成</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/</id>
    <published>2024-03-30T13:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.315Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。</p><p>今回は、Azure Private Link  を使った Azure Arc への接続時におけるDNS 構成例やオンボードする際の通信シーケンスを実際に検証環境を構成してご紹介いたします。<br>当ページの内容は <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/">Azure Private Link  を使った Azure Arc への接続 - NW 構成編</a> の内容を踏まえて記載しております。ご一読いただき当ページの内容を参照いただけますと幸いです。</p><p>ご説明にあたって、当方の検証環境は以下の通りです。<br>上部は <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security">当ページ</a> から抜粋した図であり、下部が検証環境のサーバーやエンドポイントの情報を添えた内容となります。</p><p>■図 1. 検証環境の構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/01.png"></p><h2 id="DNS-構成について"><a href="#DNS-構成について" class="headerlink" title="DNS 構成について"></a>DNS 構成について</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#configure-on-premises-dns-forwarding">オンプレミスの DNS 転送を構成する</a> に記載しておりますようにオンプレミスのマシンまたはサーバーでは、プライベート リンクの DNS レコードをプライベート エンドポイントの IP アドレスに解決できる必要があります。 </p><p>具体的には図 1 の右下の表に記載されている FQDN を Private Link がデプロイした際に同時に作成される下図 2. プライベート エンドポイントの IP アドレス（※1）に変換して通信できる環境が必要となります。<br>※1 今回の検証環境では 10.13.0.4 ～ 10.13.0.9 となります。</p><p>■図 2. プライベート エンドポイントの [DNS の構成] 画面<br><img src="/blog/Arc/Arc_AAMPLS_DNS/02.png"></p><p>これを実現する方法は<a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#configure-on-premises-dns-forwarding">オンプレミスの DNS 転送を構成する</a>  に記載のとおりとなりますが、次の 3 つの方法があります。</p><ul><li>Azure 統合プライベート DNS ゾーンを使用した DNS 構成</li><li>DNS サーバーの手動構成</li><li>単一サーバーのシナリオ</li></ul><h3 id="Azure-統合プライベート-DNS-ゾーンを使用した-DNS-構成"><a href="#Azure-統合プライベート-DNS-ゾーンを使用した-DNS-構成" class="headerlink" title="Azure 統合プライベート DNS ゾーンを使用した DNS 構成"></a>Azure 統合プライベート DNS ゾーンを使用した DNS 構成</h3><p>プライベート エンドポイント作成時に [プライベート DNS ゾーンと統合する] を ”はい”と設定するとプライベート DNS ゾーンがデプロイ時に生成されます。<br>このプライベート DNS ゾーンに FQDN から IP アドレスに変換する情報が記載されておりますが、この情報を参照する仕組みとなります。</p><p>詳細はこちらのページ <a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns-integration#on-premises-workloads-using-a-dns-forwarder">DNS フォワーダーを使用してオンプレミスのワークロード</a>  をご参照ください。</p><p>■図 3. プライベート エンドポイント作成時の画面<br><img src="/blog/Arc/Arc_AAMPLS_DNS/03.png"></p><h3 id="DNS-サーバーの手動構成"><a href="#DNS-サーバーの手動構成" class="headerlink" title="DNS サーバーの手動構成"></a>DNS サーバーの手動構成</h3><p>オンプレにあるマシンが参照する DNS サーバーの A レコードとして登録する仕組みです。<br>今回の検証ではこちらの仕組みを採用し、 DNS サーバー （IP アドレス 10.11.1.5） に下図 4 のようにレコードを登録します。<br>また Azure Arc へオンボードさせるマシンの DNS 参照先のアドレスを当サーバー（IP アドレス 10.11.1.5）に設定します。</p><p>■図 4. プライベート エンドポイントの [DNS の構成] 画面<br>下図は his.arc.azure.com ゾーンを示しております。<br><img src="/blog/Arc/Arc_AAMPLS_DNS/04.png"></p><h3 id="単一サーバーのシナリオ"><a href="#単一サーバーのシナリオ" class="headerlink" title="単一サーバーのシナリオ"></a>単一サーバーのシナリオ</h3><p>hosts ファイルに図 1 に記載しているエンドポイントの FQDN と IP アドレスの変換表を設定することで、プライベート エンドポイント向けの通信を実現させます。</p><h2 id="オンボード処理の通信シーケンスをみてみる"><a href="#オンボード処理の通信シーケンスをみてみる" class="headerlink" title="オンボード処理の通信シーケンスをみてみる"></a>オンボード処理の通信シーケンスをみてみる</h2><h3 id="検証構成"><a href="#検証構成" class="headerlink" title="検証構成"></a>検証構成</h3><p>下図 5 は 図 1 の下部の再掲となり、今回の検証環境の構成となります。<br>■図 5. 検証環境構成<br><img src="/blog/Arc/Arc_AAMPLS_DNS/05.png"></p><p>Arc にオンボードさせるマシンはコンピューター名が ”AAPLS001vm” となり、 IP アドレスは <code>10.11.1.4</code> となります。 DNS サーバーの IP アドレスは <code>10.11.1.5</code> となります。<br>■図 6. コンピューター  ”AAPLS001vm” のネットワーク構成<br><img src="/blog/Arc/Arc_AAMPLS_DNS/06.png"></p><p>また <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#troubleshooting">トラブルシューティング</a> に記載されている nslookup の結果は以下の通りとなり、DNS サーバーの設定したレコードとおりプライベート IP アドレスが返ってきます。<br>■図 7. コンピューター名 ”AAPLS001vm” のネットワーク構成<br><img src="/blog/Arc/Arc_AAMPLS_DNS/07.png"></p><h3 id="オンボード処理時のネットワークキャプチャ結果"><a href="#オンボード処理時のネットワークキャプチャ結果" class="headerlink" title="オンボード処理時のネットワークキャプチャ結果"></a>オンボード処理時のネットワークキャプチャ結果</h3><p>最後にコンピューター  ”AAPLS001vm” を Azure Arc へオンボードさせる際にネットワークキャプチャを採取して、どのような通信シーケンスになるか確認してみます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#connect-to-an-azure-arc-enabled-servers">Azure Arc 対応サーバーに接続する</a> の手順でダウンロードしたスクリプト <code>OnboardingScript.ps1</code> を実行します。</p><p>まず下図は  Azure Connected Machine エージェント （以後、Arc エージェントと呼称します）をダウンロードする際の DNS 通信と <code>download.microsoft.com</code>との通信時のキャプチャとなります。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/network-requirements?tabs=azure-cloud#urls">通信要件</a> に記載されている FQDN <code>aka.ms</code> と <code>download.microsoft.com</code> の IP アドレスが解決（図8）され、ダウンロード処理の通信（図9）が確認できます。</p><p>■図 8. Arc エージェントをダウンロードする際の DNS 通信のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/08.png"></p><p>■図 9. <code>download.microsoft.com</code>との通信時のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/09.png"></p><p>続けてインストールされた Arc エージェントにより Azure Arc へオンボードする際の通信についてです。<br>実際にはスクリプト <code>OnboardingScript.ps1</code> に記載している下記スクリプト（サブスクリプション ID など一部リソース情報をマスキングしております）の処理によりオンボードします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\tmp&gt; &amp; &quot;$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe&quot; connect --resource-group &quot;$env:RESOURCE_GROUP&quot; --tenant-id &quot;$env:TENANT_ID&quot; --location &quot;$env:LOCATION&quot; --subscription-id &quot;$env:SUBSCRIPTION_ID&quot; --cloud &quot;$env:CLOUD&quot; --private-link-scope &quot;/subscriptions/XXX/resourceGroups/AAPLS/providers/Microsoft.HybridCompute/privateLinkScopes/AAPLS001&quot; --correlation-id &quot;$env:CORRELATION_ID&quot;;</span><br><span class="line">INFO    Connecting machine to Azure... This might take a few minutes.</span><br><span class="line">INFO    Testing connectivity to endpoints that are needed to connect to Azure... This might take a few minutes.</span><br><span class="line">INFO    Please login using the pop-up browser to authenticate.</span><br><span class="line">  20% [==&gt;            ]</span><br><span class="line">  30% [===&gt;           ]</span><br><span class="line">  INFO    Creating resource in Azure...                 Correlation ID=YYY Resource ID=/subscriptions/XXXX/resourceGroups/AAPLS/providers/Microsoft.HybridCompute/machines/AAPLS001vm</span><br><span class="line">  60% [========&gt;      ]</span><br><span class="line">  80% [===========&gt;   ]</span><br><span class="line"> 100% [===============]</span><br><span class="line">  INFO    Connected machine to Azure</span><br><span class="line">INFO    Machine overview page: https://portal.azure.com/#@yyyy/resource/subscriptions/xxxx/resourceGroups/AAPLS/providers/Microsoft.HybridCompute/machines/AAPLS001vm/overview</span><br></pre></td></tr></table></figure><p>■図 10. オンボード処理<br><img src="/blog/Arc/Arc_AAMPLS_DNS/10.png"></p><p>上記処理の時の DNS 通信と <code>je.his.arc.azure.com</code> との通信時のキャプチャとなります。<br>図11 に注目いただくと DNS サーバーに登録したプライベート エンドポイントの FQDN については名前解決した結果、プライベート IP アドレスになっていることがわかります。<br>一方 <code>management.azure.com</code> の IP アドレスは <code>4.150.240.10</code> というグローバル IP アドレスとなっていることがわかります。<br>このようにプライベート エンドポイントが作成された宛先（FQDN）については、プライベート IP アドレスの応答を正しく受けれない構成の場合、正しく通信ができないこととなります。<br>また図 12 のとおり、プライベート IP アドレスとして応答受けた  ‘je.his.arc.azure.com‘ の宛先と通信シーケンスが進んでいることがわかります。</p><p>■図 11. オンボード処理の際の DNS 通信のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/11.png"></p><p>■図 12. <code>je.his.arc.azure.com</code> との通信時のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/12.png"></p><p>問題なく Arc へオンボードできれば下図 13. のようにオンボードしたコンピューター  ”AAPLS001vm” のステータスを確認することが可能となります。</p><p>■図 13.  Azure ポータルでオンボード状態を確認する際の画面<br><img src="/blog/Arc/Arc_AAMPLS_DNS/13.png"></p><p>本日のご紹介は以上となります。上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;今回は、Azure Private Link  を使った Azure Arc への接続時におけるDNS 構成例やオンボードする際の通信シーケン</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="HowTo" scheme="https://jpazmon-integ.github.io/blog/tags/HowTo/"/>
    
    <category term="Azure Private Link" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Private-Link/"/>
    
  </entry>
  
  <entry>
    <title>Azure Private Link  を使った Azure Arc への接続 - NW 構成</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/</id>
    <published>2024-03-30T08:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.327Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。</p><p>今回は、Azure Private Link を使った Azure Arc への接続に関するよくあるお問い合わせ内容とその回答について紹介したいと思います。<br>Azure Arc にオンボードさせるにはオンプレミスマシン（もしくは AWS のようなクラウド上の VM）には、Azure Connected Machine エージェント （以後、Arc エージェントと呼称します）をインストールする必要があります。</p><p>その Arc エージェントを使用して Azure Arc にオンボード（管理状態）にするには以下ネットワーク要件を満たす必要がございます。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/network-requirements?tabs=azure-cloud">Connected Machine エージェントのネットワーク要件</a></p><p>ここで Azure Private Link を使った Azure Arc への接続については以下ページに基本構成を記載しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security">Azure Private Link を使用して、サーバーを Azure Arc に安全に接続する</a></p><p>上記ページに記載しておりますが、Azure Private Link を使った Azure Arc への接続は以下が基本構成となります。<br>一部情報補記しております<br>■図1 Azure Private Link を使った Azure Arc 構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_NW/01.png"></p><p>※1 2023 年 7 月に <a href="https://news.microsoft.com/ja-jp/2023/07/12/230712-azure-ad-is-becoming-microsoft-entra-id/">Microsoft Entra ID</a> と名前が変わっております。<br>※2 後述する説明のために ExpressRoute などの Azure 側の終端となる <em>仮想ネットワーク ゲートウェイ</em> の情報を記載しております。</p><h2 id="Q1-AAD-と-ARM-には閉域で接続できるか"><a href="#Q1-AAD-と-ARM-には閉域で接続できるか" class="headerlink" title="Q1. AAD と ARM には閉域で接続できるか"></a>Q1. AAD と ARM には閉域で接続できるか</h2><p>まず上図 1 とネットワーク要件に記載されている内容で多くのお問い合わせいただく以下 QA から説明します。</p><p>Q1.<br>AAD (Azure Active Directory) および ARM (Azure Resource Manager) に閉域で接続できますか？</p><p>A1.<br>いいえ。接続できません。</p><p><em>説明</em><br>上記ネットワーク要件を記載している <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/network-requirements?tabs=azure-cloud#urls">ページ</a> に記載しておりますとおり、下図の <code>プライベートリンクで使用されるエンドポイント</code> 列に ”パブリック” と表記されている列の宛先 （aks.ms や download.microsoft.com）はインターネット経由で接続する必要がございます。</p><p>■図2. NW 要件<br><img src="/blog/Arc/Arc_AAMPLS_NW/02.png"></p><p>上図 1 で言及しますと “On-premises network” から上に Firewall を超え、インターネット経由で AAD および ARM へ接続されるイメージがわかるかと存じます。</p><h2 id="Q2-AAD-と-ARM-への通信を-Azure-network-経由で通信できるか"><a href="#Q2-AAD-と-ARM-への通信を-Azure-network-経由で通信できるか" class="headerlink" title="Q2. AAD と ARM への通信を Azure network 経由で通信できるか"></a>Q2. AAD と ARM への通信を Azure network 経由で通信できるか</h2><p>ここで On-premises network から AAD と ARM への通信も Azure network 経由で接続できるかについて説明いたします。</p><p>■図3.  通信イメージ<br><img src="/blog/Arc/Arc_AAMPLS_NW/03.png"></p><p>Q2.<br>AAD (Azure Active Directory) および ARM (Azure Resource Manager) への通信を Azure network 経由で接続できますか？</p><p>A2.<br>仕組み上可能となりますが、推奨しておりません。<br>まず仮想ネットワーク ゲートウェイにはインターネットへ接続するための機能は持っておりません。そのため、インターネットへ接続するためのサービスなどをお客様の Azure network 環境に構築いただく必要がございますが、追加の機能のデプロイや設定が必要となり 2024 年 3 月時点で当社としては推奨しておりません。</p><h2 id="Q3-公開情報の『ネットワーク構成』に記載されているオプション-1-はどのようなシナリオですか。"><a href="#Q3-公開情報の『ネットワーク構成』に記載されているオプション-1-はどのようなシナリオですか。" class="headerlink" title="Q3.  公開情報の『ネットワーク構成』に記載されているオプション 1 はどのようなシナリオですか。"></a>Q3.  公開情報の『ネットワーク構成』に記載されているオプション 1 はどのようなシナリオですか。</h2><p>上記に関連して公開情報 の <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#network-configuration">ネットワーク構成</a> に記載されている下図のオプション 1 の以下文言について質問を頂戴することがあります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">インターネットに送信されるすべてのトラフィックを Azure VPN または ExpressRoute 回線経由でルーティングするようにネットワークが構成されている場合</span><br></pre></td></tr></table></figure><p>■図4. オプション 1 の説明箇所<br><img src="/blog/Arc/Arc_AAMPLS_NW/04.png"></p><p>Q3.<br>公開情報の『ネットワーク構成』に記載されているオプション 1 はどのようなシナリオですか。</p><p>A3.<br>Azure network からインターネット（パブリック エンドポイント）へ通信させる場合に、全てのトラフィックを On-premises network へルーティングする場合となります。<br>上図 1 ですと “Azure network” から左の  “On-premises network” へルーティングすることを意図しております。<br>具体的なルーティング設定の例としては “On-premises network” 側のお客様 NW 機器などから BGP にて デフォルトルート （0.0.0.0/0）の広告が仮想ネットワーク ゲートウェイ側に届いている場合のシナリオとなります。</p><p>本日のご紹介は以上となります。上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;今回は、Azure Private Link を使った Azure Arc への接続に関するよくあるお問い合わせ内容とその回答について紹介した</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="HowTo" scheme="https://jpazmon-integ.github.io/blog/tags/HowTo/"/>
    
    <category term="Azure Private Link" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Private-Link/"/>
    
  </entry>
  
  <entry>
    <title>Application Insights にテレメトリが保存されなかった場合のトラブルシューティングについて</title>
    <link href="https://jpazmon-integ.github.io/blog/applicationInsights/troubleshooting_telemetry/"/>
    <id>https://jpazmon-integ.github.io/blog/applicationInsights/troubleshooting_telemetry/</id>
    <published>2024-02-29T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.527Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北山です。</p><p>App Service や Azure VM などにデプロイいただいている Web アプリケーションのパフォーマンスを監視するために、Application Insights をご利用いただいているケースがございます。<br>監視対象の Web アプリケーションから Application Insights リソースに対してテレメトリ (ログやメトリックなどの情報) を送信することで、Web アプリケーションのパフォーマンス監視が可能です。<br>しかし、場合によっては監視対象の Web アプリケーションから Application Insights リソースに対してテレメトリが送信されないケースがございます。</p><blockquote><p>例 : Application Insights リソースの requests テーブルや traces テーブルに、突然ログが保存されなくなった。requests テーブルにはログが記録されているのに、突然 traces テーブルのログが記録されなくなったなど。</p></blockquote><p>このような問題が発生した場合に、問題解消のためにチェックすべきポイントについて記載いたします。<br>問題発生時によろしければご参考ください。</p><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E3%82%B1%E3%83%BC%E3%82%B9-1-%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%81%AE%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%8C-application-insights-%E3%81%AB%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%8F%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F">ケース 1. すべての種類のテレメトリが Application Insights にまったく収集されなくなった</a><ul><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81">問題の概要</a></li><li><a href="#%E7%96%91%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">疑われるポイント</a></li></ul></li><li><a href="#%E3%82%B1%E3%83%BC%E3%82%B9-2-%E4%B8%80%E9%83%A8%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%81%AE%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%8C-application-insights-%E3%81%AB%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%8F%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F">ケース 2. 一部の種類のテレメトリが Application Insights にまったく収集されなくなった</a><ul><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-1">問題の概要</a></li><li><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E3%81%82%E3%81%A3%E3%81%9F%E3%82%B1%E3%83%BC%E3%82%B9">実際にあったケース</a></li></ul></li><li><a href="#%E3%82%B1%E3%83%BC%E3%82%B9-3-%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%8F-application-insights-%E3%81%AB%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%8C%E5%8F%8E%E9%9B%86%E5%87%BA%E6%9D%A5%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8C%E6%99%82%E3%80%85%E6%9C%9F%E5%BE%85%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%8C%E6%AC%A0%E8%90%BD%E3%81%99%E3%82%8B">ケース 3. 問題なく Application Insights にテレメトリが収集出来ているが、時々期待したログが欠落する</a><ul><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-2">問題の概要</a></li><li><a href="#%E7%96%91%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88-1">疑われるポイント</a></li></ul></li><li><a href="#%E8%89%B2%E3%80%85%E8%AA%BF%E3%81%B9%E3%81%9F%E3%81%91%E3%81%A9%E5%95%8F%E9%A1%8C%E3%81%8C%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88">色々調べたけど問題が解決しない場合……</a></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li><li><a href="#%E9%96%A2%E9%80%A3%E3%81%99%E3%82%8B%E8%A8%98%E4%BA%8B">関連する記事</a></li></ul><h1 id="ケース-1-すべての種類のテレメトリが-Application-Insights-にまったく収集されなくなった"><a href="#ケース-1-すべての種類のテレメトリが-Application-Insights-にまったく収集されなくなった" class="headerlink" title="ケース 1. すべての種類のテレメトリが Application Insights にまったく収集されなくなった"></a>ケース 1. すべての種類のテレメトリが Application Insights にまったく収集されなくなった</h1><h2 id="問題の概要"><a href="#問題の概要" class="headerlink" title="問題の概要"></a>問題の概要</h2><ul><li>今までは問題なく Application Insights に各種テレメトリ (requests ログや traces ログ、dependencies ログなど) が収集されていた。</li><li>しかし突然、すべての種類のテレメトリが Application Insights に収集されなくなった。</li></ul><h2 id="疑われるポイント"><a href="#疑われるポイント" class="headerlink" title="疑われるポイント"></a>疑われるポイント</h2><h3 id="その-1-通信のトラブル"><a href="#その-1-通信のトラブル" class="headerlink" title="その 1. 通信のトラブル"></a>その 1. 通信のトラブル</h3><p>突然すべてのテレメトリが Application Insights に収集されなくなった場合、Application Insights のエンドポイントに対して通信が失敗している可能性がございます。<br>例えば下記のような契機によって、すべてのテレメトリが突然収集できなくなる可能性がございます。</p><ul><li>監視対象の Web アプリケーションを App Service にデプロイしており、App Service リソースに対して VNET 統合を実施した。</li><li>監視対象の Web アプリケーションを Azure VM にデプロイしており、関連する VNET に紐づいた NSG や Azure Firewall の設定を変更した。など</li></ul><p>上記のような作業を実施したことで、Application Insights のエンドポイントと通信が出来ずテレメトリの収集に失敗している可能性がございます。</p><p>ちなみに Application Insights に対してテレメトリを送信するためには、Application Insights のエンドポイントに関連する URL に通信が可能な状態である必要がございます。</p><blockquote><p>「目的」がテレメトリの箇所の URL をご確認ください。</p></blockquote><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/ip-addresses#outgoing-ports">Azure Monitor で使用される IP アドレス # 送信ポート</a><br><img src="/blog/applicationInsights/troubleshooting_telemetry/pict1.png"></li></ul><p>もしくは、もしサービス タグを用いて通信制御を構築している場合、監視対象の Web アプリケーションから外向きの通信に対して AzureMonitor サービス タグに対する通信許可が必要です。<br>ポート番号は 443 番に対して通信許可をご構築ください。</p><p>そのため、例えば VNET 統合した App Service リソースから「dc.applicationinsights.azure.com」に対する名前解決が失敗する、通信でタイムアウトが発生している場合、突然すべての種類のテレメトリが宛先の Application Insights に対して送信できなくなる可能性がございます。</p><h3 id="Application-Insights-への通信を確認する方法"><a href="#Application-Insights-への通信を確認する方法" class="headerlink" title="Application Insights への通信を確認する方法"></a>Application Insights への通信を確認する方法</h3><h4 id="App-Service-や-Azure-Functions-に-Web-アプリケーションをデプロイしている場合"><a href="#App-Service-や-Azure-Functions-に-Web-アプリケーションをデプロイしている場合" class="headerlink" title="App Service や Azure Functions に Web アプリケーションをデプロイしている場合"></a>App Service や Azure Functions に Web アプリケーションをデプロイしている場合</h4><p>下記の手順で当該コンピューターから Application Insights へ通信が可能であるかどうかをご確認ください。</p><h5 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h5><ol><li><p>当該 Application Insights リソース ページへ移動します。</p></li><li><p>概要ページに記載がある接続文字列をコピーいただき、[IngestionEndpoint] に指定がある URL のホスト名をコピーします。<br>例 : 「<code>IngestionEndpoint=https://japaneast-0.in.applicationinsights.azure.com/</code>」の場合は、「japaneast-0.in.applicationinsights.azure.com」をコピーします。<br>もしくは、グローバル インジェスト エンドポイントのホストである「dc.applicationinsights.azure.com」を使います。<br>接続文字列を用いて Application Insights と統合する場合は、接続文字列に記載があるホストに対して通信します。<br>接続文字列ではなくインストルメンテーション キーを用いて Application Insights と統合する場合は、dc.applicationinsights.azure.com に対して通信します。<br><img src="/blog/applicationInsights/troubleshooting_telemetry/pict2.png"></p></li><li><p>当該 App Service リソース ページへ移動します。</p></li><li><p>左側ペインの [高度なツール] をクリックし、[移動] をクリックします。</p></li><li><p>画面上部の [Debug console - PowerShell] をクリックします。<br>Linux の場合おは[SSH] をクリックします。</p></li><li><p>下記コマンドを実行し、名前解決が可能であるかどうかご確認ください。</p></li></ol><p><strong>Linux の場合</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup japaneast-0.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><p>もし名前解決が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image.png" alt="Alt text"></p><p>正常に名前解決出来る場合は、下図のように IP アドレスが表示されます。<br>※ 下図の環境は AMPLS を構築しているため、プライベート エンドポイントの IP アドレスが表示されております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-1.png" alt="Alt text"></p><p><strong>Windows の場合</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameresolver &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameresolver japaneast-1.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><p>もし名前解決が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-3.png" alt="Alt text"></p><p>正常に名前解決出来る場合は、下図のように IP アドレスが表示されます。<br>※ 下図の環境は AMPLS を構築しているため、プライベート エンドポイントの IP アドレスが表示されております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-2.png" alt="Alt text"></p><ol start="7"><li>下記コマンドを実行し、Application Insights のエンドポイントと通信が可能かご確認ください。  </li></ol><p><strong>Linux の場合</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://&lt;2 でコピーした値&gt;:443</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://japaneast-0.in.applicationinsights.azure.com:443</span><br></pre></td></tr></table></figure><p>もし宛先と通信が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-7.png" alt="Alt text"></p><p>もし 404 が返ってきた場合は正常に通信が出来ております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-4.png" alt="Alt text"></p><p><strong>Windows の場合</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpping &lt;2 でコピーした値&gt;:443</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpping japaneast-1.in.applicationinsights.azure.com:443</span><br></pre></td></tr></table></figure><p>もし宛先と通信が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-6.png" alt="Alt text"></p><p>もし、「Complete: 4/4 successful attempts (100%)」が出力された場合は、正常に通信出来ております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-5.png" alt="Alt text"></p><p>App Service や Azure Functions の場合、nslookup や ping は機能しません。<br>そのため、nameresolver や tcpping を利用しております。<br>詳細は下記の公開情報をご参考ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/app-service/troubleshoot-vnet-integration-apps#troubleshoot-outbound-connectivity-on-windows-apps">仮想ネットワークとAzure App Serviceの統合のトラブルシューティング # Windows Apps での送信接続のトラブルシューティング</a>  </li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict3.png"></p><h4 id="Azure-VM-やオンプレミス環境のコンピューターに-Web-アプリケーションをデプロイしている場合"><a href="#Azure-VM-やオンプレミス環境のコンピューターに-Web-アプリケーションをデプロイしている場合" class="headerlink" title="Azure VM やオンプレミス環境のコンピューターに Web アプリケーションをデプロイしている場合"></a>Azure VM やオンプレミス環境のコンピューターに Web アプリケーションをデプロイしている場合</h4><p>下記の手順で当該コンピューターから Application Insights へ通信が可能であるかどうかをご確認ください。</p><h5 id="手順-1"><a href="#手順-1" class="headerlink" title="手順"></a>手順</h5><ol><li><p>当該 Application Insights リソース ページへ移動します。</p></li><li><p>概要ページに記載がある接続文字列をコピーいただき、[IngestionEndpoint] に指定がある URL のホスト名をコピーします。<br>例 : 「<code>IngestionEndpoint=https://japaneast-0.in.applicationinsights.azure.com/</code>」の場合は、「japaneast-0.in.applicationinsights.azure.com」をコピーします。<br><img src="/blog/applicationInsights/troubleshooting_telemetry/pict2.png"></p></li><li><p>当該コンピューターにリモートで接続いただき、下記コマンドを実行し、名前解決が可能であるかどうかご確認ください。もし名前解決に失敗する場合は、DNS 周りに何か問題があるかもしれません。</p></li></ol><p><strong>Linux の場合</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup japaneast-0.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><p><strong>Windows の場合 (PowerShell で実行)</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup japaneast-0.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><ol start="4"><li>下記コマンドを実行し、Application Insights のエンドポイントと通信が可能かご確認ください。もし通信に失敗する場合、ファイアウォールや NSG の設定などに問題があるかもしれません。</li></ol><p><strong>Linux の場合</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://&lt;2 でコピーした値&gt;:443</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://japaneast-0.in.applicationinsights.azure.com:443</span><br></pre></td></tr></table></figure><p><strong>Windows の場合 (PowerShell で実行)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test-NetConnection -ComputerName &lt;2 でコピーした値&gt; -Port 443</span><br></pre></td></tr></table></figure><p>例 :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test-NetConnection -ComputerName japaneast-0.in.applicationinsights.azure.com -Port 443</span><br></pre></td></tr></table></figure><p>もし監視対象のコンピューターや App Service から Application Insights への通信が失敗しているようなら、一度通信環境の見直しをお願いします。</p><h3 id="その-2-日時上限の制限抵触"><a href="#その-2-日時上限の制限抵触" class="headerlink" title="その 2. 日時上限の制限抵触"></a>その 2. 日時上限の制限抵触</h3><p>クラシック・ワークスペース ベースの両方に、日時上限の設定が可能です。<br>もし日時上限の制限に抵触していた場合、Application Insights リソースへのテレメトリ取り込みがストップします。</p><p>クラシック Application Insights リソースにて日時上限が発生した場合、当該 Application Insights リソースのアクティビティ ログが出力されます。<br>出力されるアクティビティ ログは、下記公開情報に記載があるログです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap#classic-application-insights-resource">Log Analytics ワークスペースの日次上限を設定する # 従来の Application Insights リソース</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict4.png"></p><p>ワークスペース ベースの Application Insights の場合、Application Insights リソース側もしくは Application Insights リソースに紐づいた Log Analytics ワークスペース側に日時上限の設定が可能です。  </p><p>もし Application Insights リソース側に日時上限の設定 10 GB を設定し、Log Analytics ワークスペース側に 100 GB を設定した場合、データ サイズが少ない Application Insights リソース側の日時上限に抵触した段階でテレメトリの取り込みがストップします。  </p><p>もし Application Insights リソース側の日時上限に抵触した場合は、前述のアクティビティ ログが出力されます。  </p><p>一方で、<strong>「Application Insights リソース側の日時上限データ サイズ &gt; Log Analytics ワークスペース側の日時上限データ サイズ」</strong> の場合は、Log Analytics ワークスペース側の制限に抵触し、テレメトリの取り込みがストップします。<br>この場合は、Log Analytics ワークスペース側にて <code>_LogOperation | where Category =~ &quot;Ingestion&quot; | where Detail contains &quot;OverQuota&quot;</code> のクエリを実行することで、日時上限に抵触したかどうかの判断が可能です。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap#alert-when-daily-cap-is-reached">Log Analytics ワークスペースの日次上限を設定する # 1 日の上限に達したら警告する</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict5.png"></p><p>日時上限に抵触してテレメトリの取り込みがストップしたかどうかは、上記の内容でご判断ください。<br>その他参考資料はこちらです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/daily-cap-unexpected-behaviors">Application Insights の日次上限の予期しない動作</a></li></ul><h3 id="その-3-AMPLS-による意図的なテレメトリ取り込みの拒否"><a href="#その-3-AMPLS-による意図的なテレメトリ取り込みの拒否" class="headerlink" title="その 3. AMPLS による意図的なテレメトリ取り込みの拒否"></a>その 3. AMPLS による意図的なテレメトリ取り込みの拒否</h3><p>もしお客様の環境にて AMPLS をご利用いただいており、Application Insights への通信を AMPLS のプライベート エンドポイント経由で行っている場合に発生する可能性がございます。</p><p>例えば下図の VNET 上に Web アプリケーションがデプロイされた Azure VM が存在する場合。<br>下図の VNET と統合した App Service・Azure Functions が存在する場合などです。</p><p><img src="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/media/private-link-security/private-link-basic-topology.png#lightbox"></p><p>上記のような環境の場合、Application Insights のエンドポイントのホスト名に対して名前解決を実施すると、AMPLS に紐づいたプライベート エンドポイントの IP アドレスに変換されます。  </p><blockquote><p>Global IP アドレスではなく、Private IP アドレスに変換されます。</p></blockquote><p>例えば通常の場合、dc.services.visualstudio.com (Application Insights エンドポイントの一部のホスト名) に対して名前解決を実施すると、下記のように Global IP アドレスに変換されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict6.png"></p><p>一方で AMPLS の環境を構築している場合、名前解決した結果下記のように Private IP アドレスに変換されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict7.png"></p><p>このように AMPLS に紐づいたプライベート エンドポイントに対する通信が発生する場合に、AMPLS 側の設定によってテレメトリが意図的に Application Insights に取り込まれない可能性があります。</p><p>例えば下記のような設定の場合を想定します。</p><p><strong>AMPLS の「インジェスト アクセス モード」が「プライベートのみ」</strong></p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict8.png"></p><p><strong>AMPLS に対して、宛先の Application Insights リソースが追加されていない</strong></p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict9.png"></p><p>このような状況で、監視対象 Web アプリケーションからプライベート エンドポイント経由で Application Insights にテレメトリを送信しようとした場合、AMPLS 側でテレメトリの取り込みが拒否されます。</p><blockquote><p>下図は、PowerShell スクリプトを使って Application Insights にテレメトリの送信を試みている状況を表しております。Application Insights のエンドポイントから 403 が返ってきている事がわかります。</p></blockquote><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict10.png"></p><p>もしお客様の環境で Application Insights へのテレメトリ送信を試されたい場合は、下記の PowerShell コマンドを Kudu や Azure VM のゲスト OS などから実行ください。</p><p>※ 下記 PowerShell スクリプトは、当該 Application Insights リソースに対して availabilityResults テーブルにテスト用のログを送信するためのスクリプトです。詳細は<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/investigate-missing-telemetry#powershell-script-send-availability-test-result">可用性テスト結果を送信する PowerShell スクリプト</a> の公開情報をご確認ください。<br>※ $ConnectionString の変数に対して、適宜当該 Application Insights リソースの接続文字列の値をご指定ください。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Info: Provide either the Connection String or Ikey for your Application Insights Resource</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ConnectionString</span> = <span class="string">&quot;InstrumentationKey=XXXXXXXX;IngestionEndpoint=https://japaneast-1.in.applicationinsights.azure.com/;LiveEndpoint=https://japaneast.livediagnostics.monitor.azure.com/&quot;</span> </span><br><span class="line"><span class="variable">$InstrumentationKey</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ParseConnectionString</span></span> &#123;</span><br><span class="line"><span class="keyword">param</span> ([<span class="built_in">string</span>]<span class="variable">$ConnectionString</span>)</span><br><span class="line">  <span class="variable">$Map</span> = <span class="selector-tag">@</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$Part</span> <span class="keyword">in</span> <span class="variable">$ConnectionString</span>.Split(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">     <span class="variable">$KeyValue</span> = <span class="variable">$Part</span>.Split(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">     <span class="variable">$Map</span>.Add(<span class="variable">$KeyValue</span>[<span class="number">0</span>], <span class="variable">$KeyValue</span>[<span class="number">1</span>])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$Map</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># If Ikey is the only parameter supplied, we&#x27;ll send telemetry to the </span></span><br><span class="line"><span class="comment"># global ingestion endpoint instead of regional endpoint found in connection strings</span></span><br><span class="line"><span class="keyword">If</span> ((<span class="variable">$InstrumentationKey</span>) <span class="operator">-and</span> (<span class="string">&quot;&quot;</span> <span class="operator">-eq</span> <span class="variable">$ConnectionString</span>)) &#123;</span><br><span class="line"><span class="variable">$ConnectionString</span> = <span class="string">&quot;InstrumentationKey=<span class="variable">$InstrumentationKey</span>;IngestionEndpoint=https://dc.services.visualstudio.com/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$map</span> = ParseConnectionString(<span class="variable">$ConnectionString</span>)</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$map</span>[<span class="string">&quot;IngestionEndpoint&quot;</span>] + <span class="string">&quot;v2/track&quot;</span></span><br><span class="line"><span class="variable">$ikey</span> = <span class="variable">$map</span>[<span class="string">&quot;InstrumentationKey&quot;</span>]</span><br><span class="line"><span class="variable">$lmUrl</span> = <span class="variable">$map</span>[<span class="string">&quot;LiveEndpoint&quot;</span>]</span><br><span class="line"> </span><br><span class="line"><span class="variable">$time</span> = (<span class="built_in">Get-Date</span>).ToUniversalTime().ToString(<span class="string">&quot;o&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="variable">$availabilityData</span> = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;baseData&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;ver&quot;: 2,</span></span><br><span class="line"><span class="string">            &quot;id&quot;: &quot;SampleRunId&quot;,</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;Microsoft Support Sample Webtest Result&quot;,</span></span><br><span class="line"><span class="string">            &quot;duration&quot;: &quot;00.00:00:10&quot;,</span></span><br><span class="line"><span class="string">            &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;runLocation&quot;: &quot;Region Name&quot;,</span></span><br><span class="line"><span class="string">            &quot;message&quot;: &quot;Sample Webtest Result&quot;,</span></span><br><span class="line"><span class="string">            &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;Sample Property&quot;: &quot;Sample Value&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;baseType&quot;: &quot;AvailabilityData&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;ver&quot;: 1,</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;Microsoft.ApplicationInsights.Metric&quot;,</span></span><br><span class="line"><span class="string">  &quot;time&quot;: &quot;<span class="variable">$time</span>&quot;,</span></span><br><span class="line"><span class="string">  &quot;sampleRate&quot;: 100,</span></span><br><span class="line"><span class="string">  &quot;iKey&quot;: &quot;<span class="variable">$iKey</span>&quot;,</span></span><br><span class="line"><span class="string">  &quot;flags&quot;: 0</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;@</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># Uncomment one or more of the following lines to test client TLS/SSL protocols other than the machine default option</span></span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::SSL3</span></span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::TLS</span></span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::TLS11</span></span><br><span class="line">[<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.SecurityProtocolType</span>]::TLS12</span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::TLS13</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$ProgressPreference</span> = <span class="string">&quot;SilentlyContinue&quot;</span></span><br><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="variable">$url</span> <span class="literal">-Method</span> POST <span class="literal">-Body</span> <span class="variable">$availabilityData</span> <span class="literal">-UseBasicParsing</span></span><br></pre></td></tr></table></figure><p>宛先から 403 が返って来た場合は、AMPLS によって拒否されている可能性が高いです。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-8.png" alt="Alt text"></p><p>正常時は、宛先から 200 番が返却されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-9.png" alt="Alt text"></p><p>そして宛先の Application Insights リソースの availabilityResults テーブルに、下記のようなログが記録されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">availabilityResults</span><br><span class="line">| where message =~ &#x27;Sample Webtest Result&#x27;</span><br></pre></td></tr></table></figure><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-10.png" alt="Alt text"></p><p>上記は PowerShell スクリプトですが、Linux の場合は下記の CURL コマンドを実行することで確認可能です。</p><p>※ 下記 CURL コマンドの詳細は<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/investigate-missing-telemetry#curl-command-send-availability-test-result">Curl コマンドを使用して可用性テスト結果を送信する</a> の公開情報をご確認ください。<br>※ iKey の XXX の箇所には、適宜当該 Application Insights リソースのインストルメンテーション キーの値をご指定ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type: application/json&quot; -X POST -d &#x27;&#123;&quot;data&quot;:&#123;&quot;baseData&quot;:&#123;&quot;ver&quot;:2,&quot;id&quot;:&quot;SampleRunId&quot;,&quot;name&quot;:&quot;MicrosoftSupportSampleWebtestResultUsingCurl&quot;,&quot;duration&quot;:&quot;00.00:00:10&quot;,&quot;success&quot;:true,&quot;runLocation&quot;:&quot;RegionName&quot;,&quot;message&quot;:&quot;SampleWebtestResult&quot;,&quot;properties&quot;:&#123;&quot;SampleProperty&quot;:&quot;SampleValue&quot;&#125;&#125;,&quot;baseType&quot;:&quot;AvailabilityData&quot;&#125;,&quot;ver&quot;:1,&quot;name&quot;:&quot;Microsoft.ApplicationInsights.Metric&quot;,&quot;time&quot;:&quot;2022-09-01T12:00:00.0000000Z&quot;,&quot;sampleRate&quot;:100,&quot;iKey&quot;:&quot;XXXXXXXXXXXX&quot;,&quot;flags&quot;:0&#125;&#x27; https://japaneast-1.in.applicationinsights.azure.com/v2.1/track</span><br></pre></td></tr></table></figure><p>もし AMPLS によってテレメトリの取り込みが拒否された場合、同じように 403 エラーが宛先から返却されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-11.png" alt="Alt text"></p><p>このように AMPLS 側でインジェストが拒否される振る舞いは仕様どおりです。<br>下記の公開情報に記載がございますが、AMPLS のインジェスト アクセス モードが「プライベートのみ」の場合は、宛先となる Application Insights リソースを当該 AMPLS に追加する必要がございます。<br>そうしないと、テレメトリの取り込みが拒否されます。<br>この点について十分ご留意くださいませ。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-design#control-how-private-links-apply-to-your-networks">プライベート リンクをネットワークに適用する方法を制御する</a>  </li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict12.png"></p><p>もし当該 AMPLS のインジェスト アクセス モードが「プライベートのみ」の場合は、このような原因でテレメトリが取り込まれなくなる可能性があります。<br>一度当該 AMPLS リソースをご確認いただき、当該 Application Insights リソースが追加されているか、追加されている Application Insights リソースのプロビジョニング状態が「Succeeded」であるかどうかを、ご確認ください。  </p><p>ちなみに Application Insights リソースのプロビジョニング状態が「Failed」の場合、プライベート エンドポイントに紐づく VNET のサブネットの IP アドレスが枯渇している可能性がございます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict13.png"></p><p>当該 VNET のページから「使用可能な IP」をご確認いただく事で枯渇しているかどうか確認可能です。<br>もし IP アドレスが足りないようでしたら、拡張いただくようご検討ください。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict14.png"></p><blockquote><p>サポートされる最小の IPv4 のサブネットは /27 です。 割り当て可能な IP アドレスの数に要注意です。</p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-design#requirements">Azure Private Link のセットアップを設計する # ネットワーク サブネットのサイズ</a></p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict11.png"></p><p>もし IP アドレスの数に問題が無いのにもかかわらずプロビジョニング状態が「Failed」の場合、一度適当なリソースを AMPLS から削除いただき、改めて追加してください。<br>それでも問題が改善しない場合は、お手数ではございますがサポート リクエストをご起票ください。</p><h1 id="ケース-2-一部の種類のテレメトリが-Application-Insights-にまったく収集されなくなった"><a href="#ケース-2-一部の種類のテレメトリが-Application-Insights-にまったく収集されなくなった" class="headerlink" title="ケース 2. 一部の種類のテレメトリが Application Insights にまったく収集されなくなった"></a>ケース 2. 一部の種類のテレメトリが Application Insights にまったく収集されなくなった</h1><h2 id="問題の概要-1"><a href="#問題の概要-1" class="headerlink" title="問題の概要"></a>問題の概要</h2><ul><li>requests ログや dependencies ログは収集されているのに、traces ログが収集されなくなった。</li></ul><h2 id="実際にあったケース"><a href="#実際にあったケース" class="headerlink" title="実際にあったケース"></a>実際にあったケース</h2><h3 id="ケース-1-NET-Framework-から-NET-へ移行したことで、収集されるログ-レベルの既定値が変わった"><a href="#ケース-1-NET-Framework-から-NET-へ移行したことで、収集されるログ-レベルの既定値が変わった" class="headerlink" title="ケース 1. .NET Framework から .NET へ移行したことで、収集されるログ レベルの既定値が変わった"></a>ケース 1. .NET Framework から .NET へ移行したことで、収集されるログ レベルの既定値が変わった</h3><p>監視対象 Web アプリケーションのランタイムが .NET Framework の場合には、問題なくログを traces テーブルに保存が出来ていた。<br>しかし Web アプリケーションのランタイムを .NET 6 などに移行すると、Warn や Error ログは出力されるのに Information のログが出力されなくなった。  </p><p>このような事例の場合、収集されるログ レベルの既定値の影響の可能性が非常に高いです。</p><p>.NET 用の Application Insights SDK は、規定では Ilogger Warning 以上のログが収集されます。<br>つまり、例えば LogInformation で収集されたログは規定では Application Insights に収集されません。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/app/asp-net-core#ilogger-logs">Application Insights for ASP.NET Core アプリケーション</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict15.png"></p><p>もし Application Insights SDK ですべてのレベルのログを収集されたい場合は、appsettings.json ファイルに下記の設定を追加ください。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict16.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;ApplicationInsights&quot;: &#123;</span><br><span class="line">  &quot;LogLevel&quot;: &#123;</span><br><span class="line">    &quot;Default&quot;: &quot;Debug&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>監視対象 Web アプリケーションのランタイムが Java の場合でも発生しうる問題です。<br>Java に関しましては下記の公開情報をご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/java-standalone-config#autocollected-logging">構成オプション: Azure Monitor Application Insights for Java # 自動収集されるログ</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict17.png"></p><h3 id="ケース-2-自動インストルメンテーション機能を有効にしているのに、中途半端な状態で-Application-Insights-SDK-が組み込まれてしまった"><a href="#ケース-2-自動インストルメンテーション機能を有効にしているのに、中途半端な状態で-Application-Insights-SDK-が組み込まれてしまった" class="headerlink" title="ケース 2. 自動インストルメンテーション機能を有効にしているのに、中途半端な状態で Application Insights SDK が組み込まれてしまった"></a>ケース 2. 自動インストルメンテーション機能を有効にしているのに、中途半端な状態で Application Insights SDK が組み込まれてしまった</h3><p>App Service と Application Insights を統合する方法として、下記の 2 種類ございます。</p><ol><li>自動インストルメンテーション機能を用いて有効化 (ソースコードの変更は不要)</li><li>Web アプリケーションに Application Insights SDK 組み込む (ソースコードの変更が必要)</li></ol><blockquote><p>これらの違いは <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/opentelemetry-overview?tabs=aspnetcore">こちらの公開情報</a> をご参考ください。</p></blockquote><p>ランタイムが .NET Framework / .NET の場合、自動インストルメンテーション機能を有効化していてかつ、当該 App Service リソースに対して Application Insights SDK が組み込まれた Web アプリケーションをデプロイした場合、Application Insights SDK 側が優先されます。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/opentelemetry-overview?tabs=aspnetcore">Azure App Service のアプリケーションの監視の概要</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict18.png"></p><p>Application Insights SDK 側が優先されるため、Application Insights SDK 側の設定に影響して収集されるテレメトリの種類が決定します。<br>もし担当者の方が自動インストルメンテーション機能の有効化を期待していた場合、何らかの原因によって組み込まれた Application Insights SDK が意図せず機能する可能性があります。<br>その場合に適切に Application Insights SDK の設定が構築出来ていないと、期待どおりテレメトリが収集出来ない場合がございます。</p><p>もし Application Insights SDK は不要であれば、下記の手順で当該 Web アプリケーションから Application Insights SDK の削除をご検討ください。</p><h4 id="Application-Insights-SDK-を完全に削除する"><a href="#Application-Insights-SDK-を完全に削除する" class="headerlink" title="Application Insights SDK を完全に削除する"></a>Application Insights SDK を完全に削除する</h4><p>Azure の基盤側ログに、ApplicationInsights.dll ファイルが wwwroot フォルダに検出されたことが記録されております。<br>もし当該 Web アプリケーションに対して ApplicationInsights.dll が含まれている場合は、お手数ではございますが当該 DLL を削除し改めて App Service に再デプロイを実施ください。<br>もしくは、当該 Web アプリケーションのプロジェクトに Microsoft.ApplicationInsights.AspNetCore が存在する場合、こちらを削除いただき App Service に再デプロイください。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/asp-net-core?tabs=netcorenew,netcore6#enable-application-insights-server-side-telemetry-no-visual-studio">Application Insights for ASP.NET Core アプリケーション</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict19.png"></p><p>.NET Framework の場合は、こちらを削除ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/asp-net#add-application-insights-manually">ASP.NET Web サイトに Application Insights を構成する</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict20.png"></p><h1 id="ケース-3-問題なく-Application-Insights-にテレメトリが収集出来ているが、時々期待したログが欠落する"><a href="#ケース-3-問題なく-Application-Insights-にテレメトリが収集出来ているが、時々期待したログが欠落する" class="headerlink" title="ケース 3. 問題なく Application Insights にテレメトリが収集出来ているが、時々期待したログが欠落する"></a>ケース 3. 問題なく Application Insights にテレメトリが収集出来ているが、時々期待したログが欠落する</h1><h2 id="問題の概要-2"><a href="#問題の概要-2" class="headerlink" title="問題の概要"></a>問題の概要</h2><ul><li>基本的には requests ログや dependencies ログ、traces ログは収集されている。</li><li>しかし時々、一部のデータが欠落しているように見受けられる。</li></ul><h2 id="疑われるポイント-1"><a href="#疑われるポイント-1" class="headerlink" title="疑われるポイント"></a>疑われるポイント</h2><p>サンプリングが機能している可能性が非常に高いです。<br>下記の公開情報をご参考に、サンプリングによってログが意図的に間引かれているかどうかをご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/sampling-classic-api#knowing-whether-sampling-is-in-operation">サンプリングが動作しているかどうかを把握する</a></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">union requests,dependencies,pageViews,browserTimings,exceptions,traces</span><br><span class="line">| where timestamp &gt; ago(1d)</span><br><span class="line">| summarize RetainedPercentage = 100/avg(itemCount) by bin(timestamp, 1h), itemType</span><br></pre></td></tr></table></figure><h1 id="色々調べたけど問題が解決しない場合……"><a href="#色々調べたけど問題が解決しない場合……" class="headerlink" title="色々調べたけど問題が解決しない場合……"></a>色々調べたけど問題が解決しない場合……</h1><p>問題解消のために、ぜひ弊社サポートにお問い合わせください。<br>その際は、<strong>必ず問題が発生したサブスクリプションからサポート リクエストをご起票ください</strong>ませ。<br>セキュリティ上の理由から、権限の確認を厳密化させていただいているためです。<br>詳細は、<a href="https://jpaztech.github.io/blog/information/Different-subscriptions-research/">お問い合わせ発行時と「異なる」サブスクリプションならびに AAD テナントの調査依頼に対してのセキュリティ チェックが強化されます</a> をご確認ください。</p><p>なお、お問い合わせいただく際には下記の情報をご共有いただく事でスムーズに調査が可能となります。<br>Application Insights に対してテレメトリが収集されなくなり、弊社サポートにお問い合わせいただく場合にご参考いただけますと幸いです。</p><ul><li>問題が発生した Application Insights リソース名</li><li>監視対象の Web アプリケーションのデプロイ先の情報<ul><li>App Service にデプロイいただいている場合は、App Service のリソース名</li><li>Azure VM にデプロイいただいている場合は、Azure VM のリソース名</li></ul></li><li>監視対象 Web アプリケーションのランタイム情報 (.NET 6, Java 17 など)</li><li>Application Insights をご利用いただくための方法<ul><li>下記のどちらかの方法で Application Insights と統合が可能ですが、どちらをご選択いただいているかを共有ください。(不明な場合はその旨お伝えください)<ul><li>ソースコードの変更が不要な、App Service リソース ページから有効化が可能な自動インストルメンテーション機能を使って、Application Insights を利用している。</li><li>ソースコードの必要な、Application Insights SDK を Web アプリケーションに組み込んで Application Insights を利用している。</li></ul></li></ul></li><li>問題が発生し始めた時間帯<ul><li>時間帯は、日本時間か UTC なのかを必ずご共有くださいませ。</li></ul></li><li>テレメトリが欠落している事に気づいた際に、ログをご確認いただく時に実際に実行いただいた Kusto クエリ</li></ul><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>本記事では、Application Insights へテレメトリが収集されなくなった場合の事象についてご案内いたしました。</p><p>本記事が少しでもお役に立ちましたら幸いです。<br>最後までお読みいただきありがとうございました！</p><h1 id="関連する記事"><a href="#関連する記事" class="headerlink" title="関連する記事"></a>関連する記事</h1><p>Application Insights に関するトラブルシューティング系の公開情報は別で用意されています。<br>今回の記事で案内させて頂いた内容も多々含まれておりますので、問題が発生した際はぜひ下記の公開情報をご確認くださいませ。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/investigate-missing-telemetry">Azure Monitor Application Insights でアプリケーション テレメトリが見つからない場合のトラブルシューティング</a></li></ul><p>またあまり知られておりませんが、当該 Application Insights リソースのページからトラブルシューティングが可能です。<br>Azure portal より問題が発生した Application Insights のページへ移動し、「問題の診断と解決」から「Application Insights の有効かごのデータがない…」という箇所をクリックしてみてください。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict21.png"></p><p>このページから、問題を解決するためのトラブルシューティングが可能です。<br>例えば、下図のように Problem subtype に対して「すべてのテレメトリがない」を選択します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict22.png"></p><p>すると、様々な観点から問題解消のために役立つ情報がご確認いただけます。<br>こちらも一度参考いただけますと幸いです。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict23.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北山です。&lt;/p&gt;
&lt;p&gt;App Service や Azure VM などにデプロイいただいている Web アプリケーションのパフォーマンスを監視するために、Application Insights をご利用</summary>
      
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Application Insights" scheme="https://jpazmon-integ.github.io/blog/tags/Application-Insights/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor Agent for Linux で取得可能なパフォーマンス カウンターの一覧</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/</id>
    <published>2024-01-17T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.359Z</updated>
    
    <content type="html"><![CDATA[<p>[更新履歴]  </p><ul><li>2024/1/18 データ収集ルールで指定できるパフォーマンス カウンターの追加に伴い、取得可能なパフォーマンス カウンターの一覧を更新いたしました。 </li><li>2023/3/21 ブログ公開</li></ul><p>こんにちは、Azure Monitor サポートの三輪です。<br>今回は Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターの一覧をご案内します。</p><p>Azure Monitor エージェントでは、Windows/Linux 各 OS のパフォーマンス データを取得することが可能です。</p><ul><li>Azure Monitor エージェントを使用して仮想マシンからイベントとパフォーマンス カウンターを収集する<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal</a></li></ul><p>Azure Monitor エージェント for Windows では、Windows OS 上に存在するパフォーマンス カウンターであれば取得が可能です。<br>一方で、Azure Monitor エージェント for Linux では、特定のパフォーマンス カウンターのみが取得可能となっています。<br>また、Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターは、以下の Log Analytics エージェントで取得可能であったパフォーマンス カウンターと一部異なる部分がありますため、本記事にてご案内を致します。</p><ul><li>Log Analytics エージェントを使用して Windows と Linux のパフォーマンス データ ソースを収集する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-performance-counters">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-performance-counters</a></li></ul><h2 id="Azure-Monitor-エージェント-for-Linux-にて取得可能なパフォーマンス-カウンター："><a href="#Azure-Monitor-エージェント-for-Linux-にて取得可能なパフォーマンス-カウンター：" class="headerlink" title="Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンター："></a>Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンター：</h2><table><thead><tr><th align="left">ObjectName</th><th align="center">CounterName</th></tr></thead><tbody><tr><td align="left">Logical Disk</td><td align="center">Logical Disk Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Free Megabytes</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Writes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Write Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Transfers/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Reads/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Read Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Used Space</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Used Inodes</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Free Space</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Free Inodes</td></tr><tr><td align="left">Memory</td><td align="center">Used Memory MBytes</td></tr><tr><td align="left">Memory</td><td align="center">Used MBytes Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">Pages/sec</td></tr><tr><td align="left">Memory</td><td align="center">Page Writes/sec</td></tr><tr><td align="left">Memory</td><td align="center">Page Reads/sec</td></tr><tr><td align="left">Memory</td><td align="center">Available MBytes Swap</td></tr><tr><td align="left">Memory</td><td align="center">Available MBytes Memory</td></tr><tr><td align="left">Memory</td><td align="center">% Used Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">% Used Memory</td></tr><tr><td align="left">Memory</td><td align="center">% Available Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">% Available Memory</td></tr><tr><td align="left">Network</td><td align="center">Total Tx Errors</td></tr><tr><td align="left">Network</td><td align="center">Total Rx Errors</td></tr><tr><td align="left">Network</td><td align="center">Total Packets Transmitted</td></tr><tr><td align="left">Network</td><td align="center">Total Packets Received</td></tr><tr><td align="left">Network</td><td align="center">Total Collisions</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes Transmitted</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes Received</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes</td></tr><tr><td align="left">Processor</td><td align="center">% User Time</td></tr><tr><td align="left">Processor</td><td align="center">% Processor Time</td></tr><tr><td align="left">Processor</td><td align="center">% Privileged Time</td></tr><tr><td align="left">Processor</td><td align="center">% Nice Time</td></tr><tr><td align="left">Processor</td><td align="center">% IO Wait Time</td></tr><tr><td align="left">Processor</td><td align="center">% Interrupt Time</td></tr><tr><td align="left">Processor</td><td align="center">% Idle Time</td></tr><tr><td align="left">Process</td><td align="center">Pct User Time</td></tr><tr><td align="left">Process</td><td align="center">Pct Privileged Time</td></tr><tr><td align="left">Process</td><td align="center">Used Memory</td></tr><tr><td align="left">Process</td><td align="center">Virtual Shared Memory</td></tr><tr><td align="left">System</td><td align="center">Uptime</td></tr><tr><td align="left">System</td><td align="center">Load1</td></tr><tr><td align="left">System</td><td align="center">Load5</td></tr><tr><td align="left">System</td><td align="center">Load15</td></tr><tr><td align="left">System</td><td align="center">Users</td></tr><tr><td align="left">System</td><td align="center">Unique Users</td></tr><tr><td align="left">System</td><td align="center">CPUs</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[更新履歴]  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;2024/1/18 データ収集ルールで指定できるパフォーマンス カウンターの追加に伴い、取得可能なパフォーマンス カウンターの一覧を更新いたしました。 &lt;/li&gt;
&lt;li&gt;2023/3/21 ブログ公開&lt;/li&gt;
&lt;/ul&gt;
&lt;p</summary>
      
    
    
    
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのデータを削除する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsWorkspacePurge/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsWorkspacePurge/</id>
    <published>2024-01-05T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.475Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は、Log Analytics ワークスペースのデータを削除する方法をご紹介します。<br>Log Analytics ワークスペースでは指定した<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-archive?tabs=portal-1,portal-2#configure-the-default-workspace-retention">保持期間</a>を超えると、自動的にログが削除されます。<br>一方で、この保持期間を迎える前にログを削除したい、特定のログのみを削除したい、といった場合には、今回紹介する方法でデータを削除することをご検討いただけますと幸いです。<br><br></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%AF-REST-API-%E3%81%A7%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B">1. Log Analytics ワークスペースのログは REST API で削除する</a></li><li><a href="#2-Purge-%E3%81%AE-REST-API-%E3%82%92%E3%81%94%E5%88%A9%E7%94%A8%E3%81%84%E3%81%9F%E3%81%A0%E3%81%8F%E9%9A%9B%E3%81%AE%E7%95%99%E6%84%8F%E7%82%B9">2. Purge の REST API をご利用いただく際の留意点</a><ul><li><a href="#2-1-%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%AD%E3%83%BC%E3%83%AB">2.1 必要なロール</a></li><li><a href="#2-2-%E3%81%94%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E6%BC%94%E7%AE%97%E5%AD%90">2.2 ご利用可能な演算子</a></li><li><a href="#2-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%82%8B%E3%81%BE%E3%81%A7%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E6%99%82%E9%96%93">2.3 データが削除されるまでにかかる時間</a></li><li><a href="#2-4-%E3%83%91%E3%83%BC%E3%82%B8%E3%81%AE%E6%93%8D%E4%BD%9C%E3%81%AF%E5%85%83%E3%81%AB%E6%88%BB%E3%81%99%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84">2.4 パージの操作は元に戻すことはできない</a></li></ul></li><li><a href="#3-Purge-%E3%81%AE-REST-API-%E3%81%A7%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">3. Purge の REST API で削除する手順</a></li><li><a href="#4-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%81%9F%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">4. データが削除されたかどうかを確認する手順</a><ul><li><a href="#4-1-Get-Purge-Status-%E3%81%AE-REST-API-%E3%81%A7%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">4-1. Get Purge Status の REST API で確認する</a></li><li><a href="#4-2-Operation-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%A7%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">4-2. Operation テーブルで確認する</a></li></ul></li></ul><br><h2 id="1-Log-Analytics-ワークスペースのログは-REST-API-で削除する"><a href="#1-Log-Analytics-ワークスペースのログは-REST-API-で削除する" class="headerlink" title="1. Log Analytics ワークスペースのログは REST API で削除する"></a>1. Log Analytics ワークスペースのログは REST API で削除する</h2><p>Log Analytics ワークスペースに収集されたログは REST API で削除することができます。<br>誠に恐縮ではございますが、Azure ポータルからログを削除することはできません。<br>この Purge の REST API では、ログのテーブル名やカラム名を指定して特定のログを削除することが可能です。<br>※ 当該 API は<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社公開情報</a>の “Try It” より実行いただけます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image01.png"></p><br><br><h2 id="2-Purge-の-REST-API-をご利用いただく際の留意点"><a href="#2-Purge-の-REST-API-をご利用いただく際の留意点" class="headerlink" title="2. Purge の REST API をご利用いただく際の留意点"></a>2. Purge の REST API をご利用いただく際の留意点</h2><p>Purge の REST API を実行いただく上での留意点をご紹介します。REST API を実行する前に必ずご確認ください。</p><br><h3 id="2-1-必要なロール"><a href="#2-1-必要なロール" class="headerlink" title="2.1 必要なロール"></a>2.1 必要なロール</h3><p>Purge の REST API を実行するには、明示的に <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#data-purger">Data Purger (データ消去者)</a> ロールが必要です。パージを実行されるユーザー様には、対象のワークスペースに <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">Data Purger のロールを付与</a>いただきますようお願いいたします。</p><br><h3 id="2-2-ご利用可能な演算子"><a href="#2-2-ご利用可能な演算子" class="headerlink" title="2.2 ご利用可能な演算子"></a>2.2 ご利用可能な演算子</h3><p>この REST API では、カラム名とその値を指定して特定のログを削除することができます。<br>カラム名を指定する際にサポートされている演算子は以下のとおりです。<br>すべての演算子をサポートしているものではございませんので、API を実行する前に<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社公開情報の “WorkspacePurgeBodyFilters”</a> の項目をご確認ください。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image03.png"></p><br><h3 id="2-3-データが削除されるまでにかかる時間"><a href="#2-3-データが削除されるまでにかかる時間" class="headerlink" title="2.3 データが削除されるまでにかかる時間"></a>2.3 データが削除されるまでにかかる時間</h3><p>Purge の REST API によるログの削除は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/personal-data-mgmt#exporting-and-deleting-personal-data">基本的に数分 ～ 数時間で反映されますが、最大 30 日かかる場合もございます</a>。<br>データが削除されたかどうかをご確認されたい場合は、後述の <a href="#4-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%81%9F%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">4. データが削除されたかどうかを確認する手順</a> をご参照ください。</p><br><h3 id="2-4-パージの操作は元に戻すことはできない"><a href="#2-4-パージの操作は元に戻すことはできない" class="headerlink" title="2.4 パージの操作は元に戻すことはできない"></a>2.4 パージの操作は元に戻すことはできない</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/personal-data-mgmt#delete">パージの操作は元に戻すことはできません</a>。パージの操作を実行する際には細心の注意を払って実施してください。</p><br><br><h2 id="3-Purge-の-REST-API-で削除する手順"><a href="#3-Purge-の-REST-API-で削除する手順" class="headerlink" title="3. Purge の REST API で削除する手順"></a>3. Purge の REST API で削除する手順</h2><p><a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社サイト</a>の “Try It” より、Purge の REST API を実行した例を紹介します。<br>今回は Test という名前の Log Analytics ワークスペースに収集された Heartbeat のログを削除します。<br>このワークスペースには TimeGenerated が 2023/12/26 07:45 UTC ～ 2023/12/27 18:46 UTC の Heartbeat が存在します。<br>このうち TimeGenerated が 2023/12/26 07:50:00 UTC より後のログを削除します。</p><p>以下は Heartbeat テーブルを検索した実行結果の一部抜粋です。2023/12/26 07:50:00 UTC より後のログを削除するため、赤線で囲んだ部分のログが削除され、黄色でマーカーした部分のログは削除されずに残ります。<br>※ TimeGenerated の値は UTC 時刻であることに注意してください。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image04.png"></p><br><p>それでは API の実行手順をご紹介します。</p><ol><li><a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">こちら</a>のサイトにアクセスし、”Try It” を選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image05.png"></li></ol><ol start="2"><li>“Try It” をクリックすると、以下のような画面に遷移します。<br>Parameters (赤線で囲った部分) では、対象のワークスペースが存在するサブスクリプション、リソース グループ、ワークスペースの名前を指定します。Body (黄色線で囲った部分) では、削除するログのテーブル名と、カラム名とその値を指定します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image06.png"></li></ol><p>今回は TimeGenerated が 2023/12/26 07:50:00 UTC より後のログを削除したいので、Body 部分の table で Heartbeat、column で TimeGenerated を指定します。<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">こちら</a>のサイトにもサンプル リクエストが掲載されておりますので、併せてご確認ください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;table&quot;: &quot;Heartbeat&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;column&quot;: &quot;TimeGenerated&quot;,</span><br><span class="line">      &quot;operator&quot;: &quot;&gt;&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;<span class="number">2023</span>-<span class="number">12</span>-<span class="number">26</span>T07:<span class="number">50</span>:<span class="number">00</span>&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>画面下部の “Run” をクリックして、REST API を実行します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image07.png"></li></ol><ol start="4"><li>以下のように HTTP Response Code: 202 と表示されることを確認し、”operationId” をメモします。<br>後述しますが、”operationId” はデータの削除状況を確認する際に必要です。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image08.png"></li></ol><ol start="5"><li>パージの操作が完了した後に、クエリを実行してログが削除されたことを確認します。<br>以下は API を実行する前と同じクエリを実行した結果です。<br>TimeGenerated が 2023/12/26 07:50:00 UTC より前のログは表示されますが、TimeGenerated が 2023/12/26 07:50:00 UTC より後のログは表示されません。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image15.png"></li></ol><br><br><h2 id="4-データが削除されたかどうかを確認する手順"><a href="#4-データが削除されたかどうかを確認する手順" class="headerlink" title="4. データが削除されたかどうかを確認する手順"></a>4. データが削除されたかどうかを確認する手順</h2><p>Purge の REST API によってデータが削除されたかどうかを確認したい場合は、以下の手順にてご確認ください。</p><br><h3 id="4-1-Get-Purge-Status-の-REST-API-で確認する"><a href="#4-1-Get-Purge-Status-の-REST-API-で確認する" class="headerlink" title="4-1. Get Purge Status の REST API で確認する"></a>4-1. Get Purge Status の REST API で確認する</h3><p><a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/get-purge-status?view=rest-loganalytics-2020-08-01&tabs=HTTP">Get Purge Status</a> の REST API でパージ操作の状態を確認できます。この REST API を実行するためには、purgeId が必要です。<br>この purgeId とは、Purge の REST API を実行した際に表示された “operatonId” の値です。<br>データの削除状態を確認されたい場合は、必ず “operatonId” をメモしていただきますようお願いいたします。</p><p>Purge の REST API と同様、<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/get-purge-status?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社サイト</a> の “Try It” から API を実行いただけます。<br>Parameters では、Purge の REST API を実行した際に表示された “operatonId” と、対象のワークスペースが存在するサブスクリプション、リソース グループ、ワークスペースの名前を指定します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image09.png"></p><p>API を実行すると以下のとおり status が表示されます。<br>パージの操作が完了していない場合は pending が返されます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image10.png"></p><p>パージの操作が完了した場合には completed が返されます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image13.png"></p><br><h3 id="4-2-Operation-テーブルで確認する"><a href="#4-2-Operation-テーブルで確認する" class="headerlink" title="4-2. Operation テーブルで確認する"></a>4-2. Operation テーブルで確認する</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/monitor-workspace">Operation テーブル</a>は、Log Analytics ワークスペース上で発生した問題や警告等が記録されるテーブルです。こちらのテーブルにパージ操作の情報も記録されます。対象のワークスペースにて以下のようなクエリを実行しますと、パージ操作の状態を確認することができます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Operation</span><br><span class="line">| where OperationCategory =~ &quot;Workspace data management&quot;</span><br><span class="line">| where Detail contains &quot;Purge&quot;</span><br></pre></td></tr></table></figure><p>以下は弊社検証環境にて上記クエリを実行した例です。Detail 列には “Purge operation started for table:Heartbeat” と記録されており、Heartbeat テーブルに対してパージの操作が開始されたことが分かります。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image11.png"></p><p>パージの操作が完了しますと Detail 列に “Purge operation completed for table:Heartbeat” と記録されます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image12.png"></p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は、Log Analytics ワークスペースのデータを削除する方法をご紹介します。&lt;br&gt;Log Analytics ワークスペースでは指定した&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-archive?tabs=portal-1,portal-2#configure-the-default-workspace-retention&quot;&gt;保持期間&lt;/a&gt;を超えると、自動的にログが削除されます。&lt;br&gt;一方で、この保持期間を迎える前にログを削除したい、特定のログのみを削除したい、といった場合には、今回紹介する方法でデータを削除することをご検討いただけますと幸いです。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="パージ" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%83%91%E3%83%BC%E3%82%B8/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのデータ エクスポートに関するよくあるご質問</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/</id>
    <published>2024-01-05T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.483Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>皆さまは <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal">Log Analytics ワークスペースのデータ エクスポート</a> という機能をご存知でしょうか。<br>この機能では Log Analytics ワークスペースに収集されたログをストレージ アカウントやイベント ハブにエクスポートすることができます。今回はこのデータ エクスポート機能でよくお問い合わせをいただくご質問を紹介いたします。</p><br><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><ul><li><a href="#Q1-%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%AF%E5%85%A8%E3%81%A6%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%A7%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q1. データ エクスポート機能は全てのテーブルでサポートされていますか。</a></li><li><a href="#Q2-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%84%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%8F%E3%83%96%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%82%8B%E5%A5%91%E6%A9%9F%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q2. ストレージ アカウントやイベント ハブにデータがエクスポートされる契機を教えてください。</a></li><li><a href="#Q3-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90%E5%89%8D%E3%81%AB-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%AF%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%84%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%8F%E3%83%96%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q3. エクスポート ルールの作成前に Log Analytics ワークスペースに収集されたログは、ストレージ アカウントやイベント ハブにエクスポートされますか。</a></li><li><a href="#Q4-%E3%83%AD%E3%82%B0%E3%81%8C%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%E8%80%83%E3%81%88%E3%82%89%E3%82%8C%E3%82%8B%E5%8E%9F%E5%9B%A0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q4. ログがストレージ アカウントに転送されていません。考えられる原因を教えてください。</a></li><li><a href="#Q5-%E3%81%82%E3%82%8B%E4%B8%80%E5%AE%9A%E6%9C%9F%E9%96%93%E7%B5%8C%E9%81%8E%E3%81%97%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q5. ある一定期間経過したデータをストレージ アカウントに転送することはできますか。</a></li><li><a href="#Q6-%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%A7%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q6. データ エクスポート機能でサポートしていないテーブルのログをストレージ アカウントに転送する方法はありますか。</a></li><li><a href="#Q7-%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%A7%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%92%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q7. データ エクスポート機能でストレージ アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。</a></li><li><a href="#Q8-%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%82%E5%90%AB%E3%82%81%E3%81%A6%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E5%86%8D%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E6%96%B9%E3%81%8C%E8%89%AF%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q8. サポートされていないテーブルも含めてエクスポート ルールを設定してしまいました。エクスポート ルールを再作成した方が良いですか。</a></li><li><a href="#Q9-%E6%97%A2%E5%AD%98%E3%81%AE%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E5%AE%9B%E5%85%88%E3%81%A8%E5%90%8C%E3%81%98%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%80%81%E6%96%B0%E8%A6%8F%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%82%88%E3%81%86%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82">Q9. 既存のエクスポート ルールの宛先と同じストレージ アカウントを指定し、新規にエクスポート ルールを作成しようしましたが、エラーが発生しました。</a></li><li><a href="#Q10-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%AE%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q10. ストレージ アカウントにデータをエクスポートするように設定しています。データ エクスポート機能の利用料金を教えてください。</a></li></ul><br><h3 id="Q1-データ-エクスポート機能は全てのテーブルでサポートされていますか。"><a href="#Q1-データ-エクスポート機能は全てのテーブルでサポートされていますか。" class="headerlink" title="Q1. データ エクスポート機能は全てのテーブルでサポートされていますか。"></a>Q1. データ エクスポート機能は全てのテーブルでサポートされていますか。</h3><p>いいえ、全てのテーブルでサポートしておりません。<br>サポート対象のテーブルは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#supported-tables">こちら</a>の弊社公開情報でご確認ください。</p><br><h3 id="Q2-ストレージ-アカウントやイベント-ハブにデータがエクスポートされる契機を教えてください。"><a href="#Q2-ストレージ-アカウントやイベント-ハブにデータがエクスポートされる契機を教えてください。" class="headerlink" title="Q2. ストレージ アカウントやイベント ハブにデータがエクスポートされる契機を教えてください。"></a>Q2. ストレージ アカウントやイベント ハブにデータがエクスポートされる契機を教えてください。</h3><p>データ エクスポート機能は Log Analytics ワークスペースに “データが取り込まれた時” に指定した宛先 (ストレージ アカウントとイベント ハブ) へデータをエクスポートします。Log Analytics ワークスペースのログをストレージ アカウントにエクスポートした場合は 5 分間のログが一つのファイルに記録されます。つまり 1 時間にファイルが 12 個作成され、レコードが生成される度にストレージ アカウントのファイルに追記されます。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#overview">弊社公開情報</a> もご覧いただけますと幸いです。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image01.png"></p><br><h3 id="Q3-エクスポート-ルールの作成前に-Log-Analytics-ワークスペースに収集されたログは、ストレージ-アカウントやイベント-ハブにエクスポートされますか。"><a href="#Q3-エクスポート-ルールの作成前に-Log-Analytics-ワークスペースに収集されたログは、ストレージ-アカウントやイベント-ハブにエクスポートされますか。" class="headerlink" title="Q3. エクスポート ルールの作成前に Log Analytics ワークスペースに収集されたログは、ストレージ アカウントやイベント ハブにエクスポートされますか。"></a>Q3. エクスポート ルールの作成前に Log Analytics ワークスペースに収集されたログは、ストレージ アカウントやイベント ハブにエクスポートされますか。</h3><p>いいえ、エクスポートされません。<br>データ エクスポート機能は Log Analytics ワークスペースに “データが取り込まれた時” に宛先 (ストレージ アカウントとイベント ハブ) へデータを転送する機能です。エクスポート ルールの設定前に既に取り込まれたログの転送は行われず、コンテナも作成されません。</p><br><h3 id="Q4-ログがストレージ-アカウントに転送されていません。考えられる原因を教えてください。"><a href="#Q4-ログがストレージ-アカウントに転送されていません。考えられる原因を教えてください。" class="headerlink" title="Q4. ログがストレージ アカウントに転送されていません。考えられる原因を教えてください。"></a>Q4. ログがストレージ アカウントに転送されていません。考えられる原因を教えてください。</h3><p>考えられる原因は以下のとおりです。弊社公開情報の <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#limitations">制限事項</a>と <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#storage-account">ストレージ アカウント</a> の項目も併せてご確認ください。<br>以下に該当しない場合で指定した宛先にログがエクスポートされない場合は弊社サポート窓口までお問い合わせください。</p><p><em><strong>1. エクスポート ルールで指定したテーブルがサポートされていない</strong></em><br>対象のテーブルがデータ エクスポート機能でサポートされていない可能性がございます。<br>まずは、指定したテーブルが<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#supported-tables">サポート対象のテーブル</a>かどうかをご確認ください。</p><p><em><strong>2. ストレージ アカウントのネットワーク設定で “信頼された Microsoft サービス” が許可されていない</strong></em><br>ストレージ アカウントのネットワーク設定により、ログがエクスポートされていない可能性がございます。<br>宛先のストレージ アカウントが選択したネットワークからのアクセスを許可する構成である場合、<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#allow-trusted-microsoft-services">[信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します。] が有効</a>になっているかどうかをご確認ください。完全に外部からのアクセスを無効にすると、Azure Monitor サービスからの通信が遮断され、ログをエクスポートすることができません。また、選択したネットワークからのアクセスを許可する構成の場合、Azure Monitor サービスからの通信を許可するために [信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します。] を有効にしていただく必要がございます。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image05.png"></p><p><em><strong>3. ストレージ アカウントのリージョンが Log Analytics ワークスペースと同じージョンでない</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#limitations">宛先のストレージ アカウントのリージョンは、Log Analytics ワークスペースと同じリージョンである必要がございます</a>。対象のストレージ アカウントと Log Analytics ワークスペースのリージョンをご確認下さいますようお願いいたします。</p><p><em><strong>4. ストレージ アカウントの種類が Standard ではない</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#limitations">データ エクスポート機能では、Premium のストレージ アカウントはサポートされていません。</a><br>宛先のストレージ アカウントの種類が Standard であることをご確認ください。</p><p><em><strong>5. エクスポート ルールの作成後に Log Analytics ワークスペースにログが収集されていない</strong></em><br>データ エクスポート機能は Log Analytics ワークスペースに “データが取り込まれた時” に宛先へデータを転送する機能です。<br>エクスポート ルールの作成後に Log Analytics ワークスペースにログが収集されていない場合は、宛先のストレージ アカウントにはログが取り込まれません。Log Analytics ワークスペース上でクエリを実行いただき、エクスポート ルールの作成後に対象のログが Log Analytics ワークスペースに収集されているかどうかをご確認ください。</p><br><h3 id="Q5-ある一定期間経過したデータをストレージ-アカウントに転送することはできますか。"><a href="#Q5-ある一定期間経過したデータをストレージ-アカウントに転送することはできますか。" class="headerlink" title="Q5. ある一定期間経過したデータをストレージ アカウントに転送することはできますか。"></a>Q5. ある一定期間経過したデータをストレージ アカウントに転送することはできますか。</h3><p>大変恐縮ではございますが、データ エクスポート機能では、ある一定期間を経過したログを転送することはできません。<br>この機能では、過去に遡ってログをエクスポートすることや特定期間のログをエクスポートすることはできません。<br>過去のログや特定の期間におけるログをエクスポートされたい場合は、お客様にてストレージ アカウントにログをアップロードする仕組みのご構築をご検討ください。</p><br><h3 id="Q6-データ-エクスポート機能でサポートしていないテーブルのログをストレージ-アカウントに転送する方法はありますか。"><a href="#Q6-データ-エクスポート機能でサポートしていないテーブルのログをストレージ-アカウントに転送する方法はありますか。" class="headerlink" title="Q6. データ エクスポート機能でサポートしていないテーブルのログをストレージ アカウントに転送する方法はありますか。"></a>Q6. データ エクスポート機能でサポートしていないテーブルのログをストレージ アカウントに転送する方法はありますか。</h3><p>エクスポートしたいログ データの種類によります。<br>例えば <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings">Azure Monitor の診断設定</a>に関するデータは、診断設定側でストレージ アカウントに転送することが可能です。エクスポートしたいデータが診断設定によるログに該当しない場合は、Azure Functions や Azure Logic Apps 等を使用して、データをストレージ アカウントにエクスポートする方法や、お客様ご自身にて Log Analytics ワークスペースからログを取得し、ストレージ アカウントに送信する仕組みのご構築をご検討ください。詳細は以下の<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/logs/logs-data-export?tabs=portal#other-export-options">弊社公開情報</a>をご参照ください。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image02.png"></p><br><h3 id="Q7-データ-エクスポート機能でストレージ-アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。"><a href="#Q7-データ-エクスポート機能でストレージ-アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。" class="headerlink" title="Q7. データ エクスポート機能でストレージ アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。"></a>Q7. データ エクスポート機能でストレージ アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。</h3><p>エクスポートされたデータは、Azure ポータルのストレージ アカウントの [ストレージ ブラウザー] の画面よりご確認いただけます。<br>ログがエクスポートされますと、am-&lt;テーブル名&gt; という名前でコンテナーが作成されます。<br>また、BLOB は WorkspaceResourceId=/subscriptions/&lt;サブスクリプション ID&gt;/resourcegroups/&lt;リソース グループ&gt;/providers/microsoft.operationalinsights/workspaces/&lt;ワークスペース名&gt;/y=&lt;4 桁の数値年&gt;/m=&lt;2 桁の数値月&gt;/d=&lt;2 桁の数値日&gt;/h=&lt;2 桁の 24 時制の時間&gt;/m=&lt;2 桁の 60 分制の分&gt;/PT05M.json というパス構造のフォルダーに格納されます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#storage-account">弊社公開情報</a>も併せてご確認ください。</p><p>※ Heartbeat テーブルをエクスポートした例です。am-Heartbeat という名前でコンテナーが作成されます。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image03.png"></p><br><h3 id="Q8-サポートされていないテーブルも含めてデータ-エクスポート-ルールを設定してしまいました。エクスポート-ルールを再作成した方が良いですか。"><a href="#Q8-サポートされていないテーブルも含めてデータ-エクスポート-ルールを設定してしまいました。エクスポート-ルールを再作成した方が良いですか。" class="headerlink" title="Q8. サポートされていないテーブルも含めてデータ エクスポート ルールを設定してしまいました。エクスポート ルールを再作成した方が良いですか。"></a>Q8. サポートされていないテーブルも含めてデータ エクスポート ルールを設定してしまいました。エクスポート ルールを再作成した方が良いですか。</h3><p>いいえ、現時点でサポートされていないテーブルをご指定いただいても構いません。<br>エクスポート ルール作成時に当該機能をサポートしていないテーブルについては、サポートされ次第、データのエクスポートが開始されます。<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/logs/logs-data-export?tabs=portal#create-or-update-a-data-export-rule">弊社公開情報</a>も併せてご確認ください。</p><br><h3 id="Q9-既存のエクスポート-ルールの宛先と同じストレージ-アカウントを指定し、新規にエクスポート-ルールを作成しようしましたが、エラーが発生しました。"><a href="#Q9-既存のエクスポート-ルールの宛先と同じストレージ-アカウントを指定し、新規にエクスポート-ルールを作成しようしましたが、エラーが発生しました。" class="headerlink" title="Q9. 既存のエクスポート ルールの宛先と同じストレージ アカウントを指定し、新規にエクスポート ルールを作成しようしましたが、エラーが発生しました。"></a>Q9. 既存のエクスポート ルールの宛先と同じストレージ アカウントを指定し、新規にエクスポート ルールを作成しようしましたが、エラーが発生しました。</h3><p>1 つの Log Analytics ワークスペースで既存のエクスポート ルールと同じ宛先のストレージ アカウントを指定したエクスポート ルールを作成することはできません。既存のエクスポート ルールと同じストレージ アカウントを宛先に設定すると以下のエラーが発生します。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#create-or-update-a-data-export-rule">弊社公開情報</a>も併せてご確認ください。<br>You are adding a destination that is already defined in rule: ym-export-test. Destination must be unique across export rules in your workspace.<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image04.png"></p><br><h3 id="Q10-ストレージ-アカウントにデータをエクスポートするように設定しています。データ-エクスポート機能の利用料金を教えてください。"><a href="#Q10-ストレージ-アカウントにデータをエクスポートするように設定しています。データ-エクスポート機能の利用料金を教えてください。" class="headerlink" title="Q10. ストレージ アカウントにデータをエクスポートするように設定しています。データ エクスポート機能の利用料金を教えてください。"></a>Q10. ストレージ アカウントにデータをエクスポートするように設定しています。データ エクスポート機能の利用料金を教えてください。</h3><p>データ エクスポート機能ではエクスポートされたデータに対して GB 単位でご利用料金が発生します。<br>また、ストレージ アカウントのご利用料金も発生いたします。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#pricing-model">弊社公開情報</a>や <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor の価格サイトの “エクスポート”</a> の項目をご覧ください。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;皆さまは &lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal&quot;&gt;Log Analytics ワークスペースのデータ エクスポート&lt;/a&gt; という機能をご存知でしょうか。&lt;br&gt;この機能では Log Analytics ワークスペースに収集されたログをストレージ アカウントやイベント ハブにエクスポートすることができます。今回はこのデータ エクスポート機能でよくお問い合わせをいただくご質問を紹介いたします。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>App Service でスロットをスワップした後に、cloud_RoleName に別スロットのホスト名が記録される事象について</title>
    <link href="https://jpazmon-integ.github.io/blog/applicationInsights/wrongSlotNameAfterSwapping/"/>
    <id>https://jpazmon-integ.github.io/blog/applicationInsights/wrongSlotNameAfterSwapping/</id>
    <published>2023-12-26T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.535Z</updated>
    
    <content type="html"><![CDATA[<p>[更新履歴]  </p><ul><li>12/27 13:00 (日本時間) ブログ公開</li></ul><p>こんにちは、Azure Monitoring サポート チームの北山です。<br>App Service に対してデプロイ スロットをスワップした後に、Application Insights の cloud_RoleName が期待しない値となる事象について案内いたします。</p><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E4%BA%8B%E8%B1%A1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">事象について</a></li><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E5%9B%9E%E9%81%BF%E6%96%B9%E6%B3%95">問題の回避方法</a></li><li><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB">最後に</a></li></ul><h1 id="事象について"><a href="#事象について" class="headerlink" title="事象について"></a>事象について</h1><p>App Service の Web アプリケーションを Application Insights で監視している場合、Application Insights に関連するログ テーブルの cloud_RoleName には、当該 Web サイト URL のホスト名が記録されます。</p><blockquote><p>xxxx-appservice.azurewebsites.net の場合は、”xxxx-appservice” が既定で cloud_RoleName の値として記録されます。</p></blockquote><p>App Service に対してデプロイ スロットのスワップを実行すると、例えば本番環境とテスト環境の入れ替えが可能です。<br>デプロイ スロットのスワップ後に、本番環境にアクセスをしているのにも関わらず、テスト環境のホスト名が Application Insights の cloud_RoleName に記録される事象を確認しています。</p><p>例えば下図のようにスワップした場合、本番環境にアクセスしているのにも関わらず cloud_RoleName に “junkitayama-appservice-dotnet02-develop” が記録されます。<br>※ 本番環境にアクセスしているので、本来は “junkitayama-appservice-dotnet02” が cloud_RoleName に記録される事を期待している。</p><p><img src="/blog/applicationInsights/wrongSlotNameAfterSwapping/image.png" alt="Alt text"></p><p>なお、こちらは弊社開発部門にて対処を検討しておりますが、発生条件が一律ではなくすぐに解消することが難しい状況です。<br>ご迷惑をおかけいたしますが、問題解消までもうしばらくお時間をいただけますと幸いです。</p><h1 id="問題の回避方法"><a href="#問題の回避方法" class="headerlink" title="問題の回避方法"></a>問題の回避方法</h1><p>App Service の運用スロット側の [設定] &gt; [構成] の [アプリケーション設定] から、以下のアプリケーション設定を追加します。</p><ul><li>設定名 : APPLICATIONINSIGHTS_ROLE_NAME</li><li>設定値 : cloud_RoleName に指定したい文字列</li><li>デプロイ スロットの設定 : チェックを入れます。</li></ul><p><img src="/blog/applicationInsights/wrongSlotNameAfterSwapping/image-1.png" alt="Alt text"></p><p>環境変数 APPLICATIONINSIGHTS_ROLE_NAME を指定いただく事で、明示的に cloud_RoleName の値を指定することが可能です。<br>そのため、もしデプロイ スロットのスワップにより cloud_RoleName が変わってしまう可能性を懸念される場合は、APPLICATIONINSIGHTS_ROLE_NAME の指定をご検討くださいませ。</p><blockquote><p>App Service に対してアプリケーション設定を構築すると、App Service に対して再起動が実施されます。  </p></blockquote><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/distributed-trace-data#role-names">分散トレースとテレメトリの相関関係</a>  </li></ul><p><img src="/blog/applicationInsights/wrongSlotNameAfterSwapping/image-3.png" alt="Alt text"></p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>もし、本ブログに記載の内容以外について追加のご質問やご不明点がございましたら、大変お手数ではございますが、事象を受けたサブスクリプションからお問い合わせをご発行ください。  </p><p>改めまして、本事象でご迷惑をおかけし大変申し訳ございません。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[更新履歴]  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;12/27 13:00 (日本時間) ブログ公開&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北山です。&lt;br&gt;App Service に対してデプロイ スロットをスワップした後に、</summary>
      
    
    
    
    
    <category term="Application Insights" scheme="https://jpazmon-integ.github.io/blog/tags/Application-Insights/"/>
    
  </entry>
  
  <entry>
    <title>DCR Config Generator の使用方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/DCRConfigGenerator/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/DCRConfigGenerator/</id>
    <published>2023-12-23T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.375Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure Monitoring チームの加治屋です。<br>この記事では、Log Analytics エージェントから Azure Monitor エージェントへの移行のために使用できるツールについてご紹介いたします。</p><p>※<br>DCR Config Generator の更新に伴い、ツールの利用方法が変更されております。<br>当記事は、DCR Config Generator バージョン 1.0.0 を前提として記載しております。</p><span id="more"></span><p>Log Analytics エージェントは 2024 年 8 月末でリタイアとなります。<br>継続してサポートを受けるためには、後継の Azure Monitor エージェントへ移行を行っていただく必要がございます。</p><p>Azure Monitor エージェントへの移行を行う場合、データ収集ルール (DCR) に対して、Log Analytics ワークスペースで設定されている収集設定を移行する必要があります。<br>お客様によっては、マシンの用途によって Log Analytics ワークスペースを分けられており、DCR への移行に以下のような問題を抱えていらっしゃるお客様も多いものと存じます。</p><p>例えば、、、<br>・Log Analytics ワークスペースから DCR に対する移行方法がよくわからない。<br>・Log Analytics ワークスペースが多くあり、かつログ収集定義がそれぞれ異なり、移行するのに工数がかかる。<br>・多くの Log Analytics ワークスペースを効率的に移行したいと思っているが、方法がわからない。<br>・移行に際して人為的なミスがあると困るので、機械的に移行を行いたい。<br>このようなお客様のお困りごとを解消するため、DCR Config Genetaor というツールをご用意しております。</p><p>以下の手順にて、DCR Config Generator を使用して、データ収集設定を Log Analytics ワークスペースから データ収集ルールへ移行することができます。</p><h2 id="DCR-Config-Generator-の仕様"><a href="#DCR-Config-Generator-の仕様" class="headerlink" title="DCR Config Generator の仕様"></a>DCR Config Generator の仕様</h2><p>このツールは、指定した Log Analytics ワークスペースに登録されている Log Analytics エージェント用の定義をもとに、データ収集ルールをデプロイするための JSON ファイルを作成するためのツールです。<br>このツールを実行することにより、以下の JSON ファイルが作成されます。</p><p>・Windows イベントログ・パフォーマンス カウンター用ファイル<br>・Linux Syslog・パフォーマンス カウンター用ファイル<br>・VM Insights 用ファイル<br>・カスタム テキスト ログ用ファイル<br>・IIS Logs 用ファイル</p><p>上記のうち、カスタム テキスト ログ定義用ファイルのみ、カスタム テキスト ログ用として使用されているのカスタム テーブルの数だけデータ収集ルール用ファイルが作成されます。<br>また、上記それぞれに ARM テンプレート用のファイル (arm_template を含むファイル)、およびコマンドによるデータ収集ルール作成時用のファイル (payload を含むファイル) が作成されます。</p><h3 id="DCR-Config-Generator-使用のための前提条件"><a href="#DCR-Config-Generator-使用のための前提条件" class="headerlink" title="DCR Config Generator 使用のための前提条件"></a>DCR Config Generator 使用のための前提条件</h3><p>DCR Config Generator を使用するためには、以下のものが必要です。<br>・PowerShell バージョン 5.1 以降。 PowerShell バージョン 7.1.3 以降の使用をお勧めします。<br>・指定したワークスペース リソースへの読み取り/書き込みアクセス権<br>・ワークスペース エージェント構成情報をプルする Az Powershell モジュール。 Az.Accounts および Az.OperationalInsights モジュールが必要です。<br>・スクリプトを実行するためのコンテキストを設定する、Connect-AzAccount および Select-AzContext の実行用の Azure 資格情報。</p><h3 id="DCR-Config-Generator-使用前の確認事項"><a href="#DCR-Config-Generator-使用前の確認事項" class="headerlink" title="DCR Config Generator 使用前の確認事項"></a>DCR Config Generator 使用前の確認事項</h3><p>現在、Log Analytics エージェントにて VM Insights をご利用されており、かつ Azure Monitor エージェント移行後も VM Insights のご利用を予定されている場合は、以下の点についてご確認をお願いいたします。</p><p>＜確認事項＞<br>移行対象とするマシンにて、Dependency Agent がインストールされているかをご確認ください。<br>マシンの [拡張機能とアプリケーション] より、[DependencyAgentLinux] もしくは [DependencyAgentWindows] が表示されているかどうかで判断が可能です。<br>Dependency Agent がインストールされているマシンについては、Log Analytics エージェントの削除後に VM Insights 用のデータ収集ルールへの紐づけが必要です。</p><h2 id="DCR-Config-Generator-の使用手順"><a href="#DCR-Config-Generator-の使用手順" class="headerlink" title="DCR Config Generator の使用手順"></a>DCR Config Generator の使用手順</h2><h3 id="手順-1"><a href="#手順-1" class="headerlink" title="手順 1"></a>手順 1</h3><p>WorkspaceConfigToDCRMigrationTool.ps1 というスクリプトをダウンロードします。<br>スクリプトはこちらよりダウンロードください。<br><a href="https://github.com/microsoft/AzureMonitorCommunity/tree/master/Azure%20Services/Azure%20Monitor/Agents/Migration%20Tools/DCR%20Config%20Generator">https://github.com/microsoft/AzureMonitorCommunity/tree/master/Azure%20Services/Azure%20Monitor/Agents/Migration%20Tools/DCR%20Config%20Generator</a></p><h3 id="手順-2"><a href="#手順-2" class="headerlink" title="手順 2"></a>手順 2</h3><p>手順 1 でダウンロードしたスクリプトを実行します。<br>実行例は以下の通りです。</p><p>&lt;実行例&gt;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$subId = &quot;&lt;subscription_id&gt;&quot;</span><br><span class="line">$rgName = &quot;&lt;resourcegroup_Name&gt;&quot;</span><br><span class="line">$workspaceName = &quot;&lt;ws_name&gt;&quot;</span><br><span class="line">$dcrName = &quot;&lt;newdcr_name&gt;&quot;</span><br><span class="line">$folderPath = &quot;&lt;結果を出力するフォルダへのパス&gt;&quot;</span><br><span class="line">.\WorkspaceConfigToDCRMigrationTool.ps1 -SubscriptionId $subId -ResourceGroupName $rgName -WorkspaceName $workspaceName -DCRName $dcrName -OutputFolder $folderPath</span><br></pre></td></tr></table></figure><p>まず上記を実行すると Azure アカウントへのログインが求められますので、ログインをお願いいたします。<br>その後、実行が完了すると、次のような出力がございます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">You entered:</span><br><span class="line"></span><br><span class="line">Subscription Id     &lt;subscription_id&gt;</span><br><span class="line">ResourceGroupName   &lt;rg_name&gt;</span><br><span class="line">Workspace Name      &lt;ws_name&gt;</span><br><span class="line"></span><br><span class="line">You are already logged into Azure</span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line">Check your output folder! (Relative path:  &lt;結果を出力するよう指定したフォルダのパス&gt;)</span><br></pre></td></tr></table></figure><p>※ この手順にて、「デジタル署名されていない」旨のエラーが出る場合は …<br><code>Get-ExecutionPolicy -list</code> により、ポリシーを確認いただいた後、<br><code>Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass</code> により、設定を変更して再度お試しください。</p><p>このツールを実行すると、$folderPath に設定したフォルダに JSON ファイルが出力されます。<br>ただし、カスタム テキスト ログ収集定義につきましては、最初に以下の選択肢が出力されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Info: A Data Collection Endpoint is required for the Ingestion of Custom Logs via DCR</span><br><span class="line">Do you want us to provision a DCE for you (in case you don&#x27;t have one)? (y/n):</span><br></pre></td></tr></table></figure><p>Azure Monitor エージェントを使用してカスタム テキスト ログの収集を行う場合、データ収集エンドポイント (DCE) が必要となります。<br>データ収集エンドポイントを事前に作成されていないお客様は、こちらの選択肢にてデータ収集エンドポイントの作成が可能です。</p><p>作成する場合は、以下の入力プロンプトが順番に表示されますので、必要な情報を入力します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Info: Provisioning a Data Collection Endpoint (DCE) on your behalf</span><br><span class="line">&gt;&gt;&gt;&gt;&gt; Sub Id: </span><br><span class="line">&gt;&gt;&gt;&gt;&gt; Resource Group: </span><br><span class="line">&gt;&gt;&gt;&gt;&gt; Name: </span><br><span class="line">&gt;&gt;&gt;&gt;&gt; Location: </span><br></pre></td></tr></table></figure><p>データ収集エンドポイントが作成されますと、以下のようなメッセージが表示されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Info: The DCE was successfully provisioned: /subscriptions/&lt;Subscription Id&gt;/resourceGroups/&lt;Resouregroup Name&gt;/providers/Microsoft.Insights/dataCollectionEndpoints/&lt;dce-Name&gt;</span><br></pre></td></tr></table></figure><p>この項目でデータ収集エンドポイントを作成した場合は、カスタム テキスト ログ収集用の JSON ファイルにてデータ収集ルールをデプロイする際、ここで作成したデータ収集エンドポイントを使用するように JSON ファイルが構成されます。</p><p>ここでデータ収集エンドポイントの作成を行わない場合は、データ収集エンドポイントのリソース ID の指定が必要です。<br>以下の入力プロンプトが表示されますので、使用するデータ収集エンドポイントのリソース ID をご指定ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please provide the full ARM ID of the DCE to use: </span><br></pre></td></tr></table></figure><p>なお、データ収集エンドポイントは Log Analytics ワークスペース、データ収集ルールと同じリージョンに作成する必要がございます。</p><h3 id="手順-3"><a href="#手順-3" class="headerlink" title="手順 3"></a>手順 3</h3><p>ツールは終了していない状況ですが、エクスプローラーなどを使用して出力された JSON ファイルを確認し、必要なファイルが存在することを確認します。<br>この手順を使用する場合、ARM テンプレートを使用するため、arm_template が含まれる json で終わるファイルが作成されていることを確認してください。<br>対象とした Log Analytics ワークスペースに Windows 用のデータ収集設定が含まれている場合は Windows 用の JSON ファイル、Linux 用のデータ収集設定が含まれている場合は Linux 用の JSON ファイル、といったように Log Analytics ワークスペースに存在するログ収集定義に対応した JSON ファイルが出力されます。<br>出力される可能性があるファイルの種類につきましては、DCR Config Generator の仕様 をご確認ください。</p><h3 id="手順-4"><a href="#手順-4" class="headerlink" title="手順 4"></a>手順 4</h3><p>出力された JSON ファイルを使用し、データ収集ルールを作成します。</p><h3 id="手順-4-I"><a href="#手順-4-I" class="headerlink" title="手順 4-I"></a>手順 4-I</h3><p>すべての JSON ファイルの出力が完了しますと、ツールにて以下の選択肢が出力されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Do you want to run a test deployment of one of the generated DCR ARM templates? (y/n):</span><br></pre></td></tr></table></figure><p>上記は JSON ファイルのテスト デプロイを行うための機能を使用するかを選択する質問でございます。<br>この設問で y を入力することで、実際に JSON ファイル (ARM テンプレート) をデプロイし、データ収集ルールを作成することが可能です。<br>※ この機能でデータ収集ルールのデプロイを実施しない場合は、個の選択肢では n を入力し、手順 4-II をご確認ください。</p><p>この機能を使用する場合は、以下のプロンプトが順番に表示されますので、必要な情報を入力します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt; Deployment Subscription:   </span><br><span class="line">&gt;&gt;&gt;&gt; Deployment Resource Group: </span><br><span class="line">&gt;&gt;&gt;&gt; ARM template file name   : </span><br></pre></td></tr></table></figure><p>※ ARM template file name の項目は、ファイル名のみを入力してください。(例: windows_dcr_arm_template.json)</p><p>正常にデプロイされますと、以下のメッセージが表示されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Info: Deployment done! Check your resource group in Azure for the newly created DCR.</span><br></pre></td></tr></table></figure><p>以下の入力プロンプトが表示されます。引き続きデプロイする場合は y を入力することで続けてのデプロイが可能です。<br>もし、これ以上デプロイしない場合は n を入力してください。DCR Config Generator の実行が終了します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Do you want to run another deployment? (y/n):</span><br></pre></td></tr></table></figure><h3 id="手順-4-II"><a href="#手順-4-II" class="headerlink" title="手順 4-II"></a>手順 4-II</h3><p>出力された JSON ファイルを使用し、データ収集ルールを作成します。<br>ここでは、Azure ポータルの [カスタム テンプレートのデプロイ] よりデータ収集ルールを作成する手順をご案内いたします。</p><h3 id="手順-4-II-1"><a href="#手順-4-II-1" class="headerlink" title="手順 4-II-1"></a>手順 4-II-1</h3><p>Azure のサービス一覧から [カスタム テンプレートのデプロイ] を選択します。<br>[エディターで独自のテンプレートを作成する] をクリック後、[ファイルの読み込み] をクリックし、出力されたテンプレート (“arm_template” が含まれている .json で終わるファイル) を読み込み [保存] をクリックします。</p><h4 id="手順-4-II-2"><a href="#手順-4-II-2" class="headerlink" title="手順 4-II-2"></a>手順 4-II-2</h4><p>必須項目を埋めて、 [確認と作成] -&gt; [作成] の順にクリックします。<br>デプロイが完了したら、作成したリソースに移動します。<br><img src="/blog/LogAnalytics/DCRConfigGenerator/4-3.png" alt="デプロイ"></p><h4 id="手順-4-II-3"><a href="#手順-4-II-3" class="headerlink" title="手順 4-II-3"></a>手順 4-II-3</h4><p>DCR とリソースの紐づけを行います。<br>※ 紐づけたいマシンの電源は、あらかじめ ON にしておく必要がございます。<br><img src="/blog/LogAnalytics/DCRConfigGenerator/4-4.png" alt="DCRとリソースの紐づけ"></p><p>手順は以上です。<br>もし、スクリプトの動作がおかしい、使用方法がよくわからない、などございましたら、ご遠慮なく弊社サポート チームへお問い合わせください。</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><ul><li>DCR Config Generator のインストールと使用<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration-tools#installing-and-using-dcr-config-generator">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration-tools#installing-and-using-dcr-config-generator</a><br><a href="https://learn.microsoft.com/en-US/azure/azure-monitor/agents/azure-monitor-agent-migration-tools#installing-and-using-dcr-config-generator">https://learn.microsoft.com/en-US/azure/azure-monitor/agents/azure-monitor-agent-migration-tools#installing-and-using-dcr-config-generator</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure Monitoring チームの加治屋です。&lt;br&gt;この記事では、Log Analytics エージェントから Azure Monitor エージェントへの移行のために使用できるツールについてご紹介いたします。&lt;/p&gt;
&lt;p&gt;※&lt;br&gt;DCR Config Generator の更新に伴い、ツールの利用方法が変更されております。&lt;br&gt;当記事は、DCR Config Generator バージョン 1.0.0 を前提として記載しております。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の診断設定とそれ以外のリソースにおける診断設定について</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToDiagnosticsSettings/</id>
    <published>2023-12-13T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.347Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回のブログでは Azure VM の診断設定と、それ以外のリソースにおける診断設定の違いをご説明します。<br>皆さんは、Azure Monitor には “診断設定” という名前の機能が 2 つ存在することをご存知ですか？<br>どちらの機能もログやメトリックを収集しますが、実は全く別の機能です。しかし、同じ名前の機能のため、この 2 つの違いについてのお問い合わせが多く寄せられます。そこで、今回はこの 2 つの機能の違いに焦点をあてて機能の概要をご説明します！</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%A8%E3%81%84%E3%81%86%E5%90%8D%E5%89%8D%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%AF-2-%E3%81%A4%E3%81%82%E3%82%8B">1. 診断設定という名前の機能は 2 つある</a></li><li><a href="#2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BB%E9%8C%B2%E8%A7%A3%E9%99%A4%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%81%94%E8%B3%AA%E5%95%8F">2. Azure VM の診断設定</a></li><li><a href="#3-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A">3. Azure Monitor の診断設定</a></li><li><a href="#4-Azure-VM-%E3%81%AE%E3%83%97%E3%83%A9%E3%83%83%E3%83%88-%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">4. Azure VM のプラット フォーム メトリックを収集する方法</a></li></ul><br><h2 id="1-診断設定という名前の機能は-2-つある"><a href="#1-診断設定という名前の機能は-2-つある" class="headerlink" title="1. 診断設定という名前の機能は 2 つある"></a>1. 診断設定という名前の機能は 2 つある</h2><p>本記事の冒頭でも記載したとおり、”診断設定” という名前の機能は 2 つあります。<br>ここでは 2 つの機能を明確に区別するため、”Azure VM の診断設定” と “Azure Monitor の診断設定” と呼ぶことにします。<br>下表は、この 2 つの機能の主な違いです。この機能の共通点は、対象リソースのメトリックやログを収集するという点です。</p><table><thead><tr><th>機能名</th><th><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure VM の診断設定</a></th><th><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">Azure Monitor の診断設定</a></th></tr></thead><tbody><tr><td>対象リソース</td><td>Azure VM</td><td><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/reference/supported-logs/logs-index">公開情報</a> に記載のリソース</td></tr><tr><td>送信するデータ</td><td>ゲスト OS のメトリックとログ</td><td>Azure プラットフォームのメトリックとログ</td></tr><tr><td>データの宛先</td><td>ストレージ アカウント、Azure Monitor メトリック、Event Hubs</td><td>Log Analytics ワークスペース、ストレージ アカウント、 <br> イベント ハブ、サード パーティの製品</td></tr><tr><td>拡張機能</td><td>あり (Azure Diagnostics 拡張機能)</td><td>なし</td></tr></tbody></table><br><h2 id="2-Azure-VM-の診断設定"><a href="#2-Azure-VM-の診断設定" class="headerlink" title="2. Azure VM の診断設定"></a>2. Azure VM の診断設定</h2><p>Azure VM に <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure Diagnostics 拡張機能</a>をインストールし、ゲスト OS のログやメトリックをストレージ アカウントに送信する機能です。Windows 用の Azure Diagnostics 拡張機能 は Windows Azure Diagnostics extension (WAD)、Linux 用は Linux Azure Diagnostics extension (LAD) と呼ばれています。Azure ポータル から対象の Azure VM を選択し、[監視] - [診断設定] から有効化することができます。設定手順の詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview#installation-and-configuration">こちら</a> をご覧ください。<br><img src="/blog/AzureMonitorEssential/HowToDiagnosticsSettings/image01.png"></p><p>Azure Monitor では、VM に拡張機能をインストールしてゲスト OS のメトリックやログを収集する機能に Log Analytics エージェントや Azure Monitor エージェントがあります。これらのエージェントとの主な違いは、ログの収集先です。<br>Log Analytics エージェントや Azure Monitor エージェントでは Log Analytics ワークスペースにログを収集します。<br>ストレージ アカウントは Log Analytics ワークスペースと比べて低コストでログを保持することが可能であり、より長い期間ログを保管することができます。そのため、低コストでログやメトリックを保管されたい場合や、より長い期間ログを保管されたいときに Azure Diagnostics 拡張機能をご利用されることが多いように思います。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Azure Diagnostics 拡張機能がサポートしている OS は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#compare-to-legacy-agents">こちら</a> をご確認ください。</p><p>ゲスト OS やメトリックに関する説明は <a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorAzVM_logs/">こちらの記事</a> をご覧ください。また、Log Analytics エージェントは 2024 年 8 月 31 日に廃止が予定されており、Azure Monitor エージェントへの移行をお願いしております。詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration">公開情報</a> をご確認ください。</p></div><br><h2 id="3-Azure-Monitor-の診断設定"><a href="#3-Azure-Monitor-の診断設定" class="headerlink" title="3. Azure Monitor の診断設定"></a>3. Azure Monitor の診断設定</h2><p>Azure プラットフォームのメトリックやログを Log Analytics ワークスペースやストレージ アカウント等に送信する機能です。<br>“Azure Monitor の診断設定” は、すべてのリソースでサポートしているわけではございません。基本的に <a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/reference/supported-logs/logs-index">公開情報</a> に掲載されているリソースでサポートされています。基本的には Azure ポータルから対象リソースを選択し、[監視] - [診断設定] から構築することが可能です。設定手順の詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal#create-diagnostic-settings">こちら</a> をご覧ください。<br><img src="/blog/AzureMonitorEssential/HowToDiagnosticsSettings/image02.png"></p><p>プラットフォームのメトリックは既定で収集されます。メトリックは Azure 基盤側のメトリック データベースに保存され、Azure ポータルの<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-getting-started">メトリック エクスプローラー</a>等から確認できます。一方で、プラットフォームのログは “Azure Monitor の診断設定” を構築しない限り、収集することはできません。プラット フォームのメトリックを既定の保持期間 (<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#platform-and-custom-metrics">93 日間</a>)以上保管したい場合やプラットフォームのログを保管/監視したい場合にご利用いただける機能です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>メトリックは、Azure リソースから一定の間隔で自動で収集される数値データです。</p><p>プラットフォーム メトリックは、Azure リソースから一定の間隔で自動で収集される数値データであり、正常性やパフォーマンスに関する情報です。</p><p>プラットフォーム のログは Azure リソース内で実行された操作に関する情報です。ログはリソースの種類によって異なります。</p><p>Azure プラットフォームのメトリックやログの詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/metrics-index">Azure Monitor のサポートされるメトリック</a> や <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/resource-logs">Azure リソース ログ</a> の公開情報をご覧ください。</p></div><br><h2 id="4-Azure-VM-のプラット-フォーム-メトリックを収集する方法"><a href="#4-Azure-VM-のプラット-フォーム-メトリックを収集する方法" class="headerlink" title="4. Azure VM のプラット フォーム メトリックを収集する方法"></a>4. Azure VM のプラット フォーム メトリックを収集する方法</h2><p>ここまでお読みいただいて「Azure VM のプラットフォーム メトリックを保管したい場合は、どうしたらいいの？」と思われた方もいるかもしれません。弊社サポートにも「Azure VM のホスト OS メトリックを Log Aanalytics ワークスペースに送信したい」というお問い合わせをよくいただきます。</p><p>Azure VM には、2 種類のメトリック (ゲスト OS メトリックとホスト OS メトリック) があります。ゲスト OS メトリックは VM 上に Azure Monitor エージェント等をインストールして収集しますが、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/microsoft-classiccompute-virtualmachines-metrics">ホスト OS メトリック (VM のホストで管理しているメトリック データ)</a> は既定で収集されます。このホスト OS メトリックは、Azure PowerShell 等で “Azure Monitor の診断設定” を構築することで、Log Analytics ワークスペース等に収集することができます。</p><p>以下は Azure PowerShell で Azure VM のプラットフォーム メトリックを Log Analytics ワークスペースに送信する設定例です。<br>“Azure Monitor の診断設定” を構築するためのコマンドの詳細につきましては、<a href="https://learn.microsoft.com/ja-jp/powershell/module/az.monitor/new-azdiagnosticsetting?view=azps-10.3.0">こちら</a> をご覧ください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$metric = @()</span><br><span class="line">$metric += New-AzDiagnosticSettingMetricSettingsObject -Enabled $true -Category AllMetrics</span><br><span class="line">New-AzDiagnosticSetting -Name &#x27;診断設定の名前&#x27; -ResourceId &lt;仮想マシンのリソース ID&gt; -WorkspaceId &lt;Log Analytics ワークスペースのリソース ID&gt; -Metric $metric</span><br></pre></td></tr></table></figure><p>“Azure Monitor の診断設定” で送信したプラットフォーム メトリックは AzureMetrics テーブルに収集されます。<br>なお、上記コマンドを実行し、ログが出力されるまで時間がかかる場合がございます。上記コマンドを実行してから約 1 ～ 2 時間後に Log Analytics ワークスペース上でログが収集されているかどうかをご確認ください。<br><img src="/blog/AzureMonitorEssential/HowToDiagnosticsSettings/image03.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>サンプル スクリプトを実行するには、Azure PowerShell をインストールいただく必要がございます。</p><p>Azure PowerShell をインストール方法は <a href="https://learn.microsoft.com/ja-jp/powershell/azure/install-azure-powershell?view=azps-10.2.0&viewFallbackFrom=azps-8.1.0">弊社公開情報</a> をご覧ください。</p><p>なお、Azure PowerShell や Azure CLI を使用する際には Azure Cloud Shell が便利です。ポータルでログインしているユーザーの認証情報が引き継がれるため、Connect-AzAccount コマンド等の実行は不要です。</p><p><a href="https://learn.microsoft.com/ja-JP/azure/cloud-shell/overview">弊社公開情報</a> にも利用方法を掲載しておりますので、ご覧いただけますと幸いです。</p></div><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回のブログでは Azure VM の診断設定と、それ以外のリソースにおける診断設定の違いをご説明します。&lt;br&gt;皆さんは、Azure Monitor には “診断設定” という名前の機能が 2 つ存在することをご存知ですか？&lt;br&gt;どちらの機能もログやメトリックを収集しますが、実は全く別の機能です。しかし、同じ名前の機能のため、この 2 つの違いについてのお問い合わせが多く寄せられます。そこで、今回はこの 2 つの機能の違いに焦点をあてて機能の概要をご説明します！&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="Diagnostics settings" scheme="https://jpazmon-integ.github.io/blog/tags/Diagnostics-settings/"/>
    
    <category term="Azure Diagnostics extension" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Diagnostics-extension/"/>
    
    <category term="WAD" scheme="https://jpazmon-integ.github.io/blog/tags/WAD/"/>
    
    <category term="LAD" scheme="https://jpazmon-integ.github.io/blog/tags/LAD/"/>
    
  </entry>
  
  <entry>
    <title>Retirement notice ： Transition to DCR-based custom log ingestion by 14 September 2026 について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToLogIngestionAPI/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToLogIngestionAPI/</id>
    <published>2023-11-28T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.435Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回の記事では、サービス正常性にて通知された「Retirement notice: Transition to DCR-based custom log ingestion by 14 September 2026」についてご説明します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E5%A0%B1%E5%91%8A%E3%81%95%E3%82%8C%E3%81%9F%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%81%AE%E5%8B%A7%E5%91%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">1. 報告された正常性の勧告について</a><ul><li><a href="#1-1-%E6%A6%82%E8%A6%81">1-1.概要</a></li><li><a href="#1-2-%E5%86%85%E5%AE%B9">1-2.内容</a></li><li><a href="#1-3-%E5%AE%9F%E6%96%BD%E3%81%84%E3%81%9F%E3%81%A0%E3%81%8D%E3%81%9F%E3%81%84%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">1-3.実施いただきたいアクション</a></li></ul></li><li><a href="#2-%E7%A7%BB%E8%A1%8C%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">2. 移行が必要かどうかを確認する方法</a><ul><li><a href="#2-1-%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8A%E5%AE%A2%E6%A7%98">2-1. 影響を受けるお客様</a></li><li><a href="#2-2-%E7%A7%BB%E8%A1%8C%E5%AF%BE%E8%B1%A1%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">2-2. 移行対象のテーブルを確認する手順</a></li></ul></li><li><a href="#3-%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86">3. 移行手順</a></li></ul><br><h2 id="1-報告された正常性の勧告について"><a href="#1-報告された正常性の勧告について" class="headerlink" title="1. 報告された正常性の勧告について"></a>1. 報告された正常性の勧告について</h2><h3 id="1-1-概要"><a href="#1-1-概要" class="headerlink" title="1-1. 概要"></a>1-1. 概要</h3><table><thead><tr><th>項目名</th><th>項目値</th></tr></thead><tbody><tr><td>題名</td><td>Retirement notice: Transition to DCR-based custom log ingestion by 14 September 2026</td></tr><tr><td>追跡 ID</td><td>2V91-5TZ</td></tr><tr><td>影響を受けるサービス</td><td>Azure Monitor</td></tr><tr><td>影響を受けるリージョン</td><td>Global</td></tr><tr><td>正常性イベントの種類</td><td>正常性の勧告</td></tr></tbody></table><br><h3 id="1-2-内容"><a href="#1-2-内容" class="headerlink" title="1-2. 内容"></a>1-2. 内容</h3><p>You’re receiving this notice because you currently use the Data Collector API for ingestion of custom logs to Azure Monitor logs.<br>On 14 September 2026, we’ll retire Data Collector API for ingesting custom logs to Azure Monitor logs. Before that date, you’ll need to transition to the Data Collection Rules based log ingestion API that provides all the functionality of the Data Collector API, as well as new ones, including:</p><ul><li>Secure token-based authentication</li><li>Full control over the shape of the destination table</li><li>Ability to filter and transform data during ingestion</li></ul><br><h3 id="1-3-実施いただきたいアクション"><a href="#1-3-実施いただきたいアクション" class="headerlink" title="1-3. 実施いただきたいアクション"></a>1-3. 実施いただきたいアクション</h3><p>To avoid ingestion errors and data loss, <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/custom-logs-migrate">transition to the DCR-based Log Ingestion API</a> before 14 September 2026. Data Collector API endpoints will become unavailable after that date.</p><br><h2 id="2-移行が必要かどうかを確認する方法"><a href="#2-移行が必要かどうかを確認する方法" class="headerlink" title="2. 移行が必要かどうかを確認する方法"></a>2. 移行が必要かどうかを確認する方法</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-collector-api?tabs=powershell">データ コレクター API</a> は 2026 年 9 月 14 日に廃止される予定のため、当該 API をご利用されている場合は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-ingestion-api-overview">ログ インジェスト API</a> への移行をお願いしております。</p><p>データ コレクター API は REST API を通じて、任意の端末および任意の方法にて HTTP アクセスしてログを送信する機能です。<br>お客様のアプリケーションなどで使用されるような機能でございますが、各種 Azure サービスの監視機能で内部的に使用されている場合もございます。</p><p>本通知では “お客様のアプリケーションなどで使用されている場合” にログ インジェスト API への移行をお願いするものです。<br>各種 Azure サービスの監視機能で内部的に使用されているテーブルにつきましては、移行の詳細が決まり次第 <a href="https://learn.microsoft.com/ja-jp/azure/service-health/overview">サービス正常性</a>や弊社公開情報等で対応方法等が通知される予定ですので、弊社海外部門からの通知をお待ちいただけますと幸いです。</p><br><h3 id="2-1-影響を受けるお客様"><a href="#2-1-影響を受けるお客様" class="headerlink" title="2-1. 影響を受けるお客様"></a>2-1. 影響を受けるお客様</h3><p>お客様のアプリケーション等でデータ コレクター API をご利用いただいている場合に影響がございます。</p><br><h3 id="2-2-移行対象のテーブルを確認する手順"><a href="#2-2-移行対象のテーブルを確認する手順" class="headerlink" title="2-2. 移行対象のテーブルを確認する手順"></a>2-2. 移行対象のテーブルを確認する手順</h3><p>以下の条件を満たす場合は、データ コレクター API をご利用されている可能性がございます。</p><ul><li>テーブルの種類が “カスタム テーブル (クラシック)” であること</li><li>テーブルの SourceSystem 列の値が “RestAPI” であること</li></ul><p>テーブルの種類が “カスタム テーブル (クラシック)” は以下の用途で使用されますが、本通知は「B. データ コレクター API によるカスタム ログ収集」を行われている場合に該当します。</p><ul><li>A. <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-custom-logs">Log Analytics エージェントによるカスタム ログ収集</a></li><li>B. データ コレクター API によるカスタム ログ収集</li><li>C. 各種 Azure サービスの監視機能によるカスタム ログ収集</li></ul><p>「A. Log Analytics エージェントによるカスタム ログ収集」と「B. データ コレクター API によるカスタム ログ収集」は、テーブルの SourceSystem 列の値で識別することが可能です。一方で「B. データ コレクター API によるカスタム ログ収集」と「C. 各種 Azure サービスの監視機能によるカスタム ログ収集」の明確な判別方法はございません。</p><p>「B. データ コレクター API によるカスタム ログ収集」の場合は、お客様にてテーブルを作成いただくものであるため、テーブル名もお客様ご自身で指定されたものです。そのため、該当するテーブルがお客様にて作成されたテーブル名かどうかをご判断いただくしか方法がございません。</p><p>これから紹介する確認手順で「B. データ コレクター API によるカスタム ログ収集」と「C. 各種 Azure サービスの監視機能によるカスタム ログ収集」の判別が困難なテーブルがございましたら、弊社公開情報等をご確認いただくか、弊社サポートまでお問い合わせいただけますと幸いです。</p><br><p>それでは、テーブルの種類を確認する方法と、テーブルの SourceSystem 列の値を確認する方法をご紹介します。</p><h4 id="1-Azure-ポータルからテーブルの種類を確認する"><a href="#1-Azure-ポータルからテーブルの種類を確認する" class="headerlink" title="1. Azure ポータルからテーブルの種類を確認する"></a>1. Azure ポータルからテーブルの種類を確認する</h4><p>1-1. Azure ポータルで [Log Analytics ワークスペース] &gt; [テーブル] を開きます。</p><p>1-2. [種類] が “カスタム テーブル (クラシック)” のテーブルがあるかどうかを確認します。<br>以下例ですと、赤枠線部分のテーブルがデータ コレクター API を利用している可能性があります。”カスタム テーブル (クラシック)” のテーブルが存在した場合は、SourceSystem 列の値を確認します。<br><img src="/blog/LogAnalytics/HowToMigrateToLogIngestionAPI/image01.png"></p><br><h4 id="2-テーブルの-SourceSystem-列の値を確認する"><a href="#2-テーブルの-SourceSystem-列の値を確認する" class="headerlink" title="2. テーブルの SourceSystem 列の値を確認する"></a>2. テーブルの SourceSystem 列の値を確認する</h4><p>2-1. Azure ポータルで [Log Analytics ワークスペース] &gt; [ログ] を開きます。</p><p>2-2. “カスタム テーブル (クラシック)” のテーブルに対してクエリを実行し、SourceSystem 列の値を確認します。SourceSystem 列の値が <em><strong>RestAPI</strong></em> の場合は、データ コレクター API でログが収集されています。テーブル名より「B. データ コレクター API によるカスタム ログ収集」もしくは「C. 各種 Azure サービスの監視機能によるカスタム ログ収集」に該当するかどうかをご確認ください。<br><img src="/blog/LogAnalytics/HowToMigrateToLogIngestionAPI/image02.png"></p><p>SourceSystem 列の値が <em><strong>OpsManager</strong></em> の場合は、Log Analytics エージェントによってログが収集されています。<br>この場合は「A. Log Analytics エージェントによるカスタム ログ収集」に該当するテーブルであり、「B. データ コレクター API によるカスタム ログ収集」に該当しませんので、移行対象のテーブルではございません。<br><img src="/blog/LogAnalytics/HowToMigrateToLogIngestionAPI/image03.png"></p><br><h2 id="3-移行手順"><a href="#3-移行手順" class="headerlink" title="3. 移行手順"></a>3. 移行手順</h2><p>ログ インジェスト API への移行手順は、<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/logs/custom-logs-migrate">こちら</a> の公開情報をご覧ください。<br>移行を実施する際には、必ず前提条件を満たしているかどうかをご確認いただきますようお願いいたします。<br>また、ログ インジェスト API では 2 種類のリソース (<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal">データ収集エンドポイント</a>および<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/data-collection-rule-overview?tabs=portal">データ収集ルール</a>) を作成する必要があります。このリソースの作成方法を含むログ インジェスト API の利用方法につきましては、弊社公開情報の<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/tutorial-logs-ingestion-portal">チュートリアル</a> にも掲載されておりますので、併せてご確認いただけますと幸いです。</p><p>Azure Monitor のログ インジェスト API<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-ingestion-api-overview">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-ingestion-api-overview</a></p><p>チュートリアル: ログ インジェスト API を使用して Azure Monitor ログにデータを送信する (Azure portal)<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/tutorial-logs-ingestion-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/tutorial-logs-ingestion-portal</a></p><p>Logs ingestion API を使用して Azure Monitor にデータを送信するサンプル コード<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/tutorial-logs-ingestion-code?tabs=powershell#sample-code">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/tutorial-logs-ingestion-code?tabs=powershell#sample-code</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回の記事では、サービス正常性にて通知された「Retirement notice: Transition to DCR-based custom log ingestion by 14 September 2026」についてご説明します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="ログ インジェスト API" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%83%AD%E3%82%B0-%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88-API/"/>
    
    <category term="データ コレクター API" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%B3%E3%83%AC%E3%82%AF%E3%82%BF%E3%83%BC-API/"/>
    
  </entry>
  
  <entry>
    <title>リソース変更を検知するアラートを作成する</title>
    <link href="https://jpazmon-integ.github.io/blog/ame/HowToResourceChangeAlert/"/>
    <id>https://jpazmon-integ.github.io/blog/ame/HowToResourceChangeAlert/</id>
    <published>2023-11-08T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.511Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの佐々木です。<br>今回はリソース変更を検知するアラートが作成できる様になりましたので、その設定方法やサンプルクエリを紹介させていただきます。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>Log Analytics から Azure Resource Graph へクエリ出来る様になりました</li><li>Azure Resource Graph にはリソース変更を記録するテーブルがあります</li><li>サンプルクエリ</li><li>設定手順</li><li>より複雑なサンプルクエリ<ul><li>操作者を確認したい</li></ul></li></ul><h2 id="Log-Analytics-から-Azure-Resource-Graph-へクエリ出来る様になりました"><a href="#Log-Analytics-から-Azure-Resource-Graph-へクエリ出来る様になりました" class="headerlink" title="Log Analytics から Azure Resource Graph へクエリ出来る様になりました"></a>Log Analytics から Azure Resource Graph へクエリ出来る様になりました</h2><p>Log Analytics より Azure Resource Graph (ARG) へクエリが出来る様になりました。</p><p>このアップデートにより、Log Analytics 内に記録されたログだけでなく、ARG へのクエリ結果を アラート ルールにて監視できる様になりました。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/azure-monitor-data-explorer-proxy#query-data-in-azure-resource-graph-preview">Azure Resource Graph のデータに対してクエリを実行する (プレビュー)</a></p><p>※ 2023/11/9 時点でプレビューでの公開となります。</p><h2 id="Azure-Resource-Graph-にはリソース変更を記録するテーブルがあります"><a href="#Azure-Resource-Graph-にはリソース変更を記録するテーブルがあります" class="headerlink" title="Azure Resource Graph にはリソース変更を記録するテーブルがあります"></a>Azure Resource Graph にはリソース変更を記録するテーブルがあります</h2><p>resourcechanges というテーブルに ARM のリソース変更履歴が記録されています。</p><p>例えば、properties 列を見る事で以下が確認可能です。</p><ul><li>changeTypeがUpdate  -&gt; 更新されたという事になります。</li><li>changes -&gt; 変更があったプロパティと新しい値(newValue)、過去の値(previousValue)が入ります。</li></ul><p>※このテーブルの保持期間は14日で変更できないため、長期的な保管は行われません。</p><p>これを踏まえ、以下の properties 列のサンプルでは、microsoft.network/networkinterfaces リソースに MAC アドレスのプロパティが追加された事がわかります。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;targetResourceType&quot;</span>: <span class="string">&quot;microsoft.network/networkinterfaces&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;targetResourceId&quot;</span>: <span class="string">&quot;/subscriptions/***/resourceGroups/1627/providers/Microsoft.Network/networkInterfaces/1627vm837&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;changeAttributes&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;previousResourceSnapshotId&quot;</span>: <span class="string">&quot;08585022745207585807_a9667ff8-fb74-82a5-ffd1-419287f1063f_3620098351_1699332364&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;newResourceSnapshotId&quot;</span>: <span class="string">&quot;08585022744595915807_7aa3a796-054b-ebe0-df8e-673414ebfde7_82482185_1699332425&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;correlationId&quot;</span>: <span class="string">&quot;43c5d84a-c3bb-47c7-bdc5-7ecf69209fc2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;changesCount&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2023-11-07T04:47:05.8860000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;changedByType&quot;</span>: <span class="string">&quot;User&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;clientType&quot;</span>: <span class="string">&quot;Azure Portal&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;operation&quot;</span>: <span class="string">&quot;Microsoft.Network/networkInterfaces/write&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;changedBy&quot;</span>: <span class="string">&quot;***@microsoft.com&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;changeType&quot;</span>: <span class="string">&quot;Update&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;changes&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;properties.virtualMachine.id&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;propertyChangeType&quot;</span>: <span class="string">&quot;Insert&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;changeCategory&quot;</span>: <span class="string">&quot;User&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;previousValue&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;newValue&quot;</span>: <span class="string">&quot;/subscriptions/***/resourceGroups/1627/providers/Microsoft.Compute/virtualMachines/1627vm&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;properties.primary&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;propertyChangeType&quot;</span>: <span class="string">&quot;Insert&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;changeCategory&quot;</span>: <span class="string">&quot;User&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;previousValue&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;newValue&quot;</span>: <span class="string">&quot;True&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;properties.macAddress&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;propertyChangeType&quot;</span>: <span class="string">&quot;Insert&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;changeCategory&quot;</span>: <span class="string">&quot;User&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;previousValue&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;newValue&quot;</span>: <span class="string">&quot;60-45-BD-66-0D-B8&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>この様に changeType が Update のログが新しく記録された場合、何か設定値が変更されたという事がわかります。</p><p>詳しくは以下ドキュメントをご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/how-to/get-resource-changes?tabs=azure-cli">https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/how-to/get-resource-changes?tabs=azure-cli</a></li></ul><h2 id="サンプルクエリ"><a href="#サンプルクエリ" class="headerlink" title="サンプルクエリ"></a>サンプルクエリ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arg(&quot;&quot;).resourcechanges</span><br><span class="line">| extend timestamp = todatetime(properties[&quot;changeAttributes&quot;][&quot;timestamp&quot;])</span><br><span class="line">| extend changes = properties[&quot;changes&quot;]</span><br><span class="line">| extend ResourceId = tostring(properties[&quot;targetResourceId&quot;])</span><br><span class="line">| extend CorrelationId = tostring(properties[&quot;changeAttributes&quot;][&quot;correlationId&quot;]) // AzureActivity (アクティビティログ) と結合可能</span><br><span class="line">| where timestamp &gt;= ago(5min) // arg(&quot;&quot;) で検索するテーブルにはアラートルールの粒度や期間指定が機能しないため、クエリで期間を指定します。</span><br></pre></td></tr></table></figure><p><img src="https://github.com/sakkuntyo/cssblog/assets/20591351/01da721e-2011-4df9-ab3a-1feed3008c21" alt="image"></p><h2 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h2><p>以下に、変更履歴を検知するアラートルールの作成方法を記載させていただきます。</p><p>この操作を行うアカウントでは、サブスクリプションスコープ の 閲覧者権限 と 閲覧者 ロールが必要になります。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#reader">閲覧者</a><br><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#role-based-access-control-administrator-preview">ロールベースのアクセス制御管理者</a></p><ol><li>Azureポータルにログインし、何れかの Log Analytics &gt; ログ ブレードを開きます。</li><li>例えばサンプルのクエリを指定し、一度検索します。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arg(&quot;&quot;).resourcechanges</span><br><span class="line">| extend timestamp = todatetime(properties[&quot;changeAttributes&quot;][&quot;timestamp&quot;])</span><br><span class="line">| extend changes = properties[&quot;changes&quot;]</span><br><span class="line">| extend ResourceId = tostring(properties[&quot;targetResourceId&quot;])</span><br><span class="line">| extend CorrelationId = tostring(properties[&quot;changeAttributes&quot;][&quot;correlationId&quot;]) // AzureActivity (アクティビティログ) と結合可能</span><br><span class="line">| where timestamp &gt;= ago(5min) // arg(&quot;&quot;) で検索するテーブルにはアラートルールの粒度や期間指定が機能しないため、クエリで期間を指定します。</span><br></pre></td></tr></table></figure><p><img src="https://github.com/sakkuntyo/cssblog/assets/20591351/01da721e-2011-4df9-ab3a-1feed3008c21" alt="image"></p><ol start="3"><li>“新しいアラート ルール” より アラートルールの作成画面へ移動します。</li></ol><p><img src="https://github.com/sakkuntyo/cssblog/assets/20591351/58c560b1-c619-414d-9403-3185e507ae5f" alt="image"></p><ol start="4"><li>条件 セクションでは例えば以下の設定値とします。</li></ol><p><img src="https://github.com/sakkuntyo/cssblog/assets/20591351/f90210e5-94b1-4ab2-931f-1671ca13b631" alt="image"></p><ul><li>測定<ul><li>メジャー: テーブルの行</li><li>集計の種類: カウント</li><li>集計の粒度: 5分</li></ul></li><li>ディメンションで分割する<ul><li>リソースID 列: ResourceId (これによりリソース毎にアラートが発生する様になります。)</li><li>ディメンション: 指定無し</li></ul></li><li>アラート ロジック<ul><li>演算子: 次の値より大きい</li><li>しきい値: 0</li><li>評価の頻度: 5分</li></ul></li></ul><ol start="5"><li><p>アクション セクションでは必要に応じてアクショングループを指定します。</p></li><li><p>詳細 セクションにて、 System assigned managed Identity を指定し、作成します。</p></li></ol><p>ARG へのクエリにはサブスクリプションスコープの閲覧者ロールが必要ですが、Default を選択した場合、アラートルールは ARG を閲覧できず検知されません。</p><p><img src="https://github.com/sakkuntyo/cssblog/assets/20591351/086a3aca-12de-417b-8095-0f9910dd2cea" alt="image"></p><ol start="7"><li>アラートルールの マネージドID の権限設定</li></ol><p>モニター &gt; アラート &gt; アラート ルール &gt; ID (プレビュー) を確認します。<br>この時、もしもシステム割り当て済 が オフ となっている場合にはオンにします。</p><p><img src="https://github.com/sakkuntyo/cssblog/assets/20591351/5989c4b1-1194-461b-806a-d2d9ff0db5af" alt="image"></p><p>Azure ロールの割り当て へ進み、サブスクリプションスコープの閲覧者権限を付与します。</p><p>以上で設定は完了です。</p><h3 id="より複雑なサンプルクエリ"><a href="#より複雑なサンプルクエリ" class="headerlink" title="より複雑なサンプルクエリ"></a>より複雑なサンプルクエリ</h3><h4 id="操作者を確認したい"><a href="#操作者を確認したい" class="headerlink" title="操作者を確認したい"></a>操作者を確認したい</h4><p>操作者はアクティビティログの Caller プロパティに記載されています。</p><p>診断設定で アクティビティログ を Log Analytics に送ると、AzureActivity テーブル上にアクティビティログが記録されますが、</p><p>AzureActivity テーブルは resourcechanges テーブルと CorrelationId が同じになるため、結合可能です。</p><p>そのため、以下のクエリで結合し、検索する事ができます。このクエリをアラートルールで指定し、検知する事も可能です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">arg(&quot;&quot;).resourcechanges</span><br><span class="line">| extend timestamp = todatetime(properties[&quot;changeAttributes&quot;][&quot;timestamp&quot;])</span><br><span class="line">| extend changes = properties[&quot;changes&quot;]</span><br><span class="line">| extend ResourceId = tostring(properties[&quot;targetResourceId&quot;])</span><br><span class="line">| extend CorrelationId = tostring(properties[&quot;changeAttributes&quot;][&quot;correlationId&quot;]) // AzureActivity (アクティビティログ) と結合可能</span><br><span class="line">| where timestamp &gt;= ago(14d) // arg(&quot;&quot;) で検索するテーブルにはアラートルールの粒度や期間指定が機能しないため、クエリで期間を指定します。</span><br><span class="line">| join kind=leftouter (</span><br><span class="line">  AzureActivity // Administrative を送る診断設定が必要です。</span><br><span class="line">  | where CategoryValue =~ &quot;Administrative&quot;</span><br><span class="line">  | where ActivityStatusValue =~ &quot;Start&quot; // 一度の操作 でStart,Success 等複数のログが出るため、Start のログのみ対象とします。</span><br><span class="line">)</span><br><span class="line">on CorrelationId </span><br><span class="line">| order by TimeGenerated</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの佐々木です。&lt;br&gt;今回はリソース変更を検知するアラートが作成できる様になりましたので、その設定方法やサンプルクエリを紹介させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
  </entry>
  
  <entry>
    <title>Migrate to Azure Monitor agent–based VM insights by 31 August 2024 について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/</id>
    <published>2023-11-05T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.427Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回の記事では、サービス正常性にて通知された「Migrate to Azure Monitor agent–based VM insights by 31 August 2024 」についてご説明します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1.-%E5%A0%B1%E5%91%8A%E3%81%95%E3%82%8C%E3%81%9F%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%81%AE%E5%8B%A7%E5%91%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">1. 報告された正常性の勧告について</a><ul><li><a href="#1-1-%E6%A6%82%E8%A6%81">1-1.概要</a></li><li><a href="#1-2-%E5%86%85%E5%AE%B9">1-2.内容</a></li><li><a href="#1-3-%E5%AE%9F%E6%96%BD%E3%81%84%E3%81%9F%E3%81%A0%E3%81%8D%E3%81%9F%E3%81%84%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">1-3.実施いただきたいアクション</a></li></ul></li><li><a href="#2-3%E7%A7%BB%E8%A1%8C%E5%AF%BE%E8%B1%A1%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%A8%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86">2. 移行対象のマシンを確認する方法と移行手順</a><ul><li><a href="#2-1-%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8A%E5%AE%A2%E6%A7%98">2-1. 影響を受けるお客様</a></li><li><a href="#2-2-%E7%A7%BB%E8%A1%8C%E5%AF%BE%E8%B1%A1%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">2-2. 移行対象のマシンを確認する方法</a></li><li><a href="#2-3-%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86">2-3.移行手順</a></li></ul></li><li><a href="#3-%E7%95%99%E6%84%8F%E4%BA%8B%E9%A0%85">3. 留意事項</a></li></ul><br><h2 id="1-報告された正常性の勧告について"><a href="#1-報告された正常性の勧告について" class="headerlink" title="1. 報告された正常性の勧告について"></a>1. 報告された正常性の勧告について</h2><h3 id="1-1-概要"><a href="#1-1-概要" class="headerlink" title="1-1. 概要"></a>1-1. 概要</h3><table><thead><tr><th>項目名</th><th>項目値</th></tr></thead><tbody><tr><td>題名</td><td>Action required: Migrate to Azure Monitor agent–based VM insights by 31 August 2024</td></tr><tr><td>追跡 ID</td><td>3MK1-NDG</td></tr><tr><td>影響を受けるサービス</td><td>Azure Monitor</td></tr><tr><td>影響を受けるリージョン</td><td>Global</td></tr><tr><td>正常性イベントの種類</td><td>正常性の勧告</td></tr></tbody></table><h3 id="1-2-内容"><a href="#1-2-内容" class="headerlink" title="1-2. 内容"></a>1-2. 内容</h3><p>You’re receiving this notice because you use Log Analytics agent–based VM insights.<br>On 31 August 2024, we’ll retire Log Analytics agent–based VM insights. Migrate to Azure Monitor agent–based VM insights, which offers improvements such as:</p><ul><li>Enhanced security and performance.</li><li>Data collection rules to help cut costs.</li><li>Simplified management experience, including efficient troubleshooting.</li></ul><h3 id="1-3-実施いただきたいアクション"><a href="#1-3-実施いただきたいアクション" class="headerlink" title="1-3. 実施いただきたいアクション"></a>1-3. 実施いただきたいアクション</h3><p>To ensure that you’re using a supported version of VM insights, <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-overview#migrate-from-log-analytics-agent-to-azure-monitor-agent">migrate</a> to Azure Monitor agent–based VM insights by 31 August 2024.</p><br><h2 id="2-移行対象のマシンを確認する方法と移行手順"><a href="#2-移行対象のマシンを確認する方法と移行手順" class="headerlink" title="2. 移行対象のマシンを確認する方法と移行手順"></a>2. 移行対象のマシンを確認する方法と移行手順</h2><p>Log Analytics エージェント ベースの VM insights は 2024 年 8 月末にてサポート終了を予定しております。そのため、Log Analytics エージェント ベースの VM insights をご利用されている場合は、Azure Monitor エージェント ベースの VM insights への移行をお願いしております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-overview">VM insights</a> は Azure VM や Azure Arc 対応サーバーなどの仮想マシンの監視を行う機能の一つです。仮想マシンのパフォーマンスや実行中のプロセス等のデータを収集します。VM insights では、Azure Monitor エージェントもしくは Log Analytics エージェントと、Dependency エージェントを仮想マシンにインストールし、ログを収集します。しかし、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/log-analytics-agent">2024 年 8 月末で Log Analytics エージェントが廃止される</a>ため、Azure Monitor エージェント ベースで VM insights をご利用いただく必要がございます。</p><br><h3 id="2-1-影響を受けるお客様"><a href="#2-1-影響を受けるお客様" class="headerlink" title="2-1. 影響を受けるお客様"></a>2-1. 影響を受けるお客様</h3><p>Log Analytics エージェント ベースの VM insights をご利用いただいているお客様に影響がございます。</p><br><h3 id="2-2-移行対象のマシンを確認する方法"><a href="#2-2-移行対象のマシンを確認する方法" class="headerlink" title="2-2. 移行対象のマシンを確認する方法"></a>2-2. 移行対象のマシンを確認する方法</h3><p>Azure ポータルで [モニター] &gt; [分析情報] &gt; [仮想マシン] &gt; [概要] タブ&gt; [監視対象] タブの画面を開きます。<br>移行対象のマシンは「データ収集ルール」欄にて「Azure Monitor エージェントを使用した構成」と表示されるマシンです。<br>Azure Monitor エージェント ベースの VM insights をご利用されている場合は、「データ収集ルール」欄に構成に使用しているデータ収集ルールの名前が表示されます。一方で、Log Analytics エージェント ベースの VM insights の場合は「データ収集ルール」欄にて、データ収集ルール名は表示されません。ただし、該当のマシンが稼働していなければ、下記画面の情報は正しい評価が表示されない可能性がありますのでご留意ください。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image1.png"></p><br><p><em><strong>&lt;補足 1.&gt;</strong></em><br>2 つのエージェント (Azure Monitor エージェントおよび Log Analytics エージェント) によって VM insights が有効化されている場合は「データ収集ルール」欄にてデータ収集ルール名が表示されます。お客様の環境で 2 つのエージェントを併行稼働されている場合は、以下画面にて Log Analytics エージェントでも VM insights が有効化されていないかどうかをご確認ください。</p><ol><li><p>Azure ポータルで [モニター] &gt; [分析情報] &gt; [仮想マシン] &gt; [概要] タブ&gt; [監視対象] タブの画面を開き、該当のマシンを選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image2.png"></p></li><li><p>以下のように表示された場合は Log Analytics エージェントでも VM insights が有効化されているため、Log Analytics エージェントのアンインストールが必要です。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image3.png"></p></li></ol><br><p><em><strong>補足 2.</strong></em><br>稼働していないマシンがある場合は、Azure ポータルの [仮想マシン] &gt; [拡張機能とアプリケーション] の画面より、インストールされているエージェントをご確認ください。Log Analytics エージェントと Dependency エージェントがインストールされている場合は、Log Analytics エージェント ベースの VM insights をご利用されている可能性がございます。</p><p>&lt;Windows マシン&gt;<br>MicrosoftMonitoringAgent (Windows 用の Log Analytics エージェント) と DependencyAgentWindows がインストールされているかどうかをご確認ください。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image9.png"></p><p>&lt;Linux マシン&gt;<br>OmsAgentForLinux (Linux 用の Log Analytics エージェント) および DependencyAgentLinux がインストールされているかどうかをご確認ください。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image8.png"></p><p>該当のマシンに Azure Monnitor エージェントもインストールされており、どちらのエージェントで VM insights が有効化されているかどうかが分からない場合は、ログ収集先の Log Analytics ワークスペースで以下のようなクエリを実行してください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// サンプル クエリ</span><br><span class="line">Heartbeat</span><br><span class="line">| where TimeGenerated &gt; ago(<span class="number">90</span>d)</span><br><span class="line">| join kind=inner (</span><br><span class="line">    InsightsMetrics</span><br><span class="line">    | where TimeGenerated &gt; ago(<span class="number">90</span>d)</span><br><span class="line">    | where Origin == &#x27;vm.azm.ms&#x27;</span><br><span class="line">) on $left.SourceComputerId == $right.AgentId</span><br><span class="line">| distinct Category, Computer, SourceComputerId</span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/insightsmetrics">InsightsMetrics</a> テーブルは、VM insights を有効化すると収集されるログです。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/heartbeat">Heartbeat</a> は Log Analytics エージェントや Azure Monitor エージェントによって既定で収集されます。Log Analytics エージェントや Azure Monitor エージェントには、クライアントを一意に識別可能なエージェント ID という識別子があります。このエージェント ID は Heartbeat テーブルの SourceComputerId 列、InsightsMetrics テーブルの AgentId 列で確認することができます。</p><p>Heartbeat の Category は、エージェントによって値が異なります。Log Analytics エージェントの場合は Category の値が Direct Agent、Azure Monitor エージェントでは Category の値が Azure Monitor Agent です。<br>そのため、両方のテーブルを SourceComputerId と AgentId で結合し、Heartbeat の Category の値を確認すれば、どちらのエージェントによって VM insights が有効化されているかどうかを確認できます。</p><p>以下は上記クエリの実行結果の例です。この例では Cateogry の値が Direct Agent のマシンは VM-B と VM-C です。VM-B は Azure Monitor エージェントが既にインストールされており、両方のエージェントで VM insights が有効化されています。<br>※ ログの保持期間を超過し上記クエリを実行してもログが存在しない場合は、マシンを起動してご確認ください。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image12.png"></p><br><h3 id="2-3-移行手順"><a href="#2-3-移行手順" class="headerlink" title="2-3.移行手順"></a>2-3.移行手順</h3><p>Log Analytics エージェントをアンインストールして、Azure Monitor エージェントでの VM insights の有効化が必要です。<br>Log Analytics エージェントと Azure Monitor エージェントは共存可能ですので、Azure Monitor エージェントによる VM insights を構成後に Log Analytics エージェントをアンインストールいただいても構いません。移行方法は 2 つございます。</p><ul><li>A. Log Analytics エージェントをアンインストールしてから Azure Monitor エージェントで VM insights を有効化する</li><li>B. Azure Monitor エージェント で VM insights を有効化してから Log Analytics エージェントをアンインストールする</li></ul><br><h4 id="A-Log-Analytics-エージェントをアンインストールしてから-Azure-Monitor-エージェントで-VM-insights-を有効化する"><a href="#A-Log-Analytics-エージェントをアンインストールしてから-Azure-Monitor-エージェントで-VM-insights-を有効化する" class="headerlink" title="A. Log Analytics エージェントをアンインストールしてから Azure Monitor エージェントで VM insights を有効化する"></a>A. Log Analytics エージェントをアンインストールしてから Azure Monitor エージェントで VM insights を有効化する</h4><ol><li>Azure ポータルの [仮想マシン] &gt; [拡張機能とアプリケーション] の画面より Log Analytics エージェントと Dependency エージェントをアンインストールします。Windows の場合は MicrosoftMonitoringAgent と DependencyAgentWindows、Linux の場合は OmsAgentForLinux および DependencyAgentLinux です。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image9.png"></li></ol><ol start="2"><li><p><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/vm/vminsights-enable-portal#enable-vm-insights-for-azure-monitor-agent">こちら</a> の手順で Azure Monitor エージェント を使用して VM Insights を有効化します。</p></li><li><p>Log Analytics ワークスペースから VMInsights ソリューションを削除します。Azure ポータルの [Log Analytics ワークスペース] &gt; [レガシー ソリューション] の画面より VMInsights ソリューションを選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image10.png"></p></li><li><p>VMInsights ソリューションの [概要] を開き、[削除] を選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image11.png"></p></li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>上記 A. の手順で移行した場合、作業中に Heartbeat や InsightsMetrics 等のデータが収集されません。</p><p>そのため、例えば Heartbeat に対するアラート ルールを設定している場合は発報する可能性があります。</p></div><br><h4 id="B-Azure-Monitor-エージェントで-VM-insights-を有効化してから-Log-Analytics-エージェントをアンインストールする"><a href="#B-Azure-Monitor-エージェントで-VM-insights-を有効化してから-Log-Analytics-エージェントをアンインストールする" class="headerlink" title="B. Azure Monitor エージェントで VM insights を有効化してから Log Analytics エージェントをアンインストールする"></a>B. Azure Monitor エージェントで VM insights を有効化してから Log Analytics エージェントをアンインストールする</h4><ol><li><p>Log Analytics エージェントで VM insights を有効化している場合、[モニター] &gt; [分析情報] の [仮想マシン] &gt; [概要] タブ&gt; [監視対象] タブで「Azure Monitor エージェントを使用した構成」リンクが表示されます。こちらをクリックすることで、Azure Monitor エージェントを利用した VM insights を有効化できます。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image1.png"></p></li><li><p>既存の VM insights 用のデータ収集ルールを選択するか、データ収集ルールを新規作成します。ログを収集する Log Analytics ワークスペースと VM insights で収集するログの種類を選択します。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-portal#enable-vm-insights-for-azure-monitor-agent">こちら</a> の公開情報をご覧ください (以下はデータ収集ルールを新規作成する際に表示される画面です)。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image4.png"></p></li><li><p>しばらく待機しますと、Azure Monitor エージェントのインストールが完了し、Heartbeat や InsightsMetrics 等のログが二重に収集されることを確認できます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// サンプル クエリ</span><br><span class="line">InsightsMetrics</span><br><span class="line">| where TimeGenerated &gt; ago(<span class="number">30</span>m)</span><br><span class="line">| where Computer contains &quot;&lt;コンピュータ名&gt;&quot;</span><br><span class="line">| summarize count() by bin(TimeGenerated, <span class="number">1</span>m)</span><br><span class="line">| <span class="built_in">sort</span> by TimeGenerated asc</span><br></pre></td></tr></table></figure><p><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image5.png"></p></li><li><p>また、Azure ポータルの [仮想マシン] &gt; [分析情報] 画面でもログが重複して収集されている旨のメッセージが表示されます。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image6.png"></p></li><li><p>Azure Monitor エージェントによるログ収集 (ログが二重に収集されていること) を確認してから、Azure ポータルの [仮想マシン] &gt; [拡張機能とアプリケーション] の画面より Log Analytics エージェントをアンインストールします。Windows の場合は MicrosoftMonitoringAgent、Linux の場合は OmsAgentForLinux をアンインストールします。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image7.png"></p></li><li><p>Log Analytics ワークスペースから VMInsights ソリューションを削除します。Azure ポータルの [Log Analytics ワークスペース] &gt; [レガシー ソリューション] の画面より VMInsights ソリューションを選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image10.png"></p></li><li><p>VMInsights ソリューションの [概要] を開き、[削除] を選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/image11.png"></p></li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>上記 B. の手順の場合は、作業中はログが二重に収集されることをご留意ください。</p><p>重複してログが収集されることにより、ログ アラート ルールが発報することがございます。</p></div><br><h3 id="3-留意事項"><a href="#3-留意事項" class="headerlink" title="3. 留意事項"></a>3. 留意事項</h3><p>今回ご紹介した移行手順は、あくまで VM insights のための移行手順です。<br>VM insights 以外の監視データを収集するように Log Analytics エージェントを構成されている場合、<br>Log Analytics エージェントをアンインストールすれば、今まで Log Analytics エージェントによってログは収集されなくなります。<br>Log Analytics エージェントで VM insights 以外の収集設定もされている場合は、下記弊社公開情報をご参照いただき Azure Monitor エージェントによる収集設定をご実施いただくようお願いいたします。</p><p>また、Log Analytics エージェントと Azure Monitor エージェントの前提条件 (ネットワーク要件等) が異なります。<br>Azure Monitor エージェントの前提条件は下記弊社公開情報にまとめておりますので、移行手順を実施する前に必ずご確認いただきますようお願いいたします。</p><p>Azure Monitor エージェントの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview</a></p><p>Azure Monitor エージェントを管理する<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=azure-portal#prerequisites">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=azure-portal#prerequisites</a></p><p>Azure Monitor エージェントのネットワーク設定を定義する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows</a></p><p>Azure Monitor エージェントを使用して仮想マシンからイベントとパフォーマンス カウンターを収集する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal</a></p><p>Azure Monitor エージェントを使用して Syslog イベントを収集する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-syslog">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-syslog</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回の記事では、サービス正常性にて通知された「Migrate to Azure Monitor agent–based VM insights by 31 August 2024 」についてご説明します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor エージェント" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88/"/>
    
    <category term="Log Analytics エージェント" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88/"/>
    
    <category term="VM insights" scheme="https://jpazmon-integ.github.io/blog/tags/VM-insights/"/>
    
    <category term="分析情報" scheme="https://jpazmon-integ.github.io/blog/tags/%E5%88%86%E6%9E%90%E6%83%85%E5%A0%B1/"/>
    
  </entry>
  
  <entry>
    <title>ワークスペースベースの Application Insights への移行についてのよくあるご質問</title>
    <link href="https://jpazmon-integ.github.io/blog/applicationInsights/migrateWorkspaceAiFAQ/"/>
    <id>https://jpazmon-integ.github.io/blog/applicationInsights/migrateWorkspaceAiFAQ/</id>
    <published>2023-10-31T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.523Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの六浦です。</p><p>サービス正常性 BTNG-JT8 にて通知されている Application Insights のクラシックからワークスペースベースへの移行に関するよくあるご質問をご紹介します。<br>移行を行う際に疑問点があれば、是非ご確認ください。</p><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><ul><li><a href="#Q1-%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF-Application-Insights-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E5%88%A4%E6%96%AD%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q1. クラシック Application Insights を使用しているかどのように判断できますか</a></li><li><a href="#Q2-%E8%A4%87%E6%95%B0%E3%81%AE-Application-Insights-%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E4%B8%80%E6%8B%AC%E3%81%A7%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF%E3%81%8B%E5%88%A4%E6%96%AD%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B">Q2. 複数の Application Insights に対して一括でクラシックか判断する方法はありますか</a></li><li><a href="#Q3-%E9%80%A3%E7%B6%9A%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E5%88%A4%E6%96%AD%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q3. 連続エクスポートを使用しているかはどのように判断できますか</a></li><li><a href="#Q4-%E7%A7%BB%E8%A1%8C%E5%89%8D%E5%BE%8C%E3%81%A7-Application-Insights-%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%81%AB%E5%B7%AE%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B">Q4. 移行前後で Application Insights のログに対するコストに差はありますか</a></li><li><a href="#Q5-%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E7%A7%BB%E8%A1%8C%E3%81%97%E3%81%9F%E3%82%89%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B">Q5. どのように移行したらいいですか</a></li><li><a href="#Q6-%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF-Application-Insights-%E3%81%A7%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AF%E5%A4%89%E6%9B%B4%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%A7%E3%81%99%E3%81%8B">Q6. クラシック Application Insights で設定したアラート ルールは変更が必要ですか</a></li><li><a href="#Q7-%E7%A7%BB%E8%A1%8C%E4%B8%AD%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%AF%E6%AC%A0%E6%90%8D%E3%81%97%E3%81%BE%E3%81%99%E3%81%8B">Q7. 移行中のログは欠損しますか</a></li><li><a href="#Q8-%E7%A7%BB%E8%A1%8C%E4%B8%AD%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%AF%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF%E3%81%A8%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E3%81%A9%E3%81%A1%E3%82%89%E3%81%AB%E8%A8%98%E9%8C%B2%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8B">Q8. 移行中のログはクラシックとワークスペースベースのどちらに記録されますか</a></li><li><a href="#Q9-%E7%A7%BB%E8%A1%8C%E5%89%8D%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF-Application-Insights-%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%92%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%84%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%B3%E3%83%94%E3%83%BC%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q9. 移行前のクラシック Application Insights のログを、Log Analytics ワークスペースやストレージ アカウントにコピーすることはできますか</a></li><li><a href="#Q10-%E7%A7%BB%E8%A1%8C%E3%81%AE%E5%88%87%E3%82%8A%E6%88%BB%E3%81%97%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q10. 移行の切り戻しはできますか</a></li><li><a href="#Q11-%E7%A7%BB%E8%A1%8C%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E3%82%89%E3%81%A9%E3%81%86%E3%81%97%E3%81%9F%E3%82%89%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B">Q11. 移行に失敗したらどうしたらいいですか</a></li><li><a href="#Q12-%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E7%B5%82%E4%BA%86%E5%BE%8C%E3%80%81%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF-Application-Insights-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E7%B6%9A%E3%81%91%E3%81%A6%E3%81%84%E3%82%8B%E3%81%A8%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%AF%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B">Q12. サポート終了後、クラシック Application Insights を利用し続けているとテレメトリは収集されなくなりますか</a></li><li><a href="#Q13-%E7%A7%BB%E8%A1%8C%E3%81%8C%E6%88%90%E5%8A%9F%E3%81%97%E3%81%9F%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E7%A2%BA%E8%AA%8D%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q13. 移行が成功したことはどのように確認できますか</a></li><li><a href="#Q14-%E7%A7%BB%E8%A1%8C%E5%89%8D%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%AF%E3%81%84%E3%81%A4%E3%81%BE%E3%81%A7%E5%8F%82%E7%85%A7%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q14. 移行前のログはいつまで参照できますか</a></li><li><a href="#Q15-%E7%A7%BB%E8%A1%8C%E3%81%AB%E4%BC%B4%E3%81%84%E3%80%81Application-Insights-%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E5%BF%85%E8%A6%81%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B">Q15. 移行に伴い、Application Insights にログを出力しているアプリケーションの設定を変更する必要はありますか</a></li><li><a href="#Q16-Application-Insights-%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AF%E7%A7%BB%E8%A1%8C%E6%99%82%E3%81%AB%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%B8%E3%81%AE%E5%BD%B1%E9%9F%BF%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F%E3%81%BE%E3%81%9F%E3%80%81%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%EF%BC%9F">Q16. Application Insights にログを出力しているアプリケーションは移行時にパフォーマンスへの影響はありますか？また、アプリケーションの再起動が必要になりますか？</a></li></ul><br><h3 id="Q1-クラシック-Application-Insights-を使用しているかどのように判断できますか"><a href="#Q1-クラシック-Application-Insights-を使用しているかどのように判断できますか" class="headerlink" title="Q1. クラシック Application Insights を使用しているかどのように判断できますか"></a>Q1. クラシック Application Insights を使用しているかどのように判断できますか</h3><p>Application Insights の [概要] に「ワークスペース」が表示されない場合は、クラシック Application Insights と判断できます。<br>また、クラシック Application Insights には、廃止に関する警告が表示されます。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q1-1.png"></p><p>「ワークスペース」が設定されている場合、ワークスペースベースの Application Insights をご利用のため、移行作業は不要です。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q1-2.png"></p><h3 id="Q2-複数の-Application-Insights-に対して一括でクラシックか判断する方法はありますか"><a href="#Q2-複数の-Application-Insights-に対して一括でクラシックか判断する方法はありますか" class="headerlink" title="Q2. 複数の Application Insights に対して一括でクラシックか判断する方法はありますか"></a>Q2. 複数の Application Insights に対して一括でクラシックか判断する方法はありますか</h3><p>Resource Graph エクスプローラーで以下のクエリを実行することでクラシック Application Insights の有無を確認できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line">| where subscriptionId == &quot;&lt;サブスクリプション ID&gt;&quot;</span><br><span class="line">| where type == &quot;microsoft.insights/components&quot;</span><br><span class="line">| extend mode = properties.IngestionMode</span><br><span class="line">| where mode has &quot;ApplicationInsights&quot;</span><br><span class="line">| project name, resourceGroup, subscriptionId, location, id, mode, properties</span><br></pre></td></tr></table></figure><p>結果に表示されたリソースがクラシック Application Insights です。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q2-1.png"></p><p>Resource Graph エクスプローラーについては、<a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/first-query-portal">こちらの弊社公開情報</a>をご参照ください。</p><h3 id="Q3-連続エクスポートを使用しているかはどのように判断できますか"><a href="#Q3-連続エクスポートを使用しているかはどのように判断できますか" class="headerlink" title="Q3. 連続エクスポートを使用しているかはどのように判断できますか"></a>Q3. 連続エクスポートを使用しているかはどのように判断できますか</h3><p>クラシック Application Insights の [連続エクスポート] をご確認ください。<br>以下のように設定が表示されれば、連続エクスポートを使用していると判断できます。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q3-1.png"></p><p>一方で、以下のように「エクスポート先が設定されていません。[追加] をクリックして開始してください。」と表示される場合、連続エクスポートの設定はないと判断できます。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q3-2.png"></p><h3 id="Q4-移行前後で-Application-Insights-のログに対するコストに差はありますか"><a href="#Q4-移行前後で-Application-Insights-のログに対するコストに差はありますか" class="headerlink" title="Q4. 移行前後で Application Insights のログに対するコストに差はありますか"></a>Q4. 移行前後で Application Insights のログに対するコストに差はありますか</h3><p>移行前後で Application Insights のログに対するコストに差はありません。<br>Application Insights のコストについてはこちらの<a href="https://jpazmon-integ.github.io/blog/applicationInsights/aboutCostOfAi/">ブログ</a>もご参照ください</p><h3 id="Q5-どのように移行したらいいですか"><a href="#Q5-どのように移行したらいいですか" class="headerlink" title="Q5. どのように移行したらいいですか"></a>Q5. どのように移行したらいいですか</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/convert-classic-resource#migrate-your-resource">弊社公開情報の手順</a> をご参考ください。<br>なお、移行の前に <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/convert-classic-resource#prerequisites">前提条件</a>を満たしているか十分に確認ください。</p><h3 id="Q6-クラシック-Application-Insights-で設定したアラート-ルールは変更が必要ですか"><a href="#Q6-クラシック-Application-Insights-で設定したアラート-ルールは変更が必要ですか" class="headerlink" title="Q6. クラシック Application Insights で設定したアラート ルールは変更が必要ですか"></a>Q6. クラシック Application Insights で設定したアラート ルールは変更が必要ですか</h3><p>いいえ。クラシック Application Insights で設定したアラート ルールは、移行後も引き続き動作します。<br>そのため、移行に伴いアラート ルールの設定を変更する必要はありません。</p><h3 id="Q7-移行中のログは欠損しますか"><a href="#Q7-移行中のログは欠損しますか" class="headerlink" title="Q7. 移行中のログは欠損しますか"></a>Q7. 移行中のログは欠損しますか</h3><p>いいえ。移行中のログは欠損しません。</p><h3 id="Q8-移行中のログはクラシックとワークスペースベースのどちらに記録されますか"><a href="#Q8-移行中のログはクラシックとワークスペースベースのどちらに記録されますか" class="headerlink" title="Q8. 移行中のログはクラシックとワークスペースベースのどちらに記録されますか"></a>Q8. 移行中のログはクラシックとワークスペースベースのどちらに記録されますか</h3><p>移行中の状況によって、クラシックに保存されるログと移行後のワークスペースに保存されるログがあります。<br>具体的に移行中のどのタイミングで移行後のワークスペースに保存され始めるかについては、公開可能な情報はございません。<br>そのため、移行作業中のログをご確認いただく際は、移行後の Log Analytics ワークスペースからではなく、Application Insights リソースの [ログ] からご確認ください。</p><h3 id="Q9-移行前のクラシック-Application-Insights-のログを、Log-Analytics-ワークスペースやストレージ-アカウントにコピーすることはできますか"><a href="#Q9-移行前のクラシック-Application-Insights-のログを、Log-Analytics-ワークスペースやストレージ-アカウントにコピーすることはできますか" class="headerlink" title="Q9. 移行前のクラシック Application Insights のログを、Log Analytics ワークスペースやストレージ アカウントにコピーすることはできますか"></a>Q9. 移行前のクラシック Application Insights のログを、Log Analytics ワークスペースやストレージ アカウントにコピーすることはできますか</h3><p>クラシック Application Insights に保存されたログをLog Analytics ワークスペースに出力する機能はありません。<br>また、連続エクスポートを除いてストレージ アカウントにログを出力することはできず、連続エクスポートが設定される以前に取り込まれたログをストレージ アカウントに出力する機能もありません。<br>すでにクラシック Application Insights に取り込まれたログをストレージ アカウントへログを保存する際は、利用者様にて以下のいずれかの手順でログを出力したファイルをストレージ アカウントに保存ください。</p><ul><li>Application Insights の [ログ] ブレードから検索した結果を CSV で出力<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q9-1.png"></li></ul><ul><li>Application Insights のログを取得する <a href="https://learn.microsoft.com/ja-jp/rest/api/Application-Insights/query/get?tabs=HTTP">REST API</a> で取得したログをファイルへ出力</li></ul><h3 id="Q10-移行の切り戻しはできますか"><a href="#Q10-移行の切り戻しはできますか" class="headerlink" title="Q10. 移行の切り戻しはできますか"></a>Q10. 移行の切り戻しはできますか</h3><p>いいえ、切り戻しはできません。<br>移行作業に懸念点がある場合は、新たにワークスペースベースの Application Insights リソースをご用意いただき、アプリケーションのログの出力先をクラシック Application Insights からワークスペースベースの Application Insights に変更ください。</p><h3 id="Q11-移行に失敗したらどうしたらいいですか"><a href="#Q11-移行に失敗したらどうしたらいいですか" class="headerlink" title="Q11. 移行に失敗したらどうしたらいいですか"></a>Q11. 移行に失敗したらどうしたらいいですか</h3><p>現時点では、移行に失敗した事例は確認しておりません。<br>もし移行後に不具合が発生した際は、弊社サポート サービスまでお問い合わせください。</p><h3 id="Q12-サポート終了後、クラシック-Application-Insights-を利用し続けているとテレメトリは収集されなくなりますか"><a href="#Q12-サポート終了後、クラシック-Application-Insights-を利用し続けているとテレメトリは収集されなくなりますか" class="headerlink" title="Q12. サポート終了後、クラシック Application Insights を利用し続けているとテレメトリは収集されなくなりますか"></a>Q12. サポート終了後、クラシック Application Insights を利用し続けているとテレメトリは収集されなくなりますか</h3><p>いいえ、サポート終了後も引き続きテレメトリを収集できます。<br>ただし、2024 年 2 月 29 日以降はサポートを受けることはできません。<br>そのため、クラシック Application Insights にて問題が発生した場合、お問い合わせいただいても対応できない可能性があります。<br>また、今後クラシック Application Insights 自体のご利用ができなくなる可能性もございます。<br>サポート終了後もクラシック Application Insights を使用する際は、これらの点を予めご留意ください。</p><h3 id="Q13-移行が成功したことはどのように確認できますか"><a href="#Q13-移行が成功したことはどのように確認できますか" class="headerlink" title="Q13. 移行が成功したことはどのように確認できますか"></a>Q13. 移行が成功したことはどのように確認できますか</h3><p>Application Insights の [概要] に「ワークスペース」の設定を確認できれば移行は成功しております。<br>または、Log Analytics ワークスペースの [ログ] から Application Insights のログを参照できれば、移行が成功したと判断できます。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q1-2.png"></p><h3 id="Q14-移行前のログはいつまで参照できますか"><a href="#Q14-移行前のログはいつまで参照できますか" class="headerlink" title="Q14. 移行前のログはいつまで参照できますか"></a>Q14. 移行前のログはいつまで参照できますか</h3><p>クラシック Application Insights で設定されていたログの保持期間までログを参照できます。<br>クラシック Application Insights の保持期間は [使用とコストの見積もり] &gt; [データ保持期間] から確認できます。<br><img src="/blog/applicationInsights/migrateWorkspaceAiFAQ/q14-1.png"></p><h3 id="Q15-移行に伴い、Application-Insights-にログを出力しているアプリケーションの設定を変更する必要はありますか"><a href="#Q15-移行に伴い、Application-Insights-にログを出力しているアプリケーションの設定を変更する必要はありますか" class="headerlink" title="Q15. 移行に伴い、Application Insights にログを出力しているアプリケーションの設定を変更する必要はありますか"></a>Q15. 移行に伴い、Application Insights にログを出力しているアプリケーションの設定を変更する必要はありますか</h3><p>いいえ、移行後もアプリケーション側の設定を変更することなく、Application Insights に引き続きログを収集できます。</p><h3 id="Q16-Application-Insights-にログを出力しているアプリケーションは移行時にパフォーマンスへの影響はありますか？また、アプリケーションの再起動が必要になりますか？"><a href="#Q16-Application-Insights-にログを出力しているアプリケーションは移行時にパフォーマンスへの影響はありますか？また、アプリケーションの再起動が必要になりますか？" class="headerlink" title="Q16. Application Insights にログを出力しているアプリケーションは移行時にパフォーマンスへの影響はありますか？また、アプリケーションの再起動が必要になりますか？"></a>Q16. Application Insights にログを出力しているアプリケーションは移行時にパフォーマンスへの影響はありますか？また、アプリケーションの再起動が必要になりますか？</h3><p>いいえ。Application Insights にログを出力しているアプリケーションの動作に影響はありませんので、ご安心ください。</p><hr><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>また、弊社公開情報の <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/convert-classic-resource#frequently-asked-questions">よく寄せられる質問</a> やクラシックとワークスペースベースの違いに関する<a href="https://jpazmon-integ.github.io/blog/applicationInsights/aboutDifferentTypesOfAi/">ブログ</a> もあわせてご確認いただけますと幸いです。</p><p>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの六浦です。&lt;/p&gt;
&lt;p&gt;サービス正常性 BTNG-JT8 にて通知されている Application Insights のクラシックからワークスペースベースへの移行に関するよくあるご質問をご紹介します。&lt;br&gt;移行を行う際に疑問点があれば、是非ご確認ください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
    <category term="Application Insights" scheme="https://jpazmon-integ.github.io/blog/tags/Application-Insights/"/>
    
  </entry>
  
  <entry>
    <title>ログ アラート ルールにおけるアクションのミュート機能とは</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowToAlertMuteAction/</id>
    <published>2023-10-29T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.343Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は、ログ アラート ルールにおけるアクションのミュート機能をご紹介します！</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%88%E3%81%A8%E3%81%AF">1. アクションのミュートとは</a></li><li><a href="#2-%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%9F%E4%BE%8B">2. アクションがミュートされた例</a></li><li><a href="#3-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AE%E9%81%95%E3%81%84">3. アラート処理ルールとの違い</a></li></ul><h2 id="1-アクションのミュートとは"><a href="#1-アクションのミュートとは" class="headerlink" title="1. アクションのミュートとは"></a>1. アクションのミュートとは</h2><p>“アクションのミュート” とは、ステートレス ログ アラートの発報後にアクション グループを一定期間実行しない機能です。<br>この機能は、ログ アラート ルールの [詳細] タブの [詳細設定オプション] で設定することができます。<br>Azure Monitor には、アラート ルールの閾値を満たす度に発報する <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateless-alerts"><em><strong>ステートレス アラート</strong></em></a> と、アラート ルールの閾値を満たしたときに一度だけ発報し、アラートが解決したとみなされた時に解決を通知する <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts"><em><strong>ステートフル アラート</strong></em></a> があります。ステートレス アラートでは、アラート ルールの閾値を満たす度に発報しますので、通常はアラートが発報する度にアクション グループが実行されます。しかし、この “アクションのミュート” 機能を利用しますと、アラートが発報してから一定期間はアクション グループが実行されないため、アラートが通知されません。</p><p>(*) ログ アラート ルールの編集画面の [詳細] タブ &gt; [詳細設定オプション] です。<br><img src="/blog/AzureMonitorEssential/HowToAlertMuteAction/image01.png"></p><br><h2 id="2-アクションがミュートされた例"><a href="#2-アクションがミュートされた例" class="headerlink" title="2. アクションがミュートされた例"></a>2. アクションがミュートされた例</h2><p>実際にアクションのミュート機能を利用したときのアクション グループの実行履歴を紹介します。<br>ここでは、5 分毎に Heartbeat を確認するログ アラート ルールを用意しました。アクションのミュート機能を有効化し、ミュート期間を 1 時間と指定しました。この設定ですと、1 回目の発報した時刻から 1 時間以内にアラートが発報しても、アクション グループは実行されず、アラートは通知されません。</p><p>では、アラートが発報した時刻とアクション グループの実行履歴を見てみましょう！<br>このアラート ルールでは 22:03 に初めてアラートが発報しています。そのため 22:03 から 1 時間後の 23:03 までは、アラートが発報してもアクション グループは実行されません (黄色セル部分がミュート期間を表します)。以下の例では 22:08 や 22:13 にアラートが発報していますが、ミュート期間内のためアラートは通知されません。一方で、23:08 の発報はミュート期間外であるため、アクション グループが実行され、アラートが通知されます。<br><img src="/blog/AzureMonitorEssential/HowToAlertMuteAction/image02.png"></p><p>アクション グループの実行履歴は、Azure portal の [モニター] - [アラート] の [履歴] タブで確認することができます。<br>1 回目に発報した 22:03 と、ミュート期間内に発報した 22:08 の履歴を確認してみましょう。<br>以下は 22:03 の履歴です。1 回目の発報のため、アクション グループが実行されていることが分かります。<br><img src="/blog/AzureMonitorEssential/HowToAlertMuteAction/image03.png"></p><p>一方で、22:08 の履歴ではアラートが発報していますが、アクション グループが実行されていないことが分かります。<br><img src="/blog/AzureMonitorEssential/HowToAlertMuteAction/image04.png"></p><br><h2 id="3-アラート処理ルールとの違い"><a href="#3-アラート処理ルールとの違い" class="headerlink" title="3. アラート処理ルールとの違い"></a>3. アラート処理ルールとの違い</h2><p>ここまでお読みいただいて、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AlertProcessingRule/">アラート処理ルール</a> と何が違うの？と思った方もいらっしゃるかもしれません。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-processing-rules?tabs=portal">アラート処理ルール</a> もアクション グループを抑制する機能があります。アラート処理ルールとの違いは、このミュート機能は、あくまで “特定のアラート ルールに関連付けられたアクション グループの通知を一定期間ミュートする” という点です。</p><p>アラート処理ルールは、発生したアラートに対してアクション グループを適用/抑制します。単一のリソースからサブスクリプションまでさまざまなリソースをスコープに適用し、複数のアラート ルールを対象にアクション グループを抑制することが可能です。また、アクション グループを抑制する時間帯を指定できる等、より柔軟にアクション グループを制御することができます。</p><p>一方で、アクションのミュートはミュートする期間を指定することはできますが、ミュートする時間帯を指定することはできません。また、アラート ルール単位で設定する必要があります。そのため、定期メンテナンスなど、特定の時間帯にアラート通知を抑制したい場合はアラート処理ルール、時間帯に関わらずアラートが発報してからある一定期間通知を抑制した場合はアクションのミュート機能のご利用をご検討ください。</p><br><p>今回はアクションのミュート機能をご紹介しました。いかがでしたでしょうか。<br>上記内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は、ログ アラート ルールにおけるアクションのミュート機能をご紹介します！&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="ログ アラート ルール" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB/"/>
    
    <category term="アクションのミュート" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%88/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのアクセス制御モードの違いについて</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/AccessControlMode/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/AccessControlMode/</id>
    <published>2023-09-03T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.363Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの秋田です。<br>本ブログでは、以下の公開情報に記載されています Log Analytics ワークスペースのアクセス制御モードについて、具体例を用いて違いをご説明します。</p><ul><li>アクセス制御モード<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#access-control-mode">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#access-control-mode</a></li></ul><br><span id="more"></span><p>ユーザーが Log Analytics ワークスペースにアクセスする際に、どのような権限を持っていればどのデータを閲覧可能とするかを定義する設定です。<br>アクセス制御モードには、”ワークスペースのアクセス許可が必要” と “リソースまたはワークスペースのアクセス許可を使用” の 2 つがあります。<br>2019 年 3 月以降に作成された Log Analytics ワークスペースは、アクセス制御モードが既定で “リソースまたはワークスペースのアクセス許可を使用” となっています。</p><p>アクセス制御モードの確認および変更方法は以下の公開情報をご参照ください。</p><ul><li>ワークスペースのアクセス制御モードを構成する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#configure-access-control-mode-for-a-workspace">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#configure-access-control-mode-for-a-workspace</a></li></ul><h1 id="アクセス-モードとは"><a href="#アクセス-モードとは" class="headerlink" title="アクセス モードとは"></a>アクセス モードとは</h1><p>各アクセス制御モードを説明するにあたり、前提知識として似た名前のアクセス モードについて先にお話しします。<br>アクセス モードとは一言でいうと、どのように Log Analytics ワークスペースにアクセスをするかです。<br>アクセス モードには、ワークスペース コンテキストとリソース コンテキストの 2 種類があります。</p><h2 id="ワークスペース-コンテキスト"><a href="#ワークスペース-コンテキスト" class="headerlink" title="ワークスペース コンテキスト"></a>ワークスペース コンテキスト</h2><p>ワークスペース コンテキストで Log Analytics ワークスペースにアクセスするとは、<br>Log Analytics ワークスペースの [ログ] メニューよりログを確認することを指します。<br><img src="/blog/LogAnalytics/AccessControlMode/image01.png"></p><h2 id="リソース-コンテキスト"><a href="#リソース-コンテキスト" class="headerlink" title="リソース コンテキスト"></a>リソース コンテキスト</h2><p>リソース コンテキストで Log Analytics ワークスペースにアクセスするとは、<br>リソース (例. 仮想マシン) の画面左側メニューにある [ログ] メニューより Log Analytics ワークスペースにアクセスしてログを確認することを指します。<br><img src="/blog/LogAnalytics/AccessControlMode/image02.png"></p><p>//参考情報</p><ul><li>アクセス モード<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#access-mode">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#access-mode</a></li></ul><h1 id="アクセス制御モードによる差異について"><a href="#アクセス制御モードによる差異について" class="headerlink" title="アクセス制御モードによる差異について"></a>アクセス制御モードによる差異について</h1><p>ワークスペース コンテキストで Log Analytics ワークスペースにアクセスする場合、アクセス制御モードに依らず Log Analytics ワークスペースへのアクセス権限により情報の閲覧可否が決まるため、<br>アクセス制御モードによる差異はありません。</p><p>リソース コンテキストで Log Analytics ワークスペースにアクセスする場合は以下の通りです。<br>アクセス制御モードが “ワークスペースへのアクセス許可が必要” の場合、権限があるリソースのデータのうち、権限がある Log Analytics ワークスペースに格納されているデータのみが閲覧可能です。<br>一方で、アクセス制御モードが “リソースまたはワークスペースのアクセス制御” の場合、権限があるリソースのデータであれば、<br>データが格納されている Log Analytics ワークスペースに対して権限を持っていなくても、リソースに関するすべてのデータが閲覧可能です。</p><h1 id="具体例"><a href="#具体例" class="headerlink" title="具体例"></a>具体例</h1><p>“アクセス制御モードによる差異について” に記載した内容を、具体例を用いてご説明します。</p><h2 id="シナリオ"><a href="#シナリオ" class="headerlink" title="シナリオ"></a>シナリオ</h2><p>&lt;構成&gt;<br><img src="/blog/LogAnalytics/AccessControlMode/image03.jpg"><br>VM A, VM B の 2 台の VM があり、どちらの VM についても、<br>Log Analytics ワークスペース A にはパフォーマンス データを送信し、Log Analytics ワークスペース B にはイベント ログを送信しているとします。</p><p>&lt;権限付与状況&gt;<br><img src="/blog/LogAnalytics/AccessControlMode/image04.jpg"><br>ユーザーには、以下の権限を付与しております。<br>VM A : 仮想マシン共同作成者権限、Log Analytics 閲覧者権限<br>VM B : 何も権限を付与しない<br>Log Analytics ワークスペース A : Log Analytics 閲覧者権限<br>Log Analytics ワークスペース B : 何も権限を付与しない</p><h2 id="ワークスペース-コンテキストでログにアクセスする場合"><a href="#ワークスペース-コンテキストでログにアクセスする場合" class="headerlink" title="ワークスペース コンテキストでログにアクセスする場合"></a>ワークスペース コンテキストでログにアクセスする場合</h2><p>アクセス制御モードに依らず、Log Analytics ワークスペースに対するアクセス権限の有無によりデータの閲覧可否を判断します。<br>そのため、どちらのアクセス制御モードについても以下の結果となります。<br>Log Analytics ワークスペース A に格納されているデータについては、VM A についても VM B についても閲覧可能。<br>権限のない Log Analytics ワークスペース B に格納されたデータは一切閲覧ができません。</p><h2 id="リソース-コンテキストでログにアクセスする場合"><a href="#リソース-コンテキストでログにアクセスする場合" class="headerlink" title="リソース コンテキストでログにアクセスする場合"></a>リソース コンテキストでログにアクセスする場合</h2><h3 id="アクセス制御モード-ワークスペースへのアクセス許可が必要の場合"><a href="#アクセス制御モード-ワークスペースへのアクセス許可が必要の場合" class="headerlink" title="アクセス制御モード : ワークスペースへのアクセス許可が必要の場合"></a>アクセス制御モード : ワークスペースへのアクセス許可が必要の場合</h3><p>VM A についての情報のうち、パフォーマンス データ (権限をもつ Log Analytics ワークスペース A に収集される) は閲覧可能であるが、<br>イベント ログ (権限を持たない Log Analytics ワークスペース B に収集される) は閲覧ができない。<br>VM B の情報については、リソースに対するアクセス権限を持たないため、一切閲覧できない。</p><h3 id="アクセス制御モード-リソースまたはワークスペースのアクセス制御の場合"><a href="#アクセス制御モード-リソースまたはワークスペースのアクセス制御の場合" class="headerlink" title="アクセス制御モード : リソースまたはワークスペースのアクセス制御の場合"></a>アクセス制御モード : リソースまたはワークスペースのアクセス制御の場合</h3><p>VM A についての情報はすべて閲覧可能である。<br>すなわち、パフォーマンス データ (権限をもつ Log Analytics ワークスペース A に収集される) も、<br>イベント ログ (権限を持たない Log Analytics ワークスペース B に収集される) も閲覧が可能である。<br>VM B の情報については、リソースに対するアクセス権限を持たないため、一切閲覧できない</p><p>今回は、Log Analytics ワークスペースのアクセス制御モードとは何かをご紹介しました。<br>最後までお読みいただき、ありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの秋田です。&lt;br&gt;本ブログでは、以下の公開情報に記載されています Log Analytics ワークスペースのアクセス制御モードについて、具体例を用いて違いをご説明します。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;アクセス制御モード&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#access-control-mode&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/manage-access?tabs=portal#access-control-mode&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Azure PowerShell で 3 万件以上のログを取得する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/QueryByPowerShell/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/QueryByPowerShell/</id>
    <published>2023-08-31T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.507Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は、Azure PowerShell で Log Analytics ワークスペースのログを取得する方法をご紹介します。</p><p>Azure ポータルで表示されるログ クエリの検索結果の上限は 30,000 件です。<br>この上限値の引き上げをご要望いただくお問い合わせをいただくことがありますが、残念ながら引き上げることはできません。<br>そのため、Azure ポータル からクエリを実行する必要がある場合は、時間範囲等で条件を指定いただき、検索結果を絞っていただくようご案内しております。</p><p>一方で Azure PowerShell からクエリを実行する場合、最大 500,000 行まで取得することが可能です。<br>そのため、今回は Azure PowerShell からクエリを実行する方法等をご紹介します！</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-Azure-%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%AB%E3%81%8B%E3%82%89%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E4%B8%8A%E9%99%90">1. Azure ポータルからクエリを実行したときの上限</a></li><li><a href="#2-Azure-PowerShell-%E3%81%8B%E3%82%89%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">2. Azure PowerShell からクエリを実行する方法</a></li><li><a href="#3-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">3. Azure PowerShell によるクエリ実行の制限に触れないように工夫して実行する方法</a></li><li><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1">参考情報</a></li></ul><br><h2 id="1-Azure-ポータルからクエリを実行したときの上限"><a href="#1-Azure-ポータルからクエリを実行したときの上限" class="headerlink" title="1. Azure ポータルからクエリを実行したときの上限"></a>1. Azure ポータルからクエリを実行したときの上限</h2><p>本ブログの冒頭でもご説明したとおり、Azure ポータルで表示されるログ クエリの検索結果の上限は 30,000 件です (*1)。<br>この上限値を引き上げることはできません。一方で、Azure ポータル ではなく Azure PowerShell からクエリを実行の場合、500,000 行までの上限に変わります。</p><p>(*1) Azure ポータルでクエリを実行し、ログ クエリの検索結果の上限に達すると、上限に達した旨のメッセージが表示されます。<br><img src="/blog/LogAnalytics/QueryByPowerShell/image02.png"></p><p>(*2) <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/service-limits#log-analytics-workspaces">Azure ポータルで実行したときの上限</a> です。<br><img src="/blog/LogAnalytics/QueryByPowerShell/image01.png"></p><p>(*3) <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/service-limits#log-analytics-workspaces">Azure PowerShell からクエリを実行したときの上限</a> です。<br><img src="/blog/LogAnalytics/QueryByPowerShell/image03.png"></p><br><br><h2 id="2-Azure-PowerShell-からクエリを実行する方法"><a href="#2-Azure-PowerShell-からクエリを実行する方法" class="headerlink" title="2. Azure PowerShell からクエリを実行する方法"></a>2. Azure PowerShell からクエリを実行する方法</h2><p>Azure PowerShell にて用意されている <a href="https://learn.microsoft.com/ja-jp/powershell/module/az.operationalinsights/invoke-azoperationalinsightsquery?view=azps-10.2.0">Invoke-AzOperationalInsightsQuery</a> のコマンドレットを利用する方法がございます。<br>以下のサンプル スクリプトでは、Azure PowerShell よりクエリを実行し CSV ファイルに出力しています。<br>ワークスペース ID は Azure Portal で該当のワークスペースを開き、[概要] のページからご確認ください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$query = &quot;Heartbeat | where TimeGenerated &gt; ago(<span class="number">3</span>d)&quot;</span><br><span class="line">$result = Invoke-AzOperationalInsightsQuery -WorkspaceId &quot;&lt;ワークスペース ID&gt;&quot; -Query $query</span><br><span class="line">$result.Results | ConvertTo-Csv &gt; &lt;出力ファイル パス&gt;</span><br></pre></td></tr></table></figure><br><p>ただし、Azure PowerShell でクエリを実行する場合も、取得するデータのサイズやクエリの実行時間等の制限がございます (*4)。<br>そのため、必ず 500,000 件のレコードが取得可能であるということではない点、ご留意ください。<br>以下の上限にも抵触し、全量のログを取得できなかった場合には、時間範囲や条件を細かく指定していただき、クエリを実行いただく必要がございます。</p><p>(*4) <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/service-limits#log-analytics-workspaces">Azure PowerShell からクエリを実行したときの上限</a> です。<br><img src="/blog/LogAnalytics/QueryByPowerShell/image04.png"></p><p>取得しようとしたデータのサイズが上限に達している場合、以下のとおりエラーが出力されます。<br>例えば、Invoke-AzOperationalInsightsQuery の結果を $result 変数に保存した場合、$result.Error に PartialError が記録されます。全量のログを取得できているかどうかを確認されたい場合は、以下のメッセージをご確認ください。<br><img src="/blog/LogAnalytics/QueryByPowerShell/image05.png"></p><p>なお、レコード数の条件に達している場合は、エラーが出力されません。<br>そのため、<a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/countoperator">count</a> 演算子で取得するログのレコード数を出力させ、全量のログを取得できているかどうかをご確認ください。<br><img src="/blog/LogAnalytics/QueryByPowerShell/image06.png"></p><br><div class="alert is-info"><p class="alert-title">Note</p><p>サンプル スクリプトを実行するには、Azure PowerShell をインストールしていただく必要がございます。</p><p>Azure PowerShell をインストール方法は <a href="https://learn.microsoft.com/ja-jp/powershell/azure/install-azure-powershell?view=azps-10.2.0&viewFallbackFrom=azps-8.1.0">弊社公開情報</a> をご欄ください。</p><p>なお、Azure PowerShell や Azure CLI を使用する際には Azure Cloud Shell が便利です。</p><p>ポータルでログインしているユーザーの認証情報が引き継がれるため、Connect-AzAccount コマンド等の実行は不要です。</p><p><a href="https://learn.microsoft.com/ja-JP/azure/cloud-shell/overview">弊社公開情報</a> にも利用方法を掲載しておりますので、ご覧いただけますと幸いです。</p></div><br><h2 id="3-Azure-PowerShell-で上限に触れないように工夫して実行する方法"><a href="#3-Azure-PowerShell-で上限に触れないように工夫して実行する方法" class="headerlink" title="3. Azure PowerShell で上限に触れないように工夫して実行する方法"></a>3. Azure PowerShell で上限に触れないように工夫して実行する方法</h2><p>クエリ実行の上限に抵触せずに、繰り返しデータを取得する方法の一例をご紹介します。<br>この方法は、レコード数で分割してログを取得します。<br>クエリで取得したデータの推定データ サイズは <a href="https://learn.microsoft.com/ja-JP/azure/data-explorer/kusto/query/estimate-data-sizefunction">estimate_data_size</a> で確認することが可能です。<br>例えば、以下のクエリでは、過去 31 日間の Syslog レコードの最大、最小、平均データ サイズを確認できます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syslog</span><br><span class="line">| where Facility == &#x27;cron&#x27;</span><br><span class="line">| where TimeGenerated between (datetime(<span class="number">2023</span>-<span class="number">08</span>-<span class="number">01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>) .. <span class="number">31</span>d)</span><br><span class="line">| summarize max(estimate_data_size(*)), min(estimate_data_size(*)), avg(estimate_data_size(*))</span><br></pre></td></tr></table></figure><br><p>弊社検証環境では、上記に該当するレコードの最小サイズが 328 バイト、最大サイズが 431 バイト、平均が 395 バイトでした。<br>つまり、全てのレコードが 431 バイトであったとしても、100,000 行で 43 MB ですので、データの最大サイズの上限 (64MB) には達しません。そのため、<a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/topoperator">top 演算子</a> を利用して 100,000 行ずつデータを取得します。top 演算子では、指定した列で並べ替えられた、先頭の N 個のレコードを返します。</p><br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 回目のクエリ (最初の <span class="number">100</span>,<span class="number">000</span> 行を出力) :</span><br><span class="line">$query = &quot;Syslog | where TimeGenerated between(datetime(<span class="number">2023</span>-<span class="number">08</span>-<span class="number">01</span>) .. <span class="number">1</span>d) | where Facility == &#x27;cron&#x27; | top <span class="number">100000</span> by TimeGenerated asc | top <span class="number">100000</span> by TimeGenerated desc&quot;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 回目のクエリ (<span class="number">100</span>,<span class="number">001</span> 行目から <span class="number">200</span>,<span class="number">000</span> 行目を出力) :</span><br><span class="line">$query = &quot;Syslog | where TimeGenerated between(datetime(<span class="number">2023</span>-<span class="number">08</span>-<span class="number">01</span>) .. <span class="number">1</span>d) | where Facility == &#x27;cron&#x27; | top <span class="number">200000</span> by TimeGenerated asc | top <span class="number">100000</span> by TimeGenerated desc&quot;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 回目のクエリ (<span class="number">200</span>,<span class="number">001</span> 行目から <span class="number">300</span>,<span class="number">000</span> 行目を出力) :</span><br><span class="line">$query = &quot;Syslog | where TimeGenerated between(datetime(<span class="number">2023</span>-<span class="number">08</span>-<span class="number">01</span>) .. <span class="number">1</span>d) | where Facility == &#x27;cron&#x27; | top <span class="number">300000</span> by TimeGenerated asc | top <span class="number">100000</span> by TimeGenerated desc&quot;</span><br></pre></td></tr></table></figure><br><p>この方法は、データの推定データ サイズからクエリの制限に触れないようにレコード数で分割する方法です。<br>そのため、レコードのデータ サイズが大きく異なるテーブルの場合は、上記の方法が効率的でない場合がございます。予めご了承ください。</p><br><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><ul><li><p>Azure Monitor でログ クエリの使用を開始する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/get-started-queries">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/get-started-queries</a></p></li><li><p>チュートリアル: 一般的な演算子について学習する<br><a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/tutorials/learn-common-operators#advanced-aggregations">https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/tutorials/learn-common-operators#advanced-aggregations</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は、Azure PowerShell で Log Analytics ワークスペースのログを取得する方法をご紹介します。&lt;/p&gt;
&lt;p&gt;Azure ポータルで表示されるログ クエリの検索結果の上限は 30,000 件です。&lt;br&gt;この上限値の引き上げをご要望いただくお問い合わせをいただくことがありますが、残念ながら引き上げることはできません。&lt;br&gt;そのため、Azure ポータル からクエリを実行する必要がある場合は、時間範囲等で条件を指定いただき、検索結果を絞っていただくようご案内しております。&lt;/p&gt;
&lt;p&gt;一方で Azure PowerShell からクエリを実行する場合、最大 500,000 行まで取得することが可能です。&lt;br&gt;そのため、今回は Azure PowerShell からクエリを実行する方法等をご紹介します！&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="クエリ" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%82%AF%E3%82%A8%E3%83%AA/"/>
    
  </entry>
  
  <entry>
    <title>7/7 に発生した障害 XMGF-5Z0 について</title>
    <link href="https://jpazmon-integ.github.io/blog/general/mdsFalseAlerts/"/>
    <id>https://jpazmon-integ.github.io/blog/general/mdsFalseAlerts/</id>
    <published>2023-07-09T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.579Z</updated>
    
    <content type="html"><![CDATA[<p>[更新履歴]  </p><ul><li>7/12 10:45 (日本時間) Post Incident Review (PIR) の「どのように対応したのか」を一部修正しました。  <ul><li>Azure Service Health を通じた最初の通知の時間に誤りがあり、2023 年 7 月 6 日 23:19 UTC (2023 年 7 月 7 日 08:19 JST) に変更しました。</li></ul></li><li>7/11 15:45 (日本時間) Post Incident Review (PIR) の抄訳を追記いたしました。  </li><li>7/10 10:00 (日本時間) ブログ公開</li></ul><p>こんにちは、Azure Monitoring サポート チームの横山です。<br>7/7 に発生した障害 XMGF-5Z0 について記載いたします。<br>この度は弊社 Azure の障害によりご不便ご迷惑をおかけし、大変申し訳ございませんでした。</p><p><a href="#summary">発生した事象と時間帯</a><br><a href="#region">事象の発生したリージョン</a><br><a href="#impact1">直接影響を受けたサービス</a><br><a href="#impact2">副次的に影響を受けたサービス</a><br><a href="#impact3">影響を受けなかったサービス</a><br><a href="#FAQ">よくあるご質問</a><br><a href="#pir">Post Incident Review (PIR) の抄訳</a><br><a href="#atLast">最後に</a></p><p><a id="summary"></a></p><h1 id="発生した事象と時間帯"><a href="#発生した事象と時間帯" class="headerlink" title="発生した事象と時間帯"></a>発生した事象と時間帯</h1><p>日本時間 7/7 8:15 - 18:00 の間、Azure Monitor 関連サービスにおけるデータの取り込みに欠損ならびに遅延が発生いたしました。<br>具体的には、問題のある構成により過剰な数の処理が発生しいたしました。これにより、ログの取り込みを行う Azure 基盤側のサービスが高負荷状態に陥り、内部で利用する認証情報の取得に失敗する事象が発生いたしました。  </p><p>Azure 基盤側のサーバー増強を行い、滞留していた処理と新規の処理を適切に処理できるよう対処いたしました。  </p><p>根本原因ならびに今後の恒久対策については現在も弊社開発にて調査、検討中です。(7/10 10:00 (日本時間) 現在)<br>なお、最新の状況は以下よりご確認いただけます。<br><a href="https://app.azure.com/h/XMGF-5Z0/">https://app.azure.com/h/XMGF-5Z0/</a> (Azure ポータル)<br><a href="https://azure.status.microsoft/ja-jp/status/history/">https://azure.status.microsoft/ja-jp/status/history/</a> (Azure の状態ページ)</p><p><a id="region"></a></p><h1 id="発生したリージョン"><a href="#発生したリージョン" class="headerlink" title="発生したリージョン"></a>発生したリージョン</h1><p>東日本、西日本を含む以下のリージョンで事象が発生いたしました。<br>Global; Australia Central; Australia Central 2; Australia East; Australia Southeast; Brazil South; Brazil Southeast; Canada Central; Canada East; Central India; Central US; Central US EUAP; East Asia; East US; East US 2; East US 2 EUAP; France Central; France South; Germany North; Germany West Central; Japan East; Japan West; Jio India Central; Jio India West; Korea Central; Korea South; North Central US; North Europe; Norway East; Norway West; Qatar Central; South Africa North; South Africa West; South Central US; South India; Southeast Asia; Sweden Central; Sweden South; Switzerland North; Switzerland West; UK South; UK West; West Central US; West Europe; West India; West US; West US 2; West US 3</p><p><a id="impact1"></a></p><h1 id="直接影響を受けたサービス"><a href="#直接影響を受けたサービス" class="headerlink" title="直接影響を受けたサービス"></a>直接影響を受けたサービス</h1><ul><li>Log Analytics エージェント、Azure Monitor エージェント、Container Insights、データ コレクタ API、ログ インジェスト API を利用した Log Analytics ワークスペースへのデータ取り込み</li><li>Microsoft Sentinel コネクタを利用した Log Log Analytics ワークスペースへのデータ取り込み</li><li>Application Insights (ワークスペース ベース) へのデータ取り込み</li><li>リソースの診断設定を利用した Log Analytics ワークスペース、ストレージ アカウント、イベント ハブへのデータ取り込み</li></ul><p><a id="impact2"></a></p><h1 id="副次的に影響を受けたサービス"><a href="#副次的に影響を受けたサービス" class="headerlink" title="副次的に影響を受けたサービス"></a>副次的に影響を受けたサービス</h1><ul><li>Log Analytics ワークスペースへのクエリを利用したログ アラート ルール</li><li>Log Analytics ワークスペースをスコープとしたメトリック アラート ルール</li><li>Log Analytics ワークスペースからストレージ アカウント、イベント ハブへのデータ エクスポート</li></ul><p><a id="impact3"></a></p><h1 id="影響を受けなかったサービス"><a href="#影響を受けなかったサービス" class="headerlink" title="影響を受けなかったサービス"></a>影響を受けなかったサービス</h1><ul><li>Log Analytics ワークスペース、Sentinel、Application Insights (ワークスペース ベース) に取り込まれたデータの参照</li><li>Application Insights (クラシック) へのデータ取り込み</li><li>Windows Azure Diagnostics (WAD)、Linux Azure Diagnostics (LAD) を利用したストレージ アカウントへのデータ取り込み</li><li>各種リソースのプラットフォーム メトリック</li><li>プラットフォーム メトリックを利用したメトリック アラート ルール</li></ul><p><a id="FAQ"></a></p><h1 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h1><p>Q. 影響を受けたサブスクリプションの確認方法はあるか？<br>A. 以下に追跡 ID: XMGF-5Z0 が表示される場合、影響を受けております。<br>[Azure ポータル] - [サービス正常性] - [サービス正常性の履歴]</p><p>Q. データの欠損はあるか？<br>A. はい、今回の障害によりデータの欠損は発生していた可能性がございます。  </p><p>Q. データの欠損を確認する方法はあるか？<br>A. もし、取り込み元のログ (イベント ログや Syslog) をお客様にて確認できる場合は、対象の取り込み先のデータと比較することで可能です。残念ながら、マイクロソフトから欠損したデータを確認することはできません。</p><p>Q. 欠損したデータの復旧は可能か？<br>A. いいえ、欠損したデータの復旧を行うことはできません。</p><p>Q. 今回の障害による返金はあるか？<br>A. いいえ、Azure Monitor 各種サービスへのデータ取り込みに関しては SLA (Service Level Agreements) が定められていないため、今回の障害による返金はございません。</p><p><a id="pir"></a></p><h1 id="Post-Incident-Review-PIR-の抄訳"><a href="#Post-Incident-Review-PIR-の抄訳" class="headerlink" title="Post Incident Review (PIR) の抄訳"></a>Post Incident Review (PIR) の抄訳</h1><p>下記に公開されている PIR の抄訳を記載いたしました。<br><a href="https://azure.status.microsoft/ja-jp/status/history/">https://azure.status.microsoft/ja-jp/status/history/</a> (Azure の状態の履歴)</p><h2 id="何が起こったのか"><a href="#何が起こったのか" class="headerlink" title="何が起こったのか"></a>何が起こったのか</h2><p>2023 年 7 月 6 日の UTC 23:15 から 7 月 7 日の UTC 9:00 (日本時間 2023 年 7 月 7 日 08:15 から 7 月 7 日 18:00) まで、Azure Monitor Log Analytics と Microsoft Sentinel の一部のデータの取り込みが失敗しました。<br>さらに、診断設定を介して収集したプラットフォーム ログは、Log Analytics、ストレージ、Event Hub、マーケットプレイスなどの顧客向けの宛先に一部のデータをルーティング (データを送信) することに失敗しました。<br>これらの失敗は、Microsoft 内のサービスのデプロイによるものであり、予想よりもはるかに高い呼び出し量を引き起こすバグが原因で、テレメトリ コントロール プレーンのリソースを使い果たしました。これによりすべてのリージョンの顧客が影響を受けました。</p><p>Sentinel 内の Security Operations Center (SOC) の機能、つまり、ハンティング クエリ、カスタム クエリを含むブック、削除されたログ データを含む範囲のインパクト テーブルをクエリしたノートブックが部分的または空の結果を返す可能性がありました。<br>Event テーブルや SecurityEvent テーブルが影響を受けた場合、相関するインシデントの調査は部分的または空の結果を示す可能性がありました。<br>残念ながら、この問題はお客様の Azure リソースの一つ以上に影響を与えました。<br>私たちはこの Post Incident Review (PIR) を提供して、何が間違っていたのか、どのように対応したのか、Microsoft が何を学び、どのように改善しているのかをまとめます。</p><h2 id="何がうまくいかなかったのか、そしてその理由は"><a href="#何がうまくいかなかったのか、そしてその理由は" class="headerlink" title="何がうまくいかなかったのか、そしてその理由は"></a>何がうまくいかなかったのか、そしてその理由は</h2><p>2023 年 7 月 3 日 UTC に Azure Container Apps サービスのコード デプロイメントが通常の Safe Deployment Practices (SDP) を介して開始され、最初に Azure の canary とステージング リージョンに展開されました。<br>このバージョンには、サービスが正常に起動しないようになってしまう、誤った構成が含まれていました。この誤った構成のため、サービスのブートストラップ コードは例外をスローし、自動的に再起動されました。これにより、ブートストラップ サービスが 5 から 10 秒ごとに再起動するループに陥りました。<br>ブートストラップ サービスが再起動されるたびに、それは構成情報をテレメトリ エージェントに提供し、サービス ホストに構成情報をインストールしました。<br>構成情報がテレメトリ ホストに送信されるたびに、テレメトリ ホストはこれを設定の変更と解釈し、したがって自分たちも現在のプロセスを終了して自動的に再起動しました。<br>アプリケーション ホストごとに、エージェント テレメトリ ホストの三つの別々のインスタンスが、5 から 10 秒ごとに再起動を繰り返していました。</p><p>テレメトリ エージェントの起動ごとに、エージェントはすぐにテレメトリ コントロール プレーンに接続し、テレメトリ構成の最新バージョンをダウンロードしました。<br>通常、このアクションはエージェント上でキャッシュされる設定であるため、数日に一度行うものです。<br>しかし、Container Apps サービスのデプロイメントが進行するにつれて、数百のホストがテレメトリ コントロール プレーンから 5 秒から 10 秒ごとにスタートアップ構成情報を要求するテレメトリ エージェントを持つようになりました。<br>Container Apps チームは、2023 年 7 月 6 日 UTC にデプロイメントの欠陥を検知し、本番環境にリリースされる前に当初予定していたデプロイメントを停止しました。<br>そして誤った構成を修正するために canary とステージング リージョンでサービスの新しいデプロイメントを開始しました。</p><p>しかし、誤った構成情報のビルドを受け取ったサービスからの各リクエストが集約された結果、テレメトリ コントロール プレーンのリソースを使い果たしました。<br>テレメトリ コントロール プレーンはグローバル サービスであり、Azure の全パブリック リージョンで稼働しているサービスに使用されています。<br>テレメトリ コントロール プレーンのリソースが枯渇すると、テレメトリの取り込みに関与する他のサービス、たとえば ingestion front door や内部でサービス間のデータをルーティングするパイプライン サービスなどが、テレメトリ コントロール プレーンに対する操作が拒否されたりタイムアウトしたりするようになり、失敗を始めました。<br>テレメトリ コントロール プレーンを単一の障害点とする設計は既知のリスクであり、その設計を見直すための改善プロジェクトが Azure Monitor において既に計画されていました。<br>しかしながら、その変更が行われる前にこの問題が発生しました。</p><h2 id="どのように対応したのか"><a href="#どのように対応したのか" class="headerlink" title="どのように対応したのか"></a>どのように対応したのか</h2><p>2023 年 7 月 6 日 12:30 UTC (2023 年 7 月 6 日 21:30 JST) までにゆっくりとテレメトリ コントロール プレーンへの影響が増大し、それが問題を引き起こすまで検出されませんでした。<br>問題が検出されたとき、テレメトリ コントロール プレーンへの負荷を発生させている原因は不明でしたが、私たちはテレメトリ コントロール プレーンに対する追加の負荷が発生していると疑い、以下のアクションを実行しました。</p><p>2023 年 7 月 6 日 14:53 UTC (2023 年 7 月 6 日 23:53 JST) - 内部でインシデント ブリッジ (インシデント対応チーム) が作成されました<br>2023 年 7 月 6 日 15:56 UTC (2023 年 7 月 7 日 00:56 JST) - ガベージ コレクター サービスの約 500 インスタンスを削除し、テレメトリ コントロール プレーンへの負荷を軽減しました<br>2023 年 7 月 6 日 16:09 UTC (2023 年 7 月 7 日 01:09 JST) - Node Diagnostics サーバーの削除を開始し、テレメトリ コントロール プレーンへの負荷を軽減しました。サーバーを削除するこの処置はその後 10 時間にわたって続けられました。<br>2023 年 7 月 6 日 20:20 UTC (2023 年 7 月 7 日 05:20 JST) - 異常に高いトラフィックの原因が特定され、関連するチームが支援に呼び出されました。<br>2023 年 7 月 6 日 23:00 UTC (2023 年 7 月 7 日 08:00 JST) - 異常なトラフィックがテレメトリ コントロール プレーンにヒットするのを防ぐために、IP アドレス ブロックが展開されました。<br>2023 年 7 月 6 日 23:15 UTC (2023 年 7 月 7 日 08:15 JST) - キャッシュ データが失効したため、お客様への影響が始まりました。<br>2023 年 7 月 6 日 23:19 UTC (2023 年 7 月 7 日 08:19 JST) - 影響を受けたサブスクリプションを持つお客様に対して、最初の通知を Azure Service Health を通じて送信しました (追跡 ID XMGF-5Z0 で送信)。<br>2023 年 7 月 7 日 01:30 UTC (2023 年 7 月 7 日 10:30 JST) - 追加の負荷を処理するためにテレメトリ コントロール プレーンに 3 つの追加クラスターが追加され、既存のクラスターの再起動を開始し、バックログの接続をクリアしました。<br>2023 年 7 月 7 日 02:45 UTC (2023 年 7 月 7 日 11:45 JST) - テレメトリ コントロール プレーンにさらに 3 つのクラスターが追加されました。<br>2023 年 7 月 7 日 05:21 UTC (2023 年 7 月 7 日 14:21 JST) - より詳細なお客様へのアップデート通知が送信されました。<br>2023 年 7 月 7 日 09:00 UTC (2023 年 7 月 7 日 18:00 JST) - コントロール プレーン API に対するコール エラー レートとコール レイテンシが通常のレベルで安定したため、インシデントの解消が宣言されました。</p><h2 id="このようなインシデントをどのようにして減らすか、または影響を軽減するか"><a href="#このようなインシデントをどのようにして減らすか、または影響を軽減するか" class="headerlink" title="このようなインシデントをどのようにして減らすか、または影響を軽減するか"></a>このようなインシデントをどのようにして減らすか、または影響を軽減するか</h2><p>私たちはお客様の信頼を獲得し、またただ正しいことを言うだけでなく、正しいことを実践することで維持されるべきだと理解しています。<br>データ保持は、すべてのクラウド サービスを担当する各エンジニアを含む、Microsoft クラウドの基本的な責任です。私たちはこのインシデントから学び、以下の改善に取り組んでいます。</p><ul><li>私たちは、テレメトリ コントロール プレーンのサービスが追加の容量で稼働していることを確認しました。 (完了)</li><li>API 呼び出しの中で異常な失敗パターンを示す特定のメトリックについて、追加のアラートを作成します。 (予定完了 : 2023 年 7 月)</li><li>コントロール プレーンに新たなポジティブ キャッシングとネガティブ キャッシングを追加することで、バッキング ストアへの負荷を軽減する予定です。 (予定完了 : 2023 年 9 月)</li><li>コア テレメトリ コントロール プレーン API に追加のスロットリングとサーキット ブレーカー パターンを導入します。 (予定完了 : 2023 年 9 月)</li><li>長期的には、テレメトリ コントロール プレーンを使用して内部向けサービスと外部向けサービスを分離します。 (予定完了 : 2023 年 12 月)</li></ul><h2 id="このようなインシデントをどのようにして影響を軽減することができますか"><a href="#このようなインシデントをどのようにして影響を軽減することができますか" class="headerlink" title="このようなインシデントをどのようにして影響を軽減することができますか"></a>このようなインシデントをどのようにして影響を軽減することができますか</h2><p>お客様はこのインシデントの影響を防止することはできませんでした。また、インシデント発生中の影響を緩和することもできませんでした。<br>一般的には、Azure の Well-Architected フレームワークとその対話的 Well-Architected レビューの指針を用いて、アプリケーションの信頼性を評価することを考慮してみてください :<br><a href="https://learn.microsoft.com/ja-JP/azure/well-architected/resiliency/">https://learn.microsoft.com/ja-JP/azure/well-architected/resiliency/</a></p><p>最後に、組織内の適切な人々が将来のサービス問題について通知を受けるようにすることを検討してください。<br>これは Azure サービス正常性のアラートを設定することで行えます。これらのアラートは、電子メール、SMS、プッシュ通知、Web フックなどをトリガーすることができます : <a href="https://aka.ms/ash-alerts">https://aka.ms/ash-alerts</a></p><h2 id="どのようにしてインシデント-レポートをより有用にすることができますか"><a href="#どのようにしてインシデント-レポートをより有用にすることができますか" class="headerlink" title="どのようにしてインシデント レポートをより有用にすることができますか"></a>どのようにしてインシデント レポートをより有用にすることができますか</h2><p>この PIR を評価し、3 問の調査を使用してフィードバックを提供することができます : <a href="https://aka.ms/AzPIR/XMGF-5Z0">https://aka.ms/AzPIR/XMGF-5Z0</a></p><p><a id="atlast"></a></p><h1 id="最後に"><a href="#最後に" class="headerlink" title="最後に"></a>最後に</h1><p>もし、本ブログに記載の内容以外について追加のご質問やご不明点がございましたら、大変お手数ではございますが、事象を受けたサブスクリプションからお問い合わせをご発行ください。<br>なお、以下についてはお問い合わせを新規ご発行いただいても回答いたしかねますので、予めご了承ください。  </p><ul><li>XMGF-5Z0 に記載されている障害の詳細、ならびに、Azure Monitor に関する内部実装  </li><li>根本原因や恒久対策について (XMGF-5Z0 を介して開発からアップデートがございますので、そちらをお待ち下さい。弊ブログも開発からの情報公開後、アップデートいたします。)</li></ul><p>改めまして、この度は弊社 Azure 障害によりご不便ご迷惑をおかけし、大変申し訳ございませんでした。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[更新履歴]  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;7/12 10:45 (日本時間) Post Incident Review (PIR) の「どのように対応したのか」を一部修正しました。  &lt;ul&gt;
&lt;li&gt;Azure Service Health を通じた最初の通知の時間に誤</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>アラート処理ルールについて</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AlertProcessingRule/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AlertProcessingRule/</id>
    <published>2023-07-06T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.335Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>Azure Monitor のアラート処理ルールという機能をご存知でしょうか。<br>アラート処理ルールでは、特定の時間帯のみアクション グループを適用したり、抑制したりすることができます。<br>今回は、アラート処理ルールの概要と、よくお問い合わせをいただく設定手順をご紹介いたします。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AF">1. アラート処理ルールとは</a></li><li><a href="#2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">2. アラート処理ルールのポイント</a><ul><li><a href="#2-1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%AF%E3%80%81%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84">2-1. アラート処理ルールで指定するスコープは、アラート ルールではない</a></li><li><a href="#2-2-%E2%80%9C%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E2%80%9D-%E3%81%A8-%E2%80%9C%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E2%80%9D-%E3%81%AE%E9%81%95%E3%81%84">2-2. “アラート ルールのスコープ” と “影響を受けるリソース” の違い</a></li><li><a href="#2-3-%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%83%87%E3%82%A3%E3%83%A1%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E5%89%B2%E3%81%A8%E3%81%AF">2-3. ログ アラート ルールのディメンション分割とは</a></li><li><a href="#2-4-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9">2-4. アラート処理ルールのスコープで指定するリソース</a></li></ul></li><li><a href="#3-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">3. アラート処理ルールの設定手順</a></li><li><a href="#4-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E9%80%9A%E7%9F%A5%E3%81%8C%E6%8A%91%E5%88%B6%E3%81%95%E3%82%8C%E3%81%9F%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">4. アラートの通知が抑制されたことを確認する方法</a></li></ul><br><h2 id="1-アラート処理ルールとは"><a href="#1-アラート処理ルールとは" class="headerlink" title="1. アラート処理ルールとは"></a>1. アラート処理ルールとは</h2><p>アラート処理ルールでは、”アクション グループによる通知の抑制 (通知を表示しない)” と、”アクション グループによる通知の適用” の二種類の機能がございます。例えば、定期メンテナンスなど、特定の時間帯にアラート通知を抑制したい場合に、アラート処理ルールを適用することで、一時的にアラートの通知を抑制することができます。なお、アラート処理ルールは、アクション グループの適用/抑制を行う機能であり、アラート ルールの実行自体を抑制するものではございませんので、ご注意ください。</p><ul><li>通知を表示しない : 発生したアラート (解決および発報) について、アクション グループを抑制します。</li><li>アクション グループの適用 : 発生したアラート (解決および発報)  について、アクション グループを適用します。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image01.png"></li></ul><br><h2 id="2-アラート処理ルールのポイント"><a href="#2-アラート処理ルールのポイント" class="headerlink" title="2. アラート処理ルールのポイント"></a>2. アラート処理ルールのポイント</h2><p>アラート処理ルールの設定手順をご紹介する前に、準備した環境を記載します。<br>今回は 3 台の仮想マシン (VM-A, VM-B, VM-C) を準備しました。<br>このマシンの Heartbeat ログを収集している Log Analytics ワークスペース (LogAnlayticsWorkspace) と、Heartbeat ログに関するログ アラート ルールが 5 つあります。今回ご紹介する手順では、アラート ルール <em><strong>Alert 3</strong></em> の通知を抑制するアラート処理ルールを設定します。</p><ul><li>仮想マシン 3 台 (VM-A, VM-B, VM-C) </li><li>Log Analytics ワークスペース (LogAnlayticsWorkspace)</li><li>ログ アラート ルール 5 つ (Alert 1, Alert 2, Alert 3, Alert 4, Alert 5) </li><li>アラート ルールに紐づかれたアクション グループ (ActionGroup)</li></ul><table><thead><tr><th>アラート ルール名</th><th>アラート ルールのスコープ (*1)</th><th>リソース ID の分割</th></tr></thead><tbody><tr><td>Alert 1</td><td>LogAnalyticsWorkspace</td><td>なし</td></tr><tr><td>Alert 2</td><td>LogAnalyticsWorkspace</td><td>あり</td></tr><tr><td>Alert 3</td><td>VM-A</td><td>なし</td></tr><tr><td>Alert 4</td><td>VM-B</td><td>なし</td></tr><tr><td>Alert 5</td><td>VM-C</td><td>なし</td></tr></tbody></table><p>(*1) 上表の “アラート ルールのスコープ” は、アラート ルールの編集画面の [スコープ] タブで指定するリソースを指します。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image03.png"></p><br><h3 id="2-1-アラート処理ルールで指定するスコープは、アラート-ルールではない"><a href="#2-1-アラート処理ルールで指定するスコープは、アラート-ルールではない" class="headerlink" title="2-1. アラート処理ルールで指定するスコープは、アラート ルールではない"></a>2-1. アラート処理ルールで指定するスコープは、アラート ルールではない</h3><p>具体的な設定手順をご紹介する前に、アラート処理ルールを設定する上でのポイントをご紹介します。</p><p>アラート処理ルールの設定で肝となる部分は、「アラート処理ルールの [スコープ]で指定するリソース」です。<br>アラート処理ルールの [スコープ] では、基本的に <em><strong>通知を抑制するアラート ルールが対象としているリソース</strong></em> を指定します。</p><p>では、この <em><strong>通知を抑制するアラート ルールが対象としているリソース</strong></em> とは、どのように確認したらよいのでしょうか。<br>結論から申し上げますと、<em><strong>通知を抑制するアラート ルールが対象としているリソース</strong></em> は、Azure ポータルの [アラート] に表示される <em><strong>影響を受けるリソース</strong></em> に該当します。時々、アラート処理ルールの [スコープ] で “通知を抑制したいアラート ルール” をご指定されているお客様がいらっしゃいますが、アラート処理ルールの [スコープ] で “アラート ルール” をご指定いただいても、通知を抑制することはできません。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image04.png"></p><br><h3 id="2-2-“アラート-ルールのスコープ”-と-“影響を受けるリソース”-の違い"><a href="#2-2-“アラート-ルールのスコープ”-と-“影響を受けるリソース”-の違い" class="headerlink" title="2-2. “アラート ルールのスコープ” と “影響を受けるリソース” の違い"></a>2-2. “アラート ルールのスコープ” と “影響を受けるリソース” の違い</h3><p>ここで注意していただきたい点は <em><strong>アラート ルールのスコープ</strong></em> と <em><strong>影響を受けるリソース</strong></em> の違いです。<br>必ずしも、<em><strong>アラート ルールのスコープ</strong></em> と <em><strong>影響を受けるリソース</strong></em> が一致するとは限りません。</p><p>今回準備したアラート ルールで発報したアラートを確認してみましょう。<br>アラート ルールのスコープで Log Analytics ワークスペース (LogAnlayticsWorkspace) を指定しているにも関わらず、<br>Alert 1 と Alert 2 では、<em><strong>影響を受けるリソース</strong></em> が異なります。なぜでしょうか？</p><p><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image11.png"></p><br><h3 id="2-3-ログ-アラート-ルールのディメンション分割とは"><a href="#2-3-ログ-アラート-ルールのディメンション分割とは" class="headerlink" title="2-3. ログ アラート ルールのディメンション分割とは"></a>2-3. ログ アラート ルールのディメンション分割とは</h3><p>結論から申し上げますと、ログ アラート ルールの “ディメンション分割” という機能で、<em><strong>リソース ID 列</strong></em> で分割すると、<em><strong>アラート ルールのスコープ</strong></em> と <em><strong>影響を受けるリソース</strong></em> が異なります。</p><table><thead><tr><th>アラート ルール名</th><th>アラート ルールのスコープ</th><th>リソース ID の分割</th><th>影響を受けるリソース</th></tr></thead><tbody><tr><td>Alert 1</td><td>LogAnalyticsWorkspace</td><td>なし</td><td>LogAnalyticsWorkspace</td></tr><tr><td>Alert 2</td><td>LogAnalyticsWorkspace</td><td>あり</td><td>VM-A, VM-B, VM-C</td></tr><tr><td>Alert 3</td><td>VM-A</td><td>なし</td><td>VM-A</td></tr><tr><td>Alert 4</td><td>VM-B</td><td>なし</td><td>VM-B</td></tr><tr><td>Alert 5</td><td>VM-C</td><td>なし</td><td>VM-C</td></tr></tbody></table><br><h5 id="lt-1-gt-リソース-ID-列で分割した場合"><a href="#lt-1-gt-リソース-ID-列で分割した場合" class="headerlink" title="&lt;1&gt; リソース ID 列で分割した場合"></a>&lt;1&gt; リソース ID 列で分割した場合</h5><p>ディメンションを <em><strong>リソース ID 列</strong></em> で分割すると、<em><strong>アラート ルールのスコープ</strong></em> と <em><strong>影響を受けるリソース</strong></em> が異なります (*2)。ディメンションで分割すると、数値列または文字列の組み合わせがグループ化され、複数の Azure リソースで同じ条件を監視できます。このディメンションで <em><strong>リソース ID 列</strong></em> で分割しますと、アラート ルールのスコープが <em><strong>リソース スコープ</strong></em> になります。</p><p>アラート ルール Alert 2 では、下図のとおり <em><strong>リソース ID 列</strong></em> で分割しています。<br>この場合は、リソース ID 毎にアラートのターゲットとして分割され、リソース ID 別にアラートの検知、通知が行われます。<br>つまり、Alert 2 では <em><strong>アラート ルールのスコープ</strong></em> で「Log Analytics ワークスペース」を指定していますが、ディメンション分割で <em><strong>リソース ID 列</strong></em> を指定したため、アラート ルールのスコープが <em><strong>リソース スコープ</strong></em>となり、仮想マシン毎にアラートが検知され、通知が行われます。そのため、<em><strong>影響を受けるリソース</strong></em> は「仮想マシン (VM-A, VM-B, VM-C) 」となります。</p><p>(*2) ログ アラート ルールの [条件] タブでディメンションを指定します。<br>ディメンション分割につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-types#narrow-the-target-using-dimensions">弊社公開情報</a> もご覧ください。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image05.png"></p><br><h5 id="lt-2-gt-リソース-ID-列で分割しない場合"><a href="#lt-2-gt-リソース-ID-列で分割しない場合" class="headerlink" title="&lt;2&gt; リソース ID 列で分割しない場合"></a>&lt;2&gt; リソース ID 列で分割しない場合</h5><p>リソース ID 列で「分割しない」に設定した場合は、”アラート ルールのスコープ” と “影響を受けるリソース” は同一リソースとなります。そのため、<em><strong>Alert 1</strong></em> では、<em><strong>アラート ルールのスコープ</strong></em> と <em><strong>影響を受けるリソース</strong></em>ともに Log Analytics ワークスペースとなります。</p><br><h3 id="2-4-アラート処理ルールのスコープで指定するリソース"><a href="#2-4-アラート処理ルールのスコープで指定するリソース" class="headerlink" title="2-4. アラート処理ルールのスコープで指定するリソース"></a>2-4. アラート処理ルールのスコープで指定するリソース</h3><p>下表に、今回準備したアラート ルールと、アラート処理ルールの [スコープ] に指定するリソースをまとめました。<br><em><strong>アラート処理ルールの [スコープ]</strong></em> と <em><strong>通知を抑制するアラート ルールが対象としているリソース</strong></em> が一致しない場合は、アラート ルールで紐づかれたアクション グループを抑制/適用できませんので、十分に注意してください。<br>また、アラート処理ルールの [スコープ] にサブスクリプションやリソース グループを選択することも可能です。この場合は、指定したサブスクリプション配下に存在するリソース、もしくは、リソース グループ配下に存在するリソースを対象としている、すべてのアラート ルールにアラート処理ルールが適用されます。</p><table><thead><tr><th>アラート ルール名</th><th>アラート ルールのスコープ</th><th>リソース ID の分割</th><th>影響を受けるリソース</th><th>アラート処理ルールのスコープ</th></tr></thead><tbody><tr><td>Alert 1</td><td>LogAnalyticsWorkspace</td><td>なし</td><td>LogAnalyticsWorkspace</td><td>LogAnalyticsWorkspace</td></tr><tr><td>Alert 2</td><td>LogAnalyticsWorkspace</td><td>あり</td><td>VM-A, VM-B, VM-C</td><td>VM-A, VM-B, VM-C</td></tr><tr><td>Alert 3</td><td>VM-A</td><td>なし</td><td>VM-A</td><td>VM-A</td></tr><tr><td>Alert 4</td><td>VM-B</td><td>なし</td><td>VM-B</td><td>VM-B</td></tr><tr><td>Alert 5</td><td>VM-C</td><td>なし</td><td>VM-C</td><td>VM-C</td></tr></tbody></table><br><h3 id="3-アラート処理ルールの設定手順"><a href="#3-アラート処理ルールの設定手順" class="headerlink" title="3. アラート処理ルールの設定手順"></a>3. アラート処理ルールの設定手順</h3><p>それでは、アラート処理ルールでアラートの通知を抑制してみましょう！<br>今回は、アラート ルール Alert 3 のみの通知を抑制するアラート処理ルールを設定します。</p><ol><li>Azure portal で [モニター] - [アラート] を開き、[アラート処理ルール] を選択し、遷移先のページ左上部の [+ 作成] をクリックします。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image12.png"></li></ol><ol start="2"><li>スコープタブでは、アラート処理ルールのスコープと条件を指定します。</li></ol><ul><li>[スコープ] : <em><strong>通知を抑制するアラート ルールが対象としているリソース</strong></em> を指定します。</li><li>[フィルター] : 必要に応じて、細かい条件 (アラート ルール名、リソースの種類、重大度等) を指定します。</li></ul><p>Alert 3 の通知を抑制するため、[スコープ] では Alert 3 の <em><strong>影響を受けるリソース</strong></em> の <em><strong>VM-A</strong></em> を指定します。<br>ここで注意すべき点は、アラート処理ルールのスコープで VM-A を指定すると、VM-A をスコープとする全てのアラート ルールに対して、アラート処理ルールが適用されることです。今回、Alert 2 の <em><strong>影響を受けるリソース</strong></em> に VM-A が含まれています。そのため、[スコープ] のみの設定ですと、Alert 2 で VM-A に関するアラートが発報したときにも、アラートの通知が抑制されてしまいます。</p><p>このようなときに [フィルター] で細かい条件を指定します。<br>今回は Alert 3 の通知を抑制したいため、フィルターの条件で [アラート ルール ID] もしくは [アラート ルール名] で通知を抑制したいアラート ルールを指定します。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image06.png"></p><br><ol start="3"><li>ルールの設定タブでは、アクション グループの適用、もしくは抑制を指定します。アラートの通知を抑制するため、 [通知を表示しない] を選択します。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image07.png"></li></ol><ol start="4"><li>スケジュールタブで、アラートの通知を抑制したい時間帯を指定します。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image08.png"></li></ol><ol start="5"><li>詳細タブでは、アラート処理ルールのリソース グループやアラート処理ルール名をご指定ください。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image13.png"></li></ol><br><h3 id="4-アラートの通知が抑制されたことを確認する方法"><a href="#4-アラートの通知が抑制されたことを確認する方法" class="headerlink" title="4. アラートの通知が抑制されたことを確認する方法"></a>4. アラートの通知が抑制されたことを確認する方法</h3><p>Azure portal の [モニター] - [アラート] から、アラート処理ルールでアラートの通知が抑制されたことを確認することができます。<br>今回は Alert 3 の通知を抑制したので、アラート処理ルールの適用期間中に発生した Alert 3 のアラートを選択します。<br>アラートの [履歴] タブを開くと、アラート処理ルール AlertProcessingRule によって、アクション グループ ActionGroup が抑制されたことがわかります。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image09.png"></p><p>今回、Alert 2 の 影響を受けるリソース に VM-A が含まれていました。Alert 2 のアラートの [履歴] も見てみましょう。<br>Alert 3 と同様、影響を受けるリソース が VM-A ですが、アラート通知は抑制されていないことがわかります。<br><img src="/blog/AzureMonitorEssential/AlertProcessingRule/image10.png"></p><br><p>今回はアラート処理ルールの概要とその設定手順をご紹介しました。いかがでしたでしょうか。<br>上記内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>また、弊社公開情報の <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-processing-rules?tabs=portal">アラート処理ルール</a> や <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-troubleshoot#alert-processing-rule-is-not-working-as-expected">Azure Monitor のアラートの問題のトラブルシューティング</a> にも、アラート処理ルールの概要や設定手順等が掲載されておりますので、ご覧いただけますと幸いです。</p><p>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;Azure Monitor のアラート処理ルールという機能をご存知でしょうか。&lt;br&gt;アラート処理ルールでは、特定の時間帯のみアクション グループを適用したり、抑制したりすることができます。&lt;br&gt;今回は、アラート処理ルールの概要と、よくお問い合わせをいただく設定手順をご紹介いたします。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
    <category term="アラート処理ルール" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor 製品に関するお問い合わせを発行いただく際のポイント</title>
    <link href="https://jpazmon-integ.github.io/blog/general/HowToCreateSR/"/>
    <id>https://jpazmon-integ.github.io/blog/general/HowToCreateSR/</id>
    <published>2023-06-14T15:00:00.000Z</published>
    <updated>2024-04-07T11:46:44.547Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は、Azure Monitor 製品のお問い合わせを発行いただく際のポイントをご紹介いたします。</p><p>大変有難いことに、たくさんのお客様に Azure Monitor 製品をご利用いただいており、日々さまざまなお問い合わせをいただいております。本記事では、お問い合わせ内容の例文や、よくあるお問い合わせを例に、弊社よりヒアリングさせていただく主な情報をご紹介いたします。今回ご紹介するポイントをふまえてお問い合わせを発行いただきますと、よりスムーズな調査が可能となります。</p><p>なお、本記事では、以下のようなお客様にお読みいただくことを想定しております。</p><ul><li>Azure Monitor 製品のお問い合わせを発行するときに、どのような情報が必要なのか知りたい</li><li>Azure Monitor サポートを利用する際にどのような情報を提供すれば、効率的に成果が得られるか知りたい</li></ul><p>Azure Monitor サポートを利用する際にどのような情報を記載すればいいの？ どのような情報が必要なの？といった疑問をお持ちの方に、少しでもご参考になれば幸いです！</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E7%B3%BB%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">2. トラブルシューティング系のお問い合わせに関するポイント</a></li><li><a href="#3-%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E7%B3%BB%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E3%81%AE%E4%BE%8B%E6%96%87">3. トラブルシューティング系のお問い合わせの例文</a></li><li><a href="#4-%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E7%B3%BB%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A7%E5%BF%85%E8%A6%81%E3%81%AA%E6%83%85%E5%A0%B1">4. トラブルシューティング系のお問い合わせで必要な情報</a><ul><li><a href="#4-1-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88-%E3%81%BE%E3%81%9F%E3%81%AF-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88-%E3%81%A7%E3%83%AD%E3%82%B0%E3%82%92%E5%8F%8E%E9%9B%86%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84">4-1. Azure Monitor エージェント (または Log Analytics エージェント) でログを収集できない</a></li><li><a href="#4-2-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88-%E3%81%BE%E3%81%9F%E3%81%AF-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88-%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%80%81%E3%82%A2%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84">4-2. Azure Monitor エージェント (または Log Analytics エージェント) がインストールできない、アンインストールできない</a></li><li><a href="#4-3-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E6%83%B3%E5%AE%9A%E3%81%A9%E3%81%8A%E3%82%8A%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84-%E6%A4%9C%E7%9F%A5%E3%82%82%E3%82%8C">4-3. アラート ルールが想定どおりに動作しない（検知もれ）</a></li><li><a href="#4-4-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E6%83%B3%E5%AE%9A%E3%81%A9%E3%81%8A%E3%82%8A%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84-%E8%AA%A4%E6%A4%9C%E7%9F%A5">4-4. アラート ルールが想定どおりに動作しない（誤検知）</a></li><li><a href="#4-5-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%8C%E7%99%BA%E5%A0%B1%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%A7%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84">4-5. アラートが発報したが、メールで通知されない</a></li><li><a href="#4-6-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E5%87%A6%E7%90%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%8C%E6%83%B3%E5%AE%9A%E3%81%A9%E3%81%8A%E3%82%8A%E3%81%AB%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84">4-6. アラート処理ルールが想定どおりに動作しない</a></li><li><a href="#4-7-Azure-Monitor-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%AB%E3%82%88%E3%82%8B%E3%83%AD%E3%82%B0%E3%81%8C%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84">4-7. Azure Monitor の診断設定によるログが出力されない</a></li></ul></li><li><a href="#5-%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E7%B3%BB%E4%BB%A5%E5%A4%96%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">5. トラブルシューティング系以外のお問い合わせに関するポイント</a></li><li><a href="#6-%E3%81%95%E3%81%84%E3%81%94%E3%81%AB">6. さいごに</a></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p>弊社サポートまでお寄せいただくお問い合わせは、主に [トラブルシューティング系] と [How-To 系] に大別できます。<br>前者の場合、Azure Monitor エージェントでログが収集されない、ログ アラート ルールでアラートが検知されなかった、といった、トラブル系のお問い合わせです。後者の場合、Azure Monitor エージェントのネットワーク要件が知りたい、ログ アラート ルールの設定手順が知りたい、といった、製品の利用方法に関する内容です。</p><p>How-To 系のお問い合わせの場合は、弊社公開情報をご案内したり、弊社内で検証の上、回答をご案内しております。<br>一方で、トラブルシューティング系の場合は、お客様環境にて発生している事象を正確に把握させていただくため、<br>事象内容を詳細にヒアリングさせていただき、場合によっては、お客様環境にてログ採取をお願いすることもございます。</p><p>本記事では、よくある [トラブルシューティング系] のお問い合わせを例に、ヒアリングさせていただく情報をご紹介いたします。<br>また、[How-To 系] のお問い合わせを発行いただく際のポイントもお伝えします。<br>お問い合わせを発行いただく際には、今回ご紹介する情報をお寄せいただけますと幸いです！<br>※ 事象によっては、本記事に掲載していない情報もヒアリングさせていただく場合もございます。予めご了承ください。</p><br><h2 id="2-トラブルシューティング系のお問い合わせに関するポイント"><a href="#2-トラブルシューティング系のお問い合わせに関するポイント" class="headerlink" title="2. トラブルシューティング系のお問い合わせに関するポイント"></a>2. トラブルシューティング系のお問い合わせに関するポイント</h2><p>トラブルシューティング系のお問い合わせを発行する際のポイントは、主に 3 つです。<br>例えば 「仮想マシンのログが収集できないため、原因を教えてほしい」 等と、お問い合わせ内容が省略されて記載されている場合、どの仮想マシンで問題が起きているのかといった点や、どのようなログが収集できていないのか、いつ頃からログの収集ができていないのか、といった点を特定することができません。事象の確認のためにヒアリングさせていただきますので、解決までにお時間を要します。以下のポイントをふまえて記載いただくことで、結果的に課題解決を早めることに繋がります。</p><br><h4 id="★1-お問い合わせのゴールを明記していただくこと"><a href="#★1-お問い合わせのゴールを明記していただくこと" class="headerlink" title="★1. お問い合わせのゴールを明記していただくこと"></a>★1. お問い合わせのゴールを明記していただくこと</h4><h4 id="★2-調査対象リソースを明記いただくこと"><a href="#★2-調査対象リソースを明記いただくこと" class="headerlink" title="★2. 調査対象リソースを明記いただくこと"></a>★2. 調査対象リソースを明記いただくこと</h4><h4 id="★3-現在の状況と問題に至るまでの経緯を正確に共有いただくこと"><a href="#★3-現在の状況と問題に至るまでの経緯を正確に共有いただくこと" class="headerlink" title="★3. 現在の状況と問題に至るまでの経緯を正確に共有いただくこと"></a>★3. 現在の状況と問題に至るまでの経緯を正確に共有いただくこと</h4><br><p>エラーや不具合が発生した場合は、以下のポイントをふまえて、情報をお寄せください。<br>発生している問題やご状況を詳細にご説明いただけますと、解決に要する時間を短縮することができます。<br>また、問題が発生しているリソースをご共有いただけますと、弊社からリソースの状態や基盤側のログを確認することができます。</p><br><h4 id="★1-お問い合わせのゴールを明記していただくこと-1"><a href="#★1-お問い合わせのゴールを明記していただくこと-1" class="headerlink" title="★1. お問い合わせのゴールを明記していただくこと"></a>★1. お問い合わせのゴールを明記していただくこと</h4><ul><li>お問い合わせで解決したいことを明確に記載してください。</li><li>原因調査をご希望される場合は、その旨明記してください。</li><li>原因調査よりも事象の復旧を優先される場合は、その旨明記してください。</li><li>複数の問題が発生している場合において、優先的に解決されたい事象がある場合は、その旨お知らせください。</li><li>お客様のスケジュールにおいて回答期日があれば、その日付とその理由、および万が一にその日付を過ぎてしまった場合の業務影響の詳細をお知らせください。 速やかに回答させていただくよう心がけておりますが、弊社内の開発部門に対してお客様のスケジュール状況を伝えさせていただくことで、優先度を上げた調査が期待できます。</li></ul><br><h4 id="★2-調査対象リソースを明記いただくこと-1"><a href="#★2-調査対象リソースを明記いただくこと-1" class="headerlink" title="★2. 調査対象リソースを明記いただくこと"></a>★2. 調査対象リソースを明記いただくこと</h4><ul><li>事象が発生しているリソース ID をご連絡ください。</li><li>調査対象リソースのページの [新しいサポート リクエスト] をクリックし、リソースを選択してください (※1)。</li><li>調査対象リソースが複数存在する場合は、調査対象リソースの [概要] - [JSONビュー] からリソース ID をご確認ください (※2)。</li></ul><p>※1 調査対象リソースのページの [新しいサポート リクエスト] をクリックしますと、自動でリソースが選択されます。<br><img src="/blog/general/HowToCreateSR/image01.png"></p><p>※2 リソースの [概要] ページの一例です。<br><img src="/blog/general/HowToCreateSR/image02.png"></p><br><div class="alert is-important"><p class="alert-title">重要</p><p>異なるサブスクリプション上のリソースの調査について</p><p>お問い合わせを発行いただく際、調査対象リソースのサブスクリプションからお問い合わせ下さいますよう、お願いいたします。異なるサブスクリプション上のリソースの調査は、セキュリティ上の問題が発生します。詳細は以下ブログをご覧ください。</p><p>お問い合わせ発行時と「異なる」サブスクリプションの調査依頼に対してのセキュリティ チェックが強化されます</p><p><a href="https://jpaztech.github.io/blog/information/Different-subscriptions-research/">https://jpaztech.github.io/blog/information/Different-subscriptions-research/</a></p><p>電話経由における Azure サブスクリプションの調査のセキュリティ チェックが厳格化されます</p><p><a href="https://jpaztech.github.io/blog/information/Security-check-stricter/">https://jpaztech.github.io/blog/information/Security-check-stricter/</a></p></div><div class="alert is-important"><p class="alert-title">重要</p><p>高度な診断情報について</p><p>お問い合わせによっては、高度な診断情報の確認が必要な場合がございます。</p><p>お問い合わせを発行する際に [高度な診断情報の収集を許可しますか] を [はい] にご設定いただきますと、Azure サポートで Azure リソースから高度な診断情報を収集できるようになり、お客様にて手動で情報採取を実施いただき、弊社サポートまでご連携いただく、といった作業が減ります。基本的には、こちらで「はい」を選択していただくことをお勧めしております。</p><p>当社が Azure サポートの提供のために使用するデータ</p><p><a href="https://azure.microsoft.com/ja-jp/support/legal/support-diagnostic-information-collection/">https://azure.microsoft.com/ja-jp/support/legal/support-diagnostic-information-collection/</a></p><p>Azure サポート要求を作成する &gt; 追加情報</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request#additional-details">https://learn.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request#additional-details</a></p></div><br><h4 id="★3-発生している問題とその経緯を正確に共有いただくこと"><a href="#★3-発生している問題とその経緯を正確に共有いただくこと" class="headerlink" title="★3. 発生している問題とその経緯を正確に共有いただくこと"></a>★3. 発生している問題とその経緯を正確に共有いただくこと</h4><ul><li>発生している問題を正確に記載してください。</li><li>事象発生時刻は、タイムゾーンを明記してご記載ください（例. 2023-03-15 12:00 JST, 2023-04-20 10:00 UTC）。</li><li>問題の切り分け作業を実施された場合は、実施した内容を明記してください。</li><li>事象が再現する場合は、その再現手順を記載してください。</li><li>エラー メッセージは、テキストと画面キャプチャでお寄せください。</li><li>事象発生前後で実施された作業がある場合は、どのような情報でも構いませんので、ご一報ください。</li></ul><br><h2 id="3-トラブルシューティング系のお問い合わせの例文"><a href="#3-トラブルシューティング系のお問い合わせの例文" class="headerlink" title="3. トラブルシューティング系のお問い合わせの例文"></a>3. トラブルシューティング系のお問い合わせの例文</h2><p>よくあるトラブルシューティングケースを参考に、お問い合わせ内容の例文をご紹介します。<br>お客様環境で発生している問題をスピーディーに解決するためにも、ご紹介したポイントをおさえて、情報をご共有いただけますと幸いです。</p><p><strong>例 1. Azure Monitor エージェントでログを収集できない</strong></p><blockquote><p>■ 本お問い合わせで解決したいこと (★1)<br>仮想マシン VM01 にて、Azure Monitor エージェントで Heartbeat, Syslog, Perf を収集できるようにしたい。</p><p>■ 調査対象リソース (★2)<br>仮想マシン (REHL 8.7)       : /subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.Compute/virtualMachines/VM01<br>データ収集ルール             : /subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.Insights/dataCollectionRules/DCR01<br>Log Analytics ワークスペース : /subscriptions/xxx/resourcegroups/xxx/providers/microsoft.operationalinsights/workspaces/LAWS01</p><p>■ 実施したこと (★3)<br>2023 年 3 月 20 日 12:00 JST に、Azure ポータルから Syslog と Perf を収集するためのデータ収集ルール DCR01 を作成した。<br>当該データ収集ルールに仮想マシン VM01 を紐づけた。</p><p>■ 状況 (★3)<br>2023 年 3 月 21 日 12:00 JST 時点で、対象マシンのログ収集先 LAWS01 に、当該マシンの Heartbeat, Syslog, Perf が収集できていない。<br>なお、対象マシンはプロキシ経由でインターネット接続を実施している。</p><p>■ 確認したこと (★3)<br>・Azure ポータルの [拡張機能とアプリケーション]より、対象マシンに Azure Monitor エージェントがインストールされ、拡張機能の状態が Provisioning succeeded となっていること<br>・Log Analytics ワークスペース LAWS01 上にて、Heartbeat, Perf, Syslog のクエリを実行し、ログが収集されていないこと</p></blockquote><br><p><strong>例 2. アラート ルールが発報しなかった</strong></p><blockquote><p>■ 確認したいこと (★1)<br>死活監視アラート Heartbeat-Alert-01 が発報しなかった原因</p><p>■ 発生した問題 (★3)<br>仮想マシン VM01 を監視している死活監視アラート Heartbeat-Alert-01 の検知漏れ</p><p>■ 調査対象リソース (★2)<br>仮想マシン (REHL 8.7)       : /subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.Compute/virtualMachines/VM01<br>ログ アラート ルール         : /subscriptions/xxx/resourceGroups/xxx/providers/microsoft.insights/scheduledqueryrules/Heartbeat-Alert-01<br>Log Analytics ワークスペース : /subscriptions/xxx/resourcegroups/xxx/providers/microsoft.operationalinsights/workspaces/LAWS01</p><p>■ 状況 (★3)<br>2023 年 4 月 20 日 15:00 JST ～ 2023 念 4 月 20 日 16:00 JST の間、対象マシンの Heartbeat が途絶えていた。<br>ログ アラート ルール Heartbeat-Alert-01 の評価の頻度は 5 分のため、アラートが発報することが想定されたが、一度も発報しなかった。</p><p>■ 確認したこと (★3)<br>・Azure ポータルの モニター &gt; アラート のページより、ログ アラート ルール Heartbeat-Alert-01 が発報していないことを確認</p></blockquote><br><h2 id="4-トラブルシューティング系のお問い合わせで必要な情報"><a href="#4-トラブルシューティング系のお問い合わせで必要な情報" class="headerlink" title="4. トラブルシューティング系のお問い合わせで必要な情報"></a>4. トラブルシューティング系のお問い合わせで必要な情報</h2><p>よくお問い合わせをいただく内容を例に、ヒアリングさせていただく情報を紹介します。<br>お問い合わせを起票いただく際には、今回ご紹介した例文をご参考に、以下の情報をお寄せください。</p><br><h3 id="4-1-Azure-Monitor-エージェント-または-Log-Analytics-エージェント-でログを収集できない"><a href="#4-1-Azure-Monitor-エージェント-または-Log-Analytics-エージェント-でログを収集できない" class="headerlink" title="4-1. Azure Monitor エージェント (または Log Analytics エージェント) でログを収集できない"></a>4-1. Azure Monitor エージェント (または Log Analytics エージェント) でログを収集できない</h3><p>例. Windows Server 2016 に Azure Monitor エージェントを導入しているが、Perf が収集されない</p><p>主に以下の情報をヒアリングさせていただき、必要に応じてログ採取を依頼させていただきます。</p><ul><li>対象 VM のリソース ID</li><li>ログを収集している Log Analytics ワークスペースのリソース ID</li><li>ログの収集が停止した日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)</li><li>収集できていないログのテーブル名 (すべてのログが収集されていない or 一部のログが収集されていない)</li><li>データ収集ルールのリソース ID (Azure Monitor エージェントの場合のみ該当)</li><li>対象 VM のネットワーク環境 (例. インターネットに接続できる環境、プロキシ サーバーやファイアウォールの有無、等)</li></ul><br><h3 id="4-2-Azure-Monitor-エージェント-または-Log-Analytics-エージェント-がインストールできない、アンインストールできない"><a href="#4-2-Azure-Monitor-エージェント-または-Log-Analytics-エージェント-がインストールできない、アンインストールできない" class="headerlink" title="4-2. Azure Monitor エージェント (または Log Analytics エージェント) がインストールできない、アンインストールできない"></a>4-2. Azure Monitor エージェント (または Log Analytics エージェント) がインストールできない、アンインストールできない</h3><p>例. Windows Server 2016 に Azure Monitor エージェントをインスールできない</p><p>主に以下の情報をヒアリングさせていただき、必要に応じてログ採取を依頼させていただきます。<br>エージェントのインストール、アンインストール時に出力されたメッセージは、画面キャプチャやテキスト情報でお寄せいただけますと幸いです。</p><ul><li>対象 VM のリソース ID</li><li>実施されたインストール、または、アンインストール手順 (例. Azure ポータルの XX の画面よりインストールした、等)</li><li>対象 VM のネットワーク環境 (例. インターネットに接続できる環境、プロキシ サーバーやファイアウォールの有無、等)</li><li>出力されたエラーメッセージ</li></ul><br><!-- AME 系 --><h3 id="4-3-アラート-ルールが想定どおりに動作しない-検知もれ"><a href="#4-3-アラート-ルールが想定どおりに動作しない-検知もれ" class="headerlink" title="4-3. アラート ルールが想定どおりに動作しない (検知もれ)"></a>4-3. アラート ルールが想定どおりに動作しない (検知もれ)</h3><p>例. アラートの発報条件に抵触していたのに、アラートが発報されなかった</p><ul><li>アラート ルールのリソース ID</li><li>アラートが発報されることが想定された日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)</li></ul><br><h3 id="4-4-アラート-ルールが想定どおりに動作しない-誤検知"><a href="#4-4-アラート-ルールが想定どおりに動作しない-誤検知" class="headerlink" title="4-4. アラート ルールが想定どおりに動作しない (誤検知)"></a>4-4. アラート ルールが想定どおりに動作しない (誤検知)</h3><p>例. アラートの発報条件に抵触していないのに、アラートが発報した</p><p>アラートの通知をメールで受領されている場合は、以下の情報がメールに記載されております。<br>Azure ポータルからお問い合わせを起票いただく場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request#additional-details">ファイルをアップロードすることが可能</a>ですので、<br>受領されたメール ファイルをご共有いただくことでも問題ございません。</p><ul><li>アラート ルールのリソース ID</li><li>アラートが発報した日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)</li><li>アラート ID</li></ul><p>アラート ID は [モニター] - [アラート] より、対象のアラートをクリックし、画面下部に表示された [Alert ID] をご共有ください。<br><img src="/blog/general/HowToCreateSR/image04.png"></p><br><h3 id="4-5-アラートが発報したが、メールで通知されない"><a href="#4-5-アラートが発報したが、メールで通知されない" class="headerlink" title="4-5. アラートが発報したが、メールで通知されない"></a>4-5. アラートが発報したが、メールで通知されない</h3><p>例. アラートが発報したが、アクション グループによるメールが通知されない</p><ul><li>アラート ルールのリソース ID</li><li>アラート ルールに紐づかれているアクション グループのリソース ID</li><li>アラートが発報した日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)</li><li>アラート ID</li></ul><br><h3 id="4-6-アラート処理ルールが想定どおりに動作しない"><a href="#4-6-アラート処理ルールが想定どおりに動作しない" class="headerlink" title="4-6. アラート処理ルールが想定どおりに動作しない"></a>4-6. アラート処理ルールが想定どおりに動作しない</h3><p>例. アラートの通知を抑制している時間帯にメールが通知された</p><ul><li>アラート処理ルールのリソース ID</li><li>アラート ルールのリソース ID</li><li>アクション グループにて通知された日時 (タイムゾーンを明記してご記載ください。例. 2023-03-15 12:00 JST)</li><li>アラート ID</li></ul><br><h3 id="4-7-Azure-Monitor-の診断設定によるログが出力されない"><a href="#4-7-Azure-Monitor-の診断設定によるログが出力されない" class="headerlink" title="4-7. Azure Monitor の診断設定によるログが出力されない"></a>4-7. Azure Monitor の診断設定によるログが出力されない</h3><p>例. Automation アカウントの診断設定で、ジョブに関するログが Log Analytics ワークスペースに収集されていない</p><ul><li>診断設定の名前</li><li>診断設定を構成されているリソースのリソース ID (上記例の場合、Automation アカウントのリソース ID)</li><li>ログ収集先 (Log Analytics ワークスペース、ストレージ アカウント等) のリソース ID</li><li>ご確認の際に実行された実際のログ クエリ (ログ収集先が Log Analytics ワークスペースの場合)</li></ul><p>診断設定の名前は 各リソースの [診断設定] よりご確認いただけます。<br><img src="/blog/general/HowToCreateSR/image05.png"></p><br><h2 id="5-トラブルシューティング系以外のお問い合わせに関するポイント"><a href="#5-トラブルシューティング系以外のお問い合わせに関するポイント" class="headerlink" title="5. トラブルシューティング系以外のお問い合わせに関するポイント"></a>5. トラブルシューティング系以外のお問い合わせに関するポイント</h2><p>トラブルシューティング系以外のお問い合わせですと、例えば、以下のような How-To 系のお問い合わせが考えられます。</p><ul><li>Azure Monitor エージェントをインストールする方法が分からない</li><li>ログ アラート ルールの作成手順が分からない</li><li>アラート ルールの設定項目である XXX の意味が知りたい</li><li>アラート発報履歴の保存期間を伸ばす方法を知りたい</li><li>メトリック アラート ルールの評価頻度を 1 分より短くする方法が知りたい</li></ul><p>上記のようなお問い合わせの場合は、以下の情報をご連絡いただけますと幸いです。<br>まず、ご確認いただいた資料を共有いただくことで、お客様の目線に合わせたご支援が可能となります。<br>また、具体的に実現されたいご要件や前提条件を共有いただくことで、根本的な課題を解決するための別のソリューションをご案内できる可能性がございます。<br>さらに、具体的なご質問の背景を共有いただくことで、適切な情報の提供が可能であったり、弊社関連部署と連携して調査する際にスムーズにコミュニケーションが図れる可能性がございます。<br>以下のような情報をご連携いただくことで、結果として、課題解決を早めることが可能となります。</p><h5 id="★1-ご参照された弊社公開情報のリンク-弊社公開情報以外でも構いません"><a href="#★1-ご参照された弊社公開情報のリンク-弊社公開情報以外でも構いません" class="headerlink" title="★1. ご参照された弊社公開情報のリンク (弊社公開情報以外でも構いません)"></a>★1. ご参照された弊社公開情報のリンク (弊社公開情報以外でも構いません)</h5><h5 id="★2-お客様が実現されたいご要件・前提条件"><a href="#★2-お客様が実現されたいご要件・前提条件" class="headerlink" title="★2. お客様が実現されたいご要件・前提条件"></a>★2. お客様が実現されたいご要件・前提条件</h5><h5 id="★3-ご質問の背景や、お問い合わせに至るまでの経緯-なぜ知る必要があるか、なぜ-Azure-Monitor-の仕様についてご質問されたのか。など"><a href="#★3-ご質問の背景や、お問い合わせに至るまでの経緯-なぜ知る必要があるか、なぜ-Azure-Monitor-の仕様についてご質問されたのか。など" class="headerlink" title="★3. ご質問の背景や、お問い合わせに至るまでの経緯 (なぜ知る必要があるか、なぜ Azure Monitor の仕様についてご質問されたのか。など)"></a>★3. ご質問の背景や、お問い合わせに至るまでの経緯 (なぜ知る必要があるか、なぜ Azure Monitor の仕様についてご質問されたのか。など)</h5><h5 id="★4-お客様のスケジュールにおいて回答期日があれば、その日付とその理由、および万が一にその日付を過ぎてしまった場合の業務影響の詳細"><a href="#★4-お客様のスケジュールにおいて回答期日があれば、その日付とその理由、および万が一にその日付を過ぎてしまった場合の業務影響の詳細" class="headerlink" title="★4. お客様のスケジュールにおいて回答期日があれば、その日付とその理由、および万が一にその日付を過ぎてしまった場合の業務影響の詳細"></a>★4. お客様のスケジュールにおいて回答期日があれば、その日付とその理由、および万が一にその日付を過ぎてしまった場合の業務影響の詳細</h5><br><h2 id="6-さいごに"><a href="#6-さいごに" class="headerlink" title="6. さいごに"></a>6. さいごに</h2><p>今回は、Azure Monitor 製品のお問い合わせを発行いただく際のポイントをご紹介するとともに、お問い合わせの例文や弊社よりヒアリングさせていただく情報をご紹介いたしました。今回ご紹介した事例に該当しない事象やご要望等ございましたら、まずはその旨、お問い合わせいただき、担当エンジニアまでご相談ください。</p><p>最後になりましたが、弊社 Azure Monitor サポートチームでは、お客様のご不明な点や問題を解消するため、チーム一丸となり、ご支援させていただきます。より良いサービスをご提供すべく、尽力させていただきますので、何かお困りごとがございましたら、いつでもお気軽にお問い合わせください。</p><p>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は、Azure Monitor 製品のお問い合わせを発行いただく際のポイントをご紹介いたします。&lt;/p&gt;
&lt;p&gt;大変有難いことに、たくさんのお客様に Azure Monitor 製品をご利用いただいており、日々さまざまなお問い合わせをいただいております。本記事では、お問い合わせ内容の例文や、よくあるお問い合わせを例に、弊社よりヒアリングさせていただく主な情報をご紹介いたします。今回ご紹介するポイントをふまえてお問い合わせを発行いただきますと、よりスムーズな調査が可能となります。&lt;/p&gt;
&lt;p&gt;なお、本記事では、以下のようなお客様にお読みいただくことを想定しております。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Azure Monitor 製品のお問い合わせを発行するときに、どのような情報が必要なのか知りたい&lt;/li&gt;
&lt;li&gt;Azure Monitor サポートを利用する際にどのような情報を提供すれば、効率的に成果が得られるか知りたい&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Azure Monitor サポートを利用する際にどのような情報を記載すればいいの？ どのような情報が必要なの？といった疑問をお持ちの方に、少しでもご参考になれば幸いです！&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
  </entry>
  
</feed>
