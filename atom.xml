<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Monitoring Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Monitoring に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazmon-integ.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazmon-integ.github.io/blog/"/>
  <updated>2023-06-05T08:30:55.547Z</updated>
  <id>https://jpazmon-integ.github.io/blog/</id>
  
  <author>
    <name>Japan Azure Monitoring Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>アラート メールの登録解除</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnsubscribeAlertMail/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnsubscribeAlertMail/</id>
    <published>2023-06-05T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.547Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は、Azure Monitor のアラート メールの登録解除と再登録の手順等をご紹介します。<br>お客様からよくお問い合わせいただくご質問もご紹介しますので、ご参考になれば幸いです。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BB%E9%8C%B2%E8%A7%A3%E9%99%A4%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">1. アラート メールの登録解除について</a></li><li><a href="#2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BB%E9%8C%B2%E8%A7%A3%E9%99%A4%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%81%94%E8%B3%AA%E5%95%8F">2. アラート メールの登録解除に関するよくあるご質問</a><ul><li><a href="#Q1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BB%E9%8C%B2%E3%81%8C%E8%A7%A3%E9%99%A4%E3%81%95%E3%82%8C%E3%82%8B%E3%81%A8%E3%80%81%E3%81%9D%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%8C%E9%80%9A%E7%9F%A5%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q1. アラート メールの登録が解除されると、そのアクション グループによるメールが通知されなくなりますか。</a></li><li><a href="#Q2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BB%E9%8C%B2%E3%81%8C%E8%A7%A3%E9%99%A4%E3%81%95%E3%82%8C%E3%81%9F%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q2. アラート メールの登録が解除されたことを確認する方法を教えてください。</a></li><li><a href="#Q3-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%92%E5%86%8D%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q3. アラート メールを再登録する方法を教えてください</a></li><li><a href="#Q4-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E5%86%85%E3%81%AB%E3%81%82%E3%82%8B-Unsubscribe-%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E7%84%A1%E5%8A%B9%E5%8C%96%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q4. アラート メール内にある Unsubscribe のリンクを無効化する方法はありますか。</a></li><li><a href="#Q5-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%A1%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BB%E9%8C%B2%E3%82%92%E8%A7%A3%E9%99%A4%E3%81%97%E3%81%9F%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q5. アラート メールの登録を解除したユーザーを特定する方法はありますか。</a></li></ul></li></ul><br><h2 id="1-アラート-メールの登録解除について"><a href="#1-アラート-メールの登録解除について" class="headerlink" title="1. アラート メールの登録解除について"></a>1. アラート メールの登録解除について</h2><p>Azure Monitor のアラート ルールでは、アラート ルールに <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> を設定することで、アラートが発報したときに通知することができます。このアクション グループで、アラートが発報したときにメールを通知するようにご設定いただいている方が多いかと思います。</p><p>アクション グループによって通知されたアラート メールには、当該アクション グループによるメール通知を解除するリンクが記載されています。赤線で囲んだ <em><strong>Unsubscribe</strong></em> というリンクから、アラート メールの登録を解除することができます。<br>アラート メールの登録を解除しますと、当該アクション グループによって通知されるアラート メールが配信されなくなります。</p><p>(*) 以下は、Azure Monitor のアラート ルールによって通知されたアラート メールの例です。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image01.png"></p><br><p>アラート メールの <em><strong>Unsubscribe from emails directed to this group.</strong></em> のリンクをクリックすると、以下のような画面に遷移します。アクション グループによるアラート メールの登録を解除するかどうかを聞かれます。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image02.png"></p><br><p>上の画面で <em><strong>Confirm</strong></em> をクリックすると、以下の画面が表示され、アラート メールの登録が解除されます。<br>誤ってアラート メールの登録を解除してしまった場合は、<em><strong>Click here to continue receiving Microsoft Azure emails</strong></em> というリンクより、再登録することが可能です。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image03.png"></p><br><p>アラート メールの登録を解除しますと、該当のアクション グループで設定されているメール アドレスに <em><strong>You’re no longer in the &lt;アクション グループの表示名&gt; action group</strong></em> というタイトルのメールが送信され、該当のアクション グループによるアラート メールの登録が解除されたことが通知されます。このメールにも、アラート メールの再登録のリンクが記載され、<em><strong>click here</strong></em> より、アラート メールを再登録することが可能です。</p><p>(*) 以下は、アラート メールの登録を解除した後に通知されたメールの例です。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image04.png"></p><br><br><h2 id="2-アラート-メールの登録解除に関するよくあるご質問"><a href="#2-アラート-メールの登録解除に関するよくあるご質問" class="headerlink" title="2. アラート メールの登録解除に関するよくあるご質問"></a>2. アラート メールの登録解除に関するよくあるご質問</h2><p>アラート メールの登録解除に関するよくあるご質問をご紹介します。<br><br></p><h3 id="Q1-アラート-メールの登録が解除されると、そのアクション-グループによるメールが通知されなくなりますか。"><a href="#Q1-アラート-メールの登録が解除されると、そのアクション-グループによるメールが通知されなくなりますか。" class="headerlink" title="Q1. アラート メールの登録が解除されると、そのアクション グループによるメールが通知されなくなりますか。"></a>Q1. アラート メールの登録が解除されると、そのアクション グループによるメールが通知されなくなりますか。</h3><p>はい、アラート メールの登録を解除すると、該当のアクション グループが紐づいているアラート ルールのメールは通知されません。</p><br><br><h3 id="Q2-アラート-メールの登録が解除されたことを確認する方法を教えてください。"><a href="#Q2-アラート-メールの登録が解除されたことを確認する方法を教えてください。" class="headerlink" title="Q2. アラート メールの登録が解除されたことを確認する方法を教えてください。"></a>Q2. アラート メールの登録が解除されたことを確認する方法を教えてください。</h3><p>アクション グループで設定しているメール アドレスに <em><strong>You’re no longer in the &lt;アクション グループの表示名&gt; action group</strong></em> という件名のメールが届ているかどうかをご確認ください。<br>また、Azure ポータルからアクション グループの編集画面を開き、[通知] の [状態] で <em><strong>登録解除済み</strong></em> と表示されている場合は、アラート メールの登録が解除された状態を意味します。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image06.png"></p><br><br><h3 id="Q3-アラート-メールを再登録する方法を教えてください。"><a href="#Q3-アラート-メールを再登録する方法を教えてください。" class="headerlink" title="Q3. アラート メールを再登録する方法を教えてください。"></a>Q3. アラート メールを再登録する方法を教えてください。</h3><p>“1. アラート メールの登録解除リンクについて” でもご紹介した方法を含め、再登録する方法は 3 つございます。<br>なお、&lt;1&gt; および &lt;2&gt; の再登録のリンクをクリックしても、リンクの期限切れを表すページへ遷移する可能性がございます。<br>この場合は &lt;3&gt;のアクション グループの再設定をお試しいただけますと幸いです。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image09.png"></p><br><br><h5 id="lt-1-gt-アラート-メールの登録を解除したときに表示される画面で再登録する"><a href="#lt-1-gt-アラート-メールの登録を解除したときに表示される画面で再登録する" class="headerlink" title="&lt;1&gt; アラート メールの登録を解除したときに表示される画面で再登録する"></a>&lt;1&gt; アラート メールの登録を解除したときに表示される画面で再登録する</h5><p><em><strong>Click here to continue receiving Microsoft Azure emails</strong></em> というリンクをクリックしてください。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image03.png"></p><br><p>このリンクをクリックすると、以下の画面が表示され、アラート メールが再登録されます。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image05.png"></p><br><h5 id="lt-2-gt-アラート-メールの登録を解除した後に通知されるメールから再登録する"><a href="#lt-2-gt-アラート-メールの登録を解除した後に通知されるメールから再登録する" class="headerlink" title="&lt;2&gt; アラート メールの登録を解除した後に通知されるメールから再登録する"></a>&lt;2&gt; アラート メールの登録を解除した後に通知されるメールから再登録する</h5><p><em><strong>If this was a mistake, click here to subscribe.</strong></em> の <em><strong>click here</strong></em> をクリックしてください。<br>このリンクをクリックすると、&lt;1&gt; と同様、再登録された旨の画面が表示されます。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image04.png"></p><br><h5 id="lt-3-gt-Azure-ポータルからアクション-グループを再設定する"><a href="#lt-3-gt-Azure-ポータルからアクション-グループを再設定する" class="headerlink" title="&lt;3&gt; Azure ポータルからアクション グループを再設定する"></a>&lt;3&gt; Azure ポータルからアクション グループを再設定する</h5><p>Azure ポータルから配信停止を解除する場合は、アクション グループの再設定をお願いいたします。</p><ol><li>アクション グループから該当のメール アドレスを削除し、当該アクション グループを保存します。</li><li>アクション グループに該当のメール アドレスを追加し、当該アクション グループを保存します。</li><li>通知の状態欄が “登録済み” と表示されることを確認します。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image08.png"></li></ol><br><br><h3 id="Q4-アラート-メール内にある-Unsubscribe-のリンクを無効化する方法はありますか。"><a href="#Q4-アラート-メール内にある-Unsubscribe-のリンクを無効化する方法はありますか。" class="headerlink" title="Q4. アラート メール内にある Unsubscribe のリンクを無効化する方法はありますか。"></a>Q4. アラート メール内にある Unsubscribe のリンクを無効化する方法はありますか。</h3><p><a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/AboutCustomizingAlertNotificationEmail/">アラートの通知メールはカスタマイズすることができない</a>ため、メール内の <em><strong>Unsubscribe</strong></em> のリンクを削除することはできません。また、このリンクをクリックした後の動作を制御する方法もございません。<br>そのため、誤ってアラート メールの登録を解除されてしまった場合は、前述の再登録手順を実施してください。</p><br><br><h3 id="Q5-アラート-メールの登録を解除したユーザーを特定する方法はありますか。"><a href="#Q5-アラート-メールの登録を解除したユーザーを特定する方法はありますか。" class="headerlink" title="Q5. アラート メールの登録を解除したユーザーを特定する方法はありますか。"></a>Q5. アラート メールの登録を解除したユーザーを特定する方法はありますか。</h3><p>アラート メールの登録を解除したユーザーを特定することはできません。<br>アクティビティ ログには、イベント開始者に対象のメール アドレスが記録されますが、そのアドレスを具体的にどのユーザーが無効化したのかまでは確認する方法がございません。<br><img src="/blog/AzureMonitorEssential/UnsubscribeAlertMail/image07.png"></p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>また、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-troubleshoot#did-not-receive-expected-email">弊社公開情報</a> もあわせてご確認いただけますと幸いです。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は、Azure Monitor のアラート メールの登録解除と再登録の手順等をご紹介します。&lt;br&gt;お客様からよくお問い合わせいただくご質問もご紹介しますので、ご参考になれば幸いです。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor エージェントでカスタム ログを取得する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMA_CustomLog/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/AMA_CustomLog/</id>
    <published>2023-03-22T01:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.555Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitor サポートの三輪です。<br>今回は Azure Monitor エージェントにて任意のテキスト ログ (カスタム ログ) を取得する方法についてご案内します。</p><p>Azure Monitor エージェントでは、Windows/Linux 各 OS 上にあるテキスト ログを Log Analytics ワークスペースへ収集することが可能です。<br>一方で、以下公開情報の手順が煩雑でわかりにくい、また REST API を用いており Azure ポータル上で作業が完結しない等の問題があることから、本記事にて改めて手順をご案内致します。</p><ul><li>Azure Monitor エージェントを使用してテキスト ログを収集する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-text-log?tabs=portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-text-log?tabs=portal</a></li></ul><h1 id="Azure-Monitor-エージェントを用いたカスタム-ログ収集手順"><a href="#Azure-Monitor-エージェントを用いたカスタム-ログ収集手順" class="headerlink" title="Azure Monitor エージェントを用いたカスタム ログ収集手順"></a>Azure Monitor エージェントを用いたカスタム ログ収集手順</h1><p>本手順は以下の順序で作業を進めます。</p><ul><li>[モニター] にてデータ収集エンドポイント (DCE) を作成</li><li>Log Analytics ワークスペースにてカスタム ログ テーブルを作成<ul><li>その際、同時にデータ収集ルール (DCR) を作成を行う</li></ul></li><li>作成された DCR を開き、必要な編集および VM リソースとの紐づけを行う</li></ul><h2 id="データ収集エンドポイント-DCE-を作成する"><a href="#データ収集エンドポイント-DCE-を作成する" class="headerlink" title="データ収集エンドポイント (DCE) を作成する"></a>データ収集エンドポイント (DCE) を作成する</h2><ul><li>Azure Monitor のデータ収集エンドポイント<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal#create-data-collection-endpoint">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal#create-data-collection-endpoint</a></li></ul><ol><li>[モニター] を開き、[データ収集エンドポイント] より [作成] を選択します。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_01.png"></p><ol start="2"><li>データ収集エンドポイント (DCE) を任意の名前、リソース グループを指定して作成します。<br>この時、DCE を作成する宛先のリージョンと、ログを収集する予定の VM が存在しているリージョンは一致している必要があります。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_02.png"></p><h2 id="カスタム-ログ-テーブルを作成する"><a href="#カスタム-ログ-テーブルを作成する" class="headerlink" title="カスタム ログ テーブルを作成する"></a>カスタム ログ テーブルを作成する</h2><ul><li>カスタム テーブルを作成する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/create-custom-table?tabs=portal-1,portal-2#create-a-custom-table">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/create-custom-table?tabs=portal-1%2Cportal-2#create-a-custom-table</a></li></ul><ol><li>Log Analytics ワークスペースを開きます。<br>未作成の場合、以下の手順にてワークスペースを作成します。</li></ol><ul><li>Log Analytics ワークスペースを作成する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal</a></li></ul><ol start="2"><li>[テーブル] より、[作成] - [DCR ベース]を選択します。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_03.png"></p><ol start="3"><li>任意のカスタム ログ名を設定し、先ほど作成した DCE を選択します。<br>また、[新しいデータ収集ルールの作成] を選択します。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_04.png"></p><ol start="4"><li>任意の名前、リソース グループを指定して完了をクリックし、データ収集ルール (DCR) を作成します。次へ進みます。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_05.png"></p><ol start="5"><li>[スキーマと変換] にて、取得したいテキスト ファイルを JSON スキーマで定義したものをアップロードします。</li></ol><p>まず、前提として今回は、以下の様なテキスト ファイルを取得することを想定します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2022-12-31T01:00:00.1234567Z | Computer=TestVM01 | Log=Service stop</span><br><span class="line">2022-12-31T01:01:00.1234567Z | Computer=TestVM01 | Log=Service start</span><br><span class="line">2022-12-31T01:02:00.1234567Z | Computer=TestVM01 | Log=Service stop</span><br></pre></td></tr></table></figure><p>上記を JSON で定義すると、以下の様になります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;RawData&quot;: &quot;2022-12-31T01:00:00.1234567Z | Computer=TestVM01 | Log=Service stop&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;RawData&quot;: &quot;2022-12-31T01:01:00.1234567Z | Computer=TestVM01 | Log=Service start&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;RawData&quot;: &quot;2022-12-31T01:02:00.1234567Z | Computer=TestVM01 | Log=Service stop&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]    </span><br></pre></td></tr></table></figure><p>上記 JSON をテキスト ファイルとして保存し、アップロードします。</p><ol start="6"><li>[変換エディター] を選択します。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_06.png"></p><ol start="7"><li>以下のクエリを記載し、実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source</span><br><span class="line">| extend TimeGenerated = now()</span><br><span class="line">| parse RawData with * &quot;Computer=&quot;HostName &quot;| &quot; *</span><br><span class="line">| parse RawData with * &quot;Log=&quot;Log&quot;</span><br></pre></td></tr></table></figure></li></ol><ul><li>parse operator<br><a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/parseoperator">https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/parseoperator</a></li></ul><p>実行すると、ログが分割され、HostName 列と Log 列に分かれます。<br>また、TimeGenerated 列として、現在の時刻が入ります。</p><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_07.png"></p><p>[適用] を選択し、次へ進み、[作成] を選択します。</p><h2 id="DCR-を設定する"><a href="#DCR-を設定する" class="headerlink" title="DCR を設定する"></a>DCR を設定する</h2><ol><li><p>[モニター] を開き、[データ収集ルール] より先ほど作成したデータ収集ルール (DCR) を選択します。</p></li><li><p>[データ ソース] を開き、[追加] を選択します。</p></li><li><p>[データ ソースの種類] にて [カスタム テキスト ログ] を選択します。<br>[ファイル パターン] にて収集先のログファイル パスを指定します。<br>今回は Linux OS 上のテキスト ログを取得することを想定し、以下のパスを入力します</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/log/test.log</span><br></pre></td></tr></table></figure></li></ol><p>[テーブル名] にはさきほど作成したテーブル名 (_CL 含む) を指定します。<br>[Transform] には、テーブル作成時に指定した以下のクエリを指定します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source| extend TimeGenerated = now()| parse RawData with * &quot;Computer=&quot;HostName &quot;| &quot; *| parse RawData with * &quot;Log=&quot;Log&quot;</span><br></pre></td></tr></table></figure><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_08.png"></p><ol start="4"><li>[ターゲット] にて、テーブルを作成済みの対象の Log Analytics ワークスペースを選択し、[データ ソースの追加] を選択します。</li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_09.png"></p><p>これによって、データ ソースが更新されます。</p><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_10.png"></p><ol start="5"><li><p>続いて、[リソース] を選択します。</p></li><li><p>[追加] より、カスタム ログを収集したい VM を選び、[適用] を選択します。<br>このとき、データ収集エンドポイントとして、作成済の DCE を設定しておきます。<br>また、この操作により、VM 側へ Azure Monitor Agent がインストールされます。</p></li></ol><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_11.png"></p><p>この後、指定したパスへテキスト ログを出力していくと、ログが取得されます。</p><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_12.png"></p><p>なお、今回のサンプルでは、TimeGenerated 列はログがエージェントによって収集されたタイミングとなります。<br>テキスト ログ内の RawData 内の日時を、Log Analytics ワークスペース上の TimeGenerated 列としたいたい場合は、Transform のクエリを以下の様に指定し、ログから時刻を取得し、日付形式に変換の上、TimeGenerated 列として定義します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source</span><br><span class="line">| extend TimeGenerated = todatetime(substring(RawData,0,28))</span><br><span class="line">| parse RawData with * &quot;Computer=&quot;HostName &quot;| &quot; *</span><br><span class="line">| parse RawData with * &quot;Log=&quot;Log&quot;</span><br></pre></td></tr></table></figure><p>これにより、TimeGenerated 列の値が RawData 内の日時をもとに設定されます。</p><p><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_13.png"></p><ul><li>substring()<br><a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/substringfunction">https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/substringfunction</a></li><li>todatetime()<br><a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/todatetimefunction">https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/todatetimefunction</a></li></ul><h2 id="正常に収集されない場合"><a href="#正常に収集されない場合" class="headerlink" title="正常に収集されない場合"></a>正常に収集されない場合</h2><p>カスタム ログを設定し、OS 上にログが出力された後、2 時間程度経過しないと Log Analytics ワークスペース上でクエリが出来ない場合があります。<br>ログを出力したまま、数時間お待ちいただき、クエリをお試し下さい。</p><p>また、時間経過してもログが収集されない場合、以下の点をご確認下さい。</p><ol><li><p>DCR 上で、紐づけている VM に対して DCE が設定されているか確認下さい。<br><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_14.png"><br>DCE が設定されていない場合、作成した DCE を設定します。<br>ドロップボックスから選択出来ない場合、VM と DCE のリージョンが異なっていることが想定されますので、同一のリージョンに作成する必要があります。</p></li><li><p>VM の Heartbeat ログが到達しているか確認下さい。<br>Log Analytics ワークスペース上で以下のクエリを実行し、収集対象の VM から Heartbeat ログが取得されているか確認下さい。<br>Heartbeat ログは通常、1 分間に 1 回 Log Analytics ワークスペースへ送られてきます。</p></li></ol><ul><li>クエリ<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat | top 10 by TimeGenerated</span><br></pre></td></tr></table></figure></li><li>結果例<br><img src="/blog/LogAnalytics/AMA_CustomLog/AMACustomlog_15.png"></li></ul><p>Heartbeat ログが確認出来ない場合、多くの場合ネットワーク要件が満たされていない可能性が高いです。<br>以下の公開情報をもとに、VM の NSG や ファイアウォールにおいて、通信要件が満たされているかご確認下さい。</p><ul><li>Azure Monitor エージェントのネットワーク設定を定義する<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows</a></li></ul><p>上記ポイントに問題がなく、また時間が経過してもログが Log Analytics ワークスペース上に収集がされない場合、以下の手順をお試し下さい。</p><p>A. DCR を再作成する</p><ol><li>[モニター] より作成した DCR を選択し、[削除] します。</li><li>再度、[モニター] - [データ収集ルール] - [+ 作成] より DCR を新規作成します。</li><li>任意のルール名、リソース グループを選択します。また、DCE を作成したリージョンと同じリージョンを選択し、ログを収集する VM の OS を選択します。(Windows または Linux)<br>エンドポイント ID の箇所で、作成した DCE を選択し、次へ進みます。</li><li>[+ リソースの追加] より収集対象の VM を選択します。[データ収集エンドポイントを有効にする] にチェックを入れ、作成した DCE を選択し、次へ進みます。</li><li>[+ データ ソースの追加] より、[カスタム テキスト ログ] を選択します。</li><li>[データ ソース] にて、[ファイル パターン]、[テーブル名]、[Transform] の各項目にて、【DCR を設定する】 にて対して設定した内容を行います。</li><li>[ターゲット] にて、テーブルを作成済みの対象の Log Analytics ワークスペースを選択し、[データ ソースの追加] を選択します。</li><li>次へ進み、最後に [作成] を選択します。</li></ol><p>B. Azure Monitor エージェントを再インストールする</p><ol><li>対象の VM を開き、[拡張機能とアプリケーション] を選択します。</li><li>OS が Windows の場合は [AzureMonitorWindowsAgent]、Linux の場合は [AzureMonitorLinuxAgent] を選択し [アンインストール] をクリックします。</li><li>Azure Monitor エージェントのアンインストールが完了するまで待ちます。</li><li>続いて、作成した DCR を開きます。</li><li>[リソース] より、Azure Monitor エージェントをアンインストールした VM を選択し、[削除] を選択します。</li><li>[+ 追加] より、Azure Monitor エージェントをアンインストールした VM を選択し、[適用] を選択します。<br>このとき、[データ収集エンドポイント] にて作成した DCE が設定されていることを確認します。</li></ol><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>上記手順利用した JSON ファイルは以下より入手が可能です。貴社環境やログの形状に合わせて変更いただければと存じます。<br><a href="/blog/LogAnalytics/AMA_CustomLog/sampleJson.json.txt">sampleJson.json</a></p><p>また、Linux OS 上で今回収集するログを、テストとしてテキスト ログに出力するコマンドは以下です。<br>本手順をテストされる場合、以下のコマンドにて簡単に検証が可能です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;`date &#x27;+%Y-%m-%dT%H:%M:%S.%7N&#x27;` | Computer=`hostname` | Log=Service stop&quot; &gt;&gt; /var/log/test.log</span><br><span class="line">echo &quot;`date &#x27;+%Y-%m-%dT%H:%M:%S.%7N&#x27;` | Computer=`hostname` | Log=Service start&quot; &gt;&gt; /var/log/test.log</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitor サポートの三輪です。&lt;br&gt;今回は Azure Monitor エージェントにて任意のテキスト ログ (カスタム ログ) を取得する方法についてご案内します。&lt;/p&gt;
&lt;p&gt;Azure Monitor エージェントでは、Windows</summary>
      
    
    
    
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor Agent for Linux で取得可能なパフォーマンス カウンターの一覧</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/</id>
    <published>2023-03-20T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.555Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitor サポートの三輪です。<br>今回は Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターの一覧をご案内します。</p><p>Azure Monitor エージェントでは、Windows/Linux 各 OS のパフォーマンス データを取得することが可能です。</p><ul><li>Azure Monitor エージェントを使用して仮想マシンからイベントとパフォーマンス カウンターを収集する<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal</a></li></ul><p>Azure Monitor エージェント for Windows では、Windows OS 上に存在するパフォーマンス カウンターであれば取得が可能です。<br>一方で、Azure Monitor エージェント for Linux では、特定のパフォーマンス カウンターのみが取得可能となっています。<br>また、Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターは、以下の Log Analytics エージェントで取得可能であったパフォーマンス カウンターと一部異なる部分がありますため、本記事にてご案内を致します。</p><ul><li>Log Analytics エージェントを使用して Windows と Linux のパフォーマンス データ ソースを収集する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-performance-counters">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-performance-counters</a></li></ul><h2 id="Azure-Monitor-エージェント-for-Linux-にて取得可能なパフォーマンス-カウンター："><a href="#Azure-Monitor-エージェント-for-Linux-にて取得可能なパフォーマンス-カウンター：" class="headerlink" title="Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンター："></a>Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンター：</h2><table><thead><tr><th align="left">ObjectName</th><th align="center">CounterName</th></tr></thead><tbody><tr><td align="left">Logical Disk</td><td align="center">Logical Disk Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Free Megabytes</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Writes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Write Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Transfers/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Reads/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Read Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Used Space</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Used Inodes</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Free Space</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Free Inodes</td></tr><tr><td align="left">Memory</td><td align="center">Used Memory MBytes</td></tr><tr><td align="left">Memory</td><td align="center">Used MBytes Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">Pages/sec</td></tr><tr><td align="left">Memory</td><td align="center">Page Writes/sec</td></tr><tr><td align="left">Memory</td><td align="center">Page Reads/sec</td></tr><tr><td align="left">Memory</td><td align="center">Available MBytes Swap</td></tr><tr><td align="left">Memory</td><td align="center">Available MBytes Memory</td></tr><tr><td align="left">Memory</td><td align="center">% Used Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">% Used Memory</td></tr><tr><td align="left">Memory</td><td align="center">% Available Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">% Available Memory</td></tr><tr><td align="left">Network</td><td align="center">Total Tx Errors</td></tr><tr><td align="left">Network</td><td align="center">Total Rx Errors</td></tr><tr><td align="left">Network</td><td align="center">Total Packets Transmitted</td></tr><tr><td align="left">Network</td><td align="center">Total Packets Received</td></tr><tr><td align="left">Network</td><td align="center">Total Collisions</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes Transmitted</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes Received</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes</td></tr><tr><td align="left">Processor</td><td align="center">% User Time</td></tr><tr><td align="left">Processor</td><td align="center">% Processor Time</td></tr><tr><td align="left">Processor</td><td align="center">% Privileged Time</td></tr><tr><td align="left">Processor</td><td align="center">% Nice Time</td></tr><tr><td align="left">Processor</td><td align="center">% IO Wait Time</td></tr><tr><td align="left">Processor</td><td align="center">% Interrupt Time</td></tr><tr><td align="left">Processor</td><td align="center">% Idle Time</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitor サポートの三輪です。&lt;br&gt;今回は Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターの一覧をご案内します。&lt;/p&gt;
&lt;p&gt;Azure Monitor エージェントでは、Window</summary>
      
    
    
    
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>リソース正常性アラートに関するよくあるご質問</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/</id>
    <published>2023-01-17T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.543Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>リソース正常性アラートという機能をご存知でしょうか。<br>リソース正常性アラートでは、リソース単位で発生した障害を確認することができます。<br>今回はリソース正常性アラートでよくお問い合わせをいただくご質問を紹介いたします。</p><br><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><ul><li><a href="#Q1-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%A8%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q1. リソース正常性アラートの概要と仕組みを教えてください。</a></li><li><a href="#Q2-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AF%E3%80%81%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%A7%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q2. リソース正常性アラートは、すべてのリソースで設定できますか。</a></li><li><a href="#Q3-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E7%9B%A3%E8%A6%96%E9%96%93%E9%9A%94%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q3. リソース正常性アラートの監視間隔を教えてください。</a></li><li><a href="#Q4-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A8%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E9%81%95%E3%81%84%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q4. リソース正常性アラートとサービス正常性アラートの違いを教えてください。</a></li><li><a href="#Q5-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E6%9D%A1%E4%BB%B6-%E2%80%9C%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E7%8A%B6%E6%85%8B%E2%80%9D-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q5. リソース正常性アラートの条件 “イベントの状態” について教えてください。</a></li><li><a href="#Q6-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E6%9D%A1%E4%BB%B6-%E2%80%9C%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E7%8A%B6%E6%85%8B%E2%80%9D-%E3%81%8A%E3%82%88%E3%81%B3-%E2%80%9C%E4%BB%A5%E5%89%8D%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E7%8A%B6%E6%85%8B%E2%80%9D-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q6. リソース正常性アラートの条件 “現在のリソースの状態” および “以前のリソースの状態” について教えてください。</a></li><li><a href="#Q7-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E6%9D%A1%E4%BB%B6-%E2%80%9C%E7%90%86%E7%94%B1%E3%81%AE%E7%A8%AE%E9%A1%9E%E2%80%9D-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q7. リソース正常性アラートの条件 “理由の種類” について教えてください。</a></li><li><a href="#Q8-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E3%83%86%E3%82%B9%E3%83%88%E7%99%BA%E5%A0%B1%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q8. リソース正常性アラートでテスト発報することは可能ですか。</a></li><li><a href="#Q9-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q9. リソース正常性アラートの利用料金を教えてください。</a></li><li><a href="#Q10-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E9%87%8D%E8%A6%81%E5%BA%A6%E3%81%8C-4-%E8%A9%B3%E7%B4%B0-%E3%81%A8%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E9%87%8D%E8%A6%81%E5%BA%A6%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q10. リソース正常性アラートの重要度が [4 - 詳細] と表示されます。リソース正常性アラートの重要度を変更することはできますか。</a></li></ul><br><h3 id="Q1-リソース正常性アラートの概要と仕組みを教えてください。"><a href="#Q1-リソース正常性アラートの概要と仕組みを教えてください。" class="headerlink" title="Q1. リソース正常性アラートの概要と仕組みを教えてください。"></a>Q1. リソース正常性アラートの概要と仕組みを教えてください。</h3><p>リソース正常性アラートは、リソースの正常性に変化が生じた際に、アラートを通知する機能でございます。<br>アクティビティ ログに正常性に関するイベントが書き込まれ、アラートで指定した条件に合致した場合に発報します。<br>リソース正常性に関するログは、Azure portal の [モニター] - [アクティビティ ログ] からご確認いただけます。<br><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image01.png"></p><br><h3 id="Q2-リソース正常性アラートは、すべてのリソースで設定できますか。"><a href="#Q2-リソース正常性アラートは、すべてのリソースで設定できますか。" class="headerlink" title="Q2. リソース正常性アラートは、すべてのリソースで設定できますか。"></a>Q2. リソース正常性アラートは、すべてのリソースで設定できますか。</h3><p>いいえ、すべてのリソースで設定することはできません。<br><a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types">弊社公開情報</a> にリソース正常性アラートで設定可能なリソースと、チェックされる内容を掲載しております。<br>上記公開情報に記載のないリソースは、リソース正常性アラートを設定することはできません。</p><br><h3 id="Q3-リソース正常性アラートの監視間隔を教えてください。"><a href="#Q3-リソース正常性アラートの監視間隔を教えてください。" class="headerlink" title="Q3. リソース正常性アラートの監視間隔を教えてください。"></a>Q3. リソース正常性アラートの監視間隔を教えてください。</h3><p>リソース正常性アラートでは、リソースの状態が遷移した場合にほぼリアルタイムで通知されます。<br><a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-alert-monitor-guide">弊社公開情報</a> にもリソース正常性アラートに関する説明を記載しておりますので、ご覧くださいませ。</p><br><h3 id="Q4-リソース正常性アラートとサービス正常性アラートの違いを教えてください。"><a href="#Q4-リソース正常性アラートとサービス正常性アラートの違いを教えてください。" class="headerlink" title="Q4. リソース正常性アラートとサービス正常性アラートの違いを教えてください。"></a>Q4. リソース正常性アラートとサービス正常性アラートの違いを教えてください。</h3><p>サービス正常性アラートとリソース正常性アラートの違いは、監視対象のスコープです。<br>リソース正常性アラートは 「リソース単位」 で正常性を確認しますが、サービス正常性アラートは 「Azure サービスやリージョン」 単位で正常性を監視します。サービス正常性アラートの内容や設定手順は <a href="https://jpazmon-integ.github.io/blog/ame/HowToSetUpServiceHealthAlertsAndRecommendedSettings/">弊社サポート ブログ</a> でも紹介しておりますので、ぜひご覧ください。</p><br><h3 id="Q5-リソース正常性アラートの条件-“イベントの状態”-について教えてください。"><a href="#Q5-リソース正常性アラートの条件-“イベントの状態”-について教えてください。" class="headerlink" title="Q5. リソース正常性アラートの条件 “イベントの状態” について教えてください。"></a>Q5. リソース正常性アラートの条件 “イベントの状態” について教えてください。</h3><p>対象リソースのイベント状態を表します。<br>イベントの状態が Active である場合、リソースの正常性が異常な状態であることを表します。<br>一方で Resolved に変化した場合、異常な状態から正常な状態に遷移したことを表します。<br>In Progress は、以前のリソースの状態から現在のリソースの状態への変化が行われている途中で、<br>Updated は変化が完了したことを示します。<br>In Progress も Updated も、どちらも正常性の状態としては異常であるとご認識いただけますと幸いです。</p><p><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image02.png"></p><br><h3 id="Q6-リソース正常性アラートの条件-“現在のリソースの状態”-および-“以前のリソースの状態”-について教えてください。"><a href="#Q6-リソース正常性アラートの条件-“現在のリソースの状態”-および-“以前のリソースの状態”-について教えてください。" class="headerlink" title="Q6. リソース正常性アラートの条件 “現在のリソースの状態” および “以前のリソースの状態” について教えてください。"></a>Q6. リソース正常性アラートの条件 “現在のリソースの状態” および “以前のリソースの状態” について教えてください。</h3><p>対象リソースの状態を表します。<br>Unavailable と Degraded はリソースが利用可能でないことを意味し、Available はリソースが利用可能であることを意味します。<br>Unknown は、リソース正常性がリソースに関する情報を 10 分以上受け取っていないことを意味します。</p><p>例えば、以下のような設定の場合、<br>リソースの状態が 「Available」 の状態から 「Degraded または Unavailable」 に遷移したタイミングでアラートがトリガーされます。</p><p>■ 以前のリソースの状態 : Available<br>■ 現在のリソースの状態 : Degraded, Unavailable</p><p>「障害発生時にアラート メールを通知」する際は、<br>リソースの状態が “利用可能” (Available) から、”利用可能以外の状態” (Unavailable , Degraded , Unknown) であるイベント (状態の変化) を検知する必要がございます。</p><p>「障害復旧時にアラート メールを通知」する際は、<br>リソースの状態が “利用可能以外の状態” (Unavailable , Degraded , Unknown) から、”利用可能” (Available) であるイベント (状態の変化) を検知する必要がございます。</p><ul><li>現在のリソースの状態<br><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image03.png"></li></ul><br><ul><li>以前のリソースの状態<br><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image04.png"></li></ul><br><h3 id="Q7-リソース正常性アラートの条件-“理由の種類”-について教えてください。"><a href="#Q7-リソース正常性アラートの条件-“理由の種類”-について教えてください。" class="headerlink" title="Q7. リソース正常性アラートの条件 “理由の種類” について教えてください。"></a>Q7. リソース正常性アラートの条件 “理由の種類” について教えてください。</h3><p>リソースの状態が変化した理由を表します。<br>User Initiated はユーザー起因、Platform Initiated はプラットフォーム起因であることを意味します。<br>Unknown は、一時的に状態を確認できない場合等に出力されます。</p><p><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image05.png"></p><br><h3 id="Q8-リソース正常性アラートでテスト発報することは可能ですか。"><a href="#Q8-リソース正常性アラートでテスト発報することは可能ですか。" class="headerlink" title="Q8. リソース正常性アラートでテスト発報することは可能ですか。"></a>Q8. リソース正常性アラートでテスト発報することは可能ですか。</h3><p>リソース正常性アラートでは、テスト アラートという仕組みはございません。<br>リソース正常性アラートでは、リソース正常性履歴の「正常性イベント」と表示されている項目が通知されます。<br>そのため、リソース正常性の「正常性イベント」の項目が、<br>リソース正常性アラートで設定したアラートの条件で通知されるかどうかをチェックいただくことで、アラートの動作をご確認いただけます。<br><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image06.png"></p><p>なお、リソース正常性アラートの設定次第ではございますが、<br>例えば VM を再起動させた場合に、意図的にリソース正常性アラートを発報することは可能でございます。<br>ただし、Azure リソースによっては意図的にリソース正常性アラートの発報ができない可能性もございます。<br>各リソースでチェックされる正常性イベントは <a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types">弊社公開情報</a> に記載がございますので、ご確認いただけますと幸いです。</p><br><h3 id="Q9-リソース正常性アラートの利用料金を教えてください。"><a href="#Q9-リソース正常性アラートの利用料金を教えてください。" class="headerlink" title="Q9. リソース正常性アラートの利用料金を教えてください。"></a>Q9. リソース正常性アラートの利用料金を教えてください。</h3><p>リソース正常性アラートは、アクティビティ ログ アラートに含まれます。<br>そのため、リソース正常性アラートの設定にかかる課金は発生いたしません。<br>一方で、リソース正常性アラートを設定し、アクション グループを利用してメール等へ通知する場合は、通知にかかる課金が発生いたします。通知にかかる課金の詳細につきましては、<a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">弊社公開情報</a> の [通知] の項目をご覧ください。</p><br><h3 id="Q10-リソース正常性アラートの重要度が-4-詳細-と表示されます。リソース正常性アラートの重要度を変更することはできますか。"><a href="#Q10-リソース正常性アラートの重要度が-4-詳細-と表示されます。リソース正常性アラートの重要度を変更することはできますか。" class="headerlink" title="Q10. リソース正常性アラートの重要度が [4 - 詳細] と表示されます。リソース正常性アラートの重要度を変更することはできますか。"></a>Q10. リソース正常性アラートの重要度が [4 - 詳細] と表示されます。リソース正常性アラートの重要度を変更することはできますか。</h3><p>いいえ、リソース正常性アラートの重要度を変更することはできません。<br><img src="/blog/AzureMonitorEssential/ResourceHealthAlert/image07.png"></p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>また、弊社公開情報の <a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-overview">Resource Health の概要</a> や <a href="https://learn.microsoft.com/ja-JP/azure/service-health/resource-health-faq">Azure Resource Health の FAQ</a> もあわせてご確認いただけますと幸いです。</p><p>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;リソース正常性アラートという機能をご存知でしょうか。&lt;br&gt;リソース正常性アラートでは、リソース単位で発生した障害を確認することができます。&lt;br&gt;今回はリソース正常性アラートでよくお問い合わせをいただくご質問を紹介いたします。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
  </entry>
  
  <entry>
    <title>ログ アラート ルールの 0 件検知とクエリの時間の範囲のオーバーライドについて</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/</id>
    <published>2022-11-12T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.535Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure Monitoring チームの佐々木 大輔(ササキ ダイスケ)です。<br>ログを対象としたアラート ルールのログが0件の検知を行う際の注意点および、<br>“クエリの時間の範囲のオーバーライド” オプションについてご紹介させていただきます。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%AA%E3%82%8B%E3%83%AD%E3%82%B0%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AF2021-08-01%E3%81%A7%E3%81%99">本記事の対象となるログアラートルールは 2021-08-01 です</a><ul><li><a href="#AzurePortal%E3%81%AEUI%E3%81%8B%E3%82%89%E5%88%A4%E6%96%AD%E3%81%99%E3%82%8B">Azure Portal の UI から判断する</a></li><li><a href="#AzureResourceGraphExplorer%E3%81%A7%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%83%85%E5%A0%B1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">Azure Resource Graph Explorer でリソース情報を確認する</a></li></ul></li><li><a href="#%E3%83%AD%E3%82%B0%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B%E3%82%AF%E3%82%A8%E3%83%AA">ログアラートルールによって実際に実行されるクエリ</a><ul><li><a href="#%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB%E4%B8%8A%E3%81%AB%E3%81%A6%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%AF%E3%82%A8%E3%83%AA">アラートルール上にて指定したクエリ</a></li><li><a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B31">パターン1</a></li><li><a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B32">パターン2</a></li></ul></li><li><a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B31%E3%81%A7%E3%81%AF%E3%83%AD%E3%82%B0%E3%81%AE0%E4%BB%B6%E3%82%92%E6%A4%9C%E7%9F%A5%E3%81%A7%E3%81%8D%E3%81%A6%E3%80%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B32%E3%81%A7%E3%81%AF%E3%83%AD%E3%82%B0%E3%81%AE0%E4%BB%B6%E3%81%8C%E6%A4%9C%E7%9F%A5%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%80%81%E3%81%9D%E3%81%AE%E7%90%86%E7%94%B1">パターン1ではログの0件を検知できて、パターン2ではログの0件が検知できない、その理由</a></li><li><a href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E6%9C%9F%E9%96%93%E3%81%AE%E7%AF%84%E5%9B%B2%E3%81%AE%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">クエリの期間の範囲のオーバーライドについて</a></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li></ul><h2 id="本記事の対象となるログアラートルールは2021-08-01です"><a href="#本記事の対象となるログアラートルールは2021-08-01です" class="headerlink" title="本記事の対象となるログアラートルールは2021-08-01です"></a>本記事の対象となるログアラートルールは2021-08-01です</h2><p>ログアラートルールでは現在、主に apiversion:2021-08-01 および 2018-04-16 が存在しています。<br>本記事では apiversion:2021-08-01 のログアラートルールについて解説しています。<br>お使いのログアラートルールが 2021-08-01 なのかどうかは、以下手順で確認ください。</p><h3 id="AzurePortalのUIから判断する"><a href="#AzurePortalのUIから判断する" class="headerlink" title="AzurePortalのUIから判断する"></a>AzurePortalのUIから判断する</h3><h4 id="apiversion-2021-08-01-の場合"><a href="#apiversion-2021-08-01-の場合" class="headerlink" title="apiversion 2021-08-01 の場合"></a>apiversion 2021-08-01 の場合</h4><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/2.png"></p><h4 id="apiversion-2018-04-16-の場合"><a href="#apiversion-2018-04-16-の場合" class="headerlink" title="apiversion 2018-04-16 の場合"></a>apiversion 2018-04-16 の場合</h4><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/3.png"></p><p>※この確認方法はログ アラート ルールの 編集画面のみの変更によって適切ではなくなる可能性があり、基本的には Azure Resource Graph Explorer より確認いただく事を推奨します。</p><h3 id="AzureResourceGraphExplorerでリソース情報を確認する"><a href="#AzureResourceGraphExplorerでリソース情報を確認する" class="headerlink" title="AzureResourceGraphExplorerでリソース情報を確認する"></a>AzureResourceGraphExplorerでリソース情報を確認する</h3><ol><li>Azure Portal より Resource Graph エクスプローラー を開きます。</li></ol><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/1.png"></p><ol start="2"><li>次のクエリを実行し、apiversion 列を確認します。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line">| where type contains &quot;scheduledqueryrules&quot;</span><br><span class="line">| where name contains &quot;アラートルール名&quot;</span><br><span class="line">| extend apiversion = tostring(parse_json(properties)[&quot;createdWithApiVersion&quot;])</span><br></pre></td></tr></table></figure><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/4.png"></p><h2 id="ログアラートルールによって実際に実行されるクエリ"><a href="#ログアラートルールによって実際に実行されるクエリ" class="headerlink" title="ログアラートルールによって実際に実行されるクエリ"></a>ログアラートルールによって実際に実行されるクエリ</h2><p>ログ アラート ルールでは、お客様が指定したクエリはそのまま利用されず、指定された期間やその他設定項目を適用したクエリが実行されています。<br>最終的に実際に実行されるクエリによって0件の検知を行うか否かが確定するためこのクエリを意識する事が重要となります。</p><h3 id="アラートルール上にて指定したクエリ"><a href="#アラートルール上にて指定したクエリ" class="headerlink" title="アラートルール上にて指定したクエリ"></a>アラートルール上にて指定したクエリ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br></pre></td></tr></table></figure><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/5.png"></p><h3 id="パターン1"><a href="#パターン1" class="headerlink" title="パターン1"></a>パターン1</h3><ul><li><p>設定値</p><ul><li>メジャー: テーブルの行</li><li>集計の種類: カウント</li><li>集計の粒度: 5分</li><li>演算子: 等しい</li><li>しきい値: 0</li><li>評価の粒度: 5分</li><li>クエリの期間の範囲のオーバーライド:未指定(なし(5分)の表示)</li></ul></li><li><p>実際に実行されるクエリ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| extend TimeGenerated = column_ifexists(&#x27;TimeGenerated&#x27;, datetime(2022-10-26T02:08:39.0000000Z)) // クエリの期間の範囲のオーバーライドに関連 (未指定のため、期間がそのまま適用された)</span><br><span class="line">| where TimeGenerated &gt;= datetime(2022-10-26T02:08:39.0000000Z) and TimeGenerated &lt; datetime(2022-10-26T02:13:39.0000000Z) // クエリの期間の範囲のオーバーライドに関連 (未指定のため、期間がそのまま適用された)</span><br><span class="line">| where Computer in (&#x27;WIN-1FCE0JPJ64V&#x27;)// ディメンション に関連 (Computer WIN-1FCE0JPJ64V のみを指定)</span><br><span class="line">| summarize AggregatedValue = count() by bin_at(TimeGenerated, 5m, datetime(2022-10-26T02:13:39.0000000Z)), Computer // 粒度、期間に関連、テーブル行、カウントを選択</span><br></pre></td></tr></table></figure></li><li><p>ポータルでの検索結果</p></li></ul><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/7.png"></p><h3 id="パターン2"><a href="#パターン2" class="headerlink" title="パターン2"></a>パターン2</h3><ul><li><p>設定値</p><ul><li>メジャー: テーブルの行</li><li>集計の種類: カウント</li><li>集計の粒度: 5分</li><li>演算子: 等しい</li><li>しきい値: 0</li><li>評価の粒度: 5分</li><li>評価の粒度: 5分</li><li>クエリの期間の範囲のオーバーライド:2日を指定</li></ul></li><li><p>実際に実行されるクエリ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| extend TimeGenerated = column_ifexists(&#x27;TimeGenerated&#x27;, datetime(2022-10-24T02:55:55.0000000Z)) // クエリの期間の範囲のオーバーライドに関連 (2日を指定)</span><br><span class="line">| where TimeGenerated &gt;= datetime(2022-10-24T02:55:55.0000000Z) and TimeGenerated &lt; datetime(2022-10-26T02:55:55.0000000Z)  // クエリの期間の範囲のオーバーライドに関連 (2日を指定)</span><br><span class="line">| where Computer in (&#x27;dasasaki-windows10&#x27;)// ディメンション に関連 (Computer  dasasaki-windows10 のみを指定)</span><br><span class="line">| summarize AggregatedValue = count() by bin_at(TimeGenerated, 5m, datetime(2022-10-26T02:55:55.0000000Z)), Computer // 粒度、期間に関連、テーブル行、カウントを選択</span><br></pre></td></tr></table></figure></li><li><p>ポータルでの検索結果</p></li></ul><p><img src="/blog/AzureMonitorEssential/HowLogAlertZeroRecordFired/6.png"></p><h3 id="パターン1ではログの0件を検知できて、パターン2ではログの0件が検知できない、その理由"><a href="#パターン1ではログの0件を検知できて、パターン2ではログの0件が検知できない、その理由" class="headerlink" title="パターン1ではログの0件を検知できて、パターン2ではログの0件が検知できない、その理由"></a>パターン1ではログの0件を検知できて、パターン2ではログの0件が検知できない、その理由</h3><p>0 件の検知を行う場合には、<a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B31">パターン1</a> の様に実際に実行されたクエリの検索結果が全く無い状況になる必要があります。<br>そのため、クエリのオーバーライド 2日を指定しますと、検索結果に 10/24 のデータが存在しており、直近5分のログが無い場合でも 0件での検知はできません。<br>このほかに、ディメンション(Computer)を増やした場合にも検索結果は <a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B32">パターン2</a> の様に検索結果が存在する可能性があり、その場合も  WIN-1FCE0JPJ64V の 0 件の検知はできません。</p><h3 id="クエリの期間の範囲のオーバーライドについて"><a href="#クエリの期間の範囲のオーバーライドについて" class="headerlink" title="クエリの期間の範囲のオーバーライドについて"></a>クエリの期間の範囲のオーバーライドについて</h3><p>クエリの期間の範囲のオーバーライド オプションは、クエリによって期間が指定されている場合でも、このオプションで二日を指定すると、その期間が2日に書き換えられます。<br>このオプションを利用する事のメリットに関するご質問をいただく事がありますが、<br>これは全ての期間のログを検索してしまうなどの高負荷・長時間かかるクエリ実行を避ける等、Azure 側の負荷抑制の意味合いが強く、ユーザーへのメリットをもたらす事は多くありません。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>以下の 3 点についてご理解いただけたでしょうか。</p><ul><li>ログ アラート ルールで実際に実行されるクエリ</li><li>ログ0件を検知する場合には実際に実行されるクエリの検索結果が0件になる必要がある</li><li>クエリの期間の範囲のオーバーライドを利用するメリット</li></ul><p>本記事がご理解の助けとして、お役立ていただければ幸いです。</p><p>以上、ログ アラート ルールの 0 件検知とクエリの時間の範囲のオーバーライドについてご紹介させていただきました。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！ Azure Monitoring チームの佐々木 大輔(ササキ ダイスケ)です。&lt;br&gt;ログを対象としたアラート ルールのログが0件の検知を行う際の注意点および、&lt;br&gt;“クエリの時間の範囲のオーバーライド” オプションについてご紹介させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Azure Monitor" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
    <category term="Log Alert" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Alert/"/>
    
  </entry>
  
  <entry>
    <title>Application Insights 可用性テスト の クラシック と 標準 の違いについて</title>
    <link href="https://jpazmon-integ.github.io/blog/applicationInsights/aboutAvailabilityTest/"/>
    <id>https://jpazmon-integ.github.io/blog/applicationInsights/aboutAvailabilityTest/</id>
    <published>2022-11-05T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.727Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの佐々木です。</p><p>今回は、Application Insights に用意されている以下の可用性テスト２種類について特徴と使い分けをご案内させていただきます。</p><p><img src="/blog/applicationInsights/aboutAvailabilityTest/1.png"></p><ul><li><ol><li>クラシック テスト</li></ol></li><li><ol start="2"><li>標準テスト</li></ol></li></ul><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88">クラシック テスト</a></li><li><a href="#%E6%A8%99%E6%BA%96%E3%83%86%E3%82%B9%E3%83%88">標準テスト</a></li><li><a href="#%E3%82%AF%E3%83%A9%E3%82%B7%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E4%BB%8A%E5%BE%8C%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">クラシック テストの今後について</a></li><li><a href="#%E9%96%89%E3%81%98%E3%82%89%E3%82%8C%E3%81%9F%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%B8%E3%81%AE%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%86%E3%82%B9%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">閉じられたネットワークへの可用性テストについて</a></li><li><a href="#%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">可用性テストのテスト方法について</a></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><h2 id="クラシックテスト"><a href="#クラシックテスト" class="headerlink" title="クラシックテスト"></a>クラシックテスト</h2><p>クラシック テストとは、以下ドキュメントにて案内されている機能を示します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/monitor-web-app-availability">URL ping テストを使用して可用性を監視する - Azure Monitor | Microsoft Learn</a></p><p>パブリック DNS レコードが存在し、ファイアウォールなどを使用してパブリックからのアクセスを制限した環境に対しては、サービス タグまたはテストの送信元のサーバーの IP アドレスを許可してテストを行うことができます。</p><p>可用性テストの送信元のサーバーの IP アドレスはサービス タグ “ApplicationInsightsAvailability” にて定義しております。このサービス タグをネットワーク セキュリティ グループなどで受信の許可を設定して、可用性テストを実施できます。<br><img src="../aboutPrivateAvailabilityTest/1.png"></p><p>または、リクエストを送信するテストの場所ごとの IP アドレスに対して受信の許可を設定し、テストを行うことも可能でございます。<br>テストの場所ごとの IP アドレスは以下の弊社公開情報にて提供しております。<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/app/ip-addresses#addresses-grouped-by-location-azure-public-cloud">場所ごとにグループ化されたアドレス (Azure パブリック クラウド)</a></p><h3 id="クラシック-テスト-の機能"><a href="#クラシック-テスト-の機能" class="headerlink" title="クラシック テスト の機能"></a>クラシック テスト の機能</h3><p><img src="/blog/applicationInsights/aboutAvailabilityTest/2.png"></p><ul><li>ICMP ではなく、HTTP リクエストを利用し、エンドポイントが応答するかどうかを検証します。</li><li>CSSの取得先など、Web ページが依存する Web ページの可用性解析(従属要求の解析)</li><li>最大3回までのリクエストが失敗した際の再試行</li><li>リクエスト元ロケーションの指定</li><li>成功時の条件指定<ul><li>応答ステータス</li><li>タイムアウト秒数</li><li>レスポンスボディの一致(コンテンツの一致) ※日本語非対応</li></ul></li></ul><p>[参考情報]<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/monitor-web-app-availability">URL ping テストを使用して可用性を監視する - Azure Monitor | Microsoft Learn</a></p><h2 id="標準テスト"><a href="#標準テスト" class="headerlink" title="標準テスト"></a>標準テスト</h2><p>標準テスト とは、以下ドキュメントにて案内されている機能を示します。</p><p><img src="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-standard-tests" alt="可用性の標準テスト - Azure Monitor Application Insights - Azure Monitor | Microsoft Learn"></p><p>これは 2021年7月頃に追加された機能であり、同時に以前から存在していた可用性テストは、クラシック テスト と呼ばれる様になりました。</p><h3 id="標準テスト-の機能"><a href="#標準テスト-の機能" class="headerlink" title="標準テスト の機能"></a>標準テスト の機能</h3><p><img src="/blog/applicationInsights/aboutAvailabilityTest/3.png"><br>クラシック テストの機能と比較し、<em><strong>追加されている機能</strong></em>がございます。<br>そのため、クラシック テストよりも多くのシチュエーションに対応する事が可能です。</p><ul><li>ICMP ではなく、HTTP リクエストを利用し、エンドポイントが応答するかどうかを検証します。</li><li>CSSの取得先など、Web ページが依存する Web ページの可用性解析(従属要求の解析)</li><li>最大3回までのリクエストが失敗した際の再試行</li><li><em><strong>SSL 証明書の有効性解析</strong></em><ul><li><em><strong>発行者が異なる証明書ではないか等</strong></em></li><li><em><strong>証明書の有効期間が切れていないか、残り日数〇日未満ではないか</strong></em></li></ul></li><li><em><strong>HTTP リクエストのメソッド指定</strong></em></li><li><em><strong>HTTP リクエストのヘッダー指定</strong></em></li><li>リクエスト元ロケーションの指定</li><li>成功時の条件指定<ul><li>応答ステータス<ul><li>400未満を全て成功にするオプション</li></ul></li><li>タイムアウト秒数</li><li>レスポンスボディの一致(コンテンツの一致) <ul><li><em><strong>日本語対応</strong></em></li><li><em><strong>大文字、小文字の区別オプション</strong></em></li><li><em><strong>部分一致オプション</strong></em></li></ul></li></ul></li></ul><h2 id="クラシックテストの今後について"><a href="#クラシックテストの今後について" class="headerlink" title="クラシックテストの今後について"></a>クラシックテストの今後について</h2><p>現時点(2022/11/6)では、クラシック テストの廃止予定はなく、引き続きご利用いただく事が可能ですが、<br>追加された機能と、それにより対応可能なシチュエーションが多数増えておりますため、新しく作成いただく場合には標準テストをご利用いただく事を推奨します。</p><h2 id="閉じられたネットワークへの可用性テストについて"><a href="#閉じられたネットワークへの可用性テストについて" class="headerlink" title="閉じられたネットワークへの可用性テストについて"></a>閉じられたネットワークへの可用性テストについて</h2><p>インターネットに公開されている必要のある、クラシック テスト や 標準テストでは対応する事ができません。<br>Azure Function を用いたカスタム可用性テストを利用した方法が公開ドキュメント、サポートブログにて案内されておりますため、こちらをご確認いただけますと幸いです。</p><p>[参考]<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-azure-functions">Azure Functions を使用してカスタム可用性テストを作成して実行する - Azure Monitor | Microsoft Learn</a><br><a href="https://jpazmon-integ.github.io/blog/applicationInsights/aboutPrivateAvailabilityTest/">プライベート環境への可用性テスト | Japan Azure Monitoring Support Blog (jpazmon-integ.github.io)</a></p><h2 id="可用性テストのテスト方法について"><a href="#可用性テストのテスト方法について" class="headerlink" title="可用性テストのテスト方法について"></a>可用性テストのテスト方法について</h2><p>可用性テストで網羅可能なシチュエーションが多数あるものの、お客様がご希望される監視要件時の動作を検証される場合、<br>弊社外にて用意されているサンプル ページを利用する事で検証可能と思われます。<br>例えば、SSL 有効性のテスト環境や、ステータスコードご構築が難しい場合は、下記のようなサイトをご利用いただく事が可能かと存じます。</p><ul><li>ステータス コード別<br><a href="https://ozuma.sakura.ne.jp/httpstatus/">Test pages of HTTP Status code (sakura.ne.jp)</a></li><li>SSL ステータス別<br><a href="https://badssl.com/">badssl.com</a></li></ul><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事では、クラシックと標準の可用性テストついてご案内いたしましたが、ご理解いただけましたでしょうか。</p><p>本記事が少しでもお役に立ちましたら幸いです。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの佐々木です。&lt;/p&gt;
&lt;p&gt;今回は、Application Insights に用意されている以下の可用性テスト２種類について特徴と使い分けをご案内させていただきます。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/applicationInsights/aboutAvailabilityTest/1.png&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;ol&gt;
&lt;li&gt;クラシック テスト&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;標準テスト&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Application Insights" scheme="https://jpazmon-integ.github.io/blog/tags/Application-Insights/"/>
    
    <category term="可用性テスト" scheme="https://jpazmon-integ.github.io/blog/tags/%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%86%E3%82%B9%E3%83%88/"/>
    
  </entry>
  
  <entry>
    <title>Migrate to Azure Storage lifecycle management from diagnostic settings storage retention について</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/</id>
    <published>2022-10-25T05:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.555Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring &amp; Integration サポート チームの北山です。<br>今回の記事では、サービス正常性にて通知された「Action required: Migrate to Azure Storage lifecycle management from diagnostic settings storage retention」について説明します。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E5%A0%B1%E5%91%8A%E3%81%95%E3%82%8C%E3%81%9F%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%81%AE%E5%8B%A7%E5%91%8A%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">報告された正常性の勧告について</a><ul><li><a href="#%E6%A6%82%E8%A6%81">概要</a></li><li><a href="#%E5%86%85%E5%AE%B9">内容</a></li><li><a href="#%E5%AE%9F%E6%96%BD%E3%81%84%E3%81%9F%E3%81%A0%E3%81%8D%E3%81%9F%E3%81%84%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">実施いただきたいアクション</a></li></ul></li><li><a href="#%E6%8A%84%E8%A8%B3">抄訳</a><ul><li><a href="#2v_c-980-%E3%81%AE%E6%A6%82%E8%A6%81">2V_C-980 の概要</a></li><li><a href="#%E5%BB%83%E6%AD%A2%E3%81%95%E3%82%8C%E3%82%8B%E3%81%A8%E3%81%A9%E3%81%86%E3%81%AA%E3%82%8B%E3%81%8B">廃止されるとどうなるか</a></li><li><a href="#%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%8A%E5%AE%A2%E6%A7%98">影響を受けるお客様</a></li><li><a href="#%E3%81%8A%E5%AE%A2%E6%A7%98%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">お客様に必要なアクションについて</a></li></ul></li><li><a href="#%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E5%81%B4%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E4%BF%9D%E6%8C%81%E6%A9%9F%E8%83%BD%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">診断設定側のデータ保持機能を利用している診断設定を特定する方法について</a><ul><li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88">サンプル スクリプト</a></li></ul></li></ul><h2 id="報告された正常性の勧告について"><a href="#報告された正常性の勧告について" class="headerlink" title="報告された正常性の勧告について"></a>報告された正常性の勧告について</h2><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><table><thead><tr><th>項目名</th><th>項目値</th></tr></thead><tbody><tr><td>題名</td><td>Action required: Migrate to Azure Storage lifecycle management from diagnostic settings storage retention</td></tr><tr><td>追跡 ID</td><td>2V_C-980</td></tr><tr><td>影響を受けるリージョン</td><td>Global</td></tr><tr><td>正常性イベントの種類</td><td>正常性の勧告</td></tr></tbody></table><h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><p>You’re receiving this notice because you use the Azure Monitor diagnostic settings storage retention feature.<br>On 30 September 2025, the diagnostic settings storage retention feature of Azure Monitor will be retired and retention will no longer be applied to logs sent to storage account destinations via diagnostic settings.<br>You’ll need to migrate to the Azure Storage lifecycle management feature by that date.  </p><p>Azure Storage lifecycle management provides all the same functionality, plus it enables you to:</p><ul><li>Transition blobs to a cooler storage tier to optimize for performance and cost.</li><li>Define up to 100 separate rules.</li><li>Apply rules to containers or specific subsets of blobs.</li></ul><h3 id="実施いただきたいアクション"><a href="#実施いただきたいアクション" class="headerlink" title="実施いただきたいアクション"></a>実施いただきたいアクション</h3><p>To continue applying retention to logs sent to storage accounts via diagnostic settings, <a href="https://docs.microsoft.com/azure/azure-monitor/essentials/migrate-to-azure-storage-lifecycle-policy">migrate</a> to Azure Storage lifecycle management by 30 September 2025.</p><h2 id="抄訳"><a href="#抄訳" class="headerlink" title="抄訳"></a>抄訳</h2><h3 id="2V-C-980-の概要"><a href="#2V-C-980-の概要" class="headerlink" title="2V_C-980 の概要"></a>2V_C-980 の概要</h3><p>Azure リソースのリソース ログやメトリックを Log Analytics ワークスペースやストレージ アカウント、Event Hubs に出力する場合に診断設定をご構築いただく必要があります。  </p><div class="alert is-info"><p class="alert-title">Note</p><p>診断設定については<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">こちら</a>の公開情報をご確認ください。</p></div><p>リソース ログやメトリックをストレージ アカウントへ出力する場合、下図のように診断設定側にデータの保持期間を指定することが可能です。  </p><p><img src="/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/capt1.png"></p><p>もし保持期間を設定いただいた場合、ストレージ アカウントに出力されたデータは設定した保持期間に従って自動的に削除されます。<br>今回の正常性の勧告は、診断設定に実装されたデータの保持期間機能が 2025 年 9 月 30 日に廃止となる案内です。</p><h3 id="廃止されるとどうなるか"><a href="#廃止されるとどうなるか" class="headerlink" title="廃止されるとどうなるか"></a>廃止されるとどうなるか</h3><p>診断設定側のデータ保持機能が廃止となるため、ストレージ アカウントに保存されたデータが自動的に削除されなくなります。<br>結果的に、診断設定により出力されたデータストレージ アカウントに永久的に残るため、期待しないコストが発生する可能性があります。<br>診断設定側のデータ保持機能が廃止された後は、ストレージ アカウント側のライフサイクル管理ポリシーを用いてデータの保持期間を管理していただく必要があります。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/storage/blobs/lifecycle-management-policy-configure?tabs=azure-portal">ライフサイクル管理ポリシーを構成する</a></li></ul><h3 id="影響を受けるお客様"><a href="#影響を受けるお客様" class="headerlink" title="影響を受けるお客様"></a>影響を受けるお客様</h3><p>診断設定側のデータ保持機能をご利用いただいているお客様が影響を受けます。</p><h3 id="お客様に必要なアクションについて"><a href="#お客様に必要なアクションについて" class="headerlink" title="お客様に必要なアクションについて"></a>お客様に必要なアクションについて</h3><p>診断設定によってストレージ アカウントへ出力されたデータの保持期間を引き続きご指定いただきたい場合は、2025 年 9 月末までにストレージ アカウント側のライフサイクル管理ポリシーへ移行していただく必要がございます。<br>移行に関する手順の詳細につきましては、下記の公開情報をご参考いただけますと幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/migrate-to-azure-storage-lifecycle-policy">診断設定ストレージ保持から Azure Storage ライフサイクル管理に移行する</a></li></ul><h2 id="診断設定側のデータ保持機能を利用している診断設定を特定する方法について"><a href="#診断設定側のデータ保持機能を利用している診断設定を特定する方法について" class="headerlink" title="診断設定側のデータ保持機能を利用している診断設定を特定する方法について"></a>診断設定側のデータ保持機能を利用している診断設定を特定する方法について</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/migrate-to-azure-storage-lifecycle-policy">ストレージ アカウントのライフサイクル管理に移行する公開情報</a>には、どの診断設定が診断設定側のデータ保持機能を利用しているかを特定する方法の記載がありません。<br>そのため、複数ある診断設定に対して一つ一つ Azure portal から確認する必要があります。<br>この方法はかなり大変な作業だと思うので、診断設定側のデータ保持機能を利用している診断設定一覧を CSV として出力するサンプル PowerShell スクリプトを用意いたしました。</p><h3 id="サンプル-スクリプト"><a href="#サンプル-スクリプト" class="headerlink" title="サンプル スクリプト"></a>サンプル スクリプト</h3><h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><ul><li>PowerShell 7 を用いて動作確認を実施しております。</li><li>以下のコマンドでインストールした Az モジュールを用いて動作確認を実施しております。<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> Az <span class="literal">-force</span> <span class="literal">-AllowPrerelease</span> <span class="literal">-AllowClobber</span> <span class="literal">-SkipPublisherCheck</span> <span class="literal">-Repository</span> PSGallery</span><br><span class="line"><span class="built_in">Update-Module</span> <span class="literal">-Name</span> Az <span class="literal">-AllowPrerelease</span> <span class="literal">-Force</span> <span class="literal">-Confirm</span></span><br></pre></td></tr></table></figure></li><li>サンプル スクリプト実行前に、必ず Connect-AzAccount を実行して Azure へログインいただき、Set-AzContext を実行して対象のサブスクリプションをご指定ください。<ul><li>なお、Cloud Shell から実行される場合は、Connect-AzAccount の実行は不要です。</li></ul></li><li>もし、どれか一つの診断設定に対して保持期間が指定されていた場合は、サンプル スクリプト実行後に CSV ファイルが出力されます。</li><li>一方で、どの診断設定にも保持期間が指定されていない場合は、CSV ファイルは出力されません。そのため、ファイルが出力されなかった場合は 2V_C-980 に対する対処は不要です。</li></ul><h4 id="サンプル"><a href="#サンプル" class="headerlink" title="サンプル"></a>サンプル</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Need to use Az module(version 9.0.0) and PowerShell version 7 ##</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$Resrouces</span> = <span class="built_in">Get-AzResource</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 診断設定の取得</span></span><br><span class="line"><span class="variable">$Resrouces</span>.Id | <span class="built_in">ForEach-Object</span> <span class="literal">-Parallel</span>&#123;</span><br><span class="line">    <span class="variable">$ResroucesId</span> = <span class="variable">$_</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 出力する csv ファイルパス、ファイル名を定義する</span></span><br><span class="line">    <span class="variable">$FilePath</span> = <span class="string">&quot;DiagnosticSettingInfo.csv&quot;</span> </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 書き込みのリトライ待機時間</span></span><br><span class="line">    <span class="variable">$RetryWaitMilliseconds</span> = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 診断設定を取得する。なければ $DiagnosticSettings は Null となる</span></span><br><span class="line">    <span class="variable">$DiagnosticSettings</span> = <span class="built_in">Get-AzDiagnosticSetting</span> <span class="literal">-ResourceId</span> <span class="variable">$ResroucesId</span> <span class="literal">-WarningAction</span> SilentlyContinue <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 診断設定があるかどうか</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$DiagnosticSettings</span> <span class="operator">-ne</span> <span class="variable">$null</span>)&#123;</span><br><span class="line">        <span class="comment"># 診断設定ある場合、各設定についてみていく</span></span><br><span class="line">        <span class="keyword">ForEach</span> (<span class="variable">$DiagnosticSetting</span> <span class="keyword">in</span> <span class="variable">$DiagnosticSettings</span>)&#123;</span><br><span class="line">            <span class="comment"># LOG 系の診断設定があるかどうか</span></span><br><span class="line">            <span class="variable">$LogSettings</span> = <span class="variable">$DiagnosticSetting</span>.Log</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$LogSettings</span> <span class="operator">-ne</span> <span class="variable">$null</span>)&#123;</span><br><span class="line">                <span class="comment"># 各カテゴリについて、保持期間があるかどうか確認していく</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$LogSetting</span> <span class="keyword">in</span> <span class="variable">$LogSettings</span>)&#123;</span><br><span class="line">                    <span class="variable">$DiagnosticSettingInfo</span> = <span class="built_in">New-Object</span> System.Collections.Generic.List<span class="function">[<span class="built_in">string</span>]</span></span><br><span class="line">                    <span class="keyword">if</span> ( <span class="variable">$LogSetting</span>.RetentionPolicyDay <span class="operator">-ne</span> <span class="number">0</span> )</span><br><span class="line">                    &#123;   </span><br><span class="line">                        <span class="comment"># 保持期間が設定された診断設定がある場合、情報を追記する</span></span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$ResroucesId</span>)</span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$DiagnosticSetting</span>.Name)</span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$LogSetting</span>.Category)</span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$LogSetting</span>.RetentionPolicyDay)</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># 書き込みが完了するまでリトライする</span></span><br><span class="line">                        <span class="keyword">while</span> (<span class="variable">$true</span>)&#123;</span><br><span class="line">                            <span class="keyword">try</span>&#123;</span><br><span class="line">                                <span class="variable">$DiagnosticSettingInfo</span> <span class="operator">-join</span> <span class="string">&quot;,&quot;</span> | <span class="built_in">Out-File</span> <span class="literal">-FilePath</span> <span class="variable">$FilePath</span> <span class="literal">-Append</span> <span class="literal">-ErrorAction</span> Stop</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            &#125;<span class="keyword">catch</span> [<span class="type">System.IO.IOException</span>]&#123;</span><br><span class="line">                                <span class="built_in">Start-Sleep</span> <span class="literal">-Milliseconds</span> <span class="variable">$RetryWaitMilliseconds</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment"># METRIC 系の診断設定がある場合</span></span><br><span class="line">            <span class="variable">$MetricSettings</span> = <span class="variable">$DiagnosticSetting</span>.Metric</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$MetricSettings</span> <span class="operator">-ne</span> <span class="variable">$null</span>)&#123;</span><br><span class="line">                <span class="comment"># 各カテゴリについて、保持期間があるかどうか確認していく</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$MetricSetting</span> <span class="keyword">in</span> <span class="variable">$MetricSettings</span>)&#123;</span><br><span class="line">                    <span class="variable">$DiagnosticSettingInfo</span> = <span class="built_in">New-Object</span> System.Collections.Generic.List<span class="function">[<span class="built_in">string</span>]</span></span><br><span class="line">                    <span class="keyword">if</span> ( <span class="variable">$MetricSetting</span>.RetentionPolicyDay <span class="operator">-ne</span> <span class="number">0</span> )</span><br><span class="line">                    &#123;   </span><br><span class="line">                        <span class="comment"># 保持期間が設定された診断設定がある場合、情報を追記する</span></span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$ResroucesId</span>)</span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$DiagnosticSetting</span>.Name)</span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$MetricSetting</span>.Category)</span><br><span class="line">                        <span class="variable">$DiagnosticSettingInfo</span>.add(<span class="variable">$MetricSetting</span>.RetentionPolicyDay)</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># 書き込みが完了するまでリトライする</span></span><br><span class="line">                        <span class="keyword">while</span> (<span class="variable">$true</span>)&#123;</span><br><span class="line">                            <span class="keyword">try</span>&#123;</span><br><span class="line">                                <span class="variable">$DiagnosticSettingInfo</span> <span class="operator">-join</span> <span class="string">&quot;,&quot;</span> | <span class="built_in">Out-File</span> <span class="literal">-FilePath</span> <span class="variable">$FilePath</span> <span class="literal">-Append</span> <span class="literal">-ErrorAction</span> Stop</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            &#125;<span class="keyword">catch</span> [<span class="type">System.IO.IOException</span>]&#123;</span><br><span class="line">                                <span class="built_in">Start-Sleep</span> <span class="literal">-Milliseconds</span> <span class="variable">$RetryWaitMilliseconds</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="literal">-ThrottleLimit</span> <span class="number">100</span></span><br></pre></td></tr></table></figure><h4 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h4><p>上記 PowerShell スクリプトは Azure portal の Cloud Shell からも実行可能です。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/cloud-shell/overview">Azure Cloud Shell の概要</a></li></ul><p>上記スクリプトの処理時間は、当該サブスクリプションに存在するリソース数に影響いたします。<br>弊社検証環境には 2000 個の Azure リソースがございますが、およそ 5 分から 10 分ほど時間を要しました。<br>Cloud Shell にてスクリプトを実行後、下記の手順にて CSV ファイルのダウンロードが可能です。</p><ol><li><p>Dir コマンドで対象の CSV ファイルが存在する事を確認します。<br><img src="/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/capt2.png"></p></li><li><p>ダウンロードをクリックします。<br><img src="/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/capt3.png"></p></li><li><p>ファイル名を入力して [ダウンロード] をクリックします。<br><img src="/blog/AzureMonitorEssential/diagSettings_storageRetention_willBeRetired/capt4.png"></p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring &amp;amp; Integration サポート チームの北山です。&lt;br&gt;今回の記事では、サービス正常性にて通知された「Action required: Migrate to Azure Storage lifecycle management from diagnostic settings storage retention」について説明します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor/"/>
    
    <category term="Diagnostic settings" scheme="https://jpazmon-integ.github.io/blog/tags/Diagnostic-settings/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor エージェントを使用した Azure Monitor VM insights の有効化 (プレビュー)</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/Azure_Monitor_VM_insights_using_AMA/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/Azure_Monitor_VM_insights_using_AMA/</id>
    <published>2022-10-19T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.567Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure Monitoring チームの秋田です。</p><p>本記事は、2022 年 8 月 4 日に米国の Azure Moniotr Blog で公開された、<a href="https://techcommunity.microsoft.com/t5/azure-observability-blog/announcing-preview-enable-azure-monitor-vm-insights-using-azure/ba-p/3589423">Announcing preview: Enable Azure Monitor VM insights using Azure Monitor agent</a> を翻訳したものになります。<br>Azure Monitor エージェントを使用した Azuer Monitor VM Insights について、既存の VM insights と比べてどういうところが変わるのか、設定方法などに関して最新情報をお届けします。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>既存の VM insigtsh との違い</li><li>設定方法<ul><li>現在</li><li>Azure Monitor VM Insights (preview)</li></ul></li><li>導入方法</li><li>VM insights DCRs とは？</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>本ブログでは、プレビュー段階の機能である Azure Monitor エージェントを使用した Azure Monitor VM Insights の構成についてご紹介します。</p><h2 id="既存の-VM-insights-との違い"><a href="#既存の-VM-insights-との違い" class="headerlink" title="既存の VM insights との違い"></a>既存の VM insights との違い</h2><p>ここでは、現状ご利用いただいております VM insghts と比べてどのようなところが変わるのかをご説明します。<br>セット アップ面、コスト面、セキュリティとパフォーマンス面で様々な利点があり、これらの利点を享受することがレガシーの Log Analytics エージェントから Azure Monitor エージェントへ移行をする理由の 1 つになります。</p><h3 id="現在"><a href="#現在" class="headerlink" title="現在"></a>現在</h3><p>VM insights は、監視のために VM や VM スケールセットに Log Analytics エージェントと Dependency エージェントの 2 つをインストールする必要があります。</p><h3 id="Azure-Monitor-VM-Insights-preview"><a href="#Azure-Monitor-VM-Insights-preview" class="headerlink" title="Azure Monitor VM Insights (preview)"></a>Azure Monitor VM Insights (preview)</h3><p>Azure Monitor VM Insights には、レガシーの Log Analytics エージェントから Azure Monitor エージェントにエージェントを交換するだけではなく、<br>もっと多くの利点があります。</p><ul><li><p>Centralized configuration (一元化された構成)<br>データ収集ルール (以下、DCR) を使用して、VM Insights を簡単にセット アップすることが可能です。<br>Azure ポータルを利用して VM insights を有効化する場合、VM insights を利用するための DCR が存在しない場合は、新たな DCR が構成されます。<br>同一構成の DCR を複数台の VM に適用する際には、DCR に当該 VM を関連付けするだけで適用することが可能です。</p></li><li><p>Optimize costs (最適化されたコスト)<br>プロセスとマップ ビューを提供する依存関係データを収集するか否かをご選択いただけるように変更しました。<br>従来は、依存関係データの収集のために Dependency エージェント (依存関係エージェント) が必要でしたが、新しい Azure Monitor VM Insights の構成オプションでは、Dependency エージェントのインストールが不要になりました。これにより、必要な情報だけを収集でき、コストを最適化することが可能になります。</p></li><li><p>Enhanced security and performance (セキュリティとパフォーマンスの強化)<br>Azure Monitor エージェントでは、認証とセキュリティのためにマネージド ID を使用しております。<br>これらは、レガシーのエージェントで使用していた認証と比べてよりセキュアでハッキングにも強いです。<br>また、レガシーのエージェントと比べてより高い event-per-second アップロード率を示します。</p></li></ul><h2 id="導入方法"><a href="#導入方法" class="headerlink" title="導入方法"></a>導入方法</h2><p>Azure ポータルから導入する方法、ARM テンプレートや Azure ポリシーにより導入する方法など様々な方法がありますが、<br>本ブログでは Azure ポータルから導入する方法をご案内いたします。</p><p>注意 : Azure Monitor VM Insights を導入する VM が事前に [開始] されている必要があることにご注意ください。</p><p>下記の弊社公開情報に手順が記載されております。<br>こちらも併せてご参照ください。<br>Azure Monitor エージェントの VM insights を有効にする<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-portal#enable-vm-insights-for-azure-monitor-agent">https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-portal#enable-vm-insights-for-azure-monitor-agent</a></p><ol><li><p>Azure のサービスから [モニター] を選択してください。</p></li><li><p>左端の [分析情報] メニューにあります [仮想マシン] を選択してください。</p></li><li><p>[概要] タブにあります [監視対象外] の VM から監視対象としたい VM を探し、[有効にする] をクリックしてください。<br><img src="/blog/LogAnalytics/Azure_Monitor_VM_insights_using_AMA/3-enable.png" alt="手順 3"></p></li><li><p>遷移後の画面で [有効] をクリックしてください。すると、[監視の構成] という画面に遷移します。<br><img src="/blog/LogAnalytics/Azure_Monitor_VM_insights_using_AMA/4.png" alt="手順 4"></p></li><li><p>手順 4 により遷移した [監視の構成] 画面で各種設定を行います。<br>[次を使用した分析情報を有効にする] は [Azure Monitor エージェント (推奨)] を選択し、[データ収集ルール] に関しては、DCR 未作成の場合は、[新規作成] により作成してください。<br>VM insights 用の DCR を既に作成している場合は、プルダウンから利用したい DCR を選択してください。</p></li></ol><p><img src="/blog/LogAnalytics/Azure_Monitor_VM_insights_using_AMA/5.png" alt="手順 5"></p><p>すべての設定が完了したら、[構成] をクリックしてください。</p><p>以上で、Azure Monitor VM insights の導入が完了しました。</p><p>(補足) 収集されたログを確認する方法。<br>収集先として指定した Log Analytics ワークスペースの左端にあります [全般] メニューから [ログ] をクリックしてください。<br>[Azure Monitor for VMs] に属するテーブルを使用することで、収集されたデータを確認いただくことが可能です。</p><p><img src="/blog/LogAnalytics/Azure_Monitor_VM_insights_using_AMA/check_data.png" alt="補足"></p><h2 id="VM-insights-DCRs-とは？"><a href="#VM-insights-DCRs-とは？" class="headerlink" title="VM insights DCRs とは？"></a>VM insights DCRs とは？</h2><table><thead><tr><th>構成オプション</th><th>説明</th></tr></thead><tbody><tr><td>ゲスト パフォーマンス</td><td>ゲスト OS からパフォーマンス データを収集するか否かを指定する。<br>すべてのマシンに対して設定が必要で、パフォーマンス ビューが取得可能。</td></tr><tr><td>プロセスと依存関係</td><td>仮想マシン上で実行中のプロセスとマシン間の依存関係に関する詳細を取得する。<br>こちらを設定するかは任意であり、設定するとマシンに対して VM insights マップの機能が使用できる。<br>この機能を使用するよう設定すると、サポートされた OS に Dependency エージェントもインストールされる。</td></tr><tr><td>Log Analytics ワークスペース</td><td>データの収集先として用いる特定のワークスペース</td></tr></tbody></table><p>上記のユニークな組み合わせにより、DCR が形成されます。</p><h3 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h3><ul><li>VM insights を有効化する際にはこのドキュメントに記載した VM insights 用の DCR の使用を推奨します。既存の DCR を編集して VM insights の機能を使えるようにしようとすると、必要な拡張機能がインストールされなかったり、VM Insights による可視化のために必要なデータ ストリームが構成されない可能性があります。</li><li>Windows や Syslog event のような追加のデータを収集するために既存の VM Insights DCR を編集することは可能ですが、新たな DCR を作成してマシンを関連付けることを推奨します。</li><li>同一のイベント ID を収集するよう設定している DCR が複数個あったり、1 つの VM を複数の DCR と関連付けたりしていると、データが重複する原因となります。重複を避けるため、DCR により収集するイベントが重複しないよう注意して DCR を作成してください。</li></ul><p>既に Log Analytics エージェントにより VM insights を構成済みの場合には、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-overview#migrate-from-log-analytics-agent">移行ガイダンス</a> をご参照いただき、Azure Monitor エージェントへ移行を行ってください。<br>オンプレミスのマシンに関しましては、 Azure VM と似たプロセスで VM insights が使用できるよう、<a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/overview">Azure Arc for Server</a> を使用できる状態にすることをお勧めします。</p><p>詳細な情報については、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-overview">ドキュメント全文</a> をご確認ください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure Monitoring チームの秋田です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 8 月 4 日に米国の Azure Moniotr Blog で公開された、&lt;a href=&quot;https://techcommunity.microsoft.com/t5/azure-observability-blog/announcing-preview-enable-azure-monitor-vm-insights-using-azure/ba-p/3589423&quot;&gt;Announcing preview: Enable Azure Monitor VM insights using Azure Monitor agent&lt;/a&gt; を翻訳したものになります。&lt;br&gt;Azure Monitor エージェントを使用した Azuer Monitor VM Insights について、既存の VM insights と比べてどういうところが変わるのか、設定方法などに関して最新情報をお届けします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics エージェントから Azure Monitor エージェントへの移行に関するよくあるご質問集</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromLA/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromLA/</id>
    <published>2022-10-17T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.643Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。</p><p>Log Analytics エージェントが 2024 年 8 月に廃止することに伴い、Azure Monitor エージェントへの移行に関するお問い合わせをよくいただいております。<br>そこで、本記事では Azure Monitor エージェントへの移行に関するよくあるご質問を Q &amp; A 形式でおまとめいたしました。<br>これから Azure Monitor エージェントへ移行される方、Azure Monitor エージェントの導入をご検討されている方の一助となれば幸いです。</p><br><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><ul><li><a href="#Q1-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AF-2024-%E5%B9%B4-8-%E6%9C%88%E3%81%AB%E5%BB%83%E6%AD%A2%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8C%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%82%E5%BB%83%E6%AD%A2%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q1. Log Analytics エージェントは 2024 年 8 月に廃止されますが、Log Analytics ワークスペースも廃止されますか。</a></li><li><a href="#Q2-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%B8%E7%A7%BB%E8%A1%8C%E3%81%97%E3%81%9F%E5%BE%8C%E3%82%82%E3%80%81%E6%97%A2%E5%AD%98%E3%81%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q2. Azure Monitor エージェントへ移行した後も、既存のアラート ルールを利用することはできますか。</a></li><li><a href="#Q3-%E5%90%8C%E4%B8%80%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E4%B8%8A%E3%81%A7-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E7%A8%BC%E5%83%8D%E3%81%95%E3%81%9B%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q3. 同一のマシン上で Log Analytics エージェントと Azure Monitor エージェントを稼働させることは可能ですか。</a></li><li><a href="#Q4-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%81%AF%E3%80%81Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8%E5%90%8C%E7%AD%89%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q4. Azure Monitor エージェントでは、Log Analytics エージェントと同等の機能が提供されていますか。</a></li><li><a href="#Q5-Azure-Montior-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E4%B8%8A%E3%81%A7%E3%81%AE%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6%E3%81%A8%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B-OS-%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q5. Azure Montior エージェントを利用する上での前提条件とサポートしている OS を教えてください。</a></li><li><a href="#Q6-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E9%80%9A%E4%BF%A1%E8%A6%81%E4%BB%B6%E3%81%AF%E5%90%8C%E3%81%98%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q6. Azure Monitor エージェントと Log Analytics エージェントの通信要件は同じですか。</a></li><li><a href="#Q7-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%90%8C%E6%99%82%E3%81%AB%E7%A8%BC%E5%83%8D%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%83%AD%E3%82%B0%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q7. Log Analytics エージェントと Azure Monitor エージェントを同時に稼働しています。Azure Monitor エージェントでログが収集されていることを確認する方法を教えてください。</a></li><li><a href="#Q8-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AB-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q8. 仮想マシンに Log Analytics エージェントがインストールされています。Azure Monitor エージェントへの移行手順を教えてください。</a></li><li><a href="#Q9-%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%80%81Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%80%81%E3%83%AD%E3%82%B0%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E3%81%97%E3%81%8B%E3%81%97%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AE-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%BD%E3%83%BC%E3%82%B9-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E3%82%92%E8%A6%8B%E3%82%8B%E3%81%A8%E3%80%81%E2%80%9D%E6%8E%A5%E7%B6%9A%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E2%80%9D-%E3%81%A8%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82">Q9. データ収集ルールを作成し、Azure Monitor エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log Analytics ワークスペースの [ワークスペースのデータ ソース] - [仮想マシン] を見ると、”接続されていません” と表示されます</a></li><li><a href="#Q10-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%80%81-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%80%81%E3%81%8A%E3%82%88%E3%81%B3%E6%97%A2%E5%AD%98%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AE%E9%96%A2%E9%80%A3%E4%BB%98%E3%81%91%E3%82%92%E8%87%AA%E5%8B%95%E3%81%A7%E5%AE%9F%E6%96%BD%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q10. 仮想マシンを作成したとき、 Azure Monitor エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。</a></li><li><a href="#Q11-%E9%96%89%E3%81%98%E3%81%9F%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%8B%E3%82%89-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%B8%E3%83%AD%E3%82%B0%E3%82%92%E9%80%81%E4%BF%A1%E3%81%97%E3%81%9F%E3%81%84%E3%81%A7%E3%81%99%E3%80%82Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%81%93%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E4%BA%8B%E3%81%8C%E5%AE%9F%E7%8F%BE%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q11. 閉じたネットワーク環境でコンピューターから Log Analytics ワークスペースへログを送信したいです。Azure Monitor エージェントでこのような事が実現可能ですか。</a></li></ul><br><h3 id="Q1-Log-Analytics-エージェントは-2024-年-8-月に廃止されますが、Log-Analytics-ワークスペースも廃止されますか。"><a href="#Q1-Log-Analytics-エージェントは-2024-年-8-月に廃止されますが、Log-Analytics-ワークスペースも廃止されますか。" class="headerlink" title="Q1. Log Analytics エージェントは 2024 年 8 月に廃止されますが、Log Analytics ワークスペースも廃止されますか。"></a>Q1. Log Analytics エージェントは 2024 年 8 月に廃止されますが、Log Analytics ワークスペースも廃止されますか。</h3><p>いいえ、Log Analytics エージェントは廃止されますが、Log Analytics ワークスペースは廃止されません。</p><br><h3 id="Q2-Azure-Monitor-エージェントへ移行した後も、既存のアラート-ルールを利用することはできますか。"><a href="#Q2-Azure-Monitor-エージェントへ移行した後も、既存のアラート-ルールを利用することはできますか。" class="headerlink" title="Q2. Azure Monitor エージェントへ移行した後も、既存のアラート ルールを利用することはできますか。"></a>Q2. Azure Monitor エージェントへ移行した後も、既存のアラート ルールを利用することはできますか。</h3><p>はい、Azure Monitor エージェントへ移行した後も既存のアラート ルールをご利用いただけます。<br>ログ収集先の Log Analytics ワークスペースを変更する場合はアラート ルールの再作成が必要ですが、<br>同一のワークスペースへログを収集する場合はそのままご利用いただけます。</p><br><h3 id="Q3-同一のマシン上で-Log-Analytics-エージェントと-Azure-Monitor-エージェントを稼働させることは可能ですか。"><a href="#Q3-同一のマシン上で-Log-Analytics-エージェントと-Azure-Monitor-エージェントを稼働させることは可能ですか。" class="headerlink" title="Q3. 同一のマシン上で Log Analytics エージェントと Azure Monitor エージェントを稼働させることは可能ですか。"></a>Q3. 同一のマシン上で Log Analytics エージェントと Azure Monitor エージェントを稼働させることは可能ですか。</h3><p>はい、可能です。<br>ただし、データが重複して収集される可能性もございますので、その点ご留意ください。<br>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration#migration-plan-considerations">Log Analytics エージェントから Azure Monitor エージェントへの移行</a> の [移行計画に関する考慮事項] をご覧ください。</p><br><h3 id="Q4-Azure-Monitor-エージェントでは、Log-Analytics-エージェントと同等の機能が提供されていますか。"><a href="#Q4-Azure-Monitor-エージェントでは、Log-Analytics-エージェントと同等の機能が提供されていますか。" class="headerlink" title="Q4. Azure Monitor エージェントでは、Log Analytics エージェントと同等の機能が提供されていますか。"></a>Q4. Azure Monitor エージェントでは、Log Analytics エージェントと同等の機能が提供されていますか。</h3><p>いいえ、現時点では Log Analytics エージェントの全ての機能を Azure Monitor エージェントで提供しておりません。<br>最終的には、Azure Monitor エージェントは Log Analytics エージェント、Azure Diagnostics 拡張機能、および Telegraf エージェントの機能を提供する予定でございます。<br>Azure Monitor エージェントと Log Analytics エージェントにおける機能の違いにつきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#compare-to-legacy-agents">Azure Monitor エージェントの概要</a> の [レガシ エージェントとの比較] をご覧ください。</p><br><h3 id="Q5-Azure-Montior-エージェントを利用する上での前提条件とサポートしている-OS-を教えてください。"><a href="#Q5-Azure-Montior-エージェントを利用する上での前提条件とサポートしている-OS-を教えてください。" class="headerlink" title="Q5. Azure Montior エージェントを利用する上での前提条件とサポートしている OS を教えてください。"></a>Q5. Azure Montior エージェントを利用する上での前提条件とサポートしている OS を教えてください。</h3><p>Azure Montior エージェントをご利用する上での前提条件は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=ARMAgentPowerShell,PowerShellWindows,PowerShellWindowsArc,CLIWindows,CLIWindowsArc#prerequisites">Azure Monitor エージェントを管理する</a> の [前提条件] をご覧ください。<br>また、当該エージェントがサポートしている OS は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#supported-operating-systems">Azure Monitor エージェントの概要</a> の [サポートされるオペレーティング システム] の表に記載されている OS かつ、対象列に “X” と記載されているものでございます。</p><br><h3 id="Q6-Azure-Monitor-エージェントと-Log-Analytics-エージェントの通信要件は同じですか。"><a href="#Q6-Azure-Monitor-エージェントと-Log-Analytics-エージェントの通信要件は同じですか。" class="headerlink" title="Q6. Azure Monitor エージェントと Log Analytics エージェントの通信要件は同じですか。"></a>Q6. Azure Monitor エージェントと Log Analytics エージェントの通信要件は同じですか。</h3><p>いいえ、Log Analytics エージェントの通信要件と Azure Monitor エージェントの通信要件は異なります。<br>Azure Monitor エージェントからワークスペースへデータを送信するには、下記 URL に対して TCP 443 ポートへのアクセスが確保されている必要がございます。</p><ul><li>global.handler.control.monitor.azure.com </li><li>&lt;virtual-machine-region-name&gt;.handler.control.monitor.azure.com (例: japaneast.handler.control.azure.com)</li><li>&lt;log-analytics-workspace-id&gt;.ods.opinsights.azure.com (例: 12345a01-b1cd-1234-e1f2-1234567g8h99.ods.opsinsights.azure.com)</li></ul><p>また、NSG を利用する場合には、AzureMonitor と AzureResourceManager のサービス タグに対して、送信方向にアクセスを許可していただく必要がございます。詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows">Azure Monitor エージェントのネットワーク設定を定義する</a> をご覧ください。</p><p>一方で、カスタム ログを収集する場合や <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> を用いて閉域網にてログを収集する場合、データ収集エンドポイント (DCE) を別途ご構築いただく必要がございます。<br>その場合、DCE をご利用いただくための通信要件を別途考慮いただく必要がございます。<br>DCE をご利用いただく場合は、下記 URL に対して TCP 443 ポートへのアクセスが確保されている必要がある点について、予めご留意ください。</p><ul><li>&lt;unique-dce-identifier&gt;.&lt;regionname&gt;.handler.control.monitor.azure.com</li><li>&lt;unique-dce-identifier&gt;.&lt;regionname&gt;.ingest.monitor.azure.com</li></ul><p>DCE に関する通信要件につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal#components-of-a-data-collection-endpoint">データ収集エンドポイントのコンポーネント</a> をご確認ください。</p><br><h3 id="Q7-Log-Analytics-エージェントと-Azure-Monitor-エージェントを同時に稼働しています。Azure-Monitor-エージェントでログが収集されていることを確認する方法を教えてください。"><a href="#Q7-Log-Analytics-エージェントと-Azure-Monitor-エージェントを同時に稼働しています。Azure-Monitor-エージェントでログが収集されていることを確認する方法を教えてください。" class="headerlink" title="Q7. Log Analytics エージェントと Azure Monitor エージェントを同時に稼働しています。Azure Monitor エージェントでログが収集されていることを確認する方法を教えてください。"></a>Q7. Log Analytics エージェントと Azure Monitor エージェントを同時に稼働しています。Azure Monitor エージェントでログが収集されていることを確認する方法を教えてください。</h3><p>対象のワークスペースで下記クエリを実行してください。<br>データ収集ルールを作成し、Azure Monitor エージェントがインストールされますと、Heartbeat が既定で収集されます。<br>Azure Monitor エージェントで収集される Heartbeat の Category は “Azure Monitor Agent” です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| where Computer == &#x27;computer-name&#x27;</span><br><span class="line">| where Category == &#x27;Azure Monitor Agent&#x27;</span><br></pre></td></tr></table></figure><br><h3 id="Q8-仮想マシンに-Log-Analytics-エージェントがインストールされています。Azure-Monitor-エージェントへの移行手順を教えてください。"><a href="#Q8-仮想マシンに-Log-Analytics-エージェントがインストールされています。Azure-Monitor-エージェントへの移行手順を教えてください。" class="headerlink" title="Q8. 仮想マシンに Log Analytics エージェントがインストールされています。Azure Monitor エージェントへの移行手順を教えてください。"></a>Q8. 仮想マシンに Log Analytics エージェントがインストールされています。Azure Monitor エージェントへの移行手順を教えてください。</h3><p>移行の一例を示します。<br>以下例では、Azure Monitor エージェントでログが収集されていることを確認し、Log Analytics エージェントをアンインストールしています。移行手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration#migration-testing">Log Analytics エージェントから Azure Monitor エージェントへの移行</a> もあわせてご覧ください。</p><ol><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-rule-overview#create-a-data-collection-rule">データ収集ルールを作成し</a>、Azure Monitor エージェントをインストールする</li><li>Azure Monitor エージェントで任意のログが収集できていることを確認する</li><li>Log Analytics エージェントのアンインストール</li></ol><div class="alert is-warning"><p class="alert-title">警告</p><p>上記手順は、Log Analytics エージェント以外のエージェント (Dependency エージェント) や他製品で Log Analytics エージェントを使用していない場合の手順でございます。Microsoft Defender for Cloud や Microsoft Sentinel 等、他製品で Log Analytics エージェントを利用されている場合は、移行前に <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#supported-services-and-features">Azure Monitor エージェントでサポートされているサービスと機能</a> で対象製品が Azure Monitor エージェントに対応していることをご確認ください。また、Dependency エージェントをご利用されている場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-overview">VM insights の有効化の概要</a> や、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-portal">Azure portal で VM insights を有効にする</a> をご確認いただき、移行を実施してください。</p></div><br><h3 id="Q9-データ収集ルールを作成し、Azure-Monitor-エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log-Analytics-ワークスペースの-ワークスペースのデータ-ソース-仮想マシン-を見ると、”接続されていません”-と表示されます。"><a href="#Q9-データ収集ルールを作成し、Azure-Monitor-エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log-Analytics-ワークスペースの-ワークスペースのデータ-ソース-仮想マシン-を見ると、”接続されていません”-と表示されます。" class="headerlink" title="Q9. データ収集ルールを作成し、Azure Monitor エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log Analytics ワークスペースの [ワークスペースのデータ ソース] - [仮想マシン] を見ると、”接続されていません” と表示されます。"></a>Q9. データ収集ルールを作成し、Azure Monitor エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log Analytics ワークスペースの [ワークスペースのデータ ソース] - [仮想マシン] を見ると、”接続されていません” と表示されます。</h3><p>Log Analytics ワークスペースの [ワークスペースのデータ ソース] - [仮想マシン] に表示される “Log Analytics 接続状況” は、<br>Log Analytics エージェントがワークスペースに接続されていることを意味します。<br>Azure Monitor エージェントが対象のワークスペースと接続している状況であることを意味するものではございません。</p><br><h3 id="Q10-仮想マシンを作成したとき、-Azure-Monitor-エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。"><a href="#Q10-仮想マシンを作成したとき、-Azure-Monitor-エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。" class="headerlink" title="Q10. 仮想マシンを作成したとき、 Azure Monitor エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。"></a>Q10. 仮想マシンを作成したとき、 Azure Monitor エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。</h3><p>はい、Azure Policy の機能を利用することで実現できます。<br>設定手順につきましては、弊社サポート ブログ <a href="https://jpazmon-integ.github.io/blog/LogAnalytics/automatically_install_ama/">仮想マシン作成時に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けを自動で行う方法</a> をご覧ください。</p><br><h3 id="Q11-閉じたネットワーク環境でコンピューターから-Log-Analytics-ワークスペースへログを送信したいです。Azure-Monitor-エージェントでこのような事が実現可能ですか。"><a href="#Q11-閉じたネットワーク環境でコンピューターから-Log-Analytics-ワークスペースへログを送信したいです。Azure-Monitor-エージェントでこのような事が実現可能ですか。" class="headerlink" title="Q11. 閉じたネットワーク環境でコンピューターから Log Analytics ワークスペースへログを送信したいです。Azure Monitor エージェントでこのような事が実現可能ですか。"></a>Q11. 閉じたネットワーク環境でコンピューターから Log Analytics ワークスペースへログを送信したいです。Azure Monitor エージェントでこのような事が実現可能ですか。</h3><p>はい、Log Analytics エージェントと同様に、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> をご利用いただくことで実現可能です。<br>AMPLS 環境下で Azure Monitor エージェントを用いてログを Log Analytics ワークスペースへ送信するためには、別途データ収集エンドポイント (DCE) のご構築が必要となります。<br>AMPLS を用いたログの収集方法につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows#enable-network-isolation-for-the-azure-monitor-agent">Azure Monitor エージェントのネットワークの分離を有効にする</a> の公開情報をご参考ください。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;/p&gt;
&lt;p&gt;Log Analytics エージェントが 2024 年 8 月に廃止することに伴い、Azure Monitor エージェントへの移行に関するお問い合わせをよくいただいております。&lt;br&gt;そこで、本記事では Azure Monitor エージェントへの移行に関するよくあるご質問を Q &amp;amp; A 形式でおまとめいたしました。&lt;br&gt;これから Azure Monitor エージェントへ移行される方、Azure Monitor エージェントの導入をご検討されている方の一助となれば幸いです。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="移行" scheme="https://jpazmon-integ.github.io/blog/tags/%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>Azure Automation で VM を起動・停止する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/automation/HowtoStartOrStopVMsbyAutomation/"/>
    <id>https://jpazmon-integ.github.io/blog/automation/HowtoStartOrStopVMsbyAutomation/</id>
    <published>2022-10-13T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.739Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure Monitoring サポート チームの趙です。<br>今回は、VM を起動・停止する方法をご案内させていただきます。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#vm-%E8%B5%B7%E5%8B%95%E5%81%9C%E6%AD%A2%E5%87%A6%E7%90%86%E3%82%92%E7%90%86%E8%A7%A3%E3%81%97%E3%81%BE%E3%81%97%E3%82%87%E3%81%86">VM 起動・停止処理を理解しましょう</a></li><li><a href="#%E3%81%AA%E3%81%9C-azure-automation-%E3%82%92%E4%BD%BF%E3%81%86%E3%81%8B">なぜ Azure Automation を使うか</a></li><li><a href="#vm-%E3%82%92%E8%B5%B7%E5%8B%95%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">VM を起動・停止するソリューション</a><ul><li><a href="#1startstop-vms-during-off-hours-%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3-v1-%E9%9D%9E%E6%8E%A8%E5%A5%A8">1.Start/Stop VMs during off-hours ソリューション (v1) (非推奨)</a></li><li><a href="#2startstop-vms-v2-%E6%8E%A8%E5%A5%A8">2.Start/Stop VMs v2 (推奨)</a></li><li><a href="#3start-azure-v2-vms--stop-azure-v2-vms-%E9%9D%9E%E6%8E%A8%E5%A5%A8">3.Start Azure V2 VMs / Stop Azure V2 VMs (非推奨)</a></li></ul></li><li><a href="#vm-%E3%82%92%E8%B5%B7%E5%8B%95%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B-runbook-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB">VM を起動・停止する Runbook サンプル</a><ul><li><a href="#%E5%85%8D%E8%B2%AC%E4%BA%8B%E9%A0%85">免責事項</a></li><li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-runbook--%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97vm-%E3%82%92%E8%B5%B7%E5%8B%95%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B-runbook">サンプル Runbook : システム割り当てマネージド ID を利用し、VM を起動・停止する Runbook</a></li><li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-runbook-%E3%81%AE%E8%A7%A3%E8%AA%AC">サンプル Runbook の解説</a><ul><li><a href="#azure-%E3%81%B8%E8%AA%8D%E8%A8%BC%E3%81%99%E3%82%8B%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89">Azure へ認証するコマンド</a></li><li><a href="#vm-%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89">VM を起動するコマンド</a></li><li><a href="#vm-%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89">VM を停止するコマンド</a></li></ul></li><li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-runbook-%E3%81%AE%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95">サンプル Runbook の利用方法</a><ul><li><a href="#1automation-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">1.Automation アカウントを作成する</a></li><li><a href="#2automation-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%82%92%E6%A7%8B%E6%88%90%E3%81%99%E3%82%8B">2.Automation アカウントにシステム割り当てマネージド ID を構成する</a></li><li><a href="#3%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B">3.必要なモジュールをインポートする</a></li><li><a href="#4%E5%AF%BE%E8%B1%A1-runbook-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">4.対象 Runbook を作成する</a></li><li><a href="#5%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">5.スケジュールを設定する</a></li><li><a href="#6%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">6.動作確認する</a><ul><li><a href="#runbook-%E6%89%8B%E5%8B%95%E5%AE%9F%E8%A1%8C%E3%81%A7%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D">Runbook 手動実行での動作確認</a></li><li><a href="#%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D">スケジュールの動作確認</a></li></ul></li></ul></li><li><a href="#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">トラブルシューティング</a><ul><li><a href="#%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AB%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%8C%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%89%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3">マネージド ID にロールが割り当てられていないパターン</a></li><li><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%8C%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3">必要なモジュールがインポートされていないパターン</a></li></ul></li></ul></li></ul><h2 id="VM-起動・停止処理を理解しましょう"><a href="#VM-起動・停止処理を理解しましょう" class="headerlink" title="VM 起動・停止処理を理解しましょう"></a>VM 起動・停止処理を理解しましょう</h2><p>みなさんは普段 VM を起動・停止する際には、どのような方法で、VM を起動・停止していますか？</p><p>最も一般的な方法は、<a href="https://jpaztech.github.io/blog/vm/vm-operation/">Azure ポータルから、[開始] ボタン、[停止] ボタンをクリックし、VM を起動・停止する方法</a>ですね。<br>あるいは、PowerShell コマンド <a href="https://learn.microsoft.com/en-us/powershell/module/az.compute/start-azvm?view=azps-8.2.0">Start-AzVM</a> 、<a href="https://learn.microsoft.com/en-us/powershell/module/az.compute/stop-azvm?view=azps-8.2.0">Stop-AzVM</a> を実行し、VM を起動・停止されている方もいると思います。</p><p>VM の電源状態の詳細については、<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/states-billing">こちらの公開情報</a>もご参考いただければ幸いです。</p><p>Azure Automation では、Runbook というものを使って、VM を起動・停止できます。</p><p>Runbook は、簡単に申しますと、Azure 上で実行できるスクリプトです。<br>Runbook の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/automation/automation-runbook-execution">Azure Automation での Runbook の実行</a> と<a href="https://learn.microsoft.com/ja-JP/azure/automation/automation-runbook-types">Azure Automation の Runbook の種類</a>をご参考いただければ幸いです。</p><h2 id="なぜ-Azure-Automation-を使うか"><a href="#なぜ-Azure-Automation-を使うか" class="headerlink" title="なぜ Azure Automation を使うか"></a>なぜ Azure Automation を使うか</h2><p>Automation は、スクリプトを定期的に実行できるサービスです。</p><p>VM 起動・停止を毎日、ポータルから [開始] ボタン、[停止] ボタンを押して、管理することは現実的に難しいと思います。<br>Azure Automation をご利用いただくことで、VM の起動・停止処理をスケジュールで起動・停止する (自動化する) ことが可能です。Azure Automation では、スケジュールという機能があり、スケジュールに設定した時間に Runbook (スクリプト) を実行できます。</p><h2 id="VM-を起動・停止するソリューション"><a href="#VM-を起動・停止するソリューション" class="headerlink" title="VM を起動・停止するソリューション"></a>VM を起動・停止するソリューション</h2><h3 id="1-Start-Stop-VMs-during-off-hours-ソリューション-v1-非推奨"><a href="#1-Start-Stop-VMs-during-off-hours-ソリューション-v1-非推奨" class="headerlink" title="1.Start/Stop VMs during off-hours ソリューション (v1) (非推奨)"></a>1.Start/Stop VMs during off-hours ソリューション (v1) (非推奨)</h3><p>Azure Automation では、以前は、<a href="https://learn.microsoft.com/ja-jp/azure/automation/automation-solution-vm-management">Start/Stop VMs during off-hours ソリューション (v1)</a> を提供しておりましたが、現時点では、非推奨の機能です。<br>なお、認証手段としては、実行アカウントが利用されていたソリューションです。 </p><p>また、Start/Stop VMs during off-hours ソリューション (v1) は、非推奨のソリューションであるため、現時点では Start/Stop VMs during off-hours ソリューション (v1) をデプロイすることはできません。<br>Start/Stop VMs during off-hours ソリューション (v1) をご検討いただいた方は、後述する Start/Stop VMs v2 のご利用をご検討いただければ幸いです。</p><h3 id="2-Start-Stop-VMs-v2-推奨"><a href="#2-Start-Stop-VMs-v2-推奨" class="headerlink" title="2.Start/Stop VMs v2 (推奨)"></a>2.Start/Stop VMs v2 (推奨)</h3><p>Start/Stop VMs during off-hours ソリューション (v1) とは別の <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/start-stop-vms/overview">Start/Stop VMs v2</a> というソリューションがございます。<br>Start/Stop VMs v2 ソリューションは、現在、一般公開 (GA) されている機能であり、弊社にて推奨する VM 起動・停止ソリューションです。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>Start/Stop VMs v2 ソリューションでは、<a href="https://learn.microsoft.com/ja-JP/azure/automation/overview">Azure Automation</a> は利用されません。</p><p><a href="https://learn.microsoft.com/ja-JP/azure/azure-functions/functions-overview">Azure Functions</a> 及び <a href="https://learn.microsoft.com/ja-JP/azure/logic-apps/logic-apps-overview">Logic Apps</a>が利用されます。 </p></div><p>また、認証手段としては、マネージド ID が利用されます。</p><p>Start/Stop VMs v2 ソリューションをデプロイすることで VM を起動・停止する Azure Functions 及び Logic Apps が自動的にデプロイできます。<br>このソリューションを利用することで、VM をスケジュールで起動・停止することが可能です。</p><h3 id="3-Start-Azure-V2-VMs-Stop-Azure-V2-VMs-非推奨"><a href="#3-Start-Azure-V2-VMs-Stop-Azure-V2-VMs-非推奨" class="headerlink" title="3.Start Azure V2 VMs / Stop Azure V2 VMs (非推奨)"></a>3.Start Azure V2 VMs / Stop Azure V2 VMs (非推奨)</h3><p>Runbook ギャラリーから入手できる “Start Azure V2 VMs” Runbook 、あるいは、”Stop Azure V2 VMs” Runbook をご利用されている方もいると存じます。</p><p><img src="/blog/automation/HowtoStartOrStopVMsbyAutomation/HowtoStartOrStopVMsbyAutomation_graphicalrunbook.png"><br><img src="/blog/automation/HowtoStartOrStopVMsbyAutomation/HowtoStartOrStopVMsbyAutomation_graphicalrunbook2.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>各 Runbook は、マイクロソフトではなく各所有者によるライセンス契約に従ってライセンスが付与されます。コミュニティ メンバーが提供し、ライセンスを付与した Runbook について、マイクロソフトはいかなる責任も負いません。また、マイクロソフトは、そのような Runbook のセキュリティ、互換性、パフォーマンスについて、いかなる審査も実施していません。ここで言及した類の Runbook は、マイクロソフトのサポート プログラムまたはサポート サービスの対象外です。そのような Runbook は現状有姿のまま提供され、いかなる種類の保証も適用されません。</p></div><p>この Runbook は、あくまでもチュートリアル用の Runbook であり、非推奨の Runbook です。<br>以下は推奨しない理由です。<br>非推奨の AzureRM モジュールのコマンドを利用している Runbook であるためです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>弊社としては、Az モジュールのコマンドを推奨します。</p><p>詳細については、<a href="https://learn.microsoft.com/ja-JP/azure/automation/shared-resources/modules#migrate-to-az-modules">Az モジュールへの移行</a>をご参考いただければ幸いです。</p></div><p>なお、<a href="https://github.com/azureautomation/start-azure-v2-vms">2016 年以降、修正・アップデートがされていない</a> Runbook であるためです。<br>また、<a href="https://jpazmon-integ.github.io/blog/automation/ThePipelineWasNotRunBecauseAPipelineIsAlreadyRunningError/">“The pipeline was not run because a pipeline is already running” エラー発生時の対処方法</a> 記事のように、既知のエラーが発生する Runbook です。</p><p>そのため、運用にて VM の起動・停止ソリューションのご利用をご検討されている方、あるいは、既にご利用されている方は、Start Azure V2 VMs / Stop Azure V2 VMs Runbook (上記グラフィカル Runbook) ではなく、弊社にて推奨する <a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/start-stop-vms/overview">Start/Stop VMs v2</a> ソリューション (Azure Functions 及び Logic Apps の機能) のご利用をご検討いただければ幸いです。</p><h2 id="VM-を起動・停止する-Runbook-サンプル"><a href="#VM-を起動・停止する-Runbook-サンプル" class="headerlink" title="VM を起動・停止する Runbook サンプル"></a>VM を起動・停止する Runbook サンプル</h2><p>上記にて紹介いたしましたソリューションとは別で、お客様にてカスタムで Runbook を作成し、Azure Automation を利用し、VM を起動・停止することも可能です。</p><p>カスタムで Runbook を作成する基本的なガイドラインは、<a href="https://learn.microsoft.com/ja-jp/azure/automation/learn/powershell-runbook-managed-identity">チュートリアル: マネージド ID を使用して Automation PowerShell Runbook を作成する</a> や、<a href="https://docs.microsoft.com/ja-JP/azure/automation/automation-edit-textual-runbook">Azure Automation でのテキスト形式の Runbook の編集</a>をご参考いただければ幸いです。</p><p>なお、以下に一例として、VM を起動・停止するサンプル Runbook を参考情報としてご案内させていただきます。<br>こちらのサンプルについては、お客様のご要件に応じて、適宜、カスタマイズいただければ幸いです。<br>以下免責事項をご確認いただいたうえで、サンプルをご活用いただければ幸いです。</p><h3 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h3><ul><li>弊社サポートにて、お客様のご要件のサンプルを作成・編集し、提供することは、サポートしておりません。</li><li> こちらの Runbook をご利用いただき、スクリプトの修正、スクリプトの追記等が必要な際には、お客様のご要件に応じて、お客様にて直接修正・動作確認いただく必要がございます。そのため、大変恐れ入りますが、スクリプトの修正、スクリプトの追記等をお問い合わせいただいても、ご要望を承ることができない点、予めご理解いただければ幸いです。</li><li>弊社として推奨する VM 起動・停止ソリューションは、現在、一般公開 (GA) されている  <a href="https://learn.microsoft.com/ja-jp/azure/automation/automation-solution-vm-management">Start/Stop VMs v2</a> ソリューションです。</li><li>こちらのサンプルは、あくまでも VM 起動・停止のコマンドの説明用のサンプルとなります。</li></ul><h3 id="サンプル-Runbook-システム割り当てマネージド-ID-を利用し、VM-を起動・停止する-Runbook"><a href="#サンプル-Runbook-システム割り当てマネージド-ID-を利用し、VM-を起動・停止する-Runbook" class="headerlink" title="サンプル Runbook : システム割り当てマネージド ID を利用し、VM を起動・停止する Runbook"></a>サンプル Runbook : システム割り当てマネージド ID を利用し、VM を起動・停止する Runbook</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">param</span>(</span><br><span class="line">[<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,<span class="type">HelpMessage</span>=<span class="string">&quot;Enter the value for Action. Values can be either start or stop&quot;</span>)][<span class="built_in">String</span>]<span class="variable">$Action</span> = <span class="variable">$</span>(<span class="keyword">throw</span> <span class="string">&quot;Value for Action is missing&quot;</span>),</span><br><span class="line">[<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,<span class="type">HelpMessage</span>=<span class="string">&quot;Enter the value for VMName.&quot;</span>)][<span class="built_in">String</span>]<span class="variable">$VMName</span> = <span class="variable">$</span>(<span class="keyword">throw</span> <span class="string">&quot;Value for VMName is missing&quot;</span>),</span><br><span class="line">[<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,<span class="type">HelpMessage</span>=<span class="string">&quot;Enter the ResourceGroupName.&quot;</span>)][<span class="built_in">String</span>]<span class="variable">$ResourceGroupName</span> = <span class="variable">$</span>(<span class="keyword">throw</span> <span class="string">&quot;Value for ResourceGroupName is missing&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">[<span class="built_in">string</span>] <span class="variable">$FailureMessage</span> = <span class="string">&quot;Failed to execute the command&quot;</span></span><br><span class="line">[<span class="built_in">int</span>] <span class="variable">$RetryCount</span> = <span class="number">3</span> </span><br><span class="line">[<span class="built_in">int</span>] <span class="variable">$TimeoutInSecs</span> = <span class="number">20</span></span><br><span class="line"><span class="variable">$RetryFlag</span> = <span class="variable">$true</span></span><br><span class="line"><span class="variable">$Attempt</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">#----------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">#---------------------LOGIN TO AZURE AND SELECT THE SUBSCRIPTION-------------------</span></span><br><span class="line">    <span class="comment">#----------------------------------------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">&quot;Logging into Azure subscription using Az cmdlets...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Ensures you do not inherit an AzContext in your runbook</span></span><br><span class="line">        <span class="built_in">Disable-AzContextAutosave</span> <span class="literal">-Scope</span> <span class="keyword">Process</span></span><br><span class="line">        <span class="comment"># Connect to Azure with system-assigned managed identity</span></span><br><span class="line">        <span class="variable">$AzureContext</span> = (<span class="built_in">Connect-AzAccount</span> <span class="literal">-Identity</span>).context</span><br><span class="line">        <span class="comment"># set and store context</span></span><br><span class="line">        <span class="variable">$AzureContext</span> = <span class="built_in">Set-AzContext</span> <span class="literal">-SubscriptionName</span> <span class="variable">$AzureContext</span>.Subscription <span class="literal">-DefaultProfile</span> <span class="variable">$AzureContext</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">Write-Output</span> <span class="string">&quot;Successfully logged into Azure subscription using Az cmdlets...&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">Write-Output</span> <span class="string">&quot;VM action is : <span class="variable">$</span>(<span class="variable">$Action</span>)&quot;</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$Action</span>.Trim().ToLower() <span class="operator">-eq</span> <span class="string">&quot;stop&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="string">&quot;Stopping the VM : <span class="variable">$</span>(<span class="variable">$VMName</span>) in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="variable">$Status</span> = <span class="built_in">Stop-AzVM</span> <span class="literal">-Name</span> <span class="variable">$VMName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroupName</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$Status</span> <span class="operator">-eq</span> <span class="variable">$null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">Write-Output</span> <span class="string">&quot;Error occured while stopping the Virtual Machine <span class="variable">$</span>(<span class="variable">$VMName</span>) in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="string">&quot;Successfully stopped the VM <span class="variable">$VMName</span> in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>) in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(<span class="variable">$Action</span>.Trim().ToLower() <span class="operator">-eq</span> <span class="string">&quot;start&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="string">&quot;Starting the VM : <span class="variable">$</span>(<span class="variable">$VMName</span>) in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="variable">$Status</span> = <span class="built_in">Start-AzVM</span> <span class="literal">-Name</span> <span class="variable">$VMName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroupName</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$Status</span> <span class="operator">-eq</span> <span class="variable">$null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">Write-Output</span> <span class="string">&quot;Error occured while starting the Virtual Machine <span class="variable">$</span>(<span class="variable">$VMName</span>) in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">Write-Output</span> <span class="string">&quot;Successfully started the VM <span class="variable">$</span>(<span class="variable">$VMName</span>) in Resource Grpup <span class="variable">$</span>(<span class="variable">$ResourceGroupName</span>)&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$RetryFlag</span> = <span class="variable">$false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$Attempt</span> <span class="operator">-gt</span> <span class="variable">$RetryCount</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="string">&quot;<span class="variable">$FailureMessage</span>! Total retry attempts: <span class="variable">$RetryCount</span>&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="string">&quot;[Error Message] <span class="variable">$</span>(<span class="variable">$_</span>.exception.message) `n&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="variable">$RetryFlag</span> = <span class="variable">$false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Write-Output</span> <span class="string">&quot;[<span class="variable">$Attempt</span>/<span class="variable">$RetryCount</span>] <span class="variable">$FailureMessage</span>. Retrying in <span class="variable">$TimeoutInSecs</span> seconds...&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="variable">$TimeoutInSecs</span></span><br><span class="line"></span><br><span class="line">            <span class="variable">$Attempt</span> = <span class="variable">$Attempt</span> + <span class="number">1</span></span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$RetryFlag</span>)</span><br></pre></td></tr></table></figure><h3 id="サンプル-Runbook-の解説"><a href="#サンプル-Runbook-の解説" class="headerlink" title="サンプル Runbook の解説"></a>サンプル Runbook の解説</h3><p>上記サンプル Runbook は、主に以下 3 つのコマンドを利用し、VM を起動・停止します。</p><h4 id="Azure-へ認証するコマンド"><a href="#Azure-へ認証するコマンド" class="headerlink" title="Azure へ認証するコマンド"></a>Azure へ認証するコマンド</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Connect-AzAccount</span> <span class="literal">-Identity</span></span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/azure/automation/enable-managed-identity-for-automation">システム割り当てマネージド ID</a> を利用するコマンドです。<br>Automation では、このコマンドを利用し、操作対象の Azure リソースへ認証します。<br>システム割り当てマネージド ID ではなく、ユーザー割当マネージド ID をご利用いただくことも可能です。<br>ユーザー割り当てマネージド ID をご希望される場合は、<a href="https://learn.microsoft.com/ja-jp/azure/automation/add-user-assigned-identity">Azure Automation アカウントのユーザー割り当てマネージド ID を使用する</a> をご参考いただければ幸いです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>マネージド ID は、2 種類あります。システム割り当てマネージド ID と、ユーザー割り当てマネージド ID があります。</p><p>システム割り当てマネージド ID を使えばいいか、ユーザー割り当てマネージド ID を使えばいいかとのお問い合わせをされている方もいます。</p><p>弊社としては、特にこのマネージド ID を使ってくださいとの推奨はございません。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/managed-identities-azure-resources/managed-identity-best-practice-recommendations">マネージド ID のベスト プラクティスに関する推奨事項</a> をご参考いただき、お客様のご要件に合うマネージド ID をご利用いただければ幸いです。</p></div><h4 id="VM-を起動するコマンド"><a href="#VM-を起動するコマンド" class="headerlink" title="VM を起動するコマンド"></a>VM を起動するコマンド</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-AzVM</span> <span class="literal">-Name</span> <span class="variable">$VMName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroupName</span></span><br></pre></td></tr></table></figure><p>VM を起動するコマンドです。<br>Runbook の入力パラメーターで設定する VM 名と VM 名のリソース グループ名がこのコマンドに利用されます。</p><h4 id="VM-を停止するコマンド"><a href="#VM-を停止するコマンド" class="headerlink" title="VM を停止するコマンド"></a>VM を停止するコマンド</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Stop-AzVM</span> <span class="literal">-Name</span> <span class="variable">$VMName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroupName</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure><p>VM を停止するコマンドです。<br>Runbook の入力パラメーターで設定する VM 名と VM 名のリソース グループ名がこのコマンドに利用されます。<br>VM を起動するコマンドとは、-Force オプションを付けている箇所が相違点ですね。<br>通常、-Force オプションなしで、Stop-AzVM を実行すると、”本当に VM を停止しますか” とユーザーの入力が求められます。<br>Automation では、このような対話型コマンドはサポートされません。<br>-Force オプションを付けることによって、ユーザーの入力を必要とせず、サイレントで処理を実行することが可能です。<br>そのため、Automation の Runbook で、Stop-AzVM を実行する場合は、明示的に -Force オプションを付けております。</p><h3 id="サンプル-Runbook-の利用方法"><a href="#サンプル-Runbook-の利用方法" class="headerlink" title="サンプル Runbook の利用方法"></a>サンプル Runbook の利用方法</h3><h4 id="1-Automation-アカウントを作成する"><a href="#1-Automation-アカウントを作成する" class="headerlink" title="1.Automation アカウントを作成する"></a>1.Automation アカウントを作成する</h4><p>ご利用いただいている環境に、Automation アカウントがない場合、<a href="https://learn.microsoft.com/ja-jp/azure/automation/automation-create-standalone-account?tabs=azureportal">スタンドアロン Azure Automation アカウントを作成する</a>をご参考いただき、Automation アカウントを作成いただければ幸いです。</p><h4 id="2-Automation-アカウントにシステム割り当てマネージド-ID-を構成する"><a href="#2-Automation-アカウントにシステム割り当てマネージド-ID-を構成する" class="headerlink" title="2.Automation アカウントにシステム割り当てマネージド ID を構成する"></a>2.Automation アカウントにシステム割り当てマネージド ID を構成する</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/automation/enable-managed-identity-for-automation">Azure Automation アカウントのシステム割り当てマネージド ID を使用する</a>をご参考いただき、Automation アカウントにシステム割り当てマネージド ID を構成いただければ幸いです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>現時点では、新規 Automation アカウントを作成すると、自動的にシステム割り当てマネージド ID が作成されます。そのため、新規 Automation アカウントを作成した場合は、別途、システム割り当てマネージド ID を作成する必要はございません。</p><p>一方で、システム割り当てマネージド ID へのロールの割り当ては何もされていない状態でシステム割り当てマネージド ID が作成されます。</p><p>そのため、現時点で、新規 Automation アカウントを作成された方は、<a href="https://learn.microsoft.com/ja-jp/azure/automation/enable-managed-identity-for-automation">Azure Automation アカウントのシステム割り当てマネージド ID を使用する</a>をご参考いただき、必要なロールを割り当てていただければ幸いです。</p></div><h4 id="3-必要なモジュールをインポートする"><a href="#3-必要なモジュールをインポートする" class="headerlink" title="3.必要なモジュールをインポートする"></a>3.必要なモジュールをインポートする</h4><p>今回の Runbook にて利用されるコマンドは主に以下 3 つです。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Connect-AzAccount</span> <span class="literal">-Identity</span></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Start-AzVM</span> <span class="literal">-Name</span> <span class="variable">$VMName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroupName</span></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Stop-AzVM</span> <span class="literal">-Name</span> <span class="variable">$VMName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroupName</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure><p>Runbook にて、それぞれのコマンドを実行するには Automation アカウントに対象コマンドのモジュールがインポートされている必要があります。<br>それぞれのコマンドで必要なモジュールは以下です。</p><ul><li><a href="https://learn.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount?view=azps-8.3.0">Connect-AzAccount</a> の場合、Az.Accounts が必要です。</li><li><a href="https://learn.microsoft.com/en-us/powershell/module/az.compute/start-azvm?view=azps-8.3.0">Start-AzVM</a> の場合、Az.Compute が必要です。</li><li><a href="https://learn.microsoft.com/en-us/powershell/module/az.compute/stop-azvm?view=azps-8.3.0">Stop-AzVM</a> の場合、Az.Compute が必要です。</li></ul><p><a href="https://learn.microsoft.com/ja-JP/azure/automation/shared-resources/modules#import-modules:~:text=PowerShell%20%E3%82%AE%E3%83%A3%E3%83%A9%E3%83%AA%E3%83%BC%20%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92,%E3%82%92%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%BE%E3%81%99%E3%80%82">Azure Automation でモジュールを管理する</a> をご参考いただき、上記モジュールを Automation アカウントにインポートいただければ幸いです。</p><div class="alert is-info"><p class="alert-title">Note</p><p>コマンドに必要なモジュールを特定するには、対象コマンドの公開情報に記載されているモジュールをご確認いただければ確認できます。</p><p>対象コマンドの公開情報は、インターネットで対象コマンドを検索すると表示される Microsoft 公開情報にて確認できます。</p><p>例えば、Connect-AzAccount の場合、”Module” に “Az.Accounts” と記載されていることが確認できます。</p><p><img src="/blog/automation/HowtoStartOrStopVMsbyAutomation/HowtoStartOrStopVMsbyAutomation_howtosearchfrominternet.png"></p><p><img src="/blog/automation/HowtoStartOrStopVMsbyAutomation/HowtoStartOrStopVMsbyAutomation_module.png"></p></div><div class="alert is-info"><p class="alert-title">Note</p><p>既に、Az.Accounts と Az.Compute モジュールがインポートされている Automation アカウントをご利用されているお客様もいます。この場合、上記モジュール インポートの対応は不要です。</p><p>[Azure ポータル] &gt; [Automation アカウント] &gt; [モジュール] に対象モジュールが存在していれば、上記モジュール インポートの対応は不要です。</p></div><h4 id="4-対象-Runbook-を作成する"><a href="#4-対象-Runbook-を作成する" class="headerlink" title="4.対象 Runbook を作成する"></a>4.対象 Runbook を作成する</h4><p>以下へアクセスします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] - [Automation アカウント] - [Runbook] - [Runbook の作成]</span><br></pre></td></tr></table></figure><p>以下を構成し、[作成] をクリックします。</p><ul><li>Runbook の名前 : &lt;任意に設定&gt;</li><li>Runbook の種類 : PowerShell</li><li>ランタイム バージョン : 5.1</li></ul><p><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-runbook--%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97vm-%E3%82%92%E8%B5%B7%E5%8B%95%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B-runbook">上記サンプル</a> のスクリプトを貼り付けます。<br>[保存] と [公開] を押します。[はい] を押します。</p><h4 id="5-スケジュールを設定する"><a href="#5-スケジュールを設定する" class="headerlink" title="5.スケジュールを設定する"></a>5.スケジュールを設定する</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/automation/shared-resources/schedules">Azure Automation のスケジュールを管理する</a> を参考に、スケジュールを作成し、スケジュールを Runbook にリンクします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-runbook--%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97vm-%E3%82%92%E8%B5%B7%E5%8B%95%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B-runbook">上記サンプル</a> は、１つの VM のみ指定できます。</p><p>そのため、VM の数分、スケジュールを作成し、Runbook へリンクする必要がございます。</p><p>Runbook は 1 つだけで問題ございません。</p><p>複数の VM を指定されたい場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-functions/start-stop-vms/overview">Start/Stop VMs v2</a> ソリューション (Azure Functions 及び Logic Apps の機能) のご利用をご検討いただければ幸いです。</p></div><p>今回のサンプルの場合、以下３つのパラメーターで構成されています。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">param</span>(</span><br><span class="line">[<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,<span class="type">HelpMessage</span>=<span class="string">&quot;Enter the value for Action. Values can be either start or stop&quot;</span>)][<span class="built_in">String</span>]<span class="variable">$Action</span> = <span class="variable">$</span>(<span class="keyword">throw</span> <span class="string">&quot;Value for Action is missing&quot;</span>),</span><br><span class="line">[<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,<span class="type">HelpMessage</span>=<span class="string">&quot;Enter the value for VMName.&quot;</span>)][<span class="built_in">String</span>]<span class="variable">$VMName</span> = <span class="variable">$</span>(<span class="keyword">throw</span> <span class="string">&quot;Value for VMName is missing&quot;</span>),</span><br><span class="line">[<span class="type">Parameter</span>(<span class="type">Mandatory</span>=<span class="variable">$true</span>,<span class="type">HelpMessage</span>=<span class="string">&quot;Enter the ResourceGroupName.&quot;</span>)][<span class="built_in">String</span>]<span class="variable">$ResourceGroupName</span> = <span class="variable">$</span>(<span class="keyword">throw</span> <span class="string">&quot;Value for ResourceGroupName is missing&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>スケジュールを Runbook へリンクするタイミングで、パラメーターの指定が求められます。<br>各パラーメーターに渡す値は、以下のように指定いただければ幸いです。</p><ul><li>ACTION : VM を起動したい場合は、”start”。VM を停止したい場合は、”stop” を入力。</li><li>VMNAME : 対象 VM の VM 名を入力</li><li>RESOURCEGROUPNAME : 対象 VM のリソース グループ名を入力</li></ul><p><img src="/blog/automation/HowtoStartOrStopVMsbyAutomation/HowtoStartOrStopVMsbyAutomation_schedule.png"></p><h4 id="6-動作確認する"><a href="#6-動作確認する" class="headerlink" title="6.動作確認する"></a>6.動作確認する</h4><p>まずは、Runbook を手動で実行し、正常動作することを確認してから、<br>スケジュールの動作をご確認いただければ幸いです。</p><h5 id="Runbook-手動実行での動作確認"><a href="#Runbook-手動実行での動作確認" class="headerlink" title="Runbook 手動実行での動作確認"></a>Runbook 手動実行での動作確認</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] - [Automation アカウント] - [Runbook] - [開始] - [パラメーターの値を入力] - [OK]</span><br></pre></td></tr></table></figure><h5 id="スケジュールの動作確認"><a href="#スケジュールの動作確認" class="headerlink" title="スケジュールの動作確認"></a>スケジュールの動作確認</h5><p>スケジュールで設定された時間に Runbook が実行されるかどうかを確認します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] - [Automation アカウント] - [ジョブ] - [ジョブ一覧に対象 Runbook のジョブが表示されるかを確認]</span><br></pre></td></tr></table></figure><h3 id="トラブルシューティング"><a href="#トラブルシューティング" class="headerlink" title="トラブルシューティング"></a>トラブルシューティング</h3><h4 id="マネージド-ID-にロールが割り当てられていないパターン"><a href="#マネージド-ID-にロールが割り当てられていないパターン" class="headerlink" title="マネージド ID にロールが割り当てられていないパターン"></a>マネージド ID にロールが割り当てられていないパターン</h4><p>例えば、以下のようなエラー メッセージが表示され、VM が起動・停止していない場合は、<br>マネージド ID に必要なロールが割り当てられているかをご確認いただければ幸いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Error Message] Cannot validate argument on parameter &#x27;Subscription&#x27;. The argument is null or empty. Provide an argument that is not null or empty, and then try the command again. </span><br></pre></td></tr></table></figure><p>本サンプルでは、システム割り当てマネージド ID を利用し、Azure へ認証し、VM を起動・停止します。<br>上記エラーは、システム割り当てマネージド ID が、Azure へ認証できていないことを意味します。<br>システム割り当てマネージド ID が、Azure へ認証するには、権限があるロールを有している必要がございます。<br>ロールが割り当てられているかをご確認ください。</p><h4 id="必要なモジュールがインポートされていないパターン"><a href="#必要なモジュールがインポートされていないパターン" class="headerlink" title="必要なモジュールがインポートされていないパターン"></a>必要なモジュールがインポートされていないパターン</h4><p>例えば、以下のようなエラー メッセージが表示され、VM が起動・停止していない場合は、<br>対象 Runbook のコマンドのモジュールがインポートされていないことを意味します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The term &#x27;&lt;コマンド名&gt;&quot; is not recognized as a name of cmdlet...</span><br></pre></td></tr></table></figure><p>Automation アカウントにモジュールがインポートされているかご確認いただき、<br>ない場合は、必要な PowerShell モジュールを適宜インポートしていただけますと幸いです。</p><p>以上です。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure Monitoring サポート チームの趙です。&lt;br&gt;今回は、VM を起動・停止する方法をご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Automation" scheme="https://jpazmon-integ.github.io/blog/tags/Automation/"/>
    
    <category term="RunAs Account" scheme="https://jpazmon-integ.github.io/blog/tags/RunAs-Account/"/>
    
    <category term="Runbook" scheme="https://jpazmon-integ.github.io/blog/tags/Runbook/"/>
    
    <category term="VM" scheme="https://jpazmon-integ.github.io/blog/tags/VM/"/>
    
    <category term="起動" scheme="https://jpazmon-integ.github.io/blog/tags/%E8%B5%B7%E5%8B%95/"/>
    
    <category term="停止" scheme="https://jpazmon-integ.github.io/blog/tags/%E5%81%9C%E6%AD%A2/"/>
    
    <category term="自動化" scheme="https://jpazmon-integ.github.io/blog/tags/%E8%87%AA%E5%8B%95%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>実行アカウントからマネージド ID へ移行する方法及び FAQ</title>
    <link href="https://jpazmon-integ.github.io/blog/automation/MigrateRunAsAccountsToManagedIdentity/"/>
    <id>https://jpazmon-integ.github.io/blog/automation/MigrateRunAsAccountsToManagedIdentity/</id>
    <published>2022-10-13T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.743Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure Monitoring サポート チームの趙です。<br>今回は、実行アカウントからマネージド ID へ移行する方法及び FAQ をご案内させていただきます。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%8B%E3%82%89%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C">実行アカウントからマネージド ID への移行</a></li><li><a href="#%E5%85%AC%E9%96%8B%E6%83%85%E5%A0%B1">公開情報</a></li><li><a href="#faq">FAQ</a><ul><li><a href="#q1automation-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%A8%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AF%E5%90%8C%E3%81%98%E3%82%82%E3%81%AE%E3%81%A7%E3%81%99%E3%81%8B">Q1.Automation アカウントと実行アカウントは同じものですか？</a></li><li><a href="#q2%E7%A7%BB%E8%A1%8C%E4%BD%9C%E6%A5%AD%E3%82%92%E5%AE%9F%E6%96%BD%E3%81%99%E3%81%93%E3%81%A8%E3%81%AB%E3%82%88%E3%82%8B%E5%BD%B1%E9%9F%BF%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B">Q2.移行作業を実施すことによる影響はありますか？</a></li><li><a href="#q3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%8B%E3%82%89%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C%E3%81%A8%E3%81%AF%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AB%E4%BD%95%E3%82%92%E6%84%8F%E5%91%B3%E3%81%97%E3%81%BE%E3%81%99%E3%81%8B">Q3.実行アカウントからマネージド ID への移行とは具体的に何を意味しますか？</a></li><li><a href="#q4%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%81%AF%E3%81%A9%E3%81%93%E3%81%8B%E3%82%89%E7%A2%BA%E8%AA%8D%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B">Q4.実行アカウントが存在するかどうかはどこから確認できますか？</a></li><li><a href="#q5%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E5%8F%82%E7%85%A7%E5%89%8A%E9%99%A4%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%A9%E3%81%86%E3%81%99%E3%82%8C%E3%81%B0%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B">Q5.実行アカウントの参照、削除ができません。どうすればいいですか？</a></li><li><a href="#q6%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%A8%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id%E3%81%A9%E3%81%A1%E3%82%89%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E3%81%84%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B">Q6.システム割り当てマネージド ID とユーザー割り当てマネージド ID、どちらを使えばいいですか？</a></li></ul></li><li><a href="#%E7%A7%BB%E8%A1%8C%E4%BD%9C%E6%A5%AD%E3%81%AE%E9%A0%86%E7%95%AA%E5%8F%8A%E3%81%B3%E5%AF%BE%E5%BF%9C%E4%BE%8B">移行作業の順番及び対応例</a><ul><li><a href="#%E5%85%8D%E8%B2%AC%E4%BA%8B%E9%A0%85">免責事項</a></li><li><a href="#1runbook-%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D">1.Runbook に実行アカウントを利用しているコマンドが存在するかを確認</a><ul><li><a href="#azurerm-%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E4%BE%8B">AzureRM モジュールのコマンドを利用している場合の例</a></li><li><a href="#az-%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AE%E4%BE%8B">Az モジュールのコマンドを利用している場合の例</a></li></ul></li><li><a href="#2%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AE%E4%BD%9C%E6%88%90">2.マネージド ID の作成</a></li><li><a href="#3%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%B8%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%AB%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6">3.マネージド ID へのロールの割り当て</a></li><li><a href="#4%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8%E3%81%AE%E6%96%B0%E8%A6%8F-runbook-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E6%97%A2%E5%AD%98%E3%81%AE-runbook-%E3%82%92%E4%BF%AE%E6%AD%A3">4.マネージド ID 用の新規 Runbook を作成、あるいは、既存の Runbook を修正</a><ul><li><a href="#%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8%E3%81%AE%E6%96%B0%E8%A6%8F-runbook-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">マネージド ID 用の新規 Runbook を作成する場合</a></li><li><a href="#%E6%97%A2%E5%AD%98%E3%81%AE-runbook-%E3%82%92%E4%BF%AE%E6%AD%A3-%E6%97%A2%E5%AD%98%E3%81%AE-runbook-%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E7%94%A8%E3%81%AE%E8%AA%8D%E8%A8%BC%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8%E3%81%AE%E8%AA%8D%E8%A8%BC%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AB%E4%BF%AE%E6%AD%A3-%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">既存の Runbook を修正 (既存の Runbook スクリプトの実行アカウント用の認証コマンドを、マネージド ID 用の認証コマンドに修正) する場合</a></li></ul></li><li><a href="#5%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AE%E5%8B%95%E4%BD%9C%E3%83%86%E3%82%B9%E3%83%88">5.マネージド ID の動作テスト</a><ul><li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB">サンプル</a></li></ul></li><li><a href="#6%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8-runbook-%E3%81%AE%E5%8B%95%E4%BD%9C%E3%83%86%E3%82%B9%E3%83%88">6.マネージド ID 用 Runbook の動作テスト</a><ul><li><a href="#%E6%AD%A3%E5%B8%B8%E5%8B%95%E4%BD%9C%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">正常動作する場合</a></li><li><a href="#%E6%96%B0%E8%A6%8F%E4%BD%9C%E6%88%90%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E4%BF%AE%E6%AD%A3%E3%81%97%E3%81%9F%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8-runbook-%E3%81%8C%E6%AD%A3%E5%B8%B8%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88">新規作成あるいは修正したマネージド ID 用 Runbook が正常動作しない場合</a></li><li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB-runbook-%E3%81%8C%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88">サンプル Runbook が動作しない場合</a></li></ul></li><li><a href="#7%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E5%89%8A%E9%99%A4">7.実行アカウントの削除</a></li></ul></li></ul><h2 id="実行アカウントからマネージド-ID-への移行"><a href="#実行アカウントからマネージド-ID-への移行" class="headerlink" title="実行アカウントからマネージド ID への移行"></a>実行アカウントからマネージド ID への移行</h2><ul><li>現在、Runbook の認証手段として実行アカウントをご利用されているお客様は、実行アカウントからマネージド ID への移行をご検討いただければ幸いです。</li><li>既に Runbook の認証手段としてマネージド ID をご利用されているお客様は、対応不要です。</li><li>2023 年 9 月 30 日に実行アカウントは、サポート終了 (retire) となります。</li><li>そのため、2023 年 9 月 30 日までには、マネージド ID へ移行する必要があります。</li><li>マネージド ID は、実行アカウントと同じ機能を提供しており、弊社が推奨する認証手段です。</li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>公開情報には、”Azure Automation実行アカウントは 2023 年 9 月 30 日に廃止され、マネージド ID に置き換えられます。” と記載されておりますが、補足させていただきます。</p><p>弊社側から 2023 年 9 月 30 日までにご利用されている実行アカウントをマネージド ID へ移行する作業・デプロイを行うわけではございません。</p><p>2023 年 9 月 30 日に実行アカウントは、サポート終了 (retire) する意味とご理解いただければ幸いです。</p><p>お客様にて、直接、実行アカウントをマネージド ID へ移行するようにご対応いただく必要がございます。</p></div><h2 id="公開情報"><a href="#公開情報" class="headerlink" title="公開情報"></a>公開情報</h2><p>弊社にて推奨する移行ガイドラインは、<a href="https://learn.microsoft.com/ja-jp/azure/automation/migrate-run-as-accounts-managed-identity?tabs=run-as-account">既存の実行アカウントからマネージド ID に移行する</a> に詳細が記載されております。必要なアクション、移行時参考となるサンプル コマンド等は、基本的には、上記公開情報をご参考いただき、ご対応いただければ幸いです。</p><p>実行アカウントとマネージド ID そのものの概念及び詳細は、以下公開情報及びブログもご参考いただければ幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-JP/azure/automation/automation-security-overview">Azure Automation アカウントの認証の概要</a> (公開情報)</li><li><a href="https://jpazmon-integ.github.io/blog/automation/DifferenceRunAsAccountAndManagedID/">実行アカウントとマネージド ID の違いについて</a> (ブログ)</li><li><a href="https://jpazmon-integ.github.io/blog/automation/HowToManageRunAsAccount/">Azure Automation の実行アカウントの管理方法の tips と FAQ</a> (ブログ)</li></ul><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="Q1-Automation-アカウントと実行アカウントは同じものですか？"><a href="#Q1-Automation-アカウントと実行アカウントは同じものですか？" class="headerlink" title="Q1.Automation アカウントと実行アカウントは同じものですか？"></a>Q1.Automation アカウントと実行アカウントは同じものですか？</h3><p>Automation アカウントと実行アカウントは別のものです。</p><p>Automation アカウントは、Azure Automation サービスを利用するために必要なリソースを保持するものとご理解いただければ幸いです。Azure Automation サービスを利用するために必要なリソースには、Runbook、スケジュール、モジュール、変数、資格情報、証明書等があります。</p><p>実行アカウントは、Azure への認証に利用されるサービス プリンシパルです。<br>Automation アカウントにある Runbook スクリプトに実行アカウントを利用する認証コマンドを実装いただくことで、Runbook 実行時、Azure への認証が可能です。<br>実行アカウントの詳細は、<a href="https://jpazmon-integ.github.io/blog/automation/HowToManageRunAsAccount/">Azure Automation の実行アカウントの管理方法の tips と FAQ</a> をご参考いただければ幸いです。</p><h3 id="Q2-移行作業を実施すことによる影響はありますか？"><a href="#Q2-移行作業を実施すことによる影響はありますか？" class="headerlink" title="Q2.移行作業を実施すことによる影響はありますか？"></a>Q2.移行作業を実施すことによる影響はありますか？</h3><p>移行作業時、実行アカウントを先に削除しない限り、<br>実行アカウントからマネージド ID への移行作業による影響は特にございません。</p><p>実行アカウントとマネージド ID は、お互い影響しない別のものであるため、共存 (Automation アカウントに実行アカウントとマネージド IDをどちらも保持すること) ができます。<br>移行作業時に、既存 Runbook にてご利用されている実行アカウントを削除せず、マネージド ID を新規作成し、<br>移行作業後、マネージド ID のみ残し、実行アカウントを削除いただければ、<br>実行アカウントからマネージド ID への移行作業による影響は特にございません。</p><p>一方で、現在、Runbook に実行アカウントによる認証コマンドを記載し、その Runbook を実行されており、<br>マネージド ID を用意せず、実行アカウントを削除してしまった場合は、<br>対象 Runbook にて、Azure への認証が行われず、対象 Runbook 内後続の処理が失敗する可能性がございます。</p><p>移行作業時の順番及び対応例は、後述させていただきます。</p><h3 id="Q3-実行アカウントからマネージド-ID-への移行とは具体的に何を意味しますか？"><a href="#Q3-実行アカウントからマネージド-ID-への移行とは具体的に何を意味しますか？" class="headerlink" title="Q3.実行アカウントからマネージド ID への移行とは具体的に何を意味しますか？"></a>Q3.実行アカウントからマネージド ID への移行とは具体的に何を意味しますか？</h3><p>以下を意味します。</p><ul><li>Automation アカウントにマネージド ID を作成する</li><li>Runbook スクリプトに記載されている実行アカウントによる認証コマンドをマネージド ID による認証コマンドに書き換える</li><li>Automation アカウントから実行アカウントを削除する</li></ul><h3 id="Q4-実行アカウントが存在するかどうかはどこから確認できますか？"><a href="#Q4-実行アカウントが存在するかどうかはどこから確認できますか？" class="headerlink" title="Q4.実行アカウントが存在するかどうかはどこから確認できますか？"></a>Q4.実行アカウントが存在するかどうかはどこから確認できますか？</h3><p>以下操作で確認できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] &gt; [Automation アカウント] &gt; [実行アカウント] &gt; Azure 実行アカウントが存在していれば、実行アカウントが存在</span><br></pre></td></tr></table></figure><h3 id="Q5-実行アカウントの参照、削除ができません。どうすればいいですか？"><a href="#Q5-実行アカウントの参照、削除ができません。どうすればいいですか？" class="headerlink" title="Q5.実行アカウントの参照、削除ができません。どうすればいいですか？"></a>Q5.実行アカウントの参照、削除ができません。どうすればいいですか？</h3><p><a href="https://jpazmon-integ.github.io/blog/automation/HowToManageRunAsAccount/">Azure Automation の実行アカウントの管理方法の tips と FAQ</a> をご参考いただき、操作を行っているユーザー アカウントに必要な権限を付与いただくか、権限があるユーザー アカウントにて操作いただければ幸いです。</p><h3 id="Q6-システム割り当てマネージド-ID-とユーザー割り当てマネージド-ID、どちらを使えばいいですか？"><a href="#Q6-システム割り当てマネージド-ID-とユーザー割り当てマネージド-ID、どちらを使えばいいですか？" class="headerlink" title="Q6.システム割り当てマネージド ID とユーザー割り当てマネージド ID、どちらを使えばいいですか？"></a>Q6.システム割り当てマネージド ID とユーザー割り当てマネージド ID、どちらを使えばいいですか？</h3><p>弊社過去事例として、システム割り当てマネージド ID や、ユーザー割り当てマネージド ID の中で、<br>どちらを利用すればいいかとのご質問をよくいただいておりますが、<br>弊社から推奨する認証手段は特になく、お客様がご判断いただければ幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/managed-identities-azure-resources/managed-identity-best-practice-recommendations">マネージド ID のベスト プラクティスに関する推奨事項</a> をご参考いただき、お客様のご要件に応じて、システム割り当てマネージド ID、あるいは、ユーザー割り当てマネージド ID どちらかをご利用いただければ幸いです。</p><p>Automation 観点では、システム割り当てマネージド ID が、ユーザー割り当てマネージド ID より、マネージド ID を構成する手間 (操作回数) が少なく、認証に利用するコマンドが短いです。<br>上記以外の相違点 (メリット、デメリット等)は特にございません。</p><h2 id="移行作業の順番及び対応例"><a href="#移行作業の順番及び対応例" class="headerlink" title="移行作業の順番及び対応例"></a>移行作業の順番及び対応例</h2><p>以下免責事項をご確認いただいたうえで、以下対応例をご参考いただければ幸いです。</p><h3 id="免責事項"><a href="#免責事項" class="headerlink" title="免責事項"></a>免責事項</h3><ul><li>以下にご案内する内容は、あくまでも対応例 (ガイドライン) です。お客様の Runbook とスクリプトの記載内容が異なる場合もある点、予めご理解いただければ幸いです。</li><li>弊社サポートにて、お客様のご要件の Runbook を作成・編集・提供することは、サポートしておりません。</li><li>スクリプトの修正、スクリプトの追記等が必要な際には、お客様のご要件に応じて、お客様にて直接修正・動作確認いただく必要がございます。そのため、大変恐れ入りますが、スクリプトの修正、スクリプトの追記等をお問い合わせいただいても、ご要望を承ることができない点、予めご理解いただければ幸いです。</li><li>例えば、現在お客様がご利用されている Runbook をご提示いただきながら、サポートにて修正・アップデート・カスタマイズしてくださいとのご要望は、弊社サポートにて承ることができない点、予めご理解いただければ幸いです。</li></ul><h3 id="1-Runbook-に実行アカウントを利用しているコマンドが存在するかを確認"><a href="#1-Runbook-に実行アカウントを利用しているコマンドが存在するかを確認" class="headerlink" title="1.Runbook に実行アカウントを利用しているコマンドが存在するかを確認"></a>1.Runbook に実行アカウントを利用しているコマンドが存在するかを確認</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] &gt; [Automation アカウント] &gt; [Runbook] &gt; 対象 Runbook クリック &gt; [表示] &gt; Runbook スクリプト確認</span><br></pre></td></tr></table></figure><p>Runbook に実行アカウントを利用しているコマンドがあるかどうかは、<br>以下のようなサンプルコマンドが Runbook に記載されているかどうかをご確認いただけますと幸いです。<br>以下例の場合、Azure への認証に実行アカウントを利用しています。</p><h4 id="AzureRM-モジュールのコマンドを利用している場合の例"><a href="#AzureRM-モジュールのコマンドを利用している場合の例" class="headerlink" title="AzureRM モジュールのコマンドを利用している場合の例"></a>AzureRM モジュールのコマンドを利用している場合の例</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$connectionName</span> = <span class="string">&quot;AzureRunAsConnection&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$servicePrincipalConnection</span>=<span class="built_in">Get-AutomationConnection</span> <span class="literal">-Name</span> <span class="variable">$connectionName</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Logging in to Azure...&quot;</span></span><br><span class="line"><span class="built_in">Add-AzureRmAccount</span> `</span><br><span class="line">    <span class="literal">-ServicePrincipal</span> `</span><br><span class="line">    <span class="literal">-TenantId</span> <span class="variable">$servicePrincipalConnection</span>.TenantId `</span><br><span class="line">    <span class="literal">-ApplicationId</span> <span class="variable">$servicePrincipalConnection</span>.ApplicationId `</span><br><span class="line">    <span class="literal">-CertificateThumbprint</span> <span class="variable">$servicePrincipalConnection</span>.CertificateThumbprint</span><br></pre></td></tr></table></figure><h4 id="Az-モジュールのコマンドを利用している場合の例"><a href="#Az-モジュールのコマンドを利用している場合の例" class="headerlink" title="Az モジュールのコマンドを利用している場合の例"></a>Az モジュールのコマンドを利用している場合の例</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Connect Automation</span></span><br><span class="line"><span class="variable">$connectionName</span> = <span class="string">&quot;AzureRunAsConnection&quot;</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Get the connection &quot;AzureRunAsConnection &quot;</span></span><br><span class="line">    <span class="variable">$Conn</span>=<span class="built_in">Get-AutomationConnection</span> <span class="literal">-Name</span> <span class="variable">$connectionName</span>         </span><br><span class="line">    <span class="built_in">Connect-AzAccount</span> <span class="literal">-ServicePrincipal</span> <span class="literal">-Tenant</span> <span class="variable">$Conn</span>.TenantID <span class="literal">-ApplicationId</span> <span class="variable">$Conn</span>.ApplicationID <span class="literal">-CertificateThumbprint</span>　<span class="variable">$Conn</span>.CertificateThumbprint</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$Conn</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ErrorMessage</span> = <span class="string">&quot;Connection <span class="variable">$connectionName</span> not found.&quot;</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="variable">$ErrorMessage</span></span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">Write-Error</span> <span class="literal">-Message</span> <span class="variable">$_</span>.Exception</span><br><span class="line">        <span class="keyword">throw</span> <span class="variable">$_</span>.Exception</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記以外の例は、<a href="https://learn.microsoft.com/ja-jp/azure/automation/migrate-run-as-accounts-managed-identity?tabs=run-as-account">既存の実行アカウントからマネージド ID に移行する</a> の例もご参考いただければ幸いです。</p><p>お客様の Runbook の実行アカウントによる認証コマンドが、上記例とは完全一致しない場合もあると思います。<br>その際には、スクリプトの Get-AutomationConnection で指定している接続が、”AzureRunAsConnection” と記載されていれば、実行アカウントを認証手段として利用しているとご判断いただければ幸いです。</p><h3 id="2-マネージド-ID-の作成"><a href="#2-マネージド-ID-の作成" class="headerlink" title="2.マネージド ID の作成"></a>2.マネージド ID の作成</h3><p>以下公開情報をご参考いただき、システム割り当てマネージド ID 、あるいは、ユーザー割り当てマネージド ID、どちらかを作成いただければ幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/enable-managed-identity-for-automation">Azure Automation アカウントのシステム割り当てマネージド ID を使用する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/add-user-assigned-identity">Azure Automation アカウントのユーザー割り当てマネージド ID を使用する</a></li></ul><h3 id="3-マネージド-ID-へのロールの割り当て"><a href="#3-マネージド-ID-へのロールの割り当て" class="headerlink" title="3.マネージド ID へのロールの割り当て"></a>3.マネージド ID へのロールの割り当て</h3><p>以下公開情報をご参考いただき、マネージド ID に必要なロールを割り当てていただければ幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/enable-managed-identity-for-automation#verify-role-assignment-to-a-system-managed-identity">システム マネージド IDへのロールの割り当てを確認する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/add-user-assigned-identity#verify-role-assignment-to-a-user-managed-identity">ユーザー マネージド ID へのロールの割り当てを確認する</a></li></ul><p>既存の実行アカウントと同じロールをマネージド ID に割り当てたい場合は、以下をご参考いただければ幸いです。</p><p>お客様にて、ポータルで実行アカウントを作成していた場合は、既定では、Azure サブスクリプションの共同作成者ロールが実行アカウントに割り当てられています。この場合は、マネージド ID へサブスクリプションの共同作成者ロールを割り当てていただければ幸いです。</p><p>お客様にて、ポータルで実行アカウントを作成していなかた場合、あるいは、ポータルで作成したかどうか忘れた場合は、実行アカウントに割り当てていたロールを確認し、割り当てます。<br>以下操作で実行アカウントに割り当てられていたロールが確認できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] &gt; [Automation アカウント] &gt; [実行アカウント] &gt; [Azure 実行アカウント] &gt; ロールの配下に記載されている &quot;役割&quot; (ロール) と &quot;割り当て対象&quot; (スコープ) を確認</span><br></pre></td></tr></table></figure><h3 id="4-マネージド-ID-用の新規-Runbook-を作成、あるいは、既存の-Runbook-を修正"><a href="#4-マネージド-ID-用の新規-Runbook-を作成、あるいは、既存の-Runbook-を修正" class="headerlink" title="4.マネージド ID 用の新規 Runbook を作成、あるいは、既存の Runbook を修正"></a>4.マネージド ID 用の新規 Runbook を作成、あるいは、既存の Runbook を修正</h3><p>Runbook にて、認証コマンドで実行アカウントを利用されている場合は、<br>以下<strong>いずれか</strong> (AND 条件ではなく、OR 条件です) をご対応いただければ幸いです。</p><ul><li>マネージド ID 用の新規 Runbook を作成する</li><li>既存の Runbook スクリプトの実行アカウント用の認証コマンドを、マネージド ID 用の認証コマンドに修正</li></ul><p>お客様のご要件に応じて、Runbook を新規作成するか、既存の Runbook を修正するかをお客様にてご判断いただけますと幸いです。<br>既存の Runbook をしばらくの間、そのまま使いたいとのご要望の場合は、マネージド ID 用の新規 Runbook を作成する案をご検討いただけますと幸いです。</p><h4 id="マネージド-ID-用の新規-Runbook-を作成する場合"><a href="#マネージド-ID-用の新規-Runbook-を作成する場合" class="headerlink" title="マネージド ID 用の新規 Runbook を作成する場合"></a>マネージド ID 用の新規 Runbook を作成する場合</h4><p>以下操作で、Runbook を新規作成できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] &gt; [Automation アカウント] &gt; [Runbook] &gt; [Runbook の作成]</span><br></pre></td></tr></table></figure><p>以下公開情報をご参考いただき、システム割り当てマネージド ID 用の認証コマンド、あるいは、ユーザー割り当てマネージド ID 用の認証コマンドを Runbook に記載します。</p><ul><li><a href="https://learn.microsoft.com/ja-JP/azure/automation/migrate-run-as-accounts-managed-identity?tabs=sa-managed-identity#sample-scripts">サンプルのスクリプト</a></li><li><a href="https://learn.microsoft.com/ja-JP/azure/automation/enable-managed-identity-for-automation#authenticate-access-with-system-assigned-managed-identity">システム割り当てマネージド ID を使用してアクセスを認証する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/add-user-assigned-identity#authenticate-access-with-user-assigned-managed-identity">ユーザー割り当てマネージド ID を使用してアクセスを認証する</a></li></ul><p>Runbook スクリプトの最初の処理として、マネージド ID 用の認証コマンドを記載します。<br>以下のサンプル コマンドのように記載することが可能です。</p><p>以下例の場合、Azure への認証にシステム割り当てマネージド ID を利用しています。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Logging in to Azure...&quot;</span></span><br><span class="line">    <span class="built_in">Connect-AzAccount</span> <span class="literal">-Identity</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Error</span> <span class="literal">-Message</span> <span class="variable">$_</span>.Exception</span><br><span class="line">    <span class="keyword">throw</span> <span class="variable">$_</span>.Exception</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上記のようにマネージド ID の認証コマンドを Runbook の最初に記載した後は、<br>お客様にて実行したい処理を Runbook に記載いただけますと幸いです。<br>既存の Runbook に記載されている実行アカウント用の Azure への認証コマンド以外の処理 (例えば、VM を起動・停止するメインの処理等) を<br>そのまま新規 Runbook に記載いただけますと幸いです。</p><h4 id="既存の-Runbook-を修正-既存の-Runbook-スクリプトの実行アカウント用の認証コマンドを、マネージド-ID-用の認証コマンドに修正-する場合"><a href="#既存の-Runbook-を修正-既存の-Runbook-スクリプトの実行アカウント用の認証コマンドを、マネージド-ID-用の認証コマンドに修正-する場合" class="headerlink" title="既存の Runbook を修正 (既存の Runbook スクリプトの実行アカウント用の認証コマンドを、マネージド ID 用の認証コマンドに修正) する場合"></a>既存の Runbook を修正 (既存の Runbook スクリプトの実行アカウント用の認証コマンドを、マネージド ID 用の認証コマンドに修正) する場合</h4><p>以下操作で、Runbook を編集できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] &gt; [Automation アカウント] &gt; [Runbook] &gt; 対象 Runbook クリック &gt; 編集</span><br></pre></td></tr></table></figure><p>上記 <a href="#1runbook-%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%8C%E5%AD%98%E5%9C%A8%E3%81%99%E3%82%8B%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D">1.Runbook に実行アカウントを利用しているコマンドが存在するかを確認</a> にて、確認した実行アカウント用の Azure への認証コマンドをマネージド ID 用の認証コマンドに置き換えます。</p><p>最終的に、Runbook スクリプト内認証コマンドの箇所には、マネージド ID 用の認証コマンドだけ残すようにご対応いただければ幸いです。<br>以下例の場合、Azure への認証にシステム割り当てマネージド ID を利用しています。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Logging in to Azure...&quot;</span></span><br><span class="line">    <span class="built_in">Connect-AzAccount</span> <span class="literal">-Identity</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Error</span> <span class="literal">-Message</span> <span class="variable">$_</span>.Exception</span><br><span class="line">    <span class="keyword">throw</span> <span class="variable">$_</span>.Exception</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下公開情報もご参考いただき、システム割り当てマネージド ID 用の認証コマンド、あるいは、ユーザー割り当てマネージド ID 用の認証コマンドを Runbook に記載します。</p><ul><li><a href="https://learn.microsoft.com/ja-JP/azure/automation/migrate-run-as-accounts-managed-identity?tabs=sa-managed-identity#sample-scripts">サンプルのスクリプト</a></li><li><a href="https://learn.microsoft.com/ja-JP/azure/automation/enable-managed-identity-for-automation#authenticate-access-with-system-assigned-managed-identity">システム割り当てマネージド ID を使用してアクセスを認証する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/add-user-assigned-identity#authenticate-access-with-user-assigned-managed-identity">ユーザー割り当てマネージド ID を使用してアクセスを認証する</a></li></ul><p>既存の Runbook に記載されている実行アカウント用の Azure への認証コマンド以外の処理 (例えば、VM を起動・停止するメインの処理等) は、そのまま残していただければ幸いです。</p><h3 id="5-マネージド-ID-の動作テスト"><a href="#5-マネージド-ID-の動作テスト" class="headerlink" title="5.マネージド ID の動作テスト"></a>5.マネージド ID の動作テスト</h3><p>お客様の Automation アカウントに、チュートリアル用 Runbook “AzureAutomationTutorialWithIdentity” が存在する場合は、以下のように操作することで、マネージド ID が動作するかどうかを確認できます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Azure ポータル] &gt; [Automation アカウント] &gt; [Runbook] &gt; [AzureAutomationTutorialWithIdentity] クリック &gt; [開始] &gt; ジョブが完了し、エラーが特になければマネージド ID は正常動作</span><br></pre></td></tr></table></figure><p>お客様の Automation アカウントに、チュートリアル用 Runbook “AzureAutomationTutorialWithIdentity” が存在しない場合は、以下サンプル Runbook を実行することで、マネージド ID が動作するかどうかを確認できます。<br>以下サンプルが、チュートリアル用 Runbook “AzureAutomationTutorialWithIdentity” のスクリプトです。</p><h4 id="サンプル"><a href="#サンプル" class="headerlink" title="サンプル"></a>サンプル</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;#</span></span><br><span class="line"><span class="comment">    <span class="doctag">.DESCRIPTION</span></span></span><br><span class="line"><span class="comment">        An example runbook which gets all the ARM resources using the Managed Identity</span></span><br><span class="line"><span class="comment">    <span class="doctag">.NOTES</span></span></span><br><span class="line"><span class="comment">        AUTHOR: Azure Automation Team</span></span><br><span class="line"><span class="comment">        LASTEDIT: Oct 26, 2021</span></span><br><span class="line"><span class="comment">#&gt;</span></span><br><span class="line"><span class="string">&quot;Please enable appropriate RBAC permissions to the system identity of this automation account. Otherwise, the runbook may fail...&quot;</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Logging in to Azure...&quot;</span></span><br><span class="line">    <span class="built_in">Connect-AzAccount</span> <span class="literal">-Identity</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Error</span> <span class="literal">-Message</span> <span class="variable">$_</span>.Exception</span><br><span class="line">    <span class="keyword">throw</span> <span class="variable">$_</span>.Exception</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#Get all ARM resources from all resource groups</span></span><br><span class="line"><span class="variable">$ResourceGroups</span> = <span class="built_in">Get-AzResourceGroup</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$ResourceGroup</span> <span class="keyword">in</span> <span class="variable">$ResourceGroups</span>)</span><br><span class="line">&#123;    </span><br><span class="line">    <span class="built_in">Write-Output</span> (<span class="string">&quot;Showing resources in resource group &quot;</span> + <span class="variable">$ResourceGroup</span>.ResourceGroupName)</span><br><span class="line">    <span class="variable">$Resources</span> = <span class="built_in">Get-AzResource</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$ResourceGroup</span>.ResourceGroupName</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$Resource</span> <span class="keyword">in</span> <span class="variable">$Resources</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Write-Output</span> (<span class="variable">$Resource</span>.Name + <span class="string">&quot; of type &quot;</span> +  <span class="variable">$Resource</span>.ResourceType)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Write-Output</span> (<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="alert is-info"><p class="alert-title">Note</p><p>上記サンプル Runbook は、マネージド ID で Azure へ認証し、接続したサブスクリプションに存在する Azure リソースの一覧を取得 (Get-AzResourceGroup) する処理を実行するだけの Runbook です。</p><p>そのため、上記サンプル Runbook を実行しても、お客様のリソースへの影響等はございません。</p></div><h3 id="6-マネージド-ID-用-Runbook-の動作テスト"><a href="#6-マネージド-ID-用-Runbook-の動作テスト" class="headerlink" title="6.マネージド ID 用 Runbook の動作テスト"></a>6.マネージド ID 用 Runbook の動作テスト</h3><h4 id="正常動作する場合"><a href="#正常動作する場合" class="headerlink" title="正常動作する場合"></a>正常動作する場合</h4><p>上記 <a href="#4%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8%E3%81%AE%E6%96%B0%E8%A6%8F-runbook-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E6%97%A2%E5%AD%98%E3%81%AE-runbook-%E3%82%92%E4%BF%AE%E6%AD%A3">4.マネージド ID 用の新規 Runbook を作成、あるいは、既存の Runbook を修正</a> にて作成、あるいは、修正したマネージド ID 用 Runbook を開始し、ジョブが完了し、エラーがなければ正常動作とご理解いただければ幸いです。</p><h4 id="新規作成あるいは修正したマネージド-ID-用-Runbook-が正常動作しない場合"><a href="#新規作成あるいは修正したマネージド-ID-用-Runbook-が正常動作しない場合" class="headerlink" title="新規作成あるいは修正したマネージド ID 用 Runbook が正常動作しない場合"></a>新規作成あるいは修正したマネージド ID 用 Runbook が正常動作しない場合</h4><p>上記 <a href="#5%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AE%E5%8B%95%E4%BD%9C%E3%83%86%E3%82%B9%E3%83%88">5.マネージド ID の動作テスト</a> のサンプル Runbook は動作するが、<a href="#4%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E7%94%A8%E3%81%AE%E6%96%B0%E8%A6%8F-runbook-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E6%97%A2%E5%AD%98%E3%81%AE-runbook-%E3%82%92%E4%BF%AE%E6%AD%A3">4.マネージド ID 用の新規 Runbook を作成、あるいは、既存の Runbook を修正</a> にて作成、あるいは、修正したお客様のマネージド ID 用 Runbook は動作しない場合は、マネージド ID の認証は問題ないが、お客様にて作成あるいは修正した Runbook スクリプト自体に問題があるとご理解いただければ幸いです。<br>この場合は、お客様のスクリプトを見直していただければ幸いです。</p><h4 id="サンプル-Runbook-が動作しない場合"><a href="#サンプル-Runbook-が動作しない場合" class="headerlink" title="サンプル Runbook が動作しない場合"></a>サンプル Runbook が動作しない場合</h4><p>上記 <a href="#5%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-id-%E3%81%AE%E5%8B%95%E4%BD%9C%E3%83%86%E3%82%B9%E3%83%88">5.マネージド ID の動作テスト</a> のサンプル Runbook が動作しない場合は、マネージド ID が正常に構成されていないとご理解いただければ幸いです。<br>この場合は、マネージド ID が作成できているか、ロールが割り当てられているかを再度ご確認いただければ幸いです。</p><h3 id="7-実行アカウントの削除"><a href="#7-実行アカウントの削除" class="headerlink" title="7.実行アカウントの削除"></a>7.実行アカウントの削除</h3><p>上記にてマネージド ID 用 Runbook が正常動作することが確認できた場合は、<br>実行アカウントを削除いただければ幸いです。<br>今削除したくない場合は、お客様のご要件に応じて、お客様のタイミングにて削除いただければ幸いです。<br>実行アカウントの削除方法は、以下公開情報をご参考いただければ幸いです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/automation/delete-run-as-account">Azure Automation の実行アカウントを削除する</a></li></ul><p>以上です。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure Monitoring サポート チームの趙です。&lt;br&gt;今回は、実行アカウントからマネージド ID へ移行する方法及び FAQ をご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="移行" scheme="https://jpazmon-integ.github.io/blog/tags/%E7%A7%BB%E8%A1%8C/"/>
    
    <category term="Automation" scheme="https://jpazmon-integ.github.io/blog/tags/Automation/"/>
    
    <category term="マネージド ID" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%89-ID/"/>
    
    <category term="Runbook" scheme="https://jpazmon-integ.github.io/blog/tags/Runbook/"/>
    
    <category term="Run As Account" scheme="https://jpazmon-integ.github.io/blog/tags/Run-As-Account/"/>
    
    <category term="Managed Identity" scheme="https://jpazmon-integ.github.io/blog/tags/Managed-Identity/"/>
    
    <category term="Managed ID" scheme="https://jpazmon-integ.github.io/blog/tags/Managed-ID/"/>
    
    <category term="Migration" scheme="https://jpazmon-integ.github.io/blog/tags/Migration/"/>
    
    <category term="実行アカウント" scheme="https://jpazmon-integ.github.io/blog/tags/%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88/"/>
    
  </entry>
  
  <entry>
    <title>診断設定によるプラットフォーム メトリックやリソース ログの一部欠損について</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/DiagnosticSettings/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/DiagnosticSettings/</id>
    <published>2022-09-27T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.535Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure Monitoring チームの堀です。</p><p>最近、お客様から “診断設定でプラットフォーム メトリックを Azure ストレージにエクスポートした際に、一部のプラットフォーム メトリックが欠損している” というお問い合わせをいただきました。</p><p>結論から申し上げますと、診断設定によるプラットフォーム メトリックやリソース ログのエクスポートは、100 % のデータ エクスポートを保証しておりません。<br>システムの制約上、一部のデータの欠損は発生する可能性がございますので、本ブログ記事にてご紹介いたします。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>診断設定とは</li><li>診断設定によるプラットフォーム メトリックやログの一部欠損</li></ul><br><h2 id="診断設定とは"><a href="#診断設定とは" class="headerlink" title="診断設定とは"></a>診断設定とは</h2><p>まず、Azure Monitor の診断設定について簡単にご説明いたします。<br>診断設定を構成しますと、Azure リソースのプラットフォーム メトリックや、リソース ログを Azure Storage アカウントや Azure Event Hubs 等に送信することができます。<br>詳細は下記弊社公開情報をご覧ください。</p><p><strong>プラットフォーム メトリック</strong><br>監視対象のリソースから一定の間隔で自動で収集される数値データです。<br>既定では、Azure 基盤側のメトリック データベースに保存され、メトリックス エクスプローラーから確認することができます。</p><p><strong>リソース ログ</strong><br>診断設定で出力されるリソース内部に関するログです。<br>既定では収集されません。</p><p>&lt;参考&gt;<br>Azure Monitor の診断設定<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal</a></p><p>Azure Monitor のサポートされるメトリック<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/metrics-supported">https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/metrics-supported</a></p><p>Azure リソース ログ<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/resource-logs">https://learn.microsoft.com/ja-JP/azure/azure-monitor/essentials/resource-logs</a></p><br><h2 id="診断設定によるプラットフォーム-メトリックやログの一部欠損"><a href="#診断設定によるプラットフォーム-メトリックやログの一部欠損" class="headerlink" title="診断設定によるプラットフォーム メトリックやログの一部欠損"></a>診断設定によるプラットフォーム メトリックやログの一部欠損</h2><p>冒頭でも申し上げましたとおり、診断設定によるエクスポートでは、制約上、プラットフォーム メトリックやログの一部欠損は発生する可能性がございます。</p><p>診断設定は、 1 日あたりペタバイト単位のデータをお手頃な価格で、効率よくエクスポートすることを前提に設計されています。<br>そのため、完全なトランザクションは保証しておらず、ログやプラットフォーム メトリックが一部欠損する可能性がございます。<br>また、欠損したデータにつきましては、Azure 側で再出力することはできません。</p><p>一方で、一部の欠損ではなく、継続的にデータが欠損している場合や一度に大量のデータが欠損している場合は、<br>弊社 Azure サポート窓口までお問い合わせいただけますと幸いです。</p><br><p>以上、診断設定によるプラットフォーム メトリックやリソース ログの一部欠損についてご案内いたしました。<br>診断設定のシステムの制約上、一部欠損が発生すること、また、欠損したデータを再出力できないこと、予めご了承いただけますと幸甚です。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！ Azure Monitoring チームの堀です。&lt;/p&gt;
&lt;p&gt;最近、お客様から “診断設定でプラットフォーム メトリックを Azure ストレージにエクスポートした際に、一部のプラットフォーム メトリックが欠損している” というお問い合わせをいただきました。&lt;/p&gt;
&lt;p&gt;結論から申し上げますと、診断設定によるプラットフォーム メトリックやリソース ログのエクスポートは、100 % のデータ エクスポートを保証しておりません。&lt;br&gt;システムの制約上、一部のデータの欠損は発生する可能性がございますので、本ブログ記事にてご紹介いたします。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="Azure Monitor" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor/"/>
    
    <category term="Diagnostic settings" scheme="https://jpazmon-integ.github.io/blog/tags/Diagnostic-settings/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics の新機能 クエリ パック について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsQueryPacks/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsQueryPacks/</id>
    <published>2022-09-27T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.643Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。</p><p>今回は Log Analytics の新機能 “Log Analytics クエリ パック” をご紹介いたします。<br>この機能は、クエリを効果的に保存、共有、管理するために設計されました。<br>よく使用するクエリを保存したい！チーム内で便利なクエリを共有したい！という方には、必見の機能です。<br>本記事では Log Analytics クエリ パックの概要とその設定方法をご案内します。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-log-analytics-%E3%82%AF%E3%82%A8%E3%83%AA-%E3%83%91%E3%83%83%E3%82%AF%E3%81%A8%E3%81%AF">1. Log Analytics クエリ パック とは</a></li><li><a href="#2-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B">2. クエリを保存する</a></li><li><a href="#3-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99">3. クエリを呼び出す</a></li><li><a href="#4-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B">4. クエリを管理する</a></li><li><a href="#5-%E3%81%BE%E3%81%A8%E3%82%81">5. まとめ</a></li></ul><h2 id="1-Log-Analytics-クエリ-パックとは"><a href="#1-Log-Analytics-クエリ-パックとは" class="headerlink" title="1. Log Analytics クエリ パックとは"></a>1. Log Analytics クエリ パックとは</h2><p>クエリ パックは、いわば クエリの “コンテナ” です。<br>Log Analytics のクエリをより簡単かつ効率的に作成、保存、管理することを目的に開発されました。<br>クエリ パックは、サブスクリプション レベルで存在するリソースです。<br>そのため、保存したクエリはサブスクリプション配下に存在する “すべての” ワークスペースから利用することができます。</p><p>&lt;参考&gt;<br>クエリ パックの概要は、下記弊社公開情報や英語版ブログ <a href="https://techcommunity.microsoft.com/t5/azure-observability-blog/log-analytics-query-packs/ba-p/2314721">Log Analytics Query packs</a> でもご確認いただけます。<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/query-packs">Azure Monitor ログでのクエリ パック</a></p><p>また、クエリ パックを利用するには、サブスクリプションをスコープとした以下の権限が必要です。<br>クエリを保存したり、既存のクエリを編集する場合は、共同作成者権限、<br>クエリを閲覧したり、クエリを実行する場合は、閲覧者権限が必要です。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#contributor">共同作成者</a> - クエリの保存、クエリの編集、クエリの閲覧、クエリの実行</li><li><a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#reader">閲覧者</a> - クエリの閲覧、クエリの実行</li></ul><p>作業を開始する前に、適切な権限が付与されていることをご確認ください。<br><a href="https://docs.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=current">Azure portal を使用して Azure ロールを割り当てる</a></p><br><h2 id="2-クエリを保存する"><a href="#2-クエリを保存する" class="headerlink" title="2. クエリを保存する"></a>2. クエリを保存する</h2><p>それでは、実際にクエリを保存してみましょう。<br>本記事では Azure portal からクエリを保存する手順をご紹介します。<br>クエリ パックは Azure リソースであり、保存上限数はございません。<br>また、1 つのクエリ パックにつき、100 個までクエリを保存することが可能です。</p><ol><li><p>任意の Log Analytics ワークスペースで、クエリを実行します。画面上部の [保存] - [クエリとして保存] をクリックします。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image01.png"></p></li><li><p>クエリの名前を入力します。必要に応じてクエリの説明やリソース タイプを指定し、[保存] をクリックします。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image02.png"></p></li></ol><p>※ [既定のクエリ パックに保存する] を選択すると、”LogAnalyticsDefaultResources” リソース グループの<br>   “DefaultQueryPack” というクエリ パックにクエリが保存されます。<br>   デフォルトで作成されるクエリ パックに保存しない場合は [既定のクエリ パックに保存する] のチェックを外してください。</p><p>&lt;参考&gt;<br>クエリの保存手順は、弊社公開情報 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/save-query">Azure Monitor Log Analytics にクエリを保存する (プレビュー)</a> にも掲載しております。<br>クエリを保存する際に設定するプロパティの詳細は、弊社公開情報 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/queries#query-properties">クエリのプロパティ</a> をご覧ください。</p><br><h2 id="3-クエリを呼び出す"><a href="#3-クエリを呼び出す" class="headerlink" title="3. クエリを呼び出す"></a>3. クエリを呼び出す</h2><p>次に、保存したクエリを呼び出し、実行してみましょう。<br>クエリ ダイアログから実行する方法とクエリのサイドバーから実行する方法をご紹介します。</p><h3 id="クエリ-ダイアログから実行する"><a href="#クエリ-ダイアログから実行する" class="headerlink" title="クエリ ダイアログから実行する"></a>クエリ ダイアログから実行する</h3><ol><li><p>Azure portal より [Log Analytics ワークスペース] – [ログ] を選択すると、以下のダイアログが表示されます。<br>画面左上に表示される [クエリ パック: 0 個が選択済み] を選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image03.png"></p></li><li><p>クエリを保存したクエリ パックを選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image04.png"></p></li><li><p>左ペインのカテゴリを選択、もしくは、保存したクエリ名やリソース タイプ等を指定してクエリを検索します。<br>下図はクエリ名で検索した例です。クエリを選択したら、[実行] もしくは [エディターに読み込む] をクリックします。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image05.png"></p></li></ol><h3 id="クエリのサイドバーから実行する"><a href="#クエリのサイドバーから実行する" class="headerlink" title="クエリのサイドバーから実行する"></a>クエリのサイドバーから実行する</h3><ol><li><p>Azure portal より [Log Analytics ワークスペース] – [ログ] を選択します。</p></li><li><p>クエリのサイドバーで [クエリ] を選択し、[クエリ パックの選択] をクリックします。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image06.png"></p></li><li><p>クエリ パックを選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image07.png"></p></li><li><p>クエリのサイドバーにクエリ パックに保存されたクエリが表示されますので、クリックします。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image08.png"></p></li></ol><p>&lt;参考&gt;<br>クエリ ダイアログは、クエリ実行画面の右上にある [クエリ] をクリックしてアクセスすることもできます。<br>弊社公開情報 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/queries#queries-dialog">クエリ ダイアログへのアクセス手順</a> にも手順を掲載しておりますので、ご覧ください。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image09.png"></p><p>クエリのサイドバーの詳細は、弊社公開情報 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/queries#query-sidebar">クエリのサイドバー</a> をご覧ください。</p><br><h2 id="4-クエリを管理する"><a href="#4-クエリを管理する" class="headerlink" title="4. クエリを管理する"></a>4. クエリを管理する</h2><p>Azure portal から作成したクエリ パックを確認することができます。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image10.png"></p><p>既定では LogAnalyticsDefaultResources リソース グループに DefaultQueryPack という名前でクエリ パックが作成されますが、<br>クエリ パック名を指定したい、複数のクエリ パックに分けて保存したい、という場合は、<br>以下の [作成] よりクエリ パックを作成してください。<br><img src="/blog/LogAnalytics/LogAnalyticsQueryPacks/image11.png"></p><p>&lt;参考&gt;<br>クエリ パックの表示方法は、弊社公開情報 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/query-packs#view-query-packs">クエリ パックの表示</a> でもご確認いただけます。</p><br><h2 id="5-まとめ"><a href="#5-まとめ" class="headerlink" title="5. まとめ"></a>5. まとめ</h2><p>本記事では、以下についてご案内いたしましたが、いかがでしたでしょうか。</p><ul><li><a href="#1-log-analytics-%E3%82%AF%E3%82%A8%E3%83%AA-%E3%83%91%E3%83%83%E3%82%AF%E3%81%A8%E3%81%AF">1. Log Analytics クエリ パック とは</a></li><li><a href="#2-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B">2. クエリを保存する</a></li><li><a href="#3-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99">3. クエリを呼び出す</a></li><li><a href="#4-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B">4. クエリを管理する</a></li></ul><p>クエリ パックについてご意見やご要望などありましたら、以下ブログへのコメント、または Log Analytics のフィードバック機能より頂戴いただけますと幸いです。<br><a href="https://techcommunity.microsoft.com/t5/azure-observability-blog/log-analytics-query-packs/ba-p/2314721">Log Analytics Query packs</a></p><p>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;/p&gt;
&lt;p&gt;今回は Log Analytics の新機能 “Log Analytics クエリ パック” をご紹介いたします。&lt;br&gt;この機能は、クエリを効果的に保存、共有、管理するために設計されました。&lt;br&gt;よく使用するクエリを保存したい！チーム内で便利なクエリを共有したい！という方には、必見の機能です。&lt;br&gt;本記事では Log Analytics クエリ パックの概要とその設定方法をご案内します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM の監視について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorAzVM_logs/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorAzVM_logs/</id>
    <published>2022-09-21T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.691Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの増塩、徳田です。</p><p>今回は、Log Analytics を使って Azure VM の監視をする方法を紹介します。<br>VM を作成しただけではゲスト OS 上のログやメトリックなどは収集されませんが、Log Analytics の機能と組み合わせることでゲスト OS の情報が収集できるようになります。<br>本記事では、Log Analytics を使って情報を収集する方法と、利用例についてご紹介します。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>ホスト メトリックについて</li><li>ゲスト メトリックについて</li><li>OS 上のログ監視について</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>ユーザーが VM を作成すると、仮想マシンのホストで管理しているメトリック データが自動的に収集されます。例えばディスクに関するメトリックとして “OS ディスク読み取りバイト数/秒” (OS Disk Read Bytes/Sec) が自動的に収集されます。</p><p>しかし、”ディスクの空き容量” のような VM 上で稼働している OS で管理しているメトリックは自動的には収集されません。</p><p>ここで、Log Analytics のエージェントが登場します。<br>エージェントをゲスト OS にインストールして、ログやメトリックを Azure Monitor に送信することで、ゲスト OS が管理している情報も監視することができるようになります。</p><h2 id="1-ホスト-メトリックについて"><a href="#1-ホスト-メトリックについて" class="headerlink" title="1. ホスト メトリックについて"></a>1. ホスト メトリックについて</h2><p>ホスト メトリックは仮想マシンを作成すると自動的に収集されます。<br>仮想マシンから取得されるメトリックは <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-supported#microsoftcomputevirtualmachines">“Azure Monitor のサポートされるメトリック” の [Microsoft.Compute/virtualMachines] チャプター</a>に記載されています。</p><p>Azure ポータルでは VM の <strong>[メトリック]</strong> 画面で、 <strong>[メトリック名前空間]</strong> を <strong>“仮想マシンホスト”</strong> にすると確認できます。</p><p><img src="/blog/LogAnalytics/MonitorAzVM_logs/vmMetricScreen.png" alt="メトリックの名前空間"></p><h2 id="2-ゲスト-メトリックについて"><a href="#2-ゲスト-メトリックについて" class="headerlink" title="2. ゲスト メトリックについて"></a>2. ゲスト メトリックについて</h2><h3 id="概要、ホスト-メトリックとの違い"><a href="#概要、ホスト-メトリックとの違い" class="headerlink" title="概要、ホスト メトリックとの違い"></a>概要、ホスト メトリックとの違い</h3><p>ゲスト OS からメトリックを取得するので “System Up Time” といったゲスト OS で管理しているメトリックも取得できます。</p><p><img src="/blog/LogAnalytics/MonitorAzVM_logs/getGuestMetric.png" alt="ゲスト メトリックの選択"></p><p>これらのメトリックは、ゲスト OS にインストールした Azure Monitor エージェントにより収集され、Azure Monitor に送信されます。</p><h3 id="監視方法"><a href="#監視方法" class="headerlink" title="監視方法"></a>監視方法</h3><p>ゲスト メトリックを収集するには、まず初めにデータ収集ルールを作成します。<br>データ収集ルールの作成方法は<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal">こちらのページの <strong>[データ収集ルールと関連付けを作成する]</strong> チャプター</a>に記載されていますので、ここでは設定のポイントを説明します。</p><p><strong>[収集と配信]</strong> タブの、 <strong>[データ ソースの追加]</strong> 画面では、以下のように <strong>“パフォーマンス カウンター”</strong> を選択します。<br>収集するメトリックをカスタマイズしない場合は、 <strong>[パフォーマンス カウンターを構成する]</strong> で <strong>“基本”</strong> を選択します。</p><p><img src="/blog/LogAnalytics/MonitorAzVM_logs/addDataSource.png" alt="データ ソースの設定方法"></p><p>収集するカウンターの設定が終了したら、 <strong>[次へ: ターゲット &gt;]</strong> をクリックすると、 <strong>[ターゲット]</strong> が表示されます。<br>このタブで、以下のように <strong>“Azure Monitor Metrics (preview)”</strong> が <strong>[ターゲットの種類]</strong> に設定されていることを確認してください。</p><p><img src="/blog/LogAnalytics/MonitorAzVM_logs/addDataSouce_target.png" alt="ターゲットの設定方法"></p><p>このように設定してデータ収集ルールを作成すると、監視対象の仮想マシンに Azure Monitor エージェントが自動的にインストールされ、ゲスト メトリックの収集が開始されます。</p><p>データ収集ルールを設定してから 10 分ほど待つと、仮想マシンの <strong>[メトリック]</strong> 画面でゲスト メトリックを確認できるようになります。<br>以下のように <strong>[メトリック名前空間]</strong> を <strong>“仮想マシンのゲスト”</strong> に設定すると、ゲスト OS から収集したメトリックの一覧が表示されます。</p><p><img src="/blog/LogAnalytics/MonitorAzVM_logs/setMeritcNameSpace.png" alt="ゲスト メトリックの表示例"></p><h2 id="3-OS-上のログ監視について"><a href="#3-OS-上のログ監視について" class="headerlink" title="3. OS 上のログ監視について"></a>3. OS 上のログ監視について</h2><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>仮想マシンにインストールされたエージェントは Azure Monitor へ、そのマシンのメトリックとログを送信します。それぞれのデータは、Azure Monitor メトリック データおよび Azure Monitor ログ データとして別の場所に格納されます。このため、それぞれのデータに対して利用できる Azure Monitor の機能には違いがあります。ここでは Azure 仮想マシン のログ データを利用した監視について紹介します。</p><h3 id="エージェントの種類紹介"><a href="#エージェントの種類紹介" class="headerlink" title="エージェントの種類紹介"></a>エージェントの種類紹介</h3><p>現在 Azure 仮想マシンの監視のために提供されているエージェントとして <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview">Azure Monitor エージェント</a>、 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/agents/log-analytics-agent">Log Analytics エージェント</a>、 <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure Diagnostics 拡張機能</a>の 3 種類が存在します。今回は仮想マシンの監視の観点から、それぞれのエージェントの概要を説明します。<br>なお、それぞれのエージェント間にはサポートされる OS や環境、収集できるデータの種類の観点で差異があります。これに関しての詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-supported#microsoftcomputevirtualmachines">こちら</a>からご確認ください。</p><h4 id="Azure-Monitor-エージェント-AMA"><a href="#Azure-Monitor-エージェント-AMA" class="headerlink" title="Azure Monitor エージェント (AMA)"></a>Azure Monitor エージェント (AMA)</h4><p>Azure Monitor エージェントは、現在提供されているエージェントのうち最も新しく、他 2 種のレガシ監視エージェントを置き換えることができます。 Azure Monitor エージェントによって Azure とハイブリッド仮想マシンのゲスト OS の監視データが Azure Monitor へと配信されます。<br>Azure Monitor エージェントは <a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/overview">Azure VM 拡張機能</a>として実装されます。</p><h4 id="Log-Analytics-エージェント-MMA"><a href="#Log-Analytics-エージェント-MMA" class="headerlink" title="Log Analytics エージェント (MMA)"></a>Log Analytics エージェント (MMA)</h4><p>Log Analytics エージェントは Microsoft Monitoring Agent(MMA) とも呼ばれるレガシ エージェントの 1 種です。<br>主に Azure 仮想マシンまたはハイブリッド マシンからログとパフォーマンス データを収集します。<br>Azure Monitor エージェントとの主な違いとして、 Azure Monitor メトリックへのデータが送信できないこと、エージェントごとに監視方法を設定することが困難であること、が挙げられます。</p><p>(注意) 従来の Log Analytics エージェントは<strong>廃止予定</strong>で、 <strong>2024 年 8 月 31 日</strong>を過ぎるとサポート対象外になります。</p><h4 id="Azure-Diagnostics-拡張機能-WAD-LAD"><a href="#Azure-Diagnostics-拡張機能-WAD-LAD" class="headerlink" title="Azure Diagnostics 拡張機能 (WAD/LAD)"></a>Azure Diagnostics 拡張機能 (WAD/LAD)</h4><p>Azure Diagnostics 拡張機能も前述の Log Analytics エージェントと同様、レガシ エージェントの 1 種です。<br>Windows 用の Windows Azure diagnostics extension (WAD) と、Linux 用の Linux Azure diagnostics extension (LAD) があります。<br>Azure Diagnostics 拡張機能は Azure の仮想マシンに対してのみ適用でき、Azure Storage (Windows、Linux) や Azure Monitor メトリック (Windows のみ) にデータを送信します。 </p><h3 id="死活監視"><a href="#死活監視" class="headerlink" title="死活監視"></a>死活監視</h3><p>先に紹介したエージェントによって収集された仮想マシンのデータを利用することで、仮想マシンの死活監視を行うことができます。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM/">こちらの記事</a>では Azure Monitor エージェントや Log Analytics エージェントによって Log Analytics ワークスペースに収集される Hearbeat を使用した主要な死活監視方法が紹介されています。</p><h3 id="ログ監視"><a href="#ログ監視" class="headerlink" title="ログ監視"></a>ログ監視</h3><p>Azure Monitor メトリックでは特定の数値データのみを格納できる一方で、Azure Monitor ログにはテキスト ログを含む様々なデータ型を格納することができます。このような Azure Monitor ログ データに対してログ クエリを使用することで、より複雑な分析を行うことができます。</p><p>以下でログ監視のための Azure Monitor の主要機能について紹介します。</p><h4 id="Log-Analytics-ワークスペースでのログ確認"><a href="#Log-Analytics-ワークスペースでのログ確認" class="headerlink" title="Log Analytics ワークスペースでのログ確認"></a>Log Analytics ワークスペースでのログ確認</h4><p>Azure Monitor ログでは、収集データが <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-workspace-overview">Log Analytics ワークスペース</a>に格納されます。そのため Azure Monitor ログを使用するためには 1 つ以上の <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal">Log Analytics ワークスペースを作成</a>する必要があります。</p><p>Log Analytics は Azure Monitor 内のツールの 1 つであり、Azure Monitor ログに対して対話形式でのログ クエリの編集・実行が可能です。さらに、クエリ実行結果を視覚化することができます。この機能は、ログ クエリの結果を利用する Azure Monitor のその他のツール (アラート、ブックなど) 内でも利用されます。<br><img src="/blog/LogAnalytics/MonitorAzVM_logs/LAScreen.png" alt="Log Analytics ワークスペースからアクセスした Log Analytics の画面"></p><p>Log Analytics は Azure Monitor メニューの [ログ] 、Log Analytics ワークスペース メニューの [ログ] から起動することができ、この場合はすべてのレコードにアクセス可能です。<br>特定の仮想マシンのログ データに絞り込んでクエリを実行したい場合、ログ クエリ内で <a href="https://learn.microsoft.com/ja-jp/azure/data-explorer/kusto/query/whereoperator">where 演算子</a>を利用することで実現できます。以下のいずれかを記述した後に実行したいクエリを続けてください。</p><ul><li><code>where Computer == &quot;コンピュータ名&quot;</code></li><li><code>where SubscriptionId == &quot;仮想マシンのサブスクリプション ID&quot;</code></li></ul><p><img src="/blog/LogAnalytics/MonitorAzVM_logs/vmFilteringQuery.png" alt="クエリ内で特定の仮想マシンのデータに絞り込むための記述"></p><h4 id="ログ-アラートを用いた監視"><a href="#ログ-アラートを用いた監視" class="headerlink" title="ログ アラートを用いた監視"></a>ログ アラートを用いた監視</h4><p>Azure Monitor ログ データに基づいてアラート ルールを作成し、仮想マシンを監視することができます。具体的には、各アラート ルールにおいてログ クエリの実行結果に対して条件を指定し、その条件を満たすときに通知やその他の自動化されたアクションを紐づけることができます。</p><p>ログ アラートは、仮想マシンの [警告] から作成を行うことができます。アラート ルール作成方法は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-new-alert-rule?tabs=metric">こちら</a>に詳細が記載されています。</p><h4 id="ログ-アラートとメトリック-アラートの違い"><a href="#ログ-アラートとメトリック-アラートの違い" class="headerlink" title="ログ アラートとメトリック アラートの違い"></a>ログ アラートとメトリック アラートの違い</h4><p>メトリック アラート ルールでは、収集されたメトリック データ (数値データ) に基づき条件を設定します。一方ログ アラート ルールでは、任意のログ クエリ実行によって返された結果に基づいた条件を設定することが可能です。<br>ログ アラートでは数値以外の情報も含めた条件設定ができるため、メトリック アラートに比べてよりそれぞれのシナリオに沿ったアラート ルールを設定することができます。<br><img src="/blog/LogAnalytics/MonitorAzVM_logs/createAlertScreen.png" alt="アラート作成画面における Log Analytics 機能の様子"></p><p>一方ログ アラートとメトリック アラートでは、ステートフルかステートレスかという違いがあります。これらの主な違いはアラートが発報されるタイミングです。</p><ul><li>ステートフル – アラートの条件を満たしたときに発報されますが、そのアラートが解決されるまでは再度条件を満たしてもアラートは発報されません。</li><li>ステートレス – アラートの条件を満たす度に発報されます。またそのアラートの解決の有無に関わらず次のアラートが発報されます。</li></ul><p>以下にそれぞれのアラートのステートフル / ステートレスのサポート状況をまとめました。デフォルトの設定がログ アラートとメトリックアラートで異なることにご注意ください。</p><table><thead><tr><th></th><th>ステートフルのサポート</th><th>デフォルトの設定</th></tr></thead><tbody><tr><td>メトリック アラート</td><td>正式にサポート</td><td><strong>ステートフル</strong>動作</td></tr><tr><td>ログ アラート</td><td>プレビューでサポート</td><td><strong>ステートレス</strong>動作</td></tr></tbody></table><p>(詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#alerts-and-state">こちら</a>の [アラートと状態] をご参照ください。)</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は Azure Monitor の機能の 1 つである Log Analytics を利用した VM 監視について紹介しました。<br>監視の主要な流れは、データの収集、データの分析、アラートの作成です。<br>仮想マシンにエージェントをインストールすることで、ゲスト OS のログやメトリックを収集します。そのうち、ログ データに対しては Log Analytics でログ クエリを実行し高度な分析を行うことができます。また、ログ アラートでは Log Analytics の機能を利用することができ、ログ クエリ実行結果に基づいたルールを作成とVM 監視が可能です。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの増塩、徳田です。&lt;/p&gt;
&lt;p&gt;今回は、Log Analytics を使って Azure VM の監視をする方法を紹介します。&lt;br&gt;VM を作成しただけではゲスト OS 上のログやメトリックなどは収集されませんが、Log Analytics の機能と組み合わせることでゲスト OS の情報が収集できるようになります。&lt;br&gt;本記事では、Log Analytics を使って情報を収集する方法と、利用例についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>仮想マシン作成時に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けを自動で行う方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/automatically_install_ama/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/automatically_install_ama/</id>
    <published>2022-09-21T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.723Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure Monitoring チームの秋田です！<br>今回は、仮想マシン (以下、VM) を作成したときに自動的に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けがされるよう設定する方法をご紹介します！</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>どうやって VM 作成時に Azure Monitor エージェントをインストールし、データ収集ルールへの関連付けを行うのか</li><li>詳細な手順</li><li>作成時の注意点</li><li>まとめ</li></ul><h2 id="どうやって-VM-作成時に-Azure-Monitor-エージェントをインストールし、データ収集ルールへの関連付けを行うのか"><a href="#どうやって-VM-作成時に-Azure-Monitor-エージェントをインストールし、データ収集ルールへの関連付けを行うのか" class="headerlink" title="どうやって VM 作成時に Azure Monitor エージェントをインストールし、データ収集ルールへの関連付けを行うのか"></a>どうやって VM 作成時に Azure Monitor エージェントをインストールし、データ収集ルールへの関連付けを行うのか</h2><p>Azure Policy の機能のひとつであるポリシー イニシアチブを作成することで、VM 作成時に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けが自動で行われるよう設定できます。<br>そもそも、ポリシー定義とは、JSON 形式で記述されたビジネス ルールのことで、 Azure Policy では、Azure 内のリソースのプロパティとポリシー定義を比較し、リソースの評価を行います。<br>そして今回用いるポリシー イニシアチブとは、複数の関連するポリシー定義をグループ化したものを指します。  </p><p>今回は、このポリシー イニシアチブにより設定する方法をご紹介します。  </p><h2 id="詳細な手順"><a href="#詳細な手順" class="headerlink" title="詳細な手順"></a>詳細な手順</h2><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>ポリシー イニシアチブを作成する際に、関連付けを行いたいデータ収集ルールのリソース ID が必要となります。<br>事前準備としてリソース ID を取得しておく必要があります。<br>以下、手順です。<br><strong>事前準備 1</strong><br>Azure ポータルで “モニター” と検索し、サービス一覧の中から [モニター] を開いてください。  </p><p><strong>事前準備 2</strong><br>[設定] メニューにあります [データ収集ルール] をクリックしてください。  </p><p><strong>事前準備 3</strong><br>一覧から自動関連付けを行いたいデータ収集ルールをクリックしてください。  </p><p><strong>事前準備 4</strong><br>[概要] ページ右上にあります [JSON ビュー] をクリックしてください。  </p><p><strong>事前準備 5</strong><br>一番上に表示されます [リソース ID] をコピーしてください。  </p><p>以上の手順で、リソース ID の取得が完了し、事前準備は終了となります。  </p><h3 id="ポリシー-イニシアチブの作成"><a href="#ポリシー-イニシアチブの作成" class="headerlink" title="ポリシー イニシアチブの作成"></a>ポリシー イニシアチブの作成</h3><p><strong>手順 1</strong><br>Azure ポータルで “ポリシー” と検索し、サービス一覧の中から [ポリシー] を開いてください。  </p><p><strong>手順 2</strong><br>[作成] メニューにあります [割り当て] をクリックしてください。  </p><p><strong>手順 3</strong><br>遷移後の画面上部にあります [イニシアティブの割り当て] をクリックしてください。  </p><p><strong>手順 4 ([基本] タブ内で行う設定)</strong><br>手順 4-1<br>まずは、[スコープ] 欄右端にある […] をクリックし、ポリシーを適用する対象の範囲 (スコープ) を設定します。<br>スコープは、サブスクリプション単位またはリソース グループ単位で設定いただけます。<br><img src="/blog/LogAnalytics/automatically_install_ama/%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97.png" alt="スコープ設定画面">  </p><p>手順 4-2<br>使用するイニシアチブ定義を設定します。<br>[イニシアティブ定義] 欄の右端にある […] をクリックしてください。<br>検索欄で、”Azure Monitor” と検索ください。<br>使用中の VM の OS に応じて下記の通りイニシアチブをご選択いただいたのち、画面下部にあります [選択] をクリックしてください。  </p><p>Windows OS の場合 -&gt; Azure Monitor エージェントを実行し、データ収集ルールに関連付けるように Windows マシンを構成する<br>Linux OS の場合 -&gt; Azure Monitor エージェントを実行し、データ収集ルールに関連付けるように Linux マシンを構成する</p><p><img src="/blog/LogAnalytics/automatically_install_ama/%E3%82%A4%E3%83%8B%E3%82%B7%E3%82%A2%E3%83%81%E3%83%96.png" alt="選択していただくイニシアチブ">  </p><p>上記の手順 4-1 および手順 4-2 が完了したら、画面下部にあります [次へ] をクリックしてください。  </p><p><strong>手順 5 ([パラメーター] タブ内で行う設定)</strong><br>[データ収集ルールのリソース ID] 欄に先ほど事前準備で取得しておいた、関連付けを行いたいデータ収集ルールのリソース ID をペーストしてください。<br>完了しましたら画面下部の [確認および作成] をクリックしてください。  </p><p>以上でポリシー イニシアチブの作成が完了となります。  </p><h2 id="作成時の注意点"><a href="#作成時の注意点" class="headerlink" title="作成時の注意点"></a>作成時の注意点</h2><p>Azure Monitor エージェントの追加を希望されない VM が存在する場合には、以下の点に注意が必要です。<br>既存の VM に対してポリシーが適用され得るタイミングとしては、以下の 2 つのいずれかが該当します。  </p><ul><li>ポリシー作成時</li><li>VM に対して更新操作があった場合 (設定値やプロパティ値などを変更する要求など)</li></ul><h3 id="ポリシー作成時"><a href="#ポリシー作成時" class="headerlink" title="ポリシー作成時"></a>ポリシー作成時</h3><p>まず、ポリシー作成時に既存の VM にポリシーが適用されないようにするためには、作成画面にて [修復タスクを作成する] のチェックを外してください。<br>(デフォルトでは、こちらのチェックは外れております。)  </p><p><img src="/blog/LogAnalytics/automatically_install_ama/%E4%BF%AE%E5%BE%A9%E3%82%BF%E3%82%B9%E3%82%AF.png" alt="修復タスク設定箇所"></p><p>これにより、既存の VM に対してポリシー作成時にポリシーが適用されることを防ぐことができます。  </p><h3 id="更新適用時"><a href="#更新適用時" class="headerlink" title="更新適用時"></a>更新適用時</h3><p>ただ、ポリシー作成時にはポリシー適用対象外となっていても、VM に対して何らかの更新操作があった場合には、一定期間後にポリシーに準拠していないリソースと評価され、ポリシーが適用される可能性があります。<br>この場合は、あらかじめポリシーを作成する際に、適用対象外としたい VM を [除外] 項目に入れておく必要があります。<br>[除外] については、 [基本] タブ内でご設定いただけます。<br><img src="/blog/LogAnalytics/automatically_install_ama/%E9%99%A4%E5%A4%96.png" alt="除外設定箇所"><br>ポリシー適用対象外として [除外] に含められるのは、スコープのレベルよりも 1 つ下のレベルとなります。<br>例えば、リソース グループをスコープとして設定している場合除外できるのはリソース単位となります。  </p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は、Azure Policy の一機能であるポリシー イニシアチブにより、VM が作成されると自動的に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けが行われるよう設定する方法をご紹介しました。<br>VM 作成時に毎回手動で Azure Monitor エージェントをインストールされていた方など、ぜひこちらの方法もご検討ください。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！ Azure Monitoring チームの秋田です！&lt;br&gt;今回は、仮想マシン (以下、VM) を作成したときに自動的に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けがされるよう設定する方法をご紹介します！&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースの正常性を示す指標の更新について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/UpdateLAHealth/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/UpdateLAHealth/</id>
    <published>2022-09-19T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.719Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Monitoring チームでサマー インターンをしております、徳田です ! </p><p>本記事は <a href="https://techcommunity.microsoft.com/t5/azure-observability-blog/improving-the-tools-for-monitoring-log-analytics-workspace/ba-p/3566634">Improbing the tools for monitoring Log Analytics workspace health</a> を元にしております。<br>今回は Log Analytics ワークスペースのリソース正常性を示す指標に関する更新についてご紹介します。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>インジェスト時間とは</li><li><em>Query succession percentage</em> (クエリ成功率) とは</li><li>今回の Log Analytics ワークスペースのリソース正常性に関する更新の概要</li><li>Log Analytics ワークスペースのリソース正常性の確認方法</li><li>Log Analytics ワークスペースのリソース正常性の状態定義</li><li>まとめ</li></ul><p>今回の更新の背景として、Log Analytics ワークスペースの正常性の重要な ２ つの指標として、<strong>インジェスト時間</strong>と <em><strong>Query succession percentage</strong></em> (クエリ成功率) を定義しました。</p><h2 id="インジェスト時間とは"><a href="#インジェスト時間とは" class="headerlink" title="インジェスト時間とは"></a>インジェスト時間とは</h2><p>インジェスト時間は、ログ データが生成されてからクエリ検索が可能になるまでにかかる時間を示しています。<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time">こちらの記事</a>にて、インジェスト時間に影響する様々な要因をご確認いただけます。</p><h2 id="Query-succession-percentage-とは"><a href="#Query-succession-percentage-とは" class="headerlink" title="Query succession percentage とは"></a><em>Query succession percentage</em> とは</h2><p><em>Query succession percentage</em> (以降、クエリ成功率) は、HTTP ステータス コードが 500 番台 “以外” のエラーが返却されるクエリの数を反映しています。この数値には Azure ログ アラートや Sentinel によって実行されるクエリは含まれません。この指標は近くリソース正常性にて確認できるようになる予定です。</p><h2 id="今回の-Log-Analytics-ワークスペースの正常性に関する更新の概要"><a href="#今回の-Log-Analytics-ワークスペースの正常性に関する更新の概要" class="headerlink" title="今回の Log Analytics ワークスペースの正常性に関する更新の概要"></a>今回の Log Analytics ワークスペースの正常性に関する更新の概要</h2><p>現在この 1 年でリリースされた機能と併せた、上記 2 つの指標の強化が進められています。<br>具体的には、<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/operation">Operation</a> テーブルが改善されました。このテーブルではユーザーがログ解析に関する問題や Log Analytics の制限に関する情報、そのたデータに関する一般的な問題を確認することができます。さらに、これらのログに基づいて<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap#alert-when-daily-cap-is-reached">アラートを作成</a>し、データ損失の可能性を知ることができます。</p><p>この <a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/reference/tables/operation">Operation</a> テーブル内のデータに基づいて、ワークスペースの正常性の指標が作成されています。Log Analytics ワークスペースの [概要] 内 [操作上の問題] 項目から、そのワークスペースの状態の概要を確認することができます。<br><img src="/blog/LogAnalytics/UpdateLAHealth/warning_status.png" alt="Azure ポータルで確認できるリソース正常性の例"></p><p>Log Analytics ワークスペースの [監視] 項目の 1 つ、<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-workspace-insights-overview">分析情報</a>からワークスペースの使用量、パフォーマンス、エージェント、クエリ、変更ログなどを確認することができます。これによりワークスペースの正常性を、パフォーマンスやインジェスト量の急増 / 急減、インジェストの待機時間、クエリ パフォーマンスの観点などから、包括的に監視することができます。</p><h2 id="Log-Analytics-ワークスペースの正常性の確認方法"><a href="#Log-Analytics-ワークスペースの正常性の確認方法" class="headerlink" title="Log Analytics ワークスペースの正常性の確認方法"></a>Log Analytics ワークスペースの正常性の確認方法</h2><p>Log Analytics ワークスペースのリソース正常性は Azure ポータル上の複数の場所で確認することができます。</p><h3 id="確認方法-1"><a href="#確認方法-1" class="headerlink" title="確認方法 1"></a>確認方法 1</h3><ol><li>Azure ポータルで “モニター” と検索し、サービス一覧の中から [モニター] を開いてください。</li><li>[サービス正常性] &gt; [Resource Health] 項目の [リソース正常性] を選択してください。</li><li>[リソースの種類] ドロップダウンから “Log Analytics” を選択・設定してください。左のカラムに各ワークスペースの状態を示すアイコンが表示されます。</li><li>より詳細な情報を確認するには、任意のワークスペースをクリックしてください。正常性の履歴が確認できます。</li></ol><h3 id="確認方法-2"><a href="#確認方法-2" class="headerlink" title="確認方法 2"></a>確認方法 2</h3><ol><li>Azure ポータルで任意の Log Analytics ワークスペースを選択してください。</li><li>[サポート + トラブルシューティング] 項目の [リソース正常性] を選択すると状態が確認できます。確認方法 1 の詳細情報と同様の内容が確認できます。</li></ol><h3 id="確認方法-3"><a href="#確認方法-3" class="headerlink" title="確認方法 3"></a>確認方法 3</h3><ol><li>Azure ポータルで任意の Log Analytics ワークスペースを選択してください。</li><li>[監視] 項目の [分析情報] をクリックし、 [正常性] タブを選択してください。可用性の状態や概要が時系列で確認できます。</li></ol><h2 id="Log-Analytics-ワークスペースの正常性の状態定義"><a href="#Log-Analytics-ワークスペースの正常性の状態定義" class="headerlink" title="Log Analytics ワークスペースの正常性の状態定義"></a>Log Analytics ワークスペースの正常性の状態定義</h2><p>今回リリースされた<a href="https://docs.microsoft.com/ja-jp/azure/service-health/resource-health-overview">リソースの正常性</a>の状態はインジェストの待ち時間を反映しており、以下の 3 つの状態で定義されます。</p><p><strong>Available</strong> - 特定の時間範囲においてインジェストの待ち時間の問題が検知されなかった状態。</p><p><strong>Degraded</strong> - 推定 1 時間以上のインジェストの待ち時間が 15 分以上続いた状態。この問題は現在緩和に向けた修正が進められています。</p><p><strong>Unknown</strong> - そのワークスペースの正常性の状態を特定することができない状態。もしくは過去 24 時間以上そのワークペースからデータがインジェストされていない状態。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回の更新により、インジェスト時間が反映された Log Analytics ワークスペースのリソース正常性が確認できるようになりました。<br>今後、リソースの正常性にはクエリ成功率の急減が反映される予定です。</p><p>また、<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-new-alert-rule?tabs=metric">こちらの記事</a>で紹介されている手順にしたがって、ワークスペースのリソース正常性の情報に基づいたアラートを作成することが推奨されています。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure Monitoring チームでサマー インターンをしております、徳田です ! &lt;/p&gt;
&lt;p&gt;本記事は &lt;a href=&quot;https://techcommunity.microsoft.com/t5/azure-observability-blog/improving-the-tools-for-monitoring-log-analytics-workspace/ba-p/3566634&quot;&gt;Improbing the tools for monitoring Log Analytics workspace health&lt;/a&gt; を元にしております。&lt;br&gt;今回は Log Analytics ワークスペースのリソース正常性を示す指標に関する更新についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Azure Monitor" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics の新機能 Basic Logs と Archived Logs について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/BasicLogsAndArchivedLogs/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/BasicLogsAndArchivedLogs/</id>
    <published>2022-08-16T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.571Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！ Azure Monitoring サポート チームの北村です。</p><p>今回は Log Analytics の新機能としてプレビューで提供されている Basic Logs と Archived Logs をご紹介いたします。<br>Log Analytics ワークスペースにログを収集しているが、コストを削減したい…という方にはお勧めしたい機能です。<br>本記事では Basic Logs と Archived Logs の概要とその設定方法をご案内します。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>Basic Logs とは</li><li>Archived Logs とは </li><li>Azure CLI コマンドを利用した Basic Logs の設定方法</li><li>Azure CLI コマンドを利用した Archived Logs の設定方法</li><li>まとめ</li></ul><h2 id="Basic-Logs-とは"><a href="#Basic-Logs-とは" class="headerlink" title="Basic Logs とは"></a>Basic Logs とは</h2><p>まず、Basic Logs のプレビュー リリースに伴い、Azure Monitor のすべての機能を使用できる Log Analytics ワークスペース内の<br>テーブルは Analytics Logs と呼ばれるようになりました。今まで Log Analytics ワークスペースに収集されていたログは<br>すべて Analytics Logs であり、デフォルトでは Analytics Logs となっています。</p><p>そして、今回の大幅なアップデートに伴い、Analytics Logs とは別に Basic Logs というプランが追加されました。<br>Basic Logs のデフォルトのデータ保有期間は 8 日間であり、クエリで使用できる演算子が限定的であったり、<br>アラートには使用できない等の制限事項がございます。<br>しかし、Azure Monitor のすべての機能を使用できないという制約がある分、Analytics Logs より安くご利用いただけます。</p><p><strong>Analytics Logs と Basic Logs の違い</strong><br>※ <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/log-analytics-workspace-overview#log-data-plans-preview">Log Analytics ワークスペースの概要 - ログ データ プラン（プレビュー）</a> より抜粋<br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image01.png"></p><p>&lt;参考&gt;</p><ul><li>Basic Logs で使用できる演算子は <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/basic-logs-query?tabs=portal-1#kql-language-limits">KQL 言語の制限</a> をご覧ください。</li><li>現在はすべてのテーブルで Basic Logs のプランを選択することはできません。サポート テーブルは <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/basic-logs-configure?tabs=cli-1,cli-2#which-tables-support-basic-logs">Basic Logs をサポートするテーブル</a> でご確認ください。</li><li>Basic Logs のご利用料金は <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor の価格</a> の [Basic ログ] をご確認ください。<br><br><br></li></ul><h2 id="Archived-Logs-とは"><a href="#Archived-Logs-とは" class="headerlink" title="Archived Logs とは"></a>Archived Logs とは</h2><p>Archived Logs は、名前のとおりログをアーカイブ領域に移動させ、長期保管するための機能です。<br>Analytics Logs は 最大 730 日、Basic Logs は 8 日間しかログを保持できませんが、<br>Archived Logs では 最大 7 年間データを保持することができます。<br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image02.png"></p><p>&lt;参考&gt;</p><ul><li>アーカイブしたデータにアクセスする場合はデータを復元するかジョブで検索する必要があります。詳細は <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/log-analytics-workspace-overview#data-retention-and-archive">データ保持とアーカイブ</a> をご確認ください。</li><li>Archived Logs のご利用料金は <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor の価格</a> をご参照ください。<br><br><br></li></ul><h2 id="Azure-CLI-コマンドを利用した-Basic-Logs-の設定方法"><a href="#Azure-CLI-コマンドを利用した-Basic-Logs-の設定方法" class="headerlink" title="Azure CLI コマンドを利用した Basic Logs の設定方法"></a>Azure CLI コマンドを利用した Basic Logs の設定方法</h2><p>それでは Basic Logs の設定をしてみましょう！<br>本記事では <code>az monitor log-analytics workspace table update</code> コマンドを使用し、テーブル単位で設定する方法をご案内します。<br>Log Analytics ワークスペース名、ワークスペースが属するリソース グループ名、テーブル名等を指定し、以下のとおり実行します。</p><p><code>az monitor log-analytics workspace table update --subscription &lt;サブスクリプション名&gt; --resource-group &lt;リソース グループ名&gt; --workspace-name &lt;ワークスペース名&gt; --name &lt;テーブル名&gt; --plan Basic</code><br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image03.png"></p><p>Azure portal から変更内容を確認することができます。Log Analytics ワークスペース から [全般] - [ログ] を選択し、<br>Basic Logs プランに変更したテーブル名をクリックすると、テーブル名の右横に <strong>基本ログ</strong> と表示されていることがわかります。<br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image04.png"></p><p>なお、Basic Logs に変更する前は、以下のとおり表示されます（Analytics Logs とは表示されません）。<br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image05.png"></p><p>また、<code>az monitor log-analytics workspace table show</code> コマンドで設定内容を確認することもできます。<br>下図の実行例では <code>plan</code> が <strong>Basic</strong> 、<code>retentionInDays</code> が <strong>8</strong> となっていることがわかります。</p><p><code>az monitor log-analytics workspace table show --subscription &lt;サブスクリプション名&gt; --resource-group &lt;リソース グループ名&gt; --workspace-name &lt;ワークスペース名&gt; --name &lt;テーブル名&gt; --output table</code><br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image06.png"></p><p>&lt;ご参考&gt;<br>Basic Logs に関する設定方法等につきましては、下記弊社公開情報にも掲載しております。<br>Azure portal から設定する手順等につきましても以下をご覧ください。</p><ul><li>Basic Logs の設定方法 : <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/basic-logs-configure?tabs=cli-1,cli-2#set-table-configuration">テーブル構成の設定</a> もご覧ください。</li><li>Basic Logs の確認方法 : <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/basic-logs-configure?tabs=cli-1,cli-2#check-table-configuration">テーブル構成の確認</a> にも掲載しております。<br><br><br></li></ul><h2 id="Azure-CLI-コマンドを利用した-Archived-Logs-の設定方法"><a href="#Azure-CLI-コマンドを利用した-Archived-Logs-の設定方法" class="headerlink" title="Azure CLI コマンドを利用した Archived Logs の設定方法"></a>Azure CLI コマンドを利用した Archived Logs の設定方法</h2><p>Basic Logs と同様に、Azure CLI コマンドで設定する方法をご紹介します。こちらもテーブル単位で指定します。</p><p><code>az monitor log-analytics workspace table update</code> コマンドには、保有期間を設定するパラメータが 2 つあります。<br><code>retention-time</code> は Basic Logs もしくは Analytics Logs として保有する期間、<br><code>total-retention-time</code> は Archived Logs としての保有期間を含めた、データの総保有期間を意味します。<br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image07.png"></p><p>以下の例では、Basic Logs を設定したテーブルに対し、 <code>total-retention-time</code> を <code>11</code> 日間に指定しています。<br>つまり、Basic Logs として 8 日間、Archived Logs として 3 日間の合計 11 日間、データが保持されることになります。</p><p><code>az monitor log-analytics workspace table update --subscription &lt;サブスクリプション名&gt; --resource-group &lt;リソース グループ名&gt; --workspace-name &lt;ワークスペース名&gt; --name &lt;テーブル名&gt; ----retention-time &lt;アーカイブされる前のデータ保有期間&gt; --total-retention-time &lt;総保有期間&gt;</code><br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image08.png"></p><p>なお、Basic Logs と同様に下記コマンドで設定内容を確認することができます。<br><code>az monitor log-analytics workspace table show --subscription &lt;サブスクリプション名&gt; --resource-group &lt;リソース グループ名&gt; --workspace-name &lt;ワークスペース名&gt; --name &lt;テーブル名&gt;</code><br><img src="/blog/LogAnalytics/BasicLogsAndArchivedLogs/image09.png"></p><p>&lt;ご参考&gt;<br>Archived Logs に関する設定方法につきましては、下記弊社公開情報にも掲載しております。<br>Azure portal から設定する手順等につきましても以下をご覧ください。</p><ul><li>Archived Logs の設定方法 : <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/data-retention-archive?tabs=cli-1,api-2#set-retention-and-archive-policy-by-table">テーブル別に保持ポリシーとアーカイブ ポリシーを設定する</a> </li><li>Archived Logs の確認方法 : <a href="https://docs.microsoft.com/ja-JP/azure/azure-monitor/logs/data-retention-archive?tabs=cli-1,cli-2#get-retention-and-archive-policy-by-table">テーブル別の保持ポリシーとアーカイブ ポリシーを取得する</a><br><br><br></li></ul><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事では、以下についてご案内いたしましたが、いかがでしたでしょうか。</p><ul><li>Basic Logs とは</li><li>Archived Logs とは </li><li>Azure CLI コマンドを利用した Basic Logs の設定方法</li><li>Azure CLI コマンドを利用した Archived Logs の設定方法</li></ul><p>本記事が少しでもお役に立ちましたら幸いです。<br>以上、Log Analytics の新しい機能 Basic Logs と Archived Logs の概要と設定方法についてお伝えしました。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！ Azure Monitoring サポート チームの北村です。&lt;/p&gt;
&lt;p&gt;今回は Log Analytics の新機能としてプレビューで提供されている Basic Logs と Archived Logs をご紹介いたします。&lt;br&gt;Log Analytics ワークスペースにログを収集しているが、コストを削減したい…という方にはお勧めしたい機能です。&lt;br&gt;本記事では Basic Logs と Archived Logs の概要とその設定方法をご案内します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics のアップグレード</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsResultsUpgrade/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsResultsUpgrade/</id>
    <published>2022-08-16T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.651Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの 北村 です。</p><p>本記事は、2022 年 4 月 4 日に米国の Azure Monitor Blog で公開された <a href="https://techcommunity.microsoft.com/t5/azure-observability-blog/log-analytics-results-upgrade/ba-p/3257229">Log Analytics results upgrade</a> を翻訳したものになります。Log Analytics ワークスペース上でログを検索する際に使用する機能について、大きなアップデートがありましたので、<br>最新情報をお届けいたします。</p><p>==========================================================================================</p><span id="more"></span><p>この記事では、Log Analytics の新しい機能の概要をご紹介いたます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>アップグレードされた機能の概要</li><li>おわりに</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>今般の大きなアップグレードに伴い、Log Analytics ワークスペースに収集したログを<br>容易に有効活用いただける新しい機能が追加されました。<br>例えば、カラムをドラッグ &amp; ドロップしてログをグループ化する機能や検索ボックスを使用したログの検索機能など、<br>Kusto クエリの知識がなくとも、より簡単にログを分析することができるようになりました。<br>また、ユーザー ビリティやパフォーマンスも改善されており、さらに進化した Log Analytics をご体感いただけるかと思います。</p><h2 id="アップグレードされた機能の概要"><a href="#アップグレードされた機能の概要" class="headerlink" title="アップグレードされた機能の概要"></a>アップグレードされた機能の概要</h2><ul><li><a href="#1-%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%94%BB%E9%9D%A2">1. クエリの実行画面</a></li><li><a href="#2-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%A8%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B7%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3">2. パフォーマンスとアクセシビリティ</a></li><li><a href="#3-%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E6%A9%9F%E8%83%BD">3. フィルタリング機能</a></li><li><a href="#4-%E3%82%BD%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD">4. ソート機能</a></li><li><a href="#5-%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E6%A9%9F%E8%83%BD">5. カスタマイズ機能</a></li><li><a href="#6-%E8%A1%8C%E3%81%A8%E3%82%BB%E3%83%AB%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">6. 行とセルのアクション</a></li><li><a href="#7-%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96">7. カラムのグループ化</a></li><li><a href="#8-%E3%83%AD%E3%82%B0%E3%81%AE%E6%A4%9C%E7%B4%A2">8. ログの検索</a></li><li><a href="#9-%E3%83%94%E3%83%9C%E3%83%83%E3%83%88-%E3%83%A2%E3%83%BC%E3%83%89">9. ピボット モード</a></li></ul><h3 id="1-クエリの実行画面"><a href="#1-クエリの実行画面" class="headerlink" title="1. クエリの実行画面"></a>1. クエリの実行画面</h3><p>Log Analytics ワークスペースに収集された機能をより有効にご利用いただくため、クエリの実行画面が新しくなりました。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/01.gif"><br><br></p><p>カラム コントロール (後述 7. 参照) はサイドバーとして再設計され、クエリの実行結果によりフォーカスできるようになりました。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/02.png"><br><br></p><p>クエリの詳細は、サイド ブレードとして表示され、実行したクエリに関するパフォーマンス指標を確認することができます。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/03-1.png"><br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/03-2.png"><br><br></p><p>従来、クエリの実行結果が多い場合は、複数のページにわたってログを確認する必要がありました。<br>しかし、今般のアップデートでページは廃止され、スクロールですべての結果を確認できるようになりました。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/04.gif"><br><br></p><h3 id="2-パフォーマンスとアクセシビリティ"><a href="#2-パフォーマンスとアクセシビリティ" class="headerlink" title="2. パフォーマンスとアクセシビリティ"></a>2. パフォーマンスとアクセシビリティ</h3><p>新しい結果セットのパフォーマンスが向上し、最大 3 万件、最大 280 カラムの結果に対して、スムーズなスクロールが可能になりました。また、アクセシビリティも向上し、より多くの方に Log Analytics を楽しんでいただけるようになりました。<br><br></p><h3 id="3-フィルタリング機能"><a href="#3-フィルタリング機能" class="headerlink" title="3. フィルタリング機能"></a>3. フィルタリング機能</h3><p>Excel のように実行結果をフィルタリングする機能が追加されました。<br>クエリを構成することなく、直感的に実行結果を絞り込むことができます。<br>以下のとおり、フィルタリングするカラムとフィルタリングする値を選択することで、ログを絞り込むことが可能です。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/05.gif"><br><br></p><h3 id="4-ソート機能"><a href="#4-ソート機能" class="headerlink" title="4. ソート機能"></a>4. ソート機能</h3><p>カラムの先頭部分をクリックするだけで、実行結果をソートできるようになりました。<br>従来のようにソートするカラムを Kusto クエリで指定する必要はありません。矢印が表示されているカラムがソートしているカラムを意味します。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/06.gif"><br><br></p><h3 id="5-カスタマイズ機能"><a href="#5-カスタマイズ機能" class="headerlink" title="5. カスタマイズ機能"></a>5. カスタマイズ機能</h3><p>実行結果をカスタマイズできるようになりました。<br>特定のカラムをピン止めしたり、カラムのサイズを自動調整したり、カラムをグループ化することができます。<br>Kusto クエリの知識がなくとも、お客様のニーズに合ったログの検索や分析ができるようになっています。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/07.png"><br><br></p><h3 id="6-行とセルのアクション"><a href="#6-行とセルのアクション" class="headerlink" title="6. 行とセルのアクション"></a>6. 行とセルのアクション</h3><p>行とセルにおいて、右クリックのアクションがサポートされました。<br>例えば、以下のとおり値のコピーができるようになっています。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/08.png"></p><h3 id="7-カラムのグループ化"><a href="#7-カラムのグループ化" class="headerlink" title="7. カラムのグループ化"></a>7. カラムのグループ化</h3><p>カラム コントロールはサイドバーとして再設計されました。<br>以下のとおりカラムをドラッグ &amp; ドロップすることで、ログの検索やカラムのグループ化ができるようになりました。</p><p>また、入力したスキーマが変更されない限り、カラムの順序やフィルタリング、ソートなど、様々な操作内容が記憶され、<br>お客様のニーズにあった検索結果をよりすばやく提供します。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/09.gif"><br><br></p><h3 id="8-ログの検索"><a href="#8-ログの検索" class="headerlink" title="8. ログの検索"></a>8. ログの検索</h3><p>クエリを構成するのではなく、UI でログを検索できるようになりました。<br>検索ボックスを使用すれば、クエリを編集することなく、必要なエントリをすばやく見つけることができます。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/10.gif"><br><br></p><h3 id="9-ピボット-モード"><a href="#9-ピボット-モード" class="headerlink" title="9. ピボット モード"></a>9. ピボット モード</h3><p>ピボット モードでは、ピボット テーブルを作成することができます。<br>ピボット モードを有効にするには、カラム コントロールで「Pivot Mode」を選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsResultsUpgrade/11.gif"><br><br></p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>アップデートされた機能の概要をご紹介しましたが、いかがでしたでしょうか。<br>もし、Log Analytics やクエリ検索の機能についてご意見やご要望などありましたら、以下ブログへのコメント、<br>または Log Analytics のフィードバック機能より頂戴いただけますと幸いです。<br> <a href="https://techcommunity.microsoft.com/t5/azure-observability-blog/log-analytics-results-upgrade/ba-p/3257229">Log Analytics results upgrade</a> </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの 北村 です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 4 月 4 日に米国の Azure Monitor Blog で公開された &lt;a href=&quot;https://techcommunity.microsoft.com/t5/azure-observability-blog/log-analytics-results-upgrade/ba-p/3257229&quot;&gt;Log Analytics results upgrade&lt;/a&gt; を翻訳したものになります。Log Analytics ワークスペース上でログを検索する際に使用する機能について、大きなアップデートがありましたので、&lt;br&gt;最新情報をお届けいたします。&lt;/p&gt;
&lt;p&gt;==========================================================================================&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics 仮想マシン拡張機能のバージョン アップ方法について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsAgentAutoUpgrade/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsAgentAutoUpgrade/</id>
    <published>2022-06-30T15:00:00.000Z</published>
    <updated>2023-06-05T08:30:55.643Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの 胡 です。</p><p>Log Analytics 仮想マシン拡張機能を利用してログの収集を行っている方がたくさんいらっしゃると思います。<br>より良いログ収集の体験ができるよう、弊社としましては常に最新バージョンの拡張機能を利用するよう、お客様にお願いしております。<br>この度、 Azure 仮想マシンで対応している拡張機能について、自動アップグレードの仕組みに大きな変更がございましたため、<br>Log Analytics 仮想マシン拡張機能のバージョン アップ方法について、ご案内させていただきます。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>対象製品</li><li>2021 年まで Log Analytics 仮想マシン拡張機能のバージョン アップについて</li><li>現在 Log Analytics 仮想マシン拡張機能のバージョン アップについて</li><li>Log Analytics 仮想マシン拡張機能のバージョン アップ手順</li><li>Windows 用の Log Analytics 仮想マシン拡張機能について</li><li>今後 Log Analytics 仮想マシン拡張機能の自動アップグレード対応について</li><li>2022 年 10 月 Linux 版 Log Analytics 仮想マシン拡張機能の変更について</li></ul><h2 id="対象製品"><a href="#対象製品" class="headerlink" title="対象製品"></a>対象製品</h2><p>Windows 用の Log Analytics 仮想マシン拡張機能</p><p><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/oms-windows?toc=/azure/azure-monitor/toc.json">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/oms-windows?toc=%2Fazure%2Fazure-monitor%2Ftoc.json</a></p><p>Linux 用の Log Analytics 仮想マシン拡張機能</p><p><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/oms-linux?toc=/azure/azure-monitor/toc.json">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/oms-linux?toc=%2Fazure%2Fazure-monitor%2Ftoc.json</a></p><h2 id="2021-年まで-Log-Analytics-仮想マシン拡張機能のバージョン-アップについて"><a href="#2021-年まで-Log-Analytics-仮想マシン拡張機能のバージョン-アップについて" class="headerlink" title="2021 年まで Log Analytics 仮想マシン拡張機能のバージョン アップについて"></a>2021 年まで Log Analytics 仮想マシン拡張機能のバージョン アップについて</h2><p>2021 年までは、新しいマイナー バージョンの Log Analytics 仮想マシン拡張機能がリリースされますと、自動的にアップデートされておりました。<br>それは、 Log Analytics エージェントを含めて、仮想マシンで対応している拡張機能に存在する AutoUpgradeMinorVersion というプロパティで実現しております。</p><p>Get-AzVMExtension コマンドを利用して、各プロパティの値をご確認いただけます。<br>以下のとおり、 Log Analytics 拡張機能の AutoUpgradeMinorVersion のプロパティは true となっております。</p><p><code>Get-AzVMExtension -ResourceGroupName &lt;リソースグループ名&gt; -VMName &lt;仮想マシン名&gt; -Name &lt;拡張機能名&gt;</code><br><img src="/blog/LogAnalytics/LogAnalyticsAgentAutoUpgrade/image01.png"></p><p>2021 年まで、 AutoUpgradeMinorVersion が true と設定されている拡張機能について、新しいマイナー バージョンがリリースされると、その情報は仮想マシンまで連携されます。<br>仮想マシンが主体的に最新バージョンのものを取得して、バージョン アップを行っておりました。<br>ですが、このバージョン アップのタイミングはきちんとコントロールされておらず、任意のタイミングで発生する可能性がございます。<br>一部のお客様から拡張機能の自動バージョン アップで自分のアプリケーションが影響されましたとの報告を受けました。<br>また、仮想マシン スケール セットの場合、すべてのインスタンスにおいて同時にバージョン アップが発生することがあるため、その影響範囲がさらに大きくなる可能性がございます。<br>以上のように、従来より安全な拡張機能のバージョン アップ方式を実現するために、今回自動アップグレードの内部処理で実装を変更いたしました。<br>Log Analytics 仮想マシン拡張機能はその実装変更の影響で、バージョン アップの方式に変更がございました。</p><h2 id="現在-Log-Analytics-仮想マシン拡張機能のバージョン-アップについて"><a href="#現在-Log-Analytics-仮想マシン拡張機能のバージョン-アップについて" class="headerlink" title="現在 Log Analytics 仮想マシン拡張機能のバージョン アップについて"></a>現在 Log Analytics 仮想マシン拡張機能のバージョン アップについて</h2><p>現在の拡張機能の仕様では、enableAutomaticUpgrade プロパティに対応していない Log Analytics 仮想マシン拡張機能はマイナー バージョンの自動アップデートが出来ません。<br>また、先程説明させていただいたとおり、AutoUpgradeMinorVersion プロパティを用いた自動的なアップデートも実施されなくなりました。<br>そのため、Log Analytics 仮想マシン拡張機能をアップデートするためには、手動でのアップデートが必須となります。</p><p>一方で、enableAutomaticUpgrade プロパティに対応している拡張機能は、下記の公開情報に記載がございます。こちらご参考いただけますと幸いです。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/automatic-extension-upgrade#supported-extensions">Azure での VM とスケール セットの拡張機能の自動アップグレード</a></li></ul><p>下記に、Log Analytics 仮想マシン拡張機能のメジャー、またはマイナー バージョンのアップデート方法について記載いたします。</p><h2 id="Log-Analytics-仮想マシン拡張機能のバージョン-アップ手順"><a href="#Log-Analytics-仮想マシン拡張機能のバージョン-アップ手順" class="headerlink" title="Log Analytics 仮想マシン拡張機能のバージョン アップ手順"></a>Log Analytics 仮想マシン拡張機能のバージョン アップ手順</h2><p>Log Analytics 仮想マシン拡張機能の最新バージョンは、 Windows と Linux でそれぞれ以下のページからご確認いただけます。</p><p><strong>Windows 用の Log Analytics 仮想マシン拡張機能</strong></p><p><a href="https://docs.microsoft.com/en-US/azure/virtual-machines/extensions/oms-windows?toc=/azure/azure-monitor/toc.json#agent-and-vm-extension-version">https://docs.microsoft.com/en-US/azure/virtual-machines/extensions/oms-windows?toc=%2Fazure%2Fazure-monitor%2Ftoc.json#agent-and-vm-extension-version</a></p><p><strong>Linux 用の Log Analytics 仮想マシン拡張機能</strong></p><p><a href="https://github.com/microsoft/OMS-Agent-for-Linux/releases">https://github.com/microsoft/OMS-Agent-for-Linux/releases</a></p><p>次に、手動バージョン アップの方法について、仮想マシン及び仮想マシン スケール セットの観点で、それぞれ手順をまとめました。</p><p><strong>仮想マシン</strong></p><ul><li>Azure ポータルを使ったバージョン アップ</li></ul><ol><li><p>拡張機能を削除する</p><ol><li>Azure ポータルにログインし、対象の VM の画面に遷移します。</li><li>中央に表示されているブレードから [拡張機能とアプリケーション] を選択し、Windows の場合は、”MicrosoftMonitoringAgent” をクリックします。</li><li>Linux の場合は、 “OmsAgentForLinux” をクリックします。</li><li>画面上部の [アンインストール] をクリックします。</li></ol></li><li><p>Log Analytics エージェントを拡張機能としてインストールする</p><ol><li>Azure ポータルにログインします。</li><li>VM が接続中のワークスペースを選択します。</li><li>[ワークスペースのデータ ソース] – [仮想マシン] をクリックします。</li><li>当該の VM を選択します。</li><li>[接続] をクリックします。</li></ol></li></ol><ul><li>PowerShell/Azure CLI を使ったバージョン アップ</li></ul><p>以下のコマンドを実行することで最新バージョンにアップデートすることが可能です (バージョンの指定は必要ございません)。</p><ol><li>PowerShell</li></ol><p><code>Set-AzVMExtension -location &lt;リージョン名&gt; -ResourceGroupName &lt;リソースグループ名&gt; -VMName &lt;仮想マシン名&gt; -Name &lt;拡張機能名&gt; -Publisher &quot;Microsoft.EnterpriseCloud.Monitoring&quot; -ExtensionType &lt;拡張機能タイプ&gt;</code></p><p>※ 拡張機能名は仮想マシンの [拡張機能とアプリケーション] 画面からご確認ください (デプロイ方法によってお客様が指定した名前になっている可能性がございます)。</p><p>※ 拡張機能タイプについて、Windows の場合は “MicrosoftMonitoringAgent” となります。</p><p>※ 拡張機能タイプについて、Linux の場合は “OmsAgentForLinux” となります。</p><ol start="2"><li>Azure CLI</li></ol><p><code>az vm extension set -n &lt;拡張機能名&gt; --publisher &quot;Microsoft.EnterpriseCloud.Monitoring&quot; --vm-name &lt;仮想マシン名&gt; --resource-group &lt;リソースグループ名&gt;</code></p><p>※ Azure CLI で設定する拡張機能名は以下指定のものにする必要がございます。</p><p>※ Windows の場合、拡張機能名は “MicrosoftMonitoringAgent” となります。</p><p>※ Linux の場合、拡張機能名は “OmsAgentForLinux” となります。</p><p><strong>仮想マシン スケール セット</strong></p><ol><li>Log Analytics エージェントの拡張機能をアンインストールする<ol><li>Azure ポータルにログインし、当該の VMSS を選択します。</li><li>[設定] – [拡張機能] を選択します。</li><li>OmsAgentForLinux を選択し、アンインストールします。</li></ol></li><li>VMSS インスタンスのアップグレードを実施する ※ VMSS のアップグレード ポリシーが手動と設定されている場合のみに実施します。<ol><li>Azure ポータルにアクセスし、対象の VMSS リソースを表示します。</li><li>[設定] – [インスタンス] をクリックし、各インスタンスにチェックし、[アップグレード] をクリックします。[はい] をクリックします。完了するまで待機します。</li></ol></li><li>VMSS の拡張機能をインストールする (Log Analytics エージェント)<ol><li>以下の Azure CLI コマンドを実行してインストールします。<br><code>az vmss extension set --name &lt;拡張機能名&gt; --publisher Microsoft.EnterpriseCloud.Monitoring --resource-group &lt;VMSS のリソース グループ名&gt; --vmss-name &lt;VMSS 名&gt; --settings &quot;&#123;&#39;workspaceId&#39;:&#39;&lt;Log AnalyticsworkspaceId&gt;&#39;&#125;&quot; --protected-settings &quot;&#123;&#39;workspaceKey&#39;:&#39;&lt;Log AnalyticsworkspaceKey&gt;&#39;&#125;&quot;</code></li></ol></li></ol><p>※ Windows の場合、拡張機能名は “MicrosoftMonitoringAgent” となります。</p><p>※ Linux の場合、拡張機能名は “OmsAgentForLinux” となります。</p><ol start="4"><li>VMSS インスタンスのアップグレードを実施する ※ VMSS のアップグレード ポリシーが手動と設定されている場合のみに実施します。<ol><li>Azure ポータルにアクセスし、対象の VMSS リソースを表示します。</li><li>[設定] – [インスタンス] をクリックし、各インスタンスにチェックし、[アップグレード] をクリックします。[はい] をクリックします。完了するまで待機します。</li></ol></li></ol><h2 id="Windows-用の-Log-Analytics-仮想マシン拡張機能について"><a href="#Windows-用の-Log-Analytics-仮想マシン拡張機能について" class="headerlink" title="Windows 用の Log Analytics 仮想マシン拡張機能について"></a>Windows 用の Log Analytics 仮想マシン拡張機能について</h2><p>Log Analytics エージェントの廃止を考慮して、現在 Windows 用の Log Analytics 仮想マシン拡張機能は、基本的にビルド番号を上げて新しいバージョンをリリースしております。<br>ビルド番号のアップグレードは、 enableAutomaticUpgrade または AutoUpgradeMinorVersion プロパティの値と関係なく、自動的に実施されます。<br>そのため、上記手順で手動でアップグレードする必要はございません。</p><p>例 : 1.0.18062 から 1.0.18064 のアップグレード</p><p><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/oms-windows?toc=/azure/azure-monitor/toc.json#agent-and-vm-extension-version">https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/oms-windows?toc=%2Fazure%2Fazure-monitor%2Ftoc.json#agent-and-vm-extension-version</a></p><p>今後もし自動アップグレードが行われない、またはマイナー バージョンのアップグレードが発生した際に、上記手順に従ってアップグレードを実施していただけますと幸いです。</p><h2 id="今後-Log-Analytics-仮想マシン拡張機能の自動アップグレード対応について"><a href="#今後-Log-Analytics-仮想マシン拡張機能の自動アップグレード対応について" class="headerlink" title="今後 Log Analytics 仮想マシン拡張機能の自動アップグレード対応について"></a>今後 Log Analytics 仮想マシン拡張機能の自動アップグレード対応について</h2><p>Log Analytics 仮想マシン拡張機能で自動アップグレードに対応してほしいとのご要望が多数お客様から上がっており、開発側にもフィードバックさせていただきました。<br>現時点で今後の開発予定がまだ決まっておりませんので、決まり次第改めて本ブログにてお知らせいたします。</p><p>また、 Log Analytics 仮想マシン拡張機能の後継となる Azure Monitor エージェント拡張機能は、新しい自動アップグレードの仕組みに対応しておりますので、こちらの利用をご検討いただけますと幸いです。</p><p>&lt;参考情報&gt;</p><p>Azure Monitor Agent 拡張機能</p><p><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-overview?tabs=PowerShellWindows">https://docs.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-overview?tabs=PowerShellWindows</a></p><h2 id="2022-年-10-月-Linux-版-Log-Analytics-仮想マシン拡張機能の変更について"><a href="#2022-年-10-月-Linux-版-Log-Analytics-仮想マシン拡張機能の変更について" class="headerlink" title="2022 年 10 月 Linux 版 Log Analytics 仮想マシン拡張機能の変更について"></a>2022 年 10 月 Linux 版 Log Analytics 仮想マシン拡張機能の変更について</h2><p>2022 年 10 月より、 Linux 版 Log Analytics 仮想マシン拡張機能は enableAutomaticUpgrade プロパティによる自動アップグレードに対応するようになりました。<br>現在 Azure ポータルより自動アップグレードの有効化は未対応ですが、 PowerShell または Azure CLI を用いて有効化することが可能となっております。</p><ol><li>PowerShell</li></ol><p><code>Set-AzVMExtension -location &lt;リージョン名&gt; -ResourceGroupName &lt;リソースグループ名&gt; -VMName &lt;仮想マシン名&gt; -Name &lt;拡張機能名&gt; -Publisher &quot;Microsoft.EnterpriseCloud.Monitoring&quot; -ExtensionType OmsAgentForLinux -EnableAutomaticUpgrade $true</code></p><p>※ 拡張機能名は仮想マシンの [拡張機能とアプリケーション] 画面からご確認ください (デプロイ方法によってお客様が指定した名前になっている可能性がございます)。</p><p>※ 自動アップブレードを無効化したい場合は、 -EnableAutomaticUpgrade の値を $false に設定します。</p><ol start="2"><li>Azure CLI</li></ol><p><code>az vm extension set -n OmsAgentForLinux --publisher &quot;Microsoft.EnterpriseCloud.Monitoring&quot; --vm-name &lt;仮想マシン名&gt; --resource-group &lt;リソースグループ名 --enable-auto-upgrade true</code></p><p>※ 自動アップブレードを無効化したい場合は、 –enable-auto-upgrade の値を false に設定します。</p><p>&lt;参考情報&gt;</p><p>エージェントをアップグレードする</p><p><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/agent-manage?tabs=PowerShellLinux#upgrade-the-agent">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/agent-manage?tabs=PowerShellLinux#upgrade-the-agent</a></p><p>Linux エージェントの自動更新を有効にする</p><p><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/agent-manage?tabs=CLILinux#enable-auto-update-for-the-linux-agent">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/agent-manage?tabs=CLILinux#enable-auto-update-for-the-linux-agent</a></p><p>以上、Log Analytics 仮想マシン拡張機能のバージョン アップの仕様についてご案内いたしました。<br>この度の仕様変更でお客様にご不便とご迷惑おかけしまして、申し訳ございません。<br>お客様によりよい製品、サービスの提供にこれまで以上に努めて参ります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの 胡 です。&lt;/p&gt;
&lt;p&gt;Log Analytics 仮想マシン拡張機能を利用してログの収集を行っている方がたくさんいらっしゃると思います。&lt;br&gt;より良いログ収集の体験ができるよう、弊社としましては常に最新バージョンの拡張機能を利用するよう、お客様にお願いしております。&lt;br&gt;この度、 Azure 仮想マシンで対応している拡張機能について、自動アップグレードの仕組みに大きな変更がございましたため、&lt;br&gt;Log Analytics 仮想マシン拡張機能のバージョン アップ方法について、ご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Automation アカウントの実行アカウントを作成するスクリプトにてエラーが発生して失敗する</title>
    <link href="https://jpazmon-integ.github.io/blog/automation/Automation-Update-AutomationRunAsCredential/"/>
    <id>https://jpazmon-integ.github.io/blog/automation/Automation-Update-AutomationRunAsCredential/</id>
    <published>2022-06-30T08:10:00.000Z</published>
    <updated>2023-06-05T08:30:55.739Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitor サポートの三輪です。<br>今回は Automation アカウントに対して実行アカウントを作成するスクリプト “Create-RunAsAccount.ps1” にて、エラーが発生する問題についてご案内させていただきます。</p><ul><li>実行アカウントを作成する PowerShell スクリプト<br><a href="https://docs.microsoft.com/ja-JP/azure/automation/create-run-as-account#powershell-script-to-create-a-run-as-account">https://docs.microsoft.com/ja-JP/azure/automation/create-run-as-account#powershell-script-to-create-a-run-as-account</a></li></ul><p>実行アカウントを作成するためにスクリプト “Create-RunAsAccount.ps1” を実行すると、以下の様なエラーが発生して失敗する場合があります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PS C:\temp&gt; .\Create-RunAsAccount.ps1 -ResourceGroup #### `</span><br><span class="line">&gt;&gt; -AutomationAccountName #### `</span><br><span class="line">&gt;&gt; -SubscriptionId #### `</span><br><span class="line">&gt;&gt; -ApplicationDisplayName #### `</span><br><span class="line">&gt;&gt; -SelfSignedCertPlainPassword #### `</span><br><span class="line">&gt;&gt; -CreateClassicRunAsAccount $false</span><br><span class="line"></span><br><span class="line">Account              SubscriptionName            TenantId                        Environment</span><br><span class="line">-------              ----------------            --------                        -----------</span><br><span class="line">####@contoso.com     #######                     XXXX-XXXX-XXXX-XXXX-XXXX        AzureCloud</span><br><span class="line"></span><br><span class="line">New-AzADApplication_CreateExpanded: C:\Program Files\WindowsPowerShell\Modules\Az.Resources\5.4.0\MSGraph.Autorest\custom\New-AzADApplication.ps1:702</span><br><span class="line">Line |</span><br><span class="line"> 702 |      $app = Az.MSGraph.internal\New-AzADApplication @PSBoundParameters</span><br><span class="line">     |      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">     | Values of identifierUris property must use a verified domain of the organization or its subdomain:</span><br><span class="line">     | &#x27;http://XXXX-XXXX-XXXX-XXXX-XXXX&#x27;</span><br><span class="line"></span><br><span class="line">New-AzADAppCredential: C:\temp\Create-RunAsAccount.ps1:42</span><br><span class="line">Line |</span><br><span class="line">  42 |  … w-AzADAppCredential -ApplicationId $Application.ApplicationId -CertVa …</span><br><span class="line">     |                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">     | Cannot process argument transformation on parameter &#x27;ApplicationId&#x27;. Cannot convert null to type</span><br><span class="line">     | &quot;System.Guid&quot;.</span><br><span class="line"></span><br><span class="line">New-AzADServicePrincipal: C:\temp\Create-RunAsAccount.ps1:44</span><br><span class="line">Line |</span><br><span class="line">  44 |  …  = New-AzADServicePrincipal -ApplicationId $Application.ApplicationId</span><br><span class="line">     |                                               ~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">     | Cannot process argument transformation on parameter &#x27;ApplicationId&#x27;. Cannot convert null to type</span><br><span class="line">     | &quot;System.Guid&quot;.</span><br><span class="line"></span><br><span class="line">Get-AzADServicePrincipal: C:\temp\Create-RunAsAccount.ps1:45</span><br><span class="line">Line |</span><br><span class="line">  45 |  … cePrincipal = Get-AzADServicePrincipal -ObjectId $ServicePrincipal.Id</span><br><span class="line">     |                                                     ~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">     | Cannot bind argument to parameter &#x27;ObjectId&#x27; because it is an empty string.</span><br><span class="line">:</span><br><span class="line">:</span><br></pre></td></tr></table></figure><p>上記エラーの原因は、Create-RunAsAccount.ps1 にて利用している New-AzADApplication コマンドが 古い identifierUris 形式になっているためです。<br>2021 年 10 月 15 日より、Azure AD に登録されるシングルテナント アプリケーションの AppId URI (identifierUris) には、<br>デフォルトのスキーム (api://{appId}) または検証済みドメインのいずれかが要求されるようになりましたが、現在公開されている Create-RunAsAccount.ps1 にはまだその内容が反映されておりません。</p><p>※ Azure AD 側の変更につきまして、以下の公開情報をご参照ください。</p><ul><li>Values of identifierUris property must use a verified domain of the organization or its subdomain エラーの対処法<br><a href="https://jpazureid.github.io/blog/azure-active-directory/aad-changes-impacting-azurecli-azureps/">https://jpazureid.github.io/blog/azure-active-directory/aad-changes-impacting-azurecli-azureps/</a></li></ul><p>また、スクリプトでは New-AzADApplication にて AAD アプリを作成し、そのアプリのアプリケーション ID を $Application.ApplicationId にて取得しております。<br>これも誤った記述となっており、アプリケーション ID を取得するためには、$Application.AppId と記述する必要があります。<br>この記述の間違いにより、New-AzADAppCredential 等のコマンドにおいてエラーが発生している状況です。</p><p>これらの問題に対応するため、変更を行ったスクリプトを以下にご案内いたします。<br>お手数をおかけしますが、上記エラーが発生する場合は、以下のスクリプトに置き換えて実行いただければと存じます。</p><p><a href="./Create-RunAsAccount_new.zip">Create-RunAsAccount_new.zip</a></p><p>なお、現時点では Automation アカウントの認証では実行アカウントではなく、マネージド ID を推奨しております。<br>マネージド ID の利点としては、実行アカウントの様に証明書を更新する必要がないこと、実行アカウントよりセキュアな認証であることがあげられます。</p><p>マネージド ID については、以下の Blog にてご案内しております。こちらも是非ご覧下さい。</p><ul><li>実行アカウントとマネージド ID の違いについて<br><a href="https://jpazmon-integ.github.io/blog/automation/DifferenceRunAsAccountAndManagedID/">https://jpazmon-integ.github.io/blog/automation/DifferenceRunAsAccountAndManagedID/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitor サポートの三輪です。&lt;br&gt;今回は Automation アカウントに対して実行アカウントを作成するスクリプト “Create-RunAsAccount.ps1” にて、エラーが発生する問題についてご案内させていただきます。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="Automation" scheme="https://jpazmon-integ.github.io/blog/tags/Automation/"/>
    
    <category term="RunAs Account" scheme="https://jpazmon-integ.github.io/blog/tags/RunAs-Account/"/>
    
  </entry>
  
</feed>
