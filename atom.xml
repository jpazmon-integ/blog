<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Monitoring Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Monitoring に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazmon-integ.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazmon-integ.github.io/blog/"/>
  <updated>2024-09-18T01:17:22.139Z</updated>
  <id>https://jpazmon-integ.github.io/blog/</id>
  
  <author>
    <name>Japan Azure Monitoring Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>メトリック アラート ルールで NULL を検知することはできない</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnableToDetectNullMetric/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/UnableToDetectNullMetric/</id>
    <published>2024-09-17T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.139Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回はメトリックがない (NULL) 場合のメトリック アラート ルールの動作について説明します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%81%8C-NULL-%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%A8%E3%81%AF">2. メトリックが NULL の状態とは</a></li><li><a href="#3-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%81%8C-NULL-%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF%E8%A9%95%E4%BE%A1%E3%81%8C%E3%82%B9%E3%82%AD%E3%83%83%E3%83%97%E3%81%95%E3%82%8C%E3%82%8B">3. メトリックが NULL の場合は評価がスキップされる</a></li><li><a href="#4-%E3%81%BE%E3%81%A8%E3%82%81">4. まとめ</a><br></li></ul><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#metric-alerts">メトリック アラート ルール</a>でテストを実施したが、しきい値を満たしている状況なのに想定どおりに発報しない・・・というお問い合わせをいただくことがございます。このようなときにご確認いただきたい点は「メトリックが出力されているかどうか」です。<br>本ブログのタイトルのとおり、メトリック アラート ルールでは「NULL」を検知することはできません。対象の評価期間の間、メトリックが NULL の場合は、アラート ルールが評価をスキップするためです。一方で、評価期間中に一度でも値が記録された場合は、その値をもとに評価が実行されます (評価はスキップされません)。</p><br><h2 id="2-メトリックが-NULL-の状態とは"><a href="#2-メトリックが-NULL-の状態とは" class="headerlink" title="2. メトリックが NULL の状態とは"></a>2. メトリックが NULL の状態とは</h2><p>メトリックが「NULL」の状態は、メトリックが何も出力されていないことを意味します。<br>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#null-and-zero-values">弊社公開情報</a> をご参照いただきたく存じますが、NULL はゼロ値とは異なります。</p><p>ここでは Azure VM の<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/monitor-vm-reference#vm-availability-metric-preview">可用性メトリック ‘VM Availability Metric (Preview)’</a> を、折れ線グラフで描画した例に説明します。<br>この<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/VMAvailability-MetricAlert/#2-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%81%A8%E3%81%AF">メトリック</a>では VM が実行中の場合は 1 が記録されますが、Azure VM が “停止済み (割り当て解除)” の場合はメトリックの値が NULL になります。</p><p>VM が実行している間は 1 が記録されます。<br><img src="/blog/AzureMonitorEssential/UnableToDetectNullMetric/image01.png"></p><p>一方で、VM が “停止済み (割り当て解除)” の場合はメトリックが記録されず、破線となっていることがわかります。<br><img src="/blog/AzureMonitorEssential/UnableToDetectNullMetric/image02.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>メトリック エクスプローラーの使い方は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics">弊社公開情報</a> をご参照ください。また、エクスプローラー上で確認した際に値が 0 と表示されていても、アラート ルールの評価時には NULL と認識されるメトリックもございます。メトリックが NULL と判定されたことにより評価がスキップされていると推測される場合には、一度対象のメトリックを意図的に記録いただき、アラートが検知するかどうかをご確認いただきますようお願いいたします。</p></div><br><h2 id="3-メトリックが-NULL-の場合は評価がスキップされる"><a href="#3-メトリックが-NULL-の場合は評価がスキップされる" class="headerlink" title="3. メトリックが NULL の場合は評価がスキップされる"></a>3. メトリックが NULL の場合は評価がスキップされる</h2><p>冒頭でもお伝えしたとおり、メトリック アラート ルールは、評価期間の間、メトリックがずっと NULL の場合は評価をスキップします。以下に例を示します。</p><p><strong>例 1.</strong><br>00:00  NULL<br>00:01  NULL<br>00:02  NULL<br>00:03  NULL<br>00:04  NULL</p><p>例えば、上記のようにメトリックが出力されていない状況だったとします。<br>この状態で、アラート ルールが 00:00 ~ 00:04 のメトリックを対象に評価したとします。<br>このとき、対象の期間メトリックはずっと NULL のため、アラート ルールはこの評価をスキップします。このため、アラートを検知することはありません。</p><p><strong>例 2.</strong><br>00:00  NULL<br>00:01  1<br>00:02  NULL<br>00:03  0<br>00:04  NULL</p><p>例えば、00:01 と 00:03 にメトリックが記録され、それ以外は NULL だったとします。<br>この状態で、アラート ルールが 00:00 ~ 00:04 のメトリックを対象に評価した場合は、00:01 と 00:03 の値をもとに評価が実行されますので、アラート ルールの評価はスキップされません。</p><br><h2 id="4-まとめ"><a href="#4-まとめ" class="headerlink" title="4. まとめ"></a>4. まとめ</h2><p>メトリック アラート ルールにてテストを実施された際には、メトリックが出力されているかどうかをご確認ください。<br>もし期待どおりメトリックが出力されていなかった場合は、メトリックが出力されるように一度意図的に Azure リソースを操作ください。メトリックの出力条件について詳細を知りたい場合は、お手数ですが対象の Azure サービス観点でメトリックに関するお問合せをご起票ください。お問合せいただく際には、「なぜメトリックの出力条件が知りたいのか?」について背景をご共有いただくとスムーズなコミュニケーションが期待出来ます。</p><p><strong>&lt;お問い合わせ文の例&gt;</strong><br>Azure VM の可用性メトリックを監視するメトリック アラート ルールの動作検証を実施したい。<br>メトリック値が 1 になる条件は分かるが 0 になる条件が分からず、メトリック アラート ルールの動作検証のために可用性メトリックが 0 となる条件について知りたいです。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回はメトリックがない (NULL) 場合のメトリック アラート ルールの動作について説明します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="MetricAlert" scheme="https://jpazmon-integ.github.io/blog/tags/MetricAlert/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのコスト増加の原因を分析しコスト削減を検討する</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToManageLogAnalyticsBilling/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToManageLogAnalyticsBilling/</id>
    <published>2024-09-17T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.247Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、Log Analytics ワークスペースのコストの管理方法 (コスト増加原因の調査、コストを抑える方法) についてご説明します。  </p><p>なお、Azure Monitor のコスト最適化、および Log Analytics ワークスペースの使用量の分析については、以下弊社サイトもご参照ください。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost">https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost</a><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li><li><a href="#1-%E3%82%B3%E3%82%B9%E3%83%88%E5%A2%97%E5%8A%A0%E3%81%AE%E5%8E%9F%E5%9B%A0%E3%82%92%E5%88%86%E6%9E%90%E3%81%99%E3%82%8B">1. コスト増加の原因を分析する</a></li><li><a href="#1-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1. データのインジェスト量の推移を確認する</a><ul><li><a href="#1-1-1-%E4%BD%BF%E7%94%A8%E9%87%8F%E3%81%A8%E6%8E%A8%E5%AE%9A%E3%82%B3%E3%82%B9%E3%83%88-%E3%81%8B%E3%82%89%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1-1. [使用量と推定コスト] から確認する</a></li><li><a href="#1-1-2-%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1-2. クエリを実行して確認する</a></li></ul></li><li><a href="#1-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-2. データの保有量の推移を確認する</a></li><li><a href="#1-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3. データの保有期間を確認する</a><ul><li><a href="#1-3-1-azure-portal-%E3%81%8B%E3%82%89%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3-1. Azure portal から確認する</a></li><li><a href="#1-3-2-powershell-%E3%81%BE%E3%81%9F%E3%81%AF-azure-cli-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3-2. PowerShell または Azure CLI を使用して確認する</a></li><li><a href="#1-3-3-api-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3-3. API を使用して確認する</a></li></ul></li><li><a href="#2-%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">2. コストを抑える</a></li><li><a href="#2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">2-1. データのインジェストにかかるコストを抑える</a><ul><li><a href="#2-1-1-%E4%B8%8D%E8%A6%81%E3%81%AA%E3%83%AD%E3%82%B0%E3%81%AE%E5%8F%8E%E9%9B%86%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B">2-1-1. 不要なログの収集を停止する</a></li><li><a href="#2-1-2-%E6%97%A5%E6%AC%A1%E4%B8%8A%E9%99%90%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%82%92%E4%B8%80%E5%AE%9A%E9%87%8F%E3%81%BE%E3%81%A7%E3%81%AB%E6%8A%91%E3%81%88%E3%82%8B">2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える</a></li></ul></li><li><a href="#2-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%8C%81%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">2-2. データの保持にかかるコストを抑える</a><ul><li><a href="#2-2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">2-2-1. データの保有期間を調整する</a></li><li><a href="#2-2-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E9%87%8F%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">2-2-2. データの保有量を調整する</a></li></ul></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Log Analytics ワークスペースは、データの収集と分析において非常に強力なツールです。<br>しかし、そのコストは収集するデータの量によって大きく変動します。<br>本ブログでは、Log Analyticsワークスペースのコスト管理方法について詳しく解説します。<br>データインジェストのコストを最適化し、予期しない請求を避けるためのベストプラクティスを紹介します。</p><h2 id="1-コスト増加の原因を分析する"><a href="#1-コスト増加の原因を分析する" class="headerlink" title="1. コスト増加の原因を分析する"></a>1. コスト増加の原因を分析する</h2><p>Log Analytics ワークスペースのコストが増加している場合、まずはじめに行うことはコスト増加の原因を分析することです。<br>Log Analytics ワークスペースのコストは主に以下 3 点によって決まります。</p><ul><li>データのインジェスト量</li><li>データの保有量と保有期間  </li><li>Log Analytics ワークスペースが存在するリージョン  </li></ul><p>このうち、コスト増加の原因となりうるのは、データのインジェスト量およびデータの保有量と保有期間です。<br>したがって、コスト増加の主な原因を分析するためには、以下の情報を得る必要があります。</p><ul><li>データのインジェスト量の推移</li><li>データの保有量の推移</li><li>データの保有期間</li></ul><p>それぞれの確認方法について、ご説明します。</p><h3 id="1-1-データのインジェスト量の推移を確認する"><a href="#1-1-データのインジェスト量の推移を確認する" class="headerlink" title="1-1. データのインジェスト量の推移を確認する"></a>1-1. データのインジェスト量の推移を確認する</h3><p>Log Analytics ワークスペースごとのデータのインジェスト量の推移を確認する方法は、主に以下 2 つです。</p><ul><li>[使用量と推定コスト] から確認する方法</li><li>クエリを実行して確認する方法</li></ul><h4 id="1-1-1-使用量と推定コスト-から確認する"><a href="#1-1-1-使用量と推定コスト-から確認する" class="headerlink" title="1-1-1. [使用量と推定コスト] から確認する"></a>1-1-1. [使用量と推定コスト] から確認する</h4><ul><li>Azure portal で、コストを確認したい Log Analytics ワークスペースを開きます。</li><li>左ペインの [設定] &gt; [使用量と推定コスト] を押下します。</li><li>ページ右側に “使用状況のグラフ” として、過去 31 日間の、課金対象のテーブルごとのデータ インジェスト量が表示されます。  </li></ul><p><img src="/blog/LogAnalytics/HowToManageLogAnalyticsBilling/portal-ingest-barchart.png"></p><h4 id="1-1-2-クエリを実行して確認する"><a href="#1-1-2-クエリを実行して確認する" class="headerlink" title="1-1-2. クエリを実行して確認する"></a>1-1-2. クエリを実行して確認する</h4><ol><li>Azure portal で、コストを確認したい Log Analytics ワークスペースを開きます。</li><li>左ペインの [ログ] を押下し、以下いずれかのクエリを実行します。</li></ol><p>(過去 31 日間のログのインジェスト量を日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let days = 31d;</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= startofday(ago(days))</span><br><span class="line">| where StartTime &gt;= startofday(ago(days)) and EndTime &lt; startofday(now())</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| make-series TotalIngestedData = sum(Quantity) / 1.0E3 default=0 on TimeGenerated from startofday(ago(days)) to startofday(now()) step 1d by DataType</span><br><span class="line">| project TimeGenerated, DataType, TotalIngestedData</span><br><span class="line">| render columnchart </span><br></pre></td></tr></table></figure><p>(過去 3 か月のログのインジェスト量を、31 日ごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let days = 93d;</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= startofday(ago(days))</span><br><span class="line">| where StartTime &gt;= startofday(ago(days))</span><br><span class="line">| where IsBillable</span><br><span class="line">| summarize IngestedGB=sum(Quantity) / 1.0E3 by DataType, bin(StartTime, 31d)</span><br><span class="line">| project StartTime, DataType, IngestedGB</span><br><span class="line">| render columnchart</span><br></pre></td></tr></table></figure><p>(指定した期間のログのインジェスト量を、日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">let StartDate = datetime(YYYY-MM-DD);</span><br><span class="line">let EndDate = datetime(YYYY-MM-DD);</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= StartDate and TimeGenerated &lt; EndDate</span><br><span class="line">| where StartTime &gt;= StartDate and EndTime &lt; EndDate</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| make-series TotalIngestedData = sum(Quantity) / 1.0E3 default=0 on TimeGenerated from StartDate to EndDate step 1d by DataType</span><br><span class="line">| project TimeGenerated, DataType, TotalIngestedData</span><br><span class="line">| render columnchart </span><br></pre></td></tr></table></figure><p>(指定した期間のログのインジェスト量を、月ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">let StartDate = datetime(YYYY-MM-DD);</span><br><span class="line">let EndDate = datetime(YYYY-MM-DD);</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= StartDate and TimeGenerated &lt; EndDate</span><br><span class="line">| where StartTime &gt;= StartDate and EndTime &lt; EndDate</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| make-series TotalIngestedData = sum(Quantity) / 1.0E3 default=0 on TimeGenerated from StartDate to EndDate step 31d by DataType</span><br><span class="line">| project TimeGenerated, DataType, TotalIngestedData</span><br><span class="line">| render columnchart </span><br></pre></td></tr></table></figure><ol start="3"><li>結果を確認します。特に以下の項目について確認します。</li></ol><ul><li>特定のテーブルへのログのインジェスト量が多い場合 → <a href="#2-1-1-%E4%B8%8D%E8%A6%81%E3%81%AA%E3%83%AD%E3%82%B0%E3%81%AE%E5%8F%8E%E9%9B%86%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%99%E3%82%8B">2-1-1. 不要なログの収集を停止する</a> をご確認ください。</li><li>ログのインジェスト量が上昇していた場合 → <a href="#2-1-2-%E6%97%A5%E6%AC%A1%E4%B8%8A%E9%99%90%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%82%92%E4%B8%80%E5%AE%9A%E9%87%8F%E3%81%BE%E3%81%A7%E3%81%AB%E6%8A%91%E3%81%88%E3%82%8B">2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える</a> をご確認ください。</li></ul><h3 id="1-2-データの保有量の推移を確認する"><a href="#1-2-データの保有量の推移を確認する" class="headerlink" title="1-2. データの保有量の推移を確認する"></a>1-2. データの保有量の推移を確認する</h3><p>以下では、データのインジェスト量を累積し、データの保有量の推移を可視化するためのクエリをご紹介します。<br>インジェスト量が増加傾向にあるわけではないものの、コストの増加が見られる場合は、保有量が増加している可能性が高いです。 </p><ol><li>Azure portal で、コストを確認したい Log Analytics ワークスペースを開きます。</li><li>左ペインの [ログ] を押下し、以下いずれかのクエリを実行します。</li></ol><p>(過去 31 日間のデータの保有量の推移を日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= startofday(ago(31d))</span><br><span class="line">| where IsBillable</span><br><span class="line">| summarize DailyIngestedGB=sum(Quantity) / 1.0E3 by DataType, bin(TimeGenerated, 1d)</span><br><span class="line">| sort by TimeGenerated asc</span><br><span class="line">| extend CumulativeIngestedGB = row_cumsum(DailyIngestedGB)</span><br><span class="line">| project TimeGenerated, DataType, CumulativeIngestedGB</span><br><span class="line">| render timechart</span><br></pre></td></tr></table></figure><p>(指定した期間のデータの保有量の推移を日ごと、課金対象のテーブルごとに確認したい場合)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let StartDate = datetime(YYYY-MM-DD);</span><br><span class="line">let EndDate = datetime(YYYY-MM-DD);</span><br><span class="line">Usage</span><br><span class="line">| where TimeGenerated &gt;= StartDate and TimeGenerated &lt; EndDate</span><br><span class="line">| where StartTime &gt;= StartDate and EndTime &lt; EndDate</span><br><span class="line">| where IsBillable == true</span><br><span class="line">| summarize DailyIngestedGB=sum(Quantity) / 1.0E3 by DataType, bin(TimeGenerated, 1d)</span><br><span class="line">| sort by TimeGenerated asc</span><br><span class="line">| extend CumulativeIngestedGB = row_cumsum(DailyIngestedGB)</span><br><span class="line">| project TimeGenerated, DataType, CumulativeIngestedGB</span><br><span class="line">| render timechart</span><br></pre></td></tr></table></figure><ol start="3"><li>結果を確認します。</li></ol><ul><li>インジェスト量が増加してるわけではないものの、保有量が増加傾向にある場合 → まずは後述の<a href="#1-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-3. データの保有期間を確認する</a>で、各テーブルの保有期間を確認します。</li></ul><h3 id="1-3-データの保有期間を確認する"><a href="#1-3-データの保有期間を確認する" class="headerlink" title="1-3. データの保有期間を確認する"></a>1-3. データの保有期間を確認する</h3><p>データの保持期間は、テーブルごとに設定することが可能です。</p><ul><li><a href="#1-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1. データのインジェスト量の推移を確認する</a>で他に比べてインジェスト量が多いテーブルは、保有されるログ量も多いため、保有期間の長さがコスト増加に寄与する可能性があります。</li><li><a href="#1-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E9%87%8F%E3%81%AE%E6%8E%A8%E7%A7%BB%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">1-1. データのインジェスト量の推移を確認する</a>で増加傾向にあったテーブルの保有期間を見直すことで、将来的なコスト増加を抑制できる可能性があります。</li></ul><p>各テーブルの保持設定は、Azure portal, API, CLI, PowerShell を使用して確認することができます。</p><h4 id="1-3-1-Azure-portal-から確認する"><a href="#1-3-1-Azure-portal-から確認する" class="headerlink" title="1-3-1. Azure portal から確認する"></a>1-3-1. Azure portal から確認する</h4><ol><li>Azure portal で任意の Log Analytics ワークスペースを開きます。</li><li>左ペインの [設定] &gt; [テーブル] を押下します。</li><li>Log Analytics ワークスペース内に存在するテーブルの一覧が表示されます。<br>“対話型の保持” と “保有期間の合計” 列から保持期間の設定を確認することが可能です。<br>(長期保持期間は “保有期間の合計” から “対話型の保持” を差し引いた値です。)</li></ol><p>特定のテーブルについてのみ確認する場合は、以下の方法でも可能です。</p><h4 id="1-3-2-PowerShell-または-Azure-CLI-を使用して確認する"><a href="#1-3-2-PowerShell-または-Azure-CLI-を使用して確認する" class="headerlink" title="1-3-2. PowerShell または Azure CLI を使用して確認する"></a>1-3-2. PowerShell または Azure CLI を使用して確認する</h4><ol><li>PowerShell を開きます。</li><li>以下いずれかのコマンドを実行します。<br>この際、&lt;&gt; の箇所は任意の値に変更します (“&lt;&gt;” は不要です)。<br>■ PowerShell の場合<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-AzOperationalInsightsTable -ResourceGroupName &lt;リソース グループ名&gt; -WorkspaceName &lt;ワークスペース名&gt; -tableName &lt;テーブル名&gt;</span><br><span class="line">```  </span><br><span class="line">■ Azure CLI の場合</span><br></pre></td></tr></table></figure>az monitor log-analytics workspace table show –resource-group &lt;リソース グループ名&gt; –workspace-name &lt;ワークスペース名&gt; –name &lt;テーブル名&gt;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">3. 結果を確認します。  </span><br><span class="line">   返ってきた結果のうち、`RetentionInDays` が対話型の保有期間を、`TotalRetentionInDays` が保有期間の合計を示します。  </span><br><span class="line">   (Azure CLI の場合はそれぞれ `retentionInDays`, `totalRetentionInDays` です。)  </span><br><span class="line">   保有期間が長く、再設定が必要なテーブルが見つかった場合 → [1-3. データの保有期間を確認する](#1-3-データの保有期間を確認する)をご確認ください。</span><br><span class="line"></span><br><span class="line">#### 1-3-3. API を使用して確認する</span><br><span class="line">以下の Get API を呼び出すことでも、上記と同様に、指定したテーブルの情報を取得することができます。  </span><br><span class="line">なお、&#123;&#125; の箇所は任意の値に変更してください (&quot;&#123;&#125;&quot; は不要です)。</span><br></pre></td></tr></table></figure>GET “<a href="https://management.azure.com/subscriptions/%7B%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">https://management.azure.com/subscriptions/{サブスクリプション</a> ID}/resourceGroups/{リソース グループ名}/providers/Microsoft.OperationalInsights/workspaces/{ワークスペース名}/Tables/{テーブル名}?api-version=2022-10-01”<br>```</li></ol><p>なお、保有期間については、以下弊社サイトでもご案内しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-configure?tabs=portal-3,portal-1,portal-2">Log Analytics ワークスペース内のデータ保持を管理する</a></p><h2 id="2-コストを抑える"><a href="#2-コストを抑える" class="headerlink" title="2. コストを抑える"></a>2. コストを抑える</h2><p><a href="#1-%E3%82%B3%E3%82%B9%E3%83%88%E5%A2%97%E5%8A%A0%E3%81%AE%E5%8E%9F%E5%9B%A0%E3%82%92%E5%88%86%E6%9E%90%E3%81%99%E3%82%8B">1. コスト増加の原因を分析する</a>により、コスト増加の原因が明らかになった場合は、その原因に応じて、コストを抑えるための対処法を実行します。</p><h3 id="2-1-データのインジェストにかかるコストを抑える"><a href="#2-1-データのインジェストにかかるコストを抑える" class="headerlink" title="2-1. データのインジェストにかかるコストを抑える"></a>2-1. データのインジェストにかかるコストを抑える</h3><p>データのインジェストにかかるコストは、データのインジェスト量によって決まります。<br>そのため、データのインジェストにかかるコストを抑えるためには、インジェスト量を減らす必要があります。</p><h4 id="2-1-1-不要なログの収集を停止する"><a href="#2-1-1-不要なログの収集を停止する" class="headerlink" title="2-1-1. 不要なログの収集を停止する"></a>2-1-1. 不要なログの収集を停止する</h4><p>インジェスト量を減らすためにまずはじめに検討できることは、不要なログの収集を停止することです。  </p><p>以下は、不要なログの収集を停止する主な例です。  </p><p>■ <strong>データ収集ルールをカスタマイズして不要なデータの収集を減らす</strong><br>Azure Monitor エージェントとデータ収集ルールを用いたデータ収集を行っている場合、以下のログについては設定を変えることで、収集・監視が必要なログのみを Log Analytics ワークスペース内に収集することができます。</p><ul><li>パフォーマンス カウンター</li><li>Windows イベント ログ</li><li>Linux Syslog</li></ul><p>ログ収集設定をカスタマイズする方法については、以下弊社サイト、およびサポート チームのブログをご参照ください。</p><p><strong>パフォーマンス カウンター</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance#configure-performance-counters-data-source">パフォーマンス カウンター データ ソースを構成する</a></li><li><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/">既定で用意されているもの以外のパフォーマンス カウンターを収集する方法</a></li></ul><p><strong>Windows イベント ログ</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events#configure-windows-event-data-source">Windows イベント データ ソースを構成する</a></li><li><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomEventlog/">既定で用意されているもの以外のイベント ログを収集する方法</a></li></ul><p><strong>Linux Syslog</strong></p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-syslog#configure-collection-of-syslog-data">Syslog データの収集を構成する</a><br><img src="/blog/LogAnalytics/HowToManageLogAnalyticsBilling/docs-syslog.png"></li></ul><p>■ <strong>Application Insights のサンプリング機能を用いて収集ログを減らす</strong></p><p>Application Insights では、サンプリング機能が実装されております。<br>このサンプリング機能では、アプリケーションから出力されるテレメトリ データの出力量を抑えることが出来ます。<br>サンプリングを使用することで、APM に必要なデータをコストの観点で効率的に収集出来ます。<br>もし Application Insights に紐づくデータのコストを抑えたい要望がある場合は、一度サンプリング機能をご検討ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/sampling-classic-api">Sampling in Application Insights</a></li></ul><p>■ <strong>Container Insights の収集設定をカスタマイズして不要なデータの収集を減らす</strong><br>Container Insights を有効化していただくことで、AKS や Azure Arc enabled k8s から、コンテナに関するログやパフォーマンス情報を、Log Analytics ワークスペースに収集することが可能です。<br>一方で Container Insights のログ収集設定によっては収集されるログが増え、コスト増加に繋がります。<br>もし不要な Container Insights に関連するログが存在する場合は、Container Insights のログ収集設定の見直しをご検討ください。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-data-collection-configure?tabs=portal">Configure log collection in Container insights</a></li></ul><h4 id="2-1-2-日次上限を設定しデータのインジェスト量を一定量までに抑える"><a href="#2-1-2-日次上限を設定しデータのインジェスト量を一定量までに抑える" class="headerlink" title="2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える"></a>2-1-2. 日次上限を設定しデータのインジェスト量を一定量までに抑える</h4><p>Log Analytics ワークスペースに日次上限とは、1 日あたりのデータのインジェスト量の上限値を指します。<br>一時的なインジェスト量の上昇がみられた場合、日次上限を設定することで予期しないインジェスト量の増加を防ぐことができます。  </p><p>1 日のデータのインジェスト量が日次上限に達すると、その日の残りの時間は、課金対象のデータの収集が自動的に停止します (*1)。</p><div class="alert is-important"><p class="alert-title">重要</p><p>(*1) データ収集が停止すると、以下の影響が起こりうることをご確認の上、日次上限を設定してください。  </p><ul><li>リソースの正常性の状態を観察したり、アラートを受信したりする機能に影響が出る可能性</li><li>ワークスペースで利用できる最新のデータに機能が依存している他の Azure サービスやソリューションに影響を与える可能性  </li></ul></blockquote><p>日次上限については、以下弊社サイトでもご案内しております。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap">Log Analytics ワークスペースの日次上限を設定する</a></li></ul><h3 id="2-2-データの保持にかかるコストを抑える"><a href="#2-2-データの保持にかかるコストを抑える" class="headerlink" title="2-2. データの保持にかかるコストを抑える"></a>2-2. データの保持にかかるコストを抑える</h3><p>データの保持に対してかかるコストは、保有期間と保持するデータ量に基づいて決定します。</p><p>保持するデータ量は、データのインジェスト量とその保有期間によって決まるため、データ保持にかかるコストを抑えるためには、まずは前述の<a href="#2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E3%82%B3%E3%82%B9%E3%83%88%E3%82%92%E6%8A%91%E3%81%88%E3%82%8B">データのインジェスト量の見直し</a>と、以下でご案内する、<a href="#2-2-1-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E6%9C%9F%E9%96%93%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">保有期間の調整</a>が有効です。</p><h4 id="2-2-1-データの保有期間を調整する"><a href="#2-2-1-データの保有期間を調整する" class="headerlink" title="2-2-1. データの保有期間を調整する"></a>2-2-1. データの保有期間を調整する</h4><p>Log Analytics ワークスペース内のデータは、対話型保持と長期保持のいずれかの状態で保持されます。</p><ul><li>対話型保持 : この状態では、データは監視、トラブルシューティング、ほぼリアルタイムの分析に利用できます。各種データには無料の対話型保持期間が設けられています (*2)。</li><li>長期保持 (アーカイブ) : 対話型保持よりも低コストでデータを保持できます。ただし、データに対するアクセス方法に、制限があります (*3)。</li></ul><p>そして、各テーブルに対して、対話型保持と長期保持の期間を設定することができ、対話型保持期間が終了したデータは、長期保持されます (対話型保持期間と長期保持期間の合計は最大 12 年に設定可能です)。</p><p>テーブル プランによって、設定できる最大の対話型保持期間が異なります。</p><p>分析プランでは、テーブルの対話型保持期間を最大 2 年間まで延長できます。</p><p>基本プランと補助プランの対話型保持期間は 30 日間に固定されています。</p><blockquote><p>[!NOTE]</p><p>(*2) 各種データには、無料の対話型保持期間が設けられています。</p><p>この無料期間を超えて Log Analytics ワークスペース内にデータを保有するためには、費用がかかります。</p><p><img src="/blog/LogAnalytics/HowToManageLogAnalyticsBilling/dataretention-cost.png">  </p></div><div class="alert is-important"><p class="alert-title">重要</p><p>(*3) 以下のことは、対話型保持されているデータに対してのみ実行でき、長期保持されているデータに対しては実行できません。  </p><ul><li>クエリを通したデータ取得  </li><li>テーブル プランに基づいた視覚化、アラート、およびその他の機能やサービスでのデータ利用  </li><li>長期保持されているデータに対してアクセスするためには、検索ジョブの実行、またはログの復元が必要です。</p><p>検索ジョブの実行、またはログの復元には別途費用がかかります。<ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/search-jobs?tabs=portal-1,portal-2">Azure Monitor で検索ジョブを実行する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/restore?tabs=api-1">Azure Monitor でログを復元する</a></li><li>それぞれにかかる費用は、<a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor の価格</a>の “ジョブの検索”、”復元” の項目をご確認ください。</li></ul></li></ul></blockquote><h4 id="2-2-2-データの保有量を調整する"><a href="#2-2-2-データの保有量を調整する" class="headerlink" title="2-2-2. データの保有量を調整する"></a>2-2-2. データの保有量を調整する</h4><p>データの保有量を削減するためにできるもう一つの方法は、現在保有しているワークスペース内のデータをストレージ アカウントにエクスポートし、ワークスペース内のデータを削除することです。</p><p>ストレージ アカウントの価格 (*4) は、<a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Log Analytics ワークスペースの保有料金</a>よりも低価格なため、収集したデータに対して対話型クエリを実行する予定がない場合は、ストレージ アカウントにデータをエクスポート (移動) し、ワークスペース内のデータを削除することで、コストを抑えられます。 </p><p>以下に、ストレージ アカウントまたは Event Hubs にログを送信する 2 つの方法と、Log Analytics ワークスペース内のデータを削除する方法をご紹介します。</p><p>■ <strong>データ エクスポート ルールを利用してエクスポートする</strong></p><ul><li>選択したテーブルごとに、データをストレージ アカウント、または Event Hubs にエクスポート・保存できます。</li><li>ストレージ アカウント、または Event Hubs にエクスポート・保存されるデータは、Log Analytics ワークスペースにも収集されます。</p><p>そのため、コストを抑えたい場合は、テーブルの保有期間を無料期間の範囲に収める、または<a href="#log-analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%86%85%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B">Log Analytics ワークスペース内のデータを削除する</a>で削除する必要があります。</li><li>より詳細な情報は、以下弊社サイトをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal">Azure Monitor の Log Analytics ワークスペース データ エクスポート</a></li></ul><p>■ <strong>データ収集ルールを構成して直接アップロードする (プレビュー)</strong></p><ul><li>データ収集ルールを構成することで、Azure Monitor エージェントを使用して収集したデータを、直接ストレージ アカウント、または Event Hubs へアップロードすることができます。  </li><li>この方法では、Log Analytics ワークスペースにはデータが収集されないため、ワークスペース内のデータを削除する必要はありません。</li><li>本機能がサポートされているデータ型には制限がございます (2024 年 9 月時点)。詳細は、以下弊社サイトをご確認ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-send-data-to-event-hubs-and-storage?tabs=windows,windows-1#whats-supported">サポートされている機能</a></li><li>本機能は 2024 年 9 月時点では、パブリック プレビュー段階です。仕様が余儀なく変更される可能性があるため、使用の際はこちらの点にご留意ください。</li></ul><p>(*4) ストレージ アカウントの価格は以下サイトからご確認ください。</p><p><a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/blobs/">Azure Blob Storage の価格</a></p><h4 id="2-2-3-Log-Analytics-ワークスペース内のデータを削除する"><a href="#2-2-3-Log-Analytics-ワークスペース内のデータを削除する" class="headerlink" title="2-2-3. Log Analytics ワークスペース内のデータを削除する"></a>2-2-3. Log Analytics ワークスペース内のデータを削除する</h4><p>Log Analytics ワークスペースに収集されたデータは、REST API で削除することができます。</p><p>この REST API を使用すると、テーブル名やカラム名を指定して特定のデータを削除することが可能です。</p><p>クエリ実行による分析が不要になったデータや、<a href="#2-2-2-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BF%9D%E6%9C%89%E9%87%8F%E3%82%92%E8%AA%BF%E6%95%B4%E3%81%99%E3%82%8B">2-2-2. データの保有量を調整する</a> で別の場所へ移動したデータを Log Analytics ワークスペースから削除することで、データの保有料金を抑えることができます。</p><p>詳細は、以下のブログをご参照ください。</p><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsWorkspacePurge/">Log Analytics ワークスペースのデータを削除する方法</a></p><blockquote><p>[!IMPORTANT]</p><p>上記、データの削除によって削除されたデータは Log Analytics ワークスペースへ再び戻すことはできません。</p><p>そのため、削除を実行する際は最新の注意を払ってください。</p></div><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本記事では、Log Analytics ワークスペースのコストを分析し、それぞれのコスト増加原因に対する対処法をご紹介しました。<br>まずはデータのインジェスト量、保有量、および保有期間の設定を確認し、どこにコストがかかっているかを特定し、適切な対処法を取ることが、コストの削減およびコスト増加の抑制につながります。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Log Analytics ワークスペースのコストの管理方法 (コスト増加原因の調査、コストを抑える方法) についてご説明します。  &lt;/p&gt;
&lt;p&gt;なお、Azure Monitor のコスト最適化、および Log Analytics ワークスペースの使用量の分析については、以下弊社サイトもご参照ください。&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/best-practices-cost&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/analyze-usage&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>マシンが起動中にも関わらず Heartbeat ログ アラートが発報された場合の調査方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/Unexpected_Heartbeat_logalert/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/Unexpected_Heartbeat_logalert/</id>
    <published>2024-09-05T01:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.335Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの佐藤です！<br><br>今回は、Heartbeat ログ アラート ルールが発報したが、マシンは稼働しているという状況、<br>特に Heartbeat ログの遅延により期待しないアラートが発報した場合の調査方法についてご紹介いたします。<br></p><span id="more"></span><ol><li>マシンが稼働しているにもかかわらず Heartbeat ログ アラート ルールが発報するシナリオ</li><li>Heartbeat ログの収集状況を確認する方法</li><li>Heartbeat ログの遅延が確認されたら</li></ol><h1 id="1-マシンが稼働しているにもかかわらず-Heartbeat-ログ-アラート-ルールが発報するシナリオ"><a href="#1-マシンが稼働しているにもかかわらず-Heartbeat-ログ-アラート-ルールが発報するシナリオ" class="headerlink" title="1. マシンが稼働しているにもかかわらず Heartbeat ログ アラート ルールが発報するシナリオ"></a>1. マシンが稼働しているにもかかわらず Heartbeat ログ アラート ルールが発報するシナリオ</h1><p>マシンが稼働しているにもかかわらず Heartbeat ログ アラート が発報する原因として、<br>主に以下がございます。<br><br>主な要因 1 : Heartbeat ログの欠損<br><br>-&gt; 何らかの原因によりマシンから Heartbeat ログが届かなくなり、それによりアラートの発報条件を満たし発報する。<br></p><p>主な要因 2 : Heartbeat ログの遅延<br><br>-&gt; Heartbeat ログの収集に遅延発生したことで、アラートの発報条件を満たし発報する。<br></p><p>主な要因 3 : サービスに問題が発生している状況<br></p><p>今回はこのなかでも、主な要因 2 (遅延) にスポットライトを当ててみます。<br></p><h1 id="2-Heartbeat-ログの収集遅延状況を確認する方法"><a href="#2-Heartbeat-ログの収集遅延状況を確認する方法" class="headerlink" title="2. Heartbeat ログの収集遅延状況を確認する方法"></a>2. Heartbeat ログの収集遅延状況を確認する方法</h1><p>以下のクエリにより、まず Heartbeat ログの遅延状況をご確認いただくことが可能です。<br><br>(※ たとえば、ログが 30 分遅延して収集されてしまった環境の場合、10:30 に収集されるべきログが Log Analytics ワークスペースに到着するのは 11:00 でございます。<br><br>    10:30 ~ 11:00 の間に 10:30 に収集されたログを確認した場合、クエリに該当するレコードがない旨表示されることにご留意ください。)<br></p><p>Log Analytics ワークスペースの各テーブルに存在する以下の 3 列を使用して、収集遅延状況を確認することが可能です。<br><br>各列の名称およびどのような値を格納しているかについては以下の通りでございます。​<br><br>(列名 : どのような値を格納しているか の順で記載いたします。)<br></p><p>TimeGenerated 列 : エージェントでデータを検知した時刻<br><br>_TimeReceived 列 : データが Azure に届いた時刻<br><br>ingestion_time() 列 : Log Analytics ワークスペースに取り込まれ、クエリが可能になった時刻<br></p><p>// 参考情報<br></p><ul><li>インジェスト時間のチェック<br><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time#check-ingestion-time">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time#check-ingestion-time</a><br></li></ul><p>Heartbeat<br><br>| where _ResourceId contains “&lt;仮想マシン名&gt;” //&lt;仮想マシン名&gt; は、遅延状況を確認したいログの収集元マシン名に置き換えます<br><br>| order by TimeGenerated asc​<br><br>| extend E2EIngestionLatency = ingestion_time() - TimeGenerated​ // ①<br><br>| extend AgentLatency = _TimeReceived - TimeGenerated​ // ②<br><br>| project TimeGenerated, Computer, E2EIngestionLatency, AgentLatency, _TimeReceived, ingestion_time(), Category​<br><br>| order by E2EIngestionLatency<br><br><br><br>① : エージェントがデータを検知してから、データがクエリ可能になるまでの所要時間を計算します<br><br>② : エージェントがデータを検知してから、Azure に届くまでの所要時間を計算します<br><br><br><br>上述のクエリを実行いただくことで、① として計算した値が大きい順に以下の表なテーブル形式でデータが出力されます。</p><p>エージェントがデータを検知してからログがクエリ可能な状態に処理されるまで、おおよそ 3 分ほどの時間を要します。<br><br>E2EIngestionLatency 列の値をご確認いただき、遅延の有無をご確認ください。<br></p><p><img src="/blog/LogAnalytics/Unexpected_Heartbeat_logalert/image001.png"><br>例えば、上述のハイライトの場合ですと、以下のようになっております。<br><br><br><br>E2EIngestionLatency : 18 分 8 秒<br><br>AgentLatency : 18 分 2 秒<br><br><br><br><br>この場合、AgentLatency が大きいために E2EIngestionLatency の値が大きくなっています。<br>すなわち、エージェントがデータを検知してから Azure に届くまでの過程で時間を要していることがわかります。</p><h1 id="3-Heartbeat-ログの遅延が確認されたら"><a href="#3-Heartbeat-ログの遅延が確認されたら" class="headerlink" title="3. Heartbeat ログの遅延が確認されたら"></a>3. Heartbeat ログの遅延が確認されたら</h1><p>2 に記載のクエリにより Heartbeat ログの遅延が確認された場合、以下 2 パターンの遅延の仕方がございます。<br><br>パターン 1 : E2EIngestionLatency が大きく、かつ AgentLatency も大きい<br><br>パターン 2 : E2EIngestionLatency が大きいが、 AgentLatency は小さい<br></p><p>遅延箇所により遅延の発生原因が異なります。<br><br>それぞれのパターンについて、以下に詳述します。<br></p><h2 id="パターン-1-E2EIngestionLatency-が大きく、かつ-AgentLatency-も大きい"><a href="#パターン-1-E2EIngestionLatency-が大きく、かつ-AgentLatency-も大きい" class="headerlink" title="パターン 1 : E2EIngestionLatency が大きく、かつ AgentLatency も大きい"></a>パターン 1 : E2EIngestionLatency が大きく、かつ AgentLatency も大きい</h2><p>この場合、エージェントがデータを検知してから Azure に届くまでに時間を要しています。<br><br>考えられる主な原因は以下の 2 つでございます。<br></p><ul><li>ご利用いただいているネットワークの問題<br></li><li>エージェントで発生している問題<br></li></ul><p>エージェントで問題が発生しているかどうかは、以下の手順でエージェントのログを取得いただくことでご確認いただけます。</p><h3 id="Windows-OS-の場合"><a href="#Windows-OS-の場合" class="headerlink" title="Windows OS の場合"></a>Windows OS の場合</h3><ol><li>問題が発生した Windows サーバーへ管理者権限にてログインします。<br></li><li>PowerShell ウインドウを管理者権限にて開きます。<br></li><li>以下のコマンドを実行します。<br><br>cd “C:\Packages\Plugins\Microsoft.Azure.Monitor.AzureMonitorWindowsAgent\1.X.X.X\Troubleshooter”<br><br>(X にはバージョン番号が入ります。環境に応じて変更下さい。)<br><br> .\AgentTroubleshooter.exe –ama -v<br></li><li>ログ採取が行われますのでそのまま待機します。<br></li><li>“C:\Packages\Plugins\Microsoft.Azure.Monitor.AzureMonitorWindowsAgent\1.X.X.X\Troubleshooter” フォルダ内 AgentTroubleshooterOutput.zip ファイルが作成されます。<br><br>こちらが Azure Monitor エージェントのログでございます。<br></li></ol><h3 id="Linux-OS-の場合"><a href="#Linux-OS-の場合" class="headerlink" title="Linux OS の場合"></a>Linux OS の場合</h3><p>対象の Linux OS 上で作業を実施してください。<br>以下のコマンドを任意のディレクトリ上で実行します。<br><br><br>$ mkdir ama_tst<br><br>$ cd ama_tst<br><br>$ wget <a href="https://github.com/Azure/azure-linux-extensions/raw/master/AzureMonitorAgent/ama_tst/ama_tst.tgz">https://github.com/Azure/azure-linux-extensions/raw/master/AzureMonitorAgent/ama_tst/ama_tst.tgz</a><br><br>$ tar -xzvf ama_tst.tgz<br><br>$ sudo sh ama_troubleshooter.sh<br><br>“Please select an option:” と表示されますので、”L” を入力し、エンターキーを押します。<br><br>“Output Directory:” と表示されますので、”.” を入力し、エンターキーを押します。<br><br><br><br>シェルが終了しますと、”amalogs” から始まるディレクトリ、またはファイルがカレントディレクトリに出力されます。<br><br>こちらが Azure Monitor エージェントのログでございます。<br><br><br></p><p>事象発生直後のほうが、ログに残存している情報が多いため、<br>弊社サポート窓口にお問い合わせいただく場合でも事象発生後なるべくお早めにログを取得いただくことをお勧めいたします。<br><br>ログ ファイルがディレクトリとなっている場合には、弊社にご提供いただきます際には圧縮いただきますようお願いいたします。<br></p><p>また、エージェントのバージョンが最新でない場合には、<br>過去のエージェント特有の不具合として事象が発生する可能性もございます。<br><br>エージェントは不具合の修正などを目的としたアップグレードが行われております。<br><br>そのため、エージェントは最新バージョンをご利用いただくことを合わせてご検討ください。<br></p><h2 id="パターン-2-E2EIngestionLatency-が大きいが、-AgentLatency-は小さい"><a href="#パターン-2-E2EIngestionLatency-が大きいが、-AgentLatency-は小さい" class="headerlink" title="パターン 2 : E2EIngestionLatency が大きいが、 AgentLatency は小さい"></a>パターン 2 : E2EIngestionLatency が大きいが、 AgentLatency は小さい</h2><p>この場合、AgentLatency が小さいことからエージェントがデータを検知してから Azure に届くまでの経路に問題はありません。<br><br>一方で、Azure に届いてからクエリ可能になるまでに時間を要しているため E2EIngestionLatency の値が大きくなっています。<br><br>この場合、Azure 内部の処理 (受信したデータをクエリ可能となるよう行う処理) に時間がかかっております。<br><br><br>なぜ Azure 内部の処理に時間がかかったか詳細な原因を調査されたい場合には、サポート リクエストを発行いただくことで調査が可能です。<br><br><br><br>Heartbeat 監視は、Log Analytics ワークスペースのデータ取り込み遅延によって期待どおり監視出来ない可能性がございます。<br><br>コンピューターの死活監視として、Heartbeat の監視以外にも様々な方法がございます。<br><br>下記の記事に死活監視に関する内容が記載しております。<br><br>こちらもあわせてご参考ください<br><br><br></p><ul><li>Azure VM における死活監視の考え方<br><br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/</a><br><br>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。最後までお読みいただきありがとうございました！</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの佐藤です！&lt;br&gt;&lt;br&gt;今回は、Heartbeat ログ アラート ルールが発報したが、マシンは稼働しているという状況、&lt;br&gt;特に Heartbeat ログの遅延により期待しないアラートが発報した場合の調査方法についてご紹介いたします。&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
  </entry>
  
  <entry>
    <title>可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラートについて</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/VMAvailability-MetricAlert/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/VMAvailability-MetricAlert/</id>
    <published>2024-08-29T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.335Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回は Azure VM のホストが出力するメトリック ‘VM Availability Metric (Preview)’ を利用したメトリック アラートの設定方法をご紹介します。</p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%81%A8%E3%81%AF">2. 可用性メトリック ‘VM Availability Metric (Preview)’ とは</a></li><li><a href="#3-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%81%AE%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86">3. 可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラート設定手順</a></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">Azure VM の死活監視にはいくつか方法があります</a>。<br>Azure Monitor エージェントによって収集される Heartbeat を利用した監視をご利用されている方が多いかと思いますが、<br>今回は可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラートの設定方法をご紹介します。</p><p>VM Availability Metric (Preview) （VM 可用性メトリック (プレビュー)）は Azure VM のホストが出力するメトリックであり、VM ホストを監視することができます。このメトリックを利用したメトリック アラートを構成することで、VM の可用性が低下していることを検知することができます。</p><br><h2 id="2-可用性メトリック-‘VM-Availability-Metric-Preview-’-とは"><a href="#2-可用性メトリック-‘VM-Availability-Metric-Preview-’-とは" class="headerlink" title="2. 可用性メトリック ‘VM Availability Metric (Preview)’ とは"></a>2. 可用性メトリック ‘VM Availability Metric (Preview)’ とは</h2><p>可用性メトリックは Azure VM のホストが出力するメトリックです。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/microsoft-compute-virtualmachines-metrics">ホスト メトリック</a>は仮想マシンを作成すると自動的に収集されます。このホスト メトリックの中で、VM の可用性を表すメトリックが「VM Availability Metric (Preview)」です。</p><p>このメトリックの値が 1 の場合は VM が実行中であり、利用可能であることを表します。<br>このメトリックの値が 0 の場合は VM を利用できない状態であることを意味します。<br>つまり、このメトリックの値が 1 を下回ったことを検知するアラートを作成いただくことで、VM ホストにおける可用性を監視することができます。</p><p>ご注意いただきたい点は、このメトリックでは <strong>Azure VM が “停止済み (割り当て解除) “ を検知することができない</strong>ことです。<br>VM が “停止済み (割り当て解除)” の場合は、メトリックの値が <a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/monitor-vm-reference#vm-availability-metric-preview">NULL</a> になります。<br>しかし、メトリック アラートではメトリックの値が <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#null-and-zero-values">NULL</a> であることを検知できませんので、予めご留意ください。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image01.png"></p><br><h2 id="3-可用性メトリック-‘VM-Availability-Metric-Preview-’-のメトリック-アラート設定手順"><a href="#3-可用性メトリック-‘VM-Availability-Metric-Preview-’-のメトリック-アラート設定手順" class="headerlink" title="3. 可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラート設定手順"></a>3. 可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラート設定手順</h2><p>それでは、可用性メトリック ‘VM Availability Metric (Preview)’ のメトリック アラートを設定してみましょう！<br>本記事では 5 分おきにメトリックの値を確認し、過去 5 分以内に記録された可用性メトリックの平均値が 1 を下回った場合に発報するメトリック アラートを設定します。</p><br><p><strong>1). 監視対象の Azure VM のメトリック エクスプローラーを開きます。</strong><br>Azure portal にログインし、監視対象の Azure VM を開きます。<br>Azure VM のリソース メニュー [メトリック] を選択し、VM Availability Metric (Preview) のメトリックを表示します。<br>[メトリックの名前空間] で「仮想マシン ホスト」を選択し、[メトリック] で「VM Availability Metric (Preview)」を検索してください。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image02.png"></p><p>下図では [集計] で「平均」を選択していますが、これは指定した期間のメトリックを集計する方法を意味します。<br>例えば、以下の場合は [時間の範囲] で指定した過去 30 分以内に記録されたメトリックを、[時間の粒度] の 5 分間隔でキャプチャされたメトリック値の平均が表示されます。可用性メトリックでは、平均、最小値、最大値の集計方法がサポートされています。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image03.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>メトリック エクスプローラーの使い方は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics">弊社公開情報</a> をご参照ください。また、メトリックの集計の考え方につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#aggregation-types">こちら</a> の公開情報をご覧ください。</p></div><br><p><strong>2). メトリック アラートの発報条件を指定します。</strong><br>VM Availability Metric (Preview) のメトリックを表示できましたら、画面上部の [新しいアラート ルール] をクリックします。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image04.png"></p><p>この画面では、アラートの発報条件を指定します。メトリック アラートの評価に関わる主な項目は以下のとおりです。</p><ul><li>確認する間隔 : 評価を行う頻度</li><li>ルックバック期間 : 1 回の評価を行う際に評価の対象となる期間</li><li>集計の種類 : [ルックバック期間] で指定した期間のメトリックを集計する方法</li></ul><p><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image05.png"></p><p>[確認する間隔] は評価を行う頻度であり、「何分おきに評価を行うか」を表します。<br>[ルックバック期間] は「1 回の評価を行う際に評価の対象となる期間」を表します。<br>今回は 5 分おきに評価を行い、過去 5 分以内に記録された可用性メトリックの平均値が 1 を下回った場合に発報させたいので、以下の通り設定します。</p><ul><li>シグナル名 : VM Availability Metric (Preview) </li><li>しきい値 : Static</li><li>集計の種類 : 平均</li><li>演算子 : 次の値より小さい</li><li>単位 : カウント</li><li>しきい値 : 1</li><li>確認する間隔 : 5 分</li><li>ルックバック期間 : 5 分</li></ul><hr><p><strong>&lt;補足&gt; Azure VM のライブ マイグレーションによる可用性メトリックの影響について</strong><br>Azure VM のライブ マイグレーションの影響で、一時的に VM Availability Metric (Preview) の値が 1 ではなく 0 と出力される可能性がございます。この場合、直近 5 分間の VM Availability Metric (Preview) の平均値が 1 を下回り、Azure VM が稼働しているのにも関わらず期待しないアラートが発報する恐れがございます。もしライブ マイグレーションの影響によるメトリック アラートの発報を回避されたい場合は、アラート発報条件を見直していただくことをご検討ください。</p><ul><li><p>例 : 5 分間のうち、1 分間メトリック値が 0 だった場合を許容したい<br>シグナル名 : VM Availability Metric (Preview)<br>しきい値 : Static<br>集計の種類 : 平均<br>演算子 : 次の値より小さい<br>単位 : カウント<br>しきい値 : 0.8<br>確認する間隔 : 5 分<br>ルックバック期間 : 5 分</p></li><li><p>例 : 5 分間連続でメトリック値が 0 だった場合にアラートを発報したい<br>シグナル名 : VM Availability Metric (Preview)<br>しきい値 : Static<br>集計の種類 : 最大<br>演算子 : 次の値より小さい<br>単位 : カウント<br>しきい値 : 1<br>確認する間隔 : 5 分<br>ルックバック期間 : 5 分</p></li></ul><hr><div class="alert is-info"><p class="alert-title">Note</p><p>メトリック アラートの設定項目につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-metric-alert-rule">弊社公開情報</a>をご覧ください。</p></div><br><p><strong>3). アラートで通知する方法を指定します。</strong><br>Azure Monitor のアラート機能では、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups">アクション グループ</a> というリソースでアラートを通知する方法を定義します。新規で作成する場合は [+ アクション グループの作成]、既存のグループを指定する場合は [+ アクション グループの選択] をクリックします。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image06.png"></p><p>例えば、アラートをメールで通知する場合には、[通知のタイプ] で “電子メール/SMS メッセージ/プッシュ/音声” を選択し、通知するメール アドレスを指定します。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image07.png"></p><p>また、[アクション] では、アクション グループがトリガーされた際に実行するアクションを選択できます (今回は設定しません)。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image08.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>アクション グループの概要や設定手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">弊社公開情報</a>をご覧ください。</p></div><br><p><strong>4. アラート ルールの名前、アラートの重大度等を設定します。</strong><br>[アラート ルールの詳細] では、重大度、アラート ルール名、アラート ルールの説明を設定します。<br>[詳細設定オプション] では、アラート ルールの有効化や自動解決を設定します。</p><p><strong>[アラートを自動的に解決する] にチェックをいれた場合には、アラートの閾値を満たす度にアラートは発報しません。</strong><br>このようなアラートは “<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#alerts-and-state">ステートフルなアラート</a>“ と呼ばれ、アラートの閾値を満たしたときに一度発報し、アラートが解決したとみなされたときに、解決したことが通知されます。メトリック アラートの場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">3 回連続で閾値を満たさなかった場合に解決したとみなされます</a>。</p><p><strong>[アラートを自動的に解決する] にチェックをいれない場合は、アラートの閾値を満たす度にアラートが発報します。</strong> お客様のご要件に合わせてご設定ください。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image09.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>ステートフルなアラートの詳細につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-overview#stateful-alerts">弊社公開情報</a>をご覧ください。</p></div><br><p><strong>5). 最後に設定した内容を確認し、[作成] をクリックします。</strong><br>手順は以上です。</p><p>アラートの履歴は、Azure portal にログインいただき、[モニター] &gt; [アラート] から確認いただけます。<br>以下の例では、アラートの評価時点から過去 5 分間の可用性メトリック ‘VM Availability Metric (Preview)’ の平均値が 1 を下回ったため、アラートが発報していることが分かります。<br><img src="/blog/LogAnalytics/VMAvailability-MetricAlert/image10.png"></p><p>本記事の冒頭でもお伝えしておりますとおり、<strong>Azure VM の死活監視には複数の方法がございます</strong>。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/">Azure VM における死活監視の考え方</a> のブログもご覧いただき、お客様のご要件に合った監視設定を構築いただけますと幸いです！<br>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回は Azure VM のホストが出力するメトリック ‘VM Availability Metric (Preview)’ を利用したメトリック アラートの設定方法をご紹介します。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>既定で用意されているもの以外のイベント ログを収集する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomEventlog/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomEventlog/</id>
    <published>2024-08-18T17:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.199Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムの Windows イベント ログを収集する方法についてご説明します。  </p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>カスタムのイベント ログの収集手順<ul><li>事前準備</li><li>収集したいイベント ログの XPath を取得する</li><li>データ収集ルールを作成する</li><li>Windows イベント ログが収集されていることを確認する</li></ul></li><li>まとめ</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Windows イベント ログは、データ収集ルール (DCR) のデータ ソースとして使用できるものの 1 つです。<br>Windows イベント ログの種類は多数存在し、Azure portal でデフォルトで用意されているものと、そうでないものがあります。<br>今回は、Azure portal でデフォルトで用意されていない Windows イベント ログ (以降、カスタム Windows イベント ログ) の収集設定方法についてご紹介します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events</a></p><h2 id="カスタム-Windows-イベント-ログの収集手順"><a href="#カスタム-Windows-イベント-ログの収集手順" class="headerlink" title="カスタム Windows イベント ログの収集手順"></a>カスタム Windows イベント ログの収集手順</h2><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>以下のリソースがご自身の環境にあることを確認してください。</p><ul><li>データ収集元となる Windows OS の仮想マシン (以下 VM)</li><li>データ収集先となる Log Analytics ワークスペース</li></ul><h3 id="収集したいイベント-ログの-XPath-を取得する"><a href="#収集したいイベント-ログの-XPath-を取得する" class="headerlink" title="収集したいイベント ログの XPath を取得する"></a>収集したいイベント ログの XPath を取得する</h3><p>任意のイベント ログをデータ収集ルールのデータ ソースとして指定し、収集設定したい場合、そのイベント ログの XPath が必要になります。<br>以下の手順に沿って任意のイベント ログの XPath を取得することができます。  </p><ol><li><p>VM のスタート画面で “イベント ビューアー” または “Event Viewer” を検索し、開きます。</p></li><li><p>左ペインで “Windows ログ” を押下し、配下の “Application”, “セキュリティ”, “Setup”, “システム”, “Forwarded Events” のいずれかを押下します。<br><img src="/blog/LogAnalytics/HowToCollectCustomEventlog/eventviewer_1.png" alt="alt text"></p></li><li><p>右ペインで “現在のログをフィルター” を押下します。<br>以下のようなウィンドウが表示されるため、”フィルター” タブで以下 2 つのパラメーターを設定します。</p></li></ol><ul><li>イベント レベル</li><li>イベント ID<br>  <img src="/blog/LogAnalytics/HowToCollectCustomEventlog/eventviewer_filter.png" alt="alt text">  </li></ul><ol start="4"><li><p>フィルターの設定ができたら、同ウィンドウの “XML” タブを開きます。<br>以下 2 点を手元にメモします。</p><ul><li><code>&lt;Select Path=&quot;2で選択したフォルダ&quot;&gt;</code> の <code>2で選択したフォルダ</code> – A</li><li><code>&lt;Select Path=&quot;2で選択したフォルダ&quot;&gt;</code> と <code>&lt;/Select&gt;</code> の間の <code>*[System[(Level=...) and (EventID=...)]]</code> の箇所 – B</li></ul><p> <img src="/blog/LogAnalytics/HowToCollectCustomEventlog/eventviewer_xml.png" alt="alt text"></p></li></ol><blockquote><p>[!NOTE]<br>上記の方法で取得した XPath が有効であるかを確認したい場合、ローカルで確認することができます。<br>手順は以下の通りです。  </p><ol><li>Windows コンピュータで、PowerShell を開きます。  </li><li>以下のクエリを実行します。<br>この際、$XPath には、上記 4 で取得した B の値を設定してください。<br>また、$LogName には、上記 4 で取得した A の値を設定してください。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$XPath = &#x27;*[System[EventID=1035]]&#x27;   </span><br><span class="line">$LogName = &#x27;Application&#x27; </span><br><span class="line">Get-WinEvent -LogName $LogName -FilterXPath $XPath</span><br><span class="line">```  </span><br><span class="line">3. 結果を確認します。ログの一覧が表示されれば、指定した XPath は有効であると判断できます。</span><br><span class="line"></span><br><span class="line">### データ収集ルールを作成する</span><br><span class="line">1. Azure potral にログインします。</span><br><span class="line">2. &quot;deta collection rules&quot; を選択します。</span><br><span class="line">3. [作成] を押下し、&quot;基本&quot; タブの各値を入力します。  </span><br><span class="line">   続いて &quot;リソース&quot; タブで収集元 VM を選択・追加します。</span><br><span class="line">4. &quot;収集と配信&quot; タブで [データ ソースの追加] を押下します。  </span><br><span class="line">   右ペイン内 &quot;データ ソース&quot; タブの &quot;データ ソースの種類&quot; で &quot;Windows イベント ログ&quot; を選択します。  </span><br><span class="line">5. [カスタム] を押下し、入力欄に [収集したいイベント ログの XPath の取得](#収集したいイベント-ログの-xpath-の取得) にて取得した XPath の先頭に `&lt;4で取得した A の値&gt;!` (&quot;&lt;&gt;&quot; は不要です) を足したものを入力し、[追加] を押下します。  </span><br><span class="line">   ![alt text](/blog/LogAnalytics/HowToCollectCustomEventlog/dcr_addDatasource.png)</span><br><span class="line"></span><br><span class="line">6. [次へ : ターゲット &gt;] を押下し、[+ ターゲットの追加] を押下します。  </span><br><span class="line">   &quot;ターゲットの種類&quot; で &quot;Azure Monitor Logs&quot; を選択し、収集先となる Log Analytics ワークスペースを選択し、&quot;データ ソースの追加&quot; を押下します。  </span><br><span class="line">   ![alt text](/blog/LogAnalytics/HowToCollectCustomEventlog/dcr_addTarget.png)</span><br><span class="line"></span><br><span class="line">7. [確認と作成] タブにて [作成] を押下し、完了です。</span><br><span class="line"></span><br><span class="line">### Windows イベント ログが収集されていることを確認する</span><br><span class="line">1. Azure portal にログインします。</span><br><span class="line">2. [データ収集ルールの作成](#データ収集ルールの作成) の 6 で選択した Log Analytics ワークスペースのページを開きます。</span><br><span class="line">3. 左ペインの [ログ] を押下し、以下のクエリを貼り付け、実行します。</span><br><span class="line">  なお、where から始まる行は、収集の有無を確認したい EventID およびイベントレベルに置き換えてください。</span><br></pre></td></tr></table></figure>Event<br>| where EventID == &lt;イベント ID&gt;<br>| where EventLevelName == “Information” // 又は where EventLevel == “4”<br>| sort by TimeGenerated</li></ol></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">例 : EventID が 7036 または 7040 の Information レベルのログ </span><br></pre></td></tr></table></figure><p>Event<br>| where EventID == 7036 or EventID == 7040<br>| where EventLevelName == “Information”<br>| sort by TimeGenerated</p><pre><code>4. 以下画像のようにログが表示されれば、ログが収集できています。![alt text](/blog/LogAnalytics/HowToCollectCustomEventlog/laws_eventlog.png)## まとめ本ブログではカスタム Windows イベント ログの収集設定方法についてご紹介しました。データ収集ルールでは、収集したいイベント ログの XPath を指定することで、任意のログを収集することができます。</code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムの Windows イベント ログを収集する方法についてご説明します。  &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-windows-events&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>既定で用意されているもの以外のパフォーマンス カウンターを収集する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectCustomPerfCounter/</id>
    <published>2024-08-18T16:10:00.000Z</published>
    <updated>2024-09-18T01:17:22.203Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムのパフォーマンス カウンターを収集するためのデータ収集ルールの作成方法についてご説明します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>カスタムのパフォーマンス カウンターの収集手順<ul><li>事前準備</li><li>収集したいパフォーマンス カウンター名の取得</li><li>データ収集ルールの作成</li></ul></li><li>まとめ</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>パフォーマンス カウンターは、データ収集ルール (DCR) のデータ ソースとして使用できるものの 1 つです。<br>パフォーマンス カウンターの種類は多数存在し、Azure portal でデフォルトで用意されているものと、そうでないものがあります。  </p><p>Linux OS のマシンについては、収集可能なパフォーマンス カウンターの種類が固定されている一方、Windows OS のマシンではデフォルトで用意されていないパフォーマンス カウンターも収集することが可能です。<br>今回は、Azure portal でデフォルトで用意されてないパフォーマンス カウンター (以降、カスタム パフォーマンス カウンター) の収集設定方法についてご紹介します。  </p><p>なお、Linux OS のマシンから収集できるパフォーマンス カウンターの一覧については、以下弊社サポート チームのブログをご参照ください。<br><a href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/">Azure Monitor Agent for Linux で取得可能なパフォーマンス カウンターの一覧</a></p><h2 id="カスタム-パフォーマンス-カウンターの収集手順"><a href="#カスタム-パフォーマンス-カウンターの収集手順" class="headerlink" title="カスタム パフォーマンス カウンターの収集手順"></a>カスタム パフォーマンス カウンターの収集手順</h2><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>以下のリソースがご自身の環境にあることを確認してください。</p><ul><li>データ収集元となる Windows OS の仮想マシン (以下 VM)</li><li>データ収集先となる Log Analytics ワークスペース</li></ul><h3 id="パフォーマンス-カウンター名を取得する"><a href="#パフォーマンス-カウンター名を取得する" class="headerlink" title="パフォーマンス カウンター名を取得する"></a>パフォーマンス カウンター名を取得する</h3><p>データ収集ルールのカスタム パフォーマンス カウンターに含まれないパフォーマンス カウンターを取得したい場合、以下の手順に沿って任意のパフォーマンス カウンター名を取得します。  </p><ol><li><p>VM のスタート画面で “パフォーマンス モニター” または “Performance Monitor” を検索し、開きます。</p></li><li><p>左ペインで Monitoring Tools &gt; Performance Monitor (モニター ツール &gt; パフォーマンス モニター) を押下します。ウィンドウ中央に折れ線グラフが表示されます。<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen1.png" alt="alt text"></p></li><li><p>上部 [+] ボタンを押下し、確認したいパフォーマンス カウンターを押下します。この際、”選択したオブジェクトのインスタンス (I)” に複数の値が表示されている場合は任意のインスタンスも押下します。<br>[追加] を押下し、[OK] を押下します。  </p></li></ol><p>例 : パフォーマンス カウンターにインスタンスがない場合<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen2.png" alt="alt text">  </p><p>例 : パフォーマンス カウンターにインスタンスがある場合<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen3.png" alt="alt text"></p><ol start="4"><li>折れ線グラフの下に、選択したパフォーマンス カウンターの一覧が表示されます。<br>オブジェクト、インスタンス、カウンター列を参照し、以下のルールに従ってパフォーマンス カウンター名を手元にメモします。  </li></ol><p><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/performancemonitor-screen4.png" alt="alt text"></p><p>インスタンスがない場合 : <code>\&lt;オブジェクト&gt;\&lt;カウンター&gt;</code><br>    例 : <code>\System\File Read Bytes/sec</code>  </p><p>インスタンスがある場合 : <code>\&lt;オブジェクト&gt;(&lt;インスタンス&gt;)\&lt;カウンター&gt;</code><br>    例 : <code>\LogicalDisk(C:)\% Free Space</code></p><div class="alert is-info"><p class="alert-title">Note</p><p>カウンター名にアンパサンド (<code>&amp;</code>) が含まれている場合は、<code>&amp;</code> を <code>&amp;amp;</code> に置き換えてください。</p><p>例 : カウンター列の値が <code>Free &amp; Zero Page List Bytes</code> の場合、パフォーマンス カウンター名は <code>\Memory\Free &amp;amp; Zero Page List Bytes</code> となります。</p></div><h3 id="データ収集ルールを作成する"><a href="#データ収集ルールを作成する" class="headerlink" title="データ収集ルールを作成する"></a>データ収集ルールを作成する</h3><ol><li><p>Azure potral にログインします。</p></li><li><p>“deta collection rules” を選択します。</p></li><li><p>[作成] を押下し、”基本” タブの各値を入力します。<br> 続いて “リソース” タブで収集元 VM を選択・追加します。</p></li><li><p>“収集と配信” タブで [データ ソースの追加] を押下します。<br> 右ペイン内 “データ ソース” タブの “データ ソースの種類” で [パフォーマンス カウンター] を選択します。<br> その下にパフォーマンス カウンターの一覧が表示されます。</p></li><li><p>[カスタム] を押下し、収集したいパフォーマンス カウンターのチェックボックスにチェックを入れます。<br> (2024 年 7 月時点では、デフォルトですべてのカスタム パフォーマンス カウンターのチェックボックスにチェックが入っています。そのため、収集不要なカウンター場合は、そちらのチェックを外していただく必要があります。)<br> <img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/dcr-addcustomperf.png" alt="alt text"><br> 表示されているパフォーマンス カウンター以外のものを収集したい場合は、<a href="#%E5%8F%8E%E9%9B%86%E3%81%97%E3%81%9F%E3%81%84%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9-%E3%82%AB%E3%82%A6%E3%83%B3%E3%82%BF%E3%83%BC%E5%90%8D%E3%81%AE%E5%8F%96%E5%BE%97">収集したいパフォーマンス カウンター名の取得</a> で取得したパフォーマンス カウンター名を入力し、”追加” を押下した後、チェック ボックスにチェックを入れます。<br> <img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/dcr-addcustomperf2.png" alt="alt text"></p></li><li><p>[次へ : ターゲット &gt;] を押下し、[+ ターゲットの追加] を押下します。<br> “ターゲットの種類” で [Azure Monitor Logs] を選択し、収集先となる Log Analytics ワークスペースを選択し、[データ ソースの追加] を押下します。<br> <img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/dcr-addtargets.png" alt="alt text"></p></li><li><p>“確認と作成” タブにて [作成] を押下し、完了です。</p></li></ol><h3 id="パフォーマンス-カウンターが収集されていることを確認する"><a href="#パフォーマンス-カウンターが収集されていることを確認する" class="headerlink" title="パフォーマンス カウンターが収集されていることを確認する"></a>パフォーマンス カウンターが収集されていることを確認する</h3><ol><li>Azure portal にログインします。</li><li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">データ収集ルールの作成</a> の 6 で選択した Log Analytics ワークスペースのページを開きます。</li><li>左ペインの [ログ] を押下し、以下のクエリを貼り付け、実行します。<br> なお、where から始まる行は、収集の有無を確認したいパフォーマンス カウンターのオブジェクト名、インスタンス名、カウンター名に置き換えてください。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Perf</span><br><span class="line">| where ObjectName == &quot;オブジェクト名&quot;</span><br><span class="line">| where InstanceName == &quot;インスタンス名&quot;</span><br><span class="line">| where CounterName == &quot;カウンター名&quot;</span><br><span class="line">| sort by TimeGenerated</span><br></pre></td></tr></table></figure>例 : パフォーマンス カウンター名が <code>\LogicalDisk(C:)\% Free Space</code> の場合<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Perf</span><br><span class="line">| where ObjectName == &quot;LogicalDisk&quot;</span><br><span class="line">| where InstanceName == &quot;C:&quot;</span><br><span class="line">| where CounterName == &quot;% Free Space&quot;</span><br><span class="line">| sort by TimeGenerated</span><br></pre></td></tr></table></figure></li><li>以下画像のようにログが表示されれば、ログが収集できています。<br><img src="/blog/LogAnalytics/HowToCollectCustomPerfCounter/law-checklog.png" alt="alt text"></li></ol><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本ブログではパフォーマンス カウンターおよびカスタム パフォーマンス カウンターの収集設定方法についてご紹介しました。<br>データ収集ルールでは、収集したいパフォーマンス カウンターのパフォーマンス カウンター名を指定することで、任意のログを収集することができます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、以下の公開情報に記載されています、Azure Monitor エージェントを使用してカスタムのパフォーマンス カウンターを収集するためのデータ収集ルールの作成方法についてご説明します。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-performance&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>データ収集ルール作成時のデータ収集エンドポイントの構成について</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/DataCollectionEndpoint/</id>
    <published>2024-07-23T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.167Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの徳田です。</p><p>本ブログでは、以下の公開情報に記載されていますデータ収集エンドポイントについて、その設定方法、利用目的、設定時の制限事項を、具体例を用いてご説明します。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal</a></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li>はじめに</li><li>データ収集エンドポイント (DCE) とは</li><li>データ収集ルールが使用するエンドポイントの種類<ul><li>ログ インジェスト エンドポイント</li><li>メトリック インジェスト エンドポイント</li><li>構成アクセス エンドポイント</li></ul></li><li>データ収集エンドポイントの 2 種類の設定箇所<ul><li>データ収集ルールの作成 [基本] タブ<ul><li>設定方法</li><li>目的</li><li>制限事項</li></ul></li><li>データ収集ルールの作成 [リソース] タブ<ul><li>設定方法</li><li>目的</li><li>制限事項</li></ul></li></ul></li><li>具体的なシナリオにおけるデータ収集エンドポイントの構成</li><li>データ収集エンドポイントに関する FAQ</li><li>まとめ</li></ul><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure Monitor エージェントを使用してログやメトリックを収集する場合、どのようなログを収集するのかはデータ収集ルール (DCR) を使用して設定します。<br>データ収集ルールを作成する際、データ収集エンドポイントを設定できる箇所が 2 つあります。<br>今回は、それぞれで設定できるデータ収集エンドポイントの違いを説明するとともに、具体的な例を用いて、どのようにそれぞれのエンドポイントを構成すればよいのかをご紹介します。</p><h2 id="データ収集エンドポイント-DCE-とは"><a href="#データ収集エンドポイント-DCE-とは" class="headerlink" title="データ収集エンドポイント (DCE) とは"></a>データ収集エンドポイント (DCE) とは</h2><p>データ収集エンドポイント (DCE) は、Azure Monitor エージェントなどのデータ ソースが収集したデータを、処理して Azure Monitor に送信する際の接続を担います。</p><h2 id="データ収集ルールが使用するエンドポイントの種類"><a href="#データ収集ルールが使用するエンドポイントの種類" class="headerlink" title="データ収集ルールが使用するエンドポイントの種類"></a>データ収集ルールが使用するエンドポイントの種類</h2><h3 id="ログ-インジェスト-エンドポイント"><a href="#ログ-インジェスト-エンドポイント" class="headerlink" title="ログ インジェスト エンドポイント"></a>ログ インジェスト エンドポイント</h3><p>ログをデータ インジェスト パイプラインに取り込むエンドポイントです。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-text-log?tabs=portal">カスタム ログ</a>、および <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-iis">IIS ログ</a>を取り込む際または<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-ingestion-api-overview">ログ インジェスト API </a>を使用してログ収集を行いたい場合に必要です。</p><h3 id="メトリック-インジェスト-エンドポイント"><a href="#メトリック-インジェスト-エンドポイント" class="headerlink" title="メトリック インジェスト エンドポイント"></a>メトリック インジェスト エンドポイント</h3><p>メトリックをデータ インジェスト パイプラインに取り込むエンドポイントです。<br>エンドポイントを介してデータ インジェスト パイプラインに取り込まれたメトリックは、データ収集ルールで設定された <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/azure-monitor-workspace-overview">Azure Monitor ワークスペース</a>とテーブルに送信されます。</p><details><summary>Azure Monitor ワークスペースとは</summary>Azure Monitor が収集したメトリック データが収集されます。2024 年 7 月時点では、Prometheus に関連するメトリックのみが収集対象です。</details><h3 id="構成アクセス-エンドポイント"><a href="#構成アクセス-エンドポイント" class="headerlink" title="構成アクセス エンドポイント"></a>構成アクセス エンドポイント</h3><p>Azure Monitor エージェントがデータ収集ルールの構成情報を取得するためのエンドポイントです。<br>データ収集元となる仮想マシン (以下、VM) に紐づけられます。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> を使用してログ収集を行いたい場合に必要です。</p><h2 id="データ収集エンドポイントの-2-種類の設定箇所"><a href="#データ収集エンドポイントの-2-種類の設定箇所" class="headerlink" title="データ収集エンドポイントの 2 種類の設定箇所"></a>データ収集エンドポイントの 2 種類の設定箇所</h2><p>“データ収集ルールが使用するエンドポイントの種類” でご紹介したそれぞれのエンドポイントは、データ収集ルール作成時に設定することが可能です。<br>その方法をご紹介します。</p><h3 id="データ収集ルールの作成-基本-タブ"><a href="#データ収集ルールの作成-基本-タブ" class="headerlink" title="データ収集ルールの作成 - [基本] タブ"></a>データ収集ルールの作成 - [基本] タブ</h3><h4 id="設定方法"><a href="#設定方法" class="headerlink" title="設定方法"></a>設定方法</h4><p>Azure portal のデータ収集ルールの作成手順における [基本] タブで設定します。<br>以下画像に示す、”エンドポイント ID” で設定します。<br><img src="/blog/LogAnalytics/DataCollectionEndpoint/endpointid_ingestion.png" alt="alt text"></p><h4 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h4><p>ログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイント を設定します。</p><h4 id="制限事項"><a href="#制限事項" class="headerlink" title="制限事項"></a>制限事項</h4><ul><li>送信先の Log Analytics ワークスペース (メトリックを収集する場合は Azure Monitor ワークスペース)、およびデータ収集ルールと同じリージョンに存在する必要があります。</li></ul><h4 id="補足-1-ログ-インジェスト-エンドポイントの設定について"><a href="#補足-1-ログ-インジェスト-エンドポイントの設定について" class="headerlink" title="補足 1 : ログ インジェスト エンドポイントの設定について"></a>補足 1 : ログ インジェスト エンドポイントの設定について</h4><p>ログ インジェスト API を使用しない場合、およびカスタム ログ、IIS ログの収集を行わない場合、このデータ収集エンドポイントの設定は必要ありません。<br>この場合、ログは Log Analytics ワークスペース リソース固有のエンドポイントを介して収集されます。</p><h4 id="補足-2-メトリック-インジェスト-エンドポイントの設定について"><a href="#補足-2-メトリック-インジェスト-エンドポイントの設定について" class="headerlink" title="補足 2 : メトリック インジェスト エンドポイントの設定について"></a>補足 2 : メトリック インジェスト エンドポイントの設定について</h4><p>2024 年 7 月時点で、Prometheus メトリックを Azure Monitor ワークスペースに収集するデータ収集ルールを作成すると、自動的にそのデータ収集ルールに、メトリック インジェスト エンドポイントとしての DCE が新規作成され紐づけられます (すなわちお客様ご自身で作成し、紐づける必要はございません) 。<br>この自動で DCE が作成され紐づけられる仕様は、ログ インジェスト エンドポイントとは異なります。<br>そのため、以降本 blog 内では [基本] タブで設定する DCE はログ インジェスト エンドポイント用の DCE として扱います。<br>尚、Prometheus メトリックの収集方法については、下記の参考情報をご確認ください。  </p><p>(参考情報) Prometheus 用の Azure Monitor マネージド サービス<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/prometheus-metrics-overview#enable">https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/prometheus-metrics-overview#enable</a></p><h3 id="データ収集ルールの作成-リソース-タブ"><a href="#データ収集ルールの作成-リソース-タブ" class="headerlink" title="データ収集ルールの作成 - [リソース] タブ"></a>データ収集ルールの作成 - [リソース] タブ</h3><h4 id="設定方法-1"><a href="#設定方法-1" class="headerlink" title="設定方法"></a>設定方法</h4><p>Azure portal のデータ収集ルールの作成手順における [リソース] タブで設定します。<br>以下画像に示す “データ収集エンドポイントを有効にする” のチェック ボックスにチェックを入れ、”データ収集エンドポイント” 列でエンドポイントを設定します。</p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/dce-getconfig.png" alt="alt text"></p><h4 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h4><p>構成アクセス エンドポイントを設定します。</p><h4 id="制限事項-1"><a href="#制限事項-1" class="headerlink" title="制限事項"></a>制限事項</h4><ul><li>収集元の VM と同じリージョンに存在する必要があります。</li><li>1 つの VM に複数の DCE を紐づけることはできません。</li></ul><h4 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h4><p>Azure Private Link Scope (APMPLS) を使用せずにログ収集を行う場合、このデータ収集エンドポイントの設定は必要ありません。<br>この場合、Azure Monitor エージェントはグローバルまたはリージョン共通の構成アクセス エンドポイント (下記参考情報のハイライト箇所) を介して構成情報を取得します。</p><p>(参考情報) ファイアウォールの要件</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows#firewall-requirements">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows#firewall-requirements</a></p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/configaccessDCE_globalregional.png" alt="alt text"></p><h2 id="具体的なシナリオ"><a href="#具体的なシナリオ" class="headerlink" title="具体的なシナリオ"></a>具体的なシナリオ</h2><p>※ このセクションでは、メトリックの収集を行わないシナリオをご紹介します。メトリックの収集を行いたい場合は、[基本] タブで設定するデータ収集エンドポイントと収集先の Azure Monitor ワークスペースを同じリージョンに配置する必要があります (<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90---%E5%9F%BA%E6%9C%AC-%E3%82%BF%E3%83%96">データ収集ルールの作成 - [基本] タブ</a>)。</p><h3 id="ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい"><a href="#ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい" class="headerlink" title="ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい"></a>ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい</h3><ul><li>ログ インジェスト エンドポイント用の DCE が必要です。</li><li>DCE は DCE と紐づけを行うデータ収集ルール、および送信先 Log Analytics ワークスペースと同じリージョンに存在している必要があります。</li></ul><h4 id="例-1"><a href="#例-1" class="headerlink" title="例 1"></a>例 1</h4><p>VM が Log Analytics ワークスペースおよびデータ収集ルールと同じリージョン (下図のリージョン A) に存在する場合、DCE (ログ インジェスト エンドポイント) もリージョン A に配置します。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/logingest_ex1.png" alt="alt text"></p><h4 id="例-2"><a href="#例-2" class="headerlink" title="例 2"></a>例 2</h4><p>VM が Log Analyics ワークスペースおよびデータ収集ルールと異なるリージョンに存在する場合、DCE は Log Analyics ワークスペースおよびデータ収集ルールと同じリージョン (下図のリージョン B) に配置します。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/logingest_ex2.png" alt="alt text"></p><h3 id="Azure-Private-Link-Scope-を使用してログを収集したい"><a href="#Azure-Private-Link-Scope-を使用してログを収集したい" class="headerlink" title="Azure Private Link Scope を使用してログを収集したい"></a>Azure Private Link Scope を使用してログを収集したい</h3><ul><li>構成アクセス エンドポイント用の DCE が必要です。</li><li>DCE はデータ収集元の VM と同じリージョンに存在している必要があります</li></ul><p>※ 以降の図内では、簡略化のためグローバル/リージョン共通のログ インジェスト エンドポイントを省略しております。</p><h4 id="例-1-1"><a href="#例-1-1" class="headerlink" title="例 1"></a>例 1</h4><p>VM が Log Analytics ワークスペースおよびデータ収集ルールと同じリージョン (下図のリージョン A) に存在する場合、DCE (構成アクセス エンドポイント) もリージョン A に配置します。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/configaccess_ex1.png" alt="alt text"></p><h4 id="例-2-1"><a href="#例-2-1" class="headerlink" title="例 2"></a>例 2</h4><p>1 つのデータ収集ルールに複数の VM を紐づける場合、それぞれの VM に対して DCE (構成アクセス エンドポイント) を設定する必要があります。<br>VM と VM に設定する DCE は同じリージョンに存在している必要があります。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/configaccess_ex4.png" alt="alt text"></p><h3 id="ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい-かつ-Azure-Private-Link-Scope-を使用してログを収集したい"><a href="#ログ-インジェスト-API-を使用したい-カスタム-ログ-または-IIS-ログを収集したい-かつ-Azure-Private-Link-Scope-を使用してログを収集したい" class="headerlink" title="ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい かつ Azure Private Link Scope を使用してログを収集したい"></a>ログ インジェスト API を使用したい / カスタム ログ または IIS ログを収集したい かつ Azure Private Link Scope を使用してログを収集したい</h3><ul><li>ログ インジェスト エンドポイント用の DCE と構成アクセス エンドポイント用の DCE が必要です。</li><li>必要な DCE の数は VM が Log Analytics ワークスペースおよびデータ収集ルールと同じリージョンに存在しているかどうかで変わります。</li></ul><h4 id="例-1-2"><a href="#例-1-2" class="headerlink" title="例 1"></a>例 1</h4><p>VM と Log Analytics ワークスペース、データ収集ルールが 1 つのリージョン (下図のリージョン A) に存在する場合、1 つの DCE をログ インジェスト エンドポイントと構成アクセス エンドポイントの両方に設定することで、収集の要件を達成することができます。  </p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/dceshared_ex1.png" alt="alt text"></p><h4 id="例-2-2"><a href="#例-2-2" class="headerlink" title="例 2"></a>例 2</h4><p>VM が Log Analytics ワークスペースおよびデータ収集ルールと異なるリージョンに存在する場合、2 つの DCE が必要です。<br>構成アクセス エンドポイントとしての DCE は VM と同じリージョンに、ログ インジェスト エンドポイントとしての DCE は Log Analytics ワークスペースおよびデータ収集ルールと同じリージョンに、それぞれ配置する必要があります。</p><p><img src="/blog/LogAnalytics/DataCollectionEndpoint/dcenotshared.png" alt="alt text"></p><h2 id="データ収集エンドポイントに関する-FAQ"><a href="#データ収集エンドポイントに関する-FAQ" class="headerlink" title="データ収集エンドポイントに関する FAQ"></a>データ収集エンドポイントに関する FAQ</h2><p><strong>Q1.</strong> 既存のデータ収集エンドポイントが 1 つ存在する場合、それをデータ収集ルール作成時の [基本] タブと [リソース] の両方で指定することはできますか？</p><p><strong>A1.</strong> はい、可能です。<br>ただし、この場合はデータ収集ルール、送信先 Log Analytics ワークスペース (メトリック収集の場合は Azure Monitor ワークスペース)、送信元 VM、データ収集エンドポイントがすべて同じリージョンに存在する必要があります。</p><hr><p><strong>Q2.</strong> 最低限必要なデータ収集エンドポイントの数が分かりません。どのように考えればよいですか？</p><p><strong>A2.</strong> ログ インジェスト エンドポイント (メトリック収集の場合はメトリック インジェスト エンドポイント)、構成アクセス エンドポイントのどちらが必要かによって考え方が異なります。  </p><p>ログ インジェスト エンドポイント (メトリック インジェスト エンドポイント) だけが必要な場合、必要な DCE の最低数は、送信先の Log Analytics ワークスペース (Azure Monitor ワークスペース) と使用するデータ収集ルールが存在するリージョンの数です。<br>この際、1 つの Log Analytics ワークスペース (Azure Monitor ワークスペース) と、それに紐づいているデータ収集ルール, DCE は同じリージョンに存在している必要があります。  </p><p>構成アクセス エンドポイントだけが必要な場合、必要な DCE の最低数は送信元の VM が存在しているリージョンの数です。<br>この際、VM とそれに紐づける DCE は同じリージョンに存在している必要があります (複数の VM に同じ DCE を設定することができます)。</p><p>なお、ログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイントと構成アクセス エンドポイントの両方が必要な場合、それぞれのエンドポイントの条件を満たしていれば、 1 つのエンドポイントをログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイントと構成アクセス エンドポイントの両方に使用することが可能です。</p><hr><p><strong>Q3.</strong> データ収集エンドポイントには料金がかかりますか？</p><p><strong>A3.</strong> データ収集エンドポイントの使用にあたり、料金は発生しません。</p><hr><p><strong>Q4.</strong> Windows VM と Linux VM, どちらに対しても同じデータ収集エンドポイントを指定できますか？</p><p><strong>A4.</strong> OS の種類に関わらず、複数の VM に 1 つのDCE (構成アクセス エンドポイント) を紐づけることが可能です。<br>この際も、VM とそれに紐づける DCE は同じリージョンに存在している必要があります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>データ収集ルールを作成する際、ご自身の環境においてログ インジェスト エンドポイントおよびメトリック インジェスト エンドポイントと構成アクセス エンドポイント、それぞれ設定が必要かどうかを検討する必要があります。<br>そして必要なデータ収集エンドポイントの数は Log Analytics ワークスペース (メトリック収集の場合は Azure Monitor ワークスペース) および VM が存在するリージョンによって変化します。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの徳田です。&lt;/p&gt;
&lt;p&gt;本ブログでは、以下の公開情報に記載されていますデータ収集エンドポイントについて、その設定方法、利用目的、設定時の制限事項を、具体例を用いてご説明します。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal&quot;&gt;https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM における死活監視の考え方</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM02/</id>
    <published>2024-07-02T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.331Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回は、Azure Monitor による Azure VM の死活監視の考え方についてご紹介したいと思います。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E5%90%84%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%81%AE%E7%9B%A3%E8%A6%96%E6%96%B9%E6%B3%95">2. 各レイヤーの監視方法</a></li><li><a href="#3-VM-%E3%83%9B%E3%82%B9%E3%83%88%E3%81%AE%E7%9B%A3%E8%A6%96">3. VM ホストの監視</a><ul><li><a href="#3-1-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E2%80%98VM-Availability-Metric-Preview-%E2%80%99-%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">3-1. メトリック ‘VM Availability Metric (Preview)’ を監視する方法</a></li><li><a href="#3-2-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%92%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">3-2. リソース正常性を監視する方法</a></li></ul></li><li><a href="#4-VM-%E3%82%B2%E3%82%B9%E3%83%88%E3%81%AE%E7%9B%A3%E8%A6%96">4. VM ゲストの監視</a><ul><li><a href="#4-1-Heartbeat-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88">4-1. Heartbeat を利用したログ アラート</a></li><li><a href="#4-2-Heartbeat-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%AE%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88">4-2. Heartbeat を利用したログのメトリック アラート</a></li></ul></li><li><a href="#5-VM-%E4%B8%8A%E3%81%A7%E7%A8%BC%E5%83%8D%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD%E3%81%AE%E7%9B%A3%E8%A6%96">5. VM 上で稼働している機能の監視</a></li><li><a href="#6-Heartbeat-%E3%81%AE%E5%8F%8E%E9%9B%86%E9%81%85%E5%BB%B6%E3%81%AB%E5%BD%B1%E9%9F%BF%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E7%9B%A3%E8%A6%96%E6%96%B9%E6%B3%95">6. Heartbeat の収集遅延に影響されない監視方法</a><ul><li><a href="#6-1-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E8%A9%95%E4%BE%A1%E6%9C%9F%E9%96%93%E3%82%92%E9%95%B7%E3%82%81%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B">6-1. アラートの評価期間を長めに設定する</a></li><li><a href="#6-2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E3%81%97%E3%81%8D%E3%81%84%E5%80%A4%E3%82%92%E7%B7%A9%E5%92%8C%E3%81%99%E3%82%8B">6-2. アラートのしきい値を緩和する</a></li><li><a href="#6-3-Heartbeat-%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8F%E3%80%81VM-Availability-Metric-Preview-%E3%82%84%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%81%A7%E7%9B%A3%E8%A6%96%E3%81%99%E3%82%8B">6-3. Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する</a></li></ul></li></ul><br><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p>Azure VM の死活監視にはいくつか方法がありますが、Heartbeat を利用した監視をご利用されている方が多いかと思います。</p><p>Heartbeat は Azure Monitor エージェントや Log Analytics エージェントによって Log Analytics ワークスペースに収集されます。<br>エージェントによって収集されるログは、基本的にはログが生成されてから 20 秒から 3 分程度で Log Analytics ワークスペースで検索可能となります。しかし、Azure サービスの負荷が高い場合や Azure 基盤側で障害が発生している場合等、様々な要因でログの収集に遅延が生じたり、ログが欠損することがあります。このような状況では Azure VM 自体は正常に稼働していても、アラートが発報する可能性があります。</p><p>弊社 Azure サービスでは、お客様の環境に影響を及ぼす障害が発生しないように日々サービスの品質向上に努めておりますが、<br>ログの収集遅延や欠損が発生する障害が発生した際には、アラートの誤検知に関するお問い合わせを沢山いただきます。</p><p>このような障害が発生した際、Heartbeat による死活監視のみを利用されている場合には、大変心苦しいのですが障害が解消されるまでお待ちいただくしかありません。そのため、弊社としては Heartbeat 以外の死活監視方法を代替案としてご案内させていただいたり、障害が発生した場合でも死活監視を継続できるように死活監視の冗長化を推奨しております。</p><p>今回は、VM の監視方法をレイヤーに分けてご紹介します。<br>お客様には誠に申し訳ございませんが、Heartbeat を含むどの監視方法も 100% の信頼性を保証することはできません。<br>Heartbeat を利用した監視だけではなく、他の監視方法も併用することで障害時でも VM の監視を継続できるようになります。<br>また、Heartbeat の収集遅延の影響を受けずに監視する場合には、Heartbeat 以外を利用した監視方法をご検討ください。<br>各レイヤーの監視方法の特性と内容をご確認いただき、お客様のご要件に合った監視方法や、監視の冗長化をご検討いただけますと幸いです。</p><div class="alert is-important"><p class="alert-title">重要</p><p>Log Analytics エージェントは 2024 年 8 月に廃止されるため、Azure Monitor エージェントへの移行をお願いしております。詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration">弊社公開情報</a> や <a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromLA/">弊社サポート ブログ</a> をご覧ください。</p></div><br><h2 id="2-各レイヤーの監視方法"><a href="#2-各レイヤーの監視方法" class="headerlink" title="2. 各レイヤーの監視方法"></a>2. 各レイヤーの監視方法</h2><p>各レイヤーの VM の監視方法を記載します。<br>複数のアラートで同時に VM の異常を検知した際に VM の状態を確認するなど、お客様のご状況に沿った方法の使用をご検討いただければ幸いです。</p><table><thead><tr><th>レイヤー</th><th>アラート</th></tr></thead><tbody><tr><td>VM ホストの監視</td><td>VM Availability Metric (Preview) <br>リソース正常性</td></tr><tr><td>VM ゲストの監視</td><td>Heartbeat</td></tr><tr><td>VM上で稼働している機能の監視</td><td>可用性テスト</td></tr></tbody></table><br><h2 id="3-VM-ホストの監視"><a href="#3-VM-ホストの監視" class="headerlink" title="3. VM ホストの監視"></a>3. VM ホストの監視</h2><p>VM ホストは、以下の方法で監視できます。</p><ul><li>メトリック ‘VM Availability Metric (Preview)’ を監視する方法</li><li>リソース正常性を監視する方法</li></ul><p>本ブログでは上記 2 つの方法をご紹介しますが、この他にも VM のホスト監視を行う方法がございます。<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/flash-overview#next-steps">こちら</a> の公開情報にも掲載されておりますので、併せてご確認いただけますと幸いです。</p><br><h3 id="3-1-メトリック-‘VM-Availability-Metric-Preview-’-を監視する方法"><a href="#3-1-メトリック-‘VM-Availability-Metric-Preview-’-を監視する方法" class="headerlink" title="3-1. メトリック ‘VM Availability Metric (Preview)’ を監視する方法"></a>3-1. メトリック ‘VM Availability Metric (Preview)’ を監視する方法</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/monitor-vm-reference#vm-availability-metric-preview">VM Availability Metric (Preview) （VM 可用性メトリック (プレビュー)）</a>は Azure VM のホストが出力するメトリックであり、VM の可用性を確認することができます。このメトリックは Heartbeat を収集する Azure Monitor エージェントや Log Analytics エージェントとは関係ないため、エージェントから Log Analytics ワークスペースへのログの出力に問題が発生した際もメトリックは出力されます。<br><img src="/blog/LogAnalytics/MonitorVM02/image01.png"></p><p>VM Availability Metric (Preview) の値が 1 の場合は、VM が実行中であり、利用可能であることを表します。<br>つまり、この値が 1 より小さい場合には VM の可用性が低下していることになりますので、このメトリックを監視するメトリック アラートを構成することで、VM の可用性が低下した場合に発報させることが可能です。<br>このメトリックを利用したアラート ルールの設定方法については、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/tutorial-monitor-vm-alert-availability#view-vm-availability-metric-in-metrics-explorer">こちら</a>の弊社公開情報をご参照ください。<br><img src="/blog/LogAnalytics/MonitorVM02/image02.png"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>VM Availability Metric (Preview) のメトリック アラートで Azure VM が “停止済み (割り当て解除) “ を検知することはできません。VM が “停止済み (割り当て解除)” の場合は VM Availability Metric (Preview) の値は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/metrics-aggregation-explained#null-and-zero-values">NULL</a> になりますが、メトリック アラートではメトリックの値が NULL であることを検知できないためです。予めご留意ください。</p></div><br><h3 id="3-2-リソース正常性を監視する方法"><a href="#3-2-リソース正常性を監視する方法" class="headerlink" title="3-2. リソース正常性を監視する方法"></a>3-2. リソース正常性を監視する方法</h3><p>リソース正常性アラートでは、リソースの正常性に変化が生じた際に通知できます。<br>リソースの状態に変化が発生すると、アクティビティ ログに正常性に関するイベントが書き込まれ、アラートで指定した条件に合致した場合に発報します。Azure VM のリソース正常性では、<a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-checks-resource-types#microsoftcomputevirtualmachines">以下の項目</a>をチェックします。この項目に該当するようなイベントが発生した場合に、リソースの正常性に変化が発生したと判断されます。<br><img src="/blog/LogAnalytics/MonitorVM02/image03.png"></p><p>リソース正常性では、リソースに変化が発生した際に、リソースの現在と過去の正常性 (リソースの状態) について報告します。<br>リソース正常性アラートで指定する条件は以下であり、”現在のリソースの状態” と “過去のリソースの状態” や、”イベントの状態”、イベントが発生した “理由の種類” を指定できます。<br><img src="/blog/LogAnalytics/MonitorVM02/image05.png"></p><p>“イベントの状態” が Active である場合、リソースの正常性が異常な状態であることを表し、Resolved に変化した場合、異常な状態から正常な状態に遷移したことを表します。また、”リソースの状態” が Unavailable はリソースが利用可能でないことを意味し、Available はリソースが利用可能であることを意味します。</p><p>つまり、以下の設定にすると、<br>リソースの状態が 「Available」 の状態から 「Unavailable」 に遷移したタイミングと、<br>リソースの状態が 「Unavailable」 の状態から 「Available」 に遷移したタイミングでアラートがトリガーされ、リソース正常性に変更が発生したタイミング、解消したタイミングで通知を受け取ることが可能です。</p><p>■ イベントの状態 :  Active, Resolved<br>■ 以前のリソースの状態 : Available, Unavailable<br>■ 現在のリソースの状態 : Unavailable, Available,</p><p><img src="/blog/LogAnalytics/MonitorVM02/image04.png"></p><p>VM のリソース正常性アラート ルールの設定方法については、<a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-overview">こちら</a>の弊社公開情報や、<a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/">弊社サポート ブログ</a>も併せてご確認ください。</p><br><h2 id="4-VM-ゲストの監視"><a href="#4-VM-ゲストの監視" class="headerlink" title="4. VM ゲストの監視"></a>4. VM ゲストの監視</h2><p>VM ゲストは、以下の方法で監視できます。</p><ul><li>Heartbeat を利用したログ アラート</li><li>Heartbeat を利用したログのメトリック アラート</li></ul><br><h3 id="4-1-Heartbeat-を利用したログ-アラート"><a href="#4-1-Heartbeat-を利用したログ-アラート" class="headerlink" title="4-1. Heartbeat を利用したログ アラート"></a>4-1. Heartbeat を利用したログ アラート</h3><p>Heartbeat は Log Analytics エージェントや Azure Monitor エージェントによって Log Analytics ワークスペースに収集されます。<br>Log Analytics ワークスペースに収集された Heartbeat を利用して、死活監視の<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">ログ アラート ルール</a>を構成することが可能です。<br>例えば、直近 10 分以内に Heartbeat が収集されていることを確認するログ アラート ルールが発報した場合、アラートが実行された時点から 過去 10 分以内に Heartbeat が途絶えたことになり、該当のマシンにて何らかの問題が発生している可能性がございます。なお、Heartbeat のログ アラートが発報したとしても、必ずしも仮想マシンに問題が発生しているとは限りません。エージェント自体に問題が発生している場合や、ログの収集遅延によってアラートが発報する場合もございます。</p><!--- https://jpazmon-integ.github.io/blog/LogAnalytics/MonitorVM/ ---><br><h3 id="4-2-Heartbeat-を利用したログのメトリック-アラート"><a href="#4-2-Heartbeat-を利用したログのメトリック-アラート" class="headerlink" title="4-2. Heartbeat を利用したログのメトリック アラート"></a>4-2. Heartbeat を利用したログのメトリック アラート</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-metric-logs">ログのメトリック アラート</a>は、Azure Monitor エージェントや Log Analytics エージェントで収集されたログをメトリックに変換し、メトリックを評価するアラート ルールです。</p><p>ログが生成され、Log Analytics のエンドポイントに対してログを送信し、メトリックに変換されてメトリックを検索できるようになるまでの時間と、ログが生成され、Log Analytics のエンドポイントに対してログを送信し、Log Analytics ワークスペース上でアラートの検索クエリでログを検索できるようになるまでの時間を比較した場合、前者の方が早く処理が実施されます。このため、ログ アラート ルールと比較し、「ログのメトリック アラート」の方がよりリアルタイムに近い監視が可能です。</p><p>なお、ログ アラートと同様、Heartbeat メトリックが途絶えたとしても、マシンに問題が発生しているとは限りません。<br>ログが生成され Log Analytics のエンドポイントに到着するまでの間に遅延が発生していた場合には、ログのメトリック アラートでも遅延の影響を受けてアラートが発報します。Log Analytics のエンドポイントに到着するまでの間に遅延が発生すると、メトリックの変換も遅延し、結果的にメトリックの収集遅延が発生するためです。また、Azure Monitor の基盤側の問題により、変換されたメトリックが欠損してしまう可能性があり、欠損の影響でアラートが発報することも考えられます。</p><p><img src="/blog/LogAnalytics/MonitorVM02/image06.png"></p><br><h2 id="5-VM-上で稼働している機能の監視"><a href="#5-VM-上で稼働している機能の監視" class="headerlink" title="5. VM 上で稼働している機能の監視"></a>5. VM 上で稼働している機能の監視</h2><p>VM で動作するアプリケーションの死活監視を行います。<br>ホストやゲストの監視に異常が発生しても、アプリケーションが正常に動作していれば VM に異常は発生していないと判断できる場合もあります。</p><p>アプリケーションは Application Insights の<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-overview">可用性テスト</a>を使用して死活監視できます。<br>可用性テストは弊社の世界各地のサーバーから定期的にアプリケーションに Web リクエストを送信し可用性を確認する機能です。</p><p>可用性テストは、「メトリック ‘VM Availability Metric (Preview)’ を監視する方法」、「Heartbeat を利用した監視方法」および「リソース正常性を監視する方法」とは独立した機能です。アプリケーションが動作している際に Heartbeat に異常が発生しても、可用性テストが正常であればアプリケーションに問題は起きておらず、VM も正常に動作していると判断いただけます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-standard-tests">可用性テストの設定方法</a>及び、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/availability-alerts">アラート ルールの設定方法</a> は、公開情報をご参照いただけますと幸いです。</p><p>なお、Application Insights の可用性テストを使って監視を行う場合は、監視対象の VM に HTTP/HTTPS のリクエストを受け取るための Web サーバー構築が必要です。Application Insights の可用性テストは、Application Insights で管理しているテスト クライアントから監視対象の VM に対して定期的に HTTP/HTTPS のプロトコルでリクエストを送信し、期待するレスポンスが返ってくるかどうかを評価する機能であるためです。HTTP/HTTPS リクエストを受け取る Web サーバーが構築されていないとご利用出来ないので、ご注意ください。</p><p>また、標準テストは、インターネットからアクセスできるエンドポイントが必要です。<br>もしプライベート ネットワークからのみを許可する機能の監視を行う必要がありましたら、弊社サポート ブログでご案内しております <a href="https://jpazmon-integ.github.io/blog/applicationInsights/privateAvailabilityTestSampleCode/">Azure Functions を使用した可用性テスト</a>を作成いただけますと幸いです。</p><br><h2 id="6-Heartbeat-の収集遅延に影響されない監視方法"><a href="#6-Heartbeat-の収集遅延に影響されない監視方法" class="headerlink" title="6. Heartbeat の収集遅延に影響されない監視方法"></a>6. Heartbeat の収集遅延に影響されない監視方法</h2><p>Heartbeat のログ アラートやログのメトリック アラートを構成されているお客様から「VM は正常に稼働しているがアラートが発報したため、原因を調査してほしい」というお問い合わせをいただくことがあります。こういったお問い合わせで原因を調査しますと、ログの収集が遅延していた影響でアラートが発報しているケースが多く見受けられます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-ingestion-time#average-latency">ログ データを取り込むための一般的な待ち時間は 20 秒から 3 分</a>です。<br>Heartbeat のアラートを構築しているお客様には申し訳ございませんが、以下の要因等によりログの取り込みに遅延が発生する場合がございます。</p><ul><li>Azure Monitor エージェントや Log Analytics エージェントがインストールされたコンピューターに一時的に負荷が発生し、エージェントの動作に影響した。</li><li>何らかの原因で Azure Monitor エージェントや Log Analytics エージェントが停止していた。</li><li>何らかの原因でネットワークに異常が発生し、クライアントから Log Analytics ワークスペースへのデータ送信に失敗。エージェント側の再試行処理により、データの取り込みに時間を要した。</li><li>Azure 基盤側で問題が発生し、Log Analytics ワークスペース上でクエリ検索できるまでに時間を要した。</li></ul><p>また、ログのメトリック アラートではエージェントから Log Analytics のエンドポイントにデータが送信された後、基盤側でログをメトリックに変換します。そのため、Log Analytics のエンドポイントにデータが到着するまでに遅延が発生した場合や、メトリックへの変換処理にて遅延が発生した場合には、ログのメトリック アラートでも収集遅延による誤検知が発生する可能性がございます。</p><p>Heartbeat の収集遅延に影響されない監視方法について聞かれることがよくありますが、<br>弊社サポートとしては基本的に以下 3 つのことをご検討いただくことをご案内しております。</p><ul><li>アラートの評価期間を長めに設定する</li><li>アラートの閾値を緩和する</li><li>Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する</li></ul><br><h3 id="6-1-アラートの評価期間を長めに設定する"><a href="#6-1-アラートの評価期間を長めに設定する" class="headerlink" title="6-1. アラートの評価期間を長めに設定する"></a>6-1. アラートの評価期間を長めに設定する</h3><p>ログの収集遅延に起因したアラートの発報を減らす方法として、アラートの評価期間を長めに設定いただくことを推奨しております。Log Analytics ワークスペースに収集されるデータや、ログからメトリックに変換するデータでは、収集遅延や待機時間が発生いたします。</p><p>「アラートの評価期間」とは、1 回の評価を行う際に評価の対象となる期間を意味します。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-log-alert-rule">ログ アラート</a>の場合は [集計の粒度]、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-create-metric-alert-rule">ログのメトリック アラート</a>の場合は [ルックバック期間] に該当します。この [集計の粒度] や [ルックバック期間] が短ければ短いほど (例. 1 分や 5 分) 、収集遅延の影響を受けやすくなります。</p><p>ログ アラートやログのメトリック アラートでは、ログの TimeGenerated やメトリックの timestamp をもとに評価期間内のデータを検索します。アラート ルールの評価時点でログやメトリックが取り込まれていない場合、アラートのしきい値を満たしてアラートが発報してしまいます。ログやメトリックの収集遅延により期待しないアラート発報を緩和させるためには、[集計の粒度] や [ルックバック期間] をより長い期間へとご指定いただけますと幸いです。</p><br><h3 id="6-2-アラートのしきい値を緩和する"><a href="#6-2-アラートのしきい値を緩和する" class="headerlink" title="6-2. アラートのしきい値を緩和する"></a>6-2. アラートのしきい値を緩和する</h3><p>Heartbeat のログ アラートで以下のように設定していたとします。<br>この場合、[評価の頻度] の 5 分毎に、直近 5 分以内に収集された Heartbeat のレコード数が [しきい値] の 3 以下であった場合に発報します。アラートのしきい値を緩和する場合には、例えば、[しきい値] を 「3 以下」から「0 以下」に設定する方法が考えられます。</p><ul><li>メジャー: テーブルの行</li><li>集計の種類: カウント</li><li>集計の粒度: 5 分 </li><li>演算子: 次の値以下</li><li>しきい値: 3</li><li>評価の頻度: 5分</li></ul><br><h3 id="6-3-Heartbeat-を利用したアラートではなく、VM-Availability-Metric-Preview-やリソース正常性で監視する"><a href="#6-3-Heartbeat-を利用したアラートではなく、VM-Availability-Metric-Preview-やリソース正常性で監視する" class="headerlink" title="6-3. Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する"></a>6-3. Heartbeat を利用したアラートではなく、VM Availability Metric (Preview) やリソース正常性で監視する</h3><p>ログやメトリックを取り込むまでに遅延が発生する場合がございます。<br>エージェントや Log Analytics 基盤等による収集遅延を受けない監視方法として、リソース正常性や VM Availability Metric (Preview) を監視する方法をご検討ください。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回は、Azure Monitor による Azure VM の死活監視の考え方についてご紹介したいと思います。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>Azure Arc のオンボードスクリプトの留意点</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_onboard_FAQ/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_onboard_FAQ/</id>
    <published>2024-05-30T12:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.107Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。<br>当ページでは、Azure Arc のオンボードスクリプトの留意点について説明します。</p><p>Azure Arc にオンボードできる OS やソフトウェアには幾つか種類がございますが、当ページでは Windows マシンを主に、一部 Linux マシンをオンボードすることも含めて解説します。<br>また、オンボードするためのスクリプトの種別は以下 3 点ございますが、本日は多くのお問い合わせを頂戴する ”単一サーバーの追加” について解説いたします。</p><ul><li>単一サーバーの追加</li><li>複数のサーバーの追加 </li><li>Update Management でサーバーを追加する</li></ul><p>まず基本のオンボードの流れは以下の当社公開ページに記載しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/learn/quick-enable-hybrid-vm">クイックスタート: Azure Arc 対応サーバーにハイブリッド マシンを接続する</a></p><p>上記ページに記載のように Azure ポータル上で作成いただいたスクリプトをオンボードさせたいマシン上で実行する運びとなります。</p><p>失敗事例と改善策をお伝えする前に一度オンボードスクリプトの内容を解説いたします。</p><h2 id="Windows-マシン向けスクリプトについて"><a href="#Windows-マシン向けスクリプトについて" class="headerlink" title="Windows マシン向けスクリプトについて"></a>Windows マシン向けスクリプトについて</h2><p>下図 1 の通り大まかな流れとしては接続先の情報を変数に代入した後、Connected Machine エージェントをインストールするため、install_windows_azcmagent.ps1 がダウンロードされ、実行されます。<br>その後、インストールされた Connected Machine エージェントの実行ファイルを使用してオンボード処理をしております。<br>尚、install_windows_azcmagent.ps1 の内容は <a href="https://gbl.his.arc.azure.com/installationScripts?api-version=1.0-preview&platform=windows">こちら</a> からご確認いただくことが可能です。<br>内容の詳細は割愛しますが、この中でエージェントのインストーラファイル”AzureConnectedMachineAgent.msi”がダウンロードされ、その後実行されます。<br>■図 1. Windows マシン向けのスクリプト<br><img src="/blog/Arc/Arc_onboard_FAQ/01.png"></p><h2 id="Linux-マシン向けスクリプトについて"><a href="#Linux-マシン向けスクリプトについて" class="headerlink" title="Linux マシン向けスクリプトについて"></a>Linux マシン向けスクリプトについて</h2><p>下図 2 が Linux 向けとなりますが、Windows 向けと同じと流れとなります。<br>■図 2. Linux マシン向けのスクリプト<br><img src="/blog/Arc/Arc_onboard_FAQ/02.png"></p><h1 id="留意点・失敗事例について"><a href="#留意点・失敗事例について" class="headerlink" title="留意点・失敗事例について"></a>留意点・失敗事例について</h1><h2 id="留意点-1：proxy-サーバーを経由し、且つプラベート-エンドポイントへ接続するシナリオ"><a href="#留意点-1：proxy-サーバーを経由し、且つプラベート-エンドポイントへ接続するシナリオ" class="headerlink" title="留意点 1：proxy サーバーを経由し、且つプラベート エンドポイントへ接続するシナリオ"></a>留意点 1：proxy サーバーを経由し、且つプラベート エンドポイントへ接続するシナリオ</h2><p>Azure ポータル画面でスクリプト作成の条件を設定いただいている中で下図 3 の箇所がございます。<br>お客様環境に依ってはプロキシ サーバーを経由し、且つプラベート エンドポイントへ接続する用件があるかと存じます。<br>その場合、自動で作成されるスクリプトでは動作しないため、まずは下図 3 のように ”プラベート エンドポイント”を選択して、スクリプトのダウンロードまでお進みください。</p><p>■図 3. 接続方法の設定個所の画面<br><img src="/blog/Arc/Arc_onboard_FAQ/03.png"></p><p>上記シナリオの場合以下のような手順でお進みください。</p><h3 id="step-1：エージェントのインストール"><a href="#step-1：エージェントのインストール" class="headerlink" title="step 1：エージェントのインストール"></a>step 1：エージェントのインストール</h3><p>最新のエージェントインストーラを <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/agent-overview#agent-resources">こちら</a> ページの手順でダウンロードおよびインストールいただき、対象マシンにConnected Machine エージェントをインストールまでお進みください。</p><h3 id="step-2：プロキシ設定"><a href="#step-2：プロキシ設定" class="headerlink" title="step 2：プロキシ設定"></a>step 2：プロキシ設定</h3><p>以下ページの手順に従いプロキシ環境向けの設定を行います。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/manage-agent?tabs=windows#update-or-remove-proxy-settings">プロキシ設定の更新または削除</a> </p><p>ここでプロキシ設定について 2 種類の説明がありますので、ここでも解説いたします。<br>上記公開ページに記載の通り、エージェントが Arc 関連の通信をする際にプロキシ向けに通信させる方法は以下２つ、両方の設定がされている場合は前者が採用される仕様となっております。</p><ul><li>エージェント構成（azcmagent config コマンドによる設定）</li><li>システム環境変数への設定</li></ul><p>また注意点として ‘netsh winhttp show proxy’ コマンドで確認できる Windows システム全体のプロキシ設定が構成されていても”システム環境変数への設定”が無い場合はプロキシサーバー向けに通信されない仕様となります。</p><p>そのため上記仕様を踏まえ、どちらの設定をするかご検討いただくようお願いいたします。<br>推奨は ”エージェント構成（azcmagent config コマンドによる設定）” となります。<br>尚、’azcmagent config’ コマンドは公開情報に ”Bash” と記載されておりますが、エージェントをインストールする Windows 上の PowerShell で実行いただけるコマンドとなります。</p><p>設定後に ‘azcmagent show’ コマンドを実行すると下図 3 のように通信を向けるプロキシサーバーならびに bypass（※）設定を確認いただけます。<br>■図 4. ‘azcmagent config’ コマンド および ‘azcmagent config’ コマンド 実行の画面<br><img src="/blog/Arc/Arc_onboard_FAQ/04.png"></p><p>※プロキシサーバーに向けない宛先グループ<br>　Arc と記載されている場合は、プライベートリンク向けの通信はプロキシサーバーへ通信を向けない事を意味します。</p><h3 id="step-3：オンボード"><a href="#step-3：オンボード" class="headerlink" title="step 3：オンボード"></a>step 3：オンボード</h3><p>最後に PowerShell を管理者権限で開いていただき、『図 1. Windows マシン向けのスクリプト』の ”接続先情報を変数に定義” および ”Connected Machine エージェントの接続コマンドを実行”をすることでオンボードが可能となります。<br>図1 のコマンドでなく、ダウンロードしたスクリプトから変数や接続コマンドをコピーして、PowerShell にて 1 行ずつ実行ください。</p><p>上記手順によりプロキシサーバーを使用する環境であり、且つプライベート エンドポイントへ接続するご要件を満たすことが可能となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;br&gt;当ページでは、Azure Arc のオンボードスクリプトの留意点について説明します。&lt;/p&gt;
&lt;p&gt;Azure Arc にオンボードできる OS やソ</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="howto" scheme="https://jpazmon-integ.github.io/blog/tags/howto/"/>
    
    <category term="オンボード script" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%82%AA%E3%83%B3%E3%83%9C%E3%83%BC%E3%83%89-script/"/>
    
  </entry>
  
  <entry>
    <title>Azure Automation の PowerShell Runbook に関するお問い合わせを発行いただく前の確認ポイント</title>
    <link href="https://jpazmon-integ.github.io/blog/automation/HowToCreatePowerShellRunbookSR/"/>
    <id>https://jpazmon-integ.github.io/blog/automation/HowToCreatePowerShellRunbookSR/</id>
    <published>2024-05-20T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.371Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの花房です！<br>今回は Azure Automation の PowerShell Runbook でよくいただくお問い合わせをもとに、いくつか起票前にご確認いただきたいポイントをご紹介いたします。<br>今回ご紹介するポイントをふまえてお問い合わせを発行いただきますと、よりスムーズな調査が可能ですので、少しでもご参考になれば幸いです！  </p><p>本ブログでは、以下の 2 つのシナリオのお問い合わせにフォーカスいたします。<br>シナリオ A. Azure Automation の PowerShell Runbook がうまく動作していない、エラーとなる<br>シナリオ B. Runbook の書き方が分からない  </p><br><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E3%82%B7%E3%83%8A%E3%83%AA%E3%82%AA-a--azure-automation-%E3%81%AE-powershell-runbook-%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E5%8B%95%E4%BD%9C%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%A8%E3%81%AA%E3%82%8B">シナリオ A. Azure Automation の PowerShell Runbook がうまく動作していない、エラーとなる</a><ul><li><a href="#%E3%82%B7%E3%83%8A%E3%83%AA%E3%82%AA-a-%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E7%99%BA%E8%A1%8C%E5%89%8D%E3%81%AE%E7%A2%BA%E8%AA%8D%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">シナリオ A のお問い合わせ発行前の確認ポイント</a></li></ul></li><li><a href="#%E3%82%B7%E3%83%8A%E3%83%AA%E3%82%AA-b-powershell-runbook-%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9%E3%81%8C%E5%88%86%E3%81%8B%E3%82%89%E3%81%AA%E3%81%84">シナリオ B. PowerShell Runbook の書き方が分からない</a><ul><li><a href="#%E3%82%B7%E3%83%8A%E3%83%AA%E3%82%AA-b-%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E7%99%BA%E8%A1%8C%E5%89%8D%E3%81%AE%E7%A2%BA%E8%AA%8D%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">シナリオ B のお問い合わせ発行前の確認ポイント</a></li></ul></li><li><a href="#automation-%E3%81%AE%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%E3%81%A8%E3%81%97%E3%81%A6%E8%B5%B7%E7%A5%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">Automation のお問い合わせとして起票する場合</a></li><li><a href="#%E5%85%B1%E9%80%9A%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9-%E3%82%AE%E3%83%A3%E3%83%A9%E3%83%AA%E3%83%BC%E3%81%AE-runbook-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">共通の注意点 (ギャラリーの Runbook について)</a></li><li><a href="#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB">さいごに</a></li></ul><br><h2 id="シナリオ-A-Azure-Automation-の-PowerShell-Runbook-がうまく動作していない、エラーとなる"><a href="#シナリオ-A-Azure-Automation-の-PowerShell-Runbook-がうまく動作していない、エラーとなる" class="headerlink" title="シナリオ A . Azure Automation の PowerShell Runbook がうまく動作していない、エラーとなる"></a>シナリオ A . Azure Automation の PowerShell Runbook がうまく動作していない、エラーとなる</h2><p>「Azure Automation の Runbook がうまく動作していないようだけれど要因が分からない」 という場合に、お問い合わせいただくことがございます。<br>この要因には、”Azure Automation 側 (Azure 基盤側)” と “お客様のスクリプト側” のどちらかに問題があることが考えられます。  </p><p>このどちらかを切り分けるため、「お客様のスクリプトには問題がなさそう」 ということをまずお客様にてご確認いただくことで、弊社での調査がスムーズになり、より短い調査時間で見解をご案内できます！  </p><p>前提として、本サポート サービスでは、お客様のスクリプトの解析は行っておりません。<br>(これは Azure Automation に限りません。)<br>お客様のスクリプトを弊社で解析することは、大変な時間を要しますし、間違っている場合には調査結果も異なることになります。<br>結果、大変な調査時間をいただいたにも関わらず、見当違いの回答を差し上げることにもなってしまいます。<br>これは、せっかくお待ちいただいたお客様にとっても、一生懸命に調査した私どもサポート エンジニアにとっても、とても残念な結果です。<br>このような点からも、お客様のスクリプトは、お客様にて解析いただく必要がございます。  </p><p>一方で、お客様にてスクリプトの問題なのかをご判断いただくのは難しい場合があるかと存じます。<br>そのような場合、以下のポイントをご参照くださいませ！  </p><br><h3 id="シナリオ-A-のお問い合わせ発行前の確認ポイント"><a href="#シナリオ-A-のお問い合わせ発行前の確認ポイント" class="headerlink" title="シナリオ A のお問い合わせ発行前の確認ポイント"></a>シナリオ A のお問い合わせ発行前の確認ポイント</h3><p><strong>★ A-1. ローカルで動作するのか</strong><br>対象の Runbook (PowerShell スクリプト) がローカルで実行した際もエラーとなる場合には、Automation 固有の問題ではないと考えられます。<br>スクリプトをデバックしていただき、エラーの対象となるリソースのお問い合わせとして起票いただけますと、よりスムーズな調査が可能です。<br>一方で、ローカルでは問題なく動作する場合、Automation 側の問題である可能性がございます。<br>この場合には、Automation のお問い合わせとして起票ください！<br>その際に添えていただきたい情報は、後述の 「Automation のお問い合わせとして起票する場合」 をご参照くださいませ。  </p><p><strong>★ A-2. 出力されるエラーはスクリプト内で自前で記録したものか</strong><br>Automation で 「xxxx」 というエラーがジョブに記録されている、という状態の場合、そのエラー内容を記録しているスクリプトの該当箇所を特定します。<br>もしもスクリプト側で write-log などで記録しているエラーなのであれば、スクリプト内のデバックを続けることが出来るかと存じます。<br>エラーとなっている個所を特定ができたら、そのエラーに関連しているリソースのお問い合わせとして起票します。  </p><p><strong>★ A-3. これまで Automation 上で動作していたか</strong><br>これまでは Automation 上で問題なく動作していたが、Runbook の内容を変更していないにも関わらずエラーが発生しているような場合には、Automation 側の問題である可能性が考えられます。<br>Automation のお問い合わせとして起票ください！<br>その際に添えていただきたい情報は、後述の 「Automation のお問い合わせとして起票する場合」 をご参照くださいませ。  </p><br><h2 id="シナリオ-B-PowerShell-Runbook-の書き方が分からない"><a href="#シナリオ-B-PowerShell-Runbook-の書き方が分からない" class="headerlink" title="シナリオ B. PowerShell Runbook の書き方が分からない"></a>シナリオ B. PowerShell Runbook の書き方が分からない</h2><p>「“xxxx” という処理を自動化したいけれど、PowerShell Runbook での実現方法が分からない」 という場合に、お問い合わせいただくことがございます。<br>「“xxxx” という処理を実現するためのスクリプトの書き方を知りたい」 というお問い合わせを頂戴することもございます。<br>こちらも前提として、本サポート サービスでは基本的にお客様の要件に合わせたスクリプトのご提供は行っておりません。<br>(こちらも Azure Automation に限りません。)<br>スクリプトは、まずはお客様にて作成ください。  </p><p>その上で、例えば 「Automation 上で xxxx のコマンドは問題なく動作するのか」 という Automation 観点での具体的な内容であれば、ご支援することは可能です！</p><br><h3 id="シナリオ-B-のお問い合わせ発行前の確認ポイント"><a href="#シナリオ-B-のお問い合わせ発行前の確認ポイント" class="headerlink" title="シナリオ B のお問い合わせ発行前の確認ポイント"></a>シナリオ B のお問い合わせ発行前の確認ポイント</h3><p><strong>★ B-1.Automation の PowerShell Runbook で実装するうえで固有の内容か</strong>  </p><p>PowerShell Runbook で実装するうえでの固有の内容であれば、ご支援できます！<br>例えば、「xxx コマンドは Azure Runbook 上で利用できるか」 というご質問です。<br>なお、ローカルで実行可能な PowerShell であれば、基本的に Automation の PowerShell Runbook でもご利用いただけます。<br>このため、ローカルで動作するスクリプトまではお客様で作成ください。</p><p>また、Automation のお問い合わせとして起票いただく際には、ご状況に応じて後述の 「Automation のお問い合わせとして起票する場合」 の情報を添えていただければと存じます。</p> <br><h2 id="共通の注意点-ギャラリーの-Runbook-について"><a href="#共通の注意点-ギャラリーの-Runbook-について" class="headerlink" title="共通の注意点 (ギャラリーの Runbook について)"></a>共通の注意点 (ギャラリーの Runbook について)</h2><p>Azure Automationでは、ギャラリーご提供している PowerShell Runbook があります。<br><img src="/blog/automation/HowToCreatePowerShellRunbookSR/gallery.png"></p><p>これらは弊社コミュニティメンバーの有志により作成・提供されております。<br>ただ、分かりにくくて大変恐縮なのですが、これらは弊社の正式な製品ではなく、あくまでサンプルであり、Runbook 内に不具合が見つかったとしても修正される保証はございません。<br>このため、ギャラリーで提供されている Runbook は、お客様の環境でも動作確認の上でご利用をいただけましたら幸いです。  </p><br><h2 id="Automation-のお問い合わせとして起票する場合"><a href="#Automation-のお問い合わせとして起票する場合" class="headerlink" title="Automation のお問い合わせとして起票する場合"></a>Automation のお問い合わせとして起票する場合</h2><p>上記のポイントをご確認いただき、Automation で調査が必要と考えられる場合には、どうぞいつでもお問い合わせくださいませ！</p><p>その際に、以下の情報を添えていただけますと、より迅速に調査に着手することが可能です。<br>-サブスクリプション ID<br>-Automation アカウント名<br>-Runbook 名<br>-ジョブ ID  </p><br><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>今回は Automation の PowerShell Runbook のお問い合わせを起票いただく際に、ご確認いただきたいポイントをご案内いたしました！<br>私どもサポート チームも、精一杯お問い合わせのご状況や背景や内容を把握したうえで、できる限り迅速なご支援できるよう、毎日調査をしております。<br>ただ、回答までにお時間を要することもございます。<br>少しでもスムーズな回答のために、お客様にて実装された点はお客様にてご確認いただけたらと存じます。  </p><p>ただ、お客さまでは判断が難しい点もあるかと存じます！<br>そのような場合に、上記ポイントが少しでもお客様のお役に立てば大変幸いです。  </p><p>最後までお読みいただきありがとうございました！  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの花房です！&lt;br&gt;今回は Azure Automation の PowerShell Runbook でよくいただくお問い合わせをもとに、いくつか起票前にご確認いただきたいポイントをご紹介いたします。&lt;br&gt;今回ご紹介するポイントをふまえてお問い合わせを発行いただきますと、よりスムーズな調査が可能ですので、少しでもご参考になれば幸いです！  &lt;/p&gt;
&lt;p&gt;本ブログでは、以下の 2 つのシナリオのお問い合わせにフォーカスいたします。&lt;br&gt;シナリオ A. Azure Automation の PowerShell Runbook がうまく動作していない、エラーとなる&lt;br&gt;シナリオ B. Runbook の書き方が分からない  &lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Automation" scheme="https://jpazmon-integ.github.io/blog/tags/Automation/"/>
    
    <category term="Runbook" scheme="https://jpazmon-integ.github.io/blog/tags/Runbook/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor の各種データの保持期間について</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/MonitorRetentionPeriod/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/MonitorRetentionPeriod/</id>
    <published>2024-05-13T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.127Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring チームの北村です。<br>今回は、Azure Monitor に関するデータの保持期間を紹介します。<br>今回ご紹介する内容は、それぞれの公開情報に掲載されておりますが、一つのページに集約されておりません。<br>よくお問い合わせいただく内容ですので、本記事では情報を集約化してお伝えします。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-Azure-Monitor-%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%A8%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%80%81%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0">1. Azure Monitor のログとメトリック、アクティビティ ログ</a><ul><li><a href="#1-1-%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF">1-1. メトリック</a></li><li><a href="#1-2-%E3%83%AD%E3%82%B0">1-2. ログ</a></li><li><a href="#1-3-%E3%82%A2%E3%82%AF%E3%83%86%E3%82%A3%E3%83%93%E3%83%86%E3%82%A3-%E3%83%AD%E3%82%B0">1-3. アクティビティ ログ</a></li></ul></li><li><a href="#2-Azure-Monitor-%E3%81%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E5%B1%A5%E6%AD%B4">2. Azure Monitor のアラートの履歴</a><ul><li><a href="#2-1-%E5%90%84%E7%A8%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AE%E5%B1%A5%E6%AD%B4">2-1. 各種アラートの履歴</a></li><li><a href="#2-2-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7">2-2. サービス正常性</a></li><li><a href="#2-3-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7">2-3. リソース正常性</a></li></ul></li></ul><br><h2 id="1-Azure-Monitor-のログとメトリック、アクティビティ-ログ"><a href="#1-Azure-Monitor-のログとメトリック、アクティビティ-ログ" class="headerlink" title="1. Azure Monitor のログとメトリック、アクティビティ ログ"></a>1. Azure Monitor のログとメトリック、アクティビティ ログ</h2><table><thead><tr><th>データの種類</th><th></th><th>保持期間</th></tr></thead><tbody><tr><td>メトリック</td><td>プラットフォーム メトリック</td><td>93 日間</td></tr><tr><td></td><td>クラシック ゲスト OS メトリック</td><td>14 日間</td></tr><tr><td></td><td>ゲスト OS メトリック</td><td>93 日間</td></tr><tr><td></td><td>Application Insights ログ ベースのメトリック</td><td>Application Insights リソースに紐づいたLog Analytics ワークスペースの保持設定に依存</td></tr><tr><td></td><td>Prometheus メトリック</td><td>18 ヶ月間</td></tr><tr><td>ログ</td><td></td><td>Log Analytics ワークスペースの保持設定に依存</td></tr><tr><td>アクティビティ ログ</td><td></td><td>90 日間</td></tr></tbody></table><br><h3 id="1-1-メトリック"><a href="#1-1-メトリック" class="headerlink" title="1-1. メトリック"></a>1-1. メトリック</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics">Azure Monitor のメトリック</a>とは、監視対象のリソースから一定の間隔で収集される数値データです。</p><br><h5 id="プラットフォーム-メトリック"><a href="#プラットフォーム-メトリック" class="headerlink" title="プラットフォーム メトリック"></a>プラットフォーム メトリック</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#platform-and-custom-metrics">プラットフォーム メトリック</a>は、Azure リソースを作成すると自動的に収集されます。<br>このメトリックの保持期間は <em><strong>93 日間</strong></em>であり、保持期間を延長することはできません。<br>プラットフォーム メトリックのデータを 93 日以上保持したい場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">Azure Monitor の診断設定</a>で対象リソースの<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/reference/supported-metrics/metrics-index">メトリック</a>を、 Log Analytics ワークスペースやストレージ アカウント等に送信することをご検討ください。<br>※ 以下は Azure VM のプラットフォーム メトリック (ホスト OS メトリック) を表示した例です。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image07.png"></p><br><h5 id="クラシック-ゲスト-OS-メトリック"><a href="#クラシック-ゲスト-OS-メトリック" class="headerlink" title="クラシック ゲスト OS メトリック"></a>クラシック ゲスト OS メトリック</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#retention-of-metrics">クラシック ゲスト OS メトリック</a> は、Azure VM に <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure Diagnostics 拡張機能</a>をインストールすることで収集されます。<br>このメトリックは、メトリック エクスプローラーで少なくとも <em><strong>14 日間</strong></em> 表示することが可能です。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image08.png"></p><br><h5 id="ゲスト-OS-メトリック"><a href="#ゲスト-OS-メトリック" class="headerlink" title="ゲスト OS メトリック"></a>ゲスト OS メトリック</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#retention-of-metrics">ゲスト OS メトリック</a> は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview">Azure Monitor エージェント</a> や <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">Azure Diagnostics 拡張機能</a> の <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-windows-install#overview">データ シンク</a> 機能で収集できます。<br>このメトリックの保持期間は <em><strong>93 日間</strong></em>であり、保持期間を延長することはできません。<br>※ 以下は Linux の Azure VM に Azure Monitor エージェントをインストールし、ゲスト OS メトリックを表示した例です。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image09.png"></p><br><h5 id="Application-Insights-ログ-ベースのメトリック"><a href="#Application-Insights-ログ-ベースのメトリック" class="headerlink" title="Application Insights ログ ベースのメトリック"></a>Application Insights ログ ベースのメトリック</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#retention-of-metrics">Application Insights ログ ベースのメトリック</a> は、Application Insights SDK や OpenTelemetry Distro、自動インストルメンテーション機能によって Application Insights リソースに送信された各種ログ データをもとに表示されるメトリックです。<br>Application Insights リソースに保存されたログ データをもとに表示するため、<strong>データ保持期間は Application Insights リソースに紐づいた Log Analytics ワークスペースの保持期間に依存</strong>します。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image12.png"></p><br><h5 id="Prometheus-メトリック"><a href="#Prometheus-メトリック" class="headerlink" title="Prometheus メトリック"></a>Prometheus メトリック</h5><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics#prometheus-metrics">Prometheus メトリック</a> は、AKS や Azure Arc enabled k8s から Azure Monitor ワークスペースに出力された<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/prometheus-metrics-overview">メトリック データ</a>です。<br>このメトリックの保持期間は <em><strong>18 か月間</strong></em>です。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image13.png"></p><br><h3 id="1-2-ログ"><a href="#1-2-ログ" class="headerlink" title="1-2. ログ"></a>1-2. ログ</h3><p>Azure Monitor のログとは、監視対象のリソースのシステム内で発生したイベントのデータです。<br>対象のリソースや種類により、様々なデータ型や値となり、Log Analytics ワークスペースに収集されます。<br>ログの保持期間は、<em><strong>Log Analytics ワークスペースの保持設定</strong></em>に依存します。この保持期間は、テーブル単位でも設定することができます。Log Analytics ワークスペースの保持期間や各テーブルの保持期間を確認する方法は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-archive?tabs=portal-3,portal-1,portal-2">こちら</a>の公開情報をご覧ください。<br>※ 以下は Log Analytics ワークスペースの保持期間を表示した例です。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image10.png"></p><br><h3 id="1-3-アクティビティ-ログ"><a href="#1-3-アクティビティ-ログ" class="headerlink" title="1-3. アクティビティ ログ"></a>1-3. アクティビティ ログ</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log-insights#retention-period">アクティビティ ログ</a>は、サブスクリプション レベルのイベントが記録されます。<br>例えば、リソースが作成された、変更された、削除された、VM が起動された、といった情報です。<br>アクティビティ ログの保持期間は <em><strong>90 日間</strong></em>であり、保持期間を延長することはできません。<br>アクティビティ ログのデータを 90 日以上保持したい場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal#activity-log-settings">Azure Monitor の診断設定</a>で <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell">Log Analytics ワークスペースやストレージ アカウント等に送信する</a>ことをご検討ください。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image11.png"></p><br><h2 id="2-Azure-Monitor-のアラートの履歴"><a href="#2-Azure-Monitor-のアラートの履歴" class="headerlink" title="2. Azure Monitor のアラートの履歴"></a>2. Azure Monitor のアラートの履歴</h2><table><thead><tr><th>アラートの種類</th><th>保持期間</th></tr></thead><tbody><tr><td>各種アラートの履歴</td><td>30 日</td></tr><tr><td>サービス正常性</td><td>90 日</td></tr><tr><td>リソース正常性</td><td>30 日</td></tr></tbody></table><br><h3 id="2-1-各種アラートの履歴"><a href="#2-1-各種アラートの履歴" class="headerlink" title="2-1. 各種アラートの履歴"></a>2-1. 各種アラートの履歴</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/alerts-manage-alert-instances#access-the-alerts-page">各種アラートの履歴</a>は Azure ポータルの [モニター] &gt; [アラート] のページで確認することができます。<br>アラートの履歴の保持期間は <em><strong>30 日間</strong></em> であり、保持期間を延長することはできません。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image01.png"></p><p>アラートの履歴を 30 日以上保持したい場合は、Azure ポータルから CSV 形式でデータをダウンロードいただくことや、<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/resource-graph-samples?tabs=azure-cli#view-recent-azure-monitor-alerts">アラート履歴を取得する Azure Resource Graph クエリ</a>を定期的に実行いただき、外部のシステム等にエクスポートするような仕組みをご構築いただくことをご検討いただけますと幸いです。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image02.png"></p><br><h3 id="2-2-サービス正常性"><a href="#2-2-サービス正常性" class="headerlink" title="2-2. サービス正常性"></a>2-2. サービス正常性</h3><p>サービス正常性は Azure ポータルの [モニター] &gt; [Service Health] のページで確認することができます。<br>サービス正常性の保持期間は <em><strong>90 日間</strong></em> であり、保持期間を延長することはできません。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image03.png"></p><p>サービス正常性のデータを 90 日以上保持したい場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log-schema#service-health-category">サービス正常性カテゴリのアクティビティ ログ</a>を、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal#activity-log-settings">Azure Monitor の診断設定</a>で <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell">Log Analytics ワークスペースやストレージ アカウント等に送信する</a>ことをご検討ください。サービス正常性は、Azure サービス自体の正常性を監視する機能です。Azure サービスの障害や計画メンテナンスの情報は、”サービス正常性カテゴリ” のアクティビティ ログとして記録されます。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image04.png"></p><br><h3 id="2-3-リソース正常性"><a href="#2-3-リソース正常性" class="headerlink" title="2-3. リソース正常性"></a>2-3. リソース正常性</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/service-health/resource-health-overview#history-information">リソース正常性</a>は、各リソースの [リソース正常性] のページで確認することができます。<br>リソース正常性の保持期間は <em><strong>30 日間</strong></em> であり、保持期間を延長することはできません。<br>※ <a href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/ResourceHealthAlert/#Q2-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E6%AD%A3%E5%B8%B8%E6%80%A7%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%81%AF%E3%80%81%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%A7%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">リソース正常性はすべてのリソースでサポートしている機能ではございません</a>ので、ご留意ください。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image05.png"></p><p>リソース正常性のデータを 30 日以上保持したい場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log-schema#resource-health-category">リソース正常性カテゴリのアクティビティ ログ</a>を、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal#activity-log-settings">Azure Monitor の診断設定</a>で <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/activity-log?tabs=powershell">Log Analytics ワークスペースやストレージ アカウント等に送信する</a>ことをご検討ください。リソース正常性はリソース単位で正常性を確認する機能であり、リソースの正常性に変化が生じた際に、その情報が “リソース正常性カテゴリ” のアクティビティ ログに記録されます。<br><img src="/blog/AzureMonitorEssential/MonitorRetentionPeriod/image06.png"></p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring チームの北村です。&lt;br&gt;今回は、Azure Monitor に関するデータの保持期間を紹介します。&lt;br&gt;今回ご紹介する内容は、それぞれの公開情報に掲載されておりますが、一つのページに集約されておりません。&lt;br&gt;よくお問い合わせいただく内容ですので、本記事では情報を集約化してお伝えします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Essential" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essential/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics エージェントから Azure Monitor エージェントへの移行に関するよくあるご質問集</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromLA/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaFromLA/</id>
    <published>2024-04-18T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.255Z</updated>
    
    <content type="html"><![CDATA[<p>[更新履歴]</p><ul><li>2024/04/30 FAQ 追加</li><li>2022/10/18 ブログ公開</li></ul><p>こんにちは、Azure Monitoring サポート チームの北村です。<br>Log Analytics エージェントが 2024 年 8 月に廃止することに伴い、Azure Monitor エージェントへの移行に関するお問い合わせをよくいただいております。そこで、本記事では Azure Monitor エージェントへの移行に関するよくあるご質問を Q &amp; A 形式でおまとめいたしました。これから Azure Monitor エージェントへ移行される方、Azure Monitor エージェントの導入をご検討されている方の一助となれば幸いです。</p><br><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><ul><li><a href="#Q1-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AF-2024-%E5%B9%B4-8-%E6%9C%88%E3%81%AB%E5%BB%83%E6%AD%A2%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8C%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%82%82%E5%BB%83%E6%AD%A2%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q1. Log Analytics エージェントは 2024 年 8 月に廃止されますが、Log Analytics ワークスペースも廃止されますか。</a></li><li><a href="#Q2-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%B8%E7%A7%BB%E8%A1%8C%E3%81%97%E3%81%9F%E5%BE%8C%E3%82%82%E3%80%81%E6%97%A2%E5%AD%98%E3%81%AE%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q2. Azure Monitor エージェントへ移行した後も、既存のアラート ルールを利用することはできますか。</a></li><li><a href="#Q3-%E5%90%8C%E4%B8%80%E3%81%AE%E3%83%9E%E3%82%B7%E3%83%B3%E4%B8%8A%E3%81%A7-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E7%A8%BC%E5%83%8D%E3%81%95%E3%81%9B%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q3. 同一のマシン上で Log Analytics エージェントと Azure Monitor エージェントを稼働させることは可能ですか。</a></li><li><a href="#Q4-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%81%AF%E3%80%81Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8%E5%90%8C%E7%AD%89%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q4. Azure Monitor エージェントでは、Log Analytics エージェントと同等の機能が提供されていますか。</a></li><li><a href="#Q5-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%9F%E4%BB%96%E8%A3%BD%E5%93%81%E3%81%AE%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q5. Log Analytics エージェントを利用した他製品のソリューションを利用しているかどうかを確認する方法を教えてください</a></li><li><a href="#Q6-Azure-Montior-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E4%B8%8A%E3%81%A7%E3%81%AE%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6%E3%81%A8%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B-OS-%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q6. Azure Montior エージェントを利用する上での前提条件とサポートしている OS を教えてください。</a></li><li><a href="#Q7-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E9%80%9A%E4%BF%A1%E8%A6%81%E4%BB%B6%E3%81%AF%E5%90%8C%E3%81%98%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q7. Azure Monitor エージェントと Log Analytics エージェントの通信要件は同じですか。</a></li><li><a href="#Q8-%E9%96%89%E3%81%98%E3%81%9F%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%8B%E3%82%89-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%B8%E3%83%AD%E3%82%B0%E3%82%92%E9%80%81%E4%BF%A1%E3%81%97%E3%81%9F%E3%81%84%E3%81%A7%E3%81%99%E3%80%82Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%81%93%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E4%BA%8B%E3%81%8C%E5%AE%9F%E7%8F%BE%E5%8F%AF%E8%83%BD%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q8. 閉じたネットワーク環境でコンピューターから Log Analytics ワークスペースへログを送信したいです。Azure Monitor エージェントでこのような事が実現可能ですか。</a></li><li><a href="#Q9-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E5%BB%83%E6%AD%A2%E6%97%A5%E3%81%BE%E3%81%A7%E3%81%AB-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AB%E7%A7%BB%E8%A1%8C%E3%81%97%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AF%E3%80%81%E3%81%A9%E3%81%86%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82%E3%81%BE%E3%81%9F%E3%80%81%E5%BB%83%E6%AD%A2%E6%97%A5%E4%BB%A5%E9%99%8D%E3%82%82-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92%E5%8F%97%E3%81%91%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q9. Log Analytics エージェントの廃止日までに Azure Monitor エージェントに移行しなかった場合は、どうなりますか。また、廃止日以降も Log Analytics エージェントのサポートを受けることはできますか。</a></li><li><a href="#Q10-Azure-VM-%E3%81%AB-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q10. Azure VM に Log Analytics エージェントがインストールされているかどうかを確認する方法を教えてください。</a></li><li><a href="#Q11-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AB-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C%E6%89%8B%E9%A0%86%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q11. 仮想マシンに Log Analytics エージェントがインストールされています。Azure Monitor エージェントへの移行手順を教えてください。</a></li><li><a href="#Q12-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A8-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E5%90%8C%E6%99%82%E3%81%AB%E7%A8%BC%E5%83%8D%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%A7%E3%83%AD%E3%82%B0%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q12. Log Analytics エージェントと Azure Monitor エージェントを同時に稼働しています。Azure Monitor エージェントでログが収集されていることを確認する方法を教えてください。</a></li><li><a href="#Q13-%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%80%81Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%80%81%E3%83%AD%E3%82%B0%E3%81%8C%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E3%81%97%E3%81%8B%E3%81%97%E3%80%81Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AE%E5%B7%A6%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E9%9D%9E%E6%8E%A8%E5%A5%A8-%E3%82%92%E8%A6%8B%E3%82%8B%E3%81%A8%E3%80%81%E2%80%9D%E6%8E%A5%E7%B6%9A%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E2%80%9D-%E3%81%A8%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82">Q13. データ収集ルールを作成し、Azure Monitor エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log Analytics ワークスペースの左メニュー [仮想マシン (非推奨)] を見ると、”接続されていません” と表示されます。</a></li><li><a href="#Q14-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%80%81-Azure-Monitor-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%80%81%E3%81%8A%E3%82%88%E3%81%B3%E6%97%A2%E5%AD%98%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%8F%8E%E9%9B%86%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AE%E9%96%A2%E9%80%A3%E4%BB%98%E3%81%91%E3%82%92%E8%87%AA%E5%8B%95%E3%81%A7%E5%AE%9F%E6%96%BD%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q14. 仮想マシンを作成したとき、 Azure Monitor エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。</a></li><li><a href="#Q15-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E5%BB%83%E6%AD%A2%E3%81%AB%E4%BC%B4%E3%81%84%E3%80%81VM-%E3%81%AE%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%82%82%E7%A7%BB%E8%A1%8C%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q15. Log Analytics エージェントの廃止に伴い、VM の診断設定も移行が必要ですか。</a></li></ul><br><h3 id="Q1-Log-Analytics-エージェントは-2024-年-8-月に廃止されますが、Log-Analytics-ワークスペースも廃止されますか。"><a href="#Q1-Log-Analytics-エージェントは-2024-年-8-月に廃止されますが、Log-Analytics-ワークスペースも廃止されますか。" class="headerlink" title="Q1. Log Analytics エージェントは 2024 年 8 月に廃止されますが、Log Analytics ワークスペースも廃止されますか。"></a>Q1. Log Analytics エージェントは 2024 年 8 月に廃止されますが、Log Analytics ワークスペースも廃止されますか。</h3><p>いいえ、Log Analytics エージェントは廃止されますが、Log Analytics ワークスペースは廃止されません。</p><br><h3 id="Q2-Azure-Monitor-エージェントへ移行した後も、既存のアラート-ルールを利用することはできますか。"><a href="#Q2-Azure-Monitor-エージェントへ移行した後も、既存のアラート-ルールを利用することはできますか。" class="headerlink" title="Q2. Azure Monitor エージェントへ移行した後も、既存のアラート ルールを利用することはできますか。"></a>Q2. Azure Monitor エージェントへ移行した後も、既存のアラート ルールを利用することはできますか。</h3><p>基本的に Azure Monitor エージェントへの移行後も既存のアラート ルールをご利用いただけますが、アラート ルールの設定と監視するログの種類によっては、動作しないものも存在する可能性もございます。念のため、移行する際にアラート ルールの動作もご確認いただけますと幸いです。特に、以下の場合は注意が必要です。</p><h5 id="1-Log-Analytics-エージェントと-Azure-Monitor-エージェントで異なる-Log-Analytics-ワークスペースを利用する場合"><a href="#1-Log-Analytics-エージェントと-Azure-Monitor-エージェントで異なる-Log-Analytics-ワークスペースを利用する場合" class="headerlink" title="1). Log Analytics エージェントと Azure Monitor エージェントで異なる Log Analytics ワークスペースを利用する場合"></a>1). Log Analytics エージェントと Azure Monitor エージェントで異なる Log Analytics ワークスペースを利用する場合</h5><p>移行前後でログの収集先が変わりますため、アラート ルールのスコープが Log Analytics ワークスペースとなっている場合は、再設定が必要となります。</p><h5 id="2-Heartbeat-の監視で-Category-列の値を利用している場合"><a href="#2-Heartbeat-の監視で-Category-列の値を利用している場合" class="headerlink" title="2). Heartbeat の監視で Category 列の値を利用している場合"></a>2). Heartbeat の監視で Category 列の値を利用している場合</h5><p>Azure Monitor エージェントに移行しますと、マシンの死活監視に用いられる Heartbeat ログの Category 列の値が変更されます。Log Analytics エージェントにより収集された Heartbeat ログは Category 列が “Direct Agent” ですが、Azure Monitor エージェントにより収集された Heartbeat ログは Category 列が “Azure Monitor Agent” となります。よって、Heartbeat テーブルを対象としたログ アラート ルールを構成しており、またそのクエリにて Category 列を何らかの形で利用している場合は、変更点に応じたクエリの検討が必要です。</p><h5 id="3-Event-テーブルの監視で-EventLevel-と-EventLevelName-列の値を利用している場合"><a href="#3-Event-テーブルの監視で-EventLevel-と-EventLevelName-列の値を利用している場合" class="headerlink" title="3). Event テーブルの監視で EventLevel と EventLevelName 列の値を利用している場合"></a>3). Event テーブルの監視で EventLevel と EventLevelName 列の値を利用している場合</h5><p>Log Analytics エージェントと Azure Monitor エージェントで収集される Event (Windows イベント ログ) のデータで、 EventLevel と EventLevelName のマッピングに一部変更がございます。Event を監視するアラート ルールでこれらの値を使用している場合は、動作の確認が必要です。</p><table class="tg"><thead>  <tr>    <th class="tg-0lax" colspan="2">Windows イベント&nbsp;&nbsp;ビューアー</th>    <th class="tg-0pky" colspan="2">Log Analytics エージェント</th>    <th class="tg-0pky" colspan="2">Azure Monitor エージェント</th>  </tr></thead><tbody>  <tr>    <td class="tg-0lax">EventLevel</td>    <td class="tg-0lax">EventLevelName</td>    <td class="tg-0pky">EventLevel</td>    <td class="tg-0pky">EventLevelName</td>    <td class="tg-0pky">EventLevel</td>    <td class="tg-0pky">EventLevelName</td>  </tr>  <tr>    <td class="tg-0lax">1</td>    <td class="tg-0lax">Critical</td>    <td class="tg-0pky">1</td>    <td class="tg-0pky">Error</td>    <td class="tg-0pky">1</td>    <td class="tg-0pky">Critical</td>  </tr>  <tr>    <td class="tg-0lax">2</td>    <td class="tg-0lax">Error</td>    <td class="tg-0pky">1</td>    <td class="tg-0pky">Error</td>    <td class="tg-0pky">2</td>    <td class="tg-0pky">Error</td>  </tr>  <tr>    <td class="tg-0lax">3</td>    <td class="tg-0lax">Warning</td>    <td class="tg-0lax">2</td>    <td class="tg-0lax">Warning</td>    <td class="tg-0lax">3</td>    <td class="tg-0lax">Warning</td>  </tr>  <tr>    <td class="tg-0lax">4</td>    <td class="tg-0lax">Information</td>    <td class="tg-0lax">4</td>    <td class="tg-0lax">Information</td>    <td class="tg-0lax">4</td>    <td class="tg-0lax">Information</td>  </tr>  <tr>    <td class="tg-0lax">5</td>    <td class="tg-0lax">Verbose</td>    <td class="tg-0lax">-</td>    <td class="tg-0lax">-</td>    <td class="tg-0lax">5</td>    <td class="tg-0lax">Verbose</td>  </tr></tbody></table><p>※    Log Analytics エージェントは Verbose レベルのイベント ログは収集しない<br>※    Log Analytics エージェントは Critical レベルのイベント ログを Error として収集する</p><h5 id="4-Microsoft-Defender-for-Cloud-や-Microsoft-Sentinel-を利用してセキュリティ-イベント-ログを収集している場合"><a href="#4-Microsoft-Defender-for-Cloud-や-Microsoft-Sentinel-を利用してセキュリティ-イベント-ログを収集している場合" class="headerlink" title="4). Microsoft Defender for Cloud や Microsoft Sentinel を利用してセキュリティ イベント ログを収集している場合"></a>4). Microsoft Defender for Cloud や Microsoft Sentinel を利用してセキュリティ イベント ログを収集している場合</h5><p>Log Analytics エージェントと Microsoft Defender for Cloud や Microsoft Sentinel を利用してセキュリティ イベント ログを収集されている場合、収集されたログは SecurityEvent テーブルに格納されます。Azure Monitor エージェントを使用してセキュリティ イベント ログを収集した場合、収集されたログは Event テーブルに格納されます。よって、SecurityEvent テーブルを対象としたログ アラート ルールを構成している場合は、ログ アラート ルール内のクエリで利用しているテーブル名を Event テーブルへ変更する必要がございます。各エージェントによるセキュリティ イベント ログの収集先テーブルの違いについては、こちらの<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToCollectWindowsSecurityEvents/">ブログ</a>でもご案内しておりますので、併せてご確認いただけますと幸いです。</p><h5 id="5-Syslog-テーブルの監視で-SeverityLevel-列の値を利用している場合"><a href="#5-Syslog-テーブルの監視で-SeverityLevel-列の値を利用している場合" class="headerlink" title="5). Syslog テーブルの監視で SeverityLevel 列の値を利用している場合"></a>5). Syslog テーブルの監視で SeverityLevel 列の値を利用している場合</h5><p>Log Analytics エージェントと Azure Monitor エージェントで収集される Syslog (Linux の Syslog) のデータで、 SeverityLevel の値に一部変更がございます。Syslog を監視するアラート ルールでこれらの値を使用している場合は、動作の確認が必要です。</p><table class="tg"><thead>  <tr>    <th class="tg-0pky">エージェント</th>    <th class="tg-lboi" colspan="4">SeverityLevel</th>  </tr></thead><tbody>  <tr>    <td class="tg-0pky"><span style="font-weight:bold">Log Analytics エージェント</span></td>    <td class="tg-0pky">warn</td>    <td class="tg-0lax">err</td>    <td class="tg-0lax">crit</td>    <td class="tg-0lax">emerg</td>  </tr>  <tr>    <td class="tg-0pky"><span style="font-weight:bold">Azure Monitor エージェント</span></td>    <td class="tg-0pky">warning</td>    <td class="tg-0lax">error</td>    <td class="tg-0lax">critical</td>    <td class="tg-0lax">emergency</td>  </tr></tbody></table><h5 id="6-カスタム-ログの監視で-Computer-列の値を利用している場合"><a href="#6-カスタム-ログの監視で-Computer-列の値を利用している場合" class="headerlink" title="6). カスタム ログの監視で Computer 列の値を利用している場合"></a>6). カスタム ログの監視で Computer 列の値を利用している場合</h5><p>Log Analytics エージェントのカスタム ログでは、 Computer 列に対象 VM のホスト名が収集されていますが、<br>移行後の Azure Monitor エージェントのカスタム ログでは、 Computer 列の値は収集されなくなります。カスタム ログを監視するアラート ルールで Computer 列の値を利用している場合は、動作の確認が必要です。</p><br><h3 id="Q3-同一のマシン上で-Log-Analytics-エージェントと-Azure-Monitor-エージェントを稼働させることは可能ですか。"><a href="#Q3-同一のマシン上で-Log-Analytics-エージェントと-Azure-Monitor-エージェントを稼働させることは可能ですか。" class="headerlink" title="Q3. 同一のマシン上で Log Analytics エージェントと Azure Monitor エージェントを稼働させることは可能ですか。"></a>Q3. 同一のマシン上で Log Analytics エージェントと Azure Monitor エージェントを稼働させることは可能ですか。</h3><p>はい、可能です。<br>ただし、データが重複して収集される可能性もございますので、その点ご留意ください。<br>詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration#migration-plan-considerations">Log Analytics エージェントから Azure Monitor エージェントへの移行</a> の [移行ガイダンス] をご覧ください。</p><br><h3 id="Q4-Azure-Monitor-エージェントでは、Log-Analytics-エージェントと同等の機能が提供されていますか。"><a href="#Q4-Azure-Monitor-エージェントでは、Log-Analytics-エージェントと同等の機能が提供されていますか。" class="headerlink" title="Q4. Azure Monitor エージェントでは、Log Analytics エージェントと同等の機能が提供されていますか。"></a>Q4. Azure Monitor エージェントでは、Log Analytics エージェントと同等の機能が提供されていますか。</h3><p>いいえ、現時点では Log Analytics エージェントの全ての機能を Azure Monitor エージェントで提供しておりません。<br>最終的には、Azure Monitor エージェントは Log Analytics エージェント、Azure Diagnostics 拡張機能、および Telegraf エージェントの機能を提供する予定でございます。Azure Monitor エージェントと Log Analytics エージェントにおける機能の違いにつきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#compare-to-legacy-agents">Azure Monitor エージェントの概要</a> の [レガシ エージェントとの比較] をご覧ください。</p><p>また、Log Analytics エージェントを利用した他製品のソリューションをご利用いただいている場合も、該当するソリューション観点で移行いただく必要がございます。移行方法の詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration#migrate-additional-services-and-features">弊社公開情報</a>をご確認いただけますと幸いです。なお、いくつかのサービスにつきましては、以下にご留意いただきたい点をお纏めしておりますので、こちらも併せてご確認いただけますと幸いです。</p><ul><li><em><strong>VM insights</strong></em><br>Log Analytics エージェントの廃止に伴い、Log Analytics エージェント ベースの <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-overview">VM insights</a> は 2024 年 8 月末にてサポート終了を予定しております。そのため、Log Analytics エージェント ベースの VM insights をご利用されている場合は、Azure Monitor エージェント ベースの VM insights への移行が必要です。詳細につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-portal">弊社公開情報</a> や<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/HowToMigrateToAmaBasedVMInsights/">弊社サポート ブログ</a> をご覧ください。</li></ul><ul><li><em><strong>Microsoft Sentinel</strong></em><br>Microsoft Sentinel をご利用され、Log Analytics エージェントを利用したコネクタをご利用されている場合は、Azure Monitor エージェントを利用したコネクタ等に移行が必要でございます。<a href="https://learn.microsoft.com/ja-jp/azure/sentinel/ama-migrate">こちら</a>の公開情報をご参照いただき、移行手順をご確認ください。</li></ul><ul><li><em><strong>Change Tracking とイベントリ</strong></em><br>Azure Automation の <a href="https://learn.microsoft.com/ja-jp/azure/automation/change-tracking/overview?tabs=python-2">Change Tracking とイベントリ機能</a> V1 でも Log Analytics エージェントを利用しております。Log Analytics エージェントを利用した Change Tracking V1 をご利用されている場合は Azure Monitor エージェントを利用した Change Tracking V2 に移行をお願いいたします。移行手順は<a href="https://learn.microsoft.com/JA-JP/azure/automation/change-tracking/guidance-migration-log-analytics-monitoring-agent?tabs=ct-single-vm,limit-single-vm">弊社公開情報</a>をご参照ください。</li></ul><ul><li><em><strong>Network Watcher</strong></em><br>Network Watcher の接続モニターを利用している環境において、オンプレミスのサーバーを監視のソースとしている場合は、Log Analytics エージェントを利用している可能性があります。Network Watcher の接続モニターで Log Analytics エージェントを利用しているかについては、<a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/connection-monitor-create-using-portal#create-test-groups-in-a-connection-monitor">接続モニターのテスト グループ</a>から、ソース/ターゲットにおいて、Azure 以外のエンドポイントでかつ、型が [ARC endpoints] を指定していれば、Log Analytics エージェントを利用していると判断できます。<br>もし NetworkWatcher でオンプレミス マシンを Log Analytics エージェントで監視している場合、まずは <a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/connection-monitor-connected-machine-agent?tabs=WindowsScript">Azure Connected Machine エージェント</a>を使用して Azure のリソースとしてください (これは Network Watcher に限らず、非 Azure マシンに Azure Monitor エージェントを使用する場合は必要な作業となります)。Azure Connected Machine エージェントを使用して Azure のリソースとして頂いた後、<a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/azure-monitor-agent-with-connection-monitor#install-monitoring-agents-for-azure-and-non-azure-resources">Azure Monitor エージェントと Network Watcher 拡張機能のインストールをしていただく必要があります</a>。Azure Connected Machine エージェントをインストールすることで、Azure Arc サーバーとして Azure 上で認識され、通常の Azure VM に拡張機能をインストールするのと同じ要領で Azure Monitor エージェントおよび Network Watcher エージェントのインストールすることが可能となります。Azure Arc 対応サーバーでの Azure Monitor エージェントのインストール手順等につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/network-watcher/connection-monitor-install-azure-monitor-agent?tabs=PowerShellWindowsArc,CLIWindowsArc">弊社公開情報</a> をご参照ください。</li></ul><ul><li><em><strong>Microsoft Defender for Cloud</strong></em><br>以前は Azure Monitor エージェントを使用する移行手順も存在しておりましたが、<a href="https://learn.microsoft.com/ja-jp/azure/defender-for-cloud/defender-for-cloud-introduction">Microsoft Defender for Cloud (以下、MDC)</a> では エージェントを廃止する方向で進んでおりまして、MDC からは既に Azure Monitor エージェントのプロビジョニングをする設定ができないように変更されております。そのため、 MDC から自動プロビジョニングされている、 Log Analytics エージェントを、 Azure Monitor エージェントに置き換えることはできません。<a href="https://learn.microsoft.com/ja-jp/azure/defender-for-cloud/prepare-deprecation-log-analytics-mma-agent#feature-functionality">こちら</a>の公開情報に、現時点の代替方法についてまとめられておりますので、ご参照ください。現在、一部の機能は提供されておりますが、  Log Analytics エージェントの代替となる方法が提供されていないものもあることをご容赦いただけますと幸いです。</li></ul><ul><li><em><strong>Update Management</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/automation/update-management/overview">Update Management</a> では Log Analytics エージェントを利用しているため、継続して仮想マシン等の更新プログムの管理を行いたい場合は Log Analytics エージェントに依存しない <a href="https://learn.microsoft.com/ja-jp/azure/update-manager/overview?tabs=azure-vms">Azure Update Manager</a> への移行が必要です。Azure Update Management の対象になっている仮想マシンは、Log Analytics ワークスペースに対して以下のクエリを実行することで確認可能です (検索範囲の時間はマシンの起動状況を加味して適宜ご設定ください)。Azure Update Management から Azure Update Manager への移行手順の詳細につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/update-manager/guidance-migration-automation-update-management-azure-update-manager">弊社公開情報</a> をご参照ください。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| where Solutions contains &quot;updates&quot;</span><br><span class="line">| summarize arg_max(TimeGenerated, *) by _ResourceId</span><br></pre></td></tr></table></figure></li></ul><ul><li><em><strong>Hybrid Runbook Worker</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/automation/automation-hybrid-runbook-worker">Hybrid Runbook Worker</a> には、エージェント ベースと拡張機能ベースの 2 種類のプラットフォームがございます。<br><a href="https://learn.microsoft.com/ja-jp/azure/automation/extension-based-hybrid-runbook-worker-install?tabs=linux,bicep-template#migrate-an-existing-agent-based-to-extension-based-hybrid-workers">エージェントベースの Hybrid Runbook Worker</a> では Log Analytics エージェントを利用しておりますので、拡張機能ベースの Hybrid Runbook Worker に移行いただく必要がございます。エージェント ベースの Hybrid Runbook Worker をご利用いただいている場合は、<a href="https://learn.microsoft.com/ja-jp/azure/automation/migrate-existing-agent-based-hybrid-worker-to-extension-based-workers?tabs=bicep-template,win-hrw">こちら</a>の公開情報の手順に従って拡張機能ベースの Hybrid Runbook Worker に移行をいただけましたら幸いです。</li></ul><ul><li><em><strong>HD Insight</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/hdinsight/hdinsight-hadoop-oms-log-analytics-tutorial?tabs=new">Azure Monitor ログを有効にしている場合</a>は、移行が必要でございます。<br>HDInsight リソースにおいて、下記画像の赤枠部分の設定 「HDInsight クラスター (クラシック) の Azure Monitor への統合を構成します。」 より、ログ収集の設定を実施いただいている場合は、Log Analytics Agent 廃止後にログ収集が停止されます。下記画像の緑枠の設定が新しい設定となり、<a href="https://learn.microsoft.com/ja-jp/azure/hdinsight/hdinsight-hadoop-oms-log-analytics-tutorial?tabs=new">公開情報</a>では [新しい Azure Monitor エクスペリエンス] と記載がある項目に該当します。こちらへ切り替えを実施いただければ、Log Analytics エージェントの廃止後も引き続き監視が可能となります。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaFromLA/image04.png"></li></ul><br><h3 id="Q5-Log-Analytics-エージェントを利用した他製品のソリューションを利用しているかどうかを確認する方法を教えてください。"><a href="#Q5-Log-Analytics-エージェントを利用した他製品のソリューションを利用しているかどうかを確認する方法を教えてください。" class="headerlink" title="Q5. Log Analytics エージェントを利用した他製品のソリューションを利用しているかどうかを確認する方法を教えてください。"></a>Q5. Log Analytics エージェントを利用した他製品のソリューションを利用しているかどうかを確認する方法を教えてください。</h3><p>Log Analytics エージェントから Azure Monitor エージェントへ移行いただく際に、移行すべきサービスを検出および移行方法の提案や進行状況の追跡を行う <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration-tools#using-ama-migration-helper">AMA Migration Helper</a> というツールがございます。AMA Migration Helper は、[モニター] &gt; [ブック] &gt; [パブリック テンプレート] &gt; [Azure Monitor の要点] &gt; [AMA Migration Helper] よりご利用いただけます。各ソリューションの移行に関する詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration#migrate-additional-services-and-features">こちら</a>の公開情報にまとまっておりますので、ご確認いただけますと幸いです。<br>AMA Migration Helper を利用して他製品のソリューションのご利用状況を確認する手順は以下のとおりです。</p><ol><li><p>すべてのサービスより、[モニター] を選択し、画面左側の [ブック] より、[パブリック テンプレート] タブを選択します。一覧より [AMA Migration Helper] を選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaFromLA/image02.png"></p></li><li><p>[ワークスペース] タブを選択し、ご確認されたい Log Analytics ワークスペースをプルダウンより選択します。</p></li><li><p>[ソリューション] タブを選択しますと、当該 Log Analytics ワークスペースでご利用のソリューションのうち、Log Analytics エージェントから Azure Monitor エージェントへの移行が必要なソリューションが表示されます。Solution 列には、移行が必要な機能、レコメンデーション列には移行方法に関する公開情報のリンクが記載されております。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaFromLA/image03.png"></p></li></ol><br><h3 id="Q6-Azure-Montior-エージェントを利用する上での前提条件とサポートしている-OS-を教えてください。"><a href="#Q6-Azure-Montior-エージェントを利用する上での前提条件とサポートしている-OS-を教えてください。" class="headerlink" title="Q6. Azure Montior エージェントを利用する上での前提条件とサポートしている OS を教えてください。"></a>Q6. Azure Montior エージェントを利用する上での前提条件とサポートしている OS を教えてください。</h3><p>Azure Montior エージェントをご利用する上での前提条件は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-manage?tabs=ARMAgentPowerShell,PowerShellWindows,PowerShellWindowsArc,CLIWindows,CLIWindowsArc#prerequisites">Azure Monitor エージェントを管理する</a> の [前提条件] をご覧ください。<br>また、当該エージェントがサポートしている OS は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#supported-operating-systems">Azure Monitor エージェントの概要</a> の [サポートされるオペレーティング システム] の表に記載されている OS かつ、対象列に “✓” と記載されているものでございます。</p><br><h3 id="Q7-Azure-Monitor-エージェントと-Log-Analytics-エージェントの通信要件は同じですか。"><a href="#Q7-Azure-Monitor-エージェントと-Log-Analytics-エージェントの通信要件は同じですか。" class="headerlink" title="Q7. Azure Monitor エージェントと Log Analytics エージェントの通信要件は同じですか。"></a>Q7. Azure Monitor エージェントと Log Analytics エージェントの通信要件は同じですか。</h3><p>いいえ、Log Analytics エージェントの通信要件と Azure Monitor エージェントの通信要件は異なります。<br>Azure Monitor エージェントからワークスペースへデータを送信するには、下記 URL に対して TCP 443 ポートへのアクセスが確保されている必要がございます。</p><ul><li>global.handler.control.monitor.azure.com </li><li>&lt;virtual-machine-region-name&gt;.handler.control.monitor.azure.com (例: japaneast.handler.control.azure.com)</li><li>&lt;log-analytics-workspace-id&gt;.ods.opinsights.azure.com (例: 12345a01-b1cd-1234-e1f2-1234567g8h99.ods.opsinsights.azure.com)</li></ul><p>また、NSG を利用する場合には、AzureMonitor と AzureResourceManager のサービス タグに対して、送信方向にアクセスを許可していただく必要がございます。詳細は <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows">Azure Monitor エージェントのネットワーク設定を定義する</a> をご覧ください。</p><p>一方で、カスタム ログを収集する場合や <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> を用いて閉域網にてログを収集する場合、データ収集エンドポイント (DCE) を別途ご構築いただく必要がございます。<br>その場合、DCE をご利用いただくための通信要件を別途考慮いただく必要がございます。<br>DCE をご利用いただく場合は、下記 URL に対して TCP 443 ポートへのアクセスが確保されている必要がある点について、予めご留意ください。</p><ul><li>&lt;unique-dce-identifier&gt;.&lt;regionname&gt;.handler.control.monitor.azure.com</li><li>&lt;unique-dce-identifier&gt;.&lt;regionname&gt;.ingest.monitor.azure.com</li></ul><p>DCE に関する通信要件につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-collection-endpoint-overview?tabs=portal#components-of-a-data-collection-endpoint">データ収集エンドポイントのコンポーネント</a> をご確認ください。</p><br><h3 id="Q8-閉じたネットワーク環境でコンピューターから-Log-Analytics-ワークスペースへログを送信したいです。Azure-Monitor-エージェントでこのような事が実現可能ですか。"><a href="#Q8-閉じたネットワーク環境でコンピューターから-Log-Analytics-ワークスペースへログを送信したいです。Azure-Monitor-エージェントでこのような事が実現可能ですか。" class="headerlink" title="Q8. 閉じたネットワーク環境でコンピューターから Log Analytics ワークスペースへログを送信したいです。Azure Monitor エージェントでこのような事が実現可能ですか。"></a>Q8. 閉じたネットワーク環境でコンピューターから Log Analytics ワークスペースへログを送信したいです。Azure Monitor エージェントでこのような事が実現可能ですか。</h3><p>はい、Log Analytics エージェントと同様に、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-security">Azure Monitor Private Link Scope (AMPLS)</a> をご利用いただくことで実現可能です。AMPLS 環境下で Azure Monitor エージェントを用いてログを Log Analytics ワークスペースへ送信するためには、別途データ収集エンドポイント (DCE) のご構築が必要となります。AMPLS を用いたログの収集方法につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-data-collection-endpoint?tabs=PowerShellWindows#enable-network-isolation-for-the-azure-monitor-agent">Azure Monitor エージェントのネットワークの分離を有効にする</a> の公開情報をご参考ください。</p><br><h3 id="Q9-Log-Analytics-エージェントの廃止日までに-Azure-Monitor-エージェントに移行しなかった場合は、どうなりますか。また、廃止日以降も-Log-Analytics-エージェントのサポートを受けることはできますか。"><a href="#Q9-Log-Analytics-エージェントの廃止日までに-Azure-Monitor-エージェントに移行しなかった場合は、どうなりますか。また、廃止日以降も-Log-Analytics-エージェントのサポートを受けることはできますか。" class="headerlink" title="Q9. Log Analytics エージェントの廃止日までに Azure Monitor エージェントに移行しなかった場合は、どうなりますか。また、廃止日以降も Log Analytics エージェントのサポートを受けることはできますか。"></a>Q9. Log Analytics エージェントの廃止日までに Azure Monitor エージェントに移行しなかった場合は、どうなりますか。また、廃止日以降も Log Analytics エージェントのサポートを受けることはできますか。</h3><p>現時点では、2024 年 8 月 31 日以降すぐに Log Analytics エージェントのログ収集機能が停止する予定はございません。<br>Log Analytics エージェントの廃止日以降は、下記のような場合サポートを提供することが出来ない可能性がございます。<br>※ お客様自身でご判断いただけない場合があるため、その際は Azure サポートまでお問合せください。</p><ul><li>Log Analytics エージェントの設定方法が分からない。</li><li>Log Analytics エージェントを使ってログを収集しているが、ログ取り込みに遅延が発生する、ログが欠損する。</li><li>その他、Log Analytics エージェント自体の不具合や、Log Analytics エージェントを利用した機能の不具合など。</li></ul><p>その他 Log Analytics エージェントの廃止に伴う影響につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration">弊社公開情報</a>もご覧いただけますと幸いです。</p><br><h3 id="Q10-Azure-VM-に-Log-Analytics-エージェントがインストールされているかどうかを確認する方法を教えてください。"><a href="#Q10-Azure-VM-に-Log-Analytics-エージェントがインストールされているかどうかを確認する方法を教えてください。" class="headerlink" title="Q10. Azure VM に Log Analytics エージェントがインストールされているかどうかを確認する方法を教えてください。"></a>Q10. Azure VM に Log Analytics エージェントがインストールされているかどうかを確認する方法を教えてください。</h3><p>Azure ポータルで [Resource Graph エクスプローラー] (Azure Resource Graph エクスプローラー) を開き、下記のようなクエリを実行することで、Log Analytics エージェントが導入されたマシンとその接続先の Log Analytics ワークスペースを確認できます。<br>以下がサンプル クエリでございます。クエリ内、&lt;&gt; 部分についてはお客様環境に合わせてご変更いただく必要がございます。以下のクエリを実行いただき、該当するマシンがあるかどうかをご確認ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resources</span><br><span class="line">| where subscriptionId == &quot;&lt;サブスクリプション ID&gt;&quot;</span><br><span class="line">| where properties.type in (&#x27;OmsAgentForLinux&#x27;,&#x27;MicrosoftMonitoringAgent&#x27;)</span><br><span class="line">| extend workspaceId = tostring(properties.settings.workspaceId)</span><br><span class="line">| parse id with * &quot;/virtualMachines/&quot; vmName &quot;/extensions&quot; *</span><br><span class="line">| project vmResourceId=id, vmResourceGroup=resourceGroup, vmName, workspaceId</span><br><span class="line">| join kind = leftouter (</span><br><span class="line">resources</span><br><span class="line">| where subscriptionId == &quot;&lt;サブスクリプション ID&gt;&quot;</span><br><span class="line">| where id contains &quot;operationalinsights/workspaces&quot;</span><br><span class="line">| extend workspaceId = tostring(properties.customerId)</span><br><span class="line">| project workspaceResourceId=id, workspaceName=name, workspaceResourceGroup=resourceGroup, workspaceId</span><br><span class="line">) on workspaceId</span><br></pre></td></tr></table></figure><p>properties.type が MicrosoftMonitoringAgent の場合は、Windows 用の Log Analytics エージェントの拡張機能を表します。<br>properties.type が OmsAgentForLinux の場合は、Linux 用の Log Analytics エージェントの拡張機能を表します。<br>上記のクエリでヒットするマシンがありましたら、そのマシンには拡張機能ベースの Log Analytics エージェントが導入されていることになります。Azure Resource Graph エクスプローラーのご利用手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/governance/resource-graph/first-query-portal">弊社公開情報</a>をご参照いただけますと幸いです。</p><br><h3 id="Q11-仮想マシンに-Log-Analytics-エージェントがインストールされています。Azure-Monitor-エージェントへの移行手順を教えてください。"><a href="#Q11-仮想マシンに-Log-Analytics-エージェントがインストールされています。Azure-Monitor-エージェントへの移行手順を教えてください。" class="headerlink" title="Q11. 仮想マシンに Log Analytics エージェントがインストールされています。Azure Monitor エージェントへの移行手順を教えてください。"></a>Q11. 仮想マシンに Log Analytics エージェントがインストールされています。Azure Monitor エージェントへの移行手順を教えてください。</h3><p>移行の一例を示します。</p><p><em><strong>1. Log Analytics エージェントが導入されている仮想マシンを確認する (Q10. 参照)</strong></em><br><em><strong>2. データ収集ルールを作成し、仮想マシンを紐づけることで Azure Monitor エージェントをインストールする</strong></em><br><em><strong>3. Log Analytics エージェントのアンインストール</strong></em></p><p>この例では、Azure Monitor エージェントを導入してから Log Analytics エージェントをアンインストールしています。<br>この場合は、エージェントが共存する時間帯が発生いたしますので、ログが重複して収集される可能性がございます。エージェントが共存すること自体は基本的に問題ありませんが、Log Analytics エージェントと Azure Monitor エージェントのログ収集設定に同一内容が含まれている場合 (例えば、どちらも CPU 情報を取得するよう設定している)、重複してログが収集され、コスト面に影響を与える可能性、設定されているアラートの誤発報につながる可能性がございますのでご注意ください。Azure Monitor エージェントを導入されましたら、必要に応じてログが適切に収集されているかどうかをご確認ください。移行手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration#migration-testing">弊社公開情報</a> にも掲載しておりますので、あわせてご覧ください。<br>※ Log Analytics エージェントをアンインストールしてから Azure Monitor エージェントを導入していただいても構いません。</p><br><p>各項目について補足いたします。</p><p><em><strong>1. Log Analytics エージェントが導入されている仮想マシンを確認する</strong></em><br><a href="#Q10-Azure-VM-%E3%81%AB-Log-Analytics-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q10</a>. の Azure Resource Graph のクエリを利用した確認方法をご覧ください。</p><p><em><strong>2. データ収集ルールを作成し、仮想マシンを紐づけることで Azure Monitor エージェントをインストールする</strong></em><br>DCR Config Generator をご利用いただくことで、Log Analytics ワークスペースから Log Analytics エージェント構成を解析し、対応するデータ収集ルール (DCR) を自動的に生成/デプロイすることが可能でございます。DCR Config Generator の概要や利用手順につきましては、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/azure-monitor-agent-migration-tools#installing-and-using-dcr-config-generator">弊社公開情報</a> や<a href="https://jpazmon-integ.github.io/blog/LogAnalytics/DCRConfigGenerator/">弊社サポートブログ</a> に掲載しておりますので、ご確認いただきますようお願いいたします。</p><p>また、DCR Config Generator を使用せず手動でデータ収集ルールを作成いただくことも可能でございます。<br>以下の公開情報にデータ収集ルールの作成手順を掲載しておりますので、データ収集ルールの作成および VM の紐づけ方法をご確認ください。お客様ご自身にて収集をされたいログ データの種類に合う公開情報をご参照いただけますと幸いです。<br>なお、Azure Monitor エージェントがインストールされるためには、マシンが実行中である必要がございますのでご注意ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal">イベント ログやパフォーマンス カウンターを収集する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-iis">IIS ログを収集する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-text-log?tabs=portal">テキスト ログを収集する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-collection-syslog">Syslog を収集する</a></li></ul><p><em><strong>3. Log Analytics エージェントのアンインストール</strong></em><br>Azure ポータルから削除する方法と PowerShell から削除する方法をご案内いたします。</p><ul><li><em><strong>Azure ポータルからアンインストールする方法</strong></em></li></ul><ol><li>Azure ポータル上で VM を開き、画面左側の [設定] &gt; [拡張機能とアプリケーション] を選択します。</li><li>一覧から Log Analytics エージェントをクリックします。Windows マシンの場合は [種類] が MicrosoftMonitoringAgent、Linux マシンの場合は [種類] が OmsAgentForLinux の拡張機能が該当します。</li><li>画面右上にあります [アンインストール] を選択します。<br><img src="/blog/LogAnalytics/HowToMigrateToAmaFromLA/image01.png"></li></ol><ul><li><em><strong>PowerShell からアンインストールする方法</strong></em><br><a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmextension?view=azps-11.4.0">Remove-AzVMExtension</a> コマンドで拡張機能 (Log Analytics エージェント) をアンインストールできます。<br>以下のスクリプトは、同一リソース グループに所属する仮想マシンについて、一括で Log Analytics エージェントを削除するサンプルでございます。なお、このスクリプトはあくまでサンプルでございますので、お客様環境でも十分にご確認とご検証いただき、お客様のご要件に沿ってカスタマイズの上、ご利用いただきますようお願い申し上げます。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#下から 4行目に記載があります &quot;-Force&quot; については、拡張機能を削除して良いか VM ごとに許可をするプロセスを省くためオプションとして追加をしております。</span><br><span class="line">#確認作業をスキップしないほうがよろしい場合には、&quot;-Force&quot; を削除して実行いただくようお願いいたします。</span><br><span class="line"></span><br><span class="line">$RG =  &quot;&lt;VM の所属するリソース グループ名&gt;&quot;</span><br><span class="line">$VMs = Get-AzVM -ResourceGroupName $RG</span><br><span class="line">foreach($VM in $VMs)&#123;</span><br><span class="line">  $Extensions = (Get-AzVMExtension -ResourceGroupName $RG -VMName $VM.Name | Select Name, Publisher, ExtensionType)</span><br><span class="line">  foreach($Ext in $Extensions)&#123;</span><br><span class="line">    if(($Ext.Publisher -eq &quot;Microsoft.EnterpriseCloud.Monitoring&quot;) -and (($Ext.ExtensionType -eq &quot;MicrosoftMonitoringAgent&quot;) -or ($Ext.ExtensionType -eq &quot;OmsAgentForLinux&quot;)))&#123;</span><br><span class="line">      Write-Output(&quot;Removing &#123;0&#125; from &#123;1&#125;.&quot; -f $Ext.Name, $VM.Name)</span><br><span class="line">      Remove-AzVMExtension -ResourceGroupName $RG -VMName $VM.Name -Name $Ext.Name -Force</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><br><div class="alert is-warning"><p class="alert-title">警告</p><p>上記手順は、Log Analytics エージェント以外のエージェント (Dependency エージェント) や他製品で Log Analytics エージェントを使用していない場合の手順でございます。Microsoft Defender for Cloud や Microsoft Sentinel 等、他製品で Log Analytics エージェントを利用されている場合は、移行前に <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/agents-overview#supported-services-and-features">Azure Monitor エージェントでサポートされているサービスと機能</a> で対象製品が Azure Monitor エージェントに対応していることをご確認ください。また、Dependency エージェントをご利用されている場合は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-overview">VM insights の有効化の概要</a> や、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/vm/vminsights-enable-portal">Azure portal で VM insights を有効にする</a> をご確認いただき、移行を実施してください。</p></div><br><h3 id="Q12-Log-Analytics-エージェントと-Azure-Monitor-エージェントを同時に稼働しています。Azure-Monitor-エージェントでログが収集されていることを確認する方法を教えてください。"><a href="#Q12-Log-Analytics-エージェントと-Azure-Monitor-エージェントを同時に稼働しています。Azure-Monitor-エージェントでログが収集されていることを確認する方法を教えてください。" class="headerlink" title="Q12. Log Analytics エージェントと Azure Monitor エージェントを同時に稼働しています。Azure Monitor エージェントでログが収集されていることを確認する方法を教えてください。"></a>Q12. Log Analytics エージェントと Azure Monitor エージェントを同時に稼働しています。Azure Monitor エージェントでログが収集されていることを確認する方法を教えてください。</h3><p>対象の Log Analytics ワークスペースで下記クエリを実行してください。<br>データ収集ルールを作成し、Azure Monitor エージェントがインストールされますと、Heartbeat が既定で収集されます。<br>Azure Monitor エージェントで収集される Heartbeat の Category は “Azure Monitor Agent” です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Heartbeat</span><br><span class="line">| where Computer == &#x27;computer-name&#x27;</span><br><span class="line">| where Category == &#x27;Azure Monitor Agent&#x27;</span><br></pre></td></tr></table></figure><br><h3 id="Q13-データ収集ルールを作成し、Azure-Monitor-エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log-Analytics-ワークスペースの左メニュー-仮想マシン-非推奨-を見ると、”接続されていません”-と表示されます。"><a href="#Q13-データ収集ルールを作成し、Azure-Monitor-エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log-Analytics-ワークスペースの左メニュー-仮想マシン-非推奨-を見ると、”接続されていません”-と表示されます。" class="headerlink" title="Q13. データ収集ルールを作成し、Azure Monitor エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log Analytics ワークスペースの左メニュー [仮想マシン (非推奨)] を見ると、”接続されていません” と表示されます。"></a>Q13. データ収集ルールを作成し、Azure Monitor エージェントがインストールされ、ログが収集されていることを確認しました。しかし、Log Analytics ワークスペースの左メニュー [仮想マシン (非推奨)] を見ると、”接続されていません” と表示されます。</h3><p>Log Analytics ワークスペースの左メニュー [仮想マシン (非推奨)] に表示される “Log Analytics 接続状況” は、Log Analytics エージェントがワークスペースに接続されていることを意味します。Azure Monitor エージェントが対象のワークスペースと接続している状況であることを意味するものではございません。</p><br><h3 id="Q14-仮想マシンを作成したとき、-Azure-Monitor-エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。"><a href="#Q14-仮想マシンを作成したとき、-Azure-Monitor-エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。" class="headerlink" title="Q14. 仮想マシンを作成したとき、 Azure Monitor エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。"></a>Q14. 仮想マシンを作成したとき、 Azure Monitor エージェントのインストール、および既存のデータ収集ルールとの関連付けを自動で実施する方法はありますか。</h3><p>はい、Azure Policy の機能を利用することで実現できます。<br>設定手順につきましては、弊社サポート ブログ <a href="https://jpazmon-integ.github.io/blog/LogAnalytics/automatically_install_ama/">仮想マシン作成時に Azure Monitor エージェントのインストールとデータ収集ルールへの関連付けを自動で行う方法</a> をご覧ください。</p><br><h3 id="Q15-Log-Analytics-エージェントの廃止に伴い、VM-の診断設定も移行が必要ですか。"><a href="#Q15-Log-Analytics-エージェントの廃止に伴い、VM-の診断設定も移行が必要ですか。" class="headerlink" title="Q15. Log Analytics エージェントの廃止に伴い、VM の診断設定も移行が必要ですか。"></a>Q15. Log Analytics エージェントの廃止に伴い、VM の診断設定も移行が必要ですか。</h3><p>いいえ、Log Analytics エージェントの廃止に伴って <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/diagnostics-extension-overview">VM の診断設定</a>の移行は必要ありません。<br>Log Analytics エージェントと、VM の診断設定は別機能でございます。VM の診断設定では、Azure VM に Azure Diagnostics 拡張機能をインストールし、ゲスト OS のログやメトリックをストレージ アカウントに送信する機能です。VM の診断設定では Log Analytics エージェントを利用しません。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;[更新履歴]&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;2024/04/30 FAQ 追加&lt;/li&gt;
&lt;li&gt;2022/10/18 ブログ公開&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;Log Analytics エージェントが 2024 年 8 月に廃止することに伴い、Azure Monitor エージェントへの移行に関するお問い合わせをよくいただいております。そこで、本記事では Azure Monitor エージェントへの移行に関するよくあるご質問を Q &amp;amp; A 形式でおまとめいたしました。これから Azure Monitor エージェントへ移行される方、Azure Monitor エージェントの導入をご検討されている方の一助となれば幸いです。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Azure Monitor" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="移行" scheme="https://jpazmon-integ.github.io/blog/tags/%E7%A7%BB%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor のリソースにおける、日本語 でリソース名を設定することによる影響</title>
    <link href="https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/"/>
    <id>https://jpazmon-integ.github.io/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/</id>
    <published>2024-04-12T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.123Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitor サポートの山口です。<br>今回は、Azure Monitor のリソースにて、リソース名を日本語で設定することに起因し発生する事象をご案内いたします。<br><br></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">1. はじめに</a></li><li><a href="#2-%E4%BA%8B%E4%BE%8B">2. 事例</a><ul><li><a href="#2-1-AzureMonitor%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86%E3%81%8C%E5%A4%B1%E6%95%97%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B">2-1. Azure Monitor エージェントにおけるログ収集が失敗することがある</a></li><li><a href="#2-2-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E7%99%BA%E5%A0%B1%E3%81%8C%E5%A4%B1%E6%95%97%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B">2-2. アラート ルールの発報が失敗することがある</a></li><li><a href="#2-3-%E8%A8%BA%E6%96%AD%E8%A8%AD%E5%AE%9A%E3%81%8C%E6%B6%88%E3%81%88%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B">2-3. 診断設定が消えることがある</a></li></ul></li><li><a href="#3-%E3%81%BE%E3%81%A8%E3%82%81">3. まとめ</a><br></li></ul><h2 id="1-はじめに"><a href="#1-はじめに" class="headerlink" title="1. はじめに"></a>1. はじめに</h2><p>サブスクリプション名、リソース グループ名、およびリソース名の命名規則につきまして、日本語でリソースを作成すること自体は可能ですが、一方で製品の動作不具合が発生する要因となる可能性があるため、これらを日本語にて命名することは推奨されておりません。</p><p>以下、弊社 Azure サポート チームの過去ブログもご参照ください。<br><br><a href="https://jpaztech1.z11.web.core.windows.net/%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%90%8D%E3%81%AE%E5%88%B6%E9%99%90%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6.html">jpaztech1.z11.web.core.windows.net/リソースグループ名の制限について</a></p><p>以下、リソースの命名規則についての公開情報もございますので併せてご確認ください。<br><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/resource-name-rules">リソースの名前付けに関する制限事項 - Azure Resource Manager</a></p><p>また、過去にはトラブルシューティングが必要なケースにて設定に問題がない場合であっても、最終的に日本語のリソースが存在したことが起因で製品不具合が発生していた事例もありました。</p><p>上記より、リソース名が日本語の場合は製品が正しく動作しない可能性があるため、Azure リソースの命名には 英数字のみでの設定をご検討いただけますと幸いです。<br>なお、リソース名は基本的に変更することが出来ないため、既に日本語を設定している場合はリソースを再作成いただく必要がある点はご留意ください。<br><br></p><h2 id="2-事例"><a href="#2-事例" class="headerlink" title="2. 事例"></a>2. 事例</h2><p>本記事では、現在確認できている、日本語でリソース名を設定することにより製品が正常に動作しない事例について 3 つご紹介いたします。<br><br></p><h3 id="2-1-Azure-Monitor-エージェントにおけるログ収集が失敗することがある"><a href="#2-1-Azure-Monitor-エージェントにおけるログ収集が失敗することがある" class="headerlink" title="2-1. Azure Monitor エージェントにおけるログ収集が失敗することがある"></a>2-1. Azure Monitor エージェントにおけるログ収集が失敗することがある</h3><p>リソース ID に日本語が含まれる場合、正常にログが収集されない場合があります。<br>Azure Monitor エージェントの前提条件として、マネージド ID が有効化されている必要がありますが、日本語が含まれることにより正常に認証が行われず、その結果としてエージェントが正常に動作しない場合があります。<br>その結果、エージェントがインストールされ前提条件を満たしていても、ログやメトリックが収集できないといった事例を複数確認しております。<br><br></p><h3 id="2-2-アラート-ルールの発報が失敗することがある"><a href="#2-2-アラート-ルールの発報が失敗することがある" class="headerlink" title="2-2. アラート ルールの発報が失敗することがある"></a>2-2. アラート ルールの発報が失敗することがある</h3><p>日本語文字の関係で、アラート ルールが正常に動作せず、しきい値を満たしたにもかかわらず発報されなかった事例を複数確認しております。<br>なお、本事象は必ず発生するわけではないため、現在正常に動作している場合であっても、今後発生する場合があります。<br>そのため、可能であれば日本語を含まないアラート ルールに変更することをご検討ください。<br><br></p><h3 id="2-3-診断設定が消えることがある"><a href="#2-3-診断設定が消えることがある" class="headerlink" title="2-3. 診断設定が消えることがある"></a>2-3. 診断設定が消えることがある</h3><p>日本語を含む、英数字以外の文字がリソース名に含まれる場合、診断設定を作成しても設定が消えることがあります。<br>ただし本事象は以下の公開情報にも記載があるとおり、診断設定が英数字以外の文字をサポートしないために発生する事象であるため、製品の不具合ではないです。<br><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/create-diagnostic-settings?tabs=portal#setting-disappears-because-of-non-ascii-characters-in-resourceid">resourceID の 非 ASCII 文字が原因で設定が消える</a><br><br></p><p>※ なお、現在は診断設定名を設定すると以下のようにメッセージが表示されます。<br><img src="/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/png1.png"><br><br></p><p>診断設定の動作につきましては事例を添えてご説明いたします。<br>以下に、自動スケーリングの診断設定のリソース名に日本語が含まれる場合の動作を例にしてご説明いたします。<br><br></p><p>[自動スケーリングの診断設定例]</p><ol><li><p>Azure Portal の言語設定が日本語の場合、カスタム自動スケーリングを設定すると自動スケーリング設定の名前が日本語にて作成されます。<br><img src="/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/png2.png"></p></li><li><p>上記状態で保存し、診断設定を以下のように作成します。<br><img src="/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/png3.png"></p></li><li><p>診断設定の作成に成功し、表示上も正しく作成されたように見えます。<br><img src="/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/png4.png"></p></li><li><p>1 時間経過後に確認してみると、診断設定が消えてしまいます。<br><img src="/blog/AzureMonitorEssential/HowtoResourceIDNamingRule/png5.png"></p></li></ol><p>事例は以上です。上記のように、日本語文字が含まれる場合には設定が消えてしまう場合があります。<br>なお、もしも日本語でリソースが作成された場合の回避策としては、既定で入力されている自動スケーリング設定の名前を英数字に入力し再設定いただくことをご検討ください。<br><br></p><h2 id="3-まとめ"><a href="#3-まとめ" class="headerlink" title="3. まとめ"></a>3. まとめ</h2><p>今回は Azure Monitor のリソースにおける、日本語 でリソース名を設定することによる影響についてご案内しました。<br>日本語文字での設定自体は可能ですが、日本語を使用することにより不具合が発生する事象を複数確認しておりますので、よろしければリソース名は “英数字” での設定をご検討ください。</p><p>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitor サポートの山口です。&lt;br&gt;今回は、Azure Monitor のリソースにて、リソース名を日本語で設定することに起因し発生する事象をご案内いたします。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Azure Monitor Essentials" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Essentials/"/>
    
  </entry>
  
  <entry>
    <title>Azure Private Link  を使った Azure Arc + Azure Monitor</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_AMPLS/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_AMPLS/</id>
    <published>2024-04-07T12:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.075Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。</p><p>今回は、Azure Private Link  を使った Azure Arc および Azure Monitor を構成した際の DNS 構成や設定画面を実際に検証環境を構成してご紹介いたします。<br>当ページの内容は以下 2 稿 の内容を踏まえて記載しております。ご一読いただき当ページの内容を参照いただけますと幸いです。</p><ul><li> <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/">Azure Private Link  を使った Azure Arc への接続 - NW 構成</a> </li><li> <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/">Azure Private Link  を使った Azure Arc への接続 - DNS 構成</a> </li></ul><p>今回説明する構成は公開情報 <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security">Azure Private Link を使用して、サーバーを Azure Arc に安全に接続する</a>に記載しております構成イメージ図を踏まえると下図 1 のような構成となります。<br>■図1 Azure Private Link を使った Azure Arc + Azure Monitor の構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/01.png"></p><p>以後、Azure Private Link  を使った Azure Monitor を AMPLS と記載いたします。<br>ご説明にあたって、当方の検証環境は以下の通りです。</p><p>■図 2. 検証環境の構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/02.png"></p><h2 id="DNS-構成について"><a href="#DNS-構成について" class="headerlink" title="DNS 構成について"></a>DNS 構成について</h2><p>DNS 構成については上記 blog  <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/#DNS-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E6%89%8B%E5%8B%95%E6%A7%8B%E6%88%90">DNS サーバーの手動構成</a> の構成を踏襲して図 2 の右上の表に記載されている FQDN を Private Link がデプロイした際に同時に作成される下図 3 のプライベート エンドポイントの IP アドレス（※1）に変換して通信できる環境を構築します。</p><p>※1 今回の検証環境では 10.13.1.4 ～ 10.13.1.17 となります。尚、Arc 向けの プライベート エンドポイントの IP アドレスは引き続き 10.13.0.4 ～ 10.13.0.9 となります。</p><p>■図 3. AMPLS 向けプライベート エンドポイントの [DNS の構成] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/03.png"></p><p>AMPLS では、後述する ”データ収集ルール”（以後、DCR ）においてリソース（今回は VM ”AAPLS001vm”）に対する ”データ収集エンドポイント” を設定する必要があります。<br>それを AMPLS の ”Azure Monitor リソース” に紐づける事を忘れないようご留意ください。<br>この設定が不足していると上図 3 における 10.13.1.15 ～ 10.13.1.17 のインターフェースのアドレスとそれに紐づく FQDN が登録されずログが採取できません。</p><p>■図 4. AMPLS の [Azure Monitor リソース] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/04.png"></p><p>上記 blog でArc にオンボードさせたマシン（コンピューター名が ”AAPLS001vm” ）から 作成した プライベート エンドポイント向けのアドレスに疎通できるか <a href="https://learn.microsoft.com/en-us/powershell/module/nettcpip/test-netconnection?view=windowsserver2022-ps">Test-NetConnection</a> で確認しました。<br>下図 5 の通りプライベート IP 向けに疎通が成功（TcpTestSucceeded の結果が True）となっていることが確認できます。</p><p>■図 5. コンピューター  ”AAPLS001vm” からの疎通確認<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/05.png"></p><h3 id="DCR-の設定確認"><a href="#DCR-の設定確認" class="headerlink" title="DCR の設定確認"></a>DCR の設定確認</h3><p>上記までの状態になれば NW ならびに DNS の構成は構築できているので、最後に実際にログを採取するための設定である DCR の設定ページの内容を確認します。<br>DCR では、”ログの送り先の Log Analytics ワークスペース” および ”AMPLS 経由でログを送付するリソース（マシン）のデータ収集エンドポイント”は下図のように 図 4 で設定した AMPLS の [Azure Monitor リソース] である必用があります。</p><p>■図 6. DCR の [データ ソース] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/06.png"></p><p>■図 7. DCR の [リソース] 画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/07.png"></p><h3 id="Log-Analytics-ワークスペースに届いているログの確認"><a href="#Log-Analytics-ワークスペースに届いているログの確認" class="headerlink" title="Log Analytics ワークスペースに届いているログの確認"></a>Log Analytics ワークスペースに届いているログの確認</h3><p>上記まででログを採取できる構成になりました。最後に実際に Log Analytics ワークスペースに届いているログを確認します。</p><p>ハートビートログ（図 8, 対象テーブル：Heartbeat）、パフォーマンスカウンターログ（図 9, 対象テーブル：Perf）を正しく確認することが出来ました。<br>■図 8. Log Analytics ワークスペース - ハートビートログを確認している画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/08.png"></p><p>■図 9. Log Analytics ワークスペース - パフォーマンスカウンターログを確認している画面<br><img src="/blog/Arc/Arc_AAMPLS_AMPLS/09.png"></p><p>本日のご紹介は以上となります。上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;今回は、Azure Private Link  を使った Azure Arc および Azure Monitor を構成した際の DNS 構成</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="HowTo" scheme="https://jpazmon-integ.github.io/blog/tags/HowTo/"/>
    
    <category term="Azure Private Link" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Private-Link/"/>
    
    <category term="AMPLS" scheme="https://jpazmon-integ.github.io/blog/tags/AMPLS/"/>
    
  </entry>
  
  <entry>
    <title>Azure Private Link  を使った Azure Arc への接続 - DNS 構成</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_DNS/</id>
    <published>2024-03-30T13:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.087Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。</p><p>今回は、Azure Private Link  を使った Azure Arc への接続時におけるDNS 構成例やオンボードする際の通信シーケンスを実際に検証環境を構成してご紹介いたします。<br>当ページの内容は <a href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/">Azure Private Link  を使った Azure Arc への接続 - NW 構成編</a> の内容を踏まえて記載しております。ご一読いただき当ページの内容を参照いただけますと幸いです。</p><p>ご説明にあたって、当方の検証環境は以下の通りです。<br>上部は <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security">当ページ</a> から抜粋した図であり、下部が検証環境のサーバーやエンドポイントの情報を添えた内容となります。</p><p>■図 1. 検証環境の構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/01.png"></p><h2 id="DNS-構成について"><a href="#DNS-構成について" class="headerlink" title="DNS 構成について"></a>DNS 構成について</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#configure-on-premises-dns-forwarding">オンプレミスの DNS 転送を構成する</a> に記載しておりますようにオンプレミスのマシンまたはサーバーでは、プライベート リンクの DNS レコードをプライベート エンドポイントの IP アドレスに解決できる必要があります。 </p><p>具体的には図 1 の右下の表に記載されている FQDN を Private Link がデプロイした際に同時に作成される下図 2. プライベート エンドポイントの IP アドレス（※1）に変換して通信できる環境が必要となります。<br>※1 今回の検証環境では 10.13.0.4 ～ 10.13.0.9 となります。</p><p>■図 2. プライベート エンドポイントの [DNS の構成] 画面<br><img src="/blog/Arc/Arc_AAMPLS_DNS/02.png"></p><p>これを実現する方法は<a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#configure-on-premises-dns-forwarding">オンプレミスの DNS 転送を構成する</a>  に記載のとおりとなりますが、次の 3 つの方法があります。</p><ul><li>Azure 統合プライベート DNS ゾーンを使用した DNS 構成</li><li>DNS サーバーの手動構成</li><li>単一サーバーのシナリオ</li></ul><h3 id="Azure-統合プライベート-DNS-ゾーンを使用した-DNS-構成"><a href="#Azure-統合プライベート-DNS-ゾーンを使用した-DNS-構成" class="headerlink" title="Azure 統合プライベート DNS ゾーンを使用した DNS 構成"></a>Azure 統合プライベート DNS ゾーンを使用した DNS 構成</h3><p>プライベート エンドポイント作成時に [プライベート DNS ゾーンと統合する] を ”はい”と設定するとプライベート DNS ゾーンがデプロイ時に生成されます。<br>このプライベート DNS ゾーンに FQDN から IP アドレスに変換する情報が記載されておりますが、この情報を参照する仕組みとなります。</p><p>詳細はこちらのページ <a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns-integration#on-premises-workloads-using-a-dns-forwarder">DNS フォワーダーを使用してオンプレミスのワークロード</a>  をご参照ください。</p><p>■図 3. プライベート エンドポイント作成時の画面<br><img src="/blog/Arc/Arc_AAMPLS_DNS/03.png"></p><h3 id="DNS-サーバーの手動構成"><a href="#DNS-サーバーの手動構成" class="headerlink" title="DNS サーバーの手動構成"></a>DNS サーバーの手動構成</h3><p>オンプレにあるマシンが参照する DNS サーバーの A レコードとして登録する仕組みです。<br>今回の検証ではこちらの仕組みを採用し、 DNS サーバー （IP アドレス 10.11.1.5） に下図 4 のようにレコードを登録します。<br>また Azure Arc へオンボードさせるマシンの DNS 参照先のアドレスを当サーバー（IP アドレス 10.11.1.5）に設定します。</p><p>■図 4. プライベート エンドポイントの [DNS の構成] 画面<br>下図は his.arc.azure.com ゾーンを示しております。<br><img src="/blog/Arc/Arc_AAMPLS_DNS/04.png"></p><h3 id="単一サーバーのシナリオ"><a href="#単一サーバーのシナリオ" class="headerlink" title="単一サーバーのシナリオ"></a>単一サーバーのシナリオ</h3><p>hosts ファイルに図 1 に記載しているエンドポイントの FQDN と IP アドレスの変換表を設定することで、プライベート エンドポイント向けの通信を実現させます。</p><h2 id="オンボード処理の通信シーケンスをみてみる"><a href="#オンボード処理の通信シーケンスをみてみる" class="headerlink" title="オンボード処理の通信シーケンスをみてみる"></a>オンボード処理の通信シーケンスをみてみる</h2><h3 id="検証構成"><a href="#検証構成" class="headerlink" title="検証構成"></a>検証構成</h3><p>下図 5 は 図 1 の下部の再掲となり、今回の検証環境の構成となります。<br>■図 5. 検証環境構成<br><img src="/blog/Arc/Arc_AAMPLS_DNS/05.png"></p><p>Arc にオンボードさせるマシンはコンピューター名が ”AAPLS001vm” となり、 IP アドレスは <code>10.11.1.4</code> となります。 DNS サーバーの IP アドレスは <code>10.11.1.5</code> となります。<br>■図 6. コンピューター  ”AAPLS001vm” のネットワーク構成<br><img src="/blog/Arc/Arc_AAMPLS_DNS/06.png"></p><p>また <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#troubleshooting">トラブルシューティング</a> に記載されている nslookup の結果は以下の通りとなり、DNS サーバーの設定したレコードとおりプライベート IP アドレスが返ってきます。<br>■図 7. 特定エンドポイントへの nslookup の結果<br><img src="/blog/Arc/Arc_AAMPLS_DNS/07.png"></p><h3 id="オンボード処理時のネットワークキャプチャ結果"><a href="#オンボード処理時のネットワークキャプチャ結果" class="headerlink" title="オンボード処理時のネットワークキャプチャ結果"></a>オンボード処理時のネットワークキャプチャ結果</h3><p>最後にコンピューター  ”AAPLS001vm” を Azure Arc へオンボードさせる際にネットワークキャプチャを採取して、どのような通信シーケンスになるか確認してみます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#connect-to-an-azure-arc-enabled-servers">Azure Arc 対応サーバーに接続する</a> の手順でダウンロードしたスクリプト <code>OnboardingScript.ps1</code> を実行します。</p><p>まず下図は  Azure Connected Machine エージェント （以後、Arc エージェントと呼称します）をダウンロードする際の DNS 通信と <code>download.microsoft.com</code>との通信時のキャプチャとなります。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/network-requirements?tabs=azure-cloud#urls">通信要件</a> に記載されている FQDN <code>aka.ms</code> と <code>download.microsoft.com</code> の IP アドレスが解決（図8）され、ダウンロード処理の通信（図9）が確認できます。</p><p>■図 8. Arc エージェントをダウンロードする際の DNS 通信のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/08.png"></p><p>■図 9. <code>download.microsoft.com</code>との通信時のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/09.png"></p><p>続けてインストールされた Arc エージェントにより Azure Arc へオンボードする際の通信についてです。<br>実際にはスクリプト <code>OnboardingScript.ps1</code> に記載している下記スクリプト（サブスクリプション ID など一部リソース情報をマスキングしております）の処理によりオンボードします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\tmp&gt; &amp; &quot;$env:ProgramW6432\AzureConnectedMachineAgent\azcmagent.exe&quot; connect --resource-group &quot;$env:RESOURCE_GROUP&quot; --tenant-id &quot;$env:TENANT_ID&quot; --location &quot;$env:LOCATION&quot; --subscription-id &quot;$env:SUBSCRIPTION_ID&quot; --cloud &quot;$env:CLOUD&quot; --private-link-scope &quot;/subscriptions/XXX/resourceGroups/AAPLS/providers/Microsoft.HybridCompute/privateLinkScopes/AAPLS001&quot; --correlation-id &quot;$env:CORRELATION_ID&quot;;</span><br><span class="line">INFO    Connecting machine to Azure... This might take a few minutes.</span><br><span class="line">INFO    Testing connectivity to endpoints that are needed to connect to Azure... This might take a few minutes.</span><br><span class="line">INFO    Please login using the pop-up browser to authenticate.</span><br><span class="line">  20% [==&gt;            ]</span><br><span class="line">  30% [===&gt;           ]</span><br><span class="line">  INFO    Creating resource in Azure...                 Correlation ID=YYY Resource ID=/subscriptions/XXXX/resourceGroups/AAPLS/providers/Microsoft.HybridCompute/machines/AAPLS001vm</span><br><span class="line">  60% [========&gt;      ]</span><br><span class="line">  80% [===========&gt;   ]</span><br><span class="line"> 100% [===============]</span><br><span class="line">  INFO    Connected machine to Azure</span><br><span class="line">INFO    Machine overview page: https://portal.azure.com/#@yyyy/resource/subscriptions/xxxx/resourceGroups/AAPLS/providers/Microsoft.HybridCompute/machines/AAPLS001vm/overview</span><br></pre></td></tr></table></figure><p>■図 10. オンボード処理<br><img src="/blog/Arc/Arc_AAMPLS_DNS/10.png"></p><p>上記処理の時の DNS 通信と <code>je.his.arc.azure.com</code> との通信時のキャプチャとなります。<br>図11 に注目いただくと DNS サーバーに登録したプライベート エンドポイントの FQDN については名前解決した結果、プライベート IP アドレスになっていることがわかります。<br>一方 <code>management.azure.com</code> の IP アドレスは <code>4.150.240.10</code> というグローバル IP アドレスとなっていることがわかります。<br>このようにプライベート エンドポイントが作成された宛先（FQDN）については、プライベート IP アドレスの応答を正しく受けれない構成の場合、正しく通信ができないこととなります。<br>また図 12 のとおり、プライベート IP アドレスとして応答受けた  ‘je.his.arc.azure.com‘ の宛先と通信シーケンスが進んでいることがわかります。</p><p>■図 11. オンボード処理の際の DNS 通信のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/11.png"></p><p>■図 12. <code>je.his.arc.azure.com</code> との通信時のキャプチャ<br><img src="/blog/Arc/Arc_AAMPLS_DNS/12.png"></p><p>問題なく Arc へオンボードできれば下図 13. のようにオンボードしたコンピューター  ”AAPLS001vm” のステータスを確認することが可能となります。</p><p>■図 13.  Azure ポータルでオンボード状態を確認する際の画面<br><img src="/blog/Arc/Arc_AAMPLS_DNS/13.png"></p><p>本日のご紹介は以上となります。上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;今回は、Azure Private Link  を使った Azure Arc への接続時におけるDNS 構成例やオンボードする際の通信シーケン</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="HowTo" scheme="https://jpazmon-integ.github.io/blog/tags/HowTo/"/>
    
    <category term="Azure Private Link" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Private-Link/"/>
    
  </entry>
  
  <entry>
    <title>Azure Private Link  を使った Azure Arc への接続 - NW 構成</title>
    <link href="https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/"/>
    <id>https://jpazmon-integ.github.io/blog/Arc/Arc_AAMPLS_NW/</id>
    <published>2024-03-30T08:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.099Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Monitoring チームの 佐藤 です。</p><p>今回は、Azure Private Link を使った Azure Arc への接続に関するよくあるお問い合わせ内容とその回答について紹介したいと思います。<br>Azure Arc にオンボードさせるにはオンプレミスマシン（もしくは AWS のようなクラウド上の VM）には、Azure Connected Machine エージェント （以後、Arc エージェントと呼称します）をインストールする必要があります。</p><p>その Arc エージェントを使用して Azure Arc にオンボード（管理状態）にするには以下ネットワーク要件を満たす必要がございます。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/network-requirements?tabs=azure-cloud">Connected Machine エージェントのネットワーク要件</a></p><p>ここで Azure Private Link を使った Azure Arc への接続については以下ページに基本構成を記載しております。<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security">Azure Private Link を使用して、サーバーを Azure Arc に安全に接続する</a></p><p>上記ページに記載しておりますが、Azure Private Link を使った Azure Arc への接続は以下が基本構成となります。<br>一部情報補記しております<br>■図1 Azure Private Link を使った Azure Arc 構成イメージ<br><img src="/blog/Arc/Arc_AAMPLS_NW/01.png"></p><p>※1 2023 年 7 月に <a href="https://news.microsoft.com/ja-jp/2023/07/12/230712-azure-ad-is-becoming-microsoft-entra-id/">Microsoft Entra ID</a> と名前が変わっております。<br>※2 後述する説明のために ExpressRoute などの Azure 側の終端となる <em>仮想ネットワーク ゲートウェイ</em> の情報を記載しております。</p><h2 id="Q1-AAD-と-ARM-には閉域で接続できるか"><a href="#Q1-AAD-と-ARM-には閉域で接続できるか" class="headerlink" title="Q1. AAD と ARM には閉域で接続できるか"></a>Q1. AAD と ARM には閉域で接続できるか</h2><p>まず上図 1 とネットワーク要件に記載されている内容で多くのお問い合わせいただく以下 QA から説明します。</p><p>Q1.<br>AAD (Azure Active Directory) および ARM (Azure Resource Manager) に閉域で接続できますか？</p><p>A1.<br>いいえ。接続できません。</p><p><em>説明</em><br>上記ネットワーク要件を記載している <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/network-requirements?tabs=azure-cloud#urls">ページ</a> に記載しておりますとおり、下図の <code>プライベートリンクで使用されるエンドポイント</code> 列に ”パブリック” と表記されている列の宛先 （aks.ms や download.microsoft.com）はインターネット経由で接続する必要がございます。</p><p>■図2. NW 要件<br><img src="/blog/Arc/Arc_AAMPLS_NW/02.png"></p><p>上図 1 で言及しますと “On-premises network” から上に Firewall を超え、インターネット経由で AAD および ARM へ接続されるイメージがわかるかと存じます。</p><h2 id="Q2-AAD-と-ARM-への通信を-Azure-network-経由で通信できるか"><a href="#Q2-AAD-と-ARM-への通信を-Azure-network-経由で通信できるか" class="headerlink" title="Q2. AAD と ARM への通信を Azure network 経由で通信できるか"></a>Q2. AAD と ARM への通信を Azure network 経由で通信できるか</h2><p>ここで On-premises network から AAD と ARM への通信も Azure network 経由で接続できるかについて説明いたします。</p><p>■図3.  通信イメージ<br><img src="/blog/Arc/Arc_AAMPLS_NW/03.png"></p><p>Q2.<br>AAD (Azure Active Directory) および ARM (Azure Resource Manager) への通信を Azure network 経由で接続できますか？</p><p>A2.<br>仕組み上可能となりますが、推奨しておりません。<br>まず仮想ネットワーク ゲートウェイにはインターネットへ接続するための機能は持っておりません。そのため、インターネットへ接続するためのサービスなどをお客様の Azure network 環境に構築いただく必要がございますが、追加の機能のデプロイや設定が必要となり 2024 年 3 月時点で当社としては推奨しておりません。</p><h2 id="Q3-公開情報の『ネットワーク構成』に記載されているオプション-1-はどのようなシナリオですか。"><a href="#Q3-公開情報の『ネットワーク構成』に記載されているオプション-1-はどのようなシナリオですか。" class="headerlink" title="Q3.  公開情報の『ネットワーク構成』に記載されているオプション 1 はどのようなシナリオですか。"></a>Q3.  公開情報の『ネットワーク構成』に記載されているオプション 1 はどのようなシナリオですか。</h2><p>上記に関連して公開情報 の <a href="https://learn.microsoft.com/ja-jp/azure/azure-arc/servers/private-link-security#network-configuration">ネットワーク構成</a> に記載されている下図のオプション 1 の以下文言について質問を頂戴することがあります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">インターネットに送信されるすべてのトラフィックを Azure VPN または ExpressRoute 回線経由でルーティングするようにネットワークが構成されている場合</span><br></pre></td></tr></table></figure><p>■図4. オプション 1 の説明箇所<br><img src="/blog/Arc/Arc_AAMPLS_NW/04.png"></p><p>Q3.<br>公開情報の『ネットワーク構成』に記載されているオプション 1 はどのようなシナリオですか。</p><p>A3.<br>Azure network からインターネット（パブリック エンドポイント）へ通信させる場合に、全てのトラフィックを On-premises network へルーティングする場合となります。<br>上図 1 ですと “Azure network” から左の  “On-premises network” へルーティングすることを意図しております。<br>具体的なルーティング設定の例としては “On-premises network” 側のお客様 NW 機器などから BGP にて デフォルトルート （0.0.0.0/0）の広告が仮想ネットワーク ゲートウェイ側に届いている場合のシナリオとなります。</p><p>本日のご紹介は以上となります。上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Monitoring チームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;今回は、Azure Private Link を使った Azure Arc への接続に関するよくあるお問い合わせ内容とその回答について紹介した</summary>
      
    
    
    
    
    <category term="Azure Arc" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Arc/"/>
    
    <category term="HowTo" scheme="https://jpazmon-integ.github.io/blog/tags/HowTo/"/>
    
    <category term="Azure Private Link" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Private-Link/"/>
    
  </entry>
  
  <entry>
    <title>Application Insights にテレメトリが保存されなかった場合のトラブルシューティングについて</title>
    <link href="https://jpazmon-integ.github.io/blog/applicationInsights/troubleshooting_telemetry/"/>
    <id>https://jpazmon-integ.github.io/blog/applicationInsights/troubleshooting_telemetry/</id>
    <published>2024-02-29T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.359Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北山です。</p><p>App Service や Azure VM などにデプロイいただいている Web アプリケーションのパフォーマンスを監視するために、Application Insights をご利用いただいているケースがございます。<br>監視対象の Web アプリケーションから Application Insights リソースに対してテレメトリ (ログやメトリックなどの情報) を送信することで、Web アプリケーションのパフォーマンス監視が可能です。<br>しかし、場合によっては監視対象の Web アプリケーションから Application Insights リソースに対してテレメトリが送信されないケースがございます。</p><blockquote><p>例 : Application Insights リソースの requests テーブルや traces テーブルに、突然ログが保存されなくなった。requests テーブルにはログが記録されているのに、突然 traces テーブルのログが記録されなくなったなど。</p></blockquote><p>このような問題が発生した場合に、問題解消のためにチェックすべきポイントについて記載いたします。<br>問題発生時によろしければご参考ください。</p><ul><li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li><li><a href="#%E3%82%B1%E3%83%BC%E3%82%B9-1-%E3%81%99%E3%81%B9%E3%81%A6%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%81%AE%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%8C-application-insights-%E3%81%AB%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%8F%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F">ケース 1. すべての種類のテレメトリが Application Insights にまったく収集されなくなった</a><ul><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81">問題の概要</a></li><li><a href="#%E7%96%91%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88">疑われるポイント</a></li></ul></li><li><a href="#%E3%82%B1%E3%83%BC%E3%82%B9-2-%E4%B8%80%E9%83%A8%E3%81%AE%E7%A8%AE%E9%A1%9E%E3%81%AE%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%8C-application-insights-%E3%81%AB%E3%81%BE%E3%81%A3%E3%81%9F%E3%81%8F%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F">ケース 2. 一部の種類のテレメトリが Application Insights にまったく収集されなくなった</a><ul><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-1">問題の概要</a></li><li><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E3%81%82%E3%81%A3%E3%81%9F%E3%82%B1%E3%83%BC%E3%82%B9">実際にあったケース</a></li></ul></li><li><a href="#%E3%82%B1%E3%83%BC%E3%82%B9-3-%E5%95%8F%E9%A1%8C%E3%81%AA%E3%81%8F-application-insights-%E3%81%AB%E3%83%86%E3%83%AC%E3%83%A1%E3%83%88%E3%83%AA%E3%81%8C%E5%8F%8E%E9%9B%86%E5%87%BA%E6%9D%A5%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8C%E6%99%82%E3%80%85%E6%9C%9F%E5%BE%85%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%8C%E6%AC%A0%E8%90%BD%E3%81%99%E3%82%8B">ケース 3. 問題なく Application Insights にテレメトリが収集出来ているが、時々期待したログが欠落する</a><ul><li><a href="#%E5%95%8F%E9%A1%8C%E3%81%AE%E6%A6%82%E8%A6%81-2">問題の概要</a></li><li><a href="#%E7%96%91%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88-1">疑われるポイント</a></li></ul></li><li><a href="#%E8%89%B2%E3%80%85%E8%AA%BF%E3%81%B9%E3%81%9F%E3%81%91%E3%81%A9%E5%95%8F%E9%A1%8C%E3%81%8C%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88">色々調べたけど問題が解決しない場合……</a></li><li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li><li><a href="#%E9%96%A2%E9%80%A3%E3%81%99%E3%82%8B%E8%A8%98%E4%BA%8B">関連する記事</a></li></ul><h1 id="ケース-1-すべての種類のテレメトリが-Application-Insights-にまったく収集されなくなった"><a href="#ケース-1-すべての種類のテレメトリが-Application-Insights-にまったく収集されなくなった" class="headerlink" title="ケース 1. すべての種類のテレメトリが Application Insights にまったく収集されなくなった"></a>ケース 1. すべての種類のテレメトリが Application Insights にまったく収集されなくなった</h1><h2 id="問題の概要"><a href="#問題の概要" class="headerlink" title="問題の概要"></a>問題の概要</h2><ul><li>今までは問題なく Application Insights に各種テレメトリ (requests ログや traces ログ、dependencies ログなど) が収集されていた。</li><li>しかし突然、すべての種類のテレメトリが Application Insights に収集されなくなった。</li></ul><h2 id="疑われるポイント"><a href="#疑われるポイント" class="headerlink" title="疑われるポイント"></a>疑われるポイント</h2><h3 id="その-1-通信のトラブル"><a href="#その-1-通信のトラブル" class="headerlink" title="その 1. 通信のトラブル"></a>その 1. 通信のトラブル</h3><p>突然すべてのテレメトリが Application Insights に収集されなくなった場合、Application Insights のエンドポイントに対して通信が失敗している可能性がございます。<br>例えば下記のような契機によって、すべてのテレメトリが突然収集できなくなる可能性がございます。</p><ul><li>監視対象の Web アプリケーションを App Service にデプロイしており、App Service リソースに対して VNET 統合を実施した。</li><li>監視対象の Web アプリケーションを Azure VM にデプロイしており、関連する VNET に紐づいた NSG や Azure Firewall の設定を変更した。など</li></ul><p>上記のような作業を実施したことで、Application Insights のエンドポイントと通信が出来ずテレメトリの収集に失敗している可能性がございます。</p><p>ちなみに Application Insights に対してテレメトリを送信するためには、Application Insights のエンドポイントに関連する URL に通信が可能な状態である必要がございます。</p><blockquote><p>「目的」がテレメトリの箇所の URL をご確認ください。</p></blockquote><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/ip-addresses#outgoing-ports">Azure Monitor で使用される IP アドレス # 送信ポート</a><br><img src="/blog/applicationInsights/troubleshooting_telemetry/pict1.png"></li></ul><p>もしくは、もしサービス タグを用いて通信制御を構築している場合、監視対象の Web アプリケーションから外向きの通信に対して AzureMonitor サービス タグに対する通信許可が必要です。<br>ポート番号は 443 番に対して通信許可をご構築ください。</p><p>そのため、例えば VNET 統合した App Service リソースから「dc.applicationinsights.azure.com」に対する名前解決が失敗する、通信でタイムアウトが発生している場合、突然すべての種類のテレメトリが宛先の Application Insights に対して送信できなくなる可能性がございます。</p><h3 id="Application-Insights-への通信を確認する方法"><a href="#Application-Insights-への通信を確認する方法" class="headerlink" title="Application Insights への通信を確認する方法"></a>Application Insights への通信を確認する方法</h3><h4 id="App-Service-や-Azure-Functions-に-Web-アプリケーションをデプロイしている場合"><a href="#App-Service-や-Azure-Functions-に-Web-アプリケーションをデプロイしている場合" class="headerlink" title="App Service や Azure Functions に Web アプリケーションをデプロイしている場合"></a>App Service や Azure Functions に Web アプリケーションをデプロイしている場合</h4><p>下記の手順で当該コンピューターから Application Insights へ通信が可能であるかどうかをご確認ください。</p><h5 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h5><ol><li><p>当該 Application Insights リソース ページへ移動します。</p></li><li><p>概要ページに記載がある接続文字列をコピーいただき、[IngestionEndpoint] に指定がある URL のホスト名をコピーします。<br>例 : 「<code>IngestionEndpoint=https://japaneast-0.in.applicationinsights.azure.com/</code>」の場合は、「japaneast-0.in.applicationinsights.azure.com」をコピーします。<br>もしくは、グローバル インジェスト エンドポイントのホストである「dc.applicationinsights.azure.com」を使います。<br>接続文字列を用いて Application Insights と統合する場合は、接続文字列に記載があるホストに対して通信します。<br>接続文字列ではなくインストルメンテーション キーを用いて Application Insights と統合する場合は、dc.applicationinsights.azure.com に対して通信します。<br><img src="/blog/applicationInsights/troubleshooting_telemetry/pict2.png"></p></li><li><p>当該 App Service リソース ページへ移動します。</p></li><li><p>左側ペインの [高度なツール] をクリックし、[移動] をクリックします。</p></li><li><p>画面上部の [Debug console - PowerShell] をクリックします。<br>Linux の場合おは[SSH] をクリックします。</p></li><li><p>下記コマンドを実行し、名前解決が可能であるかどうかご確認ください。</p></li></ol><p><strong>Linux の場合</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup japaneast-0.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><p>もし名前解決が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image.png" alt="Alt text"></p><p>正常に名前解決出来る場合は、下図のように IP アドレスが表示されます。<br>※ 下図の環境は AMPLS を構築しているため、プライベート エンドポイントの IP アドレスが表示されております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-1.png" alt="Alt text"></p><p><strong>Windows の場合</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameresolver &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameresolver japaneast-1.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><p>もし名前解決が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-3.png" alt="Alt text"></p><p>正常に名前解決出来る場合は、下図のように IP アドレスが表示されます。<br>※ 下図の環境は AMPLS を構築しているため、プライベート エンドポイントの IP アドレスが表示されております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-2.png" alt="Alt text"></p><ol start="7"><li>下記コマンドを実行し、Application Insights のエンドポイントと通信が可能かご確認ください。  </li></ol><p><strong>Linux の場合</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://&lt;2 でコピーした値&gt;:443</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://japaneast-0.in.applicationinsights.azure.com:443</span><br></pre></td></tr></table></figure><p>もし宛先と通信が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-7.png" alt="Alt text"></p><p>もし 404 が返ってきた場合は正常に通信が出来ております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-4.png" alt="Alt text"></p><p><strong>Windows の場合</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpping &lt;2 でコピーした値&gt;:443</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpping japaneast-1.in.applicationinsights.azure.com:443</span><br></pre></td></tr></table></figure><p>もし宛先と通信が出来ない場合、一例ではございますが下図のようにエラーが発生します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-6.png" alt="Alt text"></p><p>もし、「Complete: 4/4 successful attempts (100%)」が出力された場合は、正常に通信出来ております。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-5.png" alt="Alt text"></p><p>App Service や Azure Functions の場合、nslookup や ping は機能しません。<br>そのため、nameresolver や tcpping を利用しております。<br>詳細は下記の公開情報をご参考ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/app-service/troubleshoot-vnet-integration-apps#troubleshoot-outbound-connectivity-on-windows-apps">仮想ネットワークとAzure App Serviceの統合のトラブルシューティング # Windows Apps での送信接続のトラブルシューティング</a>  </li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict3.png"></p><h4 id="Azure-VM-やオンプレミス環境のコンピューターに-Web-アプリケーションをデプロイしている場合"><a href="#Azure-VM-やオンプレミス環境のコンピューターに-Web-アプリケーションをデプロイしている場合" class="headerlink" title="Azure VM やオンプレミス環境のコンピューターに Web アプリケーションをデプロイしている場合"></a>Azure VM やオンプレミス環境のコンピューターに Web アプリケーションをデプロイしている場合</h4><p>下記の手順で当該コンピューターから Application Insights へ通信が可能であるかどうかをご確認ください。</p><h5 id="手順-1"><a href="#手順-1" class="headerlink" title="手順"></a>手順</h5><ol><li><p>当該 Application Insights リソース ページへ移動します。</p></li><li><p>概要ページに記載がある接続文字列をコピーいただき、[IngestionEndpoint] に指定がある URL のホスト名をコピーします。<br>例 : 「<code>IngestionEndpoint=https://japaneast-0.in.applicationinsights.azure.com/</code>」の場合は、「japaneast-0.in.applicationinsights.azure.com」をコピーします。<br><img src="/blog/applicationInsights/troubleshooting_telemetry/pict2.png"></p></li><li><p>当該コンピューターにリモートで接続いただき、下記コマンドを実行し、名前解決が可能であるかどうかご確認ください。もし名前解決に失敗する場合は、DNS 周りに何か問題があるかもしれません。</p></li></ol><p><strong>Linux の場合</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup japaneast-0.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><p><strong>Windows の場合 (PowerShell で実行)</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup &lt;2 でコピーした値&gt;</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup japaneast-0.in.applicationinsights.azure.com</span><br></pre></td></tr></table></figure><ol start="4"><li>下記コマンドを実行し、Application Insights のエンドポイントと通信が可能かご確認ください。もし通信に失敗する場合、ファイアウォールや NSG の設定などに問題があるかもしれません。</li></ol><p><strong>Linux の場合</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://&lt;2 でコピーした値&gt;:443</span><br></pre></td></tr></table></figure><p>例 : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --tlsv1.1 --tls-max 1.2 https://japaneast-0.in.applicationinsights.azure.com:443</span><br></pre></td></tr></table></figure><p><strong>Windows の場合 (PowerShell で実行)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test-NetConnection -ComputerName &lt;2 でコピーした値&gt; -Port 443</span><br></pre></td></tr></table></figure><p>例 :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test-NetConnection -ComputerName japaneast-0.in.applicationinsights.azure.com -Port 443</span><br></pre></td></tr></table></figure><p>もし監視対象のコンピューターや App Service から Application Insights への通信が失敗しているようなら、一度通信環境の見直しをお願いします。</p><h3 id="その-2-日時上限の制限抵触"><a href="#その-2-日時上限の制限抵触" class="headerlink" title="その 2. 日時上限の制限抵触"></a>その 2. 日時上限の制限抵触</h3><p>クラシック・ワークスペース ベースの両方に、日時上限の設定が可能です。<br>もし日時上限の制限に抵触していた場合、Application Insights リソースへのテレメトリ取り込みがストップします。</p><p>クラシック Application Insights リソースにて日時上限が発生した場合、当該 Application Insights リソースのアクティビティ ログが出力されます。<br>出力されるアクティビティ ログは、下記公開情報に記載があるログです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap#classic-application-insights-resource">Log Analytics ワークスペースの日次上限を設定する # 従来の Application Insights リソース</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict4.png"></p><p>ワークスペース ベースの Application Insights の場合、Application Insights リソース側もしくは Application Insights リソースに紐づいた Log Analytics ワークスペース側に日時上限の設定が可能です。  </p><p>もし Application Insights リソース側に日時上限の設定 10 GB を設定し、Log Analytics ワークスペース側に 100 GB を設定した場合、データ サイズが少ない Application Insights リソース側の日時上限に抵触した段階でテレメトリの取り込みがストップします。  </p><p>もし Application Insights リソース側の日時上限に抵触した場合は、前述のアクティビティ ログが出力されます。  </p><p>一方で、<strong>「Application Insights リソース側の日時上限データ サイズ &gt; Log Analytics ワークスペース側の日時上限データ サイズ」</strong> の場合は、Log Analytics ワークスペース側の制限に抵触し、テレメトリの取り込みがストップします。<br>この場合は、Log Analytics ワークスペース側にて <code>_LogOperation | where Category =~ &quot;Ingestion&quot; | where Detail contains &quot;OverQuota&quot;</code> のクエリを実行することで、日時上限に抵触したかどうかの判断が可能です。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/daily-cap#alert-when-daily-cap-is-reached">Log Analytics ワークスペースの日次上限を設定する # 1 日の上限に達したら警告する</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict5.png"></p><p>日時上限に抵触してテレメトリの取り込みがストップしたかどうかは、上記の内容でご判断ください。<br>その他参考資料はこちらです。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/daily-cap-unexpected-behaviors">Application Insights の日次上限の予期しない動作</a></li></ul><h3 id="その-3-AMPLS-による意図的なテレメトリ取り込みの拒否"><a href="#その-3-AMPLS-による意図的なテレメトリ取り込みの拒否" class="headerlink" title="その 3. AMPLS による意図的なテレメトリ取り込みの拒否"></a>その 3. AMPLS による意図的なテレメトリ取り込みの拒否</h3><p>もしお客様の環境にて AMPLS をご利用いただいており、Application Insights への通信を AMPLS のプライベート エンドポイント経由で行っている場合に発生する可能性がございます。</p><p>例えば下図の VNET 上に Web アプリケーションがデプロイされた Azure VM が存在する場合。<br>下図の VNET と統合した App Service・Azure Functions が存在する場合などです。</p><p><img src="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/media/private-link-security/private-link-basic-topology.png#lightbox"></p><p>上記のような環境の場合、Application Insights のエンドポイントのホスト名に対して名前解決を実施すると、AMPLS に紐づいたプライベート エンドポイントの IP アドレスに変換されます。  </p><blockquote><p>Global IP アドレスではなく、Private IP アドレスに変換されます。</p></blockquote><p>例えば通常の場合、dc.services.visualstudio.com (Application Insights エンドポイントの一部のホスト名) に対して名前解決を実施すると、下記のように Global IP アドレスに変換されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict6.png"></p><p>一方で AMPLS の環境を構築している場合、名前解決した結果下記のように Private IP アドレスに変換されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict7.png"></p><p>このように AMPLS に紐づいたプライベート エンドポイントに対する通信が発生する場合に、AMPLS 側の設定によってテレメトリが意図的に Application Insights に取り込まれない可能性があります。</p><p>例えば下記のような設定の場合を想定します。</p><p><strong>AMPLS の「インジェスト アクセス モード」が「プライベートのみ」</strong></p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict8.png"></p><p><strong>AMPLS に対して、宛先の Application Insights リソースが追加されていない</strong></p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict9.png"></p><p>このような状況で、監視対象 Web アプリケーションからプライベート エンドポイント経由で Application Insights にテレメトリを送信しようとした場合、AMPLS 側でテレメトリの取り込みが拒否されます。</p><blockquote><p>下図は、PowerShell スクリプトを使って Application Insights にテレメトリの送信を試みている状況を表しております。Application Insights のエンドポイントから 403 が返ってきている事がわかります。</p></blockquote><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict10.png"></p><p>もしお客様の環境で Application Insights へのテレメトリ送信を試されたい場合は、下記の PowerShell コマンドを Kudu や Azure VM のゲスト OS などから実行ください。</p><p>※ 下記 PowerShell スクリプトは、当該 Application Insights リソースに対して availabilityResults テーブルにテスト用のログを送信するためのスクリプトです。詳細は<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/investigate-missing-telemetry#powershell-script-send-availability-test-result">可用性テスト結果を送信する PowerShell スクリプト</a> の公開情報をご確認ください。<br>※ $ConnectionString の変数に対して、適宜当該 Application Insights リソースの接続文字列の値をご指定ください。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Info: Provide either the Connection String or Ikey for your Application Insights Resource</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ConnectionString</span> = <span class="string">&quot;InstrumentationKey=XXXXXXXX;IngestionEndpoint=https://japaneast-1.in.applicationinsights.azure.com/;LiveEndpoint=https://japaneast.livediagnostics.monitor.azure.com/&quot;</span> </span><br><span class="line"><span class="variable">$InstrumentationKey</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ParseConnectionString</span></span> &#123;</span><br><span class="line"><span class="keyword">param</span> ([<span class="built_in">string</span>]<span class="variable">$ConnectionString</span>)</span><br><span class="line">  <span class="variable">$Map</span> = <span class="selector-tag">@</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$Part</span> <span class="keyword">in</span> <span class="variable">$ConnectionString</span>.Split(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">     <span class="variable">$KeyValue</span> = <span class="variable">$Part</span>.Split(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">     <span class="variable">$Map</span>.Add(<span class="variable">$KeyValue</span>[<span class="number">0</span>], <span class="variable">$KeyValue</span>[<span class="number">1</span>])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$Map</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># If Ikey is the only parameter supplied, we&#x27;ll send telemetry to the </span></span><br><span class="line"><span class="comment"># global ingestion endpoint instead of regional endpoint found in connection strings</span></span><br><span class="line"><span class="keyword">If</span> ((<span class="variable">$InstrumentationKey</span>) <span class="operator">-and</span> (<span class="string">&quot;&quot;</span> <span class="operator">-eq</span> <span class="variable">$ConnectionString</span>)) &#123;</span><br><span class="line"><span class="variable">$ConnectionString</span> = <span class="string">&quot;InstrumentationKey=<span class="variable">$InstrumentationKey</span>;IngestionEndpoint=https://dc.services.visualstudio.com/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$map</span> = ParseConnectionString(<span class="variable">$ConnectionString</span>)</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$map</span>[<span class="string">&quot;IngestionEndpoint&quot;</span>] + <span class="string">&quot;v2/track&quot;</span></span><br><span class="line"><span class="variable">$ikey</span> = <span class="variable">$map</span>[<span class="string">&quot;InstrumentationKey&quot;</span>]</span><br><span class="line"><span class="variable">$lmUrl</span> = <span class="variable">$map</span>[<span class="string">&quot;LiveEndpoint&quot;</span>]</span><br><span class="line"> </span><br><span class="line"><span class="variable">$time</span> = (<span class="built_in">Get-Date</span>).ToUniversalTime().ToString(<span class="string">&quot;o&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="variable">$availabilityData</span> = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;data&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;baseData&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;ver&quot;: 2,</span></span><br><span class="line"><span class="string">            &quot;id&quot;: &quot;SampleRunId&quot;,</span></span><br><span class="line"><span class="string">            &quot;name&quot;: &quot;Microsoft Support Sample Webtest Result&quot;,</span></span><br><span class="line"><span class="string">            &quot;duration&quot;: &quot;00.00:00:10&quot;,</span></span><br><span class="line"><span class="string">            &quot;success&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;runLocation&quot;: &quot;Region Name&quot;,</span></span><br><span class="line"><span class="string">            &quot;message&quot;: &quot;Sample Webtest Result&quot;,</span></span><br><span class="line"><span class="string">            &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;Sample Property&quot;: &quot;Sample Value&quot;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;baseType&quot;: &quot;AvailabilityData&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;ver&quot;: 1,</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;Microsoft.ApplicationInsights.Metric&quot;,</span></span><br><span class="line"><span class="string">  &quot;time&quot;: &quot;<span class="variable">$time</span>&quot;,</span></span><br><span class="line"><span class="string">  &quot;sampleRate&quot;: 100,</span></span><br><span class="line"><span class="string">  &quot;iKey&quot;: &quot;<span class="variable">$iKey</span>&quot;,</span></span><br><span class="line"><span class="string">  &quot;flags&quot;: 0</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;@</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># Uncomment one or more of the following lines to test client TLS/SSL protocols other than the machine default option</span></span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::SSL3</span></span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::TLS</span></span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::TLS11</span></span><br><span class="line">[<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.SecurityProtocolType</span>]::TLS12</span><br><span class="line"><span class="comment"># [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::TLS13</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$ProgressPreference</span> = <span class="string">&quot;SilentlyContinue&quot;</span></span><br><span class="line"><span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="variable">$url</span> <span class="literal">-Method</span> POST <span class="literal">-Body</span> <span class="variable">$availabilityData</span> <span class="literal">-UseBasicParsing</span></span><br></pre></td></tr></table></figure><p>宛先から 403 が返って来た場合は、AMPLS によって拒否されている可能性が高いです。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-8.png" alt="Alt text"></p><p>正常時は、宛先から 200 番が返却されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-9.png" alt="Alt text"></p><p>そして宛先の Application Insights リソースの availabilityResults テーブルに、下記のようなログが記録されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">availabilityResults</span><br><span class="line">| where message =~ &#x27;Sample Webtest Result&#x27;</span><br></pre></td></tr></table></figure><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-10.png" alt="Alt text"></p><p>上記は PowerShell スクリプトですが、Linux の場合は下記の CURL コマンドを実行することで確認可能です。</p><p>※ 下記 CURL コマンドの詳細は<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/investigate-missing-telemetry#curl-command-send-availability-test-result">Curl コマンドを使用して可用性テスト結果を送信する</a> の公開情報をご確認ください。<br>※ iKey の XXX の箇所には、適宜当該 Application Insights リソースのインストルメンテーション キーの値をご指定ください。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type: application/json&quot; -X POST -d &#x27;&#123;&quot;data&quot;:&#123;&quot;baseData&quot;:&#123;&quot;ver&quot;:2,&quot;id&quot;:&quot;SampleRunId&quot;,&quot;name&quot;:&quot;MicrosoftSupportSampleWebtestResultUsingCurl&quot;,&quot;duration&quot;:&quot;00.00:00:10&quot;,&quot;success&quot;:true,&quot;runLocation&quot;:&quot;RegionName&quot;,&quot;message&quot;:&quot;SampleWebtestResult&quot;,&quot;properties&quot;:&#123;&quot;SampleProperty&quot;:&quot;SampleValue&quot;&#125;&#125;,&quot;baseType&quot;:&quot;AvailabilityData&quot;&#125;,&quot;ver&quot;:1,&quot;name&quot;:&quot;Microsoft.ApplicationInsights.Metric&quot;,&quot;time&quot;:&quot;2022-09-01T12:00:00.0000000Z&quot;,&quot;sampleRate&quot;:100,&quot;iKey&quot;:&quot;XXXXXXXXXXXX&quot;,&quot;flags&quot;:0&#125;&#x27; https://japaneast-1.in.applicationinsights.azure.com/v2.1/track</span><br></pre></td></tr></table></figure><p>もし AMPLS によってテレメトリの取り込みが拒否された場合、同じように 403 エラーが宛先から返却されます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/image-11.png" alt="Alt text"></p><p>このように AMPLS 側でインジェストが拒否される振る舞いは仕様どおりです。<br>下記の公開情報に記載がございますが、AMPLS のインジェスト アクセス モードが「プライベートのみ」の場合は、宛先となる Application Insights リソースを当該 AMPLS に追加する必要がございます。<br>そうしないと、テレメトリの取り込みが拒否されます。<br>この点について十分ご留意くださいませ。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-design#control-how-private-links-apply-to-your-networks">プライベート リンクをネットワークに適用する方法を制御する</a>  </li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict12.png"></p><p>もし当該 AMPLS のインジェスト アクセス モードが「プライベートのみ」の場合は、このような原因でテレメトリが取り込まれなくなる可能性があります。<br>一度当該 AMPLS リソースをご確認いただき、当該 Application Insights リソースが追加されているか、追加されている Application Insights リソースのプロビジョニング状態が「Succeeded」であるかどうかを、ご確認ください。  </p><p>ちなみに Application Insights リソースのプロビジョニング状態が「Failed」の場合、プライベート エンドポイントに紐づく VNET のサブネットの IP アドレスが枯渇している可能性がございます。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict13.png"></p><p>当該 VNET のページから「使用可能な IP」をご確認いただく事で枯渇しているかどうか確認可能です。<br>もし IP アドレスが足りないようでしたら、拡張いただくようご検討ください。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict14.png"></p><blockquote><p>サポートされる最小の IPv4 のサブネットは /27 です。 割り当て可能な IP アドレスの数に要注意です。</p></blockquote><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/private-link-design#requirements">Azure Private Link のセットアップを設計する # ネットワーク サブネットのサイズ</a></p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict11.png"></p><p>もし IP アドレスの数に問題が無いのにもかかわらずプロビジョニング状態が「Failed」の場合、一度適当なリソースを AMPLS から削除いただき、改めて追加してください。<br>それでも問題が改善しない場合は、お手数ではございますがサポート リクエストをご起票ください。</p><h1 id="ケース-2-一部の種類のテレメトリが-Application-Insights-にまったく収集されなくなった"><a href="#ケース-2-一部の種類のテレメトリが-Application-Insights-にまったく収集されなくなった" class="headerlink" title="ケース 2. 一部の種類のテレメトリが Application Insights にまったく収集されなくなった"></a>ケース 2. 一部の種類のテレメトリが Application Insights にまったく収集されなくなった</h1><h2 id="問題の概要-1"><a href="#問題の概要-1" class="headerlink" title="問題の概要"></a>問題の概要</h2><ul><li>requests ログや dependencies ログは収集されているのに、traces ログが収集されなくなった。</li></ul><h2 id="実際にあったケース"><a href="#実際にあったケース" class="headerlink" title="実際にあったケース"></a>実際にあったケース</h2><h3 id="ケース-1-NET-Framework-から-NET-へ移行したことで、収集されるログ-レベルの既定値が変わった"><a href="#ケース-1-NET-Framework-から-NET-へ移行したことで、収集されるログ-レベルの既定値が変わった" class="headerlink" title="ケース 1. .NET Framework から .NET へ移行したことで、収集されるログ レベルの既定値が変わった"></a>ケース 1. .NET Framework から .NET へ移行したことで、収集されるログ レベルの既定値が変わった</h3><p>監視対象 Web アプリケーションのランタイムが .NET Framework の場合には、問題なくログを traces テーブルに保存が出来ていた。<br>しかし Web アプリケーションのランタイムを .NET 6 などに移行すると、Warn や Error ログは出力されるのに Information のログが出力されなくなった。  </p><p>このような事例の場合、収集されるログ レベルの既定値の影響の可能性が非常に高いです。</p><p>.NET 用の Application Insights SDK は、規定では Ilogger Warning 以上のログが収集されます。<br>つまり、例えば LogInformation で収集されたログは規定では Application Insights に収集されません。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/app/asp-net-core#ilogger-logs">Application Insights for ASP.NET Core アプリケーション</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict15.png"></p><p>もし Application Insights SDK ですべてのレベルのログを収集されたい場合は、appsettings.json ファイルに下記の設定を追加ください。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict16.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;ApplicationInsights&quot;: &#123;</span><br><span class="line">  &quot;LogLevel&quot;: &#123;</span><br><span class="line">    &quot;Default&quot;: &quot;Debug&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>監視対象 Web アプリケーションのランタイムが Java の場合でも発生しうる問題です。<br>Java に関しましては下記の公開情報をご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/java-standalone-config#autocollected-logging">構成オプション: Azure Monitor Application Insights for Java # 自動収集されるログ</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict17.png"></p><h3 id="ケース-2-自動インストルメンテーション機能を有効にしているのに、中途半端な状態で-Application-Insights-SDK-が組み込まれてしまった"><a href="#ケース-2-自動インストルメンテーション機能を有効にしているのに、中途半端な状態で-Application-Insights-SDK-が組み込まれてしまった" class="headerlink" title="ケース 2. 自動インストルメンテーション機能を有効にしているのに、中途半端な状態で Application Insights SDK が組み込まれてしまった"></a>ケース 2. 自動インストルメンテーション機能を有効にしているのに、中途半端な状態で Application Insights SDK が組み込まれてしまった</h3><p>App Service と Application Insights を統合する方法として、下記の 2 種類ございます。</p><ol><li>自動インストルメンテーション機能を用いて有効化 (ソースコードの変更は不要)</li><li>Web アプリケーションに Application Insights SDK 組み込む (ソースコードの変更が必要)</li></ol><blockquote><p>これらの違いは <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/opentelemetry-overview?tabs=aspnetcore">こちらの公開情報</a> をご参考ください。</p></blockquote><p>ランタイムが .NET Framework / .NET の場合、自動インストルメンテーション機能を有効化していてかつ、当該 App Service リソースに対して Application Insights SDK が組み込まれた Web アプリケーションをデプロイした場合、Application Insights SDK 側が優先されます。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/opentelemetry-overview?tabs=aspnetcore">Azure App Service のアプリケーションの監視の概要</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict18.png"></p><p>Application Insights SDK 側が優先されるため、Application Insights SDK 側の設定に影響して収集されるテレメトリの種類が決定します。<br>もし担当者の方が自動インストルメンテーション機能の有効化を期待していた場合、何らかの原因によって組み込まれた Application Insights SDK が意図せず機能する可能性があります。<br>その場合に適切に Application Insights SDK の設定が構築出来ていないと、期待どおりテレメトリが収集出来ない場合がございます。</p><p>もし Application Insights SDK は不要であれば、下記の手順で当該 Web アプリケーションから Application Insights SDK の削除をご検討ください。</p><h4 id="Application-Insights-SDK-を完全に削除する"><a href="#Application-Insights-SDK-を完全に削除する" class="headerlink" title="Application Insights SDK を完全に削除する"></a>Application Insights SDK を完全に削除する</h4><p>Azure の基盤側ログに、ApplicationInsights.dll ファイルが wwwroot フォルダに検出されたことが記録されております。<br>もし当該 Web アプリケーションに対して ApplicationInsights.dll が含まれている場合は、お手数ではございますが当該 DLL を削除し改めて App Service に再デプロイを実施ください。<br>もしくは、当該 Web アプリケーションのプロジェクトに Microsoft.ApplicationInsights.AspNetCore が存在する場合、こちらを削除いただき App Service に再デプロイください。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/asp-net-core?tabs=netcorenew,netcore6#enable-application-insights-server-side-telemetry-no-visual-studio">Application Insights for ASP.NET Core アプリケーション</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict19.png"></p><p>.NET Framework の場合は、こちらを削除ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/asp-net#add-application-insights-manually">ASP.NET Web サイトに Application Insights を構成する</a></li></ul><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict20.png"></p><h1 id="ケース-3-問題なく-Application-Insights-にテレメトリが収集出来ているが、時々期待したログが欠落する"><a href="#ケース-3-問題なく-Application-Insights-にテレメトリが収集出来ているが、時々期待したログが欠落する" class="headerlink" title="ケース 3. 問題なく Application Insights にテレメトリが収集出来ているが、時々期待したログが欠落する"></a>ケース 3. 問題なく Application Insights にテレメトリが収集出来ているが、時々期待したログが欠落する</h1><h2 id="問題の概要-2"><a href="#問題の概要-2" class="headerlink" title="問題の概要"></a>問題の概要</h2><ul><li>基本的には requests ログや dependencies ログ、traces ログは収集されている。</li><li>しかし時々、一部のデータが欠落しているように見受けられる。</li></ul><h2 id="疑われるポイント-1"><a href="#疑われるポイント-1" class="headerlink" title="疑われるポイント"></a>疑われるポイント</h2><p>サンプリングが機能している可能性が非常に高いです。<br>下記の公開情報をご参考に、サンプリングによってログが意図的に間引かれているかどうかをご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/sampling-classic-api#knowing-whether-sampling-is-in-operation">サンプリングが動作しているかどうかを把握する</a></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">union requests,dependencies,pageViews,browserTimings,exceptions,traces</span><br><span class="line">| where timestamp &gt; ago(1d)</span><br><span class="line">| summarize RetainedPercentage = 100/avg(itemCount) by bin(timestamp, 1h), itemType</span><br></pre></td></tr></table></figure><h1 id="色々調べたけど問題が解決しない場合……"><a href="#色々調べたけど問題が解決しない場合……" class="headerlink" title="色々調べたけど問題が解決しない場合……"></a>色々調べたけど問題が解決しない場合……</h1><p>問題解消のために、ぜひ弊社サポートにお問い合わせください。<br>その際は、<strong>必ず問題が発生したサブスクリプションからサポート リクエストをご起票ください</strong>ませ。<br>セキュリティ上の理由から、権限の確認を厳密化させていただいているためです。<br>詳細は、<a href="https://jpaztech.github.io/blog/information/Different-subscriptions-research/">お問い合わせ発行時と「異なる」サブスクリプションならびに AAD テナントの調査依頼に対してのセキュリティ チェックが強化されます</a> をご確認ください。</p><p>なお、お問い合わせいただく際には下記の情報をご共有いただく事でスムーズに調査が可能となります。<br>Application Insights に対してテレメトリが収集されなくなり、弊社サポートにお問い合わせいただく場合にご参考いただけますと幸いです。</p><ul><li>問題が発生した Application Insights リソース名</li><li>監視対象の Web アプリケーションのデプロイ先の情報<ul><li>App Service にデプロイいただいている場合は、App Service のリソース名</li><li>Azure VM にデプロイいただいている場合は、Azure VM のリソース名</li></ul></li><li>監視対象 Web アプリケーションのランタイム情報 (.NET 6, Java 17 など)</li><li>Application Insights をご利用いただくための方法<ul><li>下記のどちらかの方法で Application Insights と統合が可能ですが、どちらをご選択いただいているかを共有ください。(不明な場合はその旨お伝えください)<ul><li>ソースコードの変更が不要な、App Service リソース ページから有効化が可能な自動インストルメンテーション機能を使って、Application Insights を利用している。</li><li>ソースコードの必要な、Application Insights SDK を Web アプリケーションに組み込んで Application Insights を利用している。</li></ul></li></ul></li><li>問題が発生し始めた時間帯<ul><li>時間帯は、日本時間か UTC なのかを必ずご共有くださいませ。</li></ul></li><li>テレメトリが欠落している事に気づいた際に、ログをご確認いただく時に実際に実行いただいた Kusto クエリ</li></ul><h1 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h1><p>本記事では、Application Insights へテレメトリが収集されなくなった場合の事象についてご案内いたしました。</p><p>本記事が少しでもお役に立ちましたら幸いです。<br>最後までお読みいただきありがとうございました！</p><h1 id="関連する記事"><a href="#関連する記事" class="headerlink" title="関連する記事"></a>関連する記事</h1><p>Application Insights に関するトラブルシューティング系の公開情報は別で用意されています。<br>今回の記事で案内させて頂いた内容も多々含まれておりますので、問題が発生した際はぜひ下記の公開情報をご確認くださいませ。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-monitor/app-insights/investigate-missing-telemetry">Azure Monitor Application Insights でアプリケーション テレメトリが見つからない場合のトラブルシューティング</a></li></ul><p>またあまり知られておりませんが、当該 Application Insights リソースのページからトラブルシューティングが可能です。<br>Azure portal より問題が発生した Application Insights のページへ移動し、「問題の診断と解決」から「Application Insights の有効かごのデータがない…」という箇所をクリックしてみてください。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict21.png"></p><p>このページから、問題を解決するためのトラブルシューティングが可能です。<br>例えば、下図のように Problem subtype に対して「すべてのテレメトリがない」を選択します。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict22.png"></p><p>すると、様々な観点から問題解消のために役立つ情報がご確認いただけます。<br>こちらも一度参考いただけますと幸いです。</p><p><img src="/blog/applicationInsights/troubleshooting_telemetry/pict23.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北山です。&lt;/p&gt;
&lt;p&gt;App Service や Azure VM などにデプロイいただいている Web アプリケーションのパフォーマンスを監視するために、Application Insights をご利用</summary>
      
    
    
    
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Application Insights" scheme="https://jpazmon-integ.github.io/blog/tags/Application-Insights/"/>
    
  </entry>
  
  <entry>
    <title>Azure Monitor Agent for Linux で取得可能なパフォーマンス カウンターの一覧</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/AMALinux_Perf/</id>
    <published>2024-01-17T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.147Z</updated>
    
    <content type="html"><![CDATA[<p>[更新履歴]  </p><ul><li>2024/1/18 データ収集ルールで指定できるパフォーマンス カウンターの追加に伴い、取得可能なパフォーマンス カウンターの一覧を更新いたしました。 </li><li>2023/3/21 ブログ公開</li></ul><p>こんにちは、Azure Monitor サポートの三輪です。<br>今回は Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターの一覧をご案内します。</p><p>Azure Monitor エージェントでは、Windows/Linux 各 OS のパフォーマンス データを取得することが可能です。</p><ul><li>Azure Monitor エージェントを使用して仮想マシンからイベントとパフォーマンス カウンターを収集する<br><a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal">https://learn.microsoft.com/ja-JP/azure/azure-monitor/agents/data-collection-rule-azure-monitor-agent?tabs=portal</a></li></ul><p>Azure Monitor エージェント for Windows では、Windows OS 上に存在するパフォーマンス カウンターであれば取得が可能です。<br>一方で、Azure Monitor エージェント for Linux では、特定のパフォーマンス カウンターのみが取得可能となっています。<br>また、Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンターは、以下の Log Analytics エージェントで取得可能であったパフォーマンス カウンターと一部異なる部分がありますため、本記事にてご案内を致します。</p><ul><li>Log Analytics エージェントを使用して Windows と Linux のパフォーマンス データ ソースを収集する<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-performance-counters">https://learn.microsoft.com/ja-jp/azure/azure-monitor/agents/data-sources-performance-counters</a></li></ul><h2 id="Azure-Monitor-エージェント-for-Linux-にて取得可能なパフォーマンス-カウンター："><a href="#Azure-Monitor-エージェント-for-Linux-にて取得可能なパフォーマンス-カウンター：" class="headerlink" title="Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンター："></a>Azure Monitor エージェント for Linux にて取得可能なパフォーマンス カウンター：</h2><table><thead><tr><th align="left">ObjectName</th><th align="center">CounterName</th></tr></thead><tbody><tr><td align="left">Logical Disk</td><td align="center">Logical Disk Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Free Megabytes</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Writes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Write Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Transfers/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Reads/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">Disk Read Bytes/sec</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Used Space</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Used Inodes</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Free Space</td></tr><tr><td align="left">Logical Disk</td><td align="center">% Free Inodes</td></tr><tr><td align="left">Memory</td><td align="center">Used Memory MBytes</td></tr><tr><td align="left">Memory</td><td align="center">Used MBytes Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">Pages/sec</td></tr><tr><td align="left">Memory</td><td align="center">Page Writes/sec</td></tr><tr><td align="left">Memory</td><td align="center">Page Reads/sec</td></tr><tr><td align="left">Memory</td><td align="center">Available MBytes Swap</td></tr><tr><td align="left">Memory</td><td align="center">Available MBytes Memory</td></tr><tr><td align="left">Memory</td><td align="center">% Used Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">% Used Memory</td></tr><tr><td align="left">Memory</td><td align="center">% Available Swap Space</td></tr><tr><td align="left">Memory</td><td align="center">% Available Memory</td></tr><tr><td align="left">Network</td><td align="center">Total Tx Errors</td></tr><tr><td align="left">Network</td><td align="center">Total Rx Errors</td></tr><tr><td align="left">Network</td><td align="center">Total Packets Transmitted</td></tr><tr><td align="left">Network</td><td align="center">Total Packets Received</td></tr><tr><td align="left">Network</td><td align="center">Total Collisions</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes Transmitted</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes Received</td></tr><tr><td align="left">Network</td><td align="center">Total Bytes</td></tr><tr><td align="left">Processor</td><td align="center">% User Time</td></tr><tr><td align="left">Processor</td><td align="center">% Processor Time</td></tr><tr><td align="left">Processor</td><td align="center">% Privileged Time</td></tr><tr><td align="left">Processor</td><td align="center">% Nice Time</td></tr><tr><td align="left">Processor</td><td align="center">% IO Wait Time</td></tr><tr><td align="left">Processor</td><td align="center">% Interrupt Time</td></tr><tr><td align="left">Processor</td><td align="center">% Idle Time</td></tr><tr><td align="left">Process</td><td align="center">Pct User Time</td></tr><tr><td align="left">Process</td><td align="center">Pct Privileged Time</td></tr><tr><td align="left">Process</td><td align="center">Used Memory</td></tr><tr><td align="left">Process</td><td align="center">Virtual Shared Memory</td></tr><tr><td align="left">System</td><td align="center">Uptime</td></tr><tr><td align="left">System</td><td align="center">Load1</td></tr><tr><td align="left">System</td><td align="center">Load5</td></tr><tr><td align="left">System</td><td align="center">Load15</td></tr><tr><td align="left">System</td><td align="center">Users</td></tr><tr><td align="left">System</td><td align="center">Unique Users</td></tr><tr><td align="left">System</td><td align="center">CPUs</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[更新履歴]  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;2024/1/18 データ収集ルールで指定できるパフォーマンス カウンターの追加に伴い、取得可能なパフォーマンス カウンターの一覧を更新いたしました。 &lt;/li&gt;
&lt;li&gt;2023/3/21 ブログ公開&lt;/li&gt;
&lt;/ul&gt;
&lt;p</summary>
      
    
    
    
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="Azure Monitor Agent" scheme="https://jpazmon-integ.github.io/blog/tags/Azure-Monitor-Agent/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのデータを削除する方法</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsWorkspacePurge/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsWorkspacePurge/</id>
    <published>2024-01-05T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.299Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>今回は、Log Analytics ワークスペースのデータを削除する方法をご紹介します。<br>Log Analytics ワークスペースでは指定した<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-archive?tabs=portal-1,portal-2#configure-the-default-workspace-retention">保持期間</a>を超えると、自動的にログが削除されます。<br>一方で、この保持期間を迎える前にログを削除したい、特定のログのみを削除したい、といった場合には、今回紹介する方法でデータを削除することをご検討いただけますと幸いです。<br><br></p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ul><li><a href="#1-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%AF-REST-API-%E3%81%A7%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B">1. Log Analytics ワークスペースのログは REST API で削除する</a></li><li><a href="#2-Purge-%E3%81%AE-REST-API-%E3%82%92%E3%81%94%E5%88%A9%E7%94%A8%E3%81%84%E3%81%9F%E3%81%A0%E3%81%8F%E9%9A%9B%E3%81%AE%E7%95%99%E6%84%8F%E7%82%B9">2. Purge の REST API をご利用いただく際の留意点</a><ul><li><a href="#2-1-%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%AD%E3%83%BC%E3%83%AB">2.1 必要なロール</a></li><li><a href="#2-2-%E3%81%94%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E6%BC%94%E7%AE%97%E5%AD%90">2.2 ご利用可能な演算子</a></li><li><a href="#2-3-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%82%8B%E3%81%BE%E3%81%A7%E3%81%AB%E3%81%8B%E3%81%8B%E3%82%8B%E6%99%82%E9%96%93">2.3 データが削除されるまでにかかる時間</a></li><li><a href="#2-4-%E3%83%91%E3%83%BC%E3%82%B8%E3%81%AE%E6%93%8D%E4%BD%9C%E3%81%AF%E5%85%83%E3%81%AB%E6%88%BB%E3%81%99%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84">2.4 パージの操作は元に戻すことはできない</a></li></ul></li><li><a href="#3-Purge-%E3%81%AE-REST-API-%E3%81%A7%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">3. Purge の REST API で削除する手順</a></li><li><a href="#4-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%81%9F%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95">4. データが削除されたかどうかを確認する方法</a></li></ul><br><h2 id="1-Log-Analytics-ワークスペースのログは-REST-API-で削除する"><a href="#1-Log-Analytics-ワークスペースのログは-REST-API-で削除する" class="headerlink" title="1. Log Analytics ワークスペースのログは REST API で削除する"></a>1. Log Analytics ワークスペースのログは REST API で削除する</h2><p>Log Analytics ワークスペースに収集されたログは REST API で削除することができます。<br>誠に恐縮ではございますが、Azure ポータルからログを削除することはできません。<br>この Purge の REST API では、ログのテーブル名やカラム名を指定して特定のログを削除することが可能です。<br>※ 当該 API は<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社公開情報</a>の “Try It” より実行いただけます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image01.png"></p><br><br><h2 id="2-Purge-の-REST-API-をご利用いただく際の留意点"><a href="#2-Purge-の-REST-API-をご利用いただく際の留意点" class="headerlink" title="2. Purge の REST API をご利用いただく際の留意点"></a>2. Purge の REST API をご利用いただく際の留意点</h2><p>Purge の REST API を実行いただく上での留意点をご紹介します。REST API を実行する前に必ずご確認ください。</p><br><h3 id="2-1-必要なロール"><a href="#2-1-必要なロール" class="headerlink" title="2.1 必要なロール"></a>2.1 必要なロール</h3><p>Purge の REST API を実行するには、明示的に <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/built-in-roles#data-purger">Data Purger (データ消去者)</a> ロールが必要です。パージを実行されるユーザー様には、対象のワークスペースに <a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">Data Purger のロールを付与</a>いただきますようお願いいたします。</p><br><h3 id="2-2-ご利用可能な演算子"><a href="#2-2-ご利用可能な演算子" class="headerlink" title="2.2 ご利用可能な演算子"></a>2.2 ご利用可能な演算子</h3><p>この REST API では、カラム名とその値を指定して特定のログを削除することができます。<br>カラム名を指定する際にサポートされている演算子は以下のとおりです。<br>すべての演算子をサポートしているものではございませんので、API を実行する前に<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社公開情報の “WorkspacePurgeBodyFilters”</a> の項目をご確認ください。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image03.png"></p><br><h3 id="2-3-データが削除されるまでにかかる時間"><a href="#2-3-データが削除されるまでにかかる時間" class="headerlink" title="2.3 データが削除されるまでにかかる時間"></a>2.3 データが削除されるまでにかかる時間</h3><p>Purge の REST API によるログの削除は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/personal-data-mgmt#exporting-and-deleting-personal-data">基本的に数分 ～ 数時間で反映されますが、最大 30 日かかる場合がございます</a>。<br>データが削除されたかどうかを確認する場合は、Log Analytics ワークスペース上でクエリを実行してください。</p><br><h3 id="2-4-パージの操作は元に戻すことはできない"><a href="#2-4-パージの操作は元に戻すことはできない" class="headerlink" title="2.4 パージの操作は元に戻すことはできない"></a>2.4 パージの操作は元に戻すことはできない</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/personal-data-mgmt#delete">パージの操作は元に戻すことはできません</a>。パージの操作を実行する際には細心の注意を払って実施してください。</p><br><br><h2 id="3-Purge-の-REST-API-で削除する手順"><a href="#3-Purge-の-REST-API-で削除する手順" class="headerlink" title="3. Purge の REST API で削除する手順"></a>3. Purge の REST API で削除する手順</h2><p><a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社サイト</a>の “Try It” より、Purge の REST API を実行した例を紹介します。<br>今回は Test という名前の Log Analytics ワークスペースに収集された Heartbeat のログを削除します。<br>このワークスペースには TimeGenerated が 2023/12/26 07:45 UTC ～ 2023/12/27 18:46 UTC の Heartbeat が存在します。<br>このうち TimeGenerated が 2023/12/26 07:50:00 UTC より後のログを削除します。</p><p>以下は Heartbeat テーブルを検索した実行結果の一部抜粋です。2023/12/26 07:50:00 UTC より後のログを削除するため、赤線で囲んだ部分のログが削除され、黄色でマーカーした部分のログは削除されずに残ります。<br>※ TimeGenerated の値は UTC 時刻であることに注意してください。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image04.png"></p><br><p>それでは API の実行手順をご紹介します。</p><ol><li><a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">こちら</a>のサイトにアクセスし、”Try It” を選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image05.png"></li></ol><ol start="2"><li>“Try It” をクリックすると、以下のような画面に遷移します。<br>Parameters (赤線で囲った部分) では、対象のワークスペースが存在するサブスクリプション、リソース グループ、ワークスペースの名前を指定します。Body (黄色線で囲った部分) では、削除するログのテーブル名と、カラム名とその値を指定します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image06.png"></li></ol><p>今回は TimeGenerated が 2023/12/26 07:50:00 UTC より後のログを削除したいので、Body 部分の table で Heartbeat、column で TimeGenerated を指定します。<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/purge?view=rest-loganalytics-2020-08-01&tabs=HTTP">こちら</a>のサイトにもサンプル リクエストが掲載されておりますので、併せてご確認ください。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;table&quot;: &quot;Heartbeat&quot;,</span><br><span class="line">  &quot;filters&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;column&quot;: &quot;TimeGenerated&quot;,</span><br><span class="line">      &quot;operator&quot;: &quot;&gt;&quot;,</span><br><span class="line">      &quot;value&quot;: &quot;<span class="number">2023</span>-<span class="number">12</span>-<span class="number">26</span>T07:<span class="number">50</span>:<span class="number">00</span>&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>画面下部の “Run” をクリックして、REST API を実行します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image07.png"></li></ol><ol start="4"><li>以下のように HTTP Response Code: 202 と表示されることを確認し、”operationId” をメモします。<br>後述しますが、”operationId” はパージ操作の受付状態を確認する際に必要です。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image08.png"></li></ol><br><br><h2 id="4-データが削除されたかどうかを確認する方法"><a href="#4-データが削除されたかどうかを確認する方法" class="headerlink" title="4. データが削除されたかどうかを確認する方法"></a>4. データが削除されたかどうかを確認する方法</h2><p>Purge の REST API によってデータが削除されたかどうかを確認する場合は、Log Analytics ワークスペース上でクエリを実行いただく必要がございます。時間の範囲や列名等で条件句をご指定いただき、対象のログが削除されたかどうかをご確認ください。</p><p>弊社環境では、以下のようなクエリを実行し、ログが削除されたことを確認しました。<br>データを削除する前には、TimeGenerated が 2023/12/26 07:45 UTC ～ 2023/12/27 18:46 UTC の Heartbeat ログが存在しておりました。今回は TimeGenerated が 2023/12/26 07:50:00 UTC より後のログを削除しました。この Heartbeat クエリを実行したところ、TimeGenerated が 2023/12/26 07:50:00 UTC より前のログは表示されますが、TimeGenerated が 2023/12/26 07:50:00 UTC より後のログは表示されませんでした。このことより、2023/12/26 07:50:00 UTC より後のログが削除されたことがわかります。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image15.png"></p><br><p>また、パージ操作の受付状態は <a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/get-purge-status?view=rest-loganalytics-2020-08-01&tabs=HTTP">Get Purge Status</a> という REST API で確認することができます。この REST API で completed が返された場合には、パージ操作が受付されたことを意味しますが、パージ操作が受付されてからデータが削除されるまでに最大 30 日かかる場合がありますので、ご了承ください。それでは Get Purge Status の REST API の実行手順をご紹介します。</p><ul><li><h4 id="Get-Purge-Status-の-REST-API-でパージの受付状態を確認する"><a href="#Get-Purge-Status-の-REST-API-でパージの受付状態を確認する" class="headerlink" title="Get Purge Status の REST API でパージの受付状態を確認する"></a>Get Purge Status の REST API でパージの受付状態を確認する</h4>Purge の REST API と同様、Get Purge Status の REST API も<a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/get-purge-status?view=rest-loganalytics-2020-08-01&tabs=HTTP">弊社サイト</a> の “Try It” から API を実行いただけます。この REST API を実行するためには、purgeId が必要です。この purgeId とは、Purge の REST API を実行した際に表示された “operationId” の値です (<a href="#3-Purge-%E3%81%AE-REST-API-%E3%81%A7%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E6%89%8B%E9%A0%86">3. Purge の REST API で削除する手順</a> の手順 4. でメモした値です)。パージ操作の受付状態を確認する場合は、必ず “operationId” をメモしていただきますようお願いいたします。</li></ul><ol><li><p><a href="https://learn.microsoft.com/en-us/rest/api/loganalytics/workspace-purge/get-purge-status?view=rest-loganalytics-2020-08-01&tabs=HTTP">こちら</a>のサイトにアクセスし、”Try It” を選択します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image16.png"></p></li><li><p>Parameters では、Purge の REST API を実行した際に表示された “operationId” と、対象のワークスペースが存在するサブスクリプション、リソース グループ、ワークスペースの名前を指定します。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image09.png"></p></li><li><p>API を実行すると以下のとおり status が表示されます。パージ操作の受付が完了していない場合は pending が返されます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image10.png"><br>パージ操作が受付された場合は completed が返されます。<br><img src="/blog/LogAnalytics/LogAnalyticsWorkspacePurge/image13.png"></p></li></ol><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;今回は、Log Analytics ワークスペースのデータを削除する方法をご紹介します。&lt;br&gt;Log Analytics ワークスペースでは指定した&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-retention-archive?tabs=portal-1,portal-2#configure-the-default-workspace-retention&quot;&gt;保持期間&lt;/a&gt;を超えると、自動的にログが削除されます。&lt;br&gt;一方で、この保持期間を迎える前にログを削除したい、特定のログのみを削除したい、といった場合には、今回紹介する方法でデータを削除することをご検討いただけますと幸いです。&lt;br&gt;&lt;br&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="Tips" scheme="https://jpazmon-integ.github.io/blog/tags/Tips/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
    <category term="パージ" scheme="https://jpazmon-integ.github.io/blog/tags/%E3%83%91%E3%83%BC%E3%82%B8/"/>
    
  </entry>
  
  <entry>
    <title>Log Analytics ワークスペースのデータ エクスポートに関するよくあるご質問</title>
    <link href="https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/"/>
    <id>https://jpazmon-integ.github.io/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/</id>
    <published>2024-01-05T15:00:00.000Z</published>
    <updated>2024-09-18T01:17:22.307Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Monitoring サポート チームの北村です。<br>皆さまは <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal">Log Analytics ワークスペースのデータ エクスポート</a> という機能をご存知でしょうか。<br>この機能では Log Analytics ワークスペースに収集されたログをストレージ アカウントやイベント ハブにエクスポートすることができます。今回はこのデータ エクスポート機能でよくお問い合わせをいただくご質問を紹介いたします。</p><br><span id="more"></span><h2 id="Q-amp-A-タイトル"><a href="#Q-amp-A-タイトル" class="headerlink" title="Q &amp; A タイトル"></a>Q &amp; A タイトル</h2><ul><li><a href="#Q1-%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%AF%E5%85%A8%E3%81%A6%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%A7%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q1. データ エクスポート機能は全てのテーブルでサポートされていますか。</a></li><li><a href="#Q2-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%84%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%8F%E3%83%96%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%82%8B%E5%A5%91%E6%A9%9F%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q2. ストレージ アカウントやイベント ハブにデータがエクスポートされる契機を教えてください。</a></li><li><a href="#Q3-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90%E5%89%8D%E3%81%AB-Log-Analytics-%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E3%81%AB%E5%8F%8E%E9%9B%86%E3%81%95%E3%82%8C%E3%81%9F%E3%83%AD%E3%82%B0%E3%81%AF%E3%80%81%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%84%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88-%E3%83%8F%E3%83%96%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q3. エクスポート ルールの作成前に Log Analytics ワークスペースに収集されたログは、ストレージ アカウントやイベント ハブにエクスポートされますか。</a></li><li><a href="#Q4-%E3%83%AD%E3%82%B0%E3%81%8C%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82%E8%80%83%E3%81%88%E3%82%89%E3%82%8C%E3%82%8B%E5%8E%9F%E5%9B%A0%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q4. ログがストレージ アカウントに転送されていません。考えられる原因を教えてください。</a></li><li><a href="#Q5-%E3%81%82%E3%82%8B%E4%B8%80%E5%AE%9A%E6%9C%9F%E9%96%93%E7%B5%8C%E9%81%8E%E3%81%97%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q5. ある一定期間経過したデータをストレージ アカウントに転送することはできますか。</a></li><li><a href="#Q6-%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%A7%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%92%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E8%BB%A2%E9%80%81%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%AF%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%81%8B%E3%80%82">Q6. データ エクスポート機能でサポートしていないテーブルのログをストレージ アカウントに転送する方法はありますか。</a></li><li><a href="#Q7-%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%A7%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%83%AD%E3%82%B0%E3%82%92%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E3%83%AD%E3%82%B0%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q7. データ エクスポート機能でストレージ アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。</a></li><li><a href="#Q8-%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%82%E5%90%AB%E3%82%81%E3%81%A6%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%84%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E5%86%8D%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E6%96%B9%E3%81%8C%E8%89%AF%E3%81%84%E3%81%A7%E3%81%99%E3%81%8B%E3%80%82">Q8. サポートされていないテーブルも含めてエクスポート ルールを設定してしまいました。エクスポート ルールを再作成した方が良いですか。</a></li><li><a href="#Q9-%E6%97%A2%E5%AD%98%E3%81%AE%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E5%AE%9B%E5%85%88%E3%81%A8%E5%90%8C%E3%81%98%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%80%81%E6%96%B0%E8%A6%8F%E3%81%AB%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88-%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%82%88%E3%81%86%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%81%8C%E3%80%81%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82">Q9. 既存のエクスポート ルールの宛先と同じストレージ アカウントを指定し、新規にエクスポート ルールを作成しようしましたが、エラーが発生しました。</a></li><li><a href="#Q10-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E3%80%82%E3%83%87%E3%83%BC%E3%82%BF-%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E6%A9%9F%E8%83%BD%E3%81%AE%E5%88%A9%E7%94%A8%E6%96%99%E9%87%91%E3%82%92%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E3%80%82">Q10. ストレージ アカウントにデータをエクスポートするように設定しています。データ エクスポート機能の利用料金を教えてください。</a></li></ul><br><h3 id="Q1-データ-エクスポート機能は全てのテーブルでサポートされていますか。"><a href="#Q1-データ-エクスポート機能は全てのテーブルでサポートされていますか。" class="headerlink" title="Q1. データ エクスポート機能は全てのテーブルでサポートされていますか。"></a>Q1. データ エクスポート機能は全てのテーブルでサポートされていますか。</h3><p>いいえ、全てのテーブルでサポートしておりません。<br>サポート対象のテーブルは、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#supported-tables">こちら</a>の弊社公開情報でご確認ください。</p><br><h3 id="Q2-ストレージ-アカウントやイベント-ハブにデータがエクスポートされる契機を教えてください。"><a href="#Q2-ストレージ-アカウントやイベント-ハブにデータがエクスポートされる契機を教えてください。" class="headerlink" title="Q2. ストレージ アカウントやイベント ハブにデータがエクスポートされる契機を教えてください。"></a>Q2. ストレージ アカウントやイベント ハブにデータがエクスポートされる契機を教えてください。</h3><p>データ エクスポート機能は Log Analytics ワークスペースに “データが取り込まれた時” に指定した宛先 (ストレージ アカウントとイベント ハブ) へデータをエクスポートします。Log Analytics ワークスペースのログをストレージ アカウントにエクスポートした場合は 5 分間のログが一つのファイルに記録されます。つまり 1 時間にファイルが 12 個作成され、レコードが生成される度にストレージ アカウントのファイルに追記されます。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#overview">弊社公開情報</a> もご覧いただけますと幸いです。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image01.png"></p><br><h3 id="Q3-エクスポート-ルールの作成前に-Log-Analytics-ワークスペースに収集されたログは、ストレージ-アカウントやイベント-ハブにエクスポートされますか。"><a href="#Q3-エクスポート-ルールの作成前に-Log-Analytics-ワークスペースに収集されたログは、ストレージ-アカウントやイベント-ハブにエクスポートされますか。" class="headerlink" title="Q3. エクスポート ルールの作成前に Log Analytics ワークスペースに収集されたログは、ストレージ アカウントやイベント ハブにエクスポートされますか。"></a>Q3. エクスポート ルールの作成前に Log Analytics ワークスペースに収集されたログは、ストレージ アカウントやイベント ハブにエクスポートされますか。</h3><p>いいえ、エクスポートされません。<br>データ エクスポート機能は Log Analytics ワークスペースに “データが取り込まれた時” に宛先 (ストレージ アカウントとイベント ハブ) へデータを転送する機能です。エクスポート ルールの設定前に既に取り込まれたログの転送は行われず、コンテナも作成されません。</p><br><h3 id="Q4-ログがストレージ-アカウントに転送されていません。考えられる原因を教えてください。"><a href="#Q4-ログがストレージ-アカウントに転送されていません。考えられる原因を教えてください。" class="headerlink" title="Q4. ログがストレージ アカウントに転送されていません。考えられる原因を教えてください。"></a>Q4. ログがストレージ アカウントに転送されていません。考えられる原因を教えてください。</h3><p>考えられる原因は以下のとおりです。弊社公開情報の <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#limitations">制限事項</a>と <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#storage-account">ストレージ アカウント</a> の項目も併せてご確認ください。<br>以下に該当しない場合で指定した宛先にログがエクスポートされない場合は弊社サポート窓口までお問い合わせください。</p><p><em><strong>1. エクスポート ルールで指定したテーブルがサポートされていない</strong></em><br>対象のテーブルがデータ エクスポート機能でサポートされていない可能性がございます。<br>まずは、指定したテーブルが<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#supported-tables">サポート対象のテーブル</a>かどうかをご確認ください。</p><p><em><strong>2. ストレージ アカウントのネットワーク設定で “信頼された Microsoft サービス” が許可されていない</strong></em><br>ストレージ アカウントのネットワーク設定により、ログがエクスポートされていない可能性がございます。<br>宛先のストレージ アカウントが選択したネットワークからのアクセスを許可する構成である場合、<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#allow-trusted-microsoft-services">[信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します。] が有効</a>になっているかどうかをご確認ください。完全に外部からのアクセスを無効にすると、Azure Monitor サービスからの通信が遮断され、ログをエクスポートすることができません。また、選択したネットワークからのアクセスを許可する構成の場合、Azure Monitor サービスからの通信を許可するために [信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します。] を有効にしていただく必要がございます。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image05.png"></p><p><em><strong>3. ストレージ アカウントのリージョンが Log Analytics ワークスペースと同じージョンでない</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#limitations">宛先のストレージ アカウントのリージョンは、Log Analytics ワークスペースと同じリージョンである必要がございます</a>。対象のストレージ アカウントと Log Analytics ワークスペースのリージョンをご確認下さいますようお願いいたします。</p><p><em><strong>4. ストレージ アカウントの種類が Standard ではない</strong></em><br><a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#limitations">データ エクスポート機能では、Premium のストレージ アカウントはサポートされていません。</a><br>宛先のストレージ アカウントの種類が Standard であることをご確認ください。</p><p><em><strong>5. エクスポート ルールの作成後に Log Analytics ワークスペースにログが収集されていない</strong></em><br>データ エクスポート機能は Log Analytics ワークスペースに “データが取り込まれた時” に宛先へデータを転送する機能です。<br>エクスポート ルールの作成後に Log Analytics ワークスペースにログが収集されていない場合は、宛先のストレージ アカウントにはログが取り込まれません。Log Analytics ワークスペース上でクエリを実行いただき、エクスポート ルールの作成後に対象のログが Log Analytics ワークスペースに収集されているかどうかをご確認ください。</p><br><h3 id="Q5-ある一定期間経過したデータをストレージ-アカウントに転送することはできますか。"><a href="#Q5-ある一定期間経過したデータをストレージ-アカウントに転送することはできますか。" class="headerlink" title="Q5. ある一定期間経過したデータをストレージ アカウントに転送することはできますか。"></a>Q5. ある一定期間経過したデータをストレージ アカウントに転送することはできますか。</h3><p>大変恐縮ではございますが、データ エクスポート機能では、ある一定期間を経過したログを転送することはできません。<br>この機能では、過去に遡ってログをエクスポートすることや特定期間のログをエクスポートすることはできません。<br>過去のログや特定の期間におけるログをエクスポートされたい場合は、お客様にてストレージ アカウントにログをアップロードする仕組みのご構築をご検討ください。</p><br><h3 id="Q6-データ-エクスポート機能でサポートしていないテーブルのログをストレージ-アカウントに転送する方法はありますか。"><a href="#Q6-データ-エクスポート機能でサポートしていないテーブルのログをストレージ-アカウントに転送する方法はありますか。" class="headerlink" title="Q6. データ エクスポート機能でサポートしていないテーブルのログをストレージ アカウントに転送する方法はありますか。"></a>Q6. データ エクスポート機能でサポートしていないテーブルのログをストレージ アカウントに転送する方法はありますか。</h3><p>エクスポートしたいログ データの種類によります。<br>例えば <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/diagnostic-settings">Azure Monitor の診断設定</a>に関するデータは、診断設定側でストレージ アカウントに転送することが可能です。エクスポートしたいデータが診断設定によるログに該当しない場合は、Azure Functions や Azure Logic Apps 等を使用して、データをストレージ アカウントにエクスポートする方法や、お客様ご自身にて Log Analytics ワークスペースからログを取得し、ストレージ アカウントに送信する仕組みのご構築をご検討ください。詳細は以下の<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/logs/logs-data-export?tabs=portal#other-export-options">弊社公開情報</a>をご参照ください。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image02.png"></p><br><h3 id="Q7-データ-エクスポート機能でストレージ-アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。"><a href="#Q7-データ-エクスポート機能でストレージ-アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。" class="headerlink" title="Q7. データ エクスポート機能でストレージ アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。"></a>Q7. データ エクスポート機能でストレージ アカウントにログをエクスポートするように設定しました。エクスポートしたログを確認する方法を教えてください。</h3><p>エクスポートされたデータは、Azure ポータルのストレージ アカウントの [ストレージ ブラウザー] の画面よりご確認いただけます。<br>ログがエクスポートされますと、am-&lt;テーブル名&gt; という名前でコンテナーが作成されます。<br>また、BLOB は WorkspaceResourceId=/subscriptions/&lt;サブスクリプション ID&gt;/resourcegroups/&lt;リソース グループ&gt;/providers/microsoft.operationalinsights/workspaces/&lt;ワークスペース名&gt;/y=&lt;4 桁の数値年&gt;/m=&lt;2 桁の数値月&gt;/d=&lt;2 桁の数値日&gt;/h=&lt;2 桁の 24 時制の時間&gt;/m=&lt;2 桁の 60 分制の分&gt;/PT05M.json というパス構造のフォルダーに格納されます。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#storage-account">弊社公開情報</a>も併せてご確認ください。</p><p>※ Heartbeat テーブルをエクスポートした例です。am-Heartbeat という名前でコンテナーが作成されます。<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image03.png"></p><br><h3 id="Q8-サポートされていないテーブルも含めてデータ-エクスポート-ルールを設定してしまいました。エクスポート-ルールを再作成した方が良いですか。"><a href="#Q8-サポートされていないテーブルも含めてデータ-エクスポート-ルールを設定してしまいました。エクスポート-ルールを再作成した方が良いですか。" class="headerlink" title="Q8. サポートされていないテーブルも含めてデータ エクスポート ルールを設定してしまいました。エクスポート ルールを再作成した方が良いですか。"></a>Q8. サポートされていないテーブルも含めてデータ エクスポート ルールを設定してしまいました。エクスポート ルールを再作成した方が良いですか。</h3><p>いいえ、現時点でサポートされていないテーブルをご指定いただいても構いません。<br>エクスポート ルール作成時に当該機能をサポートしていないテーブルについては、サポートされ次第、データのエクスポートが開始されます。<a href="https://learn.microsoft.com/ja-JP/azure/azure-monitor/logs/logs-data-export?tabs=portal#create-or-update-a-data-export-rule">弊社公開情報</a>も併せてご確認ください。</p><br><h3 id="Q9-既存のエクスポート-ルールの宛先と同じストレージ-アカウントを指定し、新規にエクスポート-ルールを作成しようしましたが、エラーが発生しました。"><a href="#Q9-既存のエクスポート-ルールの宛先と同じストレージ-アカウントを指定し、新規にエクスポート-ルールを作成しようしましたが、エラーが発生しました。" class="headerlink" title="Q9. 既存のエクスポート ルールの宛先と同じストレージ アカウントを指定し、新規にエクスポート ルールを作成しようしましたが、エラーが発生しました。"></a>Q9. 既存のエクスポート ルールの宛先と同じストレージ アカウントを指定し、新規にエクスポート ルールを作成しようしましたが、エラーが発生しました。</h3><p>1 つの Log Analytics ワークスペースで既存のエクスポート ルールと同じ宛先のストレージ アカウントを指定したエクスポート ルールを作成することはできません。既存のエクスポート ルールと同じストレージ アカウントを宛先に設定すると以下のエラーが発生します。<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#create-or-update-a-data-export-rule">弊社公開情報</a>も併せてご確認ください。<br>You are adding a destination that is already defined in rule: ym-export-test. Destination must be unique across export rules in your workspace.<br><img src="/blog/LogAnalytics/LogAnalyticsworkspaceDataExport/image04.png"></p><br><h3 id="Q10-ストレージ-アカウントにデータをエクスポートするように設定しています。データ-エクスポート機能の利用料金を教えてください。"><a href="#Q10-ストレージ-アカウントにデータをエクスポートするように設定しています。データ-エクスポート機能の利用料金を教えてください。" class="headerlink" title="Q10. ストレージ アカウントにデータをエクスポートするように設定しています。データ エクスポート機能の利用料金を教えてください。"></a>Q10. ストレージ アカウントにデータをエクスポートするように設定しています。データ エクスポート機能の利用料金を教えてください。</h3><p>データ エクスポート機能ではエクスポートされたデータに対して GB 単位でご利用料金が発生します。<br>また、ストレージ アカウントのご利用料金も発生いたします。詳細は<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal#pricing-model">弊社公開情報</a>や <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">Azure Monitor の価格サイトの “エクスポート”</a> の項目をご覧ください。</p><br><p>上記の内容以外でご不明な点や疑問点などございましたら、弊社サポート サービスまでお問い合わせください。<br>最後までお読みいただきありがとうございました！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure Monitoring サポート チームの北村です。&lt;br&gt;皆さまは &lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/logs-data-export?tabs=portal&quot;&gt;Log Analytics ワークスペースのデータ エクスポート&lt;/a&gt; という機能をご存知でしょうか。&lt;br&gt;この機能では Log Analytics ワークスペースに収集されたログをストレージ アカウントやイベント ハブにエクスポートすることができます。今回はこのデータ エクスポート機能でよくお問い合わせをいただくご質問を紹介いたします。&lt;/p&gt;
&lt;br&gt;</summary>
    
    
    
    
    <category term="How-To" scheme="https://jpazmon-integ.github.io/blog/tags/How-To/"/>
    
    <category term="FAQ" scheme="https://jpazmon-integ.github.io/blog/tags/FAQ/"/>
    
    <category term="Log Analytics" scheme="https://jpazmon-integ.github.io/blog/tags/Log-Analytics/"/>
    
  </entry>
  
</feed>
